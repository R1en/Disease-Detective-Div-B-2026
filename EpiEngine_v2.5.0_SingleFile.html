<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Epidemic Engine: Disease Detectives Mastery Guide (2026)</title>
    <!-- <!-- Manifest removed for offline single-file use --> -->
    <script>
        if (window.location.protocol !== 'file:') {
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = 'manifest.json';
            document.head.appendChild(link);
        }
    </script>
    <meta name="theme-color" content="#ff5c00">
    <link rel="icon" type="image/png" href="assets/logo.png">
    <script src="js/vendor/phosphor-icons.js"></script>
    <!--
      Use legacy styling files for the Epidemic Engine. The modern
      modular theme has been replaced with the original CSS to
      preserve the full UI and layout while implementing Phaseâ€‘2
      improvements. These styles define colours, typography and
      structural classes consistent with the original application.
    -->
    <style>
/* Offline Fonts */

:root {
    /* Neobrutalist Palette */
    --bg-color: #f4f3ef;
    --text-color: #1a1a1a;
    --accent-orange: #ff5c00;
    --accent-green: #9dff00;
    --accent-purple: #d6b3ff;
    --border-width: 2px;
    --border-color: #000000;
    --shadow-offset: 6px;

    /* Compatibility Mappings */
    --primary: var(--accent-orange);
    --accent-primary: var(--accent-orange);
    --bg-card: #ffffff;
    --text-muted: #666666;
    --bg-hover: #e0e0e0;
    --sidebar-width: 280px;
    --border: #000000;
    --text-main: var(--text-color);
    --bg-body: var(--bg-color);
    --success: #4ade80;
    --warning: #facc15;
    --danger: #f87171;

    /* Light blue accent colour for selected options (matches epidemic-engine.css) */
    --accent-blue: #bae6fd;
}

* {
    box-sizing: border-box;
}

body {
    font-family: var(--font-body);
    background-color: var(--bg-color);
    color: var(--text-color);
    line-height: 1.5;
    margin: 0;
    padding: 0;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    font-family: var(--font-heading);
    font-weight: 700;
    color: var(--text-color);
}

h3 {
    font-size: 1.4rem;
    margin-bottom: 0.75rem;
}

/* Layout */
.app-container {
    display: flex;
    width: 100%;
    height: 100vh;
    overflow: hidden;
}

/* Sidebar */
.sidebar,
#sidebar {
    width: var(--sidebar-width);
    background-color: var(--bg-card);
    border-right: var(--border-width) solid var(--border-color);
    display: flex;
    flex-direction: column;
    padding: 1rem;
    overflow-y: auto;
    flex-shrink: 0;
}

.sidebar-header {
    margin-bottom: 1.5rem;
}

.brand {
    font-size: 1.25rem;
    font-weight: 800;
    color: var(--accent-primary);
    margin-bottom: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.sidebar-nav {
    flex: 1;
}

.nav-group {
    margin-bottom: 1.5rem;
}

.nav-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--text-muted);
    font-weight: 600;
    margin-bottom: 0.5rem;
    padding-left: 0.75rem;
}

.nav-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    color: var(--text-muted);
    text-decoration: none;
    transition: all 0.2s;
    border: var(--border-width) solid transparent;
    margin-bottom: 0.25rem;
    cursor: pointer;
    border-radius: 8px;
}

.nav-item:hover {
    background: var(--bg-hover);
    color: var(--text-color);
    border-color: var(--border-color);
    box-shadow: 2px 2px 0 var(--border-color);
    transform: translate(-1px, -1px);
}

.nav-item.active {
    background: var(--accent-purple);
    border-color: var(--border-color);
    color: var(--text-color);
    box-shadow: 2px 2px 0 var(--border-color);
    font-weight: 600;
}

.nav-item i {
    margin-right: 0.5rem;
}

/* Main Content */
.main-content {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    position: relative;
    background-color: var(--bg-color);
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

/* Components */
.card {
    background: var(--bg-card);
    padding: 1.5rem;
    border: var(--border-width) solid var(--border-color);
    border-radius: 16px;
    box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--border-color);
    margin-bottom: 1.5rem;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.1s;
    border: var(--border-width) solid var(--border-color);
    gap: 0.5rem;
    font-size: 1rem;
    font-family: var(--font-heading);
    text-transform: uppercase;
    box-shadow: 4px 4px 0 var(--border-color);
}

.btn:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 var(--border-color);
}



.btn-danger {
    background-color: var(--danger);
    color: var(--text-color);
}

/* Neobrutalist Utilities */
.neo-card {
    background: white;
    border: var(--border-width) solid var(--border-color);
    box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--border-color);
    border-radius: 16px;
    overflow: hidden;
    position: relative;
}

.neo-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 1rem 2rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: var(--accent-orange);
    color: var(--text-color);
    border: var(--border-width) solid var(--border-color);
    box-shadow: 4px 4px 0 var(--border-color);
    cursor: pointer;
    text-decoration: none;
    font-family: var(--font-heading);
    font-size: 1.1rem;
    transition: all 0.1s;
    border-radius: 8px;
}

.neo-btn:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 var(--border-color);
}

.neo-btn:active {
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0 var(--border-color);
}

.neo-btn.secondary {
    background: white;
    color: var(--text-color);
}

.neo-badge {
    background: var(--accent-green);
    border: var(--border-width) solid var(--border-color);
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-weight: 700;
    font-family: var(--font-heading);
    text-transform: uppercase;
    font-size: 0.9rem;
    display: inline-block;
}

/* Exam Styles */
.exam-start {
    text-align: center;
    padding: 2rem;
}

.exam-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--bg-card);
    border: var(--border-width) solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
    box-shadow: 4px 4px 0 var(--border-color);
}

.exam-timer {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent-orange);
}

.question-card {
    background: var(--bg-card);
    padding: 2rem;
    border: var(--border-width) solid var(--border-color);
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: 6px 6px 0 var(--border-color);
}

.question-text {
    font-size: 1.4rem;
    margin-bottom: 1.5rem;
    color: var(--text-color);
    font-weight: 700;
    font-family: var(--font-heading);
}

.answer-option {
    padding: 1rem;
    background: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.1s;
    margin-bottom: 0.75rem;
    box-shadow: 2px 2px 0 var(--border-color);
}

.answer-option:hover {
    transform: translate(-1px, -1px);
    box-shadow: 4px 4px 0 var(--border-color);
    background: var(--bg-hover);
}

.answer-option.selected {
    background: var(--accent-purple);
    border-color: var(--border-color);
    box-shadow: 2px 2px 0 var(--border-color);
    transform: translate(0, 0);
}

/* Quiz V2 Styles */
.quiz-container-v2 {
    background: white;
    width: 100%;
    max-width: 900px;
    border: var(--border-width) solid var(--border-color);
    border-radius: 24px;
    box-shadow: 12px 12px 0 var(--border-color);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 85vh;
    margin: 0 auto;
}

.quiz-header-v2 {
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: var(--border-width) solid var(--border-color);
    background: white;
}

.timer-badge {
    background: var(--accent-orange);
    color: var(--text-color);
    padding: 0.5rem 1rem;
    border: var(--border-width) solid var(--border-color);
    border-radius: 50px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 2px 2px 0 var(--border-color);
}

.quiz-body-v2 {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
}

.question-text-v2 {
    font-family: var(--font-heading);
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 2rem;
    line-height: 1.2;
}

.options-grid-v2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.option-card-v2 {
    background: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.1s;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 4px 4px 0 var(--border-color);
}

.option-card-v2:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 var(--border-color);
    background: var(--bg-hover);
}

.option-card-v2.selected {
    /* Use a light blue accent for selected quiz options to maintain contrast and readability */
    background: var(--accent-blue);
    color: var(--text-color);
    box-shadow: 2px 2px 0 var(--border-color);
    transform: translate(0, 0);
}

.option-indicator {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: var(--border-width) solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    background: white;
}

.option-card-v2.selected .option-indicator {
    background: var(--accent-orange);
    color: white;
}

.quiz-footer-v2 {
    padding: 1.5rem 2rem;
    border-top: var(--border-width) solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fafafa;
}

.progress-bar-container {
    flex: 1;
    max-width: 200px;
    height: 12px;
    background: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: 50px;
    overflow: hidden;
    margin-right: 1rem;
}

.progress-bar-fill {
    height: 100%;
    background: var(--accent-green);
    border-right: var(--border-width) solid var(--border-color);
}

/* Utilities */
.hidden {
    display: none !important;
}

.grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }

    .sidebar.open {
        transform: translateX(0);
    }

    .options-grid-v2 {
        grid-template-columns: 1fr;
    }

    .quiz-container-v2 {
        height: 100vh;
        border-radius: 0;
        border: none;
    }
}

.nav-item {
    width: 100%;
    text-align: left;
    background: transparent;
    font-family: inherit;
    font-size: inherit;
    cursor: pointer;
}

/* Mobile Toggle */
.hidden-desktop {
    display: none;
}

@media (max-width: 768px) {
    .hidden-desktop {
        display: inline-flex;
        margin-bottom: 1rem;
    }

    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 90;
        display: none;
    }

    .sidebar-overlay.active {
        display: block;
    }
}

/* Print Styles */
@media print {

    .sidebar,
    #mobile-menu-toggle,
    .no-print,
    .btn,
    .neo-btn {
        display: none !important;
    }

    .app-container {
        display: block;
        height: auto;
        overflow: visible;
    }

    .main-content {
        padding: 0;
        overflow: visible;
    }

    .neo-card {
        box-shadow: none;
        border: 1px solid #000;
        break-inside: avoid;
    }

    body {
        background: white;
        color: black;
    }

    a[href]::after {
        content: " (" attr(href) ")";
    }
}
</style>
    <style>
/* @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Inter:wght@400;500;600&display=swap'); */

:root {
    --bg-color: #f4f3ef;
    --text-color: #1a1a1a;
    /* System Fonts for Offline Performance */
    --font-heading: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    --font-body: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;

    --accent-color: #ff5c00;
    --secondary-accent: #9dff00;
    --border-width: 2px;
    --border-color: #000000;
    --shadow-offset: 4px;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --accent-purple: #a855f7;
    --accent-orange: #c2410c;
    /* Darkened for accessibility (WCAG AA compliant - ~4.5:1 ratio on white) */
    --text-muted: #475569;

    /* Light blue accent color used for selected quiz options to improve contrast */
    --accent-blue: #bae6fd;

    /* Additional colors for better contrast in tables and callouts */
    --navy-primary: #003d6b;
    /* dark blue for table headers */
    --gray-bg: #f7f7f7;
    /* light gray for alternating table rows */
    --teal-accent: #38b2ac;
    /* secondary accent used in tools */
    --callout-trap: #ffe6e6;
    /* pale red for trap callouts */
    --bg-hover: var(--gray-bg);

    /* Added variables for consistency with JS modules */
    --color-text: var(--text-color);
    --color-primary: var(--accent-color);
    --surface-color: var(--bg-color);
    --pink-500: #ec4899;
    --gold-accent: #fcd34d;
    --callout-tip: #22c55e;
    --surface-2: #e5e7eb;

    /* ADD: keep consistent with styles.css */
    --accent-green: #9dff00;
}

/* Epidemic Engine Specific Styles - Neobrutalist Update */

/* Typography Overrides */
h1,
h2,
h3,
h4,
h5,
h6 {
    font-family: var(--font-heading);
    font-weight: 700;
    color: var(--text-color);
}

h1 {
    font-size: 2.5rem;
    margin-bottom: 1.5rem;
    line-height: 1.1;
}

h2 {
    font-size: 1.75rem;
    margin-top: 2.5rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: var(--border-width) solid var(--border-color);
}

p,
li {
    font-family: 'Inter', sans-serif;
    line-height: 1.6;
    color: var(--text-color);
    margin-bottom: 1rem;
}

/* Links */
a {
    color: var(--accent-orange);
    text-decoration: none;
    font-weight: 600;
    border-bottom: 2px solid transparent;
    transition: border-color 0.2s;
}

a:hover {
    border-bottom-color: var(--accent-orange);
}

/* Cards & Containers */
.card,
.neo-card {
    background: white;
    border: var(--border-width) solid var(--border-color);
    box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

/* Timeline Component */
.timeline-container {
    position: relative;
    padding-left: 2rem;
    margin: 2rem 0;
    border-left: 4px solid #e5e7eb;
}

.timeline-item {
    position: relative;
    margin-bottom: 2rem;
}

.timeline-marker {
    position: absolute;
    left: -2.6rem;
    /* Adjust based on padding/border width */
    top: 0;
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 50%;
    background: var(--bg-color);
    border: 3px solid var(--navy-primary);
    z-index: 1;
}

.timeline-content {
    background: white;
    border: 2px solid black;
    box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 1rem;
    position: relative;
    top: -0.25rem;
}

.timeline-date {
    display: inline-block;
    background: var(--navy-primary);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.timeline-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    color: var(--text-color);
}

/* Timeline Variants */
.timeline-marker.blue {
    border-color: var(--accent-blue);
}

.timeline-marker.orange {
    border-color: var(--accent-orange);
}

.timeline-marker.green {
    border-color: var(--accent-green);
}

.timeline-marker.purple {
    border-color: var(--accent-purple);
}

.drill-box,
.content-box {
    background: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--border-color);
    margin-bottom: 2rem;
}

/* Callouts */
.callout {
    background: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 4px 4px 0 var(--border-color);
    position: relative;
}

.callout-header {
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-transform: uppercase;
}

/* Specific Callout Types */
.study-tip {
    background: #e0f2fe;
    /* Light Blue */
    border-left: 6px solid var(--accent-orange);
}

.study-tip .callout-header {
    color: var(--accent-orange);
}

.exam-trap {
    background: #fee2e2;
    /* Light Red */
    border-left: 6px solid var(--danger);
}

.exam-trap .callout-header {
    color: var(--danger);
}

.champion-concept {
    background: #fef9c3;
    /* Light Yellow */
    border-left: 6px solid var(--warning);
}

.champion-concept .callout-header {
    color: #b45309;
    /* Darker Yellow/Orange */
}

/* Tables */
.table-container {
    overflow-x: auto;
    margin-bottom: 2rem;
    border: var(--border-width) solid var(--border-color);
    border-radius: 12px;
    box-shadow: 4px 4px 0 var(--border-color);
}

.table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.table th,
.table td {
    padding: 1rem;
    border-bottom: var(--border-width) solid var(--border-color);
    text-align: left;
    /* Ensure table text contrasts against colored backgrounds */
    color: var(--text-color);
}

/* Table header styling: dark background and light text for readability */
.table th {
    background: var(--navy-primary);
    color: #ffffff;
    font-family: var(--font-heading);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.9rem;
}

.table tr:last-child td {
    border-bottom: none;
}

/* Alternating row shading for tables */
.table tr:nth-child(even) td {
    background: var(--gray-bg);
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.1s;
    border: var(--border-width) solid var(--border-color);
    gap: 0.5rem;
    font-size: 1rem;
    font-family: var(--font-heading);
    text-transform: uppercase;
    box-shadow: 4px 4px 0 var(--border-color);
    background: var(--accent-orange);
    color: var(--text-color);
}



.btn-secondary {
    background: white;
    color: var(--text-color);
}

/* Quiz Styles (Embedded) */
.quiz-wrapper {
    background: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--border-color);
    margin-top: 2rem;
}

.quiz-question {
    font-family: var(--font-heading);
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
}

.quiz-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    max-width: 800px;
    /* Constrain width */
}

.quiz-option {
    padding: 1rem;
    background: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.1s;
    box-shadow: 2px 2px 0 var(--border-color);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    /* Ensure full width of grid cell */
}

.quiz-option:hover {
    transform: translate(-1px, -1px);
    box-shadow: 4px 4px 0 var(--border-color);
    background: var(--bg-hover);
}

.quiz-option.selected {
    background: var(--accent-purple);
    border-color: var(--border-color);
    box-shadow: 2px 2px 0 var(--border-color);
    transform: translate(0, 0);
}

.quiz-option.correct {
    background: var(--accent-green);
    border-color: var(--border-color);
}

.quiz-option.incorrect {
    background: var(--danger);
    color: var(--text-color);
    border-color: var(--border-color);
}

/* Accordion */
.accordion {
    border: var(--border-width) solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1rem;
    box-shadow: 4px 4px 0 var(--border-color);
}

.accordion-header {
    background: white;
    padding: 1rem 1.5rem;
    cursor: pointer;
    font-family: var(--font-heading);
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.2s;
}

.accordion-header:hover {
    background: var(--bg-hover);
}

.accordion-content {
    padding: 1.5rem;
    background: white;
    display: none;
    border-top: var(--border-width) solid var(--border-color);
}

/* When .show class is toggled by JS, display the accordion content */
.accordion-content.show {
    display: block;
}

.accordion.active .accordion-content {
    display: block;
}

/* Utilities */
.text-center {
    text-align: center;
}

.hidden {
    display: none;
}

.grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

/* Question Grid (Horizontal) */
.question-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
}

.question-grid-item {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
}

.table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.table th,
.table td {
    padding: 1rem;
    border-bottom: var(--border-width) solid var(--border-color);
    text-align: left;
    /* Ensure table text contrasts against colored backgrounds */
    color: var(--text-color);
}

.table th {
    background: var(--bg-hover);
    font-family: var(--font-heading);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.9rem;
}

.table tr:last-child td {
    border-bottom: none;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.1s;
    border: var(--border-width) solid var(--border-color);
    gap: 0.5rem;
    font-size: 1rem;
    font-family: var(--font-heading);
    text-transform: uppercase;
    box-shadow: 4px 4px 0 var(--border-color);
    background: var(--accent-orange);
    color: var(--text-color);
}

.btn:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 var(--border-color);
}

.btn:active {
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0 var(--border-color);
}

.btn-secondary {
    background: white;
    color: var(--text-color);
}

/* Quiz Styles (Embedded) */
.quiz-wrapper {
    background: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--border-color);
    margin-top: 2rem;
}

.quiz-question {
    font-family: var(--font-heading);
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
}

.quiz-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    max-width: 800px;
    /* Constrain width */
}

.quiz-option {
    padding: 1rem;
    background: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.1s;
    box-shadow: 2px 2px 0 var(--border-color);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    /* Ensure full width of grid cell */
}

.quiz-option:hover {
    transform: translate(-1px, -1px);
    box-shadow: 4px 4px 0 var(--border-color);
    background: var(--bg-hover);
}

.quiz-option.selected {
    background: var(--accent-purple);
    border-color: var(--border-color);
    box-shadow: 2px 2px 0 var(--border-color);
    transform: translate(0, 0);
}

.quiz-option.correct {
    background: var(--accent-green);
    border-color: var(--border-color);
}

.quiz-option.incorrect {
    background: var(--danger);
    color: var(--text-color);
    border-color: var(--border-color);
}

/* Accordion */
.accordion {
    border: var(--border-width) solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1rem;
    box-shadow: 4px 4px 0 var(--border-color);
}

.accordion-header {
    background: white;
    padding: 1rem 1.5rem;
    cursor: pointer;
    font-family: var(--font-heading);
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.2s;
}

.accordion-header:hover {
    background: var(--bg-hover);
}

.accordion-content {
    padding: 1.5rem;
    background: white;
    display: none;
    border-top: var(--border-width) solid var(--border-color);
}

.accordion.active .accordion-content {
    display: block;
}

/* Utilities */
.text-center {
    text-align: center;
}

.hidden {
    display: none;
}

.grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

/* Question Grid (Horizontal) */
.question-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
}

.question-grid-item {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
}

.question-grid-item.answered {
    background: var(--bg-hover);
}

.question-grid-item.current {
    background: var(--accent-orange);
    color: var(--text-color);
    border-color: var(--border-color);
}

.question-grid-item.flagged {
    border-color: var(--danger);
    color: var(--danger);
}

/* Exposure Window Tool Styles */
.exposure-graph {
    margin-top: 0.75rem;
    padding: 1rem;
    border-radius: 0.75rem;
    border: var(--border-width) solid var(--border-color);
    background: #f9fafb;
    font-size: 0.85rem;
}

.exposure-timeline {
    position: relative;
    height: 24px;
    border-radius: 999px;
    background: #e5e7eb;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.exposure-window-bar {
    position: absolute;
    top: 0;
    bottom: 0;
    background: var(--accent-blue);
    opacity: 0.8;
}

.exposure-onset-marker {
    position: absolute;
    top: -4px;
    bottom: -4px;
    width: 2px;
    background: var(--accent-purple);
}

.exposure-legend {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.exposure-examples .example-card {
    border-radius: 0.75rem;
    border: var(--border-width) solid var(--border-color);
    padding: 0.75rem 1rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: background 0.15s ease;
}

.exposure-examples .example-card:hover {
    background: var(--bg-hover);
}

/* Quiz Explanation Box */
.quiz-explanation-box {
    margin-top: 2rem;
    border: var(--border-width) solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 4px 4px 0 var(--border-color);
    background: white;
}

.quiz-explanation-box.correct {
    background: #f0fdf4;
    /* Light Green */
    border-color: var(--success);
}

.quiz-explanation-box.incorrect {
    background: #fffbeb;
    /* Light Amber */
    border-color: var(--warning);
}

.explanation-header {
    padding: 1rem 1.5rem;
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border-bottom: var(--border-width) solid var(--border-color);
}

.quiz-explanation-box.correct .explanation-header {
    background: var(--success);
    color: var(--text-color);
    border-color: var(--success);
}

.quiz-explanation-box.incorrect .explanation-header {
    background: var(--warning);
    color: black;
    border-color: var(--warning);
}

.explanation-content {
    padding: 1.5rem;
    line-height: 1.6;
    color: var(--text-color);
}

/* Hardened Quiz Grid Layout */
.question-grid {
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: wrap !important;
    width: 100% !important;
}

/* Neobrutalist Quiz V2 Styles */
.quiz-container-v2 {
    background: white;
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    border: var(--border-width) solid var(--border-color);
    box-shadow: 8px 8px 0 var(--border-color);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.quiz-header-v2 {
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: var(--border-width) solid var(--border-color);
    background: var(--bg-color);
}

.question-counter {
    font-family: var(--font-heading);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.9rem;
}

.timer-badge {
    background: white;
    border: var(--border-width) solid var(--border-color);
    padding: 0.5rem 1rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 3px 3px 0 var(--border-color);
}

.quiz-body-v2 {
    padding: 3rem;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.question-text-v2 {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 2.5rem;
    line-height: 1.3;
}

.options-grid-v2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.option-card-v2 {
    background: white;
    border: var(--border-width) solid var(--border-color);
    padding: 1.25rem;
    cursor: pointer;
    transition: all 0.1s;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 4px 4px 0 var(--border-color);
    position: relative;
    /* Button resets */
    width: 100%;
    text-align: left;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
    appearance: none;
    -webkit-appearance: none;
}

.option-card-v2:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 var(--border-color);
    background: #fffdf5;
}

.option-card-v2.selected {
    /* Use a light blue accent for selected quiz options to maintain contrast and readability */
    background: var(--accent-blue);
    color: var(--text-color);
    box-shadow: 2px 2px 0 var(--border-color);
    transform: translate(2px, 2px);
}

.option-card-v2.correct,
.option-card-v2.correct-green {
    background: var(--success);
    color: white;
    /* Ensure high contrast */
    border-color: #059669;
    /* Darker green border */
}

.option-card-v2.incorrect,
.option-card-v2.wrong-amber {
    background: #c2410c;
    /* Darker orange/red for better contrast than standard warning color */
    color: white;
    border-color: #7c2d12;
}



.option-card-v2.correct-green {
    background-color: var(--success) !important;
    color: white !important;
    border-color: var(--success) !important;
}

.option-card-v2.wrong-amber {
    background-color: var(--warning) !important;
    color: white !important;
    border-color: var(--warning) !important;
}

.option-indicator {
    width: 32px;
    height: 32px;
    border: var(--border-width) solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    background: var(--secondary-accent);
    color: black;
    flex-shrink: 0;
}

.option-card-v2.selected .option-indicator {
    /* Highlight the selection indicator with the accent color and white text */
    background: var(--accent-orange);
    color: white;
}

.option-content {
    font-weight: 500;
    font-size: 1.05rem;
}

.quiz-footer-v2 {
    padding: 1.5rem 2rem;
    border-top: var(--border-width) solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-color);
}

.progress-bar-container {
    flex: 1;
    max-width: 200px;
    height: 12px;
    background: white;
    border: var(--border-width) solid var(--border-color);
    margin-right: 1rem;
    position: relative;
}

.progress-bar-fill {
    height: 100%;
    background: var(--accent-color);
    width: 0%;
    border-right: var(--border-width) solid var(--border-color);
    transition: width 0.3s ease;
}

/* Responsive */
@media (max-width: 768px) {
    .options-grid-v2 {
        grid-template-columns: 1fr;
    }

    .quiz-body-v2 {
        padding: 1.5rem;
    }
}

.explanation-content {
    margin-top: 1.5rem;
    padding: 1rem;
    background: #f0fdf4;
    border: var(--border-width) solid var(--success);
    border-radius: 4px;
    font-size: 1rem;
    line-height: 1.5;
    color: var(--text-color);
    box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.1);
}

/* Tool Tabs */
.tool-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.tool-tab {
    padding: 0.75rem 1.5rem;
    background: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    font-family: var(--font-heading);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 4px 4px 0 var(--border-color);
    transition: all 0.1s;
}

.tool-tab:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 var(--border-color);
    background: var(--bg-hover);
}

.tool-tab.active {
    background: var(--accent-purple);
    color: var(--text-color);
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0 var(--border-color);
}

.tool-container {
    background: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 8px 8px 0 var(--border-color);
    min-height: 400px;
}

.tool-content {
    display: none;
}

.tool-content.active {
    display: block;
}

/* ========================================
   FLASHCARDS STYLES
   ======================================== */

.flashcard-container {
    max-width: 600px;
    margin: 0 auto;
}

.flashcard-scene {
    perspective: 1000px;
    margin-bottom: 2rem;
}

.flashcard {
    width: 100%;
    height: 400px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.6s;
    cursor: pointer;
}

.flashcard.is-flipped {
    transform: rotateY(180deg);
}

.flashcard-face {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    background: white;
    border: 3px solid var(--border-color);
    border-radius: 16px;
    padding: 3rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 8px 8px 0 var(--border-color);
    overflow-y: auto;
    /* Allow scrolling for long content */
}

.flashcard-front {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
}

.flashcard-back {
    background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
    transform: rotateY(180deg);
}

.fc-content {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 700;
    text-align: center;
    color: var(--text-color);
    line-height: 1.3;
}

.fc-hint {
    position: absolute;
    bottom: 1.5rem;
    font-size: 0.9rem;
    color: var(--text-muted);
    font-family: 'Inter', sans-serif;
    font-style: italic;
}

.flashcard-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.flashcard-controls button {
    flex: 1;
    max-width: 150px;
}

.flashcard-controls span {
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--text-color);
}

.flashcard-progress {
    width: 100%;
    height: 12px;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 4px 4px 0 var(--border-color);
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-orange) 0%, var(--accent-purple) 100%);
    transition: width 0.3s ease;
}

/* ========================================
   GLOSSARY STYLES
   ======================================== */

.glossary-controls {
    margin-bottom: 2rem;
}

.glossary-controls input {
    width: 100%;
    padding: 1rem 1.5rem;
    font-size: 1.1rem;
    font-family: 'Inter', sans-serif;
    border: 3px solid var(--border-color);
    border-radius: 12px;
    background: white;
    box-shadow: 4px 4px 0 var(--border-color);
    transition: all 0.2s;
}

.glossary-controls input:focus {
    outline: none;
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 var(--border-color);
    border-color: var(--accent-purple);
}

.glossary-controls input::placeholder {
    color: var(--text-muted);
}

.glossary-list {
    display: grid;
    gap: 0.5rem;
}

.glossary-letter {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent-purple);
    margin-top: 2rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 3px solid var(--border-color);
}

.glossary-letter:first-child {
    margin-top: 0;
}

.glossary-item {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 4px 4px 0 var(--border-color);
    transition: all 0.2s;
}

.glossary-item:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 var(--border-color);
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 20%, white 20%);
}

.glossary-term {
    font-family: var(--font-heading);
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 0.5rem;
}

.glossary-def {
    font-family: 'Inter', sans-serif;
    font-size: 1rem;
    line-height: 1.6;
    color: var(--text-color);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .flashcard {
        height: 350px;
    }

    .fc-content {
        font-size: 1.5rem;
    }

    .flashcard-controls {
        flex-direction: column;
    }

    .flashcard-controls button {
        max-width: 100%;
        width: 100%;
    }

    .glossary-term {
        font-size: 1.1rem;
    }

    .glossary-def {
        font-size: 0.95rem;
    }
}


/* Epi Curve Chart Styles (Restored to global scope) */

/* Epi Curve Chart Styles */
.epi-chart-container {
    display: flex;
    height: 300px;
    margin-bottom: 2rem;
    padding-top: 1rem;
}

.y-axis {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding-right: 0.5rem;
    border-right: 2px solid var(--border-color);
    font-weight: bold;
    color: var(--text-muted);
}

.chart-bars {
    display: flex;
    align-items: flex-end;
    flex: 1;
    gap: 4px;
    padding-left: 0.5rem;
    border-bottom: 2px solid var(--border-color);
    overflow-x: auto;
}

.bar-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    height: 100%;
    min-width: 40px;
}

.bar {
    width: 100%;
    background-color: var(--accent-orange);
    transition: height 0.3s ease;
    border: 2px solid var(--border-color);
    border-bottom: none;
    border-radius: 4px 4px 0 0;
    position: relative;
    display: flex;
    justify-content: center;
}

.bar.peak {
    background-color: var(--danger);
}

.bar-label {
    position: absolute;
    top: -25px;
    font-size: 0.75rem;
    font-weight: bold;
}

.x-label {
    font-size: 0.75rem;
    margin-top: 0.5rem;
    transform: rotate(-45deg);
    white-space: nowrap;
}

/* ========================================
   GLOBAL UI HELPER STYLES
   ======================================== */

.neo-toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: white;
    color: var(--text-color);
    padding: 1rem 1.5rem;
    border: 3px solid var(--border-color);
    border-radius: 12px;
    box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.1);
    font-weight: 600;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: var(--font-heading);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.neo-toast.show {
    transform: translateY(0);
    opacity: 1;
}

.neo-toast.success {
    border-color: var(--success);
    background: #f0fdf4;
}

.neo-toast.info {
    border-color: var(--navy-primary);
    background: #f0f9ff;
}

.neo-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    backdrop-filter: blur(2px);
}

.neo-modal-overlay.show {
    opacity: 1;
    pointer-events: auto;
}

.neo-modal {
    background: white;
    border: 3px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 12px 12px 0 rgba(0, 0, 0, 0.2);
    width: 90%;
    max-width: 500px;
    padding: 2rem;
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.neo-modal-overlay.show .neo-modal {
    transform: scale(1);
}

.neo-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.neo-modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--navy-primary);
}

.neo-modal-body {
    font-size: 1.1rem;
    color: var(--text-color);
    margin-bottom: 2rem;
    line-height: 1.5;
}

.neo-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

/* ========================================
   RESPONSIVE & PRINT POLISH (AUDIT FIXES)
   ======================================== */

/* Text Scaling for Mobile */
@media (max-width: 768px) {
    h1 {
        font-size: clamp(1.8rem, 5vw, 2.5rem);
        word-wrap: break-word;
    }

    h2 {
        font-size: clamp(1.5rem, 4vw, 1.75rem);
    }

    .neo-card {
        padding: 1rem;
    }

    .quiz-body-v2 {
        padding: 1.5rem;
    }
}

/* Print Friendly Styles */
@media print {

    aside,
    nav,
    .sidebar,
    #mobile-menu-toggle,
    .btn:not(.print-show),
    .action-group,
    .quiz-footer-v2,
    .neo-toast,
    .tool-controls {
        display: none !important;
    }

    .main-content {
        margin-left: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        overflow: visible !important;
    }

    body {
        background: white !important;
        color: black !important;
        font-size: 12pt;
    }

    h1,
    h2,
    h3 {
        page-break-after: avoid;
        color: black !important;
    }

    .neo-card,
    .callout,
    .table-container {
        break-inside: avoid;
        border: 1px solid #ddd !important;
        box-shadow: none !important;
        margin-bottom: 1rem;
    }

    a {
        text-decoration: underline;
        color: black !important;
    }

    /* Reveal URLs for reference */
    a[href^="http"]:after {
        content: " (" attr(href) ")";
        font-size: 0.8em;
    }
}

@media print {
    @page {
        margin: 1.5cm;
    }

    body,
    html {
        background-color: white !important;
        color: black !important;
        font-family: 'Times New Roman', serif !important;
        font-size: 12pt;
    }

    .sidebar,
    .mobile-menu-toggle,
    .bottom-nav,
    .theme-toggle,
    .print-controls,
    .rulebook-fab,
    .rulebook-sidebar,
    .chapter-nav {
        display: none !important;
    }

    .main-content {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: auto !important;
        box-shadow: none !important;
        background: white !important;
        overflow: visible !important;
    }

    h1,
    h2,
    h3 {
        color: black !important;
        page-break-after: avoid;
    }

    .print-wrapper {
        display: block !important;
        width: 100%;
    }

    .print-question {
        page-break-inside: avoid;
    }

    .print-key {
        page-break-before: always;
    }
}

/* Mobile Touch Optimization */
@media (max-width: 768px) {

    .neo-btn,
    .sidebar-nav .nav-item,
    .tool-tab,
    .quiz-option {
        min-height: 48px;
        touch-action: manipulation;
        /* Disables double-tap zoom delay */
    }

    .sidebar-nav .nav-item {
        padding-top: 12px;
        padding-bottom: 12px;
    }
}

.interactive-card:hover {
    transform: translateY(-4px);
    box-shadow: 6px 6px 0 var(--navy-primary);
    border-color: var(--navy-primary);
}

/* Advanced Topic Indicators */
.advanced-topic-badge {
    background-color: #f3e8ff;
    color: #581c87;
    border: 1px solid #d8b4fe;
    padding: 0.25rem 0.75rem;
    border-radius: 99px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-block;
    vertical-align: middle;
    margin-left: 0.5rem;
}

.advanced-section {
    border-left: 4px solid #a855f7;
    background-color: #faf5ff;
    padding: 1.5rem;
    margin: 1.5rem 0;
    border-radius: 0 8px 8px 0;
}

/* =========================================
   COMPREHENSIVE PRINT STYLESHEET
   ========================================= */
@media print {

    /* 1. Global Layout Resets */
    @page {
        margin: 1.5cm;
    }

    body {
        background: white !important;
        color: black !important;
        font-family: 'Times New Roman', serif;
        /* Better reading on paper */
        font-size: 12pt;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    /* Hide Navigation & Interactive Elements */
    .sidebar,
    .mobile-nav-toggle,
    .btn,
    button,
    .nav-actions,
    .quiz-controls,
    .timer-display,
    .progress-bar,
    .site-footer {
        display: none !important;
    }

    /* Reset Main Content */
    .app-container {
        display: block !important;
    }

    .main-content {
        margin-left: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        max-width: none !important;
        overflow: visible !important;
    }

    #content-container {
        padding: 0 !important;
        margin: 0 !important;
    }

    /* 2. Component Flattening (Save Ink) */
    .card,
    .neo-card,
    .content-box,
    .callout,
    .drill-box,
    .quiz-wrapper {
        box-shadow: none !important;
        border: 1px solid #333 !important;
        border-radius: 4px !important;
        background: white !important;
        margin-bottom: 20px !important;
        page-break-inside: avoid;
    }

    /* Keep Callout borders to distinguish types, but remove backgrounds */
    .callout {
        border-left-width: 4px !important;
        background: #fafafa !important;
    }

    /* 3. Typography readability */
    h1,
    h2,
    h3,
    h4 {
        color: #000 !important;
        page-break-after: avoid;
    }

    h1 {
        font-size: 24pt;
        border-bottom: 2px solid black;
    }

    h2 {
        font-size: 18pt;
        border-bottom: 1px solid black;
        margin-top: 30px;
    }

    p,
    li {
        line-height: 1.5;
        color: #111;
    }

    a {
        text-decoration: underline;
        color: #000;
    }

    /* 4. Tables */
    .table-container {
        border: none !important;
        box-shadow: none !important;
        overflow: visible !important;
    }

    .table th {
        background: #eee !important;
        color: black !important;
        border-bottom: 2px solid #000 !important;
    }

    .table td {
        border-bottom: 1px solid #ccc !important;
        color: black !important;
    }

    /* 5. Special Content Handling */

    /* Flashcards - Show front and back linear */
    .flashcard {
        border: 1px solid #ccc !important;
        margin-bottom: 15px;
        page-break-inside: avoid;
        height: auto !important;
        min-height: 0 !important;
        perspective: none !important;
    }

    .flashcard-inner {
        position: relative !important;
        transform: none !important;
        box-shadow: none !important;
        height: auto !important;
        display: block !important;
    }

    .flashcard-front,
    .flashcard-back {
        position: relative !important;
        transform: none !important;
        backface-visibility: visible !important;
        display: block !important;
        padding: 10px !important;
        border: none !important;
        height: auto !important;
        background: white !important;
        color: black !important;
    }

    .flashcard-front {
        font-weight: bold;
        border-bottom: 1px dashed #999 !important;
    }

    .flashcard-back {
        font-style: italic;
        background: #f9f9f9 !important;
        color: #333 !important;
    }

    /* Notesheet Generator Optimization */
    #notesheet-content {
        font-family: 'Courier New', monospace;
        /* Look like field notes */
        display: block !important;
    }

    .formula-box {
        border: 1px solid #000;
        background: #fff;
        padding: 10px;
    }

    /* Study Design Chart */
    svg {
        max-width: 100% !important;
        height: auto !important;
    }
}

/* =========================================
   EPI CURVE TOOL STYLES
   ========================================= */
.epi-chart-container {
    display: flex;
    margin: 2rem 0;
    height: 300px;
    border: 1px solid #ccc;
    background: white;
    padding: 1rem;
    position: relative;
    border-radius: 8px;
}

.y-axis {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding-right: 1rem;
    border-right: 2px solid #333;
    font-size: 0.8rem;
    color: #666;
    height: 100%;
}

.chart-bars {
    flex: 1;
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 100%;
    padding-left: 1rem;
    overflow-x: auto;
}

.bar-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    position: relative;
    height: 100%;
    min-width: 20px;
}

.bar {
    width: 100%;
    background-color: var(--navy-primary);
    /* High contrast */
    transition: height 0.3s ease;
    border-radius: 2px 2px 0 0;
    position: relative;
    min-width: 12px;
}

.bar:hover {
    background-color: var(--accent-orange);
}

.bar.peak {
    background-color: var(--accent-orange);
    /* Highlight peak */
}

.bar-label {
    position: absolute;
    top: -20px;
    width: 100%;
    text-align: center;
    font-size: 0.75rem;
    font-weight: bold;
    color: #333;
}

.x-label {
    margin-top: 0.5rem;
    font-size: 0.7rem;
    transform: rotate(45deg);
    transform-origin: top left;
    white-space: nowrap;
}
</style>
    <link rel="stylesheet" href="css/mobile-overrides.css">
</head>

<body>
    <div class="app-container">
        <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="brand" style="display: flex; align-items: center; gap: 0.75rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" style="height: 32px; width: 32px;">
                        <circle cx="50" cy="50" r="45" fill="url(#logoGrad)" stroke="#000" stroke-width="2" />
                        <defs>
                            <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#003d6b" />
                                <stop offset="100%" stop-color="#007acc" />
                            </linearGradient>
                        </defs>
                        <path d="M50 15 L50 45 L75 60 L25 60 L50 45" fill="#ff5c00" stroke="#fff" stroke-width="2" />
                        <circle cx="50" cy="50" r="10" fill="#fff" />
                    </svg>
                    Epidemic Engine
                </div>
            </div>
            <nav class="sidebar-nav">
                <button class="nav-item active" data-chapter="home">
                    <i class="ph ph-house"></i> Home
                </button>
                <div class="nav-group">
                    <div class="nav-label">Part I: The Foundation</div>
                    <button class="nav-item" data-chapter="ch1">1. Frameworks & Mindset</button>
                    <button class="nav-item" data-chapter="ch2">2. History & Heroes</button>
                    <button class="nav-item" data-chapter="ch3">3. The Triad & Chain</button>
                    <button class="nav-item" data-chapter="ch4">4. Measures of Freq.</button>
                    <button class="nav-item" data-chapter="ch5">5. Surveillance Sys.</button>
                    <button class="nav-item" data-chapter="ch6">6. Natural History</button>
                    <button class="nav-item" data-chapter="quiz_part1">
                        <i class="ph ph-exam"></i> Part I Quiz
                    </button>
                </div>
                <div class="nav-group">
                    <div class="nav-label">Part II: Investigation & Analysis</div>
                    <button class="nav-item" data-chapter="ch7">7. Invest. Roadmap</button>
                    <button class="nav-item" data-chapter="ch8">8. Case Definitions</button>
                    <button class="nav-item" data-chapter="ch9">9. Line Lists & Data</button>
                    <button class="nav-item" data-chapter="ch10">10. Curves & Timing</button>
                    <button class="nav-item" data-chapter="ch11">11. Outbreak Math I</button>
                    <button class="nav-item" data-chapter="ch12">12. Outbreak Math II</button>
                    <button class="nav-item" data-chapter="ch13">13. Hypothesis Test</button>
                    <button class="nav-item" data-chapter="quiz_part2">
                        <i class="ph ph-exam"></i> Part II Quiz
                    </button>
                </div>
                <div class="nav-group">
                    <div class="nav-label">Part III: Control & Prevention</div>
                    <button class="nav-item" data-chapter="ch14">14. Data Synthesis</button>
                    <button class="nav-item" data-chapter="ch15">15. Prevention Levels</button>
                    <button class="nav-item" data-chapter="ch16">16. Control Measures</button>
                    <button class="nav-item" data-chapter="ch17">17. Isolation & Ethics</button>
                    <button class="nav-item" data-chapter="ch18">18. Pop. Dynamics</button>
                    <button class="nav-item" data-chapter="ch19">19. Advanced Eval</button>
                    <button class="nav-item" data-chapter="ch20">20. Case Studies</button>
                    <button class="nav-item" data-chapter="quiz_part3">
                        <i class="ph ph-exam"></i> Part III Quiz
                    </button>
                </div>
                <div class="nav-group">
                    <button class="nav-item coach-only" data-chapter="coach_resources" style="display: none;">
                        <i class="ph ph-chalkboard-teacher"></i> Coach Resources
                    </button>
                </div>
                <div class="nav-group">
                    <div class="nav-label">Tools & Appendices</div>
                    <button class="nav-item" data-chapter="drills">
                        <i class="ph ph-wrench"></i> Interactive Drills
                    </button>
                    <button class="nav-item" data-chapter="simulation">
                        <i class="ph ph-clock"></i> Simulation Exams
                    </button>
                    <button class="nav-item" data-chapter="case_library">
                        <i class="ph ph-files"></i> Case Library
                    </button>
                    <button class="nav-item" data-chapter="interactive_scenarios">
                        <i class="ph ph-game-controller"></i> Interactive Scenarios
                    </button>
                    <button class="nav-item" data-chapter="appendix">
                        <i class="ph ph-books"></i> Appendix & Resources
                    </button>
                    <button class="nav-item" data-chapter="about">
                        <i class="ph ph-info"></i> About & Credits
                    </button>
                </div>
            </nav>
        </aside>
        <main class="main-content">
            <button id="mobile-menu-toggle" class="neo-btn small hidden-desktop" aria-label="Toggle Navigation"
                aria-expanded="false">
                <i class="ph ph-list"></i> Menu
            </button>
            <div id="content-container">
                <!-- Content loaded dynamically -->
            </div>

            <footer class="site-footer"
                style="margin-top: 4rem; padding: 2rem 0; border-top: 2px solid var(--border-color); text-align: center; color: var(--text-color); font-family: 'Space Grotesk', sans-serif; opacity: 0.8;">
                <p style="margin-bottom: 0.5rem;">
                    <strong>The Epidemic Engine</strong> v2.5.0 â€¢ Â© 2026 Science Olympiad Mastery Guide<br>
                    <span
                        style="display: block; margin-top: 0.4rem; font-size: 0.95rem; color: var(--navy-primary);">Designed,
                        Created, & Conceived by <strong>Rishi Reddy</strong></span>
                </p>
                <p style="font-size: 0.85rem; margin-bottom: 0;">Content based on CDC/WHO principles. For educational
                    use only.</p>
                <p style="font-size: 0.85rem; margin-top: 0.5rem;"><a href="#"
                        onclick="loadChapter('about'); return false;" style="color: var(--text-muted);">About Epidemic
                        Engine</a></p>
            </footer>

        </main>
    </div>

    <!--
      Load the legacy monolithic scripts. These scripts power the
      entire Epidemic Engine, including content, tools, quizzes and
      simulation exams. Phaseâ€‘2 additions (quiz_phase2_additions.js)
      extend the quiz bank with new advanced questions and should be
      loaded after quiz_bank_enhanced.js.
    -->
    <!-- Bundled JS: data first, then core engine -->
    <script>
/**
 * Epidemic Engine - Content Management System
 * Handles all 20 chapters with comprehensive content
 */

window.EPIDEMIC_ENGINE_CONTENT = {
    // Welcome/Home
    welcome: {
        title: "Welcome to The Epidemic Engine",
        content: `
            <div id="home-root" style="min-height: 50vh;">
                <div style="text-align: center; margin-top: 4rem;">
                    <div class="loader"></div>
                    <p style="color: #666; margin-top: 1rem;">Loading Dashboard...</p>
                </div>
            </div>
        `
    },

    // PART I: FOUNDATION & SURVEILLANCE
    ch1: {
        title: "Chapter 1: Core Frameworks & Mindset",
        difficulty: "B",
        content: `
            <h1>Chapter 1: Core Frameworks & Mindset</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 2px solid #166534; font-weight: bold; box-shadow: 0 2px 4px rgba(21, 128, 61, 0.2); opacity: 1;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 1px solid #ca8a04; opacity: 0.3;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">Epidemiology is the study of the <strong>distribution</strong> and <strong>determinants</strong> of health-related states in populations, and the <strong>application</strong> of this study to control health problems.</p>

            <h2>1.1 The Three Pillars of Epidemiology</h2>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Study Guide Tip
                </div>
                <div class="callout-content">
                    <p><strong>Mnemonic: DDA</strong></p>
                    <ul>
                        <li><strong>D</strong>istribution - Who, where, when?</li>
                        <li><strong>D</strong>eterminants - Why and how?</li>
                        <li><strong>A</strong>pplication - What can we do?</li>
                    </ul>
                </div>
            </div>

            <h3>Distribution</h3>
            <p>Analyzing the <strong>frequency</strong> and <strong>pattern</strong> of health events by:</p>
            <ul>
                <li><strong>Person:</strong> Age, sex, occupation, socioeconomic status</li>
                <li><strong>Place:</strong> Geographic location, urban vs rural</li>
                <li><strong>Time:</strong> Seasonal patterns, trends, outbreaks (endemic vs epidemic)</li>
            </ul>

            <div class="neo-card small" style="background: #f1f5f9; margin: 1.5rem 0; border-left: 4px solid var(--navy-primary);">
                <h3><i class="ph-bold ph-chart-line-up"></i> Key Definitions: Disease Frequency</h3>
                <ul>
                    <li><strong>Endemic:</strong> Constant presence of a disease in a geographic area (e.g., Malaria in parts of Africa).</li>
                    <li><strong>Epidemic:</strong> Sudden increase in cases above what is normally expected (e.g., Zika outbreak).</li>
                    <li><strong>Pandemic:</strong> An epidemic that has spread over several countries or continents (e.g., COVID-19).</li>
                </ul>
            </div>

            <h3>Determinants</h3>
            <p>Identifying the <strong>causes</strong> and <strong>risk factors</strong> for health events:</p>
            <ul>
                <li>Biological factors (genetics, immunity)</li>
                <li>Behavioral factors (diet, exercise, smoking)</li>
                <li>Environmental factors (pollution, climate)</li>
                <li>Social factors (poverty, education, access to care)</li>
            </ul>
            <p><em>Example:</em> For SARS-CoV-2, determinants included crowding (Environment), age/comorbidities (Host), and the viral strain (Agent).</p>

            <h3>Application</h3>
            <p>Using epidemiological findings for <strong>public health action</strong>:</p>
            <ul>
                <li>Disease prevention programs</li>
                <li>Health policy development</li>
                <li>Resource allocation</li>
                <li>Outbreak control measures</li>
            </ul>
            <p><strong>Note:</strong> Public health surveillance systems (like PulseNet or NNDSS in the US) continuously collect this data to trigger early actionâ€”stay tuned for Chapter 7.</p>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Epidemiology vs. Etiology
                </div>
                <div class="callout-content">
                    <p><strong>COMMON MISTAKE:</strong> Confusing epidemiology with etiology.</p>
                    <ul>
                        <li><strong>Epidemiology:</strong> Broad study of disease patterns, causes, AND control in populations</li>
                        <li><strong>Etiology:</strong> Narrow focus on disease CAUSES only</li>
                    </ul>
                    <p><strong>Remember:</strong> Epidemiology includes etiology but is much broader!</p>
                </div>
            </div>

            <h2>1.2 Clinical Medicine vs. Public Health</h2>

            <div class="table-container"><table class="table">
                <thead style="background: var(--navy-primary); color: white;">
                    <tr>
                        <th style="padding: 1rem; text-align: left;">Aspect</th>
                        <th style="padding: 1rem; text-align: left;">Clinical Medicine</th>
                        <th style="padding: 1rem; text-align: left;">Public Health/Epidemiology</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Focus</strong></td>
                        <td style="padding: 1rem;">Individual patient</td>
                        <td style="padding: 1rem;">Populations and communities</td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>Goal</strong></td>
                        <td style="padding: 1rem;">Diagnose and treat disease</td>
                        <td style="padding: 1rem;">Prevent disease and promote health</td>
                    </tr>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Approach</strong></td>
                        <td style="padding: 1rem;">One-on-one care</td>
                        <td style="padding: 1rem;">Population-level interventions</td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>Question</strong></td>
                        <td style="padding: 1rem;">"What's wrong with this patient?"</td>
                        <td style="padding: 1rem;">"Why is this disease occurring in this community?"</td>
                    </tr>
                </tbody>
            </table></div>

            <h2>1.3 Scope of Epidemiology: Not Just Outbreaks!</h2>
            <p>While this guide focuses on "Disease Detectives" (which often emphasizes infectious outbreaks), epidemiology covers <strong>ALL</strong> health-related states.</p>
            
            <div class="neo-card small" style="background: #f0f9ff; border-left: 4px solid var(--navy-primary); margin: 1.5rem 0;">
                <p><strong>Epidemiologists study:</strong></p>
                <ul>
                    <li><strong>Infectious Diseases:</strong> Flu, Salmonella, COVID-19.</li>
                    <li><strong>Chronic Diseases:</strong> Cancer, diabetes, heart disease.</li>
                    <li><strong>Environmental Health:</strong> Lead poisoning, asthma triggers.</li>
                    <li><strong>Injuries:</strong> Car crashes, workplace safety.</li>
                    <li><strong>Behaviors:</strong> Smoking, seatbelt use, diet.</li>
                </ul>
            </div>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-question"></i>
                    Scope Quiz
                </div>
                <div class="callout-content">
                    <p><strong>Question:</strong> True or False: Determining if seatbelt laws reduce traffic deaths is an epidemiological study.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: TRUE</strong></p>
                            <p>Epidemiology studies the <em>determinants</em> (seatbelt laws) of <em>health-related events</em> (deaths) in a <em>population</em>. It is not limited to germs!</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>1.4 Historical Foundations</h2>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: John Snow's Cholera Investigation (1854)
                </div>
                <div class="callout-content">
                    <p><strong>The Father of Modern Epidemiology</strong></p>
                    <p>John Snow investigated a cholera outbreak in London's Soho district:</p>
                    
                    <div style="text-align: center; margin: 1.5rem 0;">
                        <svg width="400" height="300" viewBox="0 0 400 300" class="responsive-svg" style="background: #fdfbf7; border: 2px solid #d1d5db; border-radius: 4px;">
                            <!-- Streets -->
                            <line x1="50" y1="150" x2="350" y2="150" stroke="#9ca3af" stroke-width="12"/> <!-- Broad Street -->
                            <text x="360" y="155" font-size="10" fill="#6b7280" font-weight="bold">BROAD ST</text>
                            
                            <line x1="200" y1="50" x2="200" y2="250" stroke="#9ca3af" stroke-width="8"/> <!-- Cross Street -->
                            <line x1="120" y1="50" x2="120" y2="250" stroke="#9ca3af" stroke-width="6"/> <!-- Side Street -->
                            <line x1="280" y1="50" x2="280" y2="250" stroke="#9ca3af" stroke-width="6"/> <!-- Side Street -->

                            <!-- Cases (Dots) clustered near pump -->
                            <g fill="#ef4444">
                                <circle cx="190" cy="140" r="3"/> <circle cx="210" cy="140" r="3"/>
                                <circle cx="195" cy="160" r="3"/> <circle cx="205" cy="160" r="3"/>
                                <circle cx="180" cy="145" r="3"/> <circle cx="220" cy="145" r="3"/>
                                <circle cx="190" cy="130" r="3"/> <circle cx="210" cy="170" r="3"/>
                                <circle cx="170" cy="150" r="3"/> <circle cx="230" cy="150" r="3"/>
                                <circle cx="200" cy="120" r="3"/> <circle cx="200" cy="180" r="3"/>
                                <!-- Sparse cases further away -->
                                <circle cx="100" cy="100" r="3"/> <circle cx="300" cy="200" r="3"/>
                                <circle cx="120" cy="220" r="3"/> <circle cx="280" cy="80" r="3"/>
                            </g>

                            <!-- The Pump -->
                            <rect x="195" y="145" width="10" height="10" fill="#000" stroke="#fff" stroke-width="1"/>
                            <text x="190" y="140" font-size="12" font-weight="900" fill="#000">X</text>
                            
                            <!-- Legend -->
                            <rect x="10" y="260" width="120" height="35" fill="white" stroke="#ccc"/>
                            <circle cx="20" cy="270" r="3" fill="#ef4444"/> <text x="30" y="274" font-size="10">Cholera Case</text>
                            <text x="20" y="288" font-size="10" font-weight="900">X</text> <text x="30" y="288" font-size="10">Water Pump</text>
                        </svg>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;"><em>Visualizing the cluster around the Broad Street Pump</em></p>
                    </div>

                    <ul>
                        <li><strong>Method:</strong> Mapped cases on a street map</li>
                        <li><strong>Finding:</strong> Cases clustered around the Broad Street pump</li>
                        <li><strong>Action:</strong> Removed the pump handle</li>
                        <li><strong>Result:</strong> Outbreak ended</li>
                    </ul>
                    <p><strong>Key Insight:</strong> Snow controlled the outbreak <em>without knowing the causative agent</em> (cholera bacteria weren't discovered until 30 years later). This demonstrates epidemiology's power - you can prevent disease even without knowing the exact cause!</p>
                </div>
            </div>

            <h3>Other Pioneers</h3>
            <ul>
                <li><strong>Edward Jenner (1796):</strong> Developed smallpox vaccine</li>
                <li><strong>Ignaz Semmelweis (1840s):</strong> Hand washing to prevent childbed fever</li>
                <li><strong>William Farr:</strong> Developed vital statistics and disease classification</li>
                <li><strong>Robert Koch:</strong> Established germ theory and Koch's postulates</li>
            </ul>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Quick Check
                </div>
                <div class="callout-content">
                    <p><strong>Question:</strong> A researcher studies 500 diabetes patients to understand why some develop complications. Is this epidemiology?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: YES</strong></p>
                            <p><strong>Rationale:</strong> This is epidemiology because it's studying a <em>population</em> (500 patients) to understand <em>determinants</em> (why complications occur). Even though it's focused on one disease, it's population-level research, not individual patient care.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li>Epidemiology = Distribution + Determinants + Application</li>
                <li>Focus on populations, not individuals</li>
                <li>Can prevent disease without knowing exact causes</li>
                <li>Foundation for all public health action</li>
            </ul>

            <h2>5.5 International Health Regulations (IHR)</h2>
            <div class="callout-header" style="background: var(--gold-accent); color: var(--navy-primary);">
                <i class="ph ph-globe"></i> Global Surveillance
            </div>
            <p><strong>IHR (2005):</strong> A legally binding international law that helps countries work together to save lives while minimizing interference with international trade and travel.</p>
            
            <div class="neo-card" style="margin: 1.5rem 0;">
                <h3 style="margin-top:0; color:var(--navy-primary);">PHEIC (Public Health Emergency of International Concern)</h3>
                <p>The **WHO Director-General** declares a PHEIC if an event is:</p>
                <ol>
                    <li><strong>Extraordinary</strong></li>
                    <li><strong>A public health risk to other states</strong> (via international spread)</li>
                    <li><strong>Potentially requiring a coordinated international response</strong></li>
                </ol>
            </div>

            <div class="study-tip">
                <div class="callout-header"><i class="ph ph-lightbulb"></i> Mnemonic: IHR Decision Instrument</div>
                <div class="callout-content">
                    <p>To decide if you must notify the WHO, answer these 4 Questions:</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>1. Is the public health impact serious?</li>
                        <li>2. Is the event unusual or unexpected?</li>
                        <li>3. Is there a significant risk of international spread?</li>
                        <li>4. Is there a significant risk of international travel/trade restrictions?</li>
                    </ul>
                    <p><strong>Rule:</strong> If "Yes" to **any 2** questions -> Notify WHO within 24 hours.</p>
                    <p><em>(Note: Smallpox, Polio, SARS, and new Influenza are ALWAYS reportable).</em></p>
                </div>
            </div>

            <h2>5.6 Exam Focus (National)</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Definition:</strong> Memorize "Distribution and Determinants".</li>
                        <li><strong>Population Focus:</strong> Epidemiology is about groups, not individuals.</li>
                        <li><strong>Application:</strong> The ultimate goal is control/prevention.</li>
                    </ul>
                </div>
            </div>
        `
    },

    // Placeholder for remaining chapters (to be populated)
    ch2: {
        title: "Chapter 2: History & Heroes",
        difficulty: "B",
        content: `
            <h1>Chapter 2: History & Heroes</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 2px solid #166534; font-weight: bold; box-shadow: 0 2px 4px rgba(21, 128, 61, 0.2); opacity: 1;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 1px solid #ca8a04; opacity: 0.3;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">The story of epidemiology is filled with inspiring investigators who saved millions of lives. Division B exams frequently test your knowledge of these pioneers and their methods.</p>

            <h2>2.1 The Pioneers</h2>
            <p>Commit these names and contributions to memory (Mnemonic: <strong>GFSJSNK</strong>). They built the foundation of modern public health.</p>
            
            <div class="timeline-container">
                <!-- Graunt -->
                <div class="timeline-item">
                    <div class="timeline-marker blue"></div>
                    <div class="timeline-content">
                        <div class="timeline-date" style="background: var(--accent-blue); color: black;">1662</div>
                        <div class="timeline-title">John Graunt</div>
                        <p style="margin:0; font-size:0.95rem;"><strong>"Father of Demography"</strong>. Analyzed Bills of Mortality in London to identify seasonal patterns in death. First to quantify health data.</p>
                    </div>
                </div>

                <!-- Jenner -->
                <div class="timeline-item">
                    <div class="timeline-marker green"></div>
                    <div class="timeline-content">
                        <div class="timeline-date" style="background: var(--accent-green); color: black;">1796</div>
                        <div class="timeline-title">Edward Jenner</div>
                        <p style="margin:0; font-size:0.95rem;">Developed the first <strong>Smallpox Vaccine</strong> using cowpox material. Proved protection could be induced.</p>
                    </div>
                </div>

                <!-- Farr -->
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">1800s</div>
                        <div class="timeline-title">William Farr</div>
                        <p style="margin:0; font-size:0.95rem;">Developed vital statistics systems and the concept of <strong>"Surveillance"</strong>. Standardized disease classification.</p>
                    </div>
                </div>

                <!-- Semmelweis -->
                <div class="timeline-item">
                    <div class="timeline-marker orange"></div>
                    <div class="timeline-content">
                        <div class="timeline-date" style="background: var(--accent-orange);">1840s</div>
                        <div class="timeline-title">Ignaz Semmelweis</div>
                        <p style="margin:0; font-size:0.95rem;"><strong>"The Savior of Mothers"</strong>. Proved handwashing reduced childbed fever in Vienna hospitals. Rejected by peers.</p>
                    </div>
                </div>

                <!-- Snow -->
                <div class="timeline-item">
                    <div class="timeline-marker purple"></div>
                    <div class="timeline-content">
                        <div class="timeline-date" style="background: var(--accent-purple);">1854</div>
                        <div class="timeline-title">John Snow</div>
                        <p style="margin:0; font-size:0.95rem;"><strong>"Father of Field Epidemiology"</strong>. Mapped cholera cases in Soho to the Broad Street Pump. Stopped outbreak without knowing the germ.</p>
                    </div>
                </div>

                 <!-- Nightingale -->
                 <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date" style="background: var(--pink-500);">1850s</div>
                        <div class="timeline-title">Florence Nightingale</div>
                        <p style="margin:0; font-size:0.95rem;">Pioneer of Nursing and <strong>Data Visualization</strong>. Used "Rose Diagrams" to show soldiers died from poor sanitation, not wounds.</p>
                    </div>
                </div>

                <!-- Koch -->
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date" style="background: #333;">1880s</div>
                        <div class="timeline-title">Robert Koch</div>
                        <p style="margin:0; font-size:0.95rem;">Validated <strong>Germ Theory</strong>. Developed "Koch's Postulates" to strictly link specific microbes to specific diseases (e.g., Anthrax, TB).</p>
                    </div>
                </div>
            </div>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: John Snow's Method
                </div>
                <div class="callout-content">
                    <p><strong>He didn't know the germ!</strong></p>
                    <p>John Snow stopped the cholera outbreak by removing the pump handle <em>before</em> anyone knew bacteria caused it. He used <strong>observational epidemiology</strong> (mapping residence of cases) to find the risk factor.</p>
                </div>
            </div>

            <h2>2.2 Recent Outbreak Milestones</h2>
            <div class="timeline-container">
                 <!-- Legionnaires -->
                 <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">1976</div>
                        <div class="timeline-title">Legionnaires' Disease</div>
                        <p style="margin:0; font-size:0.95rem;">Philadelphia. Discovered in AC cooling towers. Classic <em>point source</em> investigation leading to new pathogen discovery.</p>
                    </div>
                </div>

                <!-- HIV -->
                <div class="timeline-item">
                     <div class="timeline-marker"></div>
                     <div class="timeline-content">
                         <div class="timeline-date">1981</div>
                         <div class="timeline-title">HIV/AIDS</div>
                         <p style="margin:0; font-size:0.95rem;">First recognized in MMWR as Pneumocystis pneumonia clusters in young men. Identifying a syndrome before the virus.</p>
                     </div>
                 </div>

                 <!-- SARS -->
                 <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">2003</div>
                        <div class="timeline-title">SARS</div>
                        <p style="margin:0; font-size:0.95rem;">First pandemic of 21st century. Highlighted global spread via air travel and "super-spreader" events.</p>
                    </div>
                </div>

                 <!-- H1N1 -->
                 <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">2009</div>
                        <div class="timeline-title">H1N1 (Swine Flu)</div>
                        <p style="margin:0; font-size:0.95rem;">First major influenza pandemic since 1968. Rapid global spread; highlighted success in modern vaccine development speed.</p>
                    </div>
                </div>

                 <!-- Ebola -->
                 <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">2014</div>
                        <div class="timeline-title">Ebola (West Africa)</div>
                        <p style="margin:0; font-size:0.95rem;">Largest Ebola outbreak in history. Emphasized need for contact tracing and cultural sensitivity in burial practices.</p>
                    </div>
                </div>

                 <!-- COVID-19 -->
                 <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">2019</div>
                        <div class="timeline-title">COVID-19</div>
                        <p style="margin:0; font-size:0.95rem;">SARS-CoV-2. Demonstrated challenge of <strong>asymptomatic spread</strong>. massive global intervention (social distancing, mRNA vaccines).</p>
                    </div>
                </div>
            </div>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Mnemonic: GFSJSNK
                </div>
                <div class="callout-content">
                    <p><strong>"Great Folks Studying Joyfully Save Nations Kindly"</strong></p>
                    <ul>
                        <li><strong>G</strong>raunt (Counting)</li>
                        <li><strong>F</strong>arr (Statistics)</li>
                        <li><strong>S</strong>now (Pump)</li>
                        <li><strong>J</strong>enner (Vaccine)</li>
                        <li><strong>S</strong>emmelweis (Hands)</li>
                        <li><strong>N</strong>ightingale (Nursing/Charts)</li>
                        <li><strong>K</strong>och (Germs)</li>
                    </ul>
                </div>
            </div>

            <h2>2.3 The Natural History Timeline</h2>
            <p>Diseases progress through predictable stages. Understanding this helps you identify where to intervene!</p>
            
            <div class="neo-card" style="margin: 1.5rem 0;">
                <ol style="padding-left: 1.5rem;">
                    <li style="margin-bottom: 1rem;">
                        <strong>Stage of Susceptibility</strong>
                        <div style="color: #666;">Disease has not started. Risk factors are present.</div>
                    </li>
                    <li style="margin-bottom: 1rem;">
                        <strong>Stage of Subclinical Disease</strong>
                        <div style="color: #666;">Exposure has occurred. Pathological changes are happening, but <strong>NO symptoms yet</strong>.</div>
                        <div style="background: #fff3cd; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.9rem;">(This is the <strong>Incubation Period</strong>)</div>
                    </li>
                    <li style="margin-bottom: 1rem;">
                        <strong>Stage of Clinical Disease</strong>
                        <div style="color: #666;">Symptoms appear (<strong>Onset</strong>). Diagnosis is usually made here.</div>
                    </li>
                    <li style="margin-bottom: 1rem;">
                        <strong>Stage of Recovery, Disability, or Death</strong>
                        <div style="color: #666;">The outcome of the disease process.</div>
                    </li>
                </ol>
            </div>

            <h2>2.4 Carriers</h2>
            <p>A <strong>Carrier</strong> is a person who harbors the infectious agent without showing symptoms but can still infect others.</p>
            
            <div class="table-container"><table class="table">
                <thead style="background: var(--navy-primary); color: white;">
                    <tr>
                        <th style="padding: 0.75rem; text-align: left;">Type</th>
                        <th style="padding: 0.75rem; text-align: left;">Example Scenario</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 0.75rem;"><strong>Symptomatic Carrier</strong></td>
                        <td style="padding: 0.75rem;">A person with mild flu who goes to work.</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.75rem;"><strong>Asymptomatic (Healthy) Carrier</strong></td>
                        <td style="padding: 0.75rem;">"Typhoid Mary" - never felt sick but shed bacteria.</td>
                    </tr>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 0.75rem;"><strong>Convalescent Carrier</strong></td>
                        <td style="padding: 0.75rem;">Recovering from Salmonella but still infectious for weeks.</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.75rem;"><strong>Incubatory Carrier</strong></td>
                        <td style="padding: 0.75rem;">Spreading Chickenpox before the rash appears.</td>
                    </tr>
                </tbody>
            </table></div>
            
            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Generation Time
                </div>
                <div class="callout-content">
                    <p><strong>Generation Time:</strong> The time interval between infection of host A and infection of host B.</p>
                    <p style="background: #fef2f2; padding: 0.5rem; border-radius: 4px; border-left: 3px solid #ef4444;">If <strong>Generation Time &lt; Incubation Period</strong>, the disease spreads before it is detected (hard to control!).</p>
                </div>
            </div>

            <h3>2.4.1 Carrier Drill</h3>
            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-question"></i>
                    Identify the Carrier Type
                </div>
                <div class="callout-content">
                    <p><strong>Scenario 1:</strong> "Typhoid Mary" felt perfectly healthy but spread Typhoid Fever to families she cooked for over many years.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Asymptomatic (Healthy) Carrier</strong> - Never showed symptoms but was infectious for years.</p>
                        </div>
                    </div>
                    
                    <p style="margin-top: 1rem;"><strong>Scenario 2:</strong> A student feels fine on Monday but infects his classmates. On Tuesday, he wakes up with a fever and rash.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Incubatory Carrier</strong> - Was infectious during the incubation period (before symptoms).</p>
                        </div>
                    </div>
                    
                    <p style="margin-top: 1rem;"><strong>Scenario 3:</strong> A patient recovers from diarrhea but continues to shed bacteria in stool for 2 weeks.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Convalescent Carrier</strong> - Recovered from illness but still shedding pathogen.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: "Typhoid Mary" Mallon
                </div>
                <div class="callout-content">
                    <p><strong>Mary Mallon (1869-1938)</strong> was the first identified healthy carrier of typhoid fever in the US. Working as a cook, she infected at least 53 people (3 died). She refused to believe she was the source because she felt healthy, illustrating the danger of the <strong>asymptomatic carrier</strong> state. She was forcibly quarantined for the last 23 years of her life.</p>
                </div>
            </div>
            </div>

            <div class="neo-card" style="background: #f0fdf4; border-left: 4px solid #22c55e; margin: 1.5rem 0;">
                <h4 style="margin-top: 0;"><i class="ph-bold ph-check-circle"></i> Summary</h4>
                <ul>
                    <li><strong>Incubation:</strong> Exposure to Symptoms (Infectious).</li>
                    <li><strong>Latency:</strong> Exposure to Disease (Chronic).</li>
                    <li><strong>Carrier:</strong> Infectious but no symptoms.</li>
                </ul>
            </div>

            <h2>2.5 Exam Focus &amp; Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Incubation vs Latency:</strong> Know the difference (Infectious vs Chronic).</li>
                        <li><strong>Carrier Types:</strong> Incubatory, Convalescent, Chronic, Healthy.</li>
                        <li><strong>Natural History:</strong> Susceptibility â†’ Subclinical â†’ Clinical â†’ Outcome.</li>
                    </ul>
                </div>
            </div>
        `
    },
    ch3: {
        title: "Chapter 3: Causation & Transmission",
        difficulty: "B/M",
        content: `
            <h1>Chapter 3: Causation & Transmission</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 2px solid #166534; font-weight: bold; box-shadow: 0 2px 4px rgba(21, 128, 61, 0.2); opacity: 1;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 2px solid #ca8a04; font-weight: bold; box-shadow: 0 2px 4px rgba(202, 138, 4, 0.2); opacity: 1;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">Understanding how disease spreads is the first step to stopping it. This chapter covers the fundamental models of disease causation and transmission.</p>

            <h2>3.1 The Epidemiologic Triad</h2>
            <p>The traditional model for infectious disease causation involves the interaction of three elements:</p>

            <!-- Interactive Visual Root -->
            <div id="triad-interactive-root" style="margin: 2rem 0;"></div>

            <script>
                // Self-executing check to render if navigated directly
                if(typeof VisualComponents !== 'undefined' && document.getElementById('triad-interactive-root')) {
                    VisualComponents.renderTriad('triad-interactive-root');
                }
            </script>

            
            <div class="callout-info" style="background: #eef2ff; border-left: 4px solid var(--accent-purple);">
                <h4><i class="ph-bold ph-share-network"></i> Beyond the Triad</h4>
                <p>The Triad is great for infectious disease, but for chronic disease (like heart disease) or complex outbreaks, we use updated models:</p>
                <ul>
                    <li><strong>Wheel of Causation:</strong> Host at center, surrounded by biologic, physical, and social environments. De-emphasizes the "agent". Useful for chronic diseases.</li>
                    <li><strong>Web of Causation:</strong> A complex network of factors where no single cause is necessary or sufficient. Used for multifactorial diseases like cancer.</li>
                    <li><strong>Rothman's Causal Pies:</strong> "Pies" represent sufficient causes. Each slice is a component cause. When the pie is full, disease occurs.</li>
                </ul>
                <div style="text-align: center; margin-top: 2rem;">
                    <!-- Rothman's Causal Pie SVG -->
                    <svg width="450" height="220" viewBox="0 0 450 220" class="responsive-svg">
                        <!-- Definitions -->
                        <defs>
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="2" dy="2" stdDeviation="2" flood-opacity="0.2"/>
                            </filter>
                        </defs>

                        <!-- Pie 1: Sufficient Cause I -->
                        <g transform="translate(110, 100)">
                            <!-- Slice A (Necessary) -->
                            <path d="M0,0 L0,-80 A80,80 0 0,1 80,0 Z" fill="#FF9AA2" stroke="white" stroke-width="2" />
                            <text x="25" y="-30" font-family="Arial" font-weight="bold" fill="#333">A</text>
                            
                            <!-- Slice B -->
                            <path d="M0,0 L80,0 A80,80 0 0,1 0,80 Z" fill="#FFB7B2" stroke="white" stroke-width="2" />
                            <text x="30" y="40" font-family="Arial" fill="#333">B</text>

                            <!-- Slice C -->
                            <path d="M0,0 L0,80 A80,80 0 0,1 -80,0 Z" fill="#FFDAC1" stroke="white" stroke-width="2" />
                            <text x="-30" y="40" font-family="Arial" fill="#333">C</text>

                            <!-- Slice D -->
                            <path d="M0,0 L-80,0 A80,80 0 0,1 0,-80 Z" fill="#E2F0CB" stroke="white" stroke-width="2" />
                            <text x="-30" y="-30" font-family="Arial" fill="#333">D</text>

                            <text x="0" y="110" text-anchor="middle" font-size="14" font-weight="bold" fill="var(--navy-primary)">Sufficient Cause I</text>
                        </g>

                        <!-- Pie 2: Sufficient Cause II -->
                        <g transform="translate(340, 100)">
                            <!-- Slice A (Necessary - present in both!) -->
                            <path d="M0,0 L0,-80 A80,80 0 0,1 80,0 Z" fill="#FF9AA2" stroke="white" stroke-width="2" />
                            <text x="25" y="-30" font-family="Arial" font-weight="bold" fill="#333">A</text>
                            
                            <!-- Slice E -->
                            <path d="M0,0 L80,0 A80,80 0 0,1 0,80 Z" fill="#B5EAD7" stroke="white" stroke-width="2" />
                            <text x="30" y="40" font-family="Arial" fill="#333">E</text>

                            <!-- Slice F -->
                            <path d="M0,0 L0,80 A80,80 0 1,1 0,-80 Z" fill="#C7CEEA" stroke="white" stroke-width="2" />
                            <text x="-40" y="10" font-family="Arial" fill="#333">F</text>

                            <text x="0" y="110" text-anchor="middle" font-size="14" font-weight="bold" fill="var(--navy-primary)">Sufficient Cause II</text>
                        </g>
                    </svg>
                    <p style="font-size: 0.9rem; color: #555; margin-top: 0.5rem; max-width: 600px; margin-left: auto; margin-right: auto;">
                        <strong>Rothman's Pies:</strong> Each full pie causes disease. 
                        <span style="background:#FF9AA2; padding: 2px 6px; border-radius: 4px;">A</span> is a <strong>Necessary Cause</strong> (must be present in all pies). 
                        Other letters are Component Causes.
                    </p>
                </div>
            </div>

            <h2>3.2 The Chain of Infection</h2>
            <p>For disease to spread, a complete chain of events must occur. Breaking ANY link stops the outbreak.</p>

            <ol>
                <li><strong>Infectious Agent:</strong> The pathogen itself.</li>
                <li><strong>Reservoir:</strong> Where the agent lives and multiplies (Human, Animal, Soil).</li>
                <li><strong>Portal of Exit:</strong> How it leaves the reservoir (Cough, Feces, Blood).</li>
                <li><strong>Mode of Transmission:</strong> How it travels (Direct or Indirect).</li>
                <li><strong>Portal of Entry:</strong> How it enters the new host (Mouth, Nose, Skin).</li>
                <li><strong>Susceptible Host:</strong> Someone with no immunity.</li>
            </ol>
            
            <div style="text-align: center; margin: 2rem 0;">
                <svg width="600" height="400" viewBox="0 0 600 400" class="responsive-svg" style="max-width: 100%; height: auto;">
                    <!-- Definitions for markers -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
                        </marker>
                    </defs>
                    
                    <!-- Center Icon/Text -->
                    <circle cx="300" cy="200" r="60" fill="var(--gray-bg)" stroke="var(--navy-primary)" stroke-width="2" stroke-dasharray="5,5" />
                    <text x="300" y="205" text-anchor="middle" font-weight="bold" fill="var(--navy-primary)">INFECTION</text>

                    <!-- Nodes (Hexagon Layout) -->
                    <!-- 1. Agent (Top) -->
                    <g transform="translate(300, 50)">
                        <rect x="-70" y="-25" width="140" height="50" rx="10" fill="white" stroke="var(--teal-accent)" stroke-width="2"/>
                        <text x="0" y="5" text-anchor="middle" font-weight="bold" fill="#333">1. Agent</text>
                    </g>

                    <!-- 2. Reservoir (Top Right) -->
                    <g transform="translate(500, 120)">
                       <rect x="-70" y="-25" width="140" height="50" rx="10" fill="white" stroke="var(--teal-accent)" stroke-width="2"/>
                        <text x="0" y="5" text-anchor="middle" font-weight="bold" fill="#333">2. Reservoir</text>
                    </g>

                    <!-- 3. Portal Exit (Bottom Right) -->
                    <g transform="translate(500, 280)">
                        <rect x="-70" y="-25" width="140" height="50" rx="10" fill="white" stroke="var(--teal-accent)" stroke-width="2"/>
                        <text x="0" y="5" text-anchor="middle" font-weight="bold" fill="#333">3. Portal Exit</text>
                    </g>
                    
                    <!-- 4. Mode of Trans (Bottom) -->
                    <g transform="translate(300, 350)">
                        <rect x="-80" y="-25" width="160" height="50" rx="10" fill="white" stroke="var(--teal-accent)" stroke-width="2"/>
                        <text x="0" y="5" text-anchor="middle" font-weight="bold" fill="#333">4. Transmission</text>
                    </g>

                    <!-- 5. Portal Entry (Bottom Left) -->
                    <g transform="translate(100, 280)">
                        <rect x="-70" y="-25" width="140" height="50" rx="10" fill="white" stroke="var(--teal-accent)" stroke-width="2"/>
                        <text x="0" y="5" text-anchor="middle" font-weight="bold" fill="#333">5. Portal Entry</text>
                    </g>

                    <!-- 6. Host (Top Left) -->
                    <g transform="translate(100, 120)">
                        <rect x="-70" y="-25" width="140" height="50" rx="10" fill="white" stroke="var(--teal-accent)" stroke-width="2"/>
                        <text x="0" y="5" text-anchor="middle" font-weight="bold" fill="#333">6. Host</text>
                    </g>

                    <!-- Connecting Arrows -->
                    <!-- 1 -> 2 -->
                    <path d="M370,50 Q430,50 500,95" fill="none" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <!-- 2 -> 3 -->
                    <path d="M500,145 Q500,200 500,255" fill="none" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <!-- 3 -> 4 -->
                    <path d="M500,305 Q430,350 380,350" fill="none" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <!-- 4 -> 5 -->
                    <path d="M220,350 Q170,350 100,305" fill="none" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <!-- 5 -> 6 -->
                    <path d="M100,255 Q100,200 100,145" fill="none" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <!-- 6 -> 1 -->
                    <path d="M100,95 Q170,50 230,50" fill="none" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>

                    <!-- Break Points (Red X) -->
                    <text x="450" y="60" fill="red" font-size="20">âœ•</text>
                    <text x="510" y="200" fill="red" font-size="20">âœ•</text>
                    <text x="450" y="340" fill="red" font-size="20">âœ•</text>
                    <text x="150" y="340" fill="red" font-size="20">âœ•</text>
                    <text x="90" y="200" fill="red" font-size="20">âœ•</text>
                    <text x="150" y="60" fill="red" font-size="20">âœ•</text>
                </svg>
                <p style="font-size: 0.9rem; color: #666; font-style: italic;">The Chain of Infection: Break ANY link to stop the spread!</p>
            </div>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Study Guide Tip: Breaking the Chain
                </div>
                <div class="callout-content">
                    <p>Public health interventions work by targeting specific links:</p>
                    <ul>
                        <li><strong>Handwashing:</strong> Breaks Mode of Transmission.</li>
                        <li><strong>Vaccination:</strong> Protects Susceptible Host.</li>
                        <li><strong>Antibiotics:</strong> Kills Infectious Agent.</li>
                        <li><strong>Masks:</strong> Blocks Portal of Exit/Entry.</li>
                    </ul>
                </div>
            </div>

            <h2>3.3 Modes of Transmission</h2>

            <h3>Direct Transmission</h3>
            <ul>
                <li><strong>Direct Contact:</strong> Skin-to-skin, kissing, sexual intercourse (e.g., Herpes, HIV).</li>
                <li><strong>Droplet Spread:</strong> Large spray over short distance (< 1 meter) from sneezing/coughing (e.g., Pertussis, Meningococcal).</li>
            </ul>

            <h3>Indirect Transmission</h3>
            <ul>
                <li><strong>Airborne:</strong> Tiny particles suspended in air for long distances/time (e.g., Measles, TB).</li>
                <li><strong>Vehicleborne:</strong> Food, water, blood, or inanimate objects (fomites).</li>
                <li><strong>Vectorborne:</strong> Living organisms (mosquitoes, ticks, fleas).</li>
            </ul>

            <div class="study-tip">
                 <div class="callout-header"><i class="ph ph-lightbulb"></i> Mnemonic: IWAF</div>
                 <div class="callout-content">
                    <p>Major transmission routes for exam questions:</p>
                    <ul>
                        <li><strong>I</strong>nsects (Vector - Malaria, Lyme)</li>
                        <li><strong>W</strong>ater (Vehicle - Cholera, Giardia)</li>
                        <li><strong>A</strong>ir (Airborne - TB, Measles)</li>
                        <li><strong>F</strong>ood (Vehicle - Salmonella, E. coli)</li>
                    </ul>
                 </div>
            <div style="margin: 2rem 0;">
                <h3 style="color: var(--teal-accent);">Crucial Distinction: Droplet vs. Airborne</h3>
                <p>This is a top exam concept. How far does the spit go?</p>
                <div class="table-container"><table class="table">
                    <thead style="background: var(--navy-primary); color: white;">
                        <tr>
                            <th style="padding: 1rem; text-align: left;">Feature</th>
                            <th style="padding: 1rem; text-align: left;">Droplet</th>
                            <th style="padding: 1rem; text-align: left;">Airborne</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: var(--gray-bg);">
                            <td style="padding: 1rem;"><strong>Particle Size</strong></td>
                            <td style="padding: 1rem;">Large (> 5 microns)</td>
                            <td style="padding: 1rem;">Tiny (< 5 microns)</td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem;"><strong>Distance</strong></td>
                            <td style="padding: 1rem;">Falls quickly (< 6 feet)</td>
                            <td style="padding: 1rem;">Floats (Can fill a room)</td>
                        </tr>
                        <tr style="background: var(--gray-bg);">
                            <td style="padding: 1rem;"><strong>Example</strong></td>
                            <td style="padding: 1rem;">Flu, Pertussis, Meningitis</td>
                            <td style="padding: 1rem;">TB, Measles, Chickenpox</td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem;"><strong>PPE</strong></td>
                            <td style="padding: 1rem;">Standard Surgical Mask</td>
                            <td style="padding: 1rem;">N95 Respirator (Fit-tested)</td>
                        </tr>
                    </tbody>
                </table></div>
            </div>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Vector vs. Vehicle
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> Confusing Vectors and Vehicles.</p>
                    <ul>
                        <li><strong>Vector:</strong> ALIVE (Mosquito, Tick, Fly).</li>
                        <li><strong>Vehicle:</strong> NON-LIVING (Food, Water, Doorknob).</li>
                    </ul>
                    <p><strong>Tricky Case:</strong> A fly landing on food is a mechanical vector. The food itself is a vehicle.</p>
                </div>
            </div>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Fomites
                </div>
                <div class="callout-content">
                    <p>A <strong>Fomite</strong> is a specific type of vehicle: an inanimate object that can carry disease agents.</p>
                    <p><strong>Examples:</strong> Doorknobs, bedding, surgical instruments, toys in a daycare.</p>
                    <p><em>Note: Fomites are NOT vectors!</em></p>
                </div>
            </div>

            <h2>3.4 Transmission Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Identify the Mode
                </div>
                <div class="callout-content">
                    <p><strong>Scenario 1:</strong> A child gets sick after playing with a toy that a sick child slobbered on.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Indirect - Vehicleborne (Fomite)</strong></p>
                            <p>The toy is an inanimate object (fomite) acting as a vehicle.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 2:</strong> A hiker gets Lyme disease from a tick bite.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Indirect - Vectorborne</strong></p>
                            <p>The tick is a living organism (vector).</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 3:</strong> Someone gets Tuberculosis (TB) after sitting in a waiting room where a patient coughed 2 hours ago.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Indirect - Airborne</strong></p>
                            <p>TB stays suspended in the air for long periods. This is NOT droplet spread (which falls quickly).</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Triad:</strong> Agent, Host, Environment.</li>
                <li><strong>Chain:</strong> 6 links must be intact for spread.</li>
                <li><strong>Vector:</strong> Living carrier.</li>
                <li><strong>Vehicle:</strong> Non-living carrier (includes Fomites).</li>
            </ul>

            <div class="neo-card small" style="background: #fff0f0; border-left: 4px solid var(--danger);">
                 <h3><i class="ph-bold ph-skull"></i> Prion Diseases (ADVANCED)</h3>
                 <p>Prions are transmissible proteins (not viruses/bacteria). They are resistant to standard sterilization.</p>
                 <p><strong>Example:</strong> Creutzfeldt-Jakob Disease (CJD), Mad Cow Disease (BSE).</p>
            </div>

            <h2>3.5 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Triangle:</strong> Agent, Host, Environment.</li>
                        <li><strong>Chain of Infection:</strong> Know all 6 links and how to break them.</li>
                        <li><strong>Vector vs Vehicle:</strong> Living vs Non-living. Fomites are Vehicles!</li>
                    </ul>
                </div>
            </div>

            <!-- New Section 3.6: Beyond the Triad -->
            <h2>3.6 Beyond the Triad: Wheel, Web & Causal Pie Models</h2>
            <p>While the epidemiologic triad provides a simple starting framework, realâ€‘world disease causation is often more complex. Advanced models recognise that multiple component causes interact.</p>
            <h3>The Wheel Model</h3>
            <p>The <strong>Wheel of Causation</strong> places the <em>host</em> at the centre, surrounded by overlapping segments of the physical, biologic and social environment. These segments emphasise that environmental factors, not just a single agent, shape disease.</p>
            
            <div style="text-align: center; margin: 2rem 0;">
                <svg width="400" height="400" viewBox="0 0 400 400" class="responsive-svg">
                    <defs>
                        <filter id="shadow">
                           <feDropShadow dx="2" dy="2" stdDeviation="2" flood-opacity="0.2"/>
                        </filter>
                    </defs>

                    <!-- Outer Environment Ring -->
                    <circle cx="200" cy="200" r="180" fill="#f3f4f6" stroke="#d1d5db" stroke-width="2"/>
                    
                    <!-- Environment Segments (Biologic, Physical, Social) -->
                    <!-- Biologic (Top Left) -->
                    <path d="M200,200 L200,20 A180,180 0 0,0 44,110 Z" fill="#dbeafe" stroke="white" stroke-width="2"/>
                    <text x="130" y="100" text-anchor="middle" font-weight="bold" fill="#1e40af">Biologic Env</text>
                    <text x="130" y="115" text-anchor="middle" font-size="10" fill="#1e3a8a">(Viruses, Vectors)</text>

                    <!-- Physical (Top Right) -->
                    <path d="M200,200 L356,110 A180,180 0 0,0 200,20 Z" fill="#fce7f3" stroke="white" stroke-width="2"/>
                    <text x="270" y="100" text-anchor="middle" font-weight="bold" fill="#9d174d">Physical Env</text>
                    <text x="270" y="115" text-anchor="middle" font-size="10" fill="#831843">(Geography, Climate)</text>
                    
                    <!-- Social (Bottom) -->
                    <path d="M200,200 L44,110 A180,180 0 0,0 356,110 Z" fill="#d1fae5" stroke="white" stroke-width="2"/>
                    <text x="200" y="320" text-anchor="middle" font-weight="bold" fill="#065f46">Social Env</text>
                    <text x="200" y="335" text-anchor="middle" font-size="10" fill="#064e3b">(Poverty, Policy)</text>

                    <!-- Inner Host Hub (Genetics) -->
                    <circle cx="200" cy="200" r="60" fill="white" stroke="#333" stroke-width="3" filter="url(#shadow)"/>
                    <text x="200" y="195" text-anchor="middle" font-weight="900" font-size="14" fill="#333">HOST</text>
                    <text x="200" y="215" text-anchor="middle" font-size="11" font-weight="bold" fill="#555">(Genetics)</text>
                </svg>
                <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 0.5rem;"><em>Prioritizes multiple causes over a single "Agent".</em></p>
            </div>

            <h3>The Web of Causation</h3>
            <p>The <strong>Web of Causation</strong> represents disease as a network of interconnected factors. There is no single necessary agent; instead, multiple exposures and conditions weave together. Cutting any key strand can help prevent disease.</p>
            <h3>Rothmanâ€™s Causal Pies</h3>
            <p>In <strong>Rothmanâ€™s Causal Pie</strong> model, each pie represents a sufficient cause. Each slice is a <em>component cause</em> such as an exposure or genetic predisposition. When all slices are present, the pie is complete and disease occurs. Different pies may share slices, illustrating why some factors are necessary but not sufficient on their own.</p>
            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Socio-Economic Determinants
                </div>
                <div class="callout-content">
                    <p>Disease is not just biological; it's social. Factors include:</p>
                    <ul>
                         <li><strong>Income & Housing:</strong> Overcrowding increases TB spread.</li>
                         <li><strong>Education:</strong> Health literacy affects prevention.</li>
                         <li><strong>Access:</strong> "Food deserts" lead to poor nutrition.</li>
                    </ul>
                </div>
            </div>
            <h2>3.7 Bradford Hill's Criteria for Causation</h2>
            <p>How do we know if an association is actually <strong>CAUSAL</strong>? Austin Bradford Hill established 9 criteria.</p>
            
            <div style="text-align: center; margin: 2rem 0;">
                <svg width="600" height="400" viewBox="0 0 600 400" class="responsive-svg" style="max-width: 100%; height: auto; background: white; border: 2px solid var(--navy-primary); border-radius: 8px;">
                    <defs>
                        <filter id="dropshadow" height="130%">
                          <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                          <feOffset dx="2" dy="2" result="offsetblur"/>
                          <feComponentTransfer>
                            <feFuncA type="linear" slope="0.2"/>
                          </feComponentTransfer>
                          <feMerge> 
                            <feMergeNode/>
                            <feMergeNode in="SourceGraphic"/> 
                          </feMerge>
                        </filter>
                    </defs>

                    <text x="300" y="30" text-anchor="middle" font-weight="bold" font-size="20" fill="var(--navy-primary)">Hill's Criteria (The "Big 9")</text>

                    <!-- Grid Layout for 9 Items -->
                    <!-- Row 1 -->
                    <g transform="translate(50, 60)">
                        <rect x="0" y="0" width="150" height="80" rx="4" fill="#e0f2f1" stroke="#00695c" stroke-width="2"/>
                        <text x="75" y="30" text-anchor="middle" font-weight="bold" fill="#00695c">1. Strength</text>
                        <text x="75" y="50" text-anchor="middle" font-size="10" fill="#333">Large RR/OR?</text>
                    </g>
                    <g transform="translate(225, 60)">
                        <rect x="0" y="0" width="150" height="80" rx="4" fill="#e0f2f1" stroke="#00695c" stroke-width="2"/>
                        <text x="75" y="30" text-anchor="middle" font-weight="bold" fill="#00695c">2. Consistency</text>
                        <text x="75" y="50" text-anchor="middle" font-size="10" fill="#333">Seen in other studies?</text>
                    </g>
                    <g transform="translate(400, 60)">
                        <rect x="0" y="0" width="150" height="80" rx="4" fill="#e0f2f1" stroke="#00695c" stroke-width="2"/>
                        <text x="75" y="30" text-anchor="middle" font-weight="bold" fill="#00695c">3. Specificity</text>
                        <text x="75" y="50" text-anchor="middle" font-size="10" fill="#333">One cause, one disease?</text>
                    </g>

                    <!-- Row 2 -->
                    <g transform="translate(50, 160)">
                        <rect x="0" y="0" width="150" height="80" rx="4" fill="#fff3e0" stroke="#ef6c00" stroke-width="2"/>
                         <text x="75" y="25" text-anchor="middle" font-weight="bold" fill="#ef6c00" font-size="14">4. Temporality</text>
                         <text x="75" y="45" text-anchor="middle" font-size="10" fill="#333" font-weight="bold">Cause BEFORE</text>
                         <text x="75" y="60" text-anchor="middle" font-size="10" fill="#333" font-weight="bold">Effect</text>
                         <!-- Star icon for emphasis -->
                         <path d="M135,10 L140,25 L155,25 L142,35 L147,50 L135,40 L123,50 L128,35 L115,25 L130,25 Z" fill="gold" stroke="orange" transform="scale(0.6) translate(180,20)"/>
                    </g>
                    <g transform="translate(225, 160)">
                        <rect x="0" y="0" width="150" height="80" rx="4" fill="#e0f2f1" stroke="#00695c" stroke-width="2"/>
                        <text x="75" y="30" text-anchor="middle" font-weight="bold" fill="#00695c">5. Bio Gradient</text>
                        <text x="75" y="50" text-anchor="middle" font-size="10" fill="#333">More dose = More disease?</text>
                    </g>
                    <g transform="translate(400, 160)">
                        <rect x="0" y="0" width="150" height="80" rx="4" fill="#e0f2f1" stroke="#00695c" stroke-width="2"/>
                        <text x="75" y="30" text-anchor="middle" font-weight="bold" fill="#00695c">6. Plausibility</text>
                        <text x="75" y="50" text-anchor="middle" font-size="10" fill="#333">Does biology make sense?</text>
                    </g>

                    <!-- Row 3 -->
                    <g transform="translate(50, 260)">
                        <rect x="0" y="0" width="150" height="80" rx="4" fill="#e0f2f1" stroke="#00695c" stroke-width="2"/>
                        <text x="75" y="30" text-anchor="middle" font-weight="bold" fill="#00695c">7. Coherence</text>
                        <text x="75" y="50" text-anchor="middle" font-size="10" fill="#333">Facts fit known history?</text>
                    </g>
                    <g transform="translate(225, 260)">
                        <rect x="0" y="0" width="150" height="80" rx="4" fill="#e0f2f1" stroke="#00695c" stroke-width="2"/>
                        <text x="75" y="30" text-anchor="middle" font-weight="bold" fill="#00695c">8. Experiment</text>
                        <text x="75" y="50" text-anchor="middle" font-size="10" fill="#333">Does prevention work?</text>
                    </g>
                    <g transform="translate(400, 260)">
                        <rect x="0" y="0" width="150" height="80" rx="4" fill="#e0f2f1" stroke="#00695c" stroke-width="2"/>
                        <text x="75" y="30" text-anchor="middle" font-weight="bold" fill="#00695c">9. Analogy</text>
                        <text x="75" y="50" text-anchor="middle" font-size="10" fill="#333">Similar to other diseases?</text>
                    </g>
                    
                    <!-- Essential Note -->
                    <text x="300" y="375" text-anchor="middle" font-style="italic" fill="#c62828" font-size="14">* Temporality is the ONLY necessary criterion!</text>
                </svg>
            </div>

        `
    },
    ch4: {
        title: "Chapter 4: Measures of Frequency",
        difficulty: "B",
        content: `
    <h1> Chapter 4: Measures of Frequency</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 2px solid #166534; font-weight: bold; box-shadow: 0 2px 4px rgba(21, 128, 61, 0.2); opacity: 1;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 1px solid #ca8a04; opacity: 0.3;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">To describe how often a disease occurs, epidemiologists use three main types of measures: <strong>Counts</strong>, <strong>Proportions</strong>, and <strong>Rates</strong>. Mastering the difference between Incidence and Prevalence is fundamental.</p>

            <h2>4.1 The Three Types of Measures</h2>

            <div class="table-container"><table class="table">
                <thead style="background: var(--navy-primary); color: white;">
                    <tr>
                        <th style="padding: 1rem; text-align: left;">Measure</th>
                        <th style="padding: 1rem; text-align: left;">Definition</th>
                        <th style="padding: 1rem; text-align: left;">Example</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Count</strong></td>
                        <td style="padding: 1rem;">Just the number of cases (no denominator).</td>
                        <td style="padding: 1rem;">"5 cases of measles"</td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>Proportion</strong></td>
                        <td style="padding: 1rem;">Numerator is PART of the denominator. (Usually %).</td>
                        <td style="padding: 1rem;">"20% of students are sick"</td>
                    </tr>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Rate</strong></td>
                        <td style="padding: 1rem;">Frequency of event over TIME.</td>
                        <td style="padding: 1rem;">"50 cases per 100,000 per year"</td>
                    </tr>
                </tbody>
            </table></div>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Rate vs. Proportion
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "Attack Rate" is technically a <strong>PROPORTION</strong>, not a rate!</p>
                    <p>Why? Because it doesn't strictly include time in the denominator (it's just Ill / Total). However, we still call it a "rate" by convention. Be ready for this semantic trick question.</p>
                </div>
            </div>

            <h2>4.2 Incidence vs. Prevalence</h2>
            <p>This is the most important distinction in descriptive epidemiology.</p>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Study Guide Tip: The Bathtub Analogy
                </div>
                <div class="callout-content">
                    <p>Imagine a bathtub filled with water:</p>
                    
                    <div style="text-align: center; margin: 1.5rem 0;">
                        <svg width="300" height="220" viewBox="0 0 300 220" class="responsive-svg" style="max-width: 100%; height: auto;">
                            <!-- Faucet (Incidence) -->
                            <path d="M50,10 L100,10 L100,30 L80,30 L80,40" fill="#999" stroke="#666" stroke-width="2"/>
                            <text x="75" y="25" font-size="12" fill="#333" font-weight="bold">Incidence</text>
                            
                            <!-- Water Flow In -->
                            <path d="M80,40 L80,100" stroke="#3b82f6" stroke-width="8" stroke-dasharray="5,5" opacity="0.8"/>
                            
                            <!-- The Tub -->
                            <path d="M40,100 L40,180 Q40,200 60,200 L240,200 Q260,200 260,180 L260,100" fill="none" stroke="#333" stroke-width="4"/>
                            
                            <!-- Water (Prevalence) -->
                            <path d="M45,120 L255,120 L255,180 Q255,195 240,195 L60,195 Q45,195 45,180 Z" fill="#bfdbfe" opacity="0.8"/>
                            <text x="150" y="160" text-anchor="middle" font-size="14" font-weight="bold" fill="#1e40af">Prevalence (Burden)</text>

                            <!-- Drain (Death/Recovery) -->
                            <path d="M260,180 L280,180 L280,220" stroke="#3b82f6" stroke-width="6" stroke-dasharray="5,5" opacity="0.6"/>
                            <text x="230" y="215" font-size="12" fill="#333" text-anchor="end">Recovery / Death</text>
                        </svg>
                    </div>

                    <ul>
                        <li><strong>Prevalence (The Water Level):</strong> The total amount of water in the tub (Total existing cases).</li>
                        <li><strong>Incidence (The Faucet):</strong> New water flowing in (New cases).</li>
                        <li><strong>Recovery/Death (The Drain):</strong> Water leaving the tub.</li>
                    </ul>
                    <p><strong>Key Concept:</strong> If you turn on the faucet (high incidence) but the drain is open wide (fast cure or death), the water level (prevalence) stays low!</p>
                </div>
            </div>

            <h3>Incidence Rate</h3>
            <p>Measures the <strong>risk</strong> of developing a disease.</p>
            <p style="background: rgba(57, 204, 204, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--teal-accent);">
                <strong>Incidence = (New Cases / Population at Risk) Ã— Multiplier</strong>
            </p>
            <p><em>Note: The denominator must exclude people who already have the disease or are immune!</em></p>

            <h3>Prevalence</h3>
            <p>Measures the <strong>burden</strong> of disease in a population.</p>
            <p style="background: rgba(57, 204, 204, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--teal-accent);">
                <strong>Prevalence = (Total Existing Cases / Total Population) Ã— Multiplier</strong>
            </p>
            <p><em>Includes both new and old cases.</em></p>

            <h2>4.3 Relationship Between I and P</h2>
            <p>For a steady-state condition (rates aren't changing):</p>
            <p style="font-size: 1.2rem; text-align: center; font-weight: bold;">Prevalence â‰ˆ Incidence Ã— Duration</p>
            <p><strong>P â‰ˆ I Ã— D</strong></p>
            
            <ul>
                <li><strong>High Prevalence:</strong> High incidence OR long duration (e.g., Diabetes - people live a long time with it).</li>
                <li><strong>Low Prevalence:</strong> Low incidence OR short duration (e.g., Ebola - rapid death or recovery).</li>
            </ul>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Does a Cure Lower Prevalence?
                </div>
                <div class="callout-content">
                    <p><strong>Scenario:</strong> A new drug prevents death from HIV but doesn't cure it. What happens?</p>
                    <ul>
                        <li><strong>Incidence:</strong> Unchanged (new cases still happening).</li>
                        <li><strong>Duration:</strong> Increases (people live longer).</li>
                        <li><strong>Prevalence:</strong> INCREASES!</li>
                    </ul>
                    <p><strong>Paradox:</strong> Sometimes "better" medical care leads to HIGHER disease prevalence because people stop dying.</p>
                </div>
            </div>

            <h2>4.4 Calculation Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Practice Problem: The Nursing Home
                </div>
                <div class="callout-content">
                    <p><strong>Scenario:</strong> A nursing home has 100 residents. On Jan 1, 10 residents have the flu. During January, 5 NEW residents get the flu. No one died or recovered.</p>
                    
                    <p><strong>1. Calculate Prevalence on Jan 1:</strong></p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Prevalence = Total Cases / Total Pop</strong></p>
                            <p>Total Cases = 10</p>
                            <p>Total Pop = 100</p>
                            <p><strong>Prevalence = 10 / 100 = 10%</strong></p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>2. Calculate Cumulative Incidence for January:</strong></p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Incidence = New Cases / Population AT RISK</strong></p>
                            <p>New Cases = 5</p>
                            <p><strong>Pop at Risk = Total Pop - Existing Cases</strong> (People who already have it aren't at risk!)</p>
                            <p>Pop at Risk = 100 - 10 = 90</p>
                            <p><strong>Incidence = 5 / 90 = 0.055 or 5.5%</strong></p>
                            <p><em>(Common Mistake: Using 100 as the denominator!)</em></p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Incidence:</strong> New cases (Risk). Denominator is "At Risk".</li>
                <li><strong>Prevalence:</strong> All cases (Burden). Denominator is Total Pop.</li>
                <li><strong>Bathtub:</strong> Incidence is the faucet, Prevalence is the water level.</li>
                <li><strong>P â‰ˆ I Ã— D</strong></li>
            </ul>

            <h2>4.5 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Incidence vs Prevalence:</strong> Risk vs Burden. Bathtub analogy.</li>
                        <li><strong>Calculations:</strong> Be ready to calculate Incidence Rate and Prevalence.</li>
                        <li><strong>P â‰ˆ I Ã— D:</strong> Understand how duration affects prevalence.</li>
                    </ul>
                </div>
            </div>
`
    },
    ch5: {
        title: "Chapter 5: Surveillance Systems",
        difficulty: "M",
        content: `
    <h1> Chapter 5: Surveillance Systems</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 2px solid #ca8a04; font-weight: bold; box-shadow: 0 2px 4px rgba(202, 138, 4, 0.2); opacity: 1;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">Public health surveillance is the <strong>ongoing, systematic collection, analysis, interpretation, and dissemination</strong> of health data. It's the "radar" of public health.</p>

            <h2>5.1 Types of Surveillance</h2>

            <div class="table-container"><table class="table">
                <thead style="background: var(--navy-primary); color: white;">
                    <tr>
                        <th style="padding: 1rem; text-align: left;">Type</th>
                        <th style="padding: 1rem; text-align: left;">Who Initiates?</th>
                        <th style="padding: 1rem; text-align: left;">Pros/Cons</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Passive</strong></td>
                        <td style="padding: 1rem;"><strong>Provider</strong> (Doctor/Lab) reports to Health Dept.</td>
                        <td style="padding: 1rem;">
                            <span style="color: green;">+ Cheap, Easy</span><br>
                            <span style="color: red;">- Under-reporting</span>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>Active</strong></td>
                        <td style="padding: 1rem;"><strong>Health Dept</strong> contacts providers to find cases.</td>
                        <td style="padding: 1rem;">
                            <span style="color: green;">+ Accurate, Complete</span><br>
                            <span style="color: red;">- Expensive, Time-consuming</span>
                        </td>
                    </tr>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Syndromic</strong></td>
                        <td style="padding: 1rem;">Automated data (ER visits, OTC sales).</td>
                        <td style="padding: 1rem;">
                            <span style="color: green;">+ Early warning</span><br>
                            <span style="color: red;">- Non-specific</span>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>Sentinel</strong></td>
                        <td style="padding: 1rem;">Selected sites (specific clinics).</td>
                        <td style="padding: 1rem;">
                            <span style="color: green;">+ High quality data</span><br>
                            <span style="color: red;">- Not representative</span>
                        </td>
                    </tr>
                </tbody>
            </table></div>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: "Best" Surveillance
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "Which surveillance system is BEST?"</p>
                    <p><strong>ANSWER:</strong> It depends on the goal!</p>
                    <ul>
                        <li>For routine monitoring? <strong>Passive</strong> (Sustainable).</li>
                        <li>For a specific outbreak? <strong>Active</strong> (Need all cases).</li>
                        <li>For early warning of bioterrorism? <strong>Syndromic</strong>.</li>
                    </ul>
                    <p>Don't assume Active is always "better" just because it's more accurate. It's too expensive for everything.</p>
                </div>
            </div>

            <h2>5.2 Syndromic Surveillance</h2>
            <p>Uses data <em>before</em> a diagnosis is confirmed. Looks for patterns of symptoms.</p>
            <p><strong>Data Sources:</strong></p>
            <ul>
                <li>Over-the-counter (OTC) drug sales (flu meds, anti-diarrheals)</li>
                <li>School absenteeism logs</li>
                <li>ER chief complaints ("fever", "cough")</li>
                <li>Google search trends</li>
            </ul>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: NNDSS
                </div>
                <div class="callout-content">
                    <p><strong>National Notifiable Diseases Surveillance System (NNDSS)</strong></p>
                    <p>The CDC system where states report "notifiable" diseases (like Measles, Rabies, Anthrax). It is a <strong>Passive</strong> system mandated by law.</p>
                </div>
            </div>

            <h2>5.3 Major US Surveillance Systems</h2>
            <p>Know these acronyms for the exam. They are the backbone of US public health data.</p>
            <div class="table-container"><table class="table">
                <thead>
                    <tr><th>System</th><th>Full Name</th><th>Type</th><th>Purpose</th></tr>
                </thead>
                <tbody>
                    <tr><td><strong>NNDSS</strong></td><td>National Notifiable Diseases Surveillance System</td><td>Passive</td><td>Mandatory reporting of ~120 diseases (e.g., Measles, Rabies) from states to CDC.</td></tr>
                    <tr><td><strong>NHSN</strong></td><td>National Healthcare Safety Network</td><td>Active/Passive</td><td>Tracks Hospital Acquired Infections (HAIs) and antibiotic resistance.</td></tr>
                    <tr><td><strong>BRFSS</strong></td><td>Behavioral Risk Factor Surveillance System</td><td>Active (Phone)</td><td>World's largest telephone survey tracking health risks (smoking, obesity).</td></tr>
                    <tr><td><strong>BioSense</strong></td><td>(Now part of NSSP)</td><td>Syndromic</td><td>Tracks ER visits and other real-time data for early warning.</td></tr>
                    <tr><td><strong>Vital Stats</strong></td><td>NVSS (National Vital Statistics System)</td><td>Passive</td><td>Birth and death certificates. Definitive source for mortality data.</td></tr>
                </tbody>
            </table></div>

            <h2>5.4 Surveillance Data Flow</h2>
            <p>How does a case of Salmonella get to the CDC? It follows a chain of command.</p>
            <div class="neo-card" style="text-align: center; background: white;">
                <div style="font-weight: bold; font-size: 1.2rem;">1. Clinician / Lab</div>
                <div style="color: var(--muted);">Diagnoses patient or identifies bacteria.</div>
                <i class="ph-bold ph-arrow-down" style="font-size: 1.5rem; color: var(--accent-color);"></i>
                <div style="font-weight: bold; font-size: 1.2rem;">2. Local Health Dept (County/City)</div>
                <div style="color: var(--muted);">Investigates immediate risks (restaurants, contacts).</div>
                <i class="ph-bold ph-arrow-down" style="font-size: 1.5rem; color: var(--accent-color);"></i>
                <div style="font-weight: bold; font-size: 1.2rem;">3. State Health Dept</div>
                <div style="color: var(--muted);">Aggregates data, looks for cross-county clusters.</div>
                <i class="ph-bold ph-arrow-down" style="font-size: 1.5rem; color: var(--accent-color);"></i>
                <div style="font-weight: bold; font-size: 1.2rem;">4. CDC (Federal)</div>
                <div style="color: var(--muted);">National aggregation (NNDSS), multi-state outbreaks.</div>
                <i class="ph-bold ph-arrow-down" style="font-size: 1.5rem; color: var(--accent-color);"></i>
                <div style="font-weight: bold; font-size: 1.2rem;">5. WHO (Global)</div>
                <div style="color: var(--muted);">Only for PHEIC (Public Health Emergency of International Concern).</div>
            </div>

            <h2>5.5 Surveillance Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Identify the System
                </div>
                <div class="callout-content">
                    <p><strong>Scenario 1:</strong> A health department calls every hospital in the city daily to ask about new E. coli cases during an outbreak.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Active Surveillance</strong></p>
                            <p>The Health Department is initiating the contact to actively find cases.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 2:</strong> A doctor diagnoses a patient with Salmonella and fills out a case report form to send to the state.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Passive Surveillance</strong></p>
                            <p>The provider initiated the report. This is the standard method.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 3:</strong> Public health officials monitor sales of Imodium (anti-diarrheals) at local pharmacies to detect a potential waterborne outbreak.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Syndromic Surveillance</strong></p>
                            <p>They are tracking a proxy (drug sales) for symptoms, not confirmed diagnoses.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Passive:</strong> Provider reports (Cheap, Routine).</li>
                <li><strong>Active:</strong> Health Dept calls (Expensive, Outbreaks).</li>
                <li><strong>Syndromic:</strong> Symptoms/Proxy data (Early Warning).</li>
                <li><strong>NNDSS:</strong> The core passive system for reportable diseases.</li>
            </ul>

            <h2>5.4 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Passive vs Active:</strong> Provider-initiated vs Health Dept-initiated.</li>
                        <li><strong>Syndromic:</strong> Early warning using proxy data (OTC sales).</li>
                        <li><strong>Sentinel:</strong> High quality data from selected sites.</li>
                    </ul>
                </div>
            </div>
`
    },
    ch6: {
        title: "Chapter 6: Natural History of Disease",
        difficulty: "B",
        content: `
            <h1>Chapter 6: Natural History of Disease</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 2px solid #166534; font-weight: bold; box-shadow: 0 2px 4px rgba(21, 128, 61, 0.2); opacity: 1;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 1px solid #ca8a04; opacity: 0.3;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">Disease is not a static event; it is a process. Understanding the <strong>timeline</strong> of this process is essential for identifying the source of an outbreak.</p>

            <h2>6.1 Core Timing Concepts</h2>
            <p>Division B exams frequently test the conceptual difference between these terms:</p>
            
            <div class="table-container"><table class="table">
                <thead style="background: var(--navy-primary); color: white;">
                    <tr>
                        <th style="padding: 1rem; text-align: left;">Term</th>
                        <th style="padding: 1rem; text-align: left;">Definition</th>
                        <th style="padding: 1rem; text-align: left;">Disease Type</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Incubation Period</strong></td>
                        <td style="padding: 1rem;">Time from <strong>exposure</strong> to first <strong>symptoms</strong>.</td>
                        <td style="padding: 1rem;">Infectious diseases (Flu, Salmonella)</td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>Latency Period</strong></td>
                        <td style="padding: 1rem;">Time from <strong>exposure</strong> to <strong>detectable disease</strong>.</td>
                        <td style="padding: 1rem;">Chronic diseases (Cancer, Heart Disease)</td>
                    </tr>
                </tbody>
            </table></div>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Mnemonic: LIV
                </div>
                <div class="callout-content">
                    <p><strong>"LIV" - The three key periods:</strong></p>
                    <ul>
                        <li><strong>L</strong>atent period â€“ Chronic disease.</li>
                        <li><strong>I</strong>ncubation period â€“ Infectious disease.</li>
                        <li><strong>V</strong>iral shedding period â€“ When infectious to others.</li>
                    </ul>
                </div>
            </div>

            <h2>6.2 The Natural History Timeline</h2>
            <div style="text-align: center; margin: 3rem 0;">
                <svg width="700" height="280" viewBox="0 0 700 280" class="responsive-svg" style="max-width: 100%; height: auto; background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                    <defs>
                        <marker id="arrowhead-timeline" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
                        </marker>
                    </defs>
                    <!-- Timeline Arrow -->
                    <line x1="50" y1="200" x2="650" y2="200" stroke="#333" stroke-width="3" marker-end="url(#arrowhead-timeline)"/>
                    <text x="660" y="205" font-size="12" font-weight="bold" fill="#333">TIME</text>

                    <!-- Stage 1: SUSCEPTIBILITY -->
                    <rect x="50" y="60" width="110" height="110" fill="#e0f7fa" stroke="#006064" stroke-width="2" rx="6"/>
                    <text x="105" y="90" text-anchor="middle" font-weight="bold" fill="#006064" font-size="12">SUSCEPTIBILITY</text>
                    <text x="105" y="110" text-anchor="middle" font-size="10" fill="#006064">Healthy</text>
                    <text x="105" y="130" text-anchor="middle" font-size="9" fill="#006064" font-style="italic">No disease</text>

                    <!-- Event: EXPOSURE -->
                    <line x1="160" y1="25" x2="160" y2="210" stroke="#dc2626" stroke-width="3" stroke-dasharray="5,3"/>
                    <rect x="130" y="10" width="60" height="20" fill="#dc2626" rx="4"/>
                    <text x="160" y="23" text-anchor="middle" fill="white" font-weight="bold" font-size="11">EXPOSURE</text>

                    <!-- Stage 2: SUBCLINICAL -->
                    <rect x="170" y="60" width="150" height="110" fill="#fff3e0" stroke="#e65100" stroke-width="2" rx="6"/>
                    <text x="245" y="90" text-anchor="middle" font-weight="bold" fill="#e65100" font-size="12">SUBCLINICAL</text>
                    <text x="245" y="110" text-anchor="middle" font-size="10" fill="#e65100">(Incubation Period)</text>
                    <text x="245" y="130" text-anchor="middle" font-size="9" fill="#e65100">Pathologic</text>
                    <text x="245" y="145" text-anchor="middle" font-size="9" fill="#e65100">Changes</text>

                    <!-- Event: SYMPTOMS -->
                    <line x1="320" y1="25" x2="320" y2="210" stroke="#dc2626" stroke-width="3" stroke-dasharray="5,3"/>
                    <rect x="290" y="10" width="60" height="20" fill="#dc2626" rx="4"/>
                    <text x="320" y="23" text-anchor="middle" fill="white" font-weight="bold" font-size="11">SYMPTOMS</text>

                    <!-- Stage 3: CLINICAL DISEASE -->
                    <rect x="330" y="60" width="150" height="110" fill="#fef2f2" stroke="#b91c1c" stroke-width="2" rx="6"/>
                    <text x="405" y="90" text-anchor="middle" font-weight="bold" fill="#7f1d1d" font-size="12">CLINICAL</text>
                    <text x="405" y="105" text-anchor="middle" font-weight="bold" fill="#7f1d1d" font-size="12">DISEASE</text>
                    <text x="405" y="125" text-anchor="middle" font-size="9" fill="#7f1d1d">Diagnosis</text>
                    <text x="405" y="140" text-anchor="middle" font-size="9" fill="#7f1d1d">Treatment</text>

                    <!-- Stage 4: RECOVERY -->
                    <rect x="490" y="60" width="110" height="110" fill="#e8f5e9" stroke="#1b5e20" stroke-width="2" rx="6"/>
                    <text x="545" y="90" text-anchor="middle" font-weight="bold" fill="#1b5e20" font-size="12">RECOVERY</text>
                    <text x="545" y="110" text-anchor="middle" font-size="9" fill="#1b5e20">Disability or</text>
                    <text x="545" y="125" text-anchor="middle" font-size="9" fill="#1b5e20">Death or</text>
                    <text x="545" y="140" text-anchor="middle" font-size="9" fill="#1b5e20">Full Recovery</text>

                    <!-- Period of Communicability Bar -->
                    <rect x="220" y="185" width="220" height="25" fill="#9333ea" opacity="0.3" stroke="#9333ea" stroke-width="2" rx="4"/>
                    <text x="330" y="202" text-anchor="middle" font-size="11" fill="#7c3aed" font-weight="bold">PERIOD OF COMMUNICABILITY</text>
                    
                    <!-- Note -->
                    <text x="350" y="245" text-anchor="middle" font-size="10" fill="#666" font-style="italic">(Infectiousness period may start before or during symptoms)</text>
                </svg>
            </div>

            <!-- Incubation Period Diagram -->
            <div style="background: white; padding: 1rem; border: 1px solid #eee; margin: 2rem 0; border-radius: 8px;">
                <h4 style="text-align: center; margin-top: 0; color: var(--navy-primary); font-weight:800;">Visualizing Incubation</h4>
                <svg viewBox="0 0 400 100" style="width: 100%; max-width: 500px; height: auto; margin: 1rem auto; display: block;">
                    <text x="10" y="25" font-size="12" font-weight="bold" fill="#444">Exposure</text>
                    <line x1="50" y1="50" x2="350" y2="50" stroke="#333" stroke-width="4" marker-end="url(#arrow)"/>
                    <rect x="100" y="40" width="200" height="20" fill="rgba(255, 165, 0, 0.3)" stroke="orange" stroke-width="2"/>
                    <text x="200" y="32" font-size="13" font-weight="900" text-anchor="middle" fill="#333" style="text-transform:uppercase;">Incubation Period</text>
                    <circle cx="50" cy="50" r="8" fill="#dc2626"/>
                    <circle cx="350" cy="50" r="8" fill="#16a34a"/>
                    <text x="350" y="25" font-size="12" font-weight="bold" text-anchor="end" fill="#444">Onset</text>
                </svg>
            </div>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Mnemonic: LIV
                </div>
                <div class="callout-content">
                    <p><strong>Distinguish the Periods:</strong></p>
                    <ul>
                        <li><strong>L</strong>atent: <strong>I</strong>nfectious <strong>V</strong>iral shedding (Time until you become infectious).</li>
                        <li><strong>I</strong>ncubation: Time until <strong>Symptoms</strong> appear.</li>
                    </ul>
                    <p><em>Note: You can be infectious (Latent period over) BEFORE you have symptoms (Incubation period still going). This is why quarantine is hard!</em></p>
                </div>
            </div>

            <h3 style="color: var(--teal-accent);">Crucial Comparison: Incubation vs Latency</h3>
            <div class="table-container"><table class="table">
                <thead style="background: var(--navy-primary); color: white;">
                    <tr>
                        <th style="padding: 1rem; text-align: left;">Feature</th>
                        <th style="padding: 1rem; text-align: left;">Incubation Period</th>
                        <th style="padding: 1rem; text-align: left;">Latent Period</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Definition</strong></td>
                        <td style="padding: 1rem;">Exposure to <strong>SYMPTOMS</strong></td>
                        <td style="padding: 1rem;">Exposure to <strong>INFECTIOUSNESS</strong></td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>Focus</strong></td>
                        <td style="padding: 1rem;">Clinical (Sick people)</td>
                        <td style="padding: 1rem;">Transmission (Spreading it)</td>
                    </tr>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Example (Flu)</strong></td>
                        <td style="padding: 1rem;">2 Days (Feel sick in 48h)</td>
                        <td style="padding: 1rem;">1 Day (Can spread in 24h)</td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>Implication</strong></td>
                        <td style="padding: 1rem;">Determines quarantine length</td>
                        <td style="padding: 1rem;">Determines contact tracing window</td>
                    </tr>
                </tbody>
            </table></div>

            <h2>6.3 Carriers</h2>
            <p>A <strong>Carrier</strong> is a person who harbors the infectious agent without showing symptoms but can still infect others.</p>

            <div class="table-container"><table class="table">
                 <thead style="background: var(--navy-primary); color: white;">
                    <tr><th style="padding: 1rem;">Type</th><th style="padding: 1rem;">Example Scenario</th></tr>
                 </thead>
                 <tbody>
                    <tr><td style="padding: 1rem;"><strong>Symptomatic Carrier</strong></td><td style="padding: 1rem;">A person with mild flu who goes to work.</td></tr>
                    <tr style="background: var(--gray-bg);"><td style="padding: 1rem;"><strong>Asymptomatic (Healthy) Carrier</strong></td><td style="padding: 1rem;">"Typhoid Mary" - never felt sick but shed bacteria.</td></tr>
                    <tr><td style="padding: 1rem;"><strong>Convalescent Carrier</strong></td><td style="padding: 1rem;">Recovering from Salmonella but still infectious for weeks.</td></tr>
                    <tr style="background: var(--gray-bg);"><td style="padding: 1rem;"><strong>Incubatory Carrier</strong></td><td style="padding: 1rem;">Spreading Chickenpox before the rash appears.</td></tr>
                 </tbody>
            </table></div>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Generation Time
                </div>
                <div class="callout-content">
                    <p><strong>Generation Time:</strong> The time interval between infection of host A and infection of host B.</p>
                    <p>If Generation Time &lt; Incubation Period, the disease spreads <em>before</em> it is detected (hard to control!).</p>
                </div>
            </div>

            <h2>6.4 Carrier Drill</h2>
            <div class="drill-box">
                <div class="callout-header"><i class="ph ph-calculator"></i> Identify the Carrier Type</div>
                <div class="callout-content">
                    <p><strong>Scenario 1:</strong> "Typhoid Mary" felt perfectly healthy but spread Typhoid Fever.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content"><p><strong>Answer: Chronic/Asymptomatic Carrier</strong></p></div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Incubation:</strong> Exposure to Symptoms (Infectious).</li>
                <li><strong>Latency:</strong> Exposure to Disease (Chronic).</li>
                <li><strong>Timeline:</strong> Susceptible -> Subclinical -> Clinical -> Outcome.</li>
            </ul>

            <h2>6.5 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Terms:</strong> Don't swap Incubation and Latency.</li>
                        <li><strong>Carriers:</strong> Know the difference between Incubatory (before symptoms) and Convalescent (after symptoms).</li>
                    </ul>
                </div>
            </div>
        `
    },
    ch7: {
        title: "Chapter 7: The Investigation Roadmap",
        difficulty: "M",
        content: `
            <h1>Chapter 7: The Investigation Roadmap</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 2px solid #ca8a04; font-weight: bold; box-shadow: 0 2px 4px rgba(202, 138, 4, 0.2); opacity: 1;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">The CDC's 13-Step Investigation Sequence is the <strong>systematic approach</strong> to investigating disease outbreaks. Mastering the sequence and understanding when each step occurs is critical for competition success.</p>


            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Step Sequencing
                </div>
                <div class="callout-content">
                    <p><strong>MOST COMMON MISTAKE:</strong> Getting the order of steps wrong!</p>
                    <p>Test writers LOVE to ask: "What should you do FIRST?" or "Which step comes BEFORE hypothesis testing?"</p>
                    <p><strong>Key Traps:</strong></p>
                    <ul>
                        <li>Jumping to hypothesis testing before confirming the outbreak exists</li>
                        <li>Implementing control measures before identifying the source</li>
                        <li>Forgetting to prepare for fieldwork (Step 1)</li>
                    </ul>
                </div>
            </div>

            <h2>The 13 Steps (In Order)</h2>
            
            <div style="text-align: center; margin: 2rem 0;">
                <svg width="600" height="900" viewBox="0 0 400 900" class="responsive-svg" style="max-width: 100%; height: auto; background: #fafafa; border-radius: 8px; border: 1px solid #eee;">
                    <defs>
                         <marker id="arrowdown" markerWidth="10" markerHeight="7" refX="5" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
                        </marker>
                    </defs>

                    <!-- Step 1 -->
                    <rect x="50" y="20" width="300" height="40" rx="5" fill="#eef2ff" stroke="var(--navy-primary)" stroke-width="4"/>
                    <text x="200" y="47" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">1. Prepare for Fieldwork</text>
                    <line x1="200" y1="60" x2="200" y2="80" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                    <!-- Step 2 -->
                    <rect x="50" y="80" width="300" height="40" rx="5" fill="#eef2ff" stroke="var(--navy-primary)" stroke-width="4"/>
                    <text x="200" y="107" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">2. Verify Diagnosis</text>
                    <line x1="200" y1="120" x2="200" y2="140" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                    <!-- Step 3 -->
                    <rect x="50" y="140" width="300" height="40" rx="5" fill="#eef2ff" stroke="var(--navy-primary)" stroke-width="4"/>
                    <text x="200" y="167" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">3. Establish Existence</text>
                    <line x1="200" y1="180" x2="200" y2="200" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                    <!-- Step 4 -->
                    <rect x="50" y="200" width="300" height="40" rx="5" fill="#e0f7fa" stroke="var(--teal-accent)" stroke-width="4"/>
                    <text x="200" y="227" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">4. Defined Case</text>
                    <line x1="200" y1="240" x2="200" y2="260" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                    <!-- Step 5 -->
                    <rect x="50" y="260" width="300" height="40" rx="5" fill="#e0f7fa" stroke="var(--teal-accent)" stroke-width="4"/>
                    <text x="200" y="287" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">5. Find Cases & Record</text>
                    <line x1="200" y1="300" x2="200" y2="320" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                    <!-- Step 6 -->
                    <rect x="50" y="320" width="300" height="40" rx="5" fill="#e0f7fa" stroke="var(--teal-accent)" stroke-width="4"/>
                    <text x="200" y="347" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">6. Descriptive Epi (PPT)</text>
                    <line x1="200" y1="360" x2="200" y2="380" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                    <!-- Step 7 -->
                    <rect x="50" y="380" width="300" height="40" rx="5" fill="#fff3e0" stroke="#f59e0b" stroke-width="4"/>
                    <text x="200" y="407" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">7. Develop Hypotheses</text>
                    <line x1="200" y1="420" x2="200" y2="440" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                    <!-- Step 8 -->
                    <rect x="50" y="440" width="300" height="40" rx="5" fill="#fff3e0" stroke="#f59e0b" stroke-width="4"/>
                    <text x="200" y="467" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">8. Evaluate Hypotheses</text>
                    <line x1="200" y1="480" x2="200" y2="500" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                    <!-- Step 9 -->
                    <rect x="50" y="500" width="300" height="40" rx="5" fill="#fff3e0" stroke="#f59e0b" stroke-width="4"/>
                    <text x="200" y="527" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">9. Reconsider / Refine</text>
                    <line x1="200" y1="540" x2="200" y2="560" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                    <!-- Step 10 -->
                    <rect x="50" y="560" width="300" height="40" rx="5" fill="#f3e5f5" stroke="#9c27b0" stroke-width="4"/>
                    <text x="200" y="587" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">10. Compare with Lab/Env</text>
                    <line x1="200" y1="600" x2="200" y2="620" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                    <!-- Step 11 -->
                    <rect x="50" y="620" width="300" height="40" rx="5" fill="#fce4ec" stroke="#e91e63" stroke-width="4"/>
                    <text x="200" y="647" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">11. Implement Control</text>
                    <line x1="200" y1="660" x2="200" y2="680" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                    <!-- Step 12 -->
                    <rect x="50" y="680" width="300" height="40" rx="5" fill="#fce4ec" stroke="#e91e63" stroke-width="4"/>
                    <text x="200" y="707" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">12. Maintain Surveillance</text>
                    <line x1="200" y1="720" x2="200" y2="740" stroke="#333" stroke-width="4" marker-end="url(#arrowdown)"/>

                     <!-- Step 13 -->
                    <rect x="50" y="740" width="300" height="40" rx="5" fill="#fce4ec" stroke="#e91e63" stroke-width="4"/>
                    <text x="200" y="767" text-anchor="middle" font-weight="900" font-size="15" fill="#333" style="text-transform:uppercase;">13. Communicate Findings</text>
                    
                    <!-- Side note for Control Measures -->
                    <path d="M370,640 Q390,640 390,400 Q390,100 360,100" fill="none" stroke="#e91e63" stroke-width="4" stroke-dasharray="8,5"/>
                    <text x="395" y="380" transform="rotate(90 395,380)" font-size="13" font-weight="bold" fill="#e91e63">Control can happen ANY time!</text>
                </svg>
            </div>

            <div class="study-tip">
                        <li><strong>F</strong>ind cases systematically (line listing)</li>
                        <li><strong>D</strong>escribe epidemic (time/place/person)</li>
                        <li><strong>D</strong>evelop hypotheses (agent/host/environment)</li>
                        <li><strong>E</strong>valuate hypotheses (analytical epi)</li>
                        <li><strong>R</strong>e-evaluate as needed</li>
                        <li><strong>C</strong>ompare with lab/environmental studies</li>
                        <li><strong>I</strong>mplement control measures (ASAP!)</li>
                        <li><strong>M</strong>aintain surveillance</li>
                        <li><strong>C</strong>ommunicate findings</li>
                    </ol>
                    <p><em>Note: Step 10 (control measures) can occur at ANY time once the source is identified!</em></p>
                </div>
            </div>

            <h2>Detailed Step Breakdown</h2>

            <h3>Step 1: Prepare for Fieldwork</h3>
            <p><strong>Purpose:</strong> Get ready before going to the outbreak site</p>
            <ul>
                <li>Assemble investigation team</li>
                <li>Gather supplies (forms, lab kits, PPE)</li>
                <li>Review background information</li>
                <li>Establish communication protocols</li>
                <li>Notify local authorities</li>
            </ul>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "The team arrives at the outbreak site. What should they do FIRST?"</p>
                    <p><strong>WRONG:</strong> Start collecting samples</p>
                    <p><strong>RIGHT:</strong> Verify the diagnosis (Step 2) - you should have PREPARED before arriving!</p>
                </div>
            </div>

            <h3>Step 2: Verify the Diagnosis</h3>
            <p><strong>Purpose:</strong> Confirm that reported cases actually have the disease</p>
            <ul>
                <li>Review clinical findings</li>
                <li>Check laboratory results</li>
                <li>Rule out misdiagnosis</li>
                <li>Confirm the disease is what's reported</li>
            </ul>
            <p><strong>Example:</strong> Reports of "meningitis" might actually be influenza with similar symptoms.</p>

            <h3>Step 3: Establish Outbreak Existence</h3>
            <p><strong>Purpose:</strong> Determine if cases exceed expected levels</p>
            <ul>
                <li>Compare current cases to baseline/historical data</li>
                <li>Check if this is truly an outbreak or normal variation</li>
                <li>Rule out reporting artifacts (e.g., new surveillance system)</li>
            </ul>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Quick Check
                </div>
                <div class="callout-content">
                    <p><strong>Scenario:</strong> A school reports 15 flu cases in one week. Last year, they averaged 3 cases per week in the same month. Is this an outbreak?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: YES</strong></p>
                            <p><strong>Rationale:</strong> 15 cases vs. expected 3 cases = 5x increase above baseline. This clearly exceeds normal levels and constitutes an outbreak.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h3>Step 4: Construct Case Definition</h3>
            <p><strong>Purpose:</strong> Create standardized criteria to identify cases</p>
            <p><strong>Components (CPRT + Lab):</strong></p>
            <ul>
                <li><strong>C</strong>linical criteria (symptoms, signs)</li>
                <li><strong>P</strong>erson criteria (age, location, occupation)</li>
                <li><strong>R</strong>estrictions (time, place)</li>
                <li><strong>T</strong>ime period (outbreak dates)</li>
                <li><strong>Lab</strong>oratory confirmation (if available)</li>
            </ul>

            <h3>Step 5: Find Cases & Record Information</h3>
            <p><strong>Purpose:</strong> Systematically identify all cases</p>
            <ul>
                <li>Active case finding (search for cases)</li>
                <li>Create line lists (spreadsheet of cases)</li>
                <li>Record key variables (demographics, symptoms, exposures)</li>
            </ul>

            <h3>Step 6: Perform Descriptive Epidemiology</h3>
            <p><strong>Purpose:</strong> Describe outbreak by Person, Place, Time</p>
            <ul>
                <li><strong>Person:</strong> Who is affected? (age, sex, occupation)</li>
                <li><strong>Place:</strong> Where are cases occurring? (maps, geographic patterns)</li>
                <li><strong>Time:</strong> When did cases occur? (epi curve, timeline)</li>
            </ul>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: The Epi Curve is Key
                </div>
                <div class="callout-content">
                    <p>The epidemic curve (epi curve) created in Step 6 is one of the MOST important tools:</p>
                    <ul>
                        <li><strong>Point source:</strong> Single peak (common exposure)</li>
                        <li><strong>Propagated:</strong> Multiple peaks (person-to-person)</li>
                        <li><strong>Continuous:</strong> Plateau (ongoing exposure)</li>
                    </ul>
                    <p>The epi curve shape helps generate hypotheses in Step 7!</p>
                </div>
            </div>

            <h3>Step 7: Develop Hypotheses</h3>
            <p><strong>Purpose:</strong> Generate educated guesses about source and transmission</p>
            <ul>
                <li>Based on descriptive epi (Step 6)</li>
                <li>Consider: What? Where? When? How?</li>
                <li>Identify potential exposures</li>
                <li>Propose transmission mechanisms</li>
            </ul>

            <h3>Step 8: Test Hypotheses (Analytic Studies)</h3>
            <p><strong>Purpose:</strong> Use statistics to confirm or refute hypotheses</p>
            <ul>
                <li>Calculate attack rates for exposed vs. unexposed</li>
                <li>Compute relative risk (RR) or odds ratio (OR)</li>
                <li>Determine if associations are statistically significant</li>
            </ul>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Hypothesis Testing Timing
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "Should you test hypotheses before or after creating the epi curve?"</p>
                    <p><strong>WRONG:</strong> Before (you need descriptive epi to generate hypotheses!)</p>
                    <p><strong>RIGHT:</strong> After Step 6 (descriptive epi) and Step 7 (hypothesis development)</p>
                    <p><strong>Sequence:</strong> Describe â†’ Hypothesize â†’ Test</p>
                </div>
            </div>

            <h3>Step 9: Environmental & Additional Studies</h3>
            <p><strong>Purpose:</strong> Collect environmental samples and conduct additional investigations</p>
            <ul>
                <li>Test food, water, air samples</li>
                <li>Inspect facilities</li>
                <li>Interview additional contacts</li>
                <li>Confirm laboratory findings</li>
            </ul>

            <h3>Step 10: Implement Control Measures</h3>
            <p><strong>Purpose:</strong> Stop the outbreak</p>
            <ul>
                <li>Remove contaminated source</li>
                <li>Isolate sick individuals</li>
                <li>Quarantine exposed individuals</li>
                <li>Vaccinate susceptible population</li>
                <li>Improve sanitation/hygiene</li>
            </ul>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Critical Timing Note
                </div>
                <div class="callout-content">
                    <p><strong>Step 10 can occur at ANY time!</strong></p>
                    <p>If you identify the source early (e.g., contaminated water pump), implement controls immediately. Don't wait to complete all 13 steps!</p>
                    <p><strong>Example:</strong> John Snow removed the Broad Street pump handle (control measure) before completing his full investigation.</p>
                </div>
            </div>

            <h3>Step 11: Communicate Findings</h3>
            <p><strong>Purpose:</strong> Share results with stakeholders</p>
            <ul>
                <li>Report to public health authorities</li>
                <li>Inform affected community</li>
            </ul>

            <h2>7.1 Integrated Case Study: The Picnic Outbreak</h2>
            <div class="neo-card">
                 <h3>Follow the Steps!</h3>
                 <p><strong>Scenario:</strong> 20 people report vomiting after a church picnic.</p>
                 <ol>
                     <li><strong>Prepare:</strong> Gather questionnaires and stool kits.</li>
                     <li><strong>Verify:</strong> Doctor confirms it's not "stomach flu" but Salmonella.</li>
                     <li><strong>Define Case:</strong> "Any picnic attendee with vomiting/diarrhea onset within 48h."</li>
                     <li><strong>Find Cases:</strong> Call all 50 attendees. (Don't just wait for them to call!)</li>
                     <li><strong>Descibe:</strong> Epi curve shows a Point Source peak.</li>
                     <li><strong>Hypothesize:</strong> "Potato salad (left in sun) caused illness."</li>
                     <li><strong>Test:</strong> 90% of sick people ate salad; only 10% of well people did. (High Risk Ratio).</li>
                     <li><strong>Control:</strong> Stop serving spread. Educate food handlers.</li>
                 </ol>
            </div>
                <li>Inform affected community</li>
                <li>Publish findings (if appropriate)</li>
                <li>Provide recommendations</li>
            </ul>

            <h3>Step 12: Maintain Surveillance</h3>
            <p><strong>Purpose:</strong> Monitor for additional cases</p>
            <ul>
                <li>Continue tracking cases</li>
                <li>Ensure outbreak has ended</li>
                <li>Watch for recurrence</li>
                <li>Evaluate control measure effectiveness</li>
            </ul>

            <h3>Step 13: Communicate Findings</h3>
            <p><strong>Purpose:</strong> Share investigation results with stakeholders and the public</p>
            <ul>
                <li><strong>Report to authorities:</strong> Inform health departments and CDC</li>
                <li><strong>Inform the community:</strong> Update affected populations</li>
                <li><strong>Publish findings:</strong> Write formal reports (if appropriate)</li>
                <li><strong>Provide recommendations:</strong> Share lessons learned and prevention strategies</li>
                <li><strong>Media communication:</strong> Work with public information officers if needed</li>
            </ul>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Communication Best Practices
                </div>
                <div class="callout-content">
                    <p><strong>Tailor your message to your audience:</strong></p>
                    <ul>
                        <li><strong>Public Health Authorities:</strong> Technical details, statistical findings, data tables</li>
                        <li><strong>Affected Community:</strong> Simple language, clear actions, what to do/avoid</li>
                        <li><strong>Media:</strong> Key facts, main findings, public health message (avoid jargon)</li>
                        <li><strong>Scientific Community:</strong> Methodology, detailed results, peer-reviewed format</li>
                    </ul>
                    <p><strong>Timing matters:</strong> Communicate early and often. Don't wait for perfect dataâ€”share what you know and update as you learn more.</p>
                </div>
            </div>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: When to Communicate
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "Should you wait until all lab results are back before communicating findings?"</p>
                    <p><strong>ANSWER: NO!</strong></p>
                    <p>Communication should happen throughout the investigation, not just at the end. Early communication:</p>
                    <ul>
                        <li>Warns the public about ongoing risks</li>
                        <li>Helps find additional cases</li>
                        <li>Prevents panic by showing you're taking action</li>
                    </ul>
                    <p><strong>Example:</strong> In the 2014 Ebola outbreak, early communication helped identify contacts and prevent further spread, even before complete epidemiological analysis.</p>
                </div>
            </div>

            <h2>High-Yield Sequencing Practice</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Sequencing Drill
                </div>
                <div class="callout-content">
                    <p><strong>Question 1:</strong> What should you do BEFORE creating a case definition?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer:</strong> Verify diagnosis (Step 2) and establish outbreak existence (Step 3)</p>
                            <p>You need to confirm what disease you're dealing with and that an outbreak actually exists before defining cases.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1.5rem;"><strong>Question 2:</strong> Can you implement control measures before testing hypotheses?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: YES!</strong></p>
                            <p>Step 10 (control measures) can occur at ANY time once you identify the source. You don't need to wait for statistical confirmation if the source is obvious.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1.5rem;"><strong>Question 3:</strong> What comes FIRST: hypothesis development or descriptive epidemiology?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer:</strong> Descriptive epidemiology (Step 6) comes BEFORE hypothesis development (Step 7)</p>
                            <p>You need to describe the outbreak (person, place, time) before you can generate hypotheses about the source.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary: The Critical Sequence</h2>
            <ol>
                <li>Prepare â†’ Verify â†’ Confirm outbreak exists</li>
                <li>Define cases â†’ Find cases â†’ Describe (PPT)</li>
                <li>Hypothesize â†’ Test â†’ Additional studies</li>
                <li>Control (anytime!) â†’ Communicate â†’ Maintain surveillance</li>
            </ol>

            <h2>7.4 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Sequence:</strong> Memorize the 13 steps. "Prepare" is Step 1.</li>
                        <li><strong>Verification:</strong> Verify diagnosis BEFORE creating case definition.</li>
                        <li><strong>Control:</strong> Can happen ANY time.</li>
                    </ul>
                </div>
            </div>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Final Exam Trap
                </div>
                <div class="callout-content">
                    <p><strong>Most Tested Sequence Errors:</strong></p>
                    <ol>
                        <li>Testing hypotheses BEFORE descriptive epi</li>
                        <li>Creating case definition BEFORE verifying diagnosis</li>
                        <li>Thinking control measures must wait until Step 10</li>
                        <li>Forgetting Step 1 (preparation) exists</li>
                    </ol>
                    <p><strong>Remember:</strong> The sequence is logical - each step builds on the previous one!</p>
                </div>
            </div>
`
    },
    ch8: {
        title: "Chapter 8: Case Definition Mastery",
        difficulty: "M",
        content: `
    <h1> Chapter 8: Case Definition Mastery</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 2px solid #ca8a04; font-weight: bold; box-shadow: 0 2px 4px rgba(202, 138, 4, 0.2); opacity: 1;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">A Case Definition is a set of standard criteria for deciding whether a person has a particular disease or other health-related condition. It is the <strong>foundation</strong> of any outbreak investigation.</p>

            <h2>8.1 Components of a Case Definition</h2>
            <p>A complete case definition must include four components:</p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 2rem 0;">
                <div style="border: 2px solid var(--navy-primary); padding: 1rem; border-radius: 8px;">
                    <h3 style="color: var(--teal-accent); margin-top: 0;"><i class="ph ph-stethoscope"></i> Clinical Criteria</h3>
                    <p>Symptoms (e.g., fever > 101Â°F, cough) or Lab results (e.g., positive PCR).</p>
                </div>
                <div style="border: 2px solid var(--navy-primary); padding: 1rem; border-radius: 8px;">
                    <h3 style="color: var(--teal-accent); margin-top: 0;"><i class="ph ph-user"></i> Person</h3>
                    <p>Who is affected? (e.g., Students at High School X).</p>
                </div>
                <div style="border: 2px solid var(--navy-primary); padding: 1rem; border-radius: 8px;">
                    <h3 style="color: var(--teal-accent); margin-top: 0;"><i class="ph ph-map-pin"></i> Place</h3>
                    <p>Where were they? (e.g., Attended the football game).</p>
                </div>
                <div style="border: 2px solid var(--navy-primary); padding: 1rem; border-radius: 8px;">
                    <h3 style="color: var(--teal-accent); margin-top: 0;"><i class="ph ph-clock"></i> Time</h3>
                    <p>When did it happen? (e.g., Onset between Sept 1 and Sept 30).</p>
                </div>
            </div>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Risk Factors
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "Should you include the suspected source (e.g., 'ate the potato salad') in the case definition?"</p>
                    <p><strong>ANSWER: NO!</strong></p>
                    <p>If you include the risk factor in the definition, you can't test the hypothesis later because you've already assumed everyone sick ate the salad. Keep it neutral.</p>
                </div>
            </div>

            <h2>8.2 Classification Levels</h2>
            <p>Case definitions often have levels of certainty:</p>

            <div class="table-container"><table class="table">
                <thead style="background: var(--navy-primary); color: white;">
                    <tr>
                        <th style="padding: 1rem; text-align: left;">Level</th>
                        <th style="padding: 1rem; text-align: left;">Criteria</th>
                        <th style="padding: 1rem; text-align: left;">Use Case</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Suspected</strong></td>
                        <td style="padding: 1rem;">Clinical symptoms only.</td>
                        <td style="padding: 1rem;">Early outbreak, cast a wide net.</td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>Probable</strong></td>
                        <td style="padding: 1rem;">Clinical symptoms + Epidemiologic link (contact with a case).</td>
                        <td style="padding: 1rem;">Typical for many investigations.</td>
                    </tr>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Confirmed</strong></td>
                        <td style="padding: 1rem;">Laboratory verification (Positive test).</td>
                        <td style="padding: 1rem;">Required for final counts/reporting.</td>
                    </tr>
                </tbody>
            </table></div>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Mnemonic: Case Definition Components (PPTC)
                </div>
                <div class="callout-content">
                    <p><strong>"PPTC" - Person, Place, Time, Clinical</strong></p>
                    <p>Every case definition must specify these four components:</p>
                    <ul>
                        <li><strong>P</strong>erson â€“ Who? (Age, sex, occupation, risk factors)</li>
                        <li><strong>P</strong>lace â€“ Where? (Geographic location, facility)</li>
                        <li><strong>T</strong>ime â€“ When? (Onset date, duration of illness)</li>
                        <li><strong>C</strong>linical â€“ What symptoms/lab criteria?</li>
                    </ul>
                    <p><strong>Exam Tip:</strong> If a question asks "What's missing from this case definition?", check if all four PPTC elements are present.</p>
                </div>
            </div>

            <h2>8.3 Sensitivity vs. Specificity</h2>
            <p>There is always a trade-off when designing a definition:</p>
            <ul>
                <li><strong>Sensitive (Loose):</strong> "Anyone with a cough." Captures all cases, but also many false positives. Good for <em>early</em> stages (don't miss anyone).</li>
                <li><strong>Specific (Strict):</strong> "PCR positive only." Captures only true cases, but misses many (false negatives). Good for <em>late</em> stages (confirming the cause).</li>
            </ul>

            <div class="neo-card" style="margin: 2rem 0; padding: 1.5rem;">
                <h3 style="margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 0.5rem;">Calculating Validity</h3>
                
                <div class="table-container"><table class="table" style="text-align: center;">
                    <tr>
                        <th colspan="2" rowspan="2"></th>
                        <th colspan="2" style="background: #f3f4f6; border: 1px solid #ddd;">True Disease Status (Gold Standard)</th>
                        <th rowspan="2"></th>
                    </tr>
                    <tr>
                        <th style="background: #fee2e2; width: 30%;">Sick (+)</th>
                        <th style="background: #dcfce7; width: 30%;">Healthy (-)</th>
                    </tr>
                    <tr>
                        <th rowspan="2" style="background: #f3f4f6; width: 50px; border: 1px solid #ddd; vertical-align: middle;"><div style="writing-mode: vertical-rl; transform: rotate(180deg); margin: 0 auto;">Test Result</div></th>
                        <th style="background: #fee2e2; padding: 0.5rem;">Pos (+)</th>
                        <td style="border: 2px solid #333; background: #fff0f0; font-weight: bold; font-size: 1.2rem;">TP</td>
                        <td style="border: 2px solid #333; background: #f0fdf4; font-weight: bold; font-size: 1.2rem;">FP</td>
                        <td style="background: #f9fafb; font-size: 0.9rem;">â†’ PPV</td>
                    </tr>
                    <tr>
                        <th style="background: #dcfce7; padding: 0.5rem;">Neg (-)</th>
                        <td style="border: 2px solid #333; background: #fff0f0; font-weight: bold; font-size: 1.2rem;">FN</td>
                        <td style="border: 2px solid #333; background: #f0fdf4; font-weight: bold; font-size: 1.2rem;">TN</td>
                        <td style="background: #f9fafb; font-size: 0.9rem;">â†’ NPV</td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td style="background: #f9fafb; font-size: 0.9rem;">â†“ Sensitivity</td>
                        <td style="background: #f9fafb; font-size: 0.9rem;">â†“ Specificity</td>
                        <td></td>
                    </tr>
                </table></div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- Sensitivity / Specificity -->
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
                        <h4 style="margin-top: 0; color: var(--navy-primary);">Intrinsic Properties</h4>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Sensitivity</strong> (True Positive Rate)<br>
                            Ability to correctly identify those <em>with</em> disease.<br>
                            <code style="background: white; padding: 2px 4px; border: 1px solid #ccc;">TP / (TP + FN)</code>
                        </div>
                        <div>
                            <strong>Specificity</strong> (True Negative Rate)<br>
                            Ability to correctly identify those <em>without</em> disease.<br>
                            <code style="background: white; padding: 2px 4px; border: 1px solid #ccc;">TN / (TN + FP)</code>
                        </div>
                    </div>

                    <!-- PPV / NPV -->
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
                        <h4 style="margin-top: 0; color: var(--navy-primary);">Predictive Values</h4>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>PPV</strong> (Pos Predictive Value)<br>
                            If I trust positive, does he have it?<br>
                            <code style="background: white; padding: 2px 4px; border: 1px solid #ccc;">TP / (TP + FP)</code>
                        </div>
                        <div>
                            <strong>NPV</strong> (Neg Predictive Value)<br>
                            If I test negative, am I safe?<br>
                            <code style="background: white; padding: 2px 4px; border: 1px solid #ccc;">TN / (TN + FN)</code>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; font-style: italic; color: #dc2626;">
                            *Dependent on Prevalence!
                        </div>
                    </div>
                </div>
            </div>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Mnemonics: SNOUT & SPIN
                </div>
                <div class="callout-content">
                    <ul>
                        <li><strong>SnNout:</strong> A Highly <strong>S</strong>e<strong>n</strong>sitive test, when <strong>N</strong>egative, rules <strong>OUT</strong> disease. (No false negatives).</li>
                        <li><strong>SpPin:</strong> A Highly <strong>Sp</strong>ecific test, when <strong>P</strong>ositive, rules <strong>IN</strong> disease. (No false positives).</li>
                    </ul>
                </div>
            </div>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Changing the Definition
                </div>
                <div class="callout-content">
                    <p>It is standard practice to <strong>change</strong> the case definition during an investigation.</p>
                    <p>Start <strong>Sensitive</strong> (Loose) to find everyone. Then become more <strong>Specific</strong> (Strict) as you get lab results to avoid analyzing non-cases.</p>
                </div>
                </div>
            </div>

            <div class="neo-card small" style="background: #eef2ff; border-left: 4px solid var(--accent-purple); margin-top: 2rem;">
                 <h3><i class="ph-bold ph-trend-up"></i> Real World Example: H1N1 (2009)</h3>
                 <p>Case definitions evolve!</p>
                 <ul>
                     <li><strong>April 26 (Early):</strong> "Acute respiratory illness AND travel to Mexico." (Specific, to find source).</li>
                     <li><strong>June 1 (Pandemic):</strong> "Acute respiratory illness." (Sensitive, dropped travel criteria as it spread everywhere).</li>
                 </ul>
            </div>

            <h2>8.4 Classification Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Classify the Case
                </div>
                <div class="callout-content">
                    <p><strong>Definition:</strong><br>
                    1. Fever > 100Â°F (Suspected)<br>
                    2. Fever + Contact with case (Probable)<br>
                    3. Positive Blood Culture (Confirmed)</p>

                    <p style="margin-top: 1rem;"><strong>Patient A:</strong> Has a fever of 102Â°F. No known contacts. No lab test yet.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Suspected</strong></p>
                            <p>Meets clinical criteria only.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Patient B:</strong> Has a fever of 101Â°F and sits next to Patient A in class.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Probable</strong></p>
                            <p>Meets clinical criteria + Epi link.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Patient C:</strong> No fever, but has a positive blood culture.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Confirmed</strong></p>
                            <p>Lab evidence usually trumps symptoms for confirmation (though some definitions require symptoms too).</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>8.5 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Components:</strong> Person + Place + Time + Clinical = Complete case definition.</li>
                        <li><strong>Levels:</strong> Suspected â†’ Probable â†’ Confirmed (increasing certainty).</li>
                        <li><strong>Sensitivity vs Specificity:</strong> Broad case def = High sensitivity. Narrow = High specificity.</li>
                        <li><strong>Mnemonic:</strong> "SPC" = Suspected, Probable, Confirmed.</li>
                    </ul>
                </div>
            </div>

            <div class="study-tip">
                <div class="callout-header"><i class="ph ph-warning"></i> Exam Trap</div>
                <div class="callout-content">
                    <p><strong>Changing the case definition mid-investigation</strong> changes your case count! A broader definition early helps find more cases; a narrower definition later increases accuracy.</p>
                </div>
            </div>
        `
    },
    ch9: {
        title: "Chapter 9: Line Lists & Data Cleaning",
        difficulty: "M",
        content: `
            <h1>Chapter 9: Line Lists & Data Cleaning</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 2px solid #ca8a04; font-weight: bold; box-shadow: 0 2px 4px rgba(202, 138, 4, 0.2); opacity: 1;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">A <strong>Line List</strong> is a table where each row represents a single case and each column represents a variable of interest. It is the primary way epidemiologists organize data during an outbreak.</p>

            <h2>9.1 Structure of a Line List</h2>
            <div style="overflow-x: auto; margin: 2rem 0; border: 2px solid var(--navy-primary); border-radius: 8px;">
                <div class="table-container"><table class="table" style="min-width: 600px;">
                    <thead style="background: var(--navy-primary); color: white;">
                        <tr>
                            <th style="padding: 0.75rem; text-align: left;">Case ID</th>
                            <th style="padding: 0.75rem; text-align: left;">Onset Date</th>
                            <th style="padding: 0.75rem; text-align: left;">Age</th>
                            <th style="padding: 0.75rem; text-align: left;">Sex</th>
                            <th style="padding: 0.75rem; text-align: left;">Symptoms</th>
                            <th style="padding: 0.75rem; text-align: left;">Lab Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: var(--gray-bg);">
                            <td style="padding: 0.75rem;">001</td>
                            <td style="padding: 0.75rem;">2023-09-01</td>
                            <td style="padding: 0.75rem;">14</td>
                            <td style="padding: 0.75rem;">M</td>
                            <td style="padding: 0.75rem;">Fever, Rash</td>
                            <td style="padding: 0.75rem;">Positive</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.75rem;">002</td>
                            <td style="padding: 0.75rem;">2023-09-02</td>
                            <td style="padding: 0.75rem;">13</td>
                            <td style="padding: 0.75rem;">F</td>
                            <td style="padding: 0.75rem;">Fever</td>
                            <td style="padding: 0.75rem;">Pending</td>
                        </tr>
                        <tr style="background: var(--gray-bg);">
                            <td style="padding: 0.75rem;">003</td>
                            <td style="padding: 0.75rem;">2023-09-02</td>
                            <td style="padding: 0.75rem;">14</td>
                            <td style="padding: 0.75rem;">M</td>
                            <td style="padding: 0.75rem;">Vomiting</td>
                            <td style="padding: 0.75rem;">Negative</td>
                        </tr>
                    </tbody>
                </table></div>
            </div>

            <p><strong>Key Components:</strong></p>
            <ul>
                <li><strong>Identifying Info:</strong> Name (usually removed for privacy), ID number.</li>
                <li><strong>Clinical Info:</strong> Symptoms, onset date/time, lab results.</li>
                <li><strong>Descriptive Info:</strong> Age, sex, occupation.</li>
                <li><strong>Risk Factors:</strong> Foods eaten, water sources, contacts.</li>
            </ul>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: PII (Personally Identifiable Information)
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "Should you share the Line List with the media?"</p>
                    <p><strong>ANSWER: NO!</strong></p>
                    <p>Line lists contain PII (Names, DOBs, Addresses). You must <strong>de-identify</strong> the data (remove names, keep IDs) before sharing it outside the investigation team.</p>
                </div>
            </div>

            <h2>9.2 Data Cleaning</h2>
            <p>Before analyzing, you must "clean" the data to fix errors.</p>
            <ul>
                <li><strong>Duplicates:</strong> Did the same person get reported twice? (Check Name/DOB).</li>
                <li><strong>Inconsistencies:</strong> Is a male listed as "Pregnant"? Is the Onset Date <em>before</em> the Exposure Date?</li>
                <li><strong>Missing Data:</strong> Are there blanks? (Try to call the patient back).</li>
            </ul>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: The "Unknown" Category
                </div>
                <div class="callout-content">
                    <p>When calculating percentages, handle missing data carefully.</p>
                    <p>If 50 people are sick, 20 ate salad, 20 didn't, and 10 "Don't Know":</p>
                    <ul>
                        <li><strong>Conservative:</strong> Treat "Don't Know" as "No" (20/50 = 40% exposure).</li>
                        <li><strong>Exclusion:</strong> Remove them from the denominator (20/40 = 50% exposure).</li>
                    </ul>
                    <p><em>Usually, we exclude them or report them separately.</em></p>
                </div>
            </div>

            <h2>9.3 Data Cleaning Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Find the Error
                </div>
                <div class="callout-content">
                    <p><strong>Entry 1:</strong> Case ID: 104 | Sex: M | Age: 16 | Symptoms: Ovarian Cyst</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Error: Biological Impossibility</strong></p>
                            <p>Males do not have ovaries. Check if Sex or Diagnosis is wrong.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Entry 2:</strong> Case ID: 105 | Onset: 2023-08-01 | Exposure: 2023-08-05</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Error: Temporal Inconsistency</strong></p>
                            <p>You cannot get sick <em>before</em> you are exposed.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Entry 3:</strong> Case ID: 106 | Age: 152</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Error: Outlier/Typo</strong></p>
                            <p>Likely a typo for 15 or 52. Verify with the source.</p>
                        </div>
                    </div>
                </div>
            <!-- Example Line List -->
            <div class="neo-card" style="margin: 2rem 0; overflow-x: auto;">
                <h3 style="margin-top: 0; color: var(--navy-primary);">9.3 Example: The Completed Line List</h3>
                <p>This is what your spreadsheet should look like before analysis:</p>
                <div class="table-container"><table class="table" style="min-width: 600px; font-size: 0.9rem;">
                    <thead style="background: var(--navy-primary); color: white;">
                        <tr>
                            <th style="padding: 0.5rem; text-align: left;">ID</th>
                            <th style="padding: 0.5rem; text-align: left;">Onset (Time)</th>
                            <th style="padding: 0.5rem; text-align: left;">Age/Sex (Person)</th>
                            <th style="padding: 0.5rem; text-align: left;">Symptoms (Clinical)</th>
                            <th style="padding: 0.5rem; text-align: center;">Ate Salad?</th>
                            <th style="padding: 0.5rem; text-align: center;">Ate Chicken?</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: var(--gray-bg);">
                            <td style="padding: 0.5rem;">001</td>
                            <td style="padding: 0.5rem;">May 1, 12:00</td>
                            <td style="padding: 0.5rem;">34 M</td>
                            <td style="padding: 0.5rem;">Nausea, Vomiting</td>
                            <td style="padding: 0.5rem; text-align: center; color: red; font-weight: bold;">Y</td>
                            <td style="padding: 0.5rem; text-align: center;">N</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;">002</td>
                            <td style="padding: 0.5rem;">May 1, 14:30</td>
                            <td style="padding: 0.5rem;">29 F</td>
                            <td style="padding: 0.5rem;">Diarrhea, Fever</td>
                            <td style="padding: 0.5rem; text-align: center; color: red; font-weight: bold;">Y</td>
                            <td style="padding: 0.5rem; text-align: center;">Y</td>
                        </tr>
                        <tr style="background: var(--gray-bg);">
                            <td style="padding: 0.5rem;">003</td>
                            <td style="padding: 0.5rem;">May 2, 09:00</td>
                            <td style="padding: 0.5rem;">65 F</td>
                            <td style="padding: 0.5rem;">Vomiting</td>
                            <td style="padding: 0.5rem; text-align: center; color: red; font-weight: bold;">Y</td>
                            <td style="padding: 0.5rem; text-align: center;">N</td>
                        </tr>
                         <tr>
                            <td style="padding: 0.5rem;">004</td>
                            <td style="padding: 0.5rem;">--</td>
                            <td style="padding: 0.5rem;">40 M</td>
                            <td style="padding: 0.5rem;">None (Well)</td>
                            <td style="padding: 0.5rem; text-align: center;">N</td>
                            <td style="padding: 0.5rem; text-align: center;">Y</td>
                        </tr>
                    </tbody>
                </table></div>
                <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">Note: Case 004 is a control (well). Everyone who got sick (001-003) ate the Salad. This is your clue!</p>
            </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Line List:</strong> Row = Case, Column = Variable.</li>
                <li><strong>Cleaning:</strong> Fix typos, duplicates, and impossible values.</li>
                <li><strong>Privacy:</strong> Protect PII.</li>
            </ul>

            <div class="neo-card small" style="background: #fdf2f8; border-left: 4px solid var(--pink-500); margin: 2rem 0;">
                <h3><i class="ph-bold ph-table"></i> Advanced: Three-Way Tables</h3>
                <p>When analyzing data (Person/Place/Time), you might need a Stratified Analysis.</p>
                <p><strong>Scenario:</strong> Are older people more likely to get sick at the picnic?</p>
                <ul>
                    <li><strong>Table 1 (Young < 18):</strong> AR for Salad = 50%</li>
                    <li><strong>Table 2 (Old > 65):</strong> AR for Salad = 90%</li>
                </ul>
                <p>Stratifying by Age (the 3rd variable) reveals the interaction.</p>
            </div>

            <h2>9.4 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Line List:</strong> Row = Case, Column = Variable.</li>
                        <li><strong>Cleaning:</strong> Check for typos, duplicates, and impossible values (e.g., male with ovarian cyst).</li>
                        <li><strong>Privacy:</strong> Remove PII before sharing.</li>
                    </ul>
                </div>
            </div>
`
    },
    ch10: {
        title: "Chapter 10: Epi Curves & Timing",
        difficulty: "A",
        content: `
            <h1>Chapter 10: Epi Curves & Timing</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 1px solid #ca8a04; opacity: 0.3;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 2px solid #c2410c; font-weight: bold; box-shadow: 0 2px 4px rgba(194, 65, 12, 0.2); opacity: 1;">Advanced</span>
                </div>
            </div>

            <p class="lead">An Epidemic Curve (Epi Curve) is a histogram that shows the course of an outbreak by plotting the number of cases by time of onset. The <strong>shape</strong> of the curve tells you the <strong>mode of spread</strong>.</p>

            <h2>10.1 Types of Epi Curves</h2>
            
            <div class="epi-curve-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 2rem 0;">
                <!-- Point Source -->
                <div class="neo-card">
                    <h3 style="color: var(--teal-accent); margin-top: 0;">1. Point Source</h3>
                    <p><strong>Shape:</strong> Sharp rise, sharp fall. All cases occur within one incubation period.</p>
                    <svg viewBox="0 0 200 100" style="width: 100%; max-width: 280px; height: auto; background: #f0f0f0; border-radius: 4px; margin: 0 auto; display: block;">
                        <line x1="10" y1="90" x2="190" y2="90" stroke="#333" stroke-width="4" stroke-linecap="round"/>
                        <line x1="10" y1="90" x2="10" y2="10" stroke="#333" stroke-width="4" stroke-linecap="round"/>
                        <rect x="30" y="80" width="15" height="10" fill="var(--navy-primary)"/>
                        <rect x="45" y="60" width="15" height="30" fill="var(--navy-primary)"/>
                        <rect x="60" y="20" width="15" height="70" fill="var(--navy-primary)"/>
                        <rect x="75" y="50" width="15" height="40" fill="var(--navy-primary)"/>
                        <rect x="90" y="80" width="15" height="10" fill="var(--navy-primary)"/>
                    </svg>
                </div>
                <!-- Continuous -->
                <div class="neo-card">
                    <h3 style="color: var(--teal-accent); margin-top: 0; font-weight:800;">2. Continuous Common Source</h3>
                    <p><strong>Shape:</strong> Rise to a plateau, stays high, then falls when source is removed.</p>
                    <svg viewBox="0 0 200 100" style="width: 100%; max-width: 280px; height: auto; background: #f0f0f0; border-radius: 4px; margin: 0 auto; display: block;">
                        <line x1="10" y1="90" x2="190" y2="90" stroke="#333" stroke-width="4" stroke-linecap="round"/>
                        <line x1="10" y1="90" x2="10" y2="10" stroke="#333" stroke-width="4" stroke-linecap="round"/>
                        <rect x="30" y="70" width="15" height="20" fill="var(--navy-primary)"/>
                        <rect x="45" y="30" width="15" height="60" fill="var(--navy-primary)"/>
                        <rect x="60" y="30" width="15" height="60" fill="var(--navy-primary)"/>
                        <rect x="75" y="25" width="15" height="65" fill="var(--navy-primary)"/>
                        <rect x="90" y="30" width="15" height="60" fill="var(--navy-primary)"/>
                        <rect x="105" y="70" width="15" height="20" fill="var(--navy-primary)"/>
                    </svg>
                </div>
                 <!-- Propagated -->
                <div class="neo-card">
                    <h3 style="color: var(--teal-accent); margin-top: 0;">3. Propagated</h3>
                    <p><strong>Shape:</strong> Series of progressively taller peaks, one incubation period apart.</p>
                    <svg viewBox="0 0 200 100" style="width: 100%; max-width: 280px; height: auto; background: #f0f0f0; border-radius: 4px; margin: 0 auto; display: block;">
                         <line x1="10" y1="90" x2="190" y2="90" stroke="#333" stroke-width="2"/>
                        <line x1="10" y1="90" x2="10" y2="10" stroke="#333" stroke-width="2"/>
                        <rect x="20" y="80" width="10" height="10" fill="var(--navy-primary)"/>
                        <rect x="50" y="70" width="10" height="20" fill="var(--navy-primary)"/>
                        <rect x="60" y="60" width="10" height="30" fill="var(--navy-primary)"/>
                        <rect x="100" y="50" width="10" height="40" fill="var(--navy-primary)"/>
                        <rect x="110" y="30" width="10" height="60" fill="var(--navy-primary)"/>
                        <rect x="120" y="40" width="10" height="50" fill="var(--navy-primary)"/>
                    </svg>
                </div>
                 <!-- Intermittent -->
                <div class="neo-card">
                    <h3 style="color: var(--teal-accent); margin-top: 0;">4. Intermittent</h3>
                    <p><strong>Shape:</strong> Irregular peaks. Source is not constant.</p>
                    <svg viewBox="0 0 200 100" style="width: 100%; max-width: 280px; height: auto; background: #f0f0f0; border-radius: 4px; margin: 0 auto; display: block;">
                         <line x1="10" y1="90" x2="190" y2="90" stroke="#333" stroke-width="2"/>
                        <line x1="10" y1="90" x2="10" y2="10" stroke="#333" stroke-width="2"/>
                         <rect x="30" y="60" width="15" height="30" fill="var(--navy-primary)"/>
                        <rect x="80" y="50" width="15" height="40" fill="var(--navy-primary)"/>
                        <rect x="130" y="70" width="15" height="20" fill="var(--navy-primary)"/>
                    </svg>
                </div>
            </div>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Study Guide Tip: Outliers
                </div>
                <div class="callout-content">
                    <p><strong>Outlier:</strong> A case that stands apart from the rest.</p>
                    <ul>
                        <li><strong>Early Outlier:</strong> Likely the "Index Case" (Patient Zero) or an unrelated background case.</li>
                        <li><strong>Late Outlier:</strong> Likely a secondary case (someone who got it from a sick person) or unrelated.</li>
                    </ul>
                    <p><em>Always investigate outliers! They tell a story.</em></p>
                </div>
            </div>

            <h2>10.2 Exposure Window & Logic</h2>
            <p>For Point Source outbreaks, the Epi Curve is a mathematical tool. By using the known incubation period of a disease, you can calculate exactly when the exposure happened.</p>
            <p>The most critical use of the incubation period is reverse-engineering the <strong>Exposure Window</strong>â€”the definitive time frame during which the source of the outbreak was active.</p>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-function"></i>
                    Formulas: The Reverse-Engineering Logic
                </div>
                <div class="callout-content">
                    <p>To determine the window, use the extreme values:</p>
                    <p style="background: rgba(57, 204, 204, 0.1); padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
                        <strong>Earliest Exposure = Earliest Onset - Maximum Incubation</strong>
                    </p>
                    <p><em>(To get sick earliest, you must have been exposed at the earliest possible time relative to the long incubation).</em></p>
                    
                    <p style="background: rgba(57, 204, 204, 0.1); padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
                        <strong>Latest Exposure = Latest Onset - Minimum Incubation</strong>
                    </p>
                    <p><em>(To be the last case, you must have been exposed at the latest possible time relative to the short incubation).</em></p>
                </div>
            </div>

            <h2>10.3 Identifying Cases</h2>
            <ul>
                <li><strong>Index Case:</strong> The very first case to come to the attention of health authorities.</li>
                <li><strong>Primary Case:</strong> The person who brings the disease into a population.</li>
                <li><strong>Secondary Case:</strong> Persons who get the disease from the Primary Case (person-to-person spread).</li>
            </ul>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Outliers
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "Should you include outliers in your calculation?"</p>
                    <p><strong>ANSWER:</strong> Generally, <strong>NO</strong>.</p>
                    <p>If there is a single case that occurred 2 weeks before everyone else, it is likely the Index Case or unrelated. Focus on the main cluster for the exposure window of the general outbreak.</p>
                </div>
            </div>

            <h2>10.4 Exposure Window Drill Set</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Calculate the Window
                </div>
                <div class="callout-content">
                    <p><strong>Scenario:</strong> An outbreak has a known Incubation Period of <strong>1 to 3 days</strong>.</p>
                    <p><strong>Line List Data:</strong></p>
                    <ul>
                        <li>Earliest Onset: <strong>June 10</strong> (12:00 PM)</li>
                        <li>Latest Onset: <strong>June 14</strong> (12:00 PM)</li>
                    </ul>

                    <p style="margin-top: 1rem;"><strong>Question 1:</strong> Calculate the Earliest Possible Exposure.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Formula: Earliest Onset - Max Incubation</strong></p>
                            <p>June 10 - 3 days = <strong>June 7</strong></p>
                            <p><em>(Specifically June 7 at 12:00 PM)</em></p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Question 2:</strong> Calculate the Latest Possible Exposure.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Formula: Latest Onset - Min Incubation</strong></p>
                            <p>June 14 - 1 day = <strong>June 13</strong></p>
                            <p><em>(Specifically June 13 at 12:00 PM)</em></p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Question 3:</strong> A team dinner was held on <strong>June 6</strong>. Could this be the source?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: NO</strong></p>
                            <p>The exposure window is <strong>June 7 to June 13</strong>.</p>
                            <p>June 6 is outside this window. Even if the food was bad, it couldn't have caused <em>this</em> specific cluster of cases based on the incubation period.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Start Window:</strong> First Case - Max Incubation.</li>
                <li><strong>End Window:</strong> Last Case - Min Incubation.</li>
                <li><strong>Logic:</strong> Rule out any events outside this calculated window.</li>
            </ul>

            <!-- Practice tip for Epi Curve and Exposure Window tools -->
            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Practice Tip: Use the Epi Curve & Exposure Tools
                </div>
                <div class="callout-content">
                    <p>
                        Bring the math to life by plotting your own epidemic curves and calculating exposure windows using the
                        <strong>Epi Curve Generator</strong> and <strong>Exposure&nbsp;Window Calculator</strong> in the Interactive Tools section.
                        Enter the dates from an outbreak scenario to observe how the curve shape distinguishes between pointâ€‘source and propagated
                        outbreaks, then use the calculator to pinpoint the likely exposure interval. Experimenting with these tools will make the
                        formulas and logic in this chapter tangible.
                    </p>
                </div>
            </div>

            <h2>10.5 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Exposure Window:</strong> Earliest Onset - Max Incubation TO Latest Onset - Min Incubation.</li>
                        <li><strong>Outliers:</strong> Usually exclude from window calculation.</li>
                        <li><strong>Logic:</strong> If an event is outside the window, it's NOT the source.</li>
                    </ul>
                </div>
            </div>
        `
    }, ch11: {
        title: "Chapter 11: Outbreak Math I: AR & RR",

        difficulty: "M",
        content: `
    <h1>Chapter 11: Outbreak Math I: AR & RR</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 2px solid #ca8a04; font-weight: bold; box-shadow: 0 2px 4px rgba(202, 138, 4, 0.2); opacity: 1;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">Analytic epidemiology uses math to test hypotheses. The core tools for this are the <strong>2x2 Table</strong>, <strong>Attack Rates (AR)</strong>, and <strong>Relative Risk (RR)</strong>.</p>

            <h2>11.1 The Standard 2x2 Table</h2>
            <p>Always set up your table the same way to avoid calculation errors.</p>

            <div class="table-container"><table class="table" style="text-align: center;">
                <thead>
                    <tr style="background: var(--navy-primary); color: white;">
                        <th style="padding: 1rem; border: 1px solid white;">Exposure</th>
                        <th style="padding: 1rem; border: 1px solid white;">Ill (Cases)</th>
                        <th style="padding: 1rem; border: 1px solid white;">Well (Controls)</th>
                        <th style="padding: 1rem; border: 1px solid white;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 1rem; font-weight: bold; background: var(--gray-bg);">Exposed</td>
                        <td style="padding: 1rem; border: 1px solid #ddd; font-size: 1.2rem;">a</td>
                        <td style="padding: 1rem; border: 1px solid #ddd; font-size: 1.2rem;">b</td>
                        <td style="padding: 1rem; border: 1px solid #ddd; font-weight: bold;">a + b</td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem; font-weight: bold; background: var(--gray-bg);">Unexposed</td>
                        <td style="padding: 1rem; border: 1px solid #ddd; font-size: 1.2rem;">c</td>
                        <td style="padding: 1rem; border: 1px solid #ddd; font-size: 1.2rem;">d</td>
                        <td style="padding: 1rem; border: 1px solid #ddd; font-weight: bold;">c + d</td>
                    </tr>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem; font-weight: bold;">Total</td>
                        <td style="padding: 1rem; border: 1px solid #ddd; font-weight: bold;">a + c</td>
                        <td style="padding: 1rem; border: 1px solid #ddd; font-weight: bold;">b + d</td>
                        <td style="padding: 1rem; border: 1px solid #ddd; font-weight: bold;">N</td>
                    </tr>
                </tbody>
            </table></div>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Table Orientation
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> Tests sometimes flip the table (putting Disease on the left and Exposure on top).</p>
                    <p><strong>STRATEGY:</strong> ALWAYS re-draw the table in the standard format (Exposure on Left, Disease on Top) before calculating. The formulas (a/a+b) only work if the table is standard!</p>
                </div>
            </div>

            <h2>11.2 Attack Rate (AR)</h2>
            <p>An Attack Rate is actually a <strong>proportion</strong> (risk), not a true rate. It represents the probability of getting sick.</p>
            
            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-function"></i>
                    Formula: Attack Rate
                </div>
                <div class="callout-content">
                    <p style="font-size: 1.2rem; text-align: center; margin: 1rem 0;">
                        <strong>AR = (Number of Ill / Total Number in Group) Ã— 100</strong>
                    </p>
                    <ul>
                        <li><strong>AR (Exposed):</strong> a / (a + b)</li>
                        <li><strong>AR (Unexposed):</strong> c / (c + d)</li>
                    </ul>
                </div>
            </div>

            <h2>11.3 Relative Risk (RR)</h2>
            <p>Relative Risk compares the risk of disease in the exposed group to the risk in the unexposed group. It is used in <strong>Cohort Studies</strong>.</p>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-function"></i>
                    Formula: Relative Risk
                </div>
                <div class="callout-content">
                    <p style="font-size: 1.2rem; text-align: center; margin: 1rem 0;">
                        <strong>RR = (AR Exposed) / (AR Unexposed)</strong>
                    </p>
                    <p style="text-align: center;">
                        <em>or</em><br>
                        <strong>RR = [a / (a + b)] / [c / (c + d)]</strong>
                    </p>
                </div>
            </div>

            </div>

            <div class="neo-card small" style="border: 2px solid var(--accent-orange); margin: 2rem 0;">
                <h3><i class="ph-bold ph-clock"></i> Advanced: Incidence Density (Person-Time)</h3>
                <p>When people are at risk for different lengths of time (e.g., some leave the study early), use <strong>Incidence Density</strong>.</p>
                <p><strong>Formula:</strong> New Cases / Total Person-Time Observed</p>
                <p><em>Example:</em> 5 cases per 100 person-years.</p>
            </div>

            <h3>Interpreting RR</h3>
            <ul>
                <li><strong>RR = 1.0:</strong> No association (Null hypothesis). Risk is same in both groups.</li>
                <li><strong>RR > 1.0:</strong> Positive association (Risk factor). Exposure increases risk.</li>
                <li><strong>RR < 1.0:</strong> Negative association (Protective factor). Exposure decreases risk (e.g., vaccines).</li>
            </ul>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Magnitude Matters
                </div>
                <div class="callout-content">
                    <p>A statistical association doesn't prove causation, but a <strong>strong</strong> association makes it more likely.</p>
                    <ul>
                        <li>RR = 1.2 (Weak association)</li>
                        <li>RR = 3.0 (Moderate association)</li>
                        <li>RR = 10.0 (Strong association)</li>
                    </ul>
                    <p>In a foodborne outbreak, look for the food item with the <strong>highest RR</strong> (and usually a high AR in the exposed).</p>
                </div>
            </div>

            <h2>11.4 Calculation Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Practice Problem: The Church Picnic
                </div>
                <div class="callout-content">
                    <p><strong>Scenario:</strong> At a church picnic, 100 people ate potato salad, and 60 of them got sick. 50 people did NOT eat potato salad, and 5 of them got sick.</p>
                    
                    <p style="margin-top: 1rem;"><strong>1. Set up the 2x2 Table:</strong></p>
                    <div class="accordion">
                        <div class="accordion-header">Show Table</div>
                        <div class="accordion-content">
                            <div class="table-container"><table class="table" style="text-align: center;">
                                <tr style="background:#f0f0f0;">
                                    <th style="padding:0.5rem; border:1px solid #ccc;"></th>
                                    <th style="padding:0.5rem; border:1px solid #ccc;">Ill</th>
                                    <th style="padding:0.5rem; border:1px solid #ccc;">Well</th>
                                    <th style="padding:0.5rem; border:1px solid #ccc;">Total</th>
                                </tr>
                                <tr>
                                    <td style="padding:0.5rem; border:1px solid #ccc; font-weight:bold;">Exposed (Salad)</td>
                                    <td style="padding:0.5rem; border:1px solid #ccc;">60 (a)</td>
                                    <td style="padding:0.5rem; border:1px solid #ccc;">40 (b)</td>
                                    <td style="padding:0.5rem; border:1px solid #ccc;">100</td>
                                </tr>
                                <tr>
                                    <td style="padding:0.5rem; border:1px solid #ccc; font-weight:bold;">Unexposed</td>
                                    <td style="padding:0.5rem; border:1px solid #ccc;">5 (c)</td>
                                    <td style="padding:0.5rem; border:1px solid #ccc;">45 (d)</td>
                                    <td style="padding:0.5rem; border:1px solid #ccc;">50</td>
                                </tr>
                            </table></div>
                            <p style="font-size: 0.9rem; color: #666;">Note: You usually have to calculate the "Well" column (Total - Ill).</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>2. Calculate AR (Exposed):</strong></p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>AR Exposed = a / (a + b)</strong></p>
                            <p>Ill Exposed (a) = 60</p>
                            <p>Total Exposed (a + b) = 100</p>
                            <p><strong>AR = 60 / 100 = 0.60 or 60%</strong></p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>3. Calculate AR (Unexposed):</strong></p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>AR Unexposed = c / (c + d)</strong></p>
                            <p>Ill Unexposed (c) = 5</p>
                            <p>Total Unexposed (c + d) = 50</p>
                            <p><strong>AR = 5 / 50 = 0.10 or 10%</strong></p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>4. Calculate Relative Risk (RR):</strong></p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>RR = AR Exposed / AR Unexposed</strong></p>
                            <p>RR = 0.60 / 0.10</p>
                            <p><strong>RR = 6.0</strong></p>
                            <p><strong>Interpretation:</strong> People who ate potato salad were <strong>6 times more likely</strong> to get sick than those who did not.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>11.4 Advanced: Person-Time Incidence</h2>
            <div class="callout-header" style="background: var(--gold-accent); color: var(--navy-primary);">
                <i class="ph ph-star"></i> National Level Concept
            </div>
            <p>In standard Attack Rate calculations (Cumulative Incidence), we assume everyone started at the same time and was followed for the entire outbreak. But what if people join or leave the study at different times?</p>
            <p><strong>Incidence Rate (Incidence Density)</strong> uses "Person-Time" in the denominator.</p>

            <div class="neo-card small" style="background: #e0f2f1; border-left: 4px solid var(--teal-accent); margin: 1rem 0;">
                <p style="font-size: 1.1rem; text-align: center;"><strong>Incidence Rate = New Cases / Total Person-Time</strong></p>
            </div>

            <p><strong>What is Person-Time?</strong> It is the sum of time that each person remained "at risk" (disease-free).</p>
            <p><em>Example:</em> You follow 3 people for a year:</p>
            <ul>
                <li>Person A: Specific disease-free for 10 years.</li>
                <li>Person B: Gets sick after 2 years.</li>
                <li>Person C: Moves away (lost to follow-up) after 5 years.</li>
            </ul>
            <p><strong>Total Person-Time calculation:</strong> 10 + 2 + 5 = 17 Person-Years.</p>
            <p>If Person B was the only case, rate = 1 / 17 = 0.058 cases per person-year.</p>

            <h2>Summary</h2>
            <ul>
                <li>Always set up the 2x2 table: Exposure Left, Disease Top.</li>
                <li>AR = Ill / Total (for that group).</li>
                <li>RR = AR Exposed / AR Unexposed.</li>
                <li>RR > 1 indicates a risk factor.</li>
            </ul>

            <!-- Practice tip for interactive calculator -->
            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Practice Tip: Use the 2Ã—2 Calculator
                </div>
                <div class="callout-content">
                    <p>
                        Reinforce your understanding of Attack Rates and Relative Risk by experimenting with the
                        <strong>Interactive&nbsp;2Ã—2 Table&nbsp;Calculator</strong> in the Interactive Tools section. Enter different
                        values for <em>a</em>, <em>b</em>, <em>c</em> and <em>d</em> to see how AR and RR change. Handsâ€‘on practice with
                        real numbers makes these formulas stick.
                    </p>
                </div>
            </div>

            <h2>11.5 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>2Ã—2 Setup:</strong> Exposure on LEFT, Disease on TOP.</li>
                        <li><strong>AR:</strong> Cases / Total in group.</li>
                        <li><strong>RR:</strong> AR Exposed / AR Unexposed.</li>
                        <li><strong>RR > 1:</strong> Risk factor. RR < 1: Protective.</li>
                    </ul>
                </div>
            </div>
        `
    },
    ch12: {
        title: "Chapter 12: Outbreak Math II: Advanced",
        difficulty: "A",
        content: `
    <h1>Chapter 12: Outbreak Math II <span class="advanced-topic-badge">Extension</span></h1>
            
            <div class="advanced-section">
                <h4><i class="ph-bold ph-graduation-cap"></i> Note for Division B Students</h4>
                <p style="margin-bottom:0;">Core Division B rules focus on Attack Rates and Risk Ratios (Chapter 11). The concepts in this chapter (Odds Ratios, Confidence Intervals) are typically Division C topics but often appear as tie-breakers or in advanced invitationals. Learn this to master the "why" and gain a competitive edge.</p>
            </div>

            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 1px solid #ca8a04; opacity: 0.3;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 2px solid #c2410c; font-weight: bold; box-shadow: 0 2px 4px rgba(194, 65, 12, 0.2);">Advanced</span>
                </div>
            </div>

            <div style="text-align: center; margin: 2rem 0;">
                <h3 style="color: var(--navy-primary); margin-bottom: 1rem;">Study Design Quick Guide</h3>
                <svg width="100%" height="auto" viewBox="0 0 1100 850" class="responsive-svg" style="max-width: 1100px; height: auto; display: block; margin: 0 auto; background: white; border: 2px solid #ddd; border-radius: 8px; padding: 1rem; font-family: sans-serif;">
                    <defs>
                        <marker id="arr-wide" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#555" />
                        </marker>
                    </defs>

                    <!-- Main Title -->
                    <text x="550" y="30" text-anchor="middle" font-weight="900" font-size="22" fill="#1e40af">EPIDEMIOLOGICAL STUDY DESIGNS</text>

                    <!-- Level 1: Start -->
                    <g transform="translate(550, 60)">
                        <rect x="-120" y="-20" width="240" height="40" rx="20" fill="#1e40af" stroke="none"/>
                        <text x="0" y="5" text-anchor="middle" font-weight="bold" font-size="14" fill="white">Can investigator assign exposure?</text>
                    </g>
                    
                    <!-- Branch Lines Level 1 -->
                    <path d="M550,80 L250,110" stroke="#555" stroke-width="2" marker-end="url(#arr-wide)"/>
                    <path d="M550,80 L850,110" stroke="#555" stroke-width="2" marker-end="url(#arr-wide)"/>

                    <!-- YES -> EXPERIMENTAL (Left Side) -->
                    <g transform="translate(250, 130)">
                        <rect x="-100" y="-20" width="200" height="30" rx="0" fill="#dcfce7" stroke="#059669" stroke-width="3"/>
                        <text x="0" y="0" text-anchor="middle" font-weight="900" font-size="16" fill="#065f46">EXPERIMENTAL</text>
                        <text x="0" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#059669">Randomized?</text>
                    </g>

                    <!-- NO -> OBSERVATIONAL (Right Side) -->
                    <g transform="translate(850, 130)">
                        <rect x="-100" y="-20" width="200" height="30" rx="0" fill="#fef3c7" stroke="#d97706" stroke-width="3"/>
                        <text x="0" y="0" text-anchor="middle" font-weight="900" font-size="16" fill="#78350f">OBSERVATIONAL</text>
                        <text x="0" y="35" text-anchor="middle" font-weight="bold" font-size="12" fill="#92400e">Unit of Analysis?</text>
                    </g>
                    
                    <!-- EXPERIMENTAL BRANCH -->
                    <path d="M250,150 L150,200" stroke="#059669" stroke-width="2" marker-end="url(#arr-wide)"/>
                    <text x="180" y="180" font-size="11" font-weight="bold" fill="#059669">YES</text>
                    
                    <path d="M250,150 L350,200" stroke="#059669" stroke-width="2" marker-end="url(#arr-wide)"/>
                    <text x="320" y="180" font-size="11" font-weight="bold" fill="#059669">NO</text>

                    <!-- RCT Box -->
                    <g transform="translate(150, 240)">
                        <rect x="-80" y="-30" width="160" height="80" rx="8" fill="#dcfce7" stroke="#059669" stroke-width="3"/>
                        <text x="0" y="-10" text-anchor="middle" font-weight="900" font-size="14" fill="#065f46">RCT / Clinical Trial</text>
                        <text x="0" y="10" text-anchor="middle" font-size="11" fill="#047857">Gold Standard</text>
                        <text x="0" y="25" text-anchor="middle" font-size="11" fill="#047857">Testing Interventions</text>
                    </g>

                    <!-- Quasi-Experimental -->
                    <g transform="translate(350, 240)">
                        <rect x="-70" y="-30" width="140" height="80" rx="8" fill="#ecfdf5" stroke="#059669" stroke-width="2" stroke-dasharray="5,5"/>
                        <text x="0" y="-10" text-anchor="middle" font-weight="bold" font-size="12" fill="#065f46">Quasi-Experimental</text>
                        <text x="0" y="10" text-anchor="middle" font-size="11" fill="#047857">Community Trial</text>
                        <text x="0" y="25" text-anchor="middle" font-size="11" fill="#047857">Non-randomized</text>
                    </g>

                    <!-- OBSERVATIONAL BRANCH -->
                    
                    <!-- Group vs Individual Split -->
                    <path d="M850,150 L650,200" stroke="#d97706" stroke-width="2" marker-end="url(#arr-wide)"/>
                    <text x="700" y="180" font-size="11" font-weight="bold" fill="#78350f" transform="rotate(-15 700 180)">INDIVIDUAL</text>
                    
                    <path d="M850,150 L1000,200" stroke="#d97706" stroke-width="2" marker-end="url(#arr-wide)"/>
                    <text x="950" y="170" font-size="11" font-weight="bold" fill="#78350f">GROUP</text>

                    <!-- Ecological Box -->
                    <g transform="translate(1000, 240)">
                        <rect x="-75" y="-30" width="150" height="80" rx="8" fill="#f3e8ff" stroke="#7e22ce" stroke-width="3"/>
                        <text x="0" y="-10" text-anchor="middle" font-weight="900" font-size="14" fill="#581c87">ECOLOGICAL</text>
                        <text x="0" y="10" text-anchor="middle" font-size="11" fill="#6b21a8">Correlational Study</text>
                        <text x="0" y="25" text-anchor="middle" font-size="11" fill="#6b21a8">Data: Countries/States</text>
                        <text x="0" y="40" text-anchor="middle" font-size="9" fill="#db2777" font-style="italic">âš ï¸ Eco Fallacy!</text>
                    </g>

                    <!-- INDIVIDUAL Separation Question -->
                    <g transform="translate(650, 230)">
                        <rect x="-90" y="-15" width="180" height="30" rx="15" fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
                        <text x="0" y="5" text-anchor="middle" font-weight="bold" font-size="12" fill="#92400e">Recruit Based On?</text>
                    </g>

                    <!-- Individual Branches -->
                    <path d="M650,245 L500,330" stroke="#555" stroke-width="2" marker-end="url(#arr-wide)"/>
                    <text x="540" y="275" font-size="10" font-weight="bold" fill="#1e40af" transform="rotate(-20 540 275)">EXPOSURE</text>
                    
                    <path d="M650,245 L700,350" stroke="#555" stroke-width="2" marker-end="url(#arr-wide)"/>
                    <text x="685" y="300" font-size="10" font-weight="bold" fill="#0369a1">SNAPSHOT</text>
                    
                    <path d="M650,245 L900,350" stroke="#555" stroke-width="2" marker-end="url(#arr-wide)"/>
                    <text x="800" y="280" font-size="10" font-weight="bold" fill="#991b1b" transform="rotate(20 800 280)">DISEASE</text>

                    <!-- Cohort Box - Expanded -->
                    <g transform="translate(500, 390)">
                        <rect x="-90" y="-60" width="180" height="130" rx="8" fill="#dbeafe" stroke="#1d4ed8" stroke-width="3"/>
                        <text x="0" y="-40" text-anchor="middle" font-weight="900" font-size="16" fill="#1e40af">COHORT</text>
                        
                        <!-- Prospective -->
                        <text x="0" y="-15" text-anchor="middle" font-size="11" font-weight="bold" fill="#1e40af">1. PROSPECTIVE:</text>
                        <text x="0" y="-2" text-anchor="middle" font-size="10" fill="#1e40af">Start now â†’ Follow into future</text>
                        
                        <!-- Retrospective -->
                        <text x="0" y="25" text-anchor="middle" font-size="11" font-weight="bold" fill="#1e40af">2. RETROSPECTIVE:</text>
                        <text x="0" y="38" text-anchor="middle" font-size="10" fill="#1e40af">Start now â†’ Look at past records</text>
                        <text x="0" y="50" text-anchor="middle" font-size="10" fill="#1e40af">(Exposure happened in past)</text>
                    </g>

                    <!-- Cross-Sectional Box -->
                    <g transform="translate(700, 390)">
                        <rect x="-65" y="-40" width="130" height="90" rx="8" fill="#e0f2fe" stroke="#0ea5e9" stroke-width="3"/>
                        <text x="0" y="-20" text-anchor="middle" font-weight="900" font-size="14" fill="#0369a1">CROSS-SECT</text>
                        <text x="0" y="0" text-anchor="middle" font-size="11" font-weight="bold" fill="#0369a1">Snapshot (Now)</text>
                        <text x="0" y="15" text-anchor="middle" font-size="10" fill="#0369a1">Start: Both</text>
                        <text x="0" y="30" text-anchor="middle" font-size="10" font-weight="bold" fill="#0369a1">Calc: Prevalence</text>
                    </g>

                    <!-- Case-Control Box -->
                    <g transform="translate(900, 390)">
                        <rect x="-70" y="-40" width="140" height="90" rx="8" fill="#fee2e2" stroke="#dc2626" stroke-width="3"/>
                        <text x="0" y="-20" text-anchor="middle" font-weight="900" font-size="14" fill="#991b1b">CASE-CONTROL</text>
                        <text x="0" y="0" text-anchor="middle" font-size="11" font-weight="bold" fill="#991b1b">Backward (Retro)</text>
                        <text x="0" y="15" text-anchor="middle" font-size="10" fill="#991b1b">Start: Disease</text>
                        <text x="0" y="30" text-anchor="middle" font-size="10" font-weight="bold" fill="#991b1b">Calc: OR</text>
                    </g>

                    <!-- EXAM TIPS SECTION (Bottom Full Width) -->
                    <g transform="translate(550, 700)">
                        <rect x="-520" y="-120" width="1040" height="240" rx="10" fill="#fffbeb" stroke="#f59e0b" stroke-width="3"/>
                        
                        <!-- Header -->
                        <text x="0" y="-100" text-anchor="middle" font-weight="900" font-size="20" fill="#92400e">ðŸš€ THE ULTIMATE STUDY DESIGN EXAM GUIDE</text>
                        
                        <!-- COLUMN 1: KEYWORD ASSOCIATIONS -->
                        <g transform="translate(-480, -70)">
                            <text x="0" y="0" font-weight="bold" font-size="14" fill="#78350f">ðŸ“ QUESTION KEYWORDS:</text>
                            <text x="0" y="20" font-size="12" fill="#451a03">"Followed over time" â†’ <tspan font-weight="bold" fill="#065f46">Cohort</tspan></text>
                            <text x="0" y="40" font-size="12" fill="#451a03">"Randomly assigned" â†’ <tspan font-weight="bold" fill="#065f46">RCT</tspan></text>
                            <text x="0" y="60" font-size="12" fill="#451a03">"Cases and Controls" â†’ <tspan font-weight="bold" fill="#b91c1c">Case-Control</tspan></text>
                            <text x="0" y="80" font-size="12" fill="#451a03">"Survey/Questionnaire" â†’ <tspan font-weight="bold" fill="#0369a1">Cross-Sect</tspan></text>
                            <text x="0" y="100" font-size="12" fill="#451a03">"Average chocolate intake" â†’ <tspan font-weight="bold" fill="#6b21a8">Ecological</tspan></text>
                        </g>

                        <!-- COLUMN 2: COMMON MISTAKES -->
                        <g transform="translate(-180, -70)">
                            <text x="0" y="0" font-weight="bold" font-size="14" fill="#b91c1c">âš ï¸ FATAL MISTAKES:</text>
                            <text x="0" y="20" font-size="12" fill="#7f1d1d">1. Calculating Risk Ratio in Case-Control.</text>
                            <text x="15" y="35" font-size="11" fill="#7f1d1d" font-style="italic">Only Odds Ratio allowed!</tspan></text>
                            <text x="0" y="55" font-size="12" fill="#7f1d1d">2. Confusing Prevalence with Incidence.</text>
                            <text x="15" y="70" font-size="11" fill="#7f1d1d" font-style="italic">Cross-Sect = Prev, Cohort = Inc.</tspan></text>
                            <text x="0" y="90" font-size="12" fill="#7f1d1d">3. The Ecological Fallacy.</text>
                            <text x="15" y="105" font-size="11" fill="#7f1d1d" font-style="italic">Group trend â‰  Individual truth.</tspan></text>
                        </g>

                        <!-- COLUMN 3: MNEMONICS & TIPS -->
                        <g transform="translate(150, -70)">
                            <text x="0" y="0" font-weight="bold" font-size="14" fill="#047857">ðŸ§  MNEMONICS & TRICKS:</text>
                            <text x="0" y="20" font-size="12" fill="#064e3b"><tspan font-weight="bold">"COH-ort"</tspan> sounds like "GO-forth"</text>
                            <text x="15" y="35" font-size="11" fill="#064e3b" font-style="italic">You go forward in time!</tspan></text>
                            <text x="0" y="55" font-size="12" fill="#064e3b"><tspan font-weight="bold">"Case-Control"</tspan> looks BACK</text>
                            <text x="15" y="70" font-size="11" fill="#064e3b" font-style="italic">Like investigating a crime scene.</tspan></text>
                            
                            <!-- New Cohort Trap -->
                             <text x="0" y="95" font-size="12" fill="#b91c1c"><tspan font-weight="bold">TRAP: Retro Cohort vs Case-Control</tspan></text>
                            <text x="15" y="110" font-size="11" fill="#b91c1c" font-style="italic">Retro Cohort starts with Exposure!</tspan></text>
                            <text x="15" y="125" font-size="11" fill="#b91c1c" font-style="italic">Case-Control starts with Disease!</tspan></text>
                        </g>

                         <!-- BOTTOM: MASTER SUMMARY -->
                         <rect x="-480" y="65" width="960" height="40" rx="5" fill="#fff7ed" stroke="#f97316" stroke-width="1"/>
                         <text x="0" y="90" text-anchor="middle" font-weight="bold" font-size="14" fill="#9a3412">
                             KEY: Time Direction determines Design â†’ Design determines Measure (RR vs OR)
                         </text>
                    </g>
                </svg>
            </div>

            <!-- Additional learning box below flowchart -->
            <div class="study-tip" style="margin: 2rem 0;">
                <div class="callout-header">
                    <i class="ph ph-brain"></i>
                    Mnemonic: "Really Cool Cohorts Can Cross-check Evidence"
                </div>
                <div class="callout-content">
                    <ul>
                        <li><strong>R</strong>CT - Randomized Control Trial (best evidence)</li>
                        <li><strong>C</strong>ohort - Follow exposed vs unexposed forward</li>
                        <li><strong>C</strong>ase-Control - Start with cases, look back</li>
                        <li><strong>C</strong>ross-Sectional - One point in time snapshot</li>
                        <li><strong>E</strong>cological - Population-level, exploratory</li>
                    </ul>
                    <p style="margin-top: 1rem;"><strong>Key Exam Question:</strong> "Which measure can you calculate?" â†’ Depends on study type!</p>
                    <ul style="margin-top: 0.5rem;">
                        <li>Cohort â†’ Attack Rate, RR, Risk Difference</li>
                        <li>Case-Control â†’ Odds Ratio (OR) ONLY</li>
                        <li>Cross-Sectional â†’ Prevalence ONLY</li>
                    </ul>
                </div>
            </div>

            <div style="margin: 2rem 0;">
                <h3 style="color: var(--navy-primary);">Study Design Cheat Sheet</h3>
                <div class="table-container"><table class="table">
                             <th style="padding: 1rem; border: 1px solid white;">Feature</th>
                             <th style="padding: 1rem; border: 1px solid white;">Cohort</th>
                             <th style="padding: 1rem; border: 1px solid white;">Case-Control</th>
                             <th style="padding: 1rem; border: 1px solid white;">Cross-Sectional</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 1rem; font-weight: bold; background: #eee;">Direction</td>
                            <td style="padding: 1rem;">Forward (Exposure -> Disease)</td>
                            <td style="padding: 1rem;">Backward (Disease -> Exposure)</td>
                            <td style="padding: 1rem;">Snapshot (Present)</td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem; font-weight: bold; background: #eee;">Starting Group</td>
                            <td style="padding: 1rem;">Exposed vs Unexposed</td>
                            <td style="padding: 1rem;">Sick (Case) vs Well (Control)</td>
                            <td style="padding: 1rem;">Total Sample</td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem; font-weight: bold; background: #eee;">Measure</td>
                            <td style="padding: 1rem;">Relative Risk (RR) / AR</td>
                            <td style="padding: 1rem;">Odds Ratio (OR)</td>
                            <td style="padding: 1rem;">Prevalence Ratio</td>
                        </tr>
                         <tr>
                            <td style="padding: 1rem; font-weight: bold; background: #eee;">Best For</td>
                            <td style="padding: 1rem;">Rare Exposures</td>
                            <td style="padding: 1rem;">Rare Diseases, Outbreaks</td>
                            <td style="padding: 1rem;">Surveys, Burden of Disease</td>
                        </tr>
                         <tr>
                            <td style="padding: 1rem; font-weight: bold; background: #eee;">Cost/Time</td>
                            <td style="padding: 1rem;">High / Long</td>
                            <td style="padding: 1rem;">Low / Fast</td>
                            <td style="padding: 1rem;">Medium</td>
                        </tr>
                    </tbody>
                </table></div>
            </div>

            <p class="lead">In Case-Control studies (where you start with sick people and look back), you cannot calculate Attack Rates because you don't know the total population. Instead, you calculate the <strong>Odds Ratio (OR)</strong>.</p>

            <h2>12.1 The Odds Ratio (OR)</h2>
            <p><strong>Formula:</strong> (A Ã— D) / (B Ã— C)</p>
            
            <!-- High Contrast 2x2 Table -->
            <div style="overflow-x: auto; margin: 1.5rem 0;">
                <div class="table-container"><table class="table" style="border: 3px solid black;">
                    <thead>
                        <tr style="background: black; color: white;">
                            <th style="padding: 1rem; border: 1px solid #555;">Exposure Group</th>
                            <th style="padding: 1rem; border: 1px solid #555;">Case (Sick)</th>
                            <th style="padding: 1rem; border: 1px solid #555;">Control (Not Sick)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 1rem; font-weight: bold; background: #eee; border: 1px solid black;">Exposed</td>
                            <td style="padding: 1rem; text-align: center; font-size: 1.5rem; border: 2px solid black; font-weight: 900;">A</td>
                            <td style="padding: 1rem; text-align: center; font-size: 1.5rem; border: 2px solid black; font-weight: 900;">B</td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem; font-weight: bold; background: #eee; border: 1px solid black;">Unexposed</td>
                            <td style="padding: 1rem; text-align: center; font-size: 1.5rem; border: 2px solid black; font-weight: 900;">C</td>
                            <td style="padding: 1rem; text-align: center; font-size: 1.5rem; border: 2px solid black; font-weight: 900;">D</td>
                        </tr>
                    </tbody>
                </table></div>
            </div>

            <p>Using the standard 2x2 table:</p>
            <ul>
                <li><strong>A:</strong> Exposed Case</li>
                <li><strong>B:</strong> Exposed Control</li>
                <li><strong>C:</strong> Unexposed Case</li>
                <li><strong>D:</strong> Unexposed Control</li>
            </ul>

            <div style="background: white; border: 3px solid var(--navy-primary); color: var(--navy-primary); padding: 1.5rem; border-radius: 8px; text-align: center; margin: 2rem 0;">
                <h3 style="margin-top: 0; color: var(--navy-primary); font-size: 1.5rem;">OR = (A Ã— D) / (B Ã— C)</h3>
                <p style="font-size: 1.1rem; font-weight: bold;"><em>"Cross-multiply the table!"</em></p>
            </div>

            <h2>12.2 Interpreting the Result</h2>
            <ul>
                <li><strong>OR = 1:</strong> No association. (Exposure has no effect).</li>
                <li><strong>OR > 1:</strong> Positive association. (Exposure is a <strong>Risk Factor</strong>).</li>
                <li><strong>OR < 1:</strong> Negative association. (Exposure is <strong>Protective</strong>, like a vaccine).</li>
            </ul>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Confidence Intervals (CI)
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "Is the result statistically significant?"</p>
                    <p><strong>RULE:</strong> Look at the 95% Confidence Interval (e.g., OR=2.5, CI: 0.8 - 4.2).</p>
                    <ul>
                        <li>If the range <strong>includes 1.0</strong>, it is <strong>NOT</strong> statistically significant. (It could be chance).</li>
                        <li>If the range is entirely above or below 1.0 (e.g., 1.2 - 5.0), it <strong>IS</strong> significant.</li>
                    </ul>
                </div>
            </div>

            <h2>12.3 Advanced Math Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Calculate & Interpret
                </div>
                <div class="callout-content">
                    <p><strong>Data:</strong></p>
                    <ul>
                        <li>A (Ate Fish, Sick) = 20</li>
                        <li>B (Ate Fish, Not Sick) = 10</li>
                        <li>C (No Fish, Sick) = 5</li>
                        <li>D (No Fish, Not Sick) = 30</li>
                    </ul>

                    <p style="margin-top: 1rem;"><strong>Question 1:</strong> Calculate the Odds Ratio.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: 12.0</strong></p>
                            <p>OR = (20 Ã— 30) / (10 Ã— 5) = 600 / 50 = 12.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Question 2:</strong> Interpret the result.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Strong Risk Factor</strong></p>
                            <p>People who ate fish were 12 times more likely to get sick than those who didn't.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Question 3:</strong> If the CI is 0.9 - 15.0, is it significant?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: NO</strong></p>
                            <p>The interval includes 1.0, so the result could be due to chance.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 12.4 Study Design Cheat Sheet -->
            <h2>12.4 Study Design Cheat Sheet</h2>
            <p>Different analytic study designs answer different questions and use different measures.  DivisionÂ B exams may ask you to identify the design or choose the correct measure.  Use this cheat sheet to keep them straight:</p>
            <div class="table-container"><table class="table">
                <thead>
                    <tr>
                        <th>Design</th>
                        <th>When to Use</th>
                        <th>Measure</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Cohort Study</strong></td>
                        <td>Follow exposed &amp; unexposed groups forward in time to compare disease incidence</td>
                        <td>Attack Rate, Risk Ratio (RR), Risk Difference</td>
                    </tr>
                    <tr>
                        <td><strong>Caseâ€“Control Study</strong></td>
                        <td>Start with cases &amp; controls; look back to see exposures</td>
                        <td>Odds Ratio (OR) â€“ use <em>when disease is rare</em></td>
                    </tr>
                    <tr>
                        <td><strong>Crossâ€‘Sectional Study</strong></td>
                        <td>Snapshot of exposure &amp; disease at one time</td>
                        <td>Prevalence, cannot distinguish cause vs effect</td>
                    </tr>
                </tbody>
            </table></div>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-warning"></i> Exam Trap: Wrong Measure</div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> Calculating a Risk Ratio for a caseâ€“control study or an Odds Ratio for a cohort study.</p>
                    <p><strong>TIPS:</strong></p>
                    <ul>
                        <li><strong>Cohort = Attack Rates &amp; Risk Ratios:</strong> Because you know the population at risk.</li>
                        <li><strong>Caseâ€“Control = Odds Ratios:</strong> Because you do not know the total number of exposed/unexposed in the source population.</li>
                        <li><strong>Crossâ€‘Sectional = Prevalence:</strong> Measures existing disease; cannot infer causality.</li>
                    </ul>
                </div>
                </div>
            </div>

            <h2>12.5 Advanced Study Designs & Pitfalls (ADVANCED)</h2>
            <div class="neo-card small" style="background: #fff0f0; border-left: 4px solid var(--danger);">
                <h3><i class="ph-bold ph-scales"></i> Matched Case-Control & Mantel-Haenszel</h3>
                <p><strong>Matched Analysis:</strong> If you matched controls to cases by age/sex to prevent confounding, you cannot use the normal OR formula.</p>
                <ul>
                    <li><strong>Formula:</strong> b / c (Ratio of discordant pairs).</li>
                </ul>
                <p><strong>Mantel-Haenszel:</strong> A statistical technique to combine results from multiple strata (e.g., combining age groups) to get an "Adjusted OR". It removes the effect of the confounder.</p>
            </div>

            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-warning"></i> Ecological Fallacy</div>
                <div class="callout-content">
                    <p><strong>Ecological Study:</strong> Compares groups (nations), not individuals.</p>
                    <p><strong>The Trap:</strong> Assuming a correlation at the group level applies to individuals.</p>
                    <p><em>Example:</em> "Rich countries breastfeed less." Does NOT mean "Rich women breastfeed less." (Maybe poor women in rich countries drive the trend).</p>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Case-Control Study:</strong> Use Odds Ratio (OR).</li>
                <li><strong>Formula:</strong> AD / BC.</li>
                <li><strong>Significance:</strong> CI must NOT cross 1.0.</li>
            </ul>

            <!-- Practice tip for case-control math -->
            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Practice Tip: Explore Odds Ratios
                </div>
                <div class="callout-content">
                    <p>
                        For a deeper understanding of Odds Ratios, enter sample values into the
                        <strong>Interactive&nbsp;2Ã—2 Table&nbsp;Calculator</strong> in the Interactive Tools section.
                        Since caseâ€“control studies don't provide attack rates, experiment with different combinations of A,
                        B, C, and D and watch how the OR changes. Try to adjust the numbers so that the 95&nbsp;%
                        confidence interval crosses 1.0 and see how that affects significance.
                    </p>
                </div>
            </div>

            <h2>12.4 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Case-Control Study:</strong> Use Odds Ratio (OR). Formula: (AÃ—D)/(BÃ—C).</li>
                        <li><strong>Significance:</strong> If 95% CI includes 1.0, it is NOT significant.</li>
                        <li><strong>Interpretation:</strong> OR > 1 is a Risk Factor, OR < 1 is Protective.</li>
                    </ul>
                </div>
            </div>
`
    },
    ch13: {
        title: "Chapter 13: Hypothesis Testing",
        difficulty: "A",
        content: `
    <h1>Chapter 13: Hypothesis Testing</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 1px solid #ca8a04; opacity: 0.3;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 2px solid #c2410c; font-weight: bold; box-shadow: 0 2px 4px rgba(194, 65, 12, 0.2); opacity: 1;">Advanced</span>
                </div>
            </div>

            <p class="lead">Epidemiology is a science of testing ideas. We don't just guess; we form hypotheses and test them with data to see if they hold up.</p>

            <h2>13.1 The Hypotheses</h2>
            <p>Every study has two competing hypotheses:</p>
            <ul>
                <li><strong>Null Hypothesis (Hâ‚€):</strong> There is <strong>NO</strong> association between the exposure and the disease. (The "Boring" hypothesis).</li>
                <li><strong>Alternative Hypothesis (Hâ‚ or Hâ‚):</strong> There <strong>IS</strong> an association. (The "Interesting" hypothesis).</li>
            </ul>

            <div style="background: #eef2ff; color: #1e1b4b; padding: 1.5rem; border-radius: 8px; margin: 2rem 0; border: 2px solid #312e81;">
                <h3 style="margin-top: 0; color: #312e81;">The P-Value</h3>
                <p>The probability that the results occurred by <strong>chance</strong> alone.</p>
                <ul>
                    <li><strong>p < 0.05:</strong> Statistically Significant. (Reject Hâ‚€).</li>
                    <li><strong>p > 0.05:</strong> Not Significant. (Fail to reject Hâ‚€).</li>
                </ul>
            </div>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Mnemonic: RARE
                </div>
                <div class="callout-content">
                    <p><strong>When P is Low, the Null Must Go!</strong></p>
                    <p>Think <strong>RARE</strong>:</p>
                    <p>If the outcome is <strong>RARE</strong> (p < 0.05) due to chance, you <strong>REJECT</strong> the Null Hypothesis.</p>
                </div>
            </div>

            <h2>13.2 Errors in Testing</h2>
            <p>Sometimes the math leads us to the wrong conclusion.</p>

            <div class="table-container"><table class="table">
                <thead style="background: var(--navy-primary); color: white;">
                    <tr>
                        <th style="padding: 1rem; text-align: left;">Reality</th>
                        <th style="padding: 1rem; text-align: left;">Study Says "Yes"</th>
                        <th style="padding: 1rem; text-align: left;">Study Says "No"</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>There IS an association</strong></td>
                        <td style="padding: 1rem;"><span style="color: green;">Correct</span></td>
                        <td style="padding: 1rem;"><strong>Type II Error</strong> (False Negative)</td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>There is NO association</strong></td>
                        <td style="padding: 1rem;"><strong>Type I Error</strong> (False Positive)</td>
                        <td style="padding: 1rem;"><span style="color: green;">Correct</span></td>
                    </tr>
                </tbody>
            </table></div>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Study Guide Tip: Mnemonics
                </div>
                <div class="callout-content">
                    <p><strong>Type I (False Positive):</strong> Telling a man he is pregnant. (You found something that isn't there).</p>
                    <p><strong>Type II (False Negative):</strong> Telling a clearly pregnant woman she isn't pregnant. (You missed something that is there).</p>
                </div>
            </div>

            <h2>13.3 Advanced Statistics (National Level)</h2>
            <div class="callout-header" style="background: var(--gold-accent); color: var(--navy-primary);">
                <i class="ph ph-star"></i> National Level Concept
            </div>
            <p>At the National level, you must go beyond just "p < 0.05". You need to understand <strong>Chi-Square</strong> and <strong>Confidence Intervals</strong>.</p>

            <h3>1. Chi-Square (Ï‡Â²) Test</h3>
            <p>Used to test if the observed data differs from what we would expect by chance.</p>
            <p style="background: rgba(57, 204, 204, 0.1); padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
                <strong>Ï‡Â² = Î£ [ (Observed - Expected)Â² / Expected ]</strong>
            </p>
            <ul>
                <li><strong>Observed:</strong> The actual numbers in your 2x2 table.</li>
                <li><strong>Expected:</strong> The numbers if there was NO association (Null Hypothesis).</li>
                <li><strong>Rule:</strong> High Ï‡Â² value (> 3.84 for 1 degree of freedom) -> Low p-value (< 0.05) -> Significant.</li>
            </ul>

            <h3>2. Confidence Intervals (CI)</h3>
            <p>The CI tells you the <strong>precision</strong> of your estimate. A narrow CI is precise; a wide CI is not.</p>
            <ul>
                <li><strong>95% CI:</strong> If we repeated the study 100 times, the true value would be in this range 95 times.</li>
                <li><strong>Standard Error (SE):</strong> Used to calculate CI. Larger sample size = Smaller SE = Narrower CI = More Precision.</li>
            </ul>

            <h2>13.4 Advanced Concepts (National)</h2>
            <div class="neo-card small" style="background: #eef2ff; border-left: 4px solid var(--accent-purple);">
                 <h3><i class="ph-bold ph-chart-bar-horizontal"></i> Power & Sample Size</h3>
                 <ul>
                     <li><strong>Power (1 - Î²):</strong> The ability to detect a difference if one exists. Usually aim for 80%.</li>
                     <li><strong>Sample Size:</strong> To detect a <em>smaller</em> difference, you need a <em>larger</em> sample size.</li>
                 </ul>
                 <h3><i class="ph-bold ph-warning-octagon"></i> Multiplicity & Errors</h3>
                 <ul>
                     <li><strong>Type III Error:</strong> Getting the right answer to the wrong question (asking the wrong research question).</li>
                     <li><strong>Bonferroni Correction:</strong> If you test 20 hypotheses, 1 will be significant by chance (p=0.05). To fix this, divide p-value by number of tests (0.05 / 20).</li>
                 </ul>
            </div>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Mnemonic: Hypothesis Testing (RARE)
                </div>
                <div class="callout-content">
                    <p><strong>"RARE" - Remember hypothesis testing concepts:</strong></p>
                    <ul>
                        <li><strong>R</strong>eject null when p < Î± (usually 0.05)</li>
                        <li><strong>A</strong>lpha (Î±) = Type I error = False positive (rejecting true null)</li>
                        <li><strong>R</strong>are event = Type II error (Î²) = False negative (accepting false null)</li>
                        <li><strong>E</strong>ffect size matters (statistical significance â‰  clinical significance)</li>
                    </ul>
                    <p><strong>Exam Tip:</strong> Remember that a "significant" p-value (p < 0.05) means you <em>reject</em> the null hypothesis, not accept it!</p>
                    <p><strong>Bonus:</strong> Type III error = Getting the right answer to the wrong question (asking wrong research question)</p>
                </div>
            </div>

            <h2>13.5 Hypothesis Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Identify the Concept
                </div>
                <div class="callout-content">
                    <p><strong>Scenario 1:</strong> "There is no difference in illness rates between those who ate spinach and those who didn't."</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Null Hypothesis (Hâ‚€)</strong></p>
                            <p>It assumes no association.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 2:</strong> You calculate a p-value of 0.03.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Significant</strong></p>
                            <p>Since 0.03 < 0.05, you reject the Null Hypothesis. The association is likely real.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 3:</strong> Your study says the spinach is safe, but it actually caused the outbreak.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Type II Error</strong></p>
                            <p>False Negative. You missed the truth.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Hâ‚€:</strong> No difference.</li>
                <li><strong>p < 0.05:</strong> Significant.</li>
                <li><strong>Type I:</strong> False Positive.</li>
                <li><strong>Type II:</strong> False Negative.</li>
            </ul>

            <h2>13.4 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Null Hypothesis (Hâ‚€):</strong> "No association" (Boring).</li>
                        <li><strong>P-Value:</strong> < 0.05 means Significant (Reject Hâ‚€).</li>
                        <li><strong>Errors:</strong> Type I (False Positive - Man Pregnant), Type II (False Negative - Missed it).</li>
                    </ul>
                </div>
            </div>
`
    },
    ch14: {
        title: "Chapter 14: Patterns & Data Synthesis",
        difficulty: "M",
        content: `
    <h1>Chapter 14: Patterns & Data Synthesis</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 2px solid #ca8a04; font-weight: bold; box-shadow: 0 2px 4px rgba(202, 138, 4, 0.2); opacity: 1;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">Real outbreaks are messy. You rarely get a perfect Epi Curve or a single obvious risk factor. You must synthesize data from <strong>Person</strong>, <strong>Place</strong>, and <strong>Time</strong> to see the whole picture.</p>

            <h2>14.1 Triangulation</h2>
            <p><strong>Triangulation</strong> is the process of using multiple data sources to confirm a hypothesis. If the Epi Curve suggests a point source, the Map shows clustering around a specific restaurant, and the Line List shows everyone ate there, you have strong evidence.</p>

            <div class="table-container"><table class="table" style="text-align: center;">
                <thead style="background: var(--navy-primary); color: white;">
                    <tr>
                        <th style="width: 33%; padding: 1rem;">Time</th>
                        <th style="width: 33%; padding: 1rem;">Place</th>
                        <th style="width: 33%; padding: 1rem;">Person</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 1.5rem; vertical-align: top;">
                            <i class="ph ph-clock" style="font-size: 2rem; color: var(--navy-primary); display: block; margin-bottom: 0.5rem;"></i>
                            <div style="font-weight: bold; margin-bottom: 0.25rem;">Epi Curve</div>
                            <div style="font-size: 0.9rem; color: #666;">(Point Source?)</div>
                        </td>
                        <td style="padding: 1.5rem; vertical-align: top;">
                            <i class="ph ph-map-pin" style="font-size: 2rem; color: var(--navy-primary); display: block; margin-bottom: 0.5rem;"></i>
                            <div style="font-weight: bold; margin-bottom: 0.25rem;">Spot Map</div>
                            <div style="font-size: 0.9rem; color: #666;">(Clustering?)</div>
                        </td>
                        <td style="padding: 1.5rem; vertical-align: top;">
                            <i class="ph ph-users" style="font-size: 2rem; color: var(--navy-primary); display: block; margin-bottom: 0.5rem;"></i>
                            <div style="font-weight: bold; margin-bottom: 0.25rem;">Demographics</div>
                            <div style="font-size: 0.9rem; color: #666;">(Age/Sex?)</div>
                        </td>
                    </tr>
                </tbody>
            </table></div>

            <h2>14.2 Vital Statistics & Demography</h2>
            <p>Beyond basic rates, you need advanced measures to compare populations and quantify impact.</p>

            <div class="neo-card" style="margin-bottom: 2rem;">
                <h3 style="margin-top:0; border-bottom: 2px solid var(--accent-orange); display:inline-block;">SMR (Standardized Mortality Ratio)</h3>
                <p>Used in occupational studies to compare a workforce to the general population.</p>
                <div class="formula-box">SMR = Observed Deaths / Expected Deaths</div>
                <p class="text-sm"><strong>Interpretation:</strong></p>
                <ul>
                    <li>SMR = 1.0: Risk is same as general population.</li>
                    <li>SMR > 1.0: Higher risk (e.g., SMR 1.5 = 50% excess deaths).</li>
                    <li>SMR < 1.0: Lower risk (often seeing the "Healthy Worker Effect").</li>
                </ul>
            </div>

            <div class="neo-card" style="margin-bottom: 2rem;">
                <h3 style="margin-top:0; border-bottom: 2px solid var(--accent-orange); display:inline-block;">YPLL (Years of Potential Life Lost)</h3>
                <p>Measures the impact of premature death. Weighted by age (younger deaths count more).</p>
                <div class="formula-box">YPLL = &Sigma; (Reference Age - Age at Death)</div>
                <p class="text-sm"><strong>Example:</strong> Reference age 65.<br>Person dies at 60 -> 5 YPLL.<br>Person dies at 10 -> 55 YPLL.<br>Person dies at 70 -> 0 YPLL.</p>
            </div>

            <h3 style="color: var(--navy-primary);">Crude vs. Age-Adjusted Rates</h3>
            <p><strong>Crude Rate:</strong> The actual rate in the population. Good for burden of disease.</p>
            <p><strong>Age-Adjusted Rate:</strong> A statistical "what if" rate used to compare populations with different age structures (e.g., Florida vs. Alaska).</p>
            <p><strong>Rule:</strong> If Population A is older than Population B, A will likely have a higher <em>Crude</em> death rate even if health care is equal. <em>Adjusting</em> removes the age bias.</p>

            <h2>14.3 Identifying Patterns</h2>
            <ul>
                <li><strong>Clustering:</strong> Cases grouped closely in time or space. (e.g., A cluster of cancer cases in one neighborhood).</li>
                <li><strong>Seasonality:</strong> Disease spikes at certain times of year (e.g., Flu in winter, West Nile in summer).</li>
                <li><strong>Secular Trends:</strong> Long-term changes over years (e.g., Decrease in smoking, increase in diabetes).</li>
            </ul>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: The "Artifact"
                </div>
                <div class="callout-content">
                    <p>Sometimes a "pattern" isn't real. It's an <strong>artifact</strong> of how data was collected.</p>
                    <p><strong>Example:</strong> A sudden spike in cases might just be because a new testing lab opened, or the case definition changed. Always ask: "Did surveillance change?"</p>
                </div>
            </div>

            <h2>14.4 Synthesis Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Connect the Dots
                </div>
                <div class="callout-content">
                    <p><strong>Data Points:</strong></p>
                    <ul>
                        <li><strong>Time:</strong> Cases started June 1st, peaked June 15th, ended June 30th.</li>
                        <li><strong>Place:</strong> All cases live near "Lake X".</li>
                        <li><strong>Person:</strong> Only children aged 5-12 are affected.</li>
                    </ul>

                    <p style="margin-top: 1rem;"><strong>Question 1:</strong> What is the likely Mode of Transmission?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Vehicle (Waterborne) or Vector (Mosquitoes)</strong></p>
                            <p>The location (Lake) suggests water or bugs. The age group suggests swimming or playing outside.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Question 2:</strong> Why aren't adults sick?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Behavioral or Immunity</strong></p>
                            <p>Adults might not swim in the lake, or they might have prior immunity.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Question 3:</strong> Is this a Propagated outbreak?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Unlikely</strong></p>
                            <p>It looks more like a Continuous Common Source (exposure to the lake over summer) or a Point Source with a wide range.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Triangulate:</strong> Use Time, Place, and Person together.</li>
                <li><strong>Artifacts:</strong> Check if data collection changed.</li>
                <li><strong>Context:</strong> Seasonality and trends matter.</li>
            </ul>

            <h2>14.4 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Triangulation:</strong> Use Time, Place, and Person together to confirm a hypothesis.</li>
                        <li><strong>Artifacts:</strong> Sudden spikes often mean a change in reporting/testing, not a real outbreak.</li>
                        <li><strong>Context:</strong> Always consider seasonality (Flu in winter) and long-term trends.</li>
                    </ul>
                </div>
            </div>
`
    },
    ch15: {
        title: "Chapter 15: Levels of Prevention",
        difficulty: "M",
        content: `
    <h1>Chapter 15: Levels of Prevention</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 2px solid #ca8a04; font-weight: bold; box-shadow: 0 2px 4px rgba(202, 138, 4, 0.2); opacity: 1;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">Public health interventions are classified into three levels based on <strong>when</strong> they occur in the disease process. Mastering this classification is a guaranteed way to pick up points on the exam.</p>

            <h2>15.1 The Three Levels (P-S-T)</h2>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Study Guide Tip: P-S-T Mnemonic
                </div>
                <div class="callout-content">
                    <p><strong>P</strong>rimary = <strong>P</strong>revent (Before disease)</p>
                    <p><strong>S</strong>econdary = <strong>S</strong>creen (Early disease)</p>
                    <p><strong>T</strong>ertiary = <strong>T</strong>reat (Established disease)</p>
                </div>
            </div>

            <div class="neo-card" style="margin: 2rem 0; padding: 1rem; border: none; background: #fff;">
                <h3 style="text-align: center; color: var(--navy-primary); margin-bottom: 2rem;">Visualizing the Levels of Prevention</h3>
                <svg viewBox="0 0 800 320" class="responsive-svg" style="width: 100%; max-width: 900px; height: auto; font-family: 'Inter', sans-serif; display: block; margin: 0 auto;">
                    <!-- Definitions -->
                    <defs>
                        <marker id="arrowHead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#555"/>
                        </marker>
                    </defs>
                    
                    <!-- TIME ARROW -->
                    <line x1="50" y1="30" x2="750" y2="30" stroke="#555" stroke-width="2" marker-end="url(#arrowHead)"/>
                    <text x="750" y="22" text-anchor="end" font-size="11" font-weight="bold" fill="#555">TIME â†’</text>

                    <!-- Stage Labels (Top) -->
                    <text x="150" y="52" text-anchor="middle" font-size="10" fill="#666">Before Risk Factors</text>
                    <text x="300" y="52" text-anchor="middle" font-size="10" fill="#666">Susceptibility</text>
                    <text x="500" y="52" text-anchor="middle" font-size="10" fill="#666">Subclinical</text>
                    <text x="680" y="52" text-anchor="middle" font-size="10" fill="#666">Clinical Disease</text>

                    <!-- PREVENTION BOXES -->
                    
                    <!-- Primordial -->
                    <g transform="translate(40, 70)">
                        <rect x="0" y="0" width="160" height="180" rx="8" fill="#f0f9ff" stroke="#0284c7" stroke-width="2"/>
                        <rect x="0" y="0" width="160" height="35" rx="8" fill="#0284c7"/>
                        <text x="80" y="22" text-anchor="middle" font-weight="bold" fill="white" font-size="12">PRIMORDIAL</text>
                        
                        <text x="80" y="55" text-anchor="middle" font-size="11" font-weight="bold" fill="#0284c7">Prevent Risk Factors</text>
                        <line x1="15" y1="65" x2="145" y2="65" stroke="#0284c7" stroke-width="1" opacity="0.3"/>
                        
                        <text x="80" y="85" text-anchor="middle" font-size="10" fill="#333">Policy: Ban trans fats</text>
                        <text x="80" y="100" text-anchor="middle" font-size="10" fill="#333">Urban planning</text>
                        <text x="80" y="115" text-anchor="middle" font-size="10" fill="#333">Social programs</text>
                        <text x="80" y="135" text-anchor="middle" font-size="9" font-style="italic" fill="#666">Population-level</text>
                        <text x="80" y="150" text-anchor="middle" font-size="9" font-style="italic" fill="#666">before exposure</text>
                    </g>

                    <!-- Primary -->
                    <g transform="translate(220, 70)">
                        <rect x="0" y="0" width="160" height="180" rx="8" fill="#ecfdf5" stroke="#059669" stroke-width="2"/>
                        <rect x="0" y="0" width="160" height="35" rx="8" fill="#059669"/>
                        <text x="80" y="22" text-anchor="middle" font-weight="bold" fill="white" font-size="12">PRIMARY</text>
                        
                        <text x="80" y="55" text-anchor="middle" font-size="11" font-weight="bold" fill="#059669">PREVENT Disease</text>
                        <line x1="15" y1="65" x2="145" y2="65" stroke="#059669" stroke-width="1" opacity="0.3"/>
                        
                        <text x="80" y="85" text-anchor="middle" font-size="10" fill="#333">Vaccines</text>
                        <text x="80" y="100" text-anchor="middle" font-size="10" fill="#333">Health education</text>
                        <text x="80" y="115" text-anchor="middle" font-size="10" fill="#333">Sanitation</text>
                        <text x="80" y="135" text-anchor="middle" font-size="9" font-style="italic" fill="#666">Healthy people</text>
                        <text x="80" y="150" text-anchor="middle" font-size="9" font-style="italic" fill="#666">at risk</text>
                    </g>

                    <!-- Secondary -->
                    <g transform="translate(400, 70)">
                        <rect x="0" y="0" width="160" height="180" rx="8" fill="#fffbeb" stroke="#d97706" stroke-width="2"/>
                        <rect x="0" y="0" width="160" height="35" rx="8" fill="#d97706"/>
                        <text x="80" y="22" text-anchor="middle" font-weight="bold" fill="white" font-size="12">SECONDARY</text>
                        
                        <text x="80" y="55" text-anchor="middle" font-size="11" font-weight="bold" fill="#d97706">SCREEN Early</text>
                        <line x1="15" y1="65" x2="145" y2="65" stroke="#d97706" stroke-width="1" opacity="0.3"/>
                        
                        <text x="80" y="85" text-anchor="middle" font-size="10" fill="#333">Mammograms</text>
                        <text x="80" y="100" text-anchor="middle" font-size="10" fill="#333">BP checks</text>
                        <text x="80" y="115" text-anchor="middle" font-size="10" fill="#333">Contact tracing</text>
                        <text x="80" y="135" text-anchor="middle" font-size="9" font-style="italic" fill="#666">Sick but</text>
                        <text x="80" y="150" text-anchor="middle" font-size="9" font-style="italic" fill="#666">asymptomatic</text>
                    </g>

                    <!-- Tertiary -->
                    <g transform="translate(580, 70)">
                        <rect x="0" y="0" width="160" height="180" rx="8" fill="#fef2f2" stroke="#dc2626" stroke-width="2"/>
                        <rect x="0" y="0" width="160" height="35" rx="8" fill="#dc2626"/>
                        <text x="80" y="22" text-anchor="middle" font-weight="bold" fill="white" font-size="12">TERTIARY</text>
                        
                        <text x="80" y="55" text-anchor="middle" font-size="11" font-weight="bold" fill="#dc2626">TREAT & Manage</text>
                        <line x1="15" y1="65" x2="145" y2="65" stroke="#dc2626" stroke-width="1" opacity="0.3"/>
                        
                        <text x="80" y="85" text-anchor="middle" font-size="10" fill="#333">Rehab / PT</text>
                        <text x="80" y="100" text-anchor="middle" font-size="10" fill="#333">Surgery</text>
                        <text x="80" y="115" text-anchor="middle" font-size="10" fill="#333">Medications</text>
                        <text x="80" y="135" text-anchor="middle" font-size="9" font-style="italic" fill="#666">Sick with</text>
                        <text x="80" y="150" text-anchor="middle" font-size="9" font-style="italic" fill="#666">symptoms</text>
                    </g>

                    <!-- Event Markers -->
                    <line x1="210" y1="15" x2="210" y2="280" stroke="#aaa" stroke-width="1" stroke-dasharray="3,3"/>
                    <text x="210" y="12" text-anchor="middle" font-size="9" fill="#0284c7" font-weight="bold">Risk Exposure</text>
                    
                    <line x1="390" y1="15" x2="390" y2="280" stroke="#aaa" stroke-width="1" stroke-dasharray="3,3"/>
                    <text x="390" y="12" text-anchor="middle" font-size="9" fill="#059669" font-weight="bold">Infection</text>
                    
                    <line x1="570" y1="15" x2="570" y2="280" stroke="#aaa" stroke-width="1" stroke-dasharray="3,3"/>
                    <text x="570" y="12" text-anchor="middle" font-size="9" fill="#d97706" font-weight="bold">Symptoms</text>

                    <!-- Bottom Note -->
                    <text x="400" y="295" text-anchor="middle" font-size="10" fill="#666" font-style="italic">â† Earlier = More Effective & Less Costly â†’</text>
                </svg>
            </div>

            <div class="table-container"><table class="table">
                <thead style="background: var(--navy-primary); color: white;">
                    <tr>
                        <th style="padding: 1rem; text-align: left;">Level</th>
                        <th style="padding: 1rem; text-align: left;">Goal</th>
                        <th style="padding: 1rem; text-align: left;">Target Population</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Primordial</strong></td>
                        <td style="padding: 1rem;">Prevent risk factors from developing in the first place.</td>
                        <td style="padding: 1rem;">Entire populations (before risk exposure)</td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>Primary</strong></td>
                        <td style="padding: 1rem;">Prevent disease from occurring at all.</td>
                        <td style="padding: 1rem;">Healthy people (Susceptible)</td>
                    </tr>
                    <tr style="background: var(--gray-bg);">
                        <td style="padding: 1rem;"><strong>Secondary</strong></td>
                        <td style="padding: 1rem;">Detect disease early for better outcome.</td>
                        <td style="padding: 1rem;">Sick but asymptomatic (Subclinical)</td>
                    </tr>
                    <tr>
                        <td style="padding: 1rem;"><strong>Tertiary</strong></td>
                        <td style="padding: 1rem;">Reduce severity/disability.</td>
                        <td style="padding: 1rem;">Sick and symptomatic (Clinical)</td>
                    </tr>
                </tbody>
            </table></div>

            <h2>15.2 Primary Prevention</h2>
            <p><strong>Action:</strong> Intervene before the disease process starts.</p>
            <p><strong>Examples:</strong></p>
            <ul>
                <li>Vaccination (Immunization)</li>
                <li>Health education (e.g., "Don't smoke")</li>
                <li>Sanitation and clean water</li>
                <li>Vector control (spraying for mosquitoes)</li>
                <li>Wearing a seatbelt</li>
            </ul>

            <h2>15.3 Secondary Prevention</h2>
            <p><strong>Action:</strong> Detect disease early (Screening) to stop progression.</p>
            <p><strong>Examples:</strong></p>
            <ul>
                <li>Mammograms (Breast cancer screening)</li>
                <li>Blood pressure checks</li>
                <li>Pap smears</li>
                <li>Colonoscopies</li>
                <li>Contact tracing (finding exposed people)</li>
            </ul>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Screening is Secondary
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "A doctor gives a patient a mammogram to prevent breast cancer death. What level is this?"</p>
                    <p><strong>WRONG:</strong> Primary (It doesn't prevent the <em>disease</em>, it prevents <em>death</em> from the disease).</p>
                    <p><strong>RIGHT:</strong> Secondary (It detects the disease early).</p>
                    <p><strong>Rule:</strong> If it's a TEST or SCREENING, it's usually Secondary.</p>
                </div>
            </div>

            <h2>15.4 Tertiary Prevention</h2>
            <p><strong>Action:</strong> Manage existing disease to prevent complications/disability.</p>
            <p><strong>Examples:</strong></p>
            <ul>
                <li>Physical therapy after a stroke</li>
                <li>Insulin for a diabetic</li>
                <li>Support groups for alcoholics</li>
                <li>Surgery to repair damage</li>
            </ul>

            <h2>15.5 Advanced Prevention Levels (National)</h2>
            <div class="callout-header" style="background: var(--gold-accent); color: var(--navy-primary);">
                <i class="ph ph-star"></i> National Level Concept
            </div>
            
            <p>Beyond the standard Primary/Secondary/Tertiary, advanced epidemiology (especially for Policy stations) adds two more levels.</p>

            <div class="neo-card" style="margin: 2rem 0; background: #f0fdf4;">
                <h3 style="color: var(--teal-accent); margin-top: 0;">Primordial Prevention</h3>
                <p><strong>Goal:</strong> Prevent the <em>emergence</em> of risk factors in the first place (Calculated at the Population Level).</p>
                <p><strong>Difference from Primary:</strong> Primary targets individuals who have risk factors (e.g., "Stop smoking"). Primordial targets the societal structure so smoking never becomes a habit (e.g., "Ban cigarette ads").</p>
                <p><strong>Examples:</strong></p>
                <ul>
                    <li>National policy to reduce salt in processed foods (prevents hypertension risk factor).</li>
                    <li>Urban planning to encourage walking (prevents obesity risk factor).</li>
                </ul>
            </div>

            <div class="neo-card" style="margin: 2rem 0; background: #fff1f2;">
                <h3 style="color: #be123c; margin-top: 0;">Quaternary Prevention (P4)</h3>
                <p><strong>Goal:</strong> Protect patients from medical harm (Over-medicalization).</p>
                <p><strong>Context:</strong> "First, do no harm." Preventing unnecessary tests, treatments, and over-diagnosis.</p>
                <p><strong>Examples:</strong></p>
                <ul>
                    <li>Refusing to prescribe antibiotics for a viral cold.</li>
                    <li>Stopping routine screenings (like PSA) in very elderly patients where the harm of treatment outweighs benefits.</li>
                    <li>Protecting patients from "labeling" (stigma).</li>
                </ul>
            </div>

            <h2>15.5 Classification Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Classify the Intervention
                </div>
                <div class="callout-content">
                    <p><strong>Scenario 1:</strong> A city adds fluoride to the water supply to prevent cavities.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Primary Prevention</strong></p>
                            <p>It prevents the disease (cavities) from ever happening.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 2:</strong> A diabetic patient takes medication to prevent foot ulcers.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Tertiary Prevention</strong></p>
                            <p>The patient already has the disease (diabetes). The goal is to prevent complications (ulcers).</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 3:</strong> A school nurse checks students' hair for lice.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Secondary Prevention</strong></p>
                            <p>This is screening/detection. It doesn't prevent lice from landing on them, but catches it early.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Primary:</strong> Prevent onset (Vaccines).</li>
                <li><strong>Secondary:</strong> Early detection (Screening).</li>
                <li><strong>Tertiary:</strong> Minimize damage (Rehab).</li>
            </ul>

            <h2>15.6 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Primary:</strong> Prevent BEFORE it happens (Vaccines, Education).</li>
                        <li><strong>Secondary:</strong> SCREENING and Early Detection (Mammograms, Contact Tracing).</li>
                        <li><strong>Tertiary:</strong> TREAT and Rehab (PT, Insulin).</li>
                    </ul>
                </div>
            </div>

            <!-- New Section 15.7: Beyond Pâ€‘Sâ€‘T -->
            <h2>15.7 Beyond Pâ€‘Sâ€‘T: Comprehensive Prevention Strategies</h2>
            <p>Realâ€‘world disease control involves more than three discrete levels. Additional strategies cut across stages and focus on the population and environment:</p>
            <ul>
                <li><strong>Vector control:</strong> Reduce exposure to mosquitoes and ticks through habitat removal, insecticides, bed nets and personal protection.</li>
                <li><strong>Quarantine & Isolation:</strong> Separate exposed or ill individuals to prevent onward transmission. Quarantine applies to exposed but asymptomatic people; isolation applies to sick patients.</li>
                <li><strong>Contact tracing:</strong> Identify and monitor contacts of cases to interrupt chains of transmission. Digital tools can assist with rapid notifications.</li>
                <li><strong>Environmental interventions:</strong> Improve sanitation, housing quality, air and water safety. These primordial actions reduce multiple diseases simultaneously.</li>
                <li><strong>Policy & social change:</strong> Legislation (e.g., smoking bans, seat belt laws) and cultural shifts can prevent risk factors from arising in the first place.</li>
            </ul>
`
    },
    ch16: {
        title: "Chapter 16: Control Measures & Hierarchy",
        difficulty: "M",
        content: `
    <h1>Chapter 16: Control Measures & Hierarchy</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 2px solid #ca8a04; font-weight: bold; box-shadow: 0 2px 4px rgba(202, 138, 4, 0.2); opacity: 1;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 1px solid #c2410c; opacity: 0.3;">Advanced</span>
                </div>
            </div>

            <p class="lead">Once an outbreak is identified, the goal is to stop it. Public health uses a specific hierarchy to determine the most effective ways to control a hazard.</p>

            <h2>16.1 The Hierarchy of Controls</h2>
            <p>From <strong>MOST</strong> effective to <strong>LEAST</strong> effective:</p>

            <div style="margin: 2rem 0; display: flex; flex-direction: column; gap: 0.5rem;">
                <div style="background: #001f3f; color: white; padding: 1rem; border-radius: 4px; text-align: center; width: 100%;">
                    <strong>1. Elimination</strong> (Physically remove the hazard)
                    <br><span style="font-size: 0.9rem; opacity: 0.8;">Most Effective</span>
                </div>
                <div style="background: #003366; color: white; padding: 1rem; border-radius: 4px; text-align: center; width: 90%; align-self: center;">
                    <strong>2. Substitution</strong> (Replace the hazard)
                </div>
                <div style="background: #004080; color: white; padding: 1rem; border-radius: 4px; text-align: center; width: 80%; align-self: center;">
                    <strong>3. Engineering Controls</strong> (Isolate people from the hazard)
                </div>
                <div style="background: #0059b3; color: white; padding: 1rem; border-radius: 4px; text-align: center; width: 70%; align-self: center;">
                    <strong>4. Administrative Controls</strong> (Change the way people work)
                </div>
                <div style="background: #39CCCC; color: #001f3f; padding: 1rem; border-radius: 4px; text-align: center; width: 60%; align-self: center;">
                    <strong>5. PPE</strong> (Protect the worker with Personal Protective Equipment)
                    <br><span style="font-size: 0.9rem; opacity: 0.8;">Least Effective</span>
                </div>
            </div>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: PPE is the Last Resort
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "What is the most effective way to protect nurses from Ebola?"</p>
                    <p><strong>Student Answer:</strong> "Give them full hazmat suits (PPE)."</p>
                    <p><strong>CORRECT Answer:</strong> "Engineering controls (Negative pressure rooms) or Administrative controls (Limit number of staff)."</p>
                    <p><strong>Why?</strong> PPE relies on human behavior. If you take it off wrong, you get infected. Engineering controls work automatically.</p>
                </div>
            </div>

            <h2>16.2 Non-Pharmaceutical Interventions (NPIs)</h2>
            <p>Actions, apart from getting vaccinated and taking medicine, that people and communities can take to help slow the spread of illnesses like pandemic influenza.</p>
            <ul>
                <li><strong>Personal:</strong> Hand washing, staying home when sick, covering coughs.</li>
                <li><strong>Community:</strong> Social distancing, school closures, teleworking, cancelling mass gatherings.</li>
                <li><strong>Policy & social change:</strong> Legislation (e.g., smoking bans, seat belt laws) and cultural shifts can prevent risk factors from arising in the first place.</li>
            </ul>

            <div class="neo-card small" style="background: #fdf2f8; border-left: 4px solid var(--pink-500); margin-top: 2rem;">
                 <h3><i class="ph-bold ph-table"></i> Control Strategy Matrix</h3>
                 <p>Different diseases require different targets:</p>
                 <div class="table-container"><table class="table">
                     <thead><tr><th>Target</th><th>Action</th><th>Example</th></tr></thead>
                     <tbody>
                         <tr><td><strong>Source</strong></td><td>Remove/Inactivate</td><td>Pasteurizing milk, treating water.</td></tr>
                         <tr style="background: #fff;"><td><strong>Transmission</strong></td><td>Block/Interrupt</td><td>Mosquito nets, hand washing.</td></tr>
                         <tr><td><strong>Susceptible</strong></td><td>Protect/Modify</td><td>Vaccination, chemoprophylaxis.</td></tr>
                     </tbody>
                 </table></div>
            </div>



            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Mnemonic: Chain of Infection (RET EH)
                </div>
                <div class="callout-content">
                    <p><strong>"RET EH" - Remember the 5 links in the chain:</strong></p>
                    <ul>
                        <li><strong>R</strong>eservoir â€“ Source of the pathogen (humans, animals, environment)</li>
                        <li><strong>E</strong>xit â€“ Portal of exit (respiratory, fecal, blood)</li>
                        <li><strong>T</strong>ransmission â€“ Mode of spread (direct, indirect, airborne, vector)</li>
                        <li><strong>E</strong>ntry â€“ Portal of entry (respiratory, GI, skin)</li>
                        <li><strong>H</strong>ost â€“ Susceptible host (unvaccinated, immunocompromised)</li>
                    </ul>
                    <p><strong>Exam Tip:</strong> To control an outbreak, you can break <em>any</em> link in the chain. Questions may ask "Which link is being broken?" when describing a control measure.</p>
                    <p><strong>Example:</strong> Mosquito nets break the <strong>T</strong>ransmission link (vector-borne). Vaccination protects the <strong>H</strong>ost.</p>
                </div>
            </div>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Ring Vaccination
                </div>
                <div class="callout-content">
                    <p>Instead of vaccinating everyone (Mass Vaccination), you vaccinate:</p>
                    <ol>
                        <li>The contacts of confirmed cases.</li>
                        <li>The contacts of those contacts.</li>
                    </ol>
                    <p>This creates a "ring" of immunity around the virus, trapping it. This strategy eradicated <strong>Smallpox</strong>.</p>
                </div>
            </div>

            <h2>16.3 Control Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Classify the Control Measure
                </div>
                <div class="callout-content">
                    <p><strong>Scenario 1:</strong> Installing a plexiglass barrier between a cashier and customers.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Engineering Control</strong></p>
                            <p>You are physically isolating people from the hazard without relying on their behavior.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 2:</strong> Requiring all hospital staff to attend a training on hand hygiene.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Administrative Control</strong></p>
                            <p>You are changing the way people work (policies/training).</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 3:</strong> Discontinuing the use of a toxic chemical in a lab and using a safer one instead.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Substitution</strong></p>
                            <p>You are replacing the hazard.</p>
                        </div>
                    </div>
                </div>
            </div>
            <h2>16.4 Interactive Simulation: Stop the Outbreak</h2>
            <p>Adjust the sliders below to see how interventions affected the reproduction number ($R_0$) during the COVID-19 pandemic. Can you get R < 1.0?</p>

            <div id="control-sim-root" style="margin: 2rem 0;"></div>

            <script>
                if(typeof VisualComponents !== 'undefined' && document.getElementById('control-sim-root')) {
                    VisualComponents.renderControlSimulator('control-sim-root');
                }
            </script>

            <h2>Summary</h2>
            <ul>
                <li><strong>Hierarchy:</strong> Elimination > Substitution > Engineering > Administrative > PPE.</li>
                <li><strong>NPIs:</strong> Social distancing, masks, closures (used when vaccines aren't available).</li>
                <li><strong>Ring Vaccination:</strong> Targeted strategy for eradication.</li>
            </ul>

            <h2>16.4 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Hierarchy:</strong> Elimination > Substitution > Engineering > Admin > PPE.</li>
                        <li><strong>PPE:</strong> The LEAST effective method (relies on humans).</li>
                        <li><strong>Ring Vaccination:</strong> Vaccinate contacts of cases (Smallpox strategy).</li>
                    </ul>
                </div>
            </div>
`
    },
    ch17: {
        title: "Chapter 17: Isolation, Quarantine & Ethics",
        difficulty: "A",
        content: `
    <h1>Chapter 17: Isolation, Quarantine & Ethics</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 1px solid #ca8a04; opacity: 0.3;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 2px solid #c2410c; font-weight: bold; box-shadow: 0 2px 4px rgba(194, 65, 12, 0.2); opacity: 1;">Advanced</span>
                </div>
            </div>

            <p class="lead">Public health often balances individual rights with the safety of the community. The most powerful (and controversial) tools for this are Isolation and Quarantine.</p>

            <h2>17.1 The Critical Distinction</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin: 2rem 0;">
                <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid var(--callout-trap); padding: 1.5rem; border-radius: 8px;">
                    <h3 style="color: var(--callout-trap); margin-top: 0;">Isolation</h3>
                    <p>Separating <strong>SICK</strong> people from healthy people.</p>
                    <p><em>Example:</em> A hospital ward for TB patients.</p>
                </div>
                <div style="background: rgba(251, 191, 36, 0.1); border: 2px solid var(--callout-tip); padding: 1.5rem; border-radius: 8px;">
                    <h3 style="color: #d97706; margin-top: 0;">Quarantine</h3>
                    <p>Separating <strong>EXPOSED</strong> (but not yet sick) people to see if they become sick.</p>
                    <p><em>Example:</em> Asking travelers to stay home for 14 days.</p>
                </div>
            </div>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Study Guide Tip: Mnemonic
                </div>
                <div class="callout-content">
                    <p><strong>I</strong>solation is for <strong>I</strong>ll people.</p>
                    <p><strong>Q</strong>uarantine is for <strong>Q</strong>uestionable people (we don't know if they are sick yet).</p>
                </div>
            </div>

            <h2>17.2 Ethical Principles</h2>
            <ul>
                <li><strong>Autonomy:</strong> The right of an individual to make their own choices. (Public health often overrides this).</li>
                <li><strong>Beneficence:</strong> Acting in the best interest of the patient/public.</li>
                <li><strong>Justice:</strong> Ensuring burdens and benefits are distributed fairly. (e.g., Not just quarantining the poor).</li>
            </ul>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Least Restrictive Means
                </div>
                <div class="callout-content">
                    <p>The law requires using the <strong>least restrictive</strong> method necessary to protect the public.</p>
                    <p><em>Example:</em> If home quarantine works, you cannot force someone into a hospital jail cell.</p>
                </div>
            </div>

            <h2>17.3 Classification Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-check-circle"></i>
                    Isolation or Quarantine?
                </div>
                <div class="callout-content">
                    <p><strong>Scenario 1:</strong> A student with Measles is sent home from school.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Isolation</strong></p>
                            <p>The student is already sick (Ill).</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 2:</strong> The siblings of the Measles patient are told to stay home, even though they feel fine.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Quarantine</strong></p>
                            <p>They are exposed but not yet sick (Questionable).</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 3:</strong> Closing the entire school.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Social Distancing (Community Quarantine)</strong></p>
                            <p>This is a broader measure to reduce contact, often called "Reverse Quarantine" or "Shelter in Place" depending on context, but technically a form of mass quarantine/distancing.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Isolation:</strong> Sick people.</li>
                <li><strong>Quarantine:</strong> Exposed people.</li>
                <li><strong>Ethics:</strong> Balance rights vs. safety.</li>
            </ul>

            <h2>17.4 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Isolation:</strong> For SICK people (Ill).</li>
                        <li><strong>Quarantine:</strong> For EXPOSED people (Questionable).</li>
                        <li><strong>Least Restrictive Means:</strong> Don't use a hammer when a scalpel will do.</li>
                    </ul>
                </div>
            </div>
`
    },
    ch18: {
        title: "Chapter 18: Population Immunity & Râ‚€",
        difficulty: "A",
        content: `
    <h1>Chapter 18: Population Immunity & Râ‚€</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 1px solid #ca8a04; opacity: 0.3;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 2px solid #c2410c; font-weight: bold; box-shadow: 0 2px 4px rgba(194, 65, 12, 0.2); opacity: 1;">Advanced</span>
                </div>
            </div>

            <p class="lead">How many people need to be vaccinated to stop an outbreak? The answer lies in the <strong>Basic Reproduction Number (Râ‚€)</strong> and the <strong>Herd Immunity Threshold (HIT)</strong>.</p>

            <h2>18.1 Basic Reproduction Number (Râ‚€)</h2>
            <p><strong>Definition:</strong> The average number of <em>secondary</em> cases produced by one infected individual in a <em>completely susceptible</em> population.</p>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-lightbulb"></i>
                    Study Guide Tip: Râ‚€ Interpretation
                </div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Râ‚€ < 1:</strong> Disease will die out.</li>
                        <li><strong>Râ‚€ = 1:</strong> Disease becomes endemic (stable).</li>
                        <li><strong>Râ‚€ > 1:</strong> Disease will spread (Epidemic potential).</li>
                    </ul>
                    <p><strong>Measles:</strong> Râ‚€ â‰ˆ 12-18 (Highly contagious)</p>
                    <p><strong>Influenza:</strong> Râ‚€ â‰ˆ 1.5-2 (Moderately contagious)</p>
                    <p><strong>Ebola:</strong> Râ‚€ â‰ˆ 1.5-2.5 (Spread requires close contact)</p>
                </div>
            </div>

            <div class="table-container"><table class="table" style="text-align: center;">
                 <thead style="background: var(--navy-primary); color: white;">
                    <tr><th>Disease</th><th>Transmission</th><th>Râ‚€ (Approx)</th><th>HIT</th></tr>
                 </thead>
                 <tbody>
                    <tr><td>Measles</td><td>Airborne</td><td>12-18</td><td>92-95%</td></tr>
                    <tr style="background: var(--gray-bg);"><td>Pertussis</td><td>Airborne</td><td>12-17</td><td>92-94%</td></tr>
                    <tr><td>Chickenpox</td><td>Airborne</td><td>10-12</td><td>90%</td></tr>
                    <tr style="background: var(--gray-bg);"><td>Polio</td><td>Fecal-Oral</td><td>5-7</td><td>80-86%</td></tr>
                    <tr><td>Smallpox</td><td>Droplet</td><td>3.5-6</td><td>80-85%</td></tr>
                    <tr style="background: var(--gray-bg);"><td>SARS-CoV-2 (Omicron)</td><td>Airborne</td><td>9.5 (Est)</td><td>High</td></tr>
                    <tr><td>Ebola</td><td>Direct Contact</td><td>1.5-2.5</td><td>33-60%</td></tr>
                 </tbody>
            </table></div>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Râ‚€ is NOT Constant
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> "Is Râ‚€ a biological constant for a virus?"</p>
                    <p><strong>ANSWER: NO.</strong></p>
                    <p>Râ‚€ depends on:</p>
                    <ol>
                        <li><strong>Duration</strong> of infectiousness</li>
                        <li><strong>Probability</strong> of transmission per contact</li>
                        <li><strong>Rate</strong> of contact between people</li>
                    </ol>
                    <p>Social distancing REDUCES the contact rate, effectively lowering the transmission potential.</p>
                </div>
            </div>

            <h2>18.2 Herd Immunity Threshold (HIT)</h2>
            <p>The percentage of the population that must be immune to prevent an outbreak.</p>

            <div class="study-tip">
                <div class="callout-header">
                    <i class="ph ph-function"></i>
                    Formula: Herd Immunity Threshold
                </div>
                <div class="callout-content">
                    <p style="font-size: 1.2rem; text-align: center; margin: 1rem 0;">
                        <strong>HIT = 1 - (1 / Râ‚€)</strong>
                    </p>
                    <p><em>Result is a decimal. Multiply by 100 for percentage.</em></p>
                </div>
            </div>

            <h2>18.3 Effective Reproduction Number (Râ‚‘ or Râ‚œ)</h2>
            <p>Râ‚€ assumes everyone is susceptible. In the real world, some people are immune (vaccine or prior infection).</p>
            <p style="background: rgba(57, 204, 204, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--teal-accent);">
                <strong>Râ‚‘ = Râ‚€ Ã— (Fraction Susceptible)</strong>
            </p>
            <p><strong>Goal of Vaccination:</strong> Reduce the fraction susceptible until Râ‚‘ < 1.</p>

            <h2>18.4 Calculation Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Calculate the Threshold
                </div>
                <div class="callout-content">
                    <p><strong>Scenario 1:</strong> A new flu strain has an Râ‚€ of 2. What % of the population must be vaccinated to stop it?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>HIT = 1 - (1 / Râ‚€)</strong></p>
                            <p>HIT = 1 - (1 / 2)</p>
                            <p>HIT = 1 - 0.5 = 0.5</p>
                            <p><strong>Answer: 50%</strong></p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 2:</strong> Measles has an Râ‚€ of 18. What is the HIT?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>HIT = 1 - (1 / Râ‚€)</strong></p>
                            <p>HIT = 1 - (1 / 18)</p>
                            <p>HIT = 1 - 0.055...</p>
                            <p>HIT â‰ˆ 0.944</p>
                            <p><strong>Answer: ~94-95%</strong></p>
                            <p><em>(This is why measles outbreaks happen when vaccination rates drop even slightly!)</em></p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 3:</strong> If Râ‚€ = 4, and 50% of the population is immune, will an outbreak occur?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Calculate Râ‚‘:</strong></p>
                            <p>Râ‚‘ = Râ‚€ Ã— (Fraction Susceptible)</p>
                            <p>If 50% are immune, then 50% (0.5) are susceptible.</p>
                            <p>Râ‚‘ = 4 Ã— 0.5 = 2</p>
                            <p><strong>Answer: YES</strong></p>
                            <p>Since Râ‚‘ (2) is still > 1, the outbreak will continue to spread, just slower than before.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Râ‚€:</strong> Transmission potential in a totally susceptible population.</li>
                <li><strong>HIT = 1 - (1/Râ‚€):</strong> Target for vaccination programs.</li>
                <li>Higher Râ‚€ = Higher vaccination coverage needed.</li>
            </ul>

            <h2>18.5 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Râ‚€:</strong> Average secondary cases in a SUSCEPTIBLE population.</li>
                        <li><strong>HIT Formula:</strong> 1 - (1/Râ‚€). Memorize this!</li>
                        <li><strong>Râ‚€ Variability:</strong> It is NOT a constant; it changes with behavior (distancing).</li>
                    </ul>
                </div>
            </div>
`
    },
    ch19: {
        title: "Chapter 19: Advanced Evaluation",
        difficulty: "A",
        content: `
    <h1>Chapter 19: Advanced Evaluation</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 1px solid #ca8a04; opacity: 0.3;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 2px solid #c2410c; font-weight: bold; box-shadow: 0 2px 4px rgba(194, 65, 12, 0.2); opacity: 1;">Advanced</span>
                </div>
            </div>

            <p class="lead">Just because you have data doesn't mean it's good. Advanced epidemiology involves evaluating the quality of your study. Is it valid? Is it biased? Does it prove causation?</p>

            <h2>19.1 Validity</h2>
            <ul>
                <li><strong>Internal Validity:</strong> Did the study measure what it intended to measure <em>for the study population</em>? (Was the math right? Was the design sound?)</li>
                <li><strong>External Validity (Generalizability):</strong> Can the results be applied to the <em>general population</em>? (e.g., A study on only men might not apply to women).</li>
            </ul>
            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Temporality
                </div>
                <div class="callout-content">
                    <p><strong>Temporality</strong> is the ONLY essential criterion.</p>
                    <p><strong>The Cause MUST precede the Effect.</strong></p>
                    <p>If the exposure happened <em>after</em> the disease, it cannot be the cause. All other criteria can be weak, but this one must be true.</p>
                </div>
            </div>

            <div class="neo-card" style="margin: 2rem 0;">
                <h3 style="margin-top:0; color:var(--navy-primary);">Selection Bias: Who is in your study?</h3>
                <p>Selection bias occurs when the people <em>in</em> your study are different from the people <em>not</em> in your study.</p>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #fafafa; border-left: 3px solid #ef4444;">
                        <strong>Healthy Worker Effect:</strong> Workers are generally healthier than the general population (because the sick can't work). Comparing workers to the general public masks occupational risks.
                    </li>
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #fafafa; border-left: 3px solid #ef4444;">
                        <strong>Volunteer Bias:</strong> People who volunteer for studies are often healthier/more health-conscious than those who don't.
                    </li>
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #fafafa; border-left: 3px solid #ef4444;">
                        <strong>Non-Response Bias:</strong> If 50% of people refuse to participate, they might be different (e.g., more sick, too busy) than those who said yes.
                    </li>
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #fafafa; border-left: 3px solid #ef4444;">
                        <strong>Exclusion Bias:</strong> Applying different eligibility rules to cases vs controls.
                    </li>
                </ul>
            </div>

            <h2>19.2 The Criteria for Causation</h2>
            <p>How do we know if an association is actually Causal? We use the <strong>Bradford Hill Criteria</strong>.</p>
            <div class="neo-card" style="margin: 2rem 0; background: #f8fafc;">
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #e2e8f0;"><strong>1. Temporality (Essential):</strong> Cause must come before Effect.</li>
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #e2e8f0;"><strong>2. Strength:</strong> A large RR or OR (e.g., RR=20 for smoking and lung cancer) suggests causality.</li>
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #e2e8f0;"><strong>3. Dose-Response:</strong> More exposure = More disease.</li>
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #e2e8f0;"><strong>4. Consistency:</strong> Different studies, different times, same result.</li>
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #e2e8f0;"><strong>5. Biological Plausibility:</strong> Does it make sense biologically?</li>
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #e2e8f0;"><strong>6. Specificity:</strong> One cause leads to one effect (Weakest criterion, often not true).</li>
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #e2e8f0;"><strong>7. Coherence:</strong> Doesn't contradict known science.</li>
                    <li style="margin-bottom: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #e2e8f0;"><strong>8. Experiment:</strong> Removal of the exposure reduces the disease.</li>
                    <li style="padding: 0.5rem;"><strong>9. Analogy:</strong> Similar to other known associations.</li>
                </ul>
            </div>

            <h2>19.3 Advanced Analytics (National Level)</h2>
            <div class="callout-header" style="background: var(--gold-accent); color: var(--navy-primary);">
                <i class="ph ph-star"></i> National Level Concept
            </div>

            <div style="margin: 1.5rem 0;">
                <h3 style="color: var(--teal-accent);">1. Survival Analysis</h3>
                <p>Used when time-to-event is the outcome. Covers <strong>Kaplan-Meier Curves</strong> and <strong>Cox Proportional Hazards</strong>.</p>
                <div style="background: white; padding: 1rem; border: 1px solid #eee; border-radius: 8px;">
                    <p><strong>Censoring:</strong> When a subject leaves the study (or the study ends) before the event happens. We don't know if they <em>ever</em> got sick, only that they were healthy <em>until</em> the end.</p>
                    <p><strong>Kaplan-Meier Curve:</strong> A "step-down" graph showing the % of people still surviving over time. Each step down is an event (death).</p>
                </div>
            </div>

            <div style="margin: 1.5rem 0;">
                <h3 style="color: var(--teal-accent);">2. Meta-Analysis & Forest Plots</h3>
                <p>A "study of studies". Combines data from multiple similar studies to get a statistically stronger result.</p>
                <div class="neo-card small" style="display: flex; gap: 1rem; align-items: center;">
                    <div style="flex: 1;">
                        <p><strong>The Forest Plot:</strong></p>
                        <ul>
                            <li><strong>Squares:</strong> Individual study results (Size = Weight/Sample Size).</li>
                            <li><strong>Horizontal Lines:</strong> Confidence Intervals for each study.</li>
                            <li><strong>Diamond (at bottom):</strong> The pooled (combined) result.</li>
                            <li><strong>Vertical Line (at 1):</strong> Line of No Effect. If the Diamond touches this, result is not significant.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <h2>19.4 Advanced Biases (National Level)</h2>
            <p>Beyond Selection and Recall bias, National exams test these specific, nuanced biases:</p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 2rem 0;">
                <div style="border: 1px solid #ddd; padding: 1rem; border-radius: 8px;">
                    <h4 style="color: var(--navy-primary); margin-top: 0;">Berkson's Bias</h4>
                    <p><strong>Type:</strong> Selection Bias (Hospital-based).</p>
                    <p><strong>Definition:</strong> Hospital patients are more likely to have multiple diseases than the general public. This creates a false association between two diseases.</p>
                </div>
                <div style="border: 1px solid #ddd; padding: 1rem; border-radius: 8px;">
                    <h4 style="color: var(--navy-primary); margin-top: 0;">Neyman Bias</h4>
                    <p><strong>Type:</strong> Selection Bias (Prevalence-Incidence).</p>
                    <p><strong>Definition:</strong> If a disease kills quickly (high mortality), a study will miss the severe cases and only see the survivors (mild cases). This skews the data.</p>
                </div>
                <div style="border: 1px solid #ddd; padding: 1rem; border-radius: 8px;">
                    <h4 style="color: var(--navy-primary); margin-top: 0;">Hawthorne Effect</h4>
                    <p><strong>Type:</strong> Measurement Bias.</p>
                    <p><strong>Definition:</strong> People change their behavior just because they know they are being watched.</p>
                </div>
                <div style="border: 1px solid #ddd; padding: 1rem; border-radius: 8px;">
                    <h4 style="color: var(--navy-primary); margin-top: 0;">Ecological Fallacy</h4>
                    <p><strong>Type:</strong> Interpretation Error.</p>
                    <p><strong>Definition:</strong> Assuming that a group-level correlation applies to individuals. (e.g., "Rich countries eat more fat and have more cancer" does NOT prove "Eating fat causes cancer").</p>
                </div>
            </div>

            <!-- Confounding Triangle Visual -->
            <div style="background: white; padding: 2rem; border: 2px solid var(--navy-primary); border-radius: 12px; margin: 2rem 0; text-align: center;">
                <h3 style="margin-top: 0; color: var(--navy-primary);">Visualizing Confounding</h3>
                <p>The "Third Variable" Problem</p>
                <svg width="500" height="300" viewBox="0 0 500 300" class="responsive-svg" style="max-width: 100%; height: auto; margin: 1rem auto;">
                    <defs>
                        <marker id="arrowhead-conf" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
                        </marker>
                    </defs>

                    <!-- Nodes -->
                    <g transform="translate(100, 250)">
                        <circle cx="0" cy="0" r="42" fill="#e0f2f1" stroke="#004d40" stroke-width="4"/>
                        <text x="0" y="5" text-anchor="middle" font-weight="900" fill="#004d40" font-size="14" style="text-transform:uppercase;">Exposure</text>
                        <text x="0" y="24" text-anchor="middle" font-size="11" font-weight="bold" fill="#004d40">(Coffee)</text>
                    </g>

                    <g transform="translate(400, 250)">
                         <circle cx="0" cy="0" r="42" fill="#ffebee" stroke="#b71c1c" stroke-width="4"/>
                         <text x="0" y="5" text-anchor="middle" font-weight="900" fill="#b71c1c" font-size="14" style="text-transform:uppercase;">Disease</text>
                         <text x="0" y="24" text-anchor="middle" font-size="11" font-weight="bold" fill="#b71c1c">(Heart Attack)</text>
                    </g>

                    <g transform="translate(250, 80)">
                         <circle cx="0" cy="0" r="52" fill="#fff3e0" stroke="#e65100" stroke-width="4"/>
                         <text x="0" y="-5" text-anchor="middle" font-weight="900" fill="#e65100" font-size="16" style="text-transform:uppercase;">Confounder</text>
                         <text x="0" y="20" text-anchor="middle" font-size="13" font-weight="bold" fill="#e65100">(Smoking)</text>
                    </g>

                    <!-- Arrows -->
                    <!-- Exp -> Disease (The apparent relationship) -->
                    <path d="M145,250 L355,250" fill="none" stroke="#333" stroke-width="3" stroke-dasharray="8,5" marker-end="url(#arrowhead-conf)"/>
                    <text x="250" y="275" text-anchor="middle" fill="#555" font-weight="bold" font-style="italic">Apparent Association?</text>

                    <!-- Confounder -> Exp -->
                    <path d="M220,110 L130,220" fill="none" stroke="#e65100" stroke-width="3" marker-end="url(#arrowhead-conf)"/>
                     <text x="135" y="145" text-anchor="middle" fill="#e65100" font-size="12" font-weight="bold" transform="rotate(-45 140,150)">Associated with Exp</text>

                    <!-- Confounder -> Disease -->
                    <path d="M280,110 L370,220" fill="none" stroke="#e65100" stroke-width="3" marker-end="url(#arrowhead-conf)"/>
                    <text x="365" y="145" text-anchor="middle" fill="#e65100" font-size="12" font-weight="bold" transform="rotate(45 360,150)">Risk Factor for Dis</text>
                </svg>
                <div style="text-align: left; background: #fafafa; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <p><strong>The Logic:</strong></p>
                    <ul>
                        <li>Does Coffee cause Heart Attacks? Maybe.</li>
                        <li><strong>BUT:</strong> Coffee drinkers are also more likely to <strong>Smoke</strong> (Confounder).</li>
                        <li><strong>AND:</strong> Smoking causes Heart Attacks.</li>
                        <li>Therefore, the Coffee-Heart Attack link might be fake. Smoking is the real culprit!</li>
                    </ul>
                </div>
            </div>

            <h2>19.3 Evaluation Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Name That Bias
                </div>
                <div class="callout-content">
                    <p><strong>Scenario 1:</strong> You study the health of factory workers. You find they are healthier than the general population.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Healthy Worker Effect (Selection Bias)</strong></p>
                            <p>To be a worker, you have to be healthy enough to work. The severely ill are not in the workforce, so comparing workers to the general public (which includes the sick) is biased.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 2:</strong> In a study on alcohol and heart disease, you don't account for smoking.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Confounding</strong></p>
                            <p>Smoking is associated with alcohol use AND heart disease. It confuses the result.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Scenario 3:</strong> Mothers of children with birth defects try very hard to remember every medicine they took, while other mothers don't.</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Recall Bias (Information Bias)</strong></p>
                            <p>The "Cases" have a different memory accuracy than the "Controls".</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Internal Validity:</strong> Study is done right.</li>
                <li><strong>External Validity:</strong> Applies to real world.</li>
                <li><strong>Temporality:</strong> Cause comes before Effect.</li>
            </ul>

            <h2>19.5 Exam Focus & Tips</h2>
            <div class="exam-trap">
                <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                <div class="callout-content">
                    <ul>
                        <li><strong>Internal Validity:</strong> The study was done correctly (no bias/confounding).</li>
                        <li><strong>External Validity:</strong> The results apply to the real world.</li>
                        <li><strong>Temporality:</strong> The ONLY essential criterion for causation (Cause -> Effect).</li>
                    </ul>
                </div>
            </div>
`
    },
    ch20: {
        title: "Chapter 20: Integrative Case Studies",
        difficulty: "A",
        content: `
    <h1>Chapter 20: Integrative Case Studies</h1>
            <!-- Difficulty Scale -->
            <div class="difficulty-scale-box" style="border: 2px solid #333; padding: 1rem; margin: 1rem 0; background: #fafafa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; color: #555;">Target Audience</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="neo-badge" style="background: #f0fdf4; color: #15803d; border: 1px solid #166534; opacity: 0.3;">Beginner</span>
                    <span class="neo-badge" style="background: #fefce8; color: #a16207; border: 1px solid #ca8a04; opacity: 0.3;">Middle</span>
                    <span class="neo-badge" style="background: #fff7ed; color: #c2410c; border: 2px solid #c2410c; font-weight: bold; box-shadow: 0 2px 4px rgba(194, 65, 12, 0.2); opacity: 1;">Advanced</span>
                </div>
            </div>

            <p class="lead">This is the final test. In a real outbreak (and on the exam), you won't get questions in order. You'll get a mess of data and have to make sense of it.</p>

            <h2>20.1 Case Study 1: The Church Picnic</h2>
            <p><strong>Scenario:</strong> 50 people attended a picnic. 20 got sick with vomiting and diarrhea 4 hours later.</p>
            <ul>
                <li><strong>Step 1 (Verify):</strong> Is it an outbreak? Yes (20 cases > expected).</li>
                <li><strong>Step 2 (Case Def):</strong> Person at picnic + Vomiting/Diarrhea + Onset within 6 hours.</li>
                <li><strong>Step 3 (Epi Curve):</strong> Point Source (everyone ate at the same time).</li>
                <li><strong>Step 4 (Agent):</strong> Incubation 4 hours + Symptoms = Likely <em>Staph aureus</em> (toxin).</li>
                <li><strong>Step 5 (Action):</strong> Educate food handlers on temperature control.</li>
            </ul>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Red Herrings
                </div>
                <div class="callout-content">
                    <p><strong>Red Herring:</strong> A piece of information intended to distract you.</p>
                    <p><strong>Example:</strong> "The water fountain was broken." (If everyone drank soda, this doesn't matter!). Focus on the data, not the noise.</p>
                </div>
            </div>

            <h2>20.2 Case Study 2: The Mystery Fever</h2>
            <p><strong>Scenario:</strong> Hikers in Connecticut developing bullseye rashes and joint pain in July.</p>
            <ul>
                <li><strong>Step 1 (Verify):</strong> Verify diagnosis (Lyme disease?).</li>
                <li><strong>Step 2 (Person/Place/Time):</strong> Hikers (Person), Woods (Place), Summer (Time).</li>
                <li><strong>Step 3 (Transmission):</strong> Vector-borne (Ticks).</li>
                <li><strong>Step 4 (Prevention):</strong> Secondary (Check for ticks), Primary (Wear long pants/DEET).</li>
            </ul>

            <h2>20.3 Case Study 3: The National Nightmare (Advanced)</h2>
            <div class="neo-card small" style="border: 2px solid var(--accent-orange);">
                <h3><i class="ph-bold ph-skull"></i> Stratified Analysis Required!</h3>
                <p><strong>Scenario:</strong> A study links Coffee to Pancreatic Cancer (OR = 3.0).</p>
                <p><strong>The Twist:</strong> Coffee drinkers also smoke more. Smoking causes cancer.</p>
                <p><strong>Stratification:</strong> Split data into Smokers vs Non-Smokers.</p>
                <ul>
                    <li><strong>Smokers Only:</strong> Coffee OR = 1.0 (No association).</li>
                    <li><strong>Non-Smokers Only:</strong> Coffee OR = 1.0 (No association).</li>
                </ul>
                <p><strong>Conclusion:</strong> Use the <strong>Adusted OR</strong> (1.0). The crude OR (3.0) was due to <strong>Confounding</strong> by smoking.</p>
            </div>

            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: The "Red Herring"
                </div>
                <div class="callout-content">
                    <p>Exam writers love to give you useless data.</p>
                    <p><em>Example:</em> "The patient ate chicken, beef, and salad. They also have a new puppy."</p>
                    <p>If the symptoms are respiratory (coughing), the food doesn't matter! Focus on the puppy (Zoonotic?). <strong>Filter the noise.</strong></p>
                </div>
            </div>

            <h2>20.4 Synthesis Drill</h2>

            <div class="drill-box">
                <div class="callout-header">
                    <i class="ph ph-calculator"></i>
                    Solve the Outbreak
                </div>
                <div class="callout-content">
                    <p><strong>Data:</strong></p>
                    <ul>
                        <li><strong>Symptoms:</strong> Bloody diarrhea, kidney failure.</li>
                        <li><strong>Exposure:</strong> County Fair petting zoo.</li>
                        <li><strong>Incubation:</strong> 3-4 days.</li>
                    </ul>

                    <p style="margin-top: 1rem;"><strong>Question 1:</strong> What is the likely agent?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: E. coli O157:H7</strong></p>
                            <p>Bloody diarrhea + Kidney Failure (HUS) + Petting Zoo = Classic E. coli.</p>
                        </div>
                    </div>

                    <h2>20.4 Exam Focus & Tips</h2>
                    <div class="exam-trap">
                        <div class="callout-header"><i class="ph ph-lightning"></i> High Yield Topics</div>
                        <div class="callout-content">
                            <ul>
                                <li><strong>Red Herrings:</strong> Ignore information that doesn't fit the clinical picture.</li>
                                <li><strong>Synthesis:</strong> Combine Incubation Period + Symptoms + Exposure to find the agent.</li>
                                <li><strong>Speed:</strong> Don't get stuck on one detail; look at the whole picture.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: E. coli O157:H7</strong></p>
                            <p>Bloody diarrhea + Kidney failure (HUS) + Animals = Classic E. coli.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Question 2:</strong> What is the Mode of Transmission?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Direct Contact (Zoonotic) or Indirect (Fecal-Oral)</strong></p>
                            <p>Touching animals or contaminated railings, then touching mouth.</p>
                        </div>
                    </div>

                    <p style="margin-top: 1rem;"><strong>Question 3:</strong> What is the best control measure?</p>
                    <div class="accordion">
                        <div class="accordion-header">Show Answer</div>
                        <div class="accordion-content">
                            <p><strong>Answer: Handwashing Stations</strong></p>
                            <p>Engineering control (installing sinks) + Administrative (signage).</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2>20.5 Advanced Analysis & Statistical Methods</h2>
            <p>Interpretation of observational data often requires analytic techniques beyond simple attack rate calculations. For highâ€‘level competitions, you must understand:</p>
            <ul>
                <li><strong>Confounding:</strong> When a third factor distorts the apparent association between an exposure and an outcome. Control it through restriction, matching, or adjustment.</li>
                <li><strong>Effect modification:</strong> When the strength or direction of an association differs across levels of a third variable. Report interaction terms explicitly.</li>
                <li><strong>Logistic regression:</strong> A multivariate model that estimates odds ratios while adjusting for multiple covariates simultaneously. The coefficient exponentials (<em>e</em><sup>&beta;</sup>) represent adjusted odds ratios.</li>
                <li><strong>Model checking:</strong> Assess goodness of fit with residuals and calibration plots; avoid overfitting by limiting the number of predictors relative to the number of events.</li>
            </ul>
            <div class="champion-concept">
                <div class="callout-header">
                    <i class="ph ph-trophy"></i>
                    Champion Concept: Controlling Confounding
                </div>
                <div class="callout-content">
                    <p><strong>Tip:</strong> After stratifying by a potential confounder, compare stratumâ€‘specific estimates to the crude estimate.</p>
                    <p>If they differ materially, confounding is present. Use Mantelâ€“Haenszel or regression models to compute adjusted measures.</p>
                </div>
            </div>

            <div class="exam-trap">
                <div class="callout-header">
                    <i class="ph ph-warning"></i>
                    Exam Trap: Misreading Regression
                </div>
                <div class="callout-content">
                    <p><strong>TRAP:</strong> Logistic regression output reports <em>odds ratios</em>, not relative risks. When the outcome is common (>10%), odds ratios will overestimate risk ratios.</p>
                    <p><strong>TIP:</strong> Always report confidence intervals and pâ€‘values. Check whether covariates are confounders or effect modifiers. Use adjusted odds ratios (<em>e</em><sup>Î²</sup>) only after controlling for all relevant variables.</p>
                </div>
            </div>

            <h2>Summary</h2>
            <ul>
                <li><strong>Synthesize:</strong> Combine symptoms, timing, and exposure.</li>
                <li><strong>Filter:</strong> Ignore irrelevant data.</li>
                <li><strong>Apply:</strong> Use the 13 Steps.</li>
            </ul>
`
    },

    // OFFICIAL RULES 2026
    rules_2026: {
        title: "Official Rules (2026)",
        difficulty: "Ref",
        content: `
    <h1>Official 2026 Division B Rules</h1>
            <span class="difficulty-badge difficulty-advanced">Must Know</span>
            <p class="lead">Critical updates for the 2026 season. These rules for Symptom Interpretation and Elimination are high-yield for the exam.</p>

            <h2>1. High-Level Rules for Symptom Interpretation</h2>
            <div class="grid-2">
                <div class="callout study-tip">
                    <div class="callout-header"><i class="ph ph-check-circle"></i> Rule 1: Symptoms + Timing</div>
                    <div class="callout-content">
                        <p><strong>Formula:</strong> Symptoms + Incubation Period = Narrow down agent.</p>
                        <p><em>Example:</em> Vomiting within 2 hours? Preformed toxin (Staph/Bacillus).</p>
                    </div>
                </div>
                <div class="callout study-tip">
                    <div class="callout-header"><i class="ph ph-check-circle"></i> Rule 2: Curve Shape</div>
                    <div class="callout-content">
                        <p><strong>Formula:</strong> Curve Shape = Detect exposure type.</p>
                        <p><em>Example:</em> Sharp rise and fall? Point Source.</p>
                    </div>
                </div>
                <div class="callout study-tip">
                    <div class="callout-header"><i class="ph ph-check-circle"></i> Rule 3: Maps</div>
                    <div class="callout-content">
                        <p><strong>Formula:</strong> Spot Map = Find exposure location.</p>
                        <p><em>Example:</em> Clusters around a water tower? Legionella.</p>
                    </div>
                </div>
                <div class="callout study-tip">
                    <div class="callout-header"><i class="ph ph-check-circle"></i> Rule 4: Attack Rates</div>
                    <div class="callout-content">
                        <p><strong>Formula:</strong> High AR in exposed vs. Low AR in unexposed = Confirm hypothesis.</p>
                    </div>
                </div>
            </div>

            <h2>2. High-Yield Elimination Rules</h2>
            <p>Use these rules to eliminate false leads quickly (eliminates 80% of distractors).</p>
            <ul class="feature-list">
                <li><i class="ph ph-x-circle" style="color: var(--danger);"></i> <strong>Rule 1:</strong> If many sick students did NOT eat a food &rarr; <strong>NOT the cause.</strong></li>
                <li><i class="ph ph-x-circle" style="color: var(--danger);"></i> <strong>Rule 2:</strong> If many healthy students DID eat a food &rarr; <strong>NOT the cause.</strong></li>
                <li><i class="ph ph-x-circle" style="color: var(--danger);"></i> <strong>Rule 3:</strong> If onset time is too short/long for the agent &rarr; <strong>NOT the cause.</strong></li>
                <li><i class="ph ph-x-circle" style="color: var(--danger);"></i> <strong>Rule 4:</strong> If symptoms don't match (e.g., respiratory symptoms for a foodborne pathogen) &rarr; <strong>NOT the cause.</strong></li>
                <li><i class="ph ph-x-circle" style="color: var(--danger);"></i> <strong>Rule 5:</strong> If the Epi Curve shape doesn't match the exposure type &rarr; <strong>NOT the cause.</strong></li>
            </ul>

            <h2>3. Integration Example</h2>
            <div class="champion-concept">
                <div class="callout-header"><i class="ph ph-trophy"></i> Scenario: School Banquet</div>
                <div class="callout-content">
                    <p><strong>Data:</strong> Vomiting 6-10 hours after eating.</p>
                    <p><strong>Analysis:</strong></p>
                    <ul>
                        <li><strong>Symptom:</strong> Vomiting (Upper GI) &rarr; Likely Toxin.</li>
                        <li><strong>Timing:</strong> 6-10 hours &rarr; Too slow for Staph (2-4 hrs), perfect for <em>B. cereus</em> or <em>C. perfringens</em>.</li>
                        <li><strong>Elimination:</strong> Eliminate Salmonella (12-72 hrs incubation).</li>
                    </ul>
                </div>
            </div>
    `
    },

    // TOOLS & DRILLS
    drills: {
        title: "Interactive Drills & Tools",
        difficulty: "Tool",
        content: `
    <h1>Interactive Drills & Tools</h1>
            <p class="lead">Master the math and logic of epidemiology with these interactive calculators.</p>

            <div class="tool-tabs">
                <button class="tool-tab active" data-tool="2x2">
                    <i class="ph ph-calculator"></i> 2x2 Calculator
                </button>
                <button class="tool-tab" data-tool="curve">
                    <i class="ph ph-chart-bar"></i> Epi Curve
                </button>
                <button class="tool-tab" data-tool="exposure">
                    <i class="ph ph-clock-counter-clockwise"></i> Exposure Window
                </button>
                <button class="tool-tab" data-tool="notesheet">
                    <i class="ph ph-file-text"></i> Notesheet
                </button>
                <button class="tool-tab" data-tool="proctor">
                    <i class="ph ph-timer"></i> Proctor Timer
                </button>
                <button class="tool-tab" data-tool="drills">
                    <i class="ph ph-lightning"></i> Flash Drills
                </button>
            </div>

            <div class="tool-container">
                <!-- 2x2 Calculator -->
                <div id="tool-container-2x2" class="tool-content active">
                    <!-- Injected by calculator-2x2.js -->
                </div>

                <!-- Epi Curve Generator -->
                <div id="tool-container-curve" class="tool-content">
                    <!-- Injected by epi-curve.js -->
                </div>

                <!-- Exposure Window Calculator -->
                <div id="tool-container-exposure" class="tool-content">
                    <!-- Injected by exposure-calculator.js -->
                </div>

                <!-- Notesheet Generator -->
                <div id="tool-container-notesheet" class="tool-content">
                    <!-- Injected by notesheet-generator.js -->
                </div>

                <!-- Proctor Timer -->
                <div id="tool-container-proctor" class="tool-content">
                    <!-- Injected by proctor-tools.js -->
                </div>

                <!-- Flash Drills -->
                <div id="tool-container-drills" class="tool-content">
                    <!-- Injected by flash-drills.js -->
                </div>
            </div>

            <script>
                // Trigger initialization when this content loads
                if (typeof onToolsChapterLoaded === 'function') {
                    onToolsChapterLoaded();
                }
            <\/script>
`
    },

    // QUIZZES

    'quiz-part1': {
        title: "Part I Quiz: Foundation & Surveillance",
        difficulty: "Quiz",
        content: `
    <h1>Part I Comprehensive Quiz</h1>
            <p class="lead">Test your knowledge of Chapters 1-6. This quiz contains questions covering the basics of epidemiology, surveillance, and patterns.</p>
            
            <div id="quiz-container-part1" class="quiz-container">
                <div class="text-center">
                    <div style="margin-bottom: 1rem;">
                        <label for="difficulty-part1" style="font-weight: bold; margin-right: 0.5rem;">Difficulty:</label>
                        <select id="difficulty-part1" class="neo-select" style="padding: 0.5rem;">
                            <option value="balanced">Balanced (Mix)</option>
                            <option value="beginner">Beginner Only</option>
                            <option value="intermediate">Intermediate Only</option>
                            <option value="advanced">Advanced Only</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="startQuiz('part1')">Start Quiz</button>
                </div>
            </div>
`
    },
    'quiz-part2': {
        title: "Part II Quiz: Investigation & Analysis",
        difficulty: "Quiz",
        content: `
    <h1>Part II Comprehensive Quiz</h1>
            <p class="lead">Test your knowledge of Chapters 7-13. This quiz covers outbreak investigation steps, study design, and statistical analysis.</p>
            
            <div id="quiz-container-part2" class="quiz-container">
                <div class="text-center">
                    <div style="margin-bottom: 1rem;">
                        <label for="difficulty-part2" style="font-weight: bold; margin-right: 0.5rem;">Difficulty:</label>
                        <select id="difficulty-part2" class="neo-select" style="padding: 0.5rem;">
                            <option value="balanced">Balanced (Mix)</option>
                            <option value="beginner">Beginner Only</option>
                            <option value="intermediate">Intermediate Only</option>
                            <option value="advanced">Advanced Only</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="startQuiz('part2')">Start Quiz</button>
                </div>
            </div>
`
    },
    'quiz-part3': {
        title: "Part III Quiz: Control & Prevention",
        difficulty: "Quiz",
        content: `
    <h1>Part III Comprehensive Quiz</h1>
            <p class="lead">Test your knowledge of Chapters 14-20. This quiz covers control measures, ethics, and advanced evaluation.</p>
            
            <div id="quiz-container-part3" class="quiz-container">
                <div class="text-center">
                    <div style="margin-bottom: 1rem;">
                        <label for="difficulty-part3" style="font-weight: bold; margin-right: 0.5rem;">Difficulty:</label>
                        <select id="difficulty-part3" class="neo-select" style="padding: 0.5rem;">
                            <option value="balanced">Balanced (Mix)</option>
                            <option value="beginner">Beginner Only</option>
                            <option value="intermediate">Intermediate Only</option>
                            <option value="advanced">Advanced Only</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="startQuiz('part3')">Start Quiz</button>
                </div>
            </div>
`
    },

    // SIMULATION
    simulation: {
        title: "Simulation Exams",
        difficulty: "Exam",
        content: `
    <h1>Disease Detectives Simulation Exam</h1>
            <p class="lead">A full 50-minute, 50-question simulated competition exam. Questions are drawn randomly from all topics and difficulties to mimic a real test environment.</p>
            
            <div class="exam-intro">
                <div class="callout study-tip">
                    <div class="callout-header"><i class="ph ph-clock"></i> Exam Rules</div>
                    <div class="callout-content">
                        <ul>
                            <li><strong>Time Limit:</strong> 50 Minutes</li>
                            <li><strong>Questions:</strong> 50 Multiple Choice</li>
                            <li><strong>Scoring:</strong> +2 for Correct, 0 for Incorrect (No penalty)</li>
                            <li><strong>Topics:</strong> All Parts (I, II, III)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="exam-container" class="exam-container" style="margin-top: 2rem;">
                <p>Select one of the four practice exams below. Each exam consists of 50 timed questions drawn from across the curriculum.</p>
                <div style="margin-bottom: 2rem; display: flex; justify-content: center; align-items: center; gap: 1rem;">
                     <label for="difficulty-sim" style="font-weight: bold;">Difficulty Mix:</label>
                     <select id="difficulty-sim" class="neo-select" style="padding: 0.5rem; width: 200px;">
                        <option value="balanced" selected>National (Balanced)</option>
                        <option value="beginner">Regionals (Easier)</option>
                        <option value="advanced">Nationals Finals (Hard)</option>
                     </select>
                </div>
                <div class="simulation-grid" style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
                    <button class="btn btn-primary btn-lg" onclick="startSimulationExam(1)">
                        <i class="ph ph-play-circle"></i> Exam&nbsp;1
                    </button>
                    <button class="btn btn-primary btn-lg" onclick="startSimulationExam(2)">
                        <i class="ph ph-play-circle"></i> Exam&nbsp;2
                    </button>
                    <button class="btn btn-primary btn-lg" onclick="startSimulationExam(3)">
                        <i class="ph ph-play-circle"></i> Exam&nbsp;3
                    </button>
                    <button class="btn btn-primary btn-lg" onclick="startSimulationExam(4)">
                        <i class="ph ph-play-circle"></i> Exam&nbsp;4
                    </button>
                </div>
            </div>
`
    },

    // APPENDICES
    'appendix-a': {
        title: "Appendix A: Cheat Sheet",
        difficulty: "Ref",
        content: `
    <h1>Appendix A: The Ultimate Cheat Sheet</h1>
            <p class="lead">A condensed summary of the most critical formulas and lists for the exam.</p>

            <h2>1. The 13 Steps of Outbreak Investigation</h2>
            <p><strong>Mnemonic: "Please Verify Cases Find Description Hypotheses Evaluate Review Compare Implement Monitor Communicate"</strong></p>
            <ol class="two-column-list">
                <li><strong>P</strong>repare for field work</li>
                <li><strong>V</strong>erify outbreak existence</li>
                <li><strong>V</strong>erify diagnosis</li>
                <li><strong>C</strong>ase definition (Confirmed/Probable/Possible)</li>
                <li><strong>F</strong>ind cases systematically (line listing)</li>
                <li><strong>D</strong>escribe epidemic (time/place/person)</li>
                <li><strong>D</strong>evelop hypotheses (agent/host/environment)</li>
                <li><strong>E</strong>valuate hypotheses (analytical epi)</li>
                <li><strong>R</strong>e-evaluate as needed</li>
                <li><strong>C</strong>ompare with lab/environmental studies</li>
                <li><strong>I</strong>mplement control measures (ASAP!)</li>
                <li><strong>M</strong>aintain surveillance</li>
                <li><strong>C</strong>ommunicate findings</li>
            </ol>

            <!-- Advanced concept: Causation criteria -->
            <h2>Advanced: Hill's Criteria for Causation</h2>
            <ul>
                <li><strong>Strength:</strong> High RR or OR.</li>
                <li><strong>Consistency:</strong> Repeated by others.</li>
                <li><strong>Specificity:</strong> One cause, one effect.</li>
                <li><strong>Temporality:</strong> Cause precedes effect (Essential!).</li>
                <li><strong>Biological Gradient:</strong> Dose-response.</li>
                <li><strong>Plausibility:</strong> Makes biological sense.</li>
                <li><strong>Coherence:</strong> Fits with known facts.</li>
                <li><strong>Experiment:</strong> Intervention works.</li>
                <li><strong>Analogy:</strong> Similar to other known associations.</li>
            </ul>
`
    },
    'appendix-b': {
        title: "Appendix B: Formulas",
        difficulty: "Ref",
        content: `
            <h1>Appendix B: Essential Formulas</h1>

            <!-- Study priority guidance for formulas -->
            <p class="lead" style="margin-top: 1rem;">
                Focus your study on the first six formulas belowâ€”<strong>Attack Rate</strong>, <strong>Relative Risk</strong>, <strong>Odds Ratio</strong>,
                <strong>Attributable Risk</strong>, <strong>Attributable Risk&nbsp;%</strong> and <strong>Vaccine Efficacy</strong>â€”as these measures are most
                commonly tested in Division&nbsp;B competition. Measures like Sensitivity, Specificity and Predictive Values are also important
                but can be considered secondary. Any remaining or more complex measures may be treated as advanced topics.
            </p>
            <div class="formula-grid">
                <div class="formula-card">
                    <h3>Attack Rate (Risk)</h3>
                    <div class="formula-body">
                        <div class="fraction">
                            <span class="numerator">Ill</span>
                            <span class="denominator">Total in Group</span>
                        </div>
                        &times; 100
                    </div>
                    <p class="formula-desc">Percentage of a group that becomes ill.</p>
                </div>

                <div class="formula-card">
                    <h3>Relative Risk (RR)</h3>
                    <div class="formula-body">
                        <div class="fraction">
                            <span class="numerator">Incidence in Exposed</span>
                            <span class="denominator">Incidence in Unexposed</span>
                        </div>
                        =
                        <div class="fraction">
                            <span class="numerator">a / (a + b)</span>
                            <span class="denominator">c / (c + d)</span>
                        </div>
                    </div>
                    <p class="formula-desc">Used for Cohort Studies. Measures how much more likely exposed are to get sick.</p>
                </div>

                <div class="formula-card">
                    <h3>Odds Ratio (OR)</h3>
                    <div class="formula-body">
                        <div class="fraction">
                            <span class="numerator">a &times; d</span>
                            <span class="denominator">b &times; c</span>
                        </div>
                    </div>
                    <p class="formula-desc">Used for Case-Control Studies. Estimates RR when disease is rare.</p>
                </div>

                <div class="formula-card">
                    <h3>Attributable Risk (AR)</h3>
                    <div class="formula-body">
                        I<sub>exposed</sub> - I<sub>unexposed</sub>
                    </div>
                    <p class="formula-desc">The excess risk due to the exposure.</p>
                </div>

                <div class="formula-card">
                    <h3>Attributable Risk % (AR%)</h3>
                    <div class="formula-body">
                        <div class="fraction">
                            <span class="numerator">RR - 1</span>
                            <span class="denominator">RR</span>
                        </div>
                        &times; 100
                    </div>
                    <p class="formula-desc">Proportion of disease in exposed group due to exposure.</p>
                </div>

                <div class="formula-card">
                    <h3>Vaccine Efficacy (VE)</h3>
                    <div class="formula-body">
                        <div class="fraction">
                            <span class="numerator">AR<sub>unvax</sub> - AR<sub>vax</sub></span>
                            <span class="denominator">AR<sub>unvax</sub></span>
                        </div>
                        &times; 100
                    </div>
                    <p class="formula-desc">Percentage reduction in disease incidence in vaccinated group.</p>
                </div>

                <div class="formula-card">
                    <h3>Sensitivity</h3>
                    <div class="formula-body">
                        <div class="fraction">
                            <span class="numerator">True Positives (a)</span>
                            <span class="denominator">Total Sick (a + c)</span>
                        </div>
                    </div>
                    <p class="formula-desc">Ability to correctly identify those WITH the disease.</p>
                </div>

                <div class="formula-card">
                    <h3>Specificity</h3>
                    <div class="formula-body">
                        <div class="fraction">
                            <span class="numerator">True Negatives (d)</span>
                            <span class="denominator">Total Healthy (b + d)</span>
                        </div>
                    </div>
                    <p class="formula-desc">Ability to correctly identify those WITHOUT the disease.</p>
                </div>

                <div class="formula-card">
                    <h3>Positive Predictive Value (PPV)</h3>
                    <div class="formula-body">
                        <div class="fraction">
                            <span class="numerator">a</span>
                            <span class="denominator">a + b</span>
                        </div>
                    </div>
                    <p class="formula-desc">Probability that a positive test means you are sick.</p>
                </div>

                <div class="formula-card">
                    <h3>Negative Predictive Value (NPV)</h3>
                    <div class="formula-body">
                        <div class="fraction">
                <p class="lead">Test your recall of key terms and concepts.</p>
                <div id="flashcard-root"></div>
            </div >
    `
    },

    quiz_master: {
        title: "Master Quiz: Comprehensive Exam",
        content: `
            <div class="comprehensive-quiz-container">
                <h1>Master Quiz: Comprehensive Exam</h1>
                <p class="lead">The ultimate test. 100 questions covering the entire curriculum (Chapters 1-20).</p>
                <div class="neo-card" style="text-align: center; padding: 3rem;">
                    <i class="ph ph-trophy" style="font-size: 4rem; color: var(--accent-orange); margin-bottom: 1rem;"></i>
                    <h2>Ready to prove your mastery?</h2>
                    <p>This exam simulates the National competition experience.</p>
                    <button class="neo-btn" onclick="window.startQuiz('master')">Start Master Exam</button>
                </div>
                <div id="quiz-container-master"></div>
            </div>
        `
    },
    quiz_part1: {
        title: "Part I Quiz: Foundation & History",
        content: `
            <div class="comprehensive-quiz-container">
                <h1>Part I Quiz: Foundation, History & Surveillance</h1>
                <p class="lead">Test your knowledge of Chapters 1-6, plus Definitions & History.</p>
                
                <div class="neo-card" style="text-align: center; max-width: 600px; margin: 2rem auto; padding: 2rem;">
                    <i class="ph ph-sliders-horizontal" style="font-size: 3rem; color: var(--navy-primary); margin-bottom: 1rem;"></i>
                    <h3>Configure Quiz</h3>
                    <p>Select difficulty level:</p>
                    <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
                        <select id="difficulty-part1" class="neo-select" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; width: 200px;">
                            <option value="beginner">Beginner (Recall)</option>
                            <option value="intermediate">Intermediate (Application)</option>
                            <option value="advanced">Advanced (Analysis)</option>
                            <option value="balanced" selected>Balanced (Mixed)</option>
                        </select>
                    </div>
                    <button class="neo-btn" onclick="window.startQuiz('part1')">Start Quiz</button>
                </div>

                <div id="quiz-container-part1"></div>
            </div>
        `
    },
    quiz_part2: {
        title: "Part II Quiz: Investigation",
        content: `
            <div class="comprehensive-quiz-container">
                <h1>Part II Quiz: Investigation & Analysis</h1>
                <p class="lead">Test your knowledge of Chapters 7-13.</p>

                <div class="neo-card" style="text-align: center; max-width: 600px; margin: 2rem auto; padding: 2rem;">
                    <i class="ph ph-sliders-horizontal" style="font-size: 3rem; color: var(--navy-primary); margin-bottom: 1rem;"></i>
                    <h3>Configure Quiz</h3>
                    <p>Select difficulty level:</p>
                    <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
                        <select id="difficulty-part2" class="neo-select" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; width: 200px;">
                            <option value="beginner">Beginner (Recall)</option>
                            <option value="intermediate">Intermediate (Application)</option>
                            <option value="advanced">Advanced (Analysis)</option>
                            <option value="balanced" selected>Balanced (Mixed)</option>
                        </select>
                    </div>
                    <button class="neo-btn" onclick="window.startQuiz('part2')">Start Quiz</button>
                </div>

                <div id="quiz-container-part2"></div>
            </div>
        `
    },
    quiz_part3: {
        title: "Part III Quiz: Control",
        content: `
            <div class="comprehensive-quiz-container">
                <h1>Part III Quiz: Control & Prevention</h1>
                <p class="lead">Test your knowledge of Chapters 14-20.</p>

                <div class="neo-card" style="text-align: center; max-width: 600px; margin: 2rem auto; padding: 2rem;">
                    <i class="ph ph-sliders-horizontal" style="font-size: 3rem; color: var(--navy-primary); margin-bottom: 1rem;"></i>
                    <h3>Configure Quiz</h3>
                    <p>Select difficulty level:</p>
                    <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
                        <select id="difficulty-part3" class="neo-select" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; width: 200px;">
                            <option value="beginner">Beginner (Recall)</option>
                            <option value="intermediate">Intermediate (Application)</option>
                            <option value="advanced">Advanced (Analysis)</option>
                            <option value="balanced" selected>Balanced (Mixed)</option>
                        </select>
                    </div>
                    <button class="neo-btn" onclick="window.startQuiz('part3')">Start Quiz</button>
                </div>

                <div id="quiz-container-part3"></div>
            </div>
        `
    },
    simulation: {
        title: "Simulation Exams",
        content: `
            <div class="comprehensive-quiz-container">
                <h1>National Simulation Exams</h1>
                <p class="lead">Full-length, timed practice exams generated from our 300+ question bank.</p>
                <div id="exam-container"></div>
                <div style="text-align: center; margin-top: 2rem;">
                    <p>Select one of the four simulation exams:</p>
                    <div style="display:flex; justify-content:center; flex-wrap: wrap; gap: 1rem;">
                        <button class="neo-btn" onclick="window.startSimulationExam(1)">
                            <i class="ph-bold ph-play"></i> Exam&nbsp;1
                        </button>
                        <button class="neo-btn" onclick="window.startSimulationExam(2)">
                            <i class="ph-bold ph-play"></i> Exam&nbsp;2
                        </button>
                        <button class="neo-btn" onclick="window.startSimulationExam(3)">
                            <i class="ph-bold ph-play"></i> Exam&nbsp;3
                        </button>
                        <button class="neo-btn" onclick="window.startSimulationExam(4)">
                            <i class="ph-bold ph-play"></i> Exam&nbsp;4
                        </button>
                    </div>
                </div>
            </div>
        `
    },
    case_library: {
        title: "Disease Case Library",
        content: `
    <div class="neo-card">
                <h2>Disease Case Library</h2>
                <p>A collection of 40+ case studies with counterfactuals and spot maps.</p>
                <div id="case-library-container" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                    <!-- Cases will be rendered here -->
                </div>
            </div>
    `
    },
    interactive_scenarios: {
        title: "Interactive Scenarios",
        content: `
            <div id="interactive-cases-root" style="margin-top: 1rem;"></div>
        `
    },
    'appendix-g': {
        title: "Glossary",
        content: `
    <div class="comprehensive-quiz-container">
                <h1>Epidemiology Glossary</h1>
                <p class="lead">Searchable definitions of epidemiological terms.</p>
                <div id="glossary-root"></div>
            </div>
    `
    },
    'appendix-f': {
        title: "Flashcards",
        content: `
    <div class="comprehensive-quiz-container">
                <h1>Flashcards</h1>
                <p class="lead">Test your recall of key terms and concepts.</p>
                <div id="flashcard-root"></div>
            </div>
    `
    },






    my_progress: {
        title: "My Progress",
        content: `
            <h1>My Progress</h1>
            <p class="lead">Track your performance across quizzes and exams. Data is stored locally on this device.</p>
            <div id="analytics-dashboard">
                <div class="neo-card">
                    <h3>Recent Activity</h3>
                    <div id="analytics-history-list">Loading...</div>
                </div>
                <div class="neo-card" style="margin-top: 1rem;">
                    <button class="neo-btn outline small" id="clear-history-btn">Clear History</button>
                </div>
            </div>
        `
    },
    coach_resources: {
        title: "Coach Resources",
        content: `
            <div class="neo-card" style="border: 2px solid var(--accent-orange);">
                <h1><i class="ph-bold ph-chalkboard-teacher"></i> Coach Resources</h1>
                <p class="lead">Restricted Access: Answer keys and lesson guides.</p>
                <div class="alert alert-info">
                    <strong>Coach Mode Active:</strong> You can see answer explanations during quizzes.
                </div>
                <h3>Answer Keys</h3>
                <p>Coming soon: PDF downloads for printable quizzes.</p>
            </div>
        `
    },
    about: {
        title: "About & Resources",
        content: `
            <div style="text-align:center; margin-bottom:2rem;">
                <img src="assets/logo.png" alt="Logo" class="logo-glow" style="width:120px; height:auto; border-radius:24px;">
                <h1 style="margin-top:1rem; font-size:2.5rem; letter-spacing:-0.03em;">Epidemic Engine <span style="color:var(--accent-orange)">v2.0</span></h1>
                <div class="neo-badge" style="background:var(--navy-primary); color:white; font-size:1rem; padding:0.5rem 1rem;">National Edition</div>
            </div>

            <div class="neo-card" style="margin-bottom: 2rem;">
                <h3 style="margin-top:0; color:var(--navy-primary);"><i class="ph-bold ph-info"></i> System Information</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; font-size:0.95rem;">
                    <div>
                        <strong>Version:</strong> v2.1.0 (Stable)<br>
                        <strong>Build Date:</strong> December 2025<br>
                        <strong>Division:</strong> B (Middle School) & C (Intro)
                    </div>
                    <div>
                        <strong>Engine:</strong> Antigravity React Core<br>
                        <strong>License:</strong> MIT (Open Source)<br>
                        <strong>Compliance:</strong> 2026 Rules Draft
                    </div>
                </div>
                <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid #eee; color:#64748b; font-size:0.9rem;">
                    <em>"The most advanced training platform for Disease Detectives."</em>
                </div>
            </div>

            <div style="text-align:center; margin-bottom: 2rem;">
                 <button class="neo-btn large primary" onclick="window.generateStudyGuide()" style="padding: 1rem 2rem; font-size: 1.1rem; box-shadow: 0 4px 14px rgba(0,0,0,0.2);">
                    <i class="ph-bold ph-file-pdf"></i> Download Full Study Guide (Ref Book)
                </button>
                <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">Generates a printable manual of all 20 chapters.</div>
            </div>

            <h2 style="color:var(--navy-primary); border-bottom:3px solid var(--accent-orange); display:inline-block; padding-bottom:0.25rem;">Field Resources</h2>
            <p class="lead">Essential external links for further study and official competition updates.</p>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:1.5rem; margin-bottom:3rem;">
                <a href="https://www.soinc.org" target="_blank" class="neo-card small action-card" style="text-decoration:none; color:inherit; display:block; transition:transform 0.2s;">
                    <div style="color:var(--navy-primary); font-size:2rem; margin-bottom:0.5rem;"><i class="ph-bold ph-student"></i></div>
                    <div style="font-weight:700; font-size:1.1rem;">Science Olympiad</div>
                    <div style="color:#64748b; font-size:0.9rem; margin-top:0.25rem;">Official Website & Rules</div>
                </a>

                <a href="https://www.cdc.gov/eis/field-epi-manual/index.html" target="_blank" class="neo-card small action-card" style="text-decoration:none; color:inherit; display:block; transition:transform 0.2s;">
                    <div style="color:var(--accent-blue); font-size:2rem; margin-bottom:0.5rem;"><i class="ph-bold ph-book-open"></i></div>
                    <div style="font-weight:700; font-size:1.1rem;">CDC Field Manual</div>
                    <div style="color:#64748b; font-size:0.9rem; margin-top:0.25rem;">The "Bible" of Epidemiology</div>
                </a>

                <a href="https://www.who.int/emergencies/diseases/en/" target="_blank" class="neo-card small action-card" style="text-decoration:none; color:inherit; display:block; transition:transform 0.2s;">
                    <div style="color:var(--accent-orange); font-size:2rem; margin-bottom:0.5rem;"><i class="ph-bold ph-globe"></i></div>
                    <div style="font-weight:700; font-size:1.1rem;">WHO Outbreaks</div>
                    <div style="color:#64748b; font-size:0.9rem; margin-top:0.25rem;">Global Disease News</div>
                </a>

                 <a href="https://training.seer.cancer.gov/" target="_blank" class="neo-card small action-card" style="text-decoration:none; color:inherit; display:block; transition:transform 0.2s;">
                    <div style="color:var(--accent-teal); font-size:2rem; margin-bottom:0.5rem;"><i class="ph-bold ph-chart-line-up"></i></div>
                    <div style="font-weight:700; font-size:1.1rem;">SEER Training</div>
                    <div style="color:#64748b; font-size:0.9rem; margin-top:0.25rem;">Cancer Statistics & Methods</div>
                </a>
            </div>

            </div>

            <div class="neo-card" style="background:#fff0f0; border:1px solid #fababb; margin-bottom: 2rem;">
                <h3 style="margin-top:0; color: #b91c1c;">System Tools</h3>
                <p>Use this area to clear all local data, including quiz scores, custom notes, and flashcard progress. Useful when starting a new season or sharing this device.</p>
                <button onclick="if(confirm('WARNING: This will permanently delete ALL your progress, scores, and custom notes sheet data. This cannot be undone.\n\nAre you sure you want to completely reset the application?')) { localStorage.clear(); location.reload(); }" class="neo-btn danger">
                    <i class="ph-bold ph-trash"></i> Factory Reset Application
                </button>
            </div>

            <div class="neo-card" style="background:#f8fafc; border:none;">
                <h3 style="margin-top:0;">Development Credits</h3>
                 <ul style="list-style:none; padding:0; margin:0; display:grid; gap:0.5rem;">
                    <li><strong>Lead Architect:</strong> Minum (Antigravity)</li>
                    <li><strong>Content Strategy:</strong> Google DeepMind</li>
                    <li><strong>UX Design:</strong> Agentic UI Framework</li>
                 </ul>
            </div>
        `
    },
    appendix: {
        title: "Appendix & Resources",
        content: `
    <div class="neo-card">
                <h2>Appendix & Resources</h2>
                <div class="tabs" style="margin-bottom: 1rem;">
                    <button class="neo-btn small active" onclick="showTab('rules')">Rules</button>
                    <button class="neo-btn small" onclick="showTab('strategy')">Strategy</button>
                    <button class="neo-btn small" onclick="showTab('diagnostic')">Diagnostic</button>
                    <button class="neo-btn small" onclick="showTab('biases')">Biases</button>
                    <button class="neo-btn small" onclick="showTab('mnemonics')">Mnemonics</button>
                    <button class="neo-btn small" onclick="showTab('formulas')">Formulas</button>
                    <button class="neo-btn small" onclick="showTab('tables')">Tables</button>
                    <button class="neo-btn small" onclick="showTab('flashcards')">Flashcards</button>
                    <button class="neo-btn small" onclick="showTab('glossary')">Glossary</button>
                </div>
                
                <div id="rules" class="tab-content active">
                    <h3>Competition Rules</h3>
                    <div id="rules-container"></div>
                </div>
                
                <div id="biases" class="tab-content" style="display:none;">
                    <h3>Bias Catalog</h3>
                    <div id="biases-container" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;"></div>
                </div>
                
                <div id="mnemonics" class="tab-content" style="display:none;">
                    <h3>Mnemonic Bank</h3>
                    <div id="mnemonics-container"></div>
                </div>

                <div id="formulas" class="tab-content" style="display:none;">
                    <h3>Essential Formulas</h3>
                    <p class="lead">Quick reference for all epidemiological calculations.</p>
                    <div id="formulas-root"></div>
                </div>

                <div id="tables" class="tab-content" style="display:none;">
                     <h3>Statistical Tables</h3>
                     <p class="lead">Critical values for Chi-Square and Z-scores.</p>
                     <div id="tables-root"></div>
                </div>

                <div id="flashcards" class="tab-content" style="display:none;">
                    <h3>Flashcards</h3>
                    <p class="lead">Interactive flashcards for key epidemiology concepts.</p>
                    <div id="flashcard-root"></div>
                </div>

                <div id="glossary" class="tab-content" style="display:none;">
                    <h3>Epidemiology Glossary</h3>
                    <p class="lead">Searchable definitions of epidemiological terms.</p>
                    <div id="glossary-root"></div>
                </div>

                <div id="strategy" class="tab-content" style="display:none;">
                    <h3>Competition Strategy Guide</h3>
                    <p class="lead"><strong>"Knowledge is power, but strategy wins medals."</strong> Use these proven tactics for Division B Success.</p>
                    
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="neo-card small" style="border-left: 4px solid var(--accent-blue);">
                            <h4><i class="ph-bold ph-clock"></i> Time Management</h4>
                            <ul style="padding-left: 1.2rem; margin-top:0.5rem;">
                                <li><strong>The 50/50 Rule:</strong> You have ~50 minutes for 50-100 questions. That's 30-60 seconds per item.</li>
                                <li><strong>Triage First:</strong> Scan the test. Do the quick "Vocabulary Matching" or "Simple Math" sections first to bank points.</li>
                                <li><strong>Don't Stall:</strong> If a tough case study stumps you, mark it and move on. Return only if time permits.</li>
                            </ul>
                        </div>

                        <div class="neo-card small" style="border-left: 4px solid var(--accent-orange);">
                            <h4><i class="ph-bold ph-trophy"></i> Scoring & Tie-Breakers</h4>
                            <ul style="padding-left: 1.2rem; margin-top:0.5rem;">
                                <li><strong>Show Your Work!</strong> Partial credit is common. Even if the answer is wrong, the right formula gets points.</li>
                                <li><strong>Explain "Why":</strong> "The curve suggests a point source <em>because</em> it has a sharp peak." The "because" earns the quality points.</li>
                                <li><strong>Hunt Tie-Breakers:</strong> Often the last question or the hardest math problem. Spend extra care here; it decides the medal color.</li>
                            </ul>
                        </div>

                        <div class="neo-card small" style="border-left: 4px solid var(--accent-green);">
                            <h4><i class="ph-bold ph-read-cv-logo"></i> The Cheat Sheet</h4>
                            <ul style="padding-left: 1.2rem; margin-top:0.5rem;">
                                <li><strong>Don't Print the Internet:</strong> Your sheet should be a <em>reminder</em>, not a textbook.</li>
                                <li><strong>What to Include:</strong> Formulas (RR, OR, AR), 13 Steps Mnemonic, List of Biases, Z-Score Table.</li>
                                <li><strong>Map It:</strong> Know exactly where "Incubation Periods" are located on your sheet so you don't waste time searching.</li>
                            </ul>
                        </div>

                        <div class="neo-card small" style="border-left: 4px solid var(--accent-pink);">
                            <h4><i class="ph-bold ph-brain"></i> Mental Game</h4>
                            <ul style="padding-left: 1.2rem; margin-top:0.5rem;">
                                <li><strong>Read Carefully:</strong> Circle key words: "EXCEPT", "NOT", "MOST LIKELY". Misreading is the #1 cause of lost points.</li>
                                <li><strong>Collaborate:</strong> Divide and conquer! Split the packet. Check each other's math if time allows.</li>
                                <li><strong>Assume Success:</strong> If a question looks impossible, it's impossible for everyone. Just write <em>something</em> logical.</li>
                            </ul>
                        </div>
                    </div>

                <div id="diagnostic" class="tab-content" style="display:none;">
                    <h3>Mastery Diagnostic Checklist</h3>
                    <p class="lead">Track your readiness for Regionals/States. Be honest!</p>
                    
                    <div style="background: #fff; padding: 1.5rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                       <h4 style="margin-top:0; border-bottom: 2px solid #eee; padding-bottom: 0.5rem;">Part I: Foundation</h4>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I can explain the Epidemiologic Triad (Agent, Host, Environment).</span></label>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I know the difference: Endemic vs. Epidemic vs. Pandemic.</span></label>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I can list 3 modes of transmission (Direct, Vehicle, Vector).</span></label>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I know the 4 types of Surveillance (Passive, Active, Sentinel, Syndromic).</span></label>
                       
                       <h4 style="margin-top:1.5rem; border-bottom: 2px solid #eee; padding-bottom: 0.5rem;">Part II: Investigation & Math</h4>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I have memorized the 10+ Steps of an Outbreak Investigation.</span></label>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I can calculate: Incidence, Prevalence, and Attack Rate.</span></label>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I can fill out a 2x2 table from a word problem.</span></label>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I can interpret an Epi Curve (Point Source vs. Propagated).</span></label>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span><strong>(Adv)</strong> I understand what "Relative Risk > 1" implies.</span></label>

                       <h4 style="margin-top:1.5rem; border-bottom: 2px solid #eee; padding-bottom: 0.5rem;">Part III: Control & Prevention</h4>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I can distinguish Primary, Secondary, and Tertiary prevention.</span></label>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I know the difference between Isolation and Quarantine.</span></label>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I can identify at least 3 types of Bias (Selection, Recall, etc.).</span></label>
                       <label class="neo-check" style="display:block; margin:0.5rem 0;"><input type="checkbox"> <span>I can identify Hill's Criteria (Temporality, Strength, etc.).</span></label>
                    </div>
                    <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;"><em>Tip: Use your browser's "Save Page" or just screenshot this list to track progress over time.</em></p>
                </div>
            </div>
    `
    }
};

// Make globally available
// End of Content

const QUIZ_BANKS = {
    "part2":  {
                  "intermediate":  [
                                       {
                                           "q":  "Exposed AR = 30%, unexposed AR = 10%. Risk difference?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 7",
                                           "options":  [
                                                           "20%",
                                                           "3.0",
                                                           "0.33",
                                                           "Cannot compute"
                                                       ],
                                           "explain":  "Correct: RD = 30% - 10% = 20%. (Note: 3.0 is the Risk Ratio).",
                                           "chapter":  "ch7"
                                       },
                                       {
                                           "q":  "Risk difference is most useful when:",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 7",
                                           "options":  [
                                                           "Measuring strength only",
                                                           "Planning impact / cases prevented",
                                                           "Calculating OR",
                                                           "Genetic studies"
                                                       ],
                                           "explain":  "Correct: RD gives absolute excess/reduction.",
                                           "chapter":  "ch7"
                                       },
                                       {
                                           "q":  "Why use OR instead of RR?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 7",
                                           "options":  [
                                                           "RR never valid",
                                                           "OR works when population at risk unknown",
                                                           "OR always more accurate",
                                                           "RR only for vaccines"
                                                       ],
                                           "explain":  "Correct: OR works in case-control studies.",
                                           "chapter":  "ch7"
                                       },
                                       {
                                           "q":  "Identify the outbreak pattern shown in the diagram below:\u003cbr\u003e\u003cbr\u003e\u003csvg width=\u0027240\u0027 height=\u0027120\u0027 viewBox=\u00270 0 240 120\u0027 style=\u0027background:#f9fafb; border:1px solid #e5e7eb; border-radius:4px; display:block; margin:0.5rem auto;\u0027\u003e\u003crect x=\u002740\u0027 y=\u002790\u0027 width=\u002720\u0027 height=\u002710\u0027 fill=\u0027#2d3e50\u0027/\u003e\u003crect x=\u002765\u0027 y=\u002760\u0027 width=\u002720\u0027 height=\u002740\u0027 fill=\u0027#2d3e50\u0027/\u003e\u003crect x=\u002790\u0027 y=\u002720\u0027 width=\u002720\u0027 height=\u002780\u0027 fill=\u0027#2d3e50\u0027/\u003e\u003crect x=\u0027115\u0027 y=\u002750\u0027 width=\u002720\u0027 height=\u002750\u0027 fill=\u0027#2d3e50\u0027/\u003e\u003crect x=\u0027140\u0027 y=\u002780\u0027 width=\u002720\u0027 height=\u002720\u0027 fill=\u0027#2d3e50\u0027/\u003e\u003cline x1=\u002710\u0027 y1=\u0027110\u0027 x2=\u0027230\u0027 y2=\u0027110\u0027 stroke=\u0027#374151\u0027 stroke-width=\u00272\u0027/\u003e\u003ctext x=\u0027120\u0027 y=\u0027118\u0027 text-anchor=\u0027middle\u0027 font-size=\u002710\u0027 fill=\u0027#6b7280\u0027\u003eTime\u003c/text\u003e\u003c/svg\u003e",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 8",
                                           "options":  [
                                                           "Point-source outbreak",
                                                           "Continuous common-source outbreak",
                                                           "Propagated outbreak",
                                                           "Random variation"
                                                       ],
                                           "explain":  "Correct: A. Classic spike then taper. Trap: not propagated.",
                                           "chapter":  "ch8"
                                       },
                                       {
                                           "q":  "Initial spike followed by waves. Pattern?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 8",
                                           "options":  [
                                                           "Point-source",
                                                           "Mixed outbreak",
                                                           "Continuous source",
                                                           "Propagated only"
                                                       ],
                                           "explain":  "Correct: B. Mixed = common source + propagation.",
                                           "chapter":  "ch8"
                                       },
                                       {
                                           "q":  "Propagated outbreaks generally produce:",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 8",
                                           "options":  [
                                                           "Single narrow peak",
                                                           "Multiple peaks spaced by incubation",
                                                           "Flat line",
                                                           "Plateau with no peaks"
                                                       ],
                                           "explain":  "Correct: B.",
                                           "chapter":  "ch8"
                                       },
                                       {
                                           "q":  "Which pattern suggests a slowly leaking water source?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 8",
                                           "options":  [
                                                           "Several spaced peaks",
                                                           "Prolonged plateau with slow rise and fall",
                                                           "Sharp spike",
                                                           "Single classroom cases"
                                                       ],
                                           "explain":  "Correct: B.",
                                           "chapter":  "ch8"
                                       },
                                       {
                                           "q":  "Which is NOT part of a standard case definition?",
                                           "answer":  3,
                                           "type":  "mc",
                                           "topic":  "Chapter 9",
                                           "options":  [
                                                           "Clinical criteria",
                                                           "Person/place/time",
                                                           "Lab confirmation",
                                                           "Personal opinions"
                                                       ],
                                           "explain":  "Correct: Case definitions require objective criteria.",
                                           "chapter":  "ch9"
                                       },
                                       {
                                           "q":  "Descriptive epidemiology summarizes:",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 9",
                                           "options":  [
                                                           "Risk ratios",
                                                           "Person, place, time",
                                                           "Final reports",
                                                           "Lab protocols"
                                                       ],
                                           "explain":  "Correct: Classic descriptive triad.",
                                           "chapter":  "ch9"
                                       },
                                       {
                                           "q":  "Most appropriate EARLY control measure?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 9",
                                           "options":  [
                                                           "Publish report",
                                                           "Remove contaminated food",
                                                           "Wait for full lab results",
                                                           "Re-interview cases"
                                                       ],
                                           "explain":  "Correct: Early control occurs immediately with credible evidence.",
                                           "chapter":  "ch9"
                                       },
                                       {
                                           "q":  "Researchers follow exposed and unexposed students over 3 days to record new illness. Study design?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 10",
                                           "options":  [
                                                           "Cohort",
                                                           "Case-control",
                                                           "Randomized trial",
                                                           "Cross-sectional"
                                                       ],
                                           "explain":  "Correct: Cohort = forward direction based on exposure.",
                                           "chapter":  "ch10"
                                       },
                                       {
                                           "q":  "Case-control studies primarily use which measure?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 10",
                                           "options":  [
                                                           "Risk ratio",
                                                           "Odds ratio",
                                                           "Risk difference",
                                                           "Incidence rate"
                                                       ],
                                           "explain":  "Correct: OR required because denominators forced.",
                                           "chapter":  "ch10"
                                       },
                                       {
                                           "q":  "Which design is best for measuring prevalence?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 10",
                                           "options":  [
                                                           "Cohort",
                                                           "Cross-sectional",
                                                           "Case-control",
                                                           "Clinical trial"
                                                       ],
                                           "explain":  "Correct: Cross-sectional measures prevalence.",
                                           "chapter":  "ch10"
                                       },
                                       {
                                           "q":  "Major strength of cohort studies:",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 10",
                                           "options":  [
                                                           "Cheap/quick",
                                                           "Clear temporal sequence",
                                                           "Proof of causation",
                                                           "Best for rare diseases"
                                                       ],
                                           "explain":  "Correct: Temporal clarity.",
                                           "chapter":  "ch10"
                                       },
                                       {
                                           "q":  "Study uses volunteers from a \u0027Healthy Lifestyle Club.\u0027 Bias?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 11",
                                           "options":  [
                                                           "Volunteers differ from general population",
                                                           "Sample too small",
                                                           "Uses surveys",
                                                           "Descriptive study"
                                                       ],
                                           "explain":  "Correct: Volunteers ? source population ? selection bias.",
                                           "chapter":  "ch11"
                                       },
                                       {
                                           "q":  "Non-differential misclassification usually:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 11",
                                           "options":  [
                                                           "Moves RR/OR toward 1",
                                                           "Moves RR/OR away from 1",
                                                           "Eliminates association",
                                                           "Reverses direction"
                                                       ],
                                           "explain":  "Correct: Dilutes association.",
                                           "chapter":  "ch11"
                                       },
                                       {
                                           "q":  "Random error example:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 11",
                                           "options":  [
                                                           "Small sample ? unstable estimates",
                                                           "Different recall",
                                                           "Selective recruitment",
                                                           "Confounding"
                                                       ],
                                           "explain":  "Correct: Instability = random error.",
                                           "chapter":  "ch11"
                                       },
                                       {
                                           "q":  "A rapid test correctly identifies 90 of 100 true cases. Sensitivity?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 12",
                                           "options":  [
                                                           "90%",
                                                           "10%",
                                                           "100%",
                                                           "Cannot determine"
                                                       ],
                                           "explain":  "Sensitivity = TP / (TP + FN) = 90%.",
                                           "chapter":  "ch12"
                                       },
                                       {
                                           "q":  "PPV answers:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 12",
                                           "options":  [
                                                           "Probability positive truly has disease",
                                                           "Probability negative has disease",
                                                           "Ability to detect disease",
                                                           "Avoid false positives"
                                                       ],
                                           "explain":  "PPV = P(disease | positive test).",
                                           "chapter":  "ch12"
                                       },
                                       {
                                           "q":  "TP=50, FP=10, FN=5, TN=35. Specificity?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 12",
                                           "options":  [
                                                           "35/(35+10)",
                                                           "35/(35+5)",
                                                           "50/60",
                                                           "50/55"
                                                       ],
                                           "explain":  "Specificity = TN/(TN+FP) = 35/45 = 78%.",
                                           "chapter":  "ch12"
                                       },
                                       {
                                           "q":  "Main purpose of screening:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 12",
                                           "options":  [
                                                           "Detect disease early",
                                                           "Prove causation",
                                                           "Replace diagnostics",
                                                           "Eliminate disease"
                                                       ],
                                           "explain":  "Screening = early detection.",
                                           "chapter":  "ch12"
                                       },
                                       {
                                           "q":  "Risk ratio comparing chicken eaters to non-eaters?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 13",
                                           "options":  [
                                                           "(9/30)/(2/20)",
                                                           "(2/20)/(9/30)",
                                                           "9/30",
                                                           "2/20"
                                                       ],
                                           "explain":  "RR = 0.30 / 0.10 = 3.0.",
                                           "chapter":  "ch13"
                                       },
                                       {
                                           "q":  "Odds ratio formula:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 13",
                                           "options":  [
                                                           "(aÃ—d)/(bÃ—c)",
                                                           "(a/c)/(b/d)",
                                                           "a+b+c+d",
                                                           "(a+b)/(c+d)"
                                                       ],
                                           "explain":  "OR = ad/bc.",
                                           "chapter":  "ch13"
                                       },
                                       {
                                           "q":  "Correct 2Ã—2 layout:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 13",
                                           "options":  [
                                                           "Exposure on rows, outcome on columns",
                                                           "Outcome on rows, exposure on columns",
                                                           "Symptoms on rows",
                                                           "Invalid"
                                                       ],
                                           "explain":  "Standard orientation.",
                                           "chapter":  "ch13"
                                       }
                                   ],
                  "beginner":  [
                                   {
                                       "q":  "In an outbreak, exposed AR = 40%, unexposed AR = 20%. Risk ratio?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "2.0",
                                                       "0.5",
                                                       "20%",
                                                       "40%"
                                                   ],
                                       "explain":  "Correct: 40% Ã· 20% = 2. Trap: difference ? ratio.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "RR = 1.0 means:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "Harmful",
                                                       "No association",
                                                       "Protective",
                                                       "Causal"
                                                   ],
                                       "explain":  "Correct: Null association.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "Odds among exposed is:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "Sick/Total exposed",
                                                       "Sick/Not sick",
                                                       "Sick exposed/Sick unexposed",
                                                       "Exposed/Unexposed"
                                                   ],
                                       "explain":  "Correct: Odds = sick Ã· not sick.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "Which RR indicates strongest association?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "1.2",
                                                       "3.0",
                                                       "0.9",
                                                       "1.0"
                                                   ],
                                       "explain":  "Correct: Highest distance from 1.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "Which feature best identifies a propagated outbreak?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 8",
                                       "options":  [
                                                       "Single tall peak",
                                                       "Sequential peaks separated by incubation periods",
                                                       "Flat line",
                                                       "Only meal-related cases"
                                                   ],
                                       "explain":  "Correct: B. Propagated = waves.",
                                       "chapter":  "ch8"
                                   },
                                   {
                                       "q":  "Which statement about epidemic curves is correct?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 8",
                                       "options":  [
                                                       "They show exact cause",
                                                       "They show number of cases by onset time",
                                                       "They show incubation directly",
                                                       "They show exposure dose"
                                                   ],
                                       "explain":  "Correct: B.",
                                       "chapter":  "ch8"
                                   },
                                   {
                                       "q":  "Curves help determine all EXCEPT:",
                                       "answer":  3,
                                       "type":  "mc",
                                       "topic":  "Chapter 8",
                                       "options":  [
                                                       "Pattern of spread",
                                                       "Possible exposure period",
                                                       "Incubation distribution",
                                                       "Exact bacterial species"
                                                   ],
                                       "explain":  "Correct: D.",
                                       "chapter":  "ch8"
                                   },
                                   {
                                       "q":  "Which step comes FIRST in the outbreak investigation sequence?",
                                       "answer":  2,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "Develop hypotheses",
                                                       "Define and identify cases",
                                                       "Prepare for field work",
                                                       "Implement control measures"
                                                   ],
                                       "explain":  "Correct: Prepare for field work precedes all other steps. Common error: students pick \u0027define cases\u0027 as #1.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "Case finding typically involves:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "Only hospitalized patients",
                                                       "Records, lab reports, provider contact",
                                                       "Testing whole community",
                                                       "Removing mild cases"
                                                   ],
                                       "explain":  "Correct: Broad capture across systems.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "Case-control studies identify:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "Treatment effectiveness",
                                                       "Exposures associated with illness",
                                                       "Symptoms with longest duration",
                                                       "Temperature changes"
                                                   ],
                                       "explain":  "Correct: Purpose = find associations.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "Environmental investigation may include:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "Interviewing teachers",
                                                       "Food prep observation, temperatures, storage",
                                                       "Textbook review",
                                                       "Student drawings"
                                                   ],
                                       "explain":  "Correct: Direct assessment of exposure environment.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "Survey asks students, \u0027Do you currently vape?\u0027 Study design?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 10",
                                       "options":  [
                                                       "Cohort",
                                                       "Cross-sectional",
                                                       "Case-control",
                                                       "Randomized trial"
                                                   ],
                                       "explain":  "Correct: Cross-sectional snapshot.",
                                       "chapter":  "ch10"
                                   },
                                   {
                                       "q":  "Which is an RCT example?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 10",
                                       "options":  [
                                                       "Students choose vitamin C",
                                                       "Researchers randomly assign vitamin C",
                                                       "Interview after outbreak",
                                                       "Compare sick vs not sick"
                                                   ],
                                       "explain":  "Correct: Random assignment = RCT.",
                                       "chapter":  "ch10"
                                   },
                                   {
                                       "q":  "Case-control studies are best for:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 10",
                                       "options":  [
                                                       "Common diseases",
                                                       "Rare diseases",
                                                       "Experimental treatments",
                                                       "Determining incidence"
                                                   ],
                                       "explain":  "Correct: Efficient for rare outcomes.",
                                       "chapter":  "ch10"
                                   },
                                   {
                                       "q":  "A case-control study asks sick and non-sick students to recall what they ate last week. Main bias?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "Recall bias",
                                                       "Selection bias",
                                                       "Confounding",
                                                       "Random error"
                                                   ],
                                       "explain":  "Correct: Cases remember exposures differently ? recall bias.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "Validity means:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "Cheap",
                                                       "Measures what intended",
                                                       "Consistent",
                                                       "Cohort design"
                                                   ],
                                       "explain":  "Correct: Validity = accuracy.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "Exercise ? better grades, but exercise linked to more sleep. Confounder?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "Exercise",
                                                       "Sleep",
                                                       "Grades",
                                                       "None"
                                                   ],
                                       "explain":  "Correct: Sleep linked to both exposure and outcome.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "Consistent but incorrect survey answers indicate:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "High validity",
                                                       "High reliability, low validity",
                                                       "Low reliability, high validity",
                                                       "Both high"
                                                   ],
                                       "explain":  "Correct: Consistent error.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "If specificity = 80%, false positive rate = ?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 12",
                                       "options":  [
                                                       "20%",
                                                       "80%",
                                                       "10%",
                                                       "5%"
                                                   ],
                                       "explain":  "FPR = 1 - specificity = 20%.",
                                       "chapter":  "ch12"
                                   },
                                   {
                                       "q":  "Increasing disease prevalence generally:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 12",
                                       "options":  [
                                                       "Increases PPV",
                                                       "Decreases PPV",
                                                       "No effect",
                                                       "Increases sensitivity"
                                                   ],
                                       "explain":  "Higher prevalence = more true positives ? higher PPV.",
                                       "chapter":  "ch12"
                                   },
                                   {
                                       "q":  "If a test labels many healthy students positive, problem is:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 12",
                                       "options":  [
                                                       "Low sensitivity",
                                                       "Low specificity",
                                                       "Low NPV",
                                                       "High reliability"
                                                   ],
                                       "explain":  "Low specificity = high false positives.",
                                       "chapter":  "ch12"
                                   },
                                   {
                                       "q":  "At a school picnic, 30 ate chicken (9 sick) and 20 did not eat chicken (2 sick). AR(exposed)?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "9/30",
                                                       "2/20",
                                                       "11/50",
                                                       "30/9"
                                                   ],
                                       "explain":  "Attack rate (exposed) = sick_exposed / total_exposed = 9/30 = 30%.",
                                       "chapter":  "ch13"
                                   },
                                   {
                                       "q":  "Risk difference?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "20%",
                                                       "3.0",
                                                       "10%",
                                                       "40%"
                                                   ],
                                       "explain":  "RD = 30% - 10% = 20%.",
                                       "chapter":  "ch13"
                                   },
                                   {
                                       "q":  "Vaccine effectiveness: vaccinated 2/50 sick, unvaccinated 10/50 sick.",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "1 - (2/50)/(10/50)",
                                                       "1 - (10/50)/(2/50)",
                                                       "(2/50) - (10/50)",
                                                       "2/50"
                                                   ],
                                       "explain":  "VE = 1 - (.04/.20) = 80%.",
                                       "chapter":  "ch13"
                                   },
                                   {
                                       "q":  "Water park: exposed 40 (12 sick), unexposed 60 (6 sick). AR(exposed)?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "12/40",
                                                       "6/60",
                                                       "18/100",
                                                       "40/12"
                                                   ],
                                       "explain":  "AR(exposed) = 12/40 = 30%.",
                                       "chapter":  "ch13"
                                   }
                               ],
                  "advanced":  [
                                   {
                                       "q":  "A study finds RR = 3.0 for eating tuna salad. Interpretation?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "Tuna causes illness",
                                                       "3Ã— the risk for eaters",
                                                       "3 more people got sick",
                                                       "No association"
                                                   ],
                                       "explain":  "Correct: RR shows association, not causation.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "2Ã—2 table: 18/12 exposed; 4/16 unexposed. Risk ratio?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "(18/30)/(4/20)",
                                                       "(18/30)/(16/20)",
                                                       "(4/20)/(18/30)",
                                                       "Cannot compute"
                                                   ],
                                       "explain":  "Correct: Exposed AR = .6; unexposed AR = .2; RR = 3.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "RR = 0.25 for a vaccine means:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "Risk reduced 75%",
                                                       "Risk increased 4Ã—",
                                                       "No effect",
                                                       "Eliminates all risk"
                                                   ],
                                       "explain":  "Correct: RR \u003c 1 = protective.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "Rate ratio: 40/5000 vs 10/5000. Rate ratio?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "(40/5000)/(10/5000)",
                                                       "40/10",
                                                       "10/40",
                                                       "Cannot compute"
                                                   ],
                                       "explain":  "Correct: Rate ratio = 4.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "2Ã—2: 9/3 exposed; 6/12 unexposed. OR?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "(9Ã—12)/(3Ã—6)",
                                                       "(9Ã—3)/(6Ã—12)",
                                                       "(9Ã—6)/(3Ã—12)",
                                                       "Cannot compute"
                                                   ],
                                       "explain":  "Correct: OR = 6.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "RR = 4.0 and OR = 5.0 imply:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "Both show strong positive association",
                                                       "No association",
                                                       "Protective",
                                                       "Inconclusive"
                                                   ],
                                       "explain":  "Correct: Direction same.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "Exposed AR=0.50; unexposed AR=0.10. Excess cases per 100 exposed?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "40",
                                                       "50",
                                                       "10",
                                                       "90"
                                                   ],
                                       "explain":  "Correct: RD = .40 ? 40 per 100.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "Which statement is correct?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 7",
                                       "options":  [
                                                       "RR\u003e1 and RD\u003e0 indicate harmful association",
                                                       "RR\u003e1 and RD\u003c0 indicate harm",
                                                       "RR\u003c1 always harmful",
                                                       "RD=0 means strong association"
                                                   ],
                                       "explain":  "Correct: Direction alignment.",
                                       "chapter":  "ch7"
                                   },
                                   {
                                       "q":  "Cases rise over 10 days, plateau 10 days, drop when water filter repaired. Pattern?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 8",
                                       "options":  [
                                                       "Continuous common source",
                                                       "Point source",
                                                       "Propagated",
                                                       "Mixed"
                                                   ],
                                       "explain":  "Correct: A. Long plateau + abrupt stop indicates continuous exposure.",
                                       "chapter":  "ch8"
                                   },
                                   {
                                       "q":  "Exposure at noon Friday. Onsets: 6 PM, 9 PM, midnight. Incubation range?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 8",
                                       "options":  [
                                                       "6-12 hours",
                                                       "3-6 hours",
                                                       "12-24 hours",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Correct: A. Short incubation typical of toxin.",
                                       "chapter":  "ch8"
                                   },
                                   {
                                       "q":  "Slow rise, broad peak for weeks, slow decline. Pattern?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 8",
                                       "options":  [
                                                       "Continuous common source",
                                                       "Point source",
                                                       "Mixed",
                                                       "Propagated"
                                                   ],
                                       "explain":  "Correct: A. Prolonged exposure produces broad curve.",
                                       "chapter":  "ch8"
                                   },
                                   {
                                       "q":  "Median onset = 36h; incubation = 24-72h. Approx exposure?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 8",
                                       "options":  [
                                                       "36h before median onset",
                                                       "72h before onset",
                                                       "24h before onset",
                                                       "Cannot tell"
                                                   ],
                                       "explain":  "Correct: A.",
                                       "chapter":  "ch8"
                                   },
                                   {
                                       "q":  "Sharp initial peak (food event) + two peaks 4 days apart. Pattern?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 8",
                                       "options":  [
                                                       "Mixed",
                                                       "Propagated",
                                                       "Point-source",
                                                       "Continuous"
                                                   ],
                                       "explain":  "Correct: A.",
                                       "chapter":  "ch8"
                                   },
                                   {
                                       "q":  "Exposure 8 AM. Onsets: 2 PM, 3 PM, 5 PM, 6 PM. Incubation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 8",
                                       "options":  [
                                                       "6-10 hours",
                                                       "2-4 hours",
                                                       "8-12 hours",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Correct: A.",
                                       "chapter":  "ch8"
                                   },
                                   {
                                       "q":  "Wide onset window without peaks suggests:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 8",
                                       "options":  [
                                                       "Variable exposure timing",
                                                       "Point-source",
                                                       "Propagated",
                                                       "Mixed"
                                                   ],
                                       "explain":  "Correct: A.",
                                       "chapter":  "ch8"
                                   },
                                   {
                                       "q":  "Gradual rise, long plateau, sharp decline after well closure suggests:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 8",
                                       "options":  [
                                                       "Continuous common source",
                                                       "Point-source",
                                                       "Propagated",
                                                       "Mixed"
                                                   ],
                                       "explain":  "Correct: A.",
                                       "chapter":  "ch8"
                                   },
                                   {
                                       "q":  "A clinic reports \u0027more strep cases than usual.\u0027 What is the correct next action?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "Interview all patients",
                                                       "Confirm outbreak by comparing to baseline",
                                                       "Skip confirmation and jump to control",
                                                       "Declare emergency"
                                                   ],
                                       "explain":  "Correct: Must confirm \u003e expected level before calling it an outbreak.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "Best \u0027probable case\u0027 definition for E. coli outbreak?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "Any abdominal pain",
                                                       "Bloody diarrhea + known exposure",
                                                       "Ate cafeteria food last week",
                                                       "Any student absent"
                                                   ],
                                       "explain":  "Correct: Probable = strong clinical + epi link; no lab required.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "Essential columns of a line list include:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "ID, onset date, symptoms, exposure",
                                                       "Height, weight, BP",
                                                       "Parent names",
                                                       "Enrollment date"
                                                   ],
                                       "explain":  "Correct: Line lists summarize case data, not full medical records.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "A good outbreak hypothesis must include:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "Agent, source, mode",
                                                       "Only incubation period",
                                                       "Only risk ratio",
                                                       "Only suspected food"
                                                   ],
                                       "explain":  "Correct: Minimum structure = agent + source + exposure + mode.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "Case-control picnic outbreak: 22/30 cases ate potato salad vs 5/30 controls. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "Strong association; likely source",
                                                       "Weak association",
                                                       "No association",
                                                       "Protective"
                                                   ],
                                       "explain":  "Correct: Large OR difference indicates strong association.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "Closing a kitchen while investigating shows which principle?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "Control does not wait for complete proof",
                                                       "Control must wait for labs",
                                                       "Investigation finishes before intervention",
                                                       "Intervention optional"
                                                   ],
                                       "explain":  "Correct: Critical nuance tested often.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "Several early stool samples negative but epi evidence strong. Correct interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "Epi evidence may override early negative labs",
                                                       "Labs supersede epi",
                                                       "Hypothesis must be discarded",
                                                       "Outbreak is fake"
                                                   ],
                                       "explain":  "Correct: Strong epi can override early negative tests.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "Final step in outbreak investigation is:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 9",
                                       "options":  [
                                                       "Communicate findings",
                                                       "Implement control",
                                                       "Environmental sampling",
                                                       "Analyze curves"
                                                   ],
                                       "explain":  "Correct: Final = communicate/report findings.",
                                       "chapter":  "ch9"
                                   },
                                   {
                                       "q":  "Investigators select 20 sick (cases) and 40 not sick (controls) and look backward at food exposures. Design?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 10",
                                       "options":  [
                                                       "Case-control",
                                                       "Cohort",
                                                       "Cross-sectional",
                                                       "Randomized trial"
                                                   ],
                                       "explain":  "Correct: Case-control starts with outcome.",
                                       "chapter":  "ch10"
                                   },
                                   {
                                       "q":  "Which study can directly calculate risk ratios?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 10",
                                       "options":  [
                                                       "Cohort",
                                                       "Case-control",
                                                       "Cross-sectional",
                                                       "None"
                                                   ],
                                       "explain":  "Correct: Only cohorts produce incidence.",
                                       "chapter":  "ch10"
                                   },
                                   {
                                       "q":  "Campers tracked 7 days with multiple exposure data. Design?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 10",
                                       "options":  [
                                                       "Prospective cohort",
                                                       "Case-control",
                                                       "Cross-sectional",
                                                       "Randomized trial"
                                                   ],
                                       "explain":  "Correct: Prospective follow-up = cohort.",
                                       "chapter":  "ch10"
                                   },
                                   {
                                       "q":  "Study starts with disease status and looks back at exposures. Direction?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 10",
                                       "options":  [
                                                       "Backward",
                                                       "Forward",
                                                       "Simultaneous",
                                                       "Neither"
                                                   ],
                                       "explain":  "Correct: Case-control direction.",
                                       "chapter":  "ch10"
                                   },
                                   {
                                       "q":  "Which pairing is correct?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 10",
                                       "options":  [
                                                       "Cohort ? incidence ? risk ratio",
                                                       "Case-control ? incidence ? risk ratio",
                                                       "Cross-sectional ? incidence rate ? OR",
                                                       "RCT ? cannot estimate effect"
                                                   ],
                                       "explain":  "Correct: Cohort can compute incidence and RR.",
                                       "chapter":  "ch10"
                                   },
                                   {
                                       "q":  "Case-control diet recall most vulnerable to:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 10",
                                       "options":  [
                                                       "Recall bias",
                                                       "Loss to follow-up",
                                                       "Randomization failure",
                                                       "Incidence misclassification"
                                                   ],
                                       "explain":  "Correct: Memory-dependent.",
                                       "chapter":  "ch10"
                                   },
                                   {
                                       "q":  "Retrospective cohort differs from case-control because:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 10",
                                       "options":  [
                                                       "Defined by exposure",
                                                       "Defined by disease",
                                                       "Uses OR only",
                                                       "One time point only"
                                                   ],
                                       "explain":  "Correct: Exposure groups define cohort.",
                                       "chapter":  "ch10"
                                   },
                                   {
                                       "q":  "OR approximates RR when:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 10",
                                       "options":  [
                                                       "Disease is rare",
                                                       "Disease common",
                                                       "Study prospective",
                                                       "Incidence high"
                                                   ],
                                       "explain":  "Correct: Rare disease assumption.",
                                       "chapter":  "ch10"
                                   },
                                   {
                                       "q":  "Cases exaggerate eating a suspected food. Effect on association?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "Biases OR upward",
                                                       "Biases OR downward",
                                                       "No change",
                                                       "OR becomes 1"
                                                   ],
                                       "explain":  "Correct: Differential recall inflates association.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "Energy drink study: irritability actually driven by sleep. Sleep is:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "Confounder",
                                                       "Bias",
                                                       "Outcome",
                                                       "Random error"
                                                   ],
                                       "explain":  "Correct: Confounder associated with both exposure and outcome.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "Thermometer always 2Â° too high. It is:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "Reliable but not valid",
                                                       "Valid but not reliable",
                                                       "Both",
                                                       "Neither"
                                                   ],
                                       "explain":  "Correct: Consistent error = reliable, not valid.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "Differential misclassification means:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "Misclassification differs by group",
                                                       "Equal misclassification",
                                                       "Only controls misclassify",
                                                       "Only cases misclassify"
                                                   ],
                                       "explain":  "Correct: Unequal error can bias any direction.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "Which reduces confounding?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "Stratification",
                                                       "Increasing sample size",
                                                       "Random misclassification",
                                                       "Change recall period"
                                                   ],
                                       "explain":  "Correct: Stratification adjusts for confounders.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "Sick students more likely to respond ? measured prevalence is:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "Overestimated",
                                                       "Underestimated",
                                                       "Unbiased",
                                                       "More reliable"
                                                   ],
                                       "explain":  "Correct: Differential response inflates prevalence.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "Confounder positively associated with exposure and outcome biases association:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "Upward",
                                                       "Downward",
                                                       "To 1",
                                                       "Reversal"
                                                   ],
                                       "explain":  "Correct: Strengthens false association.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "Which reduces recall bias?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 11",
                                       "options":  [
                                                       "Use records instead of self-report",
                                                       "Increase sample size",
                                                       "More questions",
                                                       "Short surveys"
                                                   ],
                                       "explain":  "Correct: Objective data removes memory error.",
                                       "chapter":  "ch11"
                                   },
                                   {
                                       "q":  "A test correctly identifies 360 of 400 healthy students as negative. Specificity?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 12",
                                       "options":  [
                                                       "360/400",
                                                       "40/400",
                                                       "400/360",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Specificity = TN / (TN + FP) = 90%.",
                                       "chapter":  "ch12"
                                   },
                                   {
                                       "q":  "A test has sensitivity of 70%. False negative rate?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 12",
                                       "options":  [
                                                       "30%",
                                                       "70%",
                                                       "Cannot determine",
                                                       "100%"
                                                   ],
                                       "explain":  "FNR = 1 - sensitivity = 30%.",
                                       "chapter":  "ch12"
                                   },
                                   {
                                       "q":  "NPV indicates:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 12",
                                       "options":  [
                                                       "Probability negative test is truly negative",
                                                       "Probability positive is true",
                                                       "Sensitivity",
                                                       "Specificity"
                                                   ],
                                       "explain":  "NPV = P(no disease | negative test).",
                                       "chapter":  "ch12"
                                   },
                                   {
                                       "q":  "Increasing disease prevalence will:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 12",
                                       "options":  [
                                                       "Decrease NPV",
                                                       "Increase NPV",
                                                       "No effect",
                                                       "Increase specificity"
                                                   ],
                                       "explain":  "More disease = fewer true negatives ? lower NPV.",
                                       "chapter":  "ch12"
                                   },
                                   {
                                       "q":  "TP=50, FN=5. Sensitivity?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 12",
                                       "options":  [
                                                       "50/(50+5)",
                                                       "35/(35+10)",
                                                       "10/(50+35)",
                                                       "Cannot compute"
                                                   ],
                                       "explain":  "Sensitivity = TP/(TP+FN) = 91%.",
                                       "chapter":  "ch12"
                                   },
                                   {
                                       "q":  "PPV for TP=50, FP=10?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 12",
                                       "options":  [
                                                       "50/(50+10)",
                                                       "35/(35+10)",
                                                       "50/(50+35)",
                                                       "60/(50+35)"
                                                   ],
                                       "explain":  "PPV = TP/(TP+FP) = 83%.",
                                       "chapter":  "ch12"
                                   },
                                   {
                                       "q":  "Lowering cutoff value generally:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 12",
                                       "options":  [
                                                       "Increases sensitivity, decreases specificity",
                                                       "Decreases sensitivity, increases specificity",
                                                       "Increases both",
                                                       "Decreases both"
                                                   ],
                                       "explain":  "Lower cutoff ? more positives ? higher sensitivity.",
                                       "chapter":  "ch12"
                                   },
                                   {
                                       "q":  "Test gives consistent but incorrect results. Means:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 12",
                                       "options":  [
                                                       "High reliability, low validity",
                                                       "Low reliability, high validity",
                                                       "Both high",
                                                       "Both low"
                                                   ],
                                       "explain":  "Consistent error = reliable but invalid.",
                                       "chapter":  "ch12"
                                   },
                                   {
                                       "q":  "Using same data: AR(unexposed)?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "2/20",
                                                       "9/30",
                                                       "11/50",
                                                       "20/2"
                                                   ],
                                       "explain":  "Unexposed attack rate = 2/20 = 10%.",
                                       "chapter":  "ch13"
                                   },
                                   {
                                       "q":  "RR = 3.0 means:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "Exposure triples risk",
                                                       "Exposure prevents illness",
                                                       "No association",
                                                       "Protective"
                                                   ],
                                       "explain":  "RR \u003e 1 = harmful.",
                                       "chapter":  "ch13"
                                   },
                                   {
                                       "q":  "AR% with RR = 3.0? (AR% = (RR-1)/RR Ã—100)",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "67%",
                                                       "200%",
                                                       "33%",
                                                       "3%"
                                                   ],
                                       "explain":  "AR% = (3-1)/3 = 67%.",
                                       "chapter":  "ch13"
                                   },
                                   {
                                       "q":  "Compute OR: 12/8 exposed, 3/27 unexposed.",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "(12Ã—27)/(8Ã—3)",
                                                       "(12Ã—3)/(8Ã—27)",
                                                       "(12/20)/(3/30)",
                                                       "Cannot compute"
                                                   ],
                                       "explain":  "OR = 108/24 = 4.5.",
                                       "chapter":  "ch13"
                                   },
                                   {
                                       "q":  "Interpretation trap: \u0027VE=80% means zero risk.\u0027 Correct response?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "VE reduces risk 80%, not to zero",
                                                       "Eliminates disease",
                                                       "Same risk",
                                                       "80% get sick"
                                                   ],
                                       "explain":  "VE ? zero risk.",
                                       "chapter":  "ch13"
                                   },
                                   {
                                       "q":  "RR = 0.25 and OR = 0.20 ? exposure is:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "Strongly protective",
                                                       "Strongly harmful",
                                                       "Neutral",
                                                       "Uninterpretable"
                                                   ],
                                       "explain":  "Ratios \u003c 1 = protective.",
                                       "chapter":  "ch13"
                                   },
                                   {
                                       "q":  "RR for water park data?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "(12/40)/(6/60)",
                                                       "(6/60)/(12/40)",
                                                       "12/60",
                                                       "40/12"
                                                   ],
                                       "explain":  "RR = 0.30 / 0.10 = 3.0.",
                                       "chapter":  "ch13"
                                   },
                                   {
                                       "q":  "RR=3.0, OR=4.0, RD=20% - which is true?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 13",
                                       "options":  [
                                                       "All indicate harmful association",
                                                       "All protective",
                                                       "Only OR harmful",
                                                       "None harmful"
                                                   ],
                                       "explain":  "RR\u003e1, OR\u003e1, RD\u003e0 all show harm.",
                                       "chapter":  "ch13"
                                   }
                               ]
              },
    "part1":  {
                  "intermediate":  [
                                       {
                                           "q":  "In a town of 100 people, 5 new cases of flu occur in January. The Incidence Rate is:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 4",
                                           "options":  [
                                                           "5%",
                                                           "95%",
                                                           "100%",
                                                           "0.05%"
                                                       ],
                                           "explain":  "Correct: Incidence = New Cases / Population at Risk (5/100 = 5%).",
                                           "chapter":  "ch4"
                                       },
                                       {
                                           "q":  "Which measure includes both new and existing cases?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 4",
                                           "options":  [
                                                           "Incidence",
                                                           "Prevalence",
                                                           "Attack Rate",
                                                           "Mortality Rate"
                                                       ],
                                           "explain":  "Correct: Prevalence counts everyone who currently has the disease.",
                                           "chapter":  "ch4"
                                       },
                                       {
                                           "q":  "If a disease has a long duration (chronic) but low incidence, Prevalence will be:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 4",
                                           "options":  [
                                                           "High",
                                                           "Low",
                                                           "Zero",
                                                           "Negative"
                                                       ],
                                           "explain":  "Correct: P â‰ˆ I Ã— D. Long Duration increases Prevalence.",
                                           "chapter":  "ch4"
                                       },
                                       {
                                           "q":  "In the Bathtub Analogy, what represents Incidence?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 4",
                                           "options":  [
                                                           "Water flowing from the faucet",
                                                           "Water in the tub",
                                                           "Water draining out",
                                                           "Evaporation"
                                                       ],
                                           "explain":  "Correct: New water entering = New cases (Incidence).",
                                           "chapter":  "ch4"
                                       },
                                       {
                                           "q":  "10 people get sick. 2 of them die. The Case Fatality Rate is:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 4",
                                           "options":  [
                                                           "20%",
                                                           "2%",
                                                           "10%",
                                                           "50%"
                                                       ],
                                           "explain":  "Correct: CFR = Deaths / Cases = 2/10 = 20%.",
                                           "chapter":  "ch4"
                                       },
                                       {
                                           "q":  "Attack Rate is technically a type of:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 4",
                                           "options":  [
                                                           "Incidence Proportion",
                                                           "Prevalence",
                                                           "Mortality Rate",
                                                           "Odds Ratio"
                                                       ],
                                           "explain":  "Correct: It measures new cases in a specific outbreak period.",
                                           "chapter":  "ch4"
                                       },
                                       {
                                           "q":  "Which is best for determining the \u0027burden\u0027 of disease for resource planning?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 4",
                                           "options":  [
                                                           "Incidence",
                                                           "Prevalence",
                                                           "Case Fatality",
                                                           "Risk Ratio"
                                                       ],
                                           "explain":  "Correct: Prevalence shows how many people need care right now.",
                                           "chapter":  "ch4"
                                       },
                                       {
                                           "q":  "Which is best for identifying the Cause (Etiology) of a disease?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 4",
                                           "options":  [
                                                           "Incidence",
                                                           "Prevalence",
                                                           "Mortality",
                                                           "Count"
                                                       ],
                                           "explain":  "Correct: Incidence tracks new cases, linking them directly to recent exposures.",
                                           "chapter":  "ch4"
                                       },
                                       {
                                           "q":  "Which question is MOST clearly a question for descriptive epidemiology?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 1",
                                           "options":  [
                                                           "Do students who eat salad have a higher risk of food poisoning than those who do not?",
                                                           "What is the attack rate of vomiting among students who ate lunch in the cafeteria on Monday?",
                                                           "Does drinking unpasteurized milk cause more Salmonella infections?",
                                                           "Is there an association between pet ownership and asthma?"
                                                       ],
                                           "explain":  "Correct (B): Descriptive epidemiology describes the amount and pattern of disease in terms of person, place, and time without testing a cause. Calculating an attack rate in a defined group on a specific day is describing distribution.\r\nA, C, D: All compare exposed vs unexposed groups and ask if an exposure changes risk ? analytic epidemiology.\r\nExam frequency: High.\r\nExam tip: If there is a comparison of two groups (exposed vs not), it is almost always analytic, not descriptive.",
                                           "chapter":  "ch1"
                                       },
                                       {
                                           "q":  "Which situation BEST shows epidemiologists focusing on populations rather than individuals?",
                                           "answer":  2,
                                           "type":  "mc",
                                           "topic":  "Chapter 1",
                                           "options":  [
                                                           "A doctor adjusting the medication dose for one child with asthma.",
                                                           "A nurse teaching one patient how to use an inhaler correctly.",
                                                           "A team studying asthma rates in different neighborhoods of a city.",
                                                           "A pharmacist checking drug interactions for a single prescription."
                                                       ],
                                           "explain":  "Correct (C): Comparing asthma rates between neighborhoods is a population-level question ? classic epidemiology.\r\nA, B, D: All focus on individual patient care (clinical medicine, nursing, pharmacy).\r\nExam frequency: Medium.\r\nExam tip: Population comparisons or rates across groups almost always point to epidemiology.",
                                           "chapter":  "ch1"
                                       },
                                       {
                                           "q":  "Which of the following is LEAST likely to be considered a \"health-related state or event\" in epidemiology?",
                                           "answer":  3,
                                           "type":  "mc",
                                           "topic":  "Chapter 1",
                                           "options":  [
                                                           "Injuries from car crashes.",
                                                           "Asthma attacks in schoolchildren.",
                                                           "Use of seatbelts among drivers.",
                                                           "Favorite ice cream flavors among students."
                                                       ],
                                           "explain":  "Correct (D): Favorite ice cream flavor is not directly health-related. It could be studied, but it is not a typical outcome in Disease Detectives.\r\nA, B, C: Injuries, asthma, and safety behaviors are all common health-related states/events.\r\nExam frequency: Low-medium (but easy points).\r\nExam tip: Health-related includes diseases, injuries, behaviors, and even positive states like wellness-but not random preferences.",
                                           "chapter":  "ch1"
                                       },
                                       {
                                           "q":  "What is the BEST definition of the incubation period?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 2",
                                           "options":  [
                                                           "Time from infection until a person becomes infectious.",
                                                           "Time between exposure and onset of symptoms.",
                                                           "Time from symptoms to recovery.",
                                                           "Time between recovery and reinfection."
                                                       ],
                                           "explain":  "Correct (B): Classic definition - exposure ? symptoms.\r\nA: Infectiousness timing = latent period.\r\nC/D: Irrelevant to incubation.",
                                           "chapter":  "ch2"
                                       },
                                       {
                                           "q":  "Which sequence is correct?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 2",
                                           "options":  [
                                                           "Susceptibility ? clinical ? recovery",
                                                           "Exposure ? incubation ? symptoms ? outcome",
                                                           "Outcome ? incubation",
                                                           "Clinical ? exposure"
                                                       ],
                                           "explain":  "Correct (B): Classic natural history timeline.",
                                           "chapter":  "ch2"
                                       },
                                       {
                                           "q":  "Wearing a bike helmet is:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 2",
                                           "options":  [
                                                           "Primary prevention",
                                                           "Secondary",
                                                           "Tertiary",
                                                           "Quaternary"
                                                       ],
                                           "explain":  "Correct (A): Prevent injury before occurrence.",
                                           "chapter":  "ch2"
                                       },
                                       {
                                           "q":  "Primary prevention is MOST effective:",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 2",
                                           "options":  [
                                                           "After symptoms",
                                                           "Before exposure",
                                                           "During subclinical",
                                                           "After recovery"
                                                       ],
                                           "explain":  "Correct (B): Prevent before exposure.",
                                           "chapter":  "ch2"
                                       },
                                       {
                                           "q":  "A measles case enters a school where 97% of students are vaccinated. Which host factor matters most?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 3",
                                           "options":  [
                                                           "Age",
                                                           "Immunity",
                                                           "Nutrition",
                                                           "Genetics"
                                                       ],
                                           "explain":  "Correct (B): Host immunity is the critical factor.",
                                           "chapter":  "ch3"
                                       },
                                       {
                                           "q":  "Lead poisoning in children is caused by:",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 3",
                                           "options":  [
                                                           "Infectious agent",
                                                           "Chemical agent",
                                                           "Biological vector",
                                                           "Physical environment"
                                                       ],
                                           "explain":  "Correct (B). Chemical toxins = agents.",
                                           "chapter":  "ch3"
                                       },
                                       {
                                           "q":  "Primary reservoir for rabies in much of the U.S.?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 3",
                                           "options":  [
                                                           "Mosquitoes",
                                                           "Bats",
                                                           "Dirty water",
                                                           "Humans"
                                                       ],
                                           "explain":  "Correct (B).",
                                           "chapter":  "ch3"
                                       },
                                       {
                                           "q":  "A student gets pinkeye after touching their eye immediately after handling a shared pencil used by an infected classmate. What is the mode of transmission?",
                                           "answer":  2,
                                           "type":  "mc",
                                           "topic":  "Chapter 4",
                                           "options":  [
                                                           "Droplet",
                                                           "Airborne",
                                                           "Indirect contact (fomite)",
                                                           "Vehicle-borne"
                                                       ],
                                           "explain":  "Correct: Indirect contact via fomite. Trap: Students confuse shared objects with droplets.",
                                           "chapter":  "ch4"
                                       },
                                       {
                                           "q":  "Which is vehicle-borne, not fomite?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 4",
                                           "options":  [
                                                           "Salmonella from chicken salad",
                                                           "MRSA from shoulder pads",
                                                           "Pinkeye from makeup brush",
                                                           "Impetigo from mats"
                                                       ],
                                           "explain":  "Correct: Food/water are vehicles.",
                                           "chapter":  "ch4"
                                       },
                                       {
                                           "q":  "Poor ventilation + coughing ? influenza in nearby students. Mode?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 4",
                                           "options":  [
                                                           "Airborne",
                                                           "Droplet",
                                                           "Indirect contact",
                                                           "Vehicle"
                                                       ],
                                           "explain":  "Correct: Droplet. Ventilation is environment, not a mode.",
                                           "chapter":  "ch4"
                                       },
                                       {
                                           "q":  "Why is surveillance necessary?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 5",
                                           "options":  [
                                                           "To treat patients effectively",
                                                           "To monitor trends, detect outbreaks, and guide control measures",
                                                           "To inspect hospitals",
                                                           "To determine exact causes of every disease"
                                                       ],
                                           "explain":  "Correct: B. Core surveillance function.",
                                           "chapter":  "ch5"
                                       },
                                       {
                                           "q":  "Which is TRUE about reportable diseases?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 5",
                                           "options":  [
                                                           "All diseases are reportable",
                                                           "States determine which diseases must be reported",
                                                           "Federal government mandates one list",
                                                           "Only infectious diseases are reportable"
                                                       ],
                                           "explain":  "Correct: B. States define lists.",
                                           "chapter":  "ch5"
                                       },
                                       {
                                           "q":  "EHR systems automatically sending reportable cases is:",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 5",
                                           "options":  [
                                                           "Active surveillance",
                                                           "Passive-enhanced (automated)",
                                                           "Sentinel",
                                                           "Syndromic"
                                                       ],
                                           "explain":  "Correct: B. Automated ? active.",
                                           "chapter":  "ch5"
                                       },
                                       {
                                           "q":  "On January 1, a school of 400 students has 20 currently sick with flu. What is the prevalence?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 6",
                                           "options":  [
                                                           "20/400",
                                                           "20/380",
                                                           "400/20",
                                                           "Cannot calculate"
                                                       ],
                                           "explain":  "Correct: Prevalence = existing cases / total population.",
                                           "chapter":  "ch6"
                                       },
                                       {
                                           "q":  "Why can prevalence increase even if incidence stays constant?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 6",
                                           "options":  [
                                                           "Recovery rate increases",
                                                           "Disease duration increases",
                                                           "Population decreases",
                                                           "More exposures occur"
                                                       ],
                                           "explain":  "Correct: Longer duration inflates prevalence.",
                                           "chapter":  "ch6"
                                       },
                                       {
                                           "q":  "Incidence of 10 per 100 per year means:",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 6",
                                           "options":  [
                                                           "Every student will get disease",
                                                           "10 new cases per 100 students yearly",
                                                           "10 sick at all times",
                                                           "10% sick forever"
                                                       ],
                                           "explain":  "Correct: Rate of new cases.",
                                           "chapter":  "ch6"
                                       },
                                       {
                                           "q":  "Which measure most influenced by chronic disease duration?",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 6",
                                           "options":  [
                                                           "Incidence",
                                                           "Prevalence",
                                                           "Risk ratio",
                                                           "Attack rate"
                                                       ],
                                           "explain":  "Correct: Longer duration raises prevalence.",
                                           "chapter":  "ch6"
                                       }
                                   ],
                  "beginner":  [
                                   {
                                       "q":  "Which surveillance type involves the Health Department actively calling hospital staff to find new cases?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "Passive Surveillance",
                                                       "Active Surveillance",
                                                       "Syndromic Surveillance",
                                                       "Sentinel Surveillance"
                                                   ],
                                       "explain":  "Correct: Active surveillance involves health agencies reaching out to providers.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "The time interval between exposure to an infectious agent and the first appearance of symptoms is:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "Incubation Period",
                                                       "Latency Period",
                                                       "Communicable Period",
                                                       "Generation Time"
                                                   ],
                                       "explain":  "Correct: Incubation is Exposure -\u003e Symptoms.",
                                       "chapter":  "ch6"
                                   },
                                   {
                                       "q":  "In the Chain of Infection, a doorknob contaminated with flu virus is an example of:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Vector",
                                                       "Vehicle (Fomite)",
                                                       "Reservoir",
                                                       "Portal of Exit"
                                                   ],
                                       "explain":  "Correct: Fomites are inanimate vehicles.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "What is the BEST definition of epidemiology?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 1",
                                       "options":  [
                                                       "The study of how doctors treat sick patients in hospitals.",
                                                       "The study of the distribution and determinants of health-related states or events in specific populations, and the application of this study to control health problems.",
                                                       "The study of germs and how they cause disease in a laboratory.",
                                                       "The study of human anatomy and physiology."
                                                   ],
                                       "explain":  "Correct (B): This is the classic textbook/CDC definition and contains all key parts: distribution (who/where/when), determinants (why/how), populations (not individuals), and application (using findings to control problems).\r\nA: Focuses on treating individual patients ? clinical medicine, not epidemiology.\r\nC: Focuses on germs in a lab ? microbiology, only a slice of epidemiology.\r\nD: Anatomy and physiology are basic sciences about body structure and function, not population patterns.\r\nExam frequency: Very high. This definition is almost guaranteed somewhere.\r\nExam tip: Look for the combination of distribution + determinants + populations + control.",
                                       "chapter":  "ch1"
                                   },
                                   {
                                       "q":  "In epidemiology, \"distribution\" mainly refers to:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 1",
                                       "options":  [
                                                       "How germs spread inside one person.",
                                                       "Who is getting the disease, where, and when.",
                                                       "How doctors distribute medicines.",
                                                       "How many germs are in a single droplet."
                                                   ],
                                       "explain":  "Correct (B): Distribution = patterns of disease by person (age, sex, etc.), place (where), and time (when).\r\nA: Within-one-person spread is pathophysiology, not population distribution.\r\nC: That is pharmacy/clinical logistics.\r\nD: Lab measurement, not population distribution.\r\nExam frequency: Medium-high.\r\nExam tip: Whenever you see person/place/time ? think distribution.",
                                       "chapter":  "ch1"
                                   },
                                   {
                                       "q":  "Which of the following is a typical USE of epidemiology?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 1",
                                       "options":  [
                                                       "Choosing the best treatment for a specific patient.",
                                                       "Finding out whether a new vaccine reduces the risk of disease in a population.",
                                                       "Designing the blueprint for a new hospital building.",
                                                       "Learning the names of all bacteria that cause disease."
                                                   ],
                                       "explain":  "Correct (B): Evaluating whether a vaccine reduces disease risk in a population is a core use of epidemiology.\r\nA: Individual treatment choice is clinical medicine.\r\nC: Building design is architecture/engineering, not epidemiology.\r\nD: Listing bacteria is microbiology.\r\nExam frequency: Medium.\r\nExam tip: Uses of epi often involve evaluating interventions, describing patterns, or identifying risk factors.",
                                       "chapter":  "ch1"
                                   },
                                   {
                                       "q":  "Which pair correctly matches the field with its MAIN focus?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 1",
                                       "options":  [
                                                       "Clinical medicine - patterns in populations",
                                                       "Epidemiology - patterns and causes in populations",
                                                       "Microbiology - choosing public health policies",
                                                       "Pathology - designing community intervention programs"
                                                   ],
                                       "explain":  "Correct (B): Epidemiology focuses on distribution and determinants of health events in populations.\r\nA: Clinical medicine focuses on diagnosis and treatment of individuals.\r\nC: Microbiology studies organisms (bacteria, viruses), not policies.\r\nD: Pathology studies disease mechanisms in tissues, not community programs.\r\nExam frequency: Medium.\r\nExam tip: Always separate \"individual vs population\" in these comparisons.",
                                       "chapter":  "ch1"
                                   },
                                   {
                                       "q":  "A child infected with hepatitis A has no symptoms but spreads infection. This is:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 2",
                                       "options":  [
                                                       "Incubation",
                                                       "Subclinical",
                                                       "Latent",
                                                       "Carrier only"
                                                   ],
                                       "explain":  "Correct (B): Subclinical = infected + asymptomatic + may transmit.",
                                       "chapter":  "ch2"
                                   },
                                   {
                                       "q":  "A mild symptomatic COVID infection represents:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 2",
                                       "options":  [
                                                       "Preclinical",
                                                       "Clinical (mild)",
                                                       "Subclinical",
                                                       "Carrier"
                                                   ],
                                       "explain":  "Correct (B): Symptoms ? clinical disease.",
                                       "chapter":  "ch2"
                                   },
                                   {
                                       "q":  "Return to full health is:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 2",
                                       "options":  [
                                                       "Exposure window",
                                                       "Recovery/convalescence",
                                                       "Latent",
                                                       "Susceptible"
                                                   ],
                                       "explain":  "Correct (B).",
                                       "chapter":  "ch2"
                                   },
                                   {
                                       "q":  "A farmer develops leptospirosis after swimming in a pond contaminated by animal urine. What triad element is the pond?",
                                       "answer":  2,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Host",
                                                       "Agent",
                                                       "Environment",
                                                       "Vector"
                                                   ],
                                       "explain":  "Correct (C): The pond represents the environment. Trap: Water is not a vector.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "Which is the correct infection chain order?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Portal entry ? portal exit ? reservoir",
                                                       "Reservoir ? portal exit ? mode ? portal entry ? host",
                                                       "Host ? agent ? environment",
                                                       "Environment ? host ? agent ? vector"
                                                   ],
                                       "explain":  "Correct (B): Canonical chain sequence.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "Which is an environmental factor?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Bacteria on a cutting board",
                                                       "Overcrowded dormitory",
                                                       "Shared pencil",
                                                       "Sneezing"
                                                   ],
                                       "explain":  "Correct (B): Overcrowding = environment; cutting board = fomite.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "Vomiting in norovirus acts as a:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Mode",
                                                       "Portal of exit",
                                                       "Reservoir",
                                                       "Portal of entry"
                                                   ],
                                       "explain":  "Correct (B): Vomiting enables exit; droplets = later mode.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "Campers develop fever after tick bites. What is the mode?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 4",
                                       "options":  [
                                                       "Vehicle-borne",
                                                       "Vector-borne",
                                                       "Droplet",
                                                       "Airborne"
                                                   ],
                                       "explain":  "Correct: Vector-borne.",
                                       "chapter":  "ch4"
                                   },
                                   {
                                       "q":  "Ringworm after wrestling (skin-to-skin). What is the mode?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 4",
                                       "options":  [
                                                       "Indirect",
                                                       "Direct",
                                                       "Droplet",
                                                       "Airborne"
                                                   ],
                                       "explain":  "Correct: Direct contact.",
                                       "chapter":  "ch4"
                                   },
                                   {
                                       "q":  "Public health surveillance is best defined as:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "Tracking individual patients in hospitals",
                                                       "Continuous, systematic collection, analysis, and interpretation of health data",
                                                       "A one-time survey of disease rates",
                                                       "Lab testing of bacteria and viruses"
                                                   ],
                                       "explain":  "Correct: B. Requires continuous, systematic collection + analysis + interpretation + dissemination.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "Reporting fever + cough before confirmation is:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "Passive",
                                                       "Syndromic",
                                                       "Sentinel",
                                                       "Active"
                                                   ],
                                       "explain":  "Correct: B. Uses symptom clusters.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "A spike in ER vomiting visits most clearly shows:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "Passive surveillance failure",
                                                       "Potential outbreak signal",
                                                       "Better lab reporting",
                                                       "Data error"
                                                   ],
                                       "explain":  "Correct: B. Surveillance detects anomalies.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "Surveillance differs from outbreak investigation because surveillance is:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "One-time and targeted",
                                                       "Ongoing and population-based",
                                                       "Only used during outbreaks",
                                                       "Focused on lab confirmation"
                                                   ],
                                       "explain":  "Correct: B. Ongoing system vs focused investigation.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "A survey asks, \"Do you currently have asthma symptoms?\" This measures:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "Period prevalence",
                                                       "Point prevalence",
                                                       "Incidence",
                                                       "Attack rate"
                                                   ],
                                       "explain":  "Correct: \u0027Currently\u0027 = point prevalence.",
                                       "chapter":  "ch6"
                                   },
                                   {
                                       "q":  "Which situation uses attack rate correctly?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "Diabetes diagnoses yearly",
                                                       "Illness in defined group during outbreak",
                                                       "Lifetime cancer risk",
                                                       "Injuries per 10k"
                                                   ],
                                       "explain":  "Correct: Outbreak measure.",
                                       "chapter":  "ch6"
                                   },
                                   {
                                       "q":  "Which describes incidence rate, not proportion?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "10 new cases per 100",
                                                       "2 cases per 100 person-years",
                                                       "5 new cases per semester",
                                                       "25% sick"
                                                   ],
                                       "explain":  "Correct: Rate must include time.",
                                       "chapter":  "ch6"
                                   }
                               ],
                  "advanced":  [
                                   {
                                       "q":  "Which of the following BEST represents a \"determinant\" in epidemiology?",
                                       "answer":  2,
                                       "type":  "mc",
                                       "topic":  "Chapter 1",
                                       "options":  [
                                                       "Weekly number of new COVID-19 cases in a county.",
                                                       "The age distribution of all residents in a city.",
                                                       "Exposure to contaminated well water used for drinking.",
                                                       "The shape of the epidemic curve for a measles outbreak."
                                                   ],
                                       "explain":  "Correct (C): A determinant is any factor that increases or decreases the risk of a health event. Contaminated well water is a clear exposure that can cause disease.\r\nA: Number of new cases = measure of frequency, not a determinant.\r\nB: Age distribution is a person characteristic used to describe distribution; it can modify risk but by itself is not a specific exposure.\r\nD: Epidemic curve shape is a descriptive visualization of time pattern, not a determinant.\r\nExam frequency: Medium.\r\nExam tip: Determinants are about WHY or WHAT CAUSES disease (risk factors, exposures).",
                                       "chapter":  "ch1"
                                   },
                                   {
                                       "q":  "Which question BEST fits the PUBLIC HEALTH APPROACH sequence (problem ? cause ? strategy ? action)?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 1",
                                       "options":  [
                                                       "How many students are in the school band?",
                                                       "How can we reduce asthma attacks among students living near a busy road by changing traffic or air quality?",
                                                       "What is the scientific name of the bacteria that cause strep throat?",
                                                       "Which brand of cough syrup works fastest in one specific patient?"
                                                   ],
                                       "explain":  "Correct (B): This asks about reducing asthma (problem), links to air pollution (cause), and considers strategies (changing traffic/air quality) ? full public health approach.\r\nA: Pure counting; not about a health problem.\r\nC: Microbiology, not full public health approach.\r\nD: Individual treatment decision, not population-level strategy.\r\nExam frequency: Medium.\r\nExam tip: The public health approach always includes both understanding causes AND applying a control strategy.",
                                       "chapter":  "ch1"
                                   },
                                   {
                                       "q":  "A study measures how many students in each grade have had chickenpox and maps the rates by classroom. Which TWO main tasks of epidemiology does this MOST directly represent?",
                                       "answer":  3,
                                       "type":  "mc",
                                       "topic":  "Chapter 1",
                                       "options":  [
                                                       "Distribution and clinical treatment",
                                                       "Determinants and anatomy",
                                                       "Distribution and application to control",
                                                       "Distribution only"
                                                   ],
                                       "explain":  "Correct (D): This study only describes who has had chickenpox and where (grades/classrooms). It does not test causes or apply control.\r\nA: No treatment is mentioned.\r\nB: Anatomy is irrelevant.\r\nC: No control strategy is being applied-only measurement.\r\nExam frequency: Medium.\r\nExam tip: Many questions try to trick you into thinking any epidemiology work automatically applies control-look for actual interventions.",
                                       "chapter":  "ch1"
                                   },
                                   {
                                       "q":  "Which of these research questions is MOST clearly analytic epidemiology?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 1",
                                       "options":  [
                                                       "What is the average age of students who got flu this semester?",
                                                       "Did students who attended the winter dance have a higher risk of flu than those who did not attend?",
                                                       "During which month did most flu cases occur?",
                                                       "In which grade were the most flu cases reported?"
                                                   ],
                                       "explain":  "Correct (B): It compares risk between exposed (dance) and unexposed groups, testing a causal hypothesis.\r\nA, C, D: All describe who/where/when (descriptive), with no comparison of exposure vs non-exposure.\r\nExam frequency: Very high.\r\nExam tip: Analytic = presence of a clear comparison group and a cause-effect question.",
                                       "chapter":  "ch1"
                                   },
                                   {
                                       "q":  "Which statement about the relationship between epidemiology and public health is MOST accurate?",
                                       "answer":  2,
                                       "type":  "mc",
                                       "topic":  "Chapter 1",
                                       "options":  [
                                                       "Epidemiology is only used after public health actions are finished.",
                                                       "Public health decisions are made without using epidemiologic data.",
                                                       "Epidemiology provides data and evidence that guide public health decisions and policies.",
                                                       "Epidemiology focuses only on lab testing and does not affect real-world actions."
                                                   ],
                                       "explain":  "Correct (C): Epidemiology supplies the evidence base (data on who/where/when/why) that public health officials use to plan and evaluate interventions.\r\nA: Wrong order-epi is used before, during, and after actions.\r\nB: False; decisions that ignore data are poor public health.\r\nD: Lab work is one tool, but epidemiology is directly connected to real-world control.\r\nExam frequency: Medium.\r\nExam tip: When in doubt, link epidemiology ? evidence; public health ? action.",
                                       "chapter":  "ch1"
                                   },
                                   {
                                       "q":  "A point-source outbreak occurred at noon May 10. Onsets on May 11, 12, 13. What is the incubation period range?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 2",
                                       "options":  [
                                                       "12-48 hours",
                                                       "24-72 hours",
                                                       "48-96 hours",
                                                       "Cannot be estimated"
                                                   ],
                                       "explain":  "Correct (B): 24h ? 72h window.\r\nTrap: Students erroneously add full calendar days.",
                                       "chapter":  "ch2"
                                   },
                                   {
                                       "q":  "Screening detects scoliosis in which stage?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 2",
                                       "options":  [
                                                       "Preclinical",
                                                       "Clinical",
                                                       "Susceptible",
                                                       "Recovery"
                                                   ],
                                       "explain":  "Correct (A): Screening targets disease before symptoms.",
                                       "chapter":  "ch2"
                                   },
                                   {
                                       "q":  "Which describes the latent period?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 2",
                                       "options":  [
                                                       "Time from infection until infectious",
                                                       "Time from infection to symptoms",
                                                       "Time from symptoms to recovery",
                                                       "Time after recovery"
                                                   ],
                                       "explain":  "Correct (A): Latent ? incubation.",
                                       "chapter":  "ch2"
                                   },
                                   {
                                       "q":  "Food served 1 PM; onsets 4 PM, 7 PM, 10 PM ? incubation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 2",
                                       "options":  [
                                                       "3-9 hours",
                                                       "1-2 hours",
                                                       "6-12 hours",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Correct (A): Consistent with short-incubation toxins.",
                                       "chapter":  "ch2"
                                   },
                                   {
                                       "q":  "Which pairing is correct?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 2",
                                       "options":  [
                                                       "Susceptibility - before exposure",
                                                       "Exposure - recovery",
                                                       "Preclinical - symptom onset",
                                                       "Clinical - asymptomatic"
                                                   ],
                                       "explain":  "Correct (A).",
                                       "chapter":  "ch2"
                                   },
                                   {
                                       "q":  "Detecting lead exposure before symptoms =",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 2",
                                       "options":  [
                                                       "Secondary prevention",
                                                       "Tertiary",
                                                       "Treatment",
                                                       "None"
                                                   ],
                                       "explain":  "Correct (A): Screening = secondary.",
                                       "chapter":  "ch2"
                                   },
                                   {
                                       "q":  "Chemical exposure Mon 2 PM; onsets Tues 10 AM, Tues 1 PM, Wed 8 AM. Incubation window?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 2",
                                       "options":  [
                                                       "20-42 hours",
                                                       "10-24 hours",
                                                       "5-12 hours",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Correct (A): Earliest 20h; latest 42h.",
                                       "chapter":  "ch2"
                                   },
                                   {
                                       "q":  "Various severities + asymptomatic cases describes:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 2",
                                       "options":  [
                                                       "Spectrum of disease",
                                                       "Epicurve",
                                                       "Natural timeline",
                                                       "Sensitivity"
                                                   ],
                                       "explain":  "Correct (A): Full severity range = spectrum.",
                                       "chapter":  "ch2"
                                   },
                                   {
                                       "q":  "A cafeteria stops an outbreak by requiring handwashing before food prep. Which chain link was broken?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Reservoir",
                                                       "Portal of exit",
                                                       "Mode of transmission",
                                                       "Portal of entry"
                                                   ],
                                       "explain":  "Correct (B): Prevents the agent from leaving the infected worker. Trap: Students pick mode incorrectly.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "Lead contamination affects children in an old apartment building. Lead represents the:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Agent",
                                                       "Host",
                                                       "Environment",
                                                       "Vector"
                                                   ],
                                       "explain":  "Correct (A): Chemical exposures count as agents. Trap: Students think only microbes qualify.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "Campylobacter cases occur only among campers who handled raw chicken and didn\u0027t wash hands. Which links are involved?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Reservoir + portal of entry",
                                                       "Portal exit + vector",
                                                       "Mode + host",
                                                       "Environment + vector"
                                                   ],
                                       "explain":  "Correct (A): Raw chicken = reservoir; ingestion = portal of entry.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "Coronavirus outbreak: cough droplets contaminate surfaces ? students touch ? infection. Mode?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Droplet + indirect contact",
                                                       "Airborne",
                                                       "Vehicle",
                                                       "Direct contact"
                                                   ],
                                       "explain":  "Correct (A): Mixed droplet + fomite pathway. Trap: Not airborne.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "Warm winter causes rodent reservoirs to increase. Which triad element changed?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Environment",
                                                       "Host",
                                                       "Agent",
                                                       "Vector"
                                                   ],
                                       "explain":  "Correct (A): Climate affecting reservoir levels is environmental.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "Two students exposed to same influenza strain; one sick, one not. Which triad link explains difference?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Host",
                                                       "Agent",
                                                       "Environment",
                                                       "Vector"
                                                   ],
                                       "explain":  "Correct (A): Host immunity governs susceptibility.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "Helminth-endemic group shows mild disease due to long-term immunity. Triad element?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Host",
                                                       "Agent",
                                                       "Environment",
                                                       "Reservoir"
                                                   ],
                                       "explain":  "Correct (A): Host adaptation modifies severity.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "Hospital reduces MRSA via handwashing, disinfection, isolation. Which links broken?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 3",
                                       "options":  [
                                                       "Portal exit + mode + environment",
                                                       "Reservoir",
                                                       "Portal entry",
                                                       "Host"
                                                   ],
                                       "explain":  "Correct (A): Multi-link disruption.",
                                       "chapter":  "ch3"
                                   },
                                   {
                                       "q":  "During choir practice, multiple people seated \u003e20 ft apart develop measles. What is the most likely mode?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 4",
                                       "options":  [
                                                       "Airborne",
                                                       "Droplet",
                                                       "Indirect contact",
                                                       "Vehicle-borne"
                                                   ],
                                       "explain":  "Correct: Measles is airborne. Trap: Distance reveals the true mode.",
                                       "chapter":  "ch4"
                                   },
                                   {
                                       "q":  "At a party, a sick person vomits; droplets land on food; guests eat contaminated food. Which modes occurred?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 4",
                                       "options":  [
                                                       "Droplet + vehicle-borne",
                                                       "Droplet + airborne",
                                                       "Airborne + vector",
                                                       "Direct + indirect contact"
                                                   ],
                                       "explain":  "Correct: Droplet contamination ? vehicle transmission.",
                                       "chapter":  "ch4"
                                   },
                                   {
                                       "q":  "Which statement is incorrect?",
                                       "answer":  3,
                                       "type":  "mc",
                                       "topic":  "Chapter 4",
                                       "options":  [
                                                       "Airborne involves droplet nuclei",
                                                       "Droplet requires close range",
                                                       "Vehicles include food/water",
                                                       "Fomites include mosquitoes and ticks"
                                                   ],
                                       "explain":  "Correct: D is incorrect. Mosquitoes/ticks = vectors.",
                                       "chapter":  "ch4"
                                   },
                                   {
                                       "q":  "Legionnaires\u0027 disease among hot tub users. Mode?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 4",
                                       "options":  [
                                                       "Vehicle (aerosolized water)",
                                                       "Airborne like measles",
                                                       "Droplet",
                                                       "Indirect contact"
                                                   ],
                                       "explain":  "Correct: Vehicle-borne (aerosolized water). Trap: Not airborne.",
                                       "chapter":  "ch4"
                                   },
                                   {
                                       "q":  "Which disease is correctly matched with its dominant mode?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 4",
                                       "options":  [
                                                       "Tuberculosis ? airborne",
                                                       "COVID-19 ? vector-borne",
                                                       "Lyme disease ? droplet",
                                                       "Influenza ? vehicle-borne"
                                                   ],
                                       "explain":  "Correct: TB is airborne. Others are incorrect.",
                                       "chapter":  "ch4"
                                   },
                                   {
                                       "q":  "Which scenario represents active surveillance?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "Clinics voluntarily submit weekly flu reports",
                                                       "Health department staff call hospitals for updated case counts",
                                                       "Labs automatically report positive results",
                                                       "Doctors report only unusual diseases"
                                                   ],
                                       "explain":  "Correct: B. Active = health department initiates contact. Trap: Automated lab reports are passive-enhanced.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "A pediatric clinic reports weekly ILI cases to serve as an early warning system. This is:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "Sentinel surveillance",
                                                       "Active",
                                                       "Syndromic",
                                                       "Passive"
                                                   ],
                                       "explain":  "Correct: A. Selected sites give high-quality data; not population wide.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "Which is a weakness of passive surveillance?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "Underreporting",
                                                       "High cost",
                                                       "Hard to scale",
                                                       "Too much health dept staff"
                                                   ],
                                       "explain":  "Correct: A. Passive is cheap but incomplete.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "Syndromic surveillance is typically:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "More sensitive but less specific",
                                                       "More specific but less sensitive",
                                                       "Highly specific and sensitive",
                                                       "Neither"
                                                   ],
                                       "explain":  "Correct: A. Early detection ? high sensitivity, low specificity.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "Which measure assesses surveillance sensitivity?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "Proportion of actual cases captured",
                                                       "Ability to avoid false positives",
                                                       "Time from detection to reporting",
                                                       "Number of facilities included"
                                                   ],
                                       "explain":  "Correct: A. Sensitivity = captured Ã· true cases.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "Syndromic data show increased respiratory visits but low influenza positivity. Explanation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "Syndromic systems detect symptoms, not causes",
                                                       "Labs missed cases",
                                                       "Surveillance too specific",
                                                       "Public health overestimated risk"
                                                   ],
                                       "explain":  "Correct: A. High-yield distinction.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "ML detects unusual prescription patterns predicting a surge. This is:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "Syndromic",
                                                       "Passive",
                                                       "Sentinel",
                                                       "Not surveillance"
                                                   ],
                                       "explain":  "Correct: A. Uses precursors before diagnoses.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "Which combination gives earliest and broadest detection?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 5",
                                       "options":  [
                                                       "Syndromic + sentinel + lab-confirmed",
                                                       "Passive only",
                                                       "Sentinel only",
                                                       "Active only"
                                                   ],
                                       "explain":  "Correct: A. Integration maximizes coverage.",
                                       "chapter":  "ch5"
                                   },
                                   {
                                       "q":  "During February, 10 new flu cases occur among 380 students who were not sick Feb 1. Incidence proportion?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "10/380",
                                                       "10/400",
                                                       "10/20",
                                                       "380/10"
                                                   ],
                                       "explain":  "Correct: Incidence uses population at risk.",
                                       "chapter":  "ch6"
                                   },
                                   {
                                       "q":  "At a picnic of 100 students, 25 became sick. Attack rate?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "25%",
                                                       "4%",
                                                       "75%",
                                                       "40%"
                                                   ],
                                       "explain":  "Correct: 25/100.",
                                       "chapter":  "ch6"
                                   },
                                   {
                                       "q":  "Start of October: 950 disease-free. 25 new cases in October. Incidence for October?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "25/950",
                                                       "30/950",
                                                       "5/950",
                                                       "Cannot compute"
                                                   ],
                                       "explain":  "Correct: Only October cases included.",
                                       "chapter":  "ch6"
                                   },
                                   {
                                       "q":  "Food poisoning: Exposed=60, sick=24. Attack rate (exposed)?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "24/60",
                                                       "24/40",
                                                       "4/40",
                                                       "60/24"
                                                   ],
                                       "explain":  "Correct: 24/60 = 40%.",
                                       "chapter":  "ch6"
                                   },
                                   {
                                       "q":  "Prevalence ratio: A=10%, B=20%.",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "20/10 = 2",
                                                       "10/20 = 0.5",
                                                       "20/100",
                                                       "Cannot calculate"
                                                   ],
                                       "explain":  "Correct: Straight ratio.",
                                       "chapter":  "ch6"
                                   },
                                   {
                                       "q":  "Camp of 200: 50 currently with swimmer\u0027s itch. Prevalence?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "50/200",
                                                       "150/200",
                                                       "200/50",
                                                       "Cannot compute"
                                                   ],
                                       "explain":  "Correct: Existing cases / total.",
                                       "chapter":  "ch6"
                                   },
                                   {
                                       "q":  "30 new cases over 7,500 person-months. Incidence rate per 1,000 person-months?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "(30/7,500) Ã— 1,000",
                                                       "30/1,000",
                                                       "(7,500/30) Ã— 1,000",
                                                       "Cannot compute"
                                                   ],
                                       "explain":  "Correct: 4 per 1,000 person-months.",
                                       "chapter":  "ch6"
                                   },
                                   {
                                       "q":  "Short-duration disease: correct relationship?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 6",
                                       "options":  [
                                                       "Prevalence Ëœ incidence",
                                                       "Prevalence always higher",
                                                       "Incidence = prevalence Ã— duration",
                                                       "Prevalence = incidence Ã— duration"
                                                   ],
                                       "explain":  "Correct: Short duration collapses accumulation.",
                                       "chapter":  "ch6"
                                   }
                               ]
              },
    "part3":  {
                  "intermediate":  [
                                       {
                                           "q":  "Watery diarrhea + muscle cramps + contaminated water suggests:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 14",
                                           "options":  [
                                                           "Cholera",
                                                           "Tetanus",
                                                           "Rabies",
                                                           "Chickenpox"
                                                       ],
                                           "explain":  "Classic cholera symptoms.",
                                           "chapter":  "ch14"
                                       },
                                       {
                                           "q":  "Vomiting/diarrhea 12-48 hours after exposure suggests:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 14",
                                           "options":  [
                                                           "Norovirus",
                                                           "Hepatitis C",
                                                           "Influenza",
                                                           "Malaria"
                                                       ],
                                           "explain":  "Typical norovirus incubation.",
                                           "chapter":  "ch14"
                                       },
                                       {
                                           "q":  "A zoonotic disease is one that:",
                                           "answer":  1,
                                           "type":  "mc",
                                           "topic":  "Chapter 14",
                                           "options":  [
                                                           "Is airborne",
                                                           "Spreads animal ? human",
                                                           "Human ? animal only",
                                                           "Only via vectors"
                                                       ],
                                           "explain":  "Zoonosis = animal to human.",
                                           "chapter":  "ch14"
                                       },
                                       {
                                           "q":  "Students eat cream-filled pastries left unrefrigerated. Four hours later: vomiting, cramps, no fever. Cause?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 15",
                                           "options":  [
                                                           "Staphylococcal toxin",
                                                           "Norovirus",
                                                           "Salmonella",
                                                           "Influenza"
                                                       ],
                                           "explain":  "Short (=4 hr) onset + vomiting = Staph aureus pre-formed toxin.",
                                           "chapter":  "ch15"
                                       },
                                       {
                                           "q":  "Cases appear abruptly within 12 hrs after buffet. Pattern?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 15",
                                           "options":  [
                                                           "Point-source",
                                                           "Propagated",
                                                           "Continuous",
                                                           "Mixed"
                                                       ],
                                           "explain":  "Sudden cluster ? point source.",
                                           "chapter":  "ch15"
                                       },
                                       {
                                           "q":  "Campers who swam in Lake Bluewater show higher AR. Finding called:",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 15",
                                           "options":  [
                                                           "Association",
                                                           "Causation",
                                                           "Herd immunity",
                                                           "Validity"
                                                       ],
                                           "explain":  "Epi studies identify associations, not causation.",
                                           "chapter":  "ch15"
                                       },
                                       {
                                           "q":  "Diarrhea over 10 days in swimmers using under-chlorinated pool. Pattern?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 15",
                                           "options":  [
                                                           "Continuous source",
                                                           "Point-source",
                                                           "Propagated",
                                                           "Mixed"
                                                       ],
                                           "explain":  "Long period = continuous exposure.",
                                           "chapter":  "ch15"
                                       },
                                       {
                                           "q":  "Cluster of diarrhea after shared water cooler. Mode?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 16",
                                           "options":  [
                                                           "Vehicle-borne",
                                                           "Airborne",
                                                           "Vector-borne",
                                                           "Fomite"
                                                       ],
                                           "explain":  "Contaminated drink = vehicle.",
                                           "chapter":  "ch16"
                                       },
                                       {
                                           "q":  "8-day slow appearance among swimmers in low-chlorine pool. Pattern?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 16",
                                           "options":  [
                                                           "Continuous exposure",
                                                           "Point source",
                                                           "Propagated",
                                                           "Mixed"
                                                       ],
                                           "explain":  "Long duration ? continuous source.",
                                           "chapter":  "ch16"
                                       },
                                       {
                                           "q":  "Diarrhea after swimming in lake. Mode?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 16",
                                           "options":  [
                                                           "Waterborne",
                                                           "Droplet",
                                                           "Vector-borne",
                                                           "Airborne"
                                                       ],
                                           "explain":  "Lake ? waterborne.",
                                           "chapter":  "ch16"
                                       },
                                       {
                                           "q":  "Lunch event: 25 ate chicken (15 sick), 35 did not (5 sick). AR(exposed)?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 17",
                                           "options":  [
                                                           "15/25",
                                                           "5/35",
                                                           "20/60",
                                                           "25/15"
                                                       ],
                                           "explain":  "AR(exposed) = 15/25 = 60%.",
                                           "chapter":  "ch17"
                                       },
                                       {
                                           "q":  "Cases begin within 24 hrs after banquet, then stop. Pattern?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 17",
                                           "options":  [
                                                           "Point-source",
                                                           "Continuous source",
                                                           "Propagated",
                                                           "Mixed"
                                                       ],
                                           "explain":  "Sharp single peak ? point source.",
                                           "chapter":  "ch17"
                                       },
                                       {
                                           "q":  "Diarrhea cluster among users of specific water fountain. Mode?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 17",
                                           "options":  [
                                                           "Waterborne",
                                                           "Droplet",
                                                           "Airborne",
                                                           "Sexual transmission"
                                                       ],
                                           "explain":  "Localized water source.",
                                           "chapter":  "ch17"
                                       },
                                       {
                                           "q":  "Gradual increase over 3-4 days via close contact. Pattern?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 17",
                                           "options":  [
                                                           "Propagated",
                                                           "Point source",
                                                           "Continuous",
                                                           "Mixed"
                                                       ],
                                           "explain":  "Wave-like ? propagated.",
                                           "chapter":  "ch17"
                                       },
                                       {
                                           "q":  "Illness 30-48 hrs after burritos; diarrhea, fever, cramps. Organism?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 18",
                                           "options":  [
                                                           "Salmonella",
                                                           "Staph toxin",
                                                           "Influenza",
                                                           "Rabies"
                                                       ],
                                           "explain":  "Matches Salmonella profile.",
                                           "chapter":  "ch18"
                                       },
                                       {
                                           "q":  "Diarrhea only among students using a specific faucet. Mode?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 18",
                                           "options":  [
                                                           "Waterborne",
                                                           "Droplet",
                                                           "Fomite",
                                                           "Vector"
                                                       ],
                                           "explain":  "Localized water contamination.",
                                           "chapter":  "ch18"
                                       },
                                       {
                                           "q":  "Dorm outbreak rises gradually over days among roommates. Pattern?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 18",
                                           "options":  [
                                                           "Propagated",
                                                           "Point source",
                                                           "Waterborne",
                                                           "Chemical"
                                                       ],
                                           "explain":  "Person-to-person sustained spread.",
                                           "chapter":  "ch18"
                                       },
                                       {
                                           "q":  "Tournament lunch ARs: Pasta 20/60, Salad 18/40, Fruit cups 8/50. Strongest association?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 19",
                                           "options":  [
                                                           "Salad",
                                                           "Pasta",
                                                           "Fruit cups",
                                                           "All equal"
                                                       ],
                                           "explain":  "AR(salad)=45% ? highest.",
                                           "chapter":  "ch19"
                                       },
                                       {
                                           "q":  "Steady increase over 9 days among swimmers in poorly chlorinated pool. Pattern?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 19",
                                           "options":  [
                                                           "Continuous source",
                                                           "Point source",
                                                           "Propagated",
                                                           "Mixed"
                                                       ],
                                           "explain":  "Long exposure ? continuous source.",
                                           "chapter":  "ch19"
                                       },
                                       {
                                           "q":  "Vomiting?diarrhea, 12-48hr incubation, secondary household cases. Most likely?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 19",
                                           "options":  [
                                                           "Norovirus",
                                                           "Salmonella",
                                                           "Staph toxin",
                                                           "Hepatitis A"
                                                       ],
                                           "explain":  "Norovirus spreads easily.",
                                           "chapter":  "ch19"
                                       },
                                       {
                                           "q":  "Party: early vomiting (4-6 hr), later diarrhea (24-36 hr), no spread. Most likely?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 19",
                                           "options":  [
                                                           "Mixed foodborne outbreak",
                                                           "Pure norovirus",
                                                           "Pure Salmonella",
                                                           "Airborne"
                                                       ],
                                           "explain":  "Two incubation windows ? mixed.",
                                           "chapter":  "ch19"
                                       },
                                       {
                                           "q":  "12-48 hr incubation; vomiting ? diarrhea. Most likely pathogen?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 20",
                                           "options":  [
                                                           "Norovirus",
                                                           "Salmonella",
                                                           "Staph toxin",
                                                           "Influenza"
                                                       ],
                                           "explain":  "Vomiting-first, 12-48 hrs matches norovirus.",
                                           "chapter":  "ch20"
                                       },
                                       {
                                           "q":  "Pool with intermittent chlorination produces cases over 11 days. Pattern?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 20",
                                           "options":  [
                                                           "Continuous",
                                                           "Point-source",
                                                           "Mixed",
                                                           "Propagated"
                                                       ],
                                           "explain":  "Ongoing exposure = continuous.",
                                           "chapter":  "ch20"
                                       },
                                       {
                                           "q":  "4-6 day wave-like dorm spread. Pattern?",
                                           "answer":  0,
                                           "type":  "mc",
                                           "topic":  "Chapter 20",
                                           "options":  [
                                                           "Propagated",
                                                           "Point-source",
                                                           "Continuous",
                                                           "Fomite"
                                                       ],
                                           "explain":  "Close-contact wave spread ? propagated.",
                                           "chapter":  "ch20"
                                       }
                                   ],
                  "beginner":  [
                                   {
                                       "q":  "A student becomes ill 4 hours after eating food left out at room temperature. Most likely transmission?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Vehicle-borne (foodborne)",
                                                       "Airborne",
                                                       "Vector-borne",
                                                       "Person-to-person"
                                                   ],
                                       "explain":  "Short incubation + food ? pre-formed toxin ? vehicle-borne.",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Closing a kitchen after an outbreak is which type of prevention?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Primary",
                                                       "Secondary",
                                                       "Tertiary",
                                                       "Screening"
                                                   ],
                                       "explain":  "Primary = removing exposure source.",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Malaria spreads by:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Mosquito vector",
                                                       "Contaminated water",
                                                       "Aerosol",
                                                       "Person-to-person"
                                                   ],
                                       "explain":  "Mosquito transmitted.",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Fever + cough + rash starting on face and spreading down suggests:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Measles",
                                                       "Chickenpox",
                                                       "Norovirus",
                                                       "Salmonella"
                                                   ],
                                       "explain":  "Classic measles rash (cephalocaudal).",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Students vomit after drinking from unrefrigerated punch bowl. Vehicle?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 15",
                                       "options":  [
                                                       "The punch",
                                                       "The cups",
                                                       "Door handles",
                                                       "Classroom"
                                                   ],
                                       "explain":  "Vehicle = contaminated food/drink.",
                                       "chapter":  "ch15"
                                   },
                                   {
                                       "q":  "Influenza cluster after sick student attends class. Transmission mode?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 15",
                                       "options":  [
                                                       "Droplet",
                                                       "Vector",
                                                       "Airborne",
                                                       "Waterborne"
                                                   ],
                                       "explain":  "Influenza spreads by droplets.",
                                       "chapter":  "ch15"
                                   },
                                   {
                                       "q":  "Vomiting 24-48 hrs after hike sandwiches suggests:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 15",
                                       "options":  [
                                                       "Norovirus",
                                                       "Influenza",
                                                       "Hepatitis B",
                                                       "Rabies"
                                                   ],
                                       "explain":  "Norovirus incubation is 12-48 hrs.",
                                       "chapter":  "ch15"
                                   },
                                   {
                                       "q":  "Field trip lunch: 18 students sick in 12-24 hours. ARs: Pizza 10/50, Salad 16/40, Cookies 3/45. Most associated?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "Salad",
                                                       "Pizza",
                                                       "Cookies",
                                                       "All equal"
                                                   ],
                                       "explain":  "Salad has highest AR = 40% ? strongest association.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "Picnic: 20 ate melon (8 sick); 25 did not (5 sick). AR(exposed)?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "8/20",
                                                       "5/25",
                                                       "13/45",
                                                       "25/8"
                                                   ],
                                       "explain":  "AR(exposed) = 8/20 = 40%.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "24-36 hr onset after tacos; diarrhea, cramps, low fever. Most likely?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "Salmonella",
                                                       "Norovirus",
                                                       "Staph toxin",
                                                       "Influenza"
                                                   ],
                                       "explain":  "Salmonella matches timeline + symptoms.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "Sudden vomiting 8 hrs after party. Most likely?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "Point-source foodborne",
                                                       "Propagated",
                                                       "Continuous",
                                                       "Vector"
                                                   ],
                                       "explain":  "Short onset ? toxin foodborne.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "Vomiting 3-6 hrs after cafeteria party suggests:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 17",
                                       "options":  [
                                                       "Staph aureus toxin",
                                                       "Norovirus",
                                                       "Salmonella",
                                                       "Hepatitis A"
                                                   ],
                                       "explain":  "Short incubation ? Staph toxin.",
                                       "chapter":  "ch17"
                                   },
                                   {
                                       "q":  "Exposed AR = 15/30; Unexposed AR = 3/20. RR?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 17",
                                       "options":  [
                                                       "3.33",
                                                       "0.30",
                                                       "5.00",
                                                       "0.15"
                                                   ],
                                       "explain":  "RR = 0.50 / 0.15 = 3.33.",
                                       "chapter":  "ch17"
                                   },
                                   {
                                       "q":  "Vomiting + mild fever 24-48 hrs after eating suggests:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 17",
                                       "options":  [
                                                       "Norovirus",
                                                       "Influenza",
                                                       "Rabies",
                                                       "Staph toxin"
                                                   ],
                                       "explain":  "Norovirus incubation window.",
                                       "chapter":  "ch17"
                                   },
                                   {
                                       "q":  "Festival lunch: Pizza 12/60, Nachos 18/50, Lemonade 3/70. Strongest association?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "Nachos",
                                                       "Pizza",
                                                       "Lemonade",
                                                       "All equal"
                                                   ],
                                       "explain":  "Nachos AR = 36% ? highest.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "7-10 day rising cases among swimmers in low-chlorine pool. Pattern?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "Continuous source",
                                                       "Point source",
                                                       "Propagated",
                                                       "Mixed"
                                                   ],
                                       "explain":  "Long exposure ? continuous.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "Vomiting ? diarrhea; 12-36 hr incubation; secondary household cases. Most likely?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "Norovirus",
                                                       "Salmonella",
                                                       "Staph toxin",
                                                       "Influenza"
                                                   ],
                                       "explain":  "Norovirus spreads readily ? secondary cases.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "Party: vomiting 4-6 hrs; diarrhea 24-36 hrs; no secondary spread. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "Mixed foodborne outbreak",
                                                       "Propagated",
                                                       "Continuous",
                                                       "Pure norovirus"
                                                   ],
                                       "explain":  "Two incubation windows ? mixed outbreak.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "20-30 hr incubation; diarrhea + cramps + low fever. Pathogen?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 19",
                                       "options":  [
                                                       "Salmonella",
                                                       "Staph toxin",
                                                       "Norovirus",
                                                       "Influenza"
                                                   ],
                                       "explain":  "Classic Salmonella profile.",
                                       "chapter":  "ch19"
                                   },
                                   {
                                       "q":  "Diarrhea only in students using lower hallway fountain. Mode?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 19",
                                       "options":  [
                                                       "Waterborne",
                                                       "Airborne",
                                                       "Droplet",
                                                       "Vector"
                                                   ],
                                       "explain":  "Localized water contamination.",
                                       "chapter":  "ch19"
                                   },
                                   {
                                       "q":  "Dorm: gradual rise over 4-5 days via close contact. Pattern?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 19",
                                       "options":  [
                                                       "Propagated",
                                                       "Point source",
                                                       "Continuous",
                                                       "Mixed"
                                                   ],
                                       "explain":  "Person-to-person waves.",
                                       "chapter":  "ch19"
                                   },
                                   {
                                       "q":  "Conference lunch ARs: Pasta 30/70, Chicken 14/50, Fruit cups 10/60. Strongest association?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "Pasta",
                                                       "Chicken",
                                                       "Fruit cups",
                                                       "All equal"
                                                   ],
                                       "explain":  "Pasta AR = 43% ? highest signal.",
                                       "chapter":  "ch20"
                                   },
                                   {
                                       "q":  "Only students using right hallway fountain have diarrhea. Mode?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "Waterborne",
                                                       "Droplet",
                                                       "Airborne",
                                                       "Vector"
                                                   ],
                                       "explain":  "Localized fountain exposure = waterborne.",
                                       "chapter":  "ch20"
                                   },
                                   {
                                       "q":  "Vomiting?diarrhea; 14-36 hr incubation; sibling AR 45%. Pathogen?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "Norovirus",
                                                       "Salmonella",
                                                       "Staph toxin",
                                                       "Hepatitis A"
                                                   ],
                                       "explain":  "High secondary household transmission = norovirus.",
                                       "chapter":  "ch20"
                                   },
                                   {
                                       "q":  "Party: vomiting 4-6 hr, diarrhea 20-30 hr, no secondary spread. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "Mixed foodborne outbreak",
                                                       "Pure norovirus",
                                                       "Pure Salmonella",
                                                       "Airborne"
                                                   ],
                                       "explain":  "Two incubation windows = mixed outbreak.",
                                       "chapter":  "ch20"
                                   }
                               ],
                  "advanced":  [
                                   {
                                       "q":  "Which disease is airborne, not droplet?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Measles",
                                                       "Influenza",
                                                       "COVID-19 (typical spread)",
                                                       "Pertussis"
                                                   ],
                                       "explain":  "Measles is truly airborne and extremely contagious.",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Parotitis (swollen salivary glands) is characteristic of:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Mumps",
                                                       "Measles",
                                                       "Rubella",
                                                       "Norovirus"
                                                   ],
                                       "explain":  "Signature mumps sign.",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Treating a patient to prevent long-term complications is:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Tertiary prevention",
                                                       "Primary",
                                                       "Secondary",
                                                       "Environmental control"
                                                   ],
                                       "explain":  "Tertiary = reduce impact after disease.",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Students ate Monday noon; cases Tues 6 PM-Wed AM. Likely agent?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Bacterial toxin-mediated",
                                                       "Vector-borne",
                                                       "Airborne viral",
                                                       "Parasite"
                                                   ],
                                       "explain":  "18-36 hr ? bacterial foodborne (not pre-formed toxin).",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Which intervention interrupts the reservoir?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Treat infected individuals to eliminate carriage",
                                                       "Masks",
                                                       "Improve water sanitation",
                                                       "Close gatherings"
                                                   ],
                                       "explain":  "Removing reservoir = treating carriers.",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Handwashing breaks which link in chain of infection?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Mode of transmission",
                                                       "Susceptible host",
                                                       "Reservoir",
                                                       "Portal of entry"
                                                   ],
                                       "explain":  "Interrupts spread pathway.",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Sore throat + fever + sandpaper rash + positive strep suggests:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Scarlet fever",
                                                       "Rubella",
                                                       "Hepatitis A",
                                                       "Shigella"
                                                   ],
                                       "explain":  "Scarlet fever = strep + rash.",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Respiratory disease spreading by droplets with 1-4 day incubation is likely:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 14",
                                       "options":  [
                                                       "Influenza",
                                                       "Measles",
                                                       "TB",
                                                       "Rabies"
                                                   ],
                                       "explain":  "Influenza = droplet + short incubation.",
                                       "chapter":  "ch14"
                                   },
                                   {
                                       "q":  "Chicken salad eaten; onset 10-36 hrs; diarrhea + cramps + low fever. Most likely agent?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 15",
                                       "options":  [
                                                       "Salmonella",
                                                       "Staph aureus toxin",
                                                       "Norovirus",
                                                       "Hepatitis A"
                                                   ],
                                       "explain":  "10-36 hr range matches Salmonella/non-toxin bacterial illness.",
                                       "chapter":  "ch15"
                                   },
                                   {
                                       "q":  "Picnic: 40 ate potato salad (16 sick); 30 did not (3 sick). AR(exposed)?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 15",
                                       "options":  [
                                                       "16/40",
                                                       "3/30",
                                                       "19/70",
                                                       "40/16"
                                                   ],
                                       "explain":  "AR(exposed) = 16/40 = 40%.",
                                       "chapter":  "ch15"
                                   },
                                   {
                                       "q":  "Using picnic data: RR? (16/40 vs 3/30)",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 15",
                                       "options":  [
                                                       "4.0",
                                                       "0.25",
                                                       "0.10",
                                                       "0.40"
                                                   ],
                                       "explain":  "RR = 0.40 / 0.10 = 4.0.",
                                       "chapter":  "ch15"
                                   },
                                   {
                                       "q":  "Chicken wraps eaten at noon; cases 8 PM-2 AM; vomiting \u003e diarrhea. Cause?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 15",
                                       "options":  [
                                                       "Staph aureus toxin",
                                                       "Salmonella",
                                                       "Hepatitis A",
                                                       "Influenza"
                                                   ],
                                       "explain":  "Short incubation + vomiting-dominant ? Staph toxin.",
                                       "chapter":  "ch15"
                                   },
                                   {
                                       "q":  "Only students using Sink #4 (very cold water) have diarrhea. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 15",
                                       "options":  [
                                                       "Contaminated water source",
                                                       "Person-to-person",
                                                       "Vector",
                                                       "Droplet"
                                                   ],
                                       "explain":  "Local water contamination likely.",
                                       "chapter":  "ch15"
                                   },
                                   {
                                       "q":  "Best probable case definition for taco-day outbreak:",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 15",
                                       "options":  [
                                                       "Any diarrhea",
                                                       "Vomiting + ate tacos Friday",
                                                       "Anyone in school",
                                                       "Cramps only"
                                                   ],
                                       "explain":  "Probable = symptoms + exposure link.",
                                       "chapter":  "ch15"
                                   },
                                   {
                                       "q":  "Only students who ate bananas from same bowl are sick; contamination under peel. Cause?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 15",
                                       "options":  [
                                                       "Contaminated food surface/handling",
                                                       "Airborne viral",
                                                       "Vector bite",
                                                       "Droplet spread"
                                                   ],
                                       "explain":  "Bacterial contamination via handling.",
                                       "chapter":  "ch15"
                                   },
                                   {
                                       "q":  "Daycare: vomiting ? diarrhea; onset 14-30 hrs; secondary cases in siblings later. Most likely?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 15",
                                       "options":  [
                                                       "Mixed outbreak",
                                                       "Propagated",
                                                       "Point-source",
                                                       "Parasite"
                                                   ],
                                       "explain":  "Initial foodborne + secondary person-to-person spread.",
                                       "chapter":  "ch15"
                                   },
                                   {
                                       "q":  "Festival outbreak ARs: Hamburgers 12/80, Ice cream 22/30, Lemonade 14/60. Vehicle?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "Ice cream",
                                                       "Hamburgers",
                                                       "Lemonade",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Ice cream AR = 73% ? most likely vehicle.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "Wraps eaten at noon; onset 6 PM-4 AM; vomiting \u003e diarrhea. Likely cause?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "Staph toxin",
                                                       "Norovirus",
                                                       "Salmonella",
                                                       "Hepatitis A"
                                                   ],
                                       "explain":  "Short incubation + vomiting dominant ? Staph toxin.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "RR with AR(exposed)=40% and AR(unexposed)=20%?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "2.0",
                                                       "0.5",
                                                       "20%",
                                                       "60%"
                                                   ],
                                       "explain":  "RR = 0.40 / 0.20 = 2.0.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "Food event cluster within 24 hrs, then household cases after 2-3 days. Pattern?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "Mixed",
                                                       "Propagated",
                                                       "Continuous",
                                                       "Point source"
                                                   ],
                                       "explain":  "Foodborne initial cluster + secondary spread.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "Best probable case definition for pasta outbreak?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "Vomiting AND ate pasta Tuesday",
                                                       "Any vomiting",
                                                       "Any diarrhea",
                                                       "Any cafeteria student"
                                                   ],
                                       "explain":  "Probable = symptoms + exposure.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "AR(exp)=60%, AR(unexp)=15%. RR?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "4.0",
                                                       "0.25",
                                                       "15%",
                                                       "45%"
                                                   ],
                                       "explain":  "RR = 0.60 / 0.15 = 4.0.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "Cases only in students filling bottles from construction-area faucet. Cause?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "Local water contamination",
                                                       "Droplet",
                                                       "Person-to-person",
                                                       "Vector"
                                                   ],
                                       "explain":  "Localized environmental source.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "ARs: Fruit salad 14/50, Chicken bites 3/40, Chocolate milk 18/30. Source?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 16",
                                       "options":  [
                                                       "Chocolate milk",
                                                       "Fruit salad",
                                                       "Chicken bites",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Chocolate milk AR = 60% ? strongest association.",
                                       "chapter":  "ch16"
                                   },
                                   {
                                       "q":  "Potluck ARs: Pasta salad 14/40; Fruit cups 12/30; Brownies 5/50. Strongest association?",
                                       "answer":  1,
                                       "type":  "mc",
                                       "topic":  "Chapter 17",
                                       "options":  [
                                                       "Pasta salad",
                                                       "Fruit cups",
                                                       "Brownies",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Fruit cups AR = 40%, higher than pasta salad (35%).",
                                       "chapter":  "ch17"
                                   },
                                   {
                                       "q":  "Tacos eaten 12 PM; symptoms 4 AM next day (16 hrs); diarrhea first. Cause?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 17",
                                       "options":  [
                                                       "Salmonella",
                                                       "Norovirus",
                                                       "Staph toxin",
                                                       "Influenza"
                                                   ],
                                       "explain":  "16 hrs + diarrhea dominant ? Salmonella.",
                                       "chapter":  "ch17"
                                   },
                                   {
                                       "q":  "Banquet cases ? household cases 2 days later. Pattern?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 17",
                                       "options":  [
                                                       "Mixed",
                                                       "Point source",
                                                       "Continuous",
                                                       "Never mixed"
                                                   ],
                                       "explain":  "Foodborne initial + secondary spread.",
                                       "chapter":  "ch17"
                                   },
                                   {
                                       "q":  "AR punch 16%; AR macaroni 68%. All macaroni eaters drank punch. True vehicle?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 17",
                                       "options":  [
                                                       "Macaroni",
                                                       "Fruit punch",
                                                       "Both",
                                                       "Neither"
                                                   ],
                                       "explain":  "Punch is confounded by macaroni exposure.",
                                       "chapter":  "ch17"
                                   },
                                   {
                                       "q":  "Illness only in students using left spigot; right spigot users fine. Explanation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 17",
                                       "options":  [
                                                       "Left spigot contaminated",
                                                       "Entire water supply contaminated",
                                                       "Person-to-person",
                                                       "Airborne"
                                                   ],
                                       "explain":  "Localized contamination at single spigot.",
                                       "chapter":  "ch17"
                                   },
                                   {
                                       "q":  "Best probable case definition for multi-day burrito outbreak:",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 17",
                                       "options":  [
                                                       "Vomiting AND ate burrito Mon-Wed",
                                                       "Any vomiting",
                                                       "Any diarrhea",
                                                       "Any cafeteria visitor"
                                                   ],
                                       "explain":  "Probable = symptoms + exposure link.",
                                       "chapter":  "ch17"
                                   },
                                   {
                                       "q":  "Catered lunch: sandwiches 18/55 (12-hr onset); fruit cups 9/40 (24-48 hr onset). Interpret?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 17",
                                       "options":  [
                                                       "Two overlapping outbreaks",
                                                       "Fruit cups true source",
                                                       "Sandwiches true source",
                                                       "Bottled water source"
                                                   ],
                                       "explain":  "Two different incubation patterns ? two agents.",
                                       "chapter":  "ch17"
                                   },
                                   {
                                       "q":  "Macaroni meal: early vomiting cases (6-8 hr) + later diarrhea (18-36 hr), no secondary spread. Explanation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 17",
                                       "options":  [
                                                       "Two agents in same meal",
                                                       "Pure norovirus",
                                                       "Pure Salmonella",
                                                       "Propagated outbreak"
                                                   ],
                                       "explain":  "Distinct incubation and symptoms ? dual-agent foodborne outbreak.",
                                       "chapter":  "ch17"
                                   },
                                   {
                                       "q":  "Picnic: Watermelon 10/30, Sandwiches 20/40, but all sick watermelon eaters also ate sandwiches. Source?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "Sandwiches",
                                                       "Watermelon",
                                                       "Both",
                                                       "Neither"
                                                   ],
                                       "explain":  "Watermelon exposure nested inside sandwich exposure ? sandwiches true vehicle.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "Dinner 6 PM; onset 4-30 hrs; early vomiting + later diarrhea; no secondary cases. Explanation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "Two agents in same meal",
                                                       "Single norovirus",
                                                       "Single Salmonella",
                                                       "Propagated outbreak"
                                                   ],
                                       "explain":  "Bimodal incubation + symptoms ? dual agents.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "Camp: 30 ate chili (18 sick); 40 did not (6 sick). RR?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "4.0",
                                                       "3.0",
                                                       "2.0",
                                                       "1.0"
                                                   ],
                                       "explain":  "RR = (18/30)/(6/40) = 0.60/0.15 = 4.0.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "6th graders eat at 10:30 AM; 7th graders at 12:30 PM. Two peaks but identical incubation. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "Single food source with staggered exposure",
                                                       "Two outbreaks",
                                                       "Only 6th graders affected",
                                                       "Only 7th graders affected"
                                                   ],
                                       "explain":  "Same exposure, different meal times ? false two-peak illusion.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "Potluck: Pasta 14/40, Brownies 12/30, Salad 22/25, salad served by ill volunteer. Vehicle?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "Salad",
                                                       "Pasta",
                                                       "Brownies",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Extreme AR + ill food-handler ? salad.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "20-30 hr incubation; chicken 12/30, rice 10/30, salad 7/20; rice eaters mostly chicken eaters; many chicken-only eaters sick. Source?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "Chicken",
                                                       "Rice",
                                                       "Salad",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Chicken retains strongest association independent of rice.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "Carnival: Cotton candy 22%, Hot dogs 40%, Chips 41% but chip eaters clustered with known sick classmate. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "Hot dogs are true vehicle",
                                                       "Chips true vehicle",
                                                       "Cotton candy",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Chip AR inflated by propagated cluster ? hot dogs true driver.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "Banquet: early vomiting (5-7 hrs), mid diarrhea (14-20 hrs), late diarrhea (30-48 hrs), secondary siblings 2 days later. Best explanation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 18",
                                       "options":  [
                                                       "Mixed: Staph + Salmonella + secondary norovirus",
                                                       "Single norovirus",
                                                       "Single Salmonella",
                                                       "Fruit cups only"
                                                   ],
                                       "explain":  "Three distinct patterns ? triple mechanism.",
                                       "chapter":  "ch18"
                                   },
                                   {
                                       "q":  "All salad eaters also ate pasta; many pasta eaters did NOT eat salad and got sick. True vehicle?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 19",
                                       "options":  [
                                                       "Pasta",
                                                       "Salad",
                                                       "Both",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Salad signal inflated by pasta co-exposure ? pasta true source.",
                                       "chapter":  "ch19"
                                   },
                                   {
                                       "q":  "Dinner with 3 waves: 6-8 hr vomiting, 18-24 hr diarrhea, 36-48 hr fever/diarrhea. Explanation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 19",
                                       "options":  [
                                                       "Multiple agents in same meal",
                                                       "Single pathogen irregular incubation",
                                                       "Propagated",
                                                       "Airborne"
                                                   ],
                                       "explain":  "Triple peak ? multiple agents.",
                                       "chapter":  "ch19"
                                   },
                                   {
                                       "q":  "Lasagna: 35 ate (21 sick); 55 did not (11 sick). RR?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 19",
                                       "options":  [
                                                       "3.0",
                                                       "2.5",
                                                       "1.5",
                                                       "4.0"
                                                   ],
                                       "explain":  "RR = (21/35)/(11/55) = 0.60/0.20 = 3.0.",
                                       "chapter":  "ch19"
                                   },
                                   {
                                       "q":  "Two peaks: 12 hrs \u0026 36 hrs after same snack; symptoms differ. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 19",
                                       "options":  [
                                                       "Same exposure, two pathogens",
                                                       "Pure norovirus",
                                                       "Pure Salmonella",
                                                       "Propagated"
                                                   ],
                                       "explain":  "Dual agents ? two peaks.",
                                       "chapter":  "ch19"
                                   },
                                   {
                                       "q":  "Fruit cups AR inflated by pasta co-exposure; pasta eaters sick without fruit cups. Vehicle?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 19",
                                       "options":  [
                                                       "Pasta",
                                                       "Fruit cups",
                                                       "Sandwiches",
                                                       "None"
                                                   ],
                                       "explain":  "Pasta retains independent signal.",
                                       "chapter":  "ch19"
                                   },
                                   {
                                       "q":  "School event: Chips AR inflated by classroom cluster; Pizza 22/45 unaffected by cluster. True vehicle?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 19",
                                       "options":  [
                                                       "Pizza",
                                                       "Chips",
                                                       "Fruit salad",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Pizza signal remains independent of cluster.",
                                       "chapter":  "ch19"
                                   },
                                   {
                                       "q":  "Catered lunch: Pasta 28/35; both tables served by sick food handler; compatible symptoms. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 19",
                                       "options":  [
                                                       "Pasta true vehicle",
                                                       "Sandwiches",
                                                       "Two outbreaks",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Extremely high AR + common exposure source.",
                                       "chapter":  "ch19"
                                   },
                                   {
                                       "q":  "Banquet: early vomiting (6-8 hr), mid diarrhea (18-28 hr), late fever/diarrhea (36-52 hr), plus household spread. Explanation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 19",
                                       "options":  [
                                                       "Staph + Salmonella + secondary norovirus",
                                                       "Single norovirus",
                                                       "Single Salmonella",
                                                       "Fruit trays only"
                                                   ],
                                       "explain":  "Three distinct incubation/symptom patterns + secondaries ? triple mechanism.",
                                       "chapter":  "ch19"
                                   },
                                   {
                                       "q":  "Pasta at 11:00 AM, Chicken at 12:45 PM. Onset clusters match times, but pasta AR higher within each time block. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "Pasta true vehicle",
                                                       "Chicken true vehicle",
                                                       "Timing confounding only",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Time-adjusted AR confirms pasta effect independent of timing.",
                                       "chapter":  "ch20"
                                   },
                                   {
                                       "q":  "Trip event: early vomiting (6-8 hr), mid diarrhea (20-28 hr), late diarrhea+fever (32-48 hr), secondary household cases only in late group. Explanation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "Staph + Salmonella + secondary norovirus",
                                                       "Pure norovirus",
                                                       "Pure Salmonella",
                                                       "Continuous environmental exposure"
                                                   ],
                                       "explain":  "Three distinct incubation patterns + household spread.",
                                       "chapter":  "ch20"
                                   },
                                   {
                                       "q":  "Camp tacos: 50 ate (30 sick); 70 did not (14 sick). RR?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "3.0",
                                                       "2.1",
                                                       "0.5",
                                                       "4.0"
                                                   ],
                                       "explain":  "RR = (30/50) / (14/70) = 0.60 / 0.20 = 3.0.",
                                       "chapter":  "ch20"
                                   },
                                   {
                                       "q":  "Fruit salad 12/40, Pizza 20/45, Chips 9/12 but chips group was pre-exposed to vomiting classmate. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "Pizza true vehicle",
                                                       "Chips true vehicle",
                                                       "Fruit salad",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Chip AR inflated by unrelated propagated cluster.",
                                       "chapter":  "ch20"
                                   },
                                   {
                                       "q":  "Banquet ARs: Pasta 25/40, Burgers 12/50, Fruit bowls 22/30. Fruit bowl eaters all ate pasta; many pasta-only eaters sick. Vehicle?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "Pasta",
                                                       "Fruit bowls",
                                                       "Burgers",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Fruit AR inflated by pasta co-exposure; pasta retains signal.",
                                       "chapter":  "ch20"
                                   },
                                   {
                                       "q":  "Tacos Mon-Tue: only Tuesday group sick; substitute cook symptomatic. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "Tuesday tacos true vehicle",
                                                       "Monday tacos true vehicle",
                                                       "Both days equal",
                                                       "Classmate spread"
                                                   ],
                                       "explain":  "Clear link to Tuesday cook with GI symptoms.",
                                       "chapter":  "ch20"
                                   },
                                   {
                                       "q":  "Catered lunch: Pasta 26/35; two sick servers at pasta table; symptoms Salmonella-like. Interpretation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "Pasta overwhelmingly likely vehicle",
                                                       "Salad possible",
                                                       "Sandwiches implicated",
                                                       "Cannot determine"
                                                   ],
                                       "explain":  "Very high AR + direct food-handler contamination.",
                                       "chapter":  "ch20"
                                   },
                                   {
                                       "q":  "Banquet of 450: early vomiting, mid diarrhea, late diarrhea+fever, secondary household spread only in late group. Food ARs: Pasta 60/110, Chicken 25/120, Fruit 70/100. Explanation?",
                                       "answer":  0,
                                       "type":  "mc",
                                       "topic":  "Chapter 20",
                                       "options":  [
                                                       "Staph + Salmonella + secondary norovirus",
                                                       "Single norovirus",
                                                       "Single Salmonella",
                                                       "Fruit trays only"
                                                   ],
                                       "explain":  "Three incubation/symptom waves + household spread ? triple mechanism.",
                                       "chapter":  "ch20"
                                   }
                               ]
              }
};

// Make globally available
if (typeof window !== 'undefined') {
    window.QUIZ_BANKS = QUIZ_BANKS;
}
if (typeof module !== 'undefined') {
    module.exports = QUIZ_BANKS;
}
/*
 * quiz_phase2_additions.js
 *
 * This module augments the existing QUIZ_BANKS with additional
 * advanced questions and combination questions to support PhaseÂ 2
 * improvements. It runs immediately when loaded and will do
 * nothing if QUIZ_BANKS is undefined. Each new question includes
 * a clear explanation and is placed into the appropriate partâ€™s
 * advanced array. Multiâ€‘topic questions are encoded as single
 * multipleâ€‘choice items by combining correct answers. If you add
 * more questions here, ensure they are comprehensive and align
 * with the curriculum.
 */

(function() {
    // Guard: only run if the global quiz bank exists.
    if (typeof window === 'undefined' || typeof QUIZ_BANKS === 'undefined') {
        console.warn('quiz_phase2_additions.js: QUIZ_BANKS not available â€“ new questions not loaded');
        return;
    }

    // Helper to ensure part and difficulty arrays exist
    function ensureArray(part, level) {
        if (!QUIZ_BANKS[part]) {
            QUIZ_BANKS[part] = {};
        }
        if (!Array.isArray(QUIZ_BANKS[part][level])) {
            QUIZ_BANKS[part][level] = [];
        }
        return QUIZ_BANKS[part][level];
    }

    // Part I (Foundations) â€“ advanced
    const part1Advanced = ensureArray('part1', 'advanced');
    part1Advanced.push(
        {
            q: 'Which Hill criterion requires that the exposure occurs before the disease?',
            answer: 0,
            type: 'mc',
            topic: 'Chapter 3',
            options: [
                'Temporality',
                'Strength of association',
                'Consistency',
                'Doseâ€“response (Biological gradient)'
            ],
            explain: 'Temporality is the only Hill criterion that insists the cause precedes the effect. Without it, an association cannot imply causation.'
        },
        {
            q: 'Public health ethics: which Belmont principle emphasizes respect for persons and the requirement for informed consent?',
            answer: 0,
            type: 'mc',
            topic: 'Chapter 3',
            options: [
                'Respect for Persons (Autonomy)',
                'Beneficence',
                'Justice',
                'Nonâ€‘maleficence'
            ],
            explain: 'The Belmont Report outlines three principles: respect for persons (autonomy), beneficence, and justice. Respect for persons emphasises voluntary informed consent and treating individuals as autonomous agents.'
        }
    );

    // Part II (Investigation & Analysis) â€“ advanced
    const part2Advanced = ensureArray('part2', 'advanced');
    part2Advanced.push(
        {
            q: 'At a potluck, 50 people attend. Thirty ate the tuna salad; 20 of these reported gastroenteritis. Twenty did not eat tuna salad; 2 reported illness. Based on attack rates, is the tuna salad the likely source?',
            answer: 0,
            type: 'mc',
            topic: 'Chapter 8',
            options: [
                'Yes â€“ AR_exposedâ‰ˆ67% vs AR_unexposed=10%',
                'No â€“ AR_exposedâ‰ˆ10% vs AR_unexposed=67%',
                'No â€“ AR_exposed=50% vs AR_unexposed=50%',
                'Cannot determine without RR'
            ],
            explain: 'Attack rate among those who ate tuna salad (20/30) = 66.7%. Among those who didnâ€™t eat (2/20) = 10%. Because AR_exposed â‰« AR_unexposed, tuna salad is likely the culprit. Tip: practise calculating attack rates and risk ratios using the 2Ã—2 Table Calculator found in the Interactive Drills.'
        },
        {
            q: 'A study collects exposure information incorrectly for both cases and controls, causing bias toward the null. What type of misclassification is this?',
            answer: 0,
            type: 'mc',
            topic: 'Chapter 10',
            options: [
                'Nonâ€‘differential misclassification of exposure',
                'Differential misclassification of exposure',
                'Selection bias',
                'Information bias due to recall'
            ],
            explain: 'Nonâ€‘differential misclassification occurs when exposure status is measured with the same error in both cases and controls. It typically biases effect measures toward the null.'
        }
    );

    // Part III (Control & Prevention) â€“ advanced
    const part3Advanced = ensureArray('part3', 'advanced');
    part3Advanced.push(
        {
            q: 'Which of the following combinations represents examples of primary prevention?',
            answer: 0,
            type: 'mc',
            topic: 'Chapter 15',
            options: [
                'Vaccination and health education',
                'Cancer screening and cholesterol testing',
                'Physical therapy after a stroke',
                'All of the above'
            ],
            explain: 'Primary prevention aims to prevent disease before it occurs, such as through vaccination and health education. Screening detects disease early (secondary prevention), and therapy after illness is tertiary.'
        },
        {
            q: 'If the basic reproduction number (Râ‚€) of measles is approximately 18, what proportion of the population must be immune to achieve herd immunity?',
            answer: 0,
            type: 'mc',
            topic: 'Chapter 18',
            options: [
                'â‰ˆ94%',
                '50%',
                '18%',
                '5%'
            ],
            explain: 'Herd immunity threshold â‰ˆ 1 â€“ 1/Râ‚€. For Râ‚€ = 18, the threshold is 1 â€“ 1/18 â‰ˆ 0.944, or 94% of the population.'
        },
        {
            q: 'Which set contains only Hill\'s criteria for causation?',
            answer: 2,
            type: 'mc',
            topic: 'Chapter 18',
            options: [
                'Strength, pâ€‘value, plausibility',
                'Pâ€‘value, doseâ€“response, temporality',
                'Temporality, consistency, doseâ€“response',
                'Specificity, pâ€‘value, consistency'
            ],
            explain: 'Hill\'s criteria include temporality, strength, consistency, doseâ€“response, plausibility, coherence, experiment and analogy. Pâ€‘value is not among the criteria. The only option containing three actual criteria is option C.'
        }
    );

    // Part I (Modes of Transmission) â€“ multiâ€‘select style advanced question
    const part1AdvancedMulti = ensureArray('part1', 'advanced');
    part1AdvancedMulti.push({
        q: 'Vectorâ€‘borne diseases include which of the following combinations?',
        answer: 0,
        type: 'mc',
        topic: 'Chapter 5',
        options: [
            'Malaria & Lyme disease',
            'Malaria, Lyme disease & Influenza',
            'Cholera & Influenza',
            'All of the above'
        ],
        explain: 'Vectorâ€‘borne diseases are transmitted by arthropods such as mosquitoes or ticks. Malaria (mosquitoâ€‘borne) and Lyme disease (tickâ€‘borne) are vectorâ€‘borne. Cholera and influenza are primarily transmitted via contaminated water and respiratory droplets, respectively, not by insects.'
    });
})();
(function () {
    if (typeof QUIZ_BANKS === 'undefined') {
        console.warn('QUIZ_BANKS not loaded, Phase 3 additions skipped.');
        return;
    }

    // console.log('[Phase 3] Injecting Advanced Content & Visuals...');

    const newQuestions = {
        part1: [
            {
                q: "Analyze this Epi Curve:<br><pre style='font-family:monospace; line-height:10px;'>\n   #\n   #\n  ###\n #####   #\n----------\n1 2 3 4 5 6</pre>Which pattern is most consistent with this single sharp peak?",
                answer: 0,
                type: "mc",
                topic: "Chapter 4",
                options: ["Point Source", "Propagated", "Continuous Common Source", "Intermittent"],
                explain: "Correct: A. A single sharp peak with a rapid decline suggests a point source exposure (e.g., a single contaminated meal)."
            },
            {
                q: "Compare Study Designs:<br><table class='neo-table small'><tr><td>A</td><td>Start with Disease</td><td>Look Back</td></tr><tr><td>B</td><td>Start with Exposure</td><td>Follow Forward</td></tr></table><br>Which row describes a Cohort Study?",
                answer: 1,
                type: "mc",
                topic: "Chapter 10",
                options: ["Row A", "Row B", "Both", "Neither"],
                explain: "Correct: B. Cohort studies classify by exposure status first, then track outcomes."
            },
            {
                q: "<strong>Visual Analogy:</strong><br>Identifying 'sick' people against a noisy background of 'healthy' people is best described by measures of:",
                answer: 0,
                type: "mc",
                topic: "Chapter 1",
                options: ["Validity (Sensitivity/Specificity)", "Reliability", "Representativeness", "Generalizability"],
                explain: "Correct: A. Signal-to-noise detection is the core concept of Sensitivity (finding the signal) and Specificity (ignoring the noise)."
            }
        ],
        part2: [
            {
                q: "<div style='font-family:monospace; border:1px solid #ccc; padding:5px;'>ID | Ate Salad | Sick<br>1  | Yes       | Yes<br>2  | No        | No<br>3  | Yes       | No</div><br>Calculate the Attack Rate for Salad Eaters.",
                answer: 0,
                type: "mc",
                topic: "Chapter 13",
                options: ["50% (1/2)", "33% (1/3)", "100% (2/2)", "0%"],
                explain: "Correct: A. Two people ate salad (ID 1, ID 3). Of them, only ID 1 got sick. 1/2 = 50%."
            },
            {
                q: "Risk Ratio Interpretation:<br><strong>RR = 0.6 (95% CI: 0.4 - 0.9)</strong><br>How should you interpret this?",
                answer: 1,
                type: "mc",
                topic: "Chapter 13",
                options: ["Exposure is a Risk Factor", "Exposure is Protective", "Result is Not Statistically Significant", "Bias is present"],
                explain: "Correct: B. RR < 1 indicates protection. Since the CI (0.4-0.9) does NOT include 1.0, it is statistically significant."
            },
            {
                q: "<strong>Visual Bias Drill:</strong><br>Two groups are compared. Group A has mean age 20. Group B has mean age 60. You find higher death rates in B. This is likely:",
                answer: 0,
                type: "mc",
                topic: "Chapter 11",
                options: ["Confounding by Age", "Selection Bias", "Recall Bias", "Observer Bias"],
                explain: "Correct: A. Age is related to both the group assignment and the outcome (death), making it a classic confounder."
            }
        ],
        part3: [
            {
                q: "<strong>Chain of Infection Visual:</strong><br>Reservoir -> Portal of Exit -> ??? -> Portal of Entry.<br>What is the missing link?",
                answer: 0,
                type: "mc",
                topic: "Chapter 15",
                options: ["Mode of Transmission", "Susceptible Host", "Agent", "Vector"],
                explain: "Correct: A. The agent must travel from the exit to the entry via a Mode of Transmission."
            },
            {
                q: "Ethical Dilemma:<br>A student has active Measles (Airborne). Which action is least restrictive but effective?",
                answer: 1,
                type: "mc",
                topic: "Chapter 17",
                options: ["Quarantine the whole school", "Isolate the student at home", "Monitor temperature only", "Do nothing"],
                explain: "Correct: B. Isolation restricts the sick individual. Quarantine restricts healthy/exposed. Whole school quarantine is too restrictive initially."
            }
        ]
    };

    // Inject
    if (QUIZ_BANKS.part1) QUIZ_BANKS.part1.advanced.push(...newQuestions.part1);
    if (QUIZ_BANKS.part2) QUIZ_BANKS.part2.intermediate.push(...newQuestions.part2);
    if (QUIZ_BANKS.part3) QUIZ_BANKS.part3.beginner.push(...newQuestions.part3);

})();

/**
 * SCIENCE OLYMPIAD 2026 - DISEASE DETECTIVES (DIV B)
 * RULES COMPLIANCE MATRIX & SCHEMA
 * 
 * This file acts as the pedagogical source of truth.
 * It maps App Content (Chapters, Tools) to Official Rule IDs.
 */

const RULES_DATA = {
    meta: {
        version: "2026-Draft",
        division: "B"
    },
    // The Core Rules (Simplified for Logic)
    rules: {
        "1.a": "Scientific Inquiry: Hypothesis Generation",
        "1.b": "Scientific Inquiry: Study Design (Cross-Sectional)",
        "1.c": "Scientific Inquiry: Study Design (Case-Control)",
        "1.d": "Scientific Inquiry: Study Design (Cohort)",
        "2.a": "Pattern Recognition: Person, Place, Time",
        "2.b": "Pattern Recognition: Epi Curves (Point Source)",
        "2.c": "Pattern Recognition: Epi Curves (Propagated)",
        "2.d": "Pattern Recognition: Maps & Clustering",
        "3.a": "Etiology: Agents (Bacteria, Virus, Fungi, Prions)",
        "3.b": "Etiology: Modes of Transmission",
        "3.c": "Etiology: Chain of Infection",
        "4.a": "Calculation: Attack Rate",
        "4.b": "Calculation: Relative Risk (Risk Ratio)",
        "4.c": "Calculation: Odds Ratio",
        "4.d": "Calculation: Confidence Intervals (Basic)",
        "5.a": "Prevention: Levels (Prim, Sec, Tert)",
        "5.b": "Prevention: Strategies (Vector, Env, etc.)",
        "5.c": "Prevention: Herd Immunity & R0",
        "6.a": "Public Health: Surveillance Systems",
        "6.b": "Public Health: Outbreak Investigation Steps (13)",
        "6.c": "Public Health: Ethics, Laws, & Privacy"
    },
    // Mapping: Which Chapter Covers Which Rule?
    mapping: {
        "ch1": ["1.a", "6.b"],           // Frameworks -> Inquiry, Steps
        "ch2": ["6.c"],                  // History often touches on ethics/laws context
        "ch3": ["3.a", "3.b", "3.c"],    // Triad & Chain covers Etiology
        "ch4": ["4.a"],                  // Measures of Freq -> Basics
        "ch5": ["6.a", "3.b"],           // Surveillance
        "ch6": ["2.a"],                  // Natural History -> PPT
        "ch7": ["6.b"],                  // Investigation Roadmap -> Steps
        "ch8": ["2.a"],                  // Case Definitions
        "ch9": ["2.a", "2.d"],           // Line Lists -> Data Organization
        "ch10": ["2.b", "2.c"],          // Epi Curves
        "ch11": ["4.a", "4.b"],          // Math I -> AR, RR
        "ch12": ["4.c", "4.d"],          // Math II -> OR, CI
        "ch13": ["1.b", "1.c", "1.d"],   // Hypothesis Testing -> Study Designs
        "ch14": ["2.d"],                 // Data Synthesis
        "ch15": ["5.a"],                 // Prevention Levels
        "ch16": ["5.b"],                 // Control Measures
        "ch17": ["6.c"],                 // Isolation & Ethics
        "ch18": ["5.c"],                 // Pop Dynamics -> Herd Immunity
        "drills": ["2.b", "2.c", "4.b", "4.c"], // Tools cover curves and math
        "simulation": ["*"]              // Exams cover all
    }
};

/**
 * Rules Engine
 * Provides helper functions to check compliance.
 */
window.RulesEngine = {
    /**
     * Returns an array of Rule Objects {id, desc} for a given chapter.
     */
    getRulesForChapter(chapterId) {
        const ruleIds = RULES_DATA.mapping[chapterId];
        if (!ruleIds) return [];
        if (ruleIds[0] === "*") return [{ id: "ALL", desc: "Comprehensive Coverage" }];

        return ruleIds.map(id => ({
            id: id,
            desc: RULES_DATA.rules[id] || "Unknown Rule"
        }));
    },

    /**
     * Generates an HTML badge string for display in the header.
     */
    renderBadges(chapterId) {
        const rules = this.getRulesForChapter(chapterId);
        if (rules.length === 0) return '';

        return `
            <div class="rules-badge-container" style="margin-top: 0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
                ${rules.map(r => `
                    <span class="neo-badge small" title="${r.desc}" style="background:var(--accent-blue); color:var(--text-color); cursor:help;">
                        <i class="ph-bold ph-check-circle"></i> Rule ${r.id}
                    </span>
                `).join('')}
            </div>
        `;
    }
};

const CASE_LIBRARY = [
    // --- FOODBORNE & WATERBORNE ---
    {
        id: "C1", disease: "Norovirus", title: "The School Potluck",
        scenario_text: "30% of school students absent with vomiting/cramps after Sunday potluck.",
        learning_objectives: ["Identify viral gastroenteritis symptoms.", "Calculate attack rates."],
        curve: "Point-Source", incubation: "24-48h", agent: "Norovirus GII", transmission: "Fecal-Oral",
        spot_map: "Clusters in classrooms A and B (who ate first shift).",
        counterfactual: "If hand sanitizer had been replaced with soap/water, transmission would have decreased (sanitizer doesn't kill Noro).",
        controls: ["Bleach disinfection", "Exclude ill staff 48h"],
        questions: [{ q: "Viral vs Bacterial?", a: "Viral (Vomiting dominant, short incubation)." }]
    },
    {
        id: "C2", disease: "Salmonella", title: "Peep Peep Problem",
        scenario_text: "Cluster of children with bloody diarrhea linked to backyard poultry.",
        learning_objectives: ["Zoonotic transmission.", "Propagated outbreaks."],
        curve: "Propagated", incubation: "12-72h", agent: "Salmonella Enteritidis", transmission: "Zoonotic/Fecal-Oral",
        spot_map: "Cases scattered across rural county, all with backyard coops.",
        counterfactual: "If children washed hands after touching chicks, cases would drop 90%.",
        controls: ["Handwashing", "Keep birds outdoors"],
        questions: [{ q: "Why propagated?", a: "Secondary household spread." }]
    },
    {
        id: "C3", disease: "E. coli O157", title: "The Raw Deal",
        scenario_text: "HS students with HUS after eating salad bar.",
        learning_objectives: ["HUS risk.", "Antibiotic contraindication."],
        curve: "Point-Source", incubation: "3-4 days", agent: "STEC O157", transmission: "Foodborne",
        spot_map: "Cases localized to high school cafeteria patrons.",
        counterfactual: "If antibiotics were administered, HUS rate would triple.",
        controls: ["No Antibiotics", "Pull lettuce"],
        questions: [{ q: "Treatment?", a: "Supportive care only." }]
    },
    {
        id: "C4", disease: "Campylobacter", title: "The Raw Milk",
        scenario_text: "Gastroenteritis outbreak after a farm field trip.",
        learning_objectives: ["Raw milk risks.", "Guillain-Barre link."],
        curve: "Point-Source", incubation: "2-5 days", agent: "Campylobacter jejuni", transmission: "Foodborne",
        spot_map: "Cluster of cases who signed the farm waiver.",
        counterfactual: "If milk was pasteurized, outbreak would be 0 cases.",
        controls: ["Pasteurization", "Hygiene"],
        questions: [{ q: "Long term risk?", a: "Guillain-Barre Syndrome." }]
    },
    {
        id: "C5", disease: "Listeria", title: "Deli Danger",
        scenario_text: "Spike in miscarriages and sepsis in elderly. Linked to deli meat.",
        learning_objectives: ["High risk groups.", "Psychrophilic bacteria."],
        curve: "Intermittent", incubation: "1-70 days", agent: "Listeria monocytogenes", transmission: "Foodborne",
        spot_map: "Dispersed cases across 3 states (distribution network).",
        counterfactual: "If meat was heated to steaming, risk is eliminated.",
        controls: ["Recall", "Sanitize slicers"],
        questions: [{ q: "Why hard to track?", a: "Long incubation (up to 70 days)." }]
    },
    {
        id: "C6", disease: "Vibrio parahaemolyticus", title: "The Oyster Bar",
        scenario_text: "Watery diarrhea after eating raw oysters in summer.",
        learning_objectives: ["Halophilic bacteria.", "Warm water risk."],
        curve: "Point-Source", incubation: "24h", agent: "Vibrio parahaemolyticus", transmission: "Foodborne",
        spot_map: "Coastal restaurants serving local catch.",
        counterfactual: "If oysters were harvested in winter, risk would be negligible.",
        controls: ["Cook seafood", "Monitor water temp"],
        questions: [{ q: "Environmental factor?", a: "Warm sea water." }]
    },
    {
        id: "C7", disease: "Shigella", title: "Daycare Disaster",
        scenario_text: "Bloody diarrhea spreading rapidly in a preschool.",
        learning_objectives: ["Low infectious dose.", "Person-to-Person spread."],
        curve: "Propagated", incubation: "1-2 days", agent: "Shigella sonnei", transmission: "Fecal-Oral",
        spot_map: "Clustered in 'Diaper' room.",
        counterfactual: "If soap was used instead of sanitizer, efficacy improves (barely). Handwashing is key.",
        controls: ["Strict hygiene", "Supervised washing"],
        questions: [{ q: "Infectious dose?", a: "Very low (10-100 bacteria)." }]
    },
    {
        id: "C8", disease: "Giardia", title: "The Beaver Fever",
        scenario_text: "Backpackers with foul, greasy diarrhea lasting weeks.",
        learning_objectives: ["Parasitic life cycle.", "Water filtration."],
        curve: "Sporadic", incubation: "1-2 weeks", agent: "Giardia lamblia", transmission: "Waterborne",
        spot_map: "Cases hiking along the same mountain stream.",
        counterfactual: "If iodine/filters were used, cysts would be removed.",
        controls: ["Filter water", "Boil"],
        questions: [{ q: "Symptom hallmark?", a: "Steatorrhea (Greasy stool)." }]
    },
    {
        id: "C9", disease: "Cryptosporidium", title: "Pool Panic",
        scenario_text: "Diarrhea outbreak at community pool. Chlorine is normal.",
        learning_objectives: ["Chlorine resistance.", "Fecal accident."],
        curve: "Continuous", incubation: "7 days", agent: "Cryptosporidium", transmission: "Waterborne",
        spot_map: "Cases all visited the 'Kiddie Pool'.",
        counterfactual: "If UV filters were installed, outbreak stops.",
        controls: ["Hyperchlorination", "UV"],
        questions: [{ q: "Why chlorine failed?", a: "Crypto is resistant." }]
    },
    {
        id: "C10", disease: "Cholera", title: "The Flight Home",
        scenario_text: "Severe 'rice water' stool in travelers returning from Haiti.",
        learning_objectives: ["Rapid dehydration.", "Rehydration therapy."],
        curve: "Point-Source (Flight)", incubation: "2-3 days", agent: "Vibrio cholerae", transmission: "Water/Food",
        spot_map: "Seated in rows 30-40 (served cold seafood salad).",
        counterfactual: "If ORS was given immediately, mortality drops <1%.",
        controls: ["Rehydration (ORS)", "Sanitation"],
        questions: [{ q: "Cause of death?", a: "Hypovolemic shock." }]
    },
    {
        id: "C11", disease: "Typhoid Fever", title: "The Carrier",
        scenario_text: "Unexplained fever cases linked to a single bakery.",
        learning_objectives: ["Chronic carriers.", "Systemic infection."],
        curve: "Intermittent", incubation: "1-3 weeks", agent: "Salmonella Typhi", transmission: "Fecal-Oral",
        spot_map: "All cases bought glazed donuts.",
        counterfactual: "If the baker (carrier) was treated/excluded, outbreak ends.",
        controls: ["Treat carrier", "Hygiene"],
        questions: [{ q: "Famous historical case?", a: "Typhoid Mary." }]
    },
    {
        id: "C12", disease: "Botulism", title: "Canned Death",
        scenario_text: "Descending paralysis after family reunion.",
        learning_objectives: ["Neurotoxin.", "Canning safety."],
        curve: "Point-Source", incubation: "12-36h", agent: "C. botulinum toxin", transmission: "Foodborne",
        spot_map: "Family members who ate the green beans.",
        counterfactual: "If beans were pressure canned, spores would die.",
        controls: ["Antitoxin", "Respiratory support"],
        questions: [{ q: "Mechanism?", a: "Blocks Acetylcholine." }]
    },
    {
        id: "C13", disease: "Staph Aureus", title: "Picnic Panic",
        scenario_text: "Vomiting 3 hours after eating potato salad.",
        learning_objectives: ["Intoxication vs Infection.", "Temp abuse."],
        curve: "Explosive Point-Source", incubation: "2-4h", agent: "Staph Enterotoxin", transmission: "Foodborne",
        spot_map: "Picnic table A.",
        counterfactual: "If salad was chilled, bacteria wouldn't produce toxin.",
        controls: ["Keep cold foods cold", "Hygiene"],
        questions: [{ q: "Why so fast?", a: "Pre-formed toxin." }]
    },
    {
        id: "C14", disease: "Bacillus cereus", title: "Fried Rice Syndrome",
        scenario_text: "Vomiting after eating buffet fried rice.",
        learning_objectives: ["Spore forming.", "Rice safety."],
        curve: "Point-Source", incubation: "1-5h (Emetic)", agent: "B. cereus", transmission: "Foodborne",
        spot_map: "Buffet line patrons.",
        counterfactual: "If rice was kept >60C, spores wouldn't germinate.",
        controls: ["Temp control"],
        questions: [{ q: "Two forms?", a: "Emetic (Vomiting) vs Diarrheal." }]
    },
    {
        id: "C15", disease: "Hepatitis A", title: "The Smoothie King",
        scenario_text: "Jaundice outbreak 1 month after visiting smoothie shop.",
        learning_objectives: ["Long incubation.", "Vaccine prevention."],
        curve: "Point-Source", incubation: "28 days", agent: "Hepatitis A Virus", transmission: "Fecal-Oral",
        spot_map: "Patrons of 'Berry Blast' (imported strawberries).",
        counterfactual: "If staff were vaccinated, transmission blocked.",
        controls: ["Post-exposure prophylaxis", "Vaccine"],
        questions: [{ q: "Symptom triad?", a: "Fever, Jaundice, Clay stool." }]
    },

    // --- VECTOR-BORNE & ZOONOTIC ---
    {
        id: "C16", disease: "Lyme Disease", title: "Bullseye",
        scenario_text: "Hikers with EM rash and arthralgia.",
        learning_objectives: ["Tick vectors.", "Early recognition."],
        curve: "Seasonal", incubation: "3-30 days", agent: "Borrelia burgdorferi", transmission: "Tick Bite",
        spot_map: "Cases map to brushy edge of campsite.",
        counterfactual: "If tick removed <24h, transmission unlikely.",
        controls: ["Permethrin", "Tick checks"],
        questions: [{ q: "Vector?", a: "Ixodes scapularis (Blacklegged tick)." }]
    },
    {
        id: "C17", disease: "RMSF", title: "Spotted Fever",
        scenario_text: "High fever and petechial rash on palms/soles.",
        learning_objectives: ["Rapid progression.", "Doxycycline urgency."],
        curve: "Seasonal", incubation: "2-14 days", agent: "Rickettsia rickettsii", transmission: "Tick Bite",
        spot_map: "Dog owners in rural suburb.",
        counterfactual: "If treated day 1, survival 100%. Day 5, mortality 30%.",
        controls: ["Doxycycline immediately"],
        questions: [{ q: "Rash pattern?", a: "Centripetal (Extremities to trunk)." }]
    },
    {
        id: "C18", disease: "West Nile", title: "Summer Encephalitis",
        scenario_text: "Elderly patients with fever/confusion in August.",
        learning_objectives: ["Mosquito vector.", "Neuroinvasive risk."],
        curve: "Seasonal (Late Summer)", incubation: "2-6 days", agent: "WNV", transmission: "Mosquito (Culex)",
        spot_map: "Clusters near stagnant drainage ponds.",
        counterfactual: "If larvicide applied in May, August cases drop.",
        controls: ["Larvicide", "DEET"],
        questions: [{ q: " Reservoir?", a: "Birds." }]
    },
    {
        id: "C19", disease: "Dengue", title: "Breakbone Fever",
        scenario_text: "Travelers to Puerto Rico return with severe bone pain.",
        learning_objectives: ["Aedes vector.", "Hemorrhagic risk."],
        curve: "Imported", incubation: "4-10 days", agent: "Dengue Virus", transmission: "Mosquito (Aedes)",
        spot_map: "Travelers staying in open-window hostels.",
        counterfactual: "If previously infected, second infection is worse (ADE).",
        controls: ["Screens", "Vector control"],
        questions: [{ q: "Vector habit?", a: "Day-biting." }]
    },
    {
        id: "C20", disease: "Malaria", title: "The Shakes",
        scenario_text: "Cyclical fever in missionary returning from Nigeria.",
        learning_objectives: ["Anopheles vector.", "Chemoprophylaxis."],
        curve: "Imported", incubation: "7-30 days", agent: "Plasmodium falciparum", transmission: "Mosquito",
        spot_map: "N/A (Travel)",
        counterfactual: "If taking prophylaxis, illness prevented.",
        controls: ["Bed nets", "Artemisinin"],
        questions: [{ q: "Deadliest species?", a: "Falciparum." }]
    },
    {
        id: "C21", disease: "Plague", title: "Prairie Dog Town",
        scenario_text: "Camper with painful swollen lymph node (bubo).",
        learning_objectives: ["Flea vector.", "Reservoir hosts."],
        curve: "Sporadic", incubation: "2-6 days", agent: "Yersinia pestis", transmission: "Flea bite",
        spot_map: "Close proximity to rodent die-off.",
        counterfactual: "If treated with Streptomycin early, curative.",
        controls: ["Flea control", "Avoid rodents"],
        questions: [{ q: "Bacteria shape?", a: "Safety-pin (Bipolar staining)." }]
    },
    {
        id: "C22", disease: "Tularemia", title: "Rabbit Fever",
        scenario_text: "Landscaper with ulcer detected after mowing over rabbit nest.",
        learning_objectives: ["Aerosol vs Contact.", "Low infectious dose."],
        curve: "Sporadic", incubation: "3-5 days", agent: "Francisella tularensis", transmission: "Contact/Aerosol",
        spot_map: "Map of lawn mowing path.",
        counterfactual: "If wearing mask, aerosol prevention.",
        controls: ["Antibiotics"],
        questions: [{ q: "AKA?", a: "Rabbit Fever." }]
    },
    {
        id: "C23", disease: "Rabies", title: "The Bat",
        scenario_text: "Child wakes up with bat in room. Small scratch.",
        learning_objectives: ["100% Fatality.", "PEP urgency."],
        curve: "Single Case", incubation: "Weeks to Months", agent: "Rabies Virus", transmission: "Bite/Scratch",
        spot_map: "Sleeping quarters.",
        counterfactual: "If PEP given immediately, survival 100%. If symptoms start, 0%.",
        controls: ["PEP (IG + Vaccine)"],
        questions: [{ q: "Survivable?", a: "No, once symptomatic." }]
    },
    {
        id: "C24", disease: "Hantavirus", title: "Dusty Shed",
        scenario_text: "Respiratory failure after sweeping cabin.",
        learning_objectives: ["Rodent excreta.", "No cure."],
        curve: "Sporadic", incubation: "1-5 weeks", agent: "Sin Nombre Virus", transmission: "Aerosolized urine",
        spot_map: "Old cabin location.",
        counterfactual: "If wet mopped, no aerosol.",
        controls: ["Wet cleaning", "N95"],
        questions: [{ q: "Region?", a: "Southwest USA (Four Corners)." }]
    },
    {
        id: "C25", disease: "Anthrax", title: "Wool Sorter",
        scenario_text: "Hide processor with black eschar ulcer.",
        learning_objectives: ["Cutaneous vs Inhalation.", "Spores."],
        curve: "Sporadic", incubation: "1-7 days", agent: "Bacillus anthracis", transmission: "Spore contact",
        spot_map: "Tannery workstation.",
        counterfactual: "If inhaled, mortality is typically high (Woolsorters disease).",
        controls: ["Cipro", "Vaccine (Occupational)"],
        questions: [{ q: "Painless?", a: "Yes, the ulcer is painless." }]
    },

    // --- RESPIRATORY & VACCINE PREVENTABLE ---
    {
        id: "C26", disease: "Measles", title: "Waiting Room",
        scenario_text: "Unvax child infects waiting room. Airborne.",
        learning_objectives: ["R0", "Airborne duration."],
        curve: "Propagated", incubation: "10-12 days", agent: "Measles Virus", transmission: "Airborne",
        spot_map: "Waiting room seating (infects everyone).",
        counterfactual: "If vaccinated (MMR), herd immunity protects.",
        controls: ["Isolation", "Vaccination"],
        questions: [{ q: "Koplik spots?", a: "Pathognomonic sign in mouth." }]
    },
    {
        id: "C27", disease: "Pertussis", title: "100 Day Cough",
        scenario_text: "Infant with apnea and severe cough. Unvax family.",
        learning_objectives: ["Waning immunity.", "Cocooning."],
        curve: "Propagated", incubation: "7-10 days", agent: "Bordetella pertussis", transmission: "Droplet",
        spot_map: "Daycare center.",
        counterfactual: "If mother vaxed during pregnancy (Tdap), antibodies protect infant.",
        controls: ["Antibiotics (Macrolides)", "Vaccinate"],
        questions: [{ q: "Sound?", a: "Whoop (Inspiratory stridor)." }]
    },
    {
        id: "C28", disease: "Mumps", title: "College Swell",
        scenario_text: "Outbreak of parotitis (swollen jaw) in dorms.",
        learning_objectives: ["Close contact.", "Complications (Orchitis)."],
        curve: "Propagated", incubation: "16-18 days", agent: "Mumps Virus", transmission: "Droplet",
        spot_map: "Dormitory cluster.",
        counterfactual: "If 3rd MMR dose given, outbreak control improves.",
        controls: ["Isolation", "Booster"],
        questions: [{ q: "Male complication?", a: "Orchitis (Testicular swelling)." }]
    },
    {
        id: "C29", disease: "Legionella", title: "The Cooling Tower",
        scenario_text: "Pneumonia cluster in hotel guests. No person-to-person.",
        learning_objectives: ["Environmental source.", "Urinary antigen."],
        curve: "Continuous Common Source", incubation: "2-10 days", agent: "L. pneumophila", transmission: "Aerosol Water",
        spot_map: "Rooms facing the cooling tower exhaust.",
        counterfactual: "If tower disinfected, outbreak stops immediately.",
        controls: ["Hyperchlorination"],
        questions: [{ q: "Transmission?", a: "Inhalation only, not P2P." }]
    },
    {
        id: "C30", disease: "Tuberculosis", title: "The Night Sweats",
        scenario_text: "Homeless shelter resident with chronic cough/hemoptysis.",
        learning_objectives: ["Latent vs Active.", "Long treatment."],
        curve: "Prolonged Propagated", incubation: "Weeks to Years", agent: "Mycobacterium tuberculosis", transmission: "Airborne",
        spot_map: "Bunks near airflow vent.",
        counterfactual: "If latent TB treated, active disease prevented.",
        controls: ["DOTS therapy", "Negative pressure isolation"],
        questions: [{ q: "Stain?", a: "Acid-Fast Bacilli (AFB)." }]
    },
    {
        id: "C31", disease: "Influenza", title: "Nursing Home Drift",
        scenario_text: "Rapid onset fever/cough in 50% of residents.",
        learning_objectives: ["Drift vs Shift.", "Prophylaxis."],
        curve: "Explosive Propagated", incubation: "1-4 days", agent: "Influenza A", transmission: "Droplet/Airborne",
        spot_map: "Dining hall seating.",
        counterfactual: "If Tamiflu prophylaxis given, attack rate halves.",
        controls: ["Antivirals", "Vaccine matching"],
        questions: [{ q: "Shift?", a: "Pandemic potential (Reassortment)." }]
    },
    {
        id: "C32", disease: "Meningitis", title: "Dorm Emergency",
        scenario_text: "Student found unconscious with stiff neck and purpura.",
        learning_objectives: ["Medical emergency.", "Chemoprophylaxis contacts."],
        curve: "Sporadic Cluster", incubation: "3-4 days", agent: "Neisseria meningitidis", transmission: "Droplet",
        spot_map: "Roommates.",
        counterfactual: "If contacts given Rifampin, secondary cases prevented.",
        controls: ["Vaccine (MenACWY/B)", "Antibiotics"],
        questions: [{ q: "Glass test?", a: "Rash doesn't fade under pressure." }]
    },

    // --- OTHER & SPECIAL ---
    {
        id: "C33", disease: "Lead Poisoning", title: "Sweet Paint",
        scenario_text: "Children in old housing with developmental regression.",
        learning_objectives: ["Environmental toxin.", "Chronic exposure."],
        curve: "N/A", incubation: "Chronic", agent: "Lead", transmission: "Ingestion",
        spot_map: "Map of houses built pre-1978.",
        counterfactual: "If abatement performed, levels drop.",
        controls: ["Chelation", "Abatement"],
        questions: [{ q: "Source?", a: "Peeling paint, dust." }]
    },
    {
        id: "C34", disease: "CO Poisoning", title: "Silent Killer",
        scenario_text: "Family found unconscious after winter storm. Generator inside.",
        learning_objectives: ["Cherry red skin.", "O2 displacement."],
        curve: "Point Source (Event)", incubation: "Hours", agent: "Carbon Monoxide", transmission: "Inhalation",
        spot_map: "Garage proximity.",
        counterfactual: "If detector installed, alarm would have saved them.",
        controls: ["Oxygen", "Ventilation"],
        questions: [{ q: "Hemoglobin?", a: "Carboxyhemoglobin affinity 200x O2." }]
    },
    {
        id: "C35", disease: "Tetanus", title: "Rusty Nail",
        scenario_text: "Gardener with lockjaw and muscle spasms.",
        learning_objectives: ["Anaerobic spores.", "Toxin mediated."],
        curve: "Single Case", incubation: "3-21 days", agent: "Clostridium tetani", transmission: "Puncture",
        spot_map: "Garden.",
        counterfactual: "If Td booster up to date, immune.",
        controls: ["IG", "Ventilator"],
        questions: [{ q: "Smile?", a: "Risus sardonicus." }]
    },
    {
        id: "C36", disease: "Ebola", title: "Viral Hemorrhagic",
        scenario_text: "Healthcare worker returning from West Africa with fever/bleeding.",
        learning_objectives: ["Direct contact fluids.", "High PPE."],
        curve: "Propagated", incubation: "2-21 days", agent: "Ebolavirus", transmission: "Fluids",
        spot_map: "Isolation unit.",
        counterfactual: "If PPE breach avoided, no infection.",
        controls: ["Strict Isolation", "Contact Tracing"],
        questions: [{ q: "Survivors?", a: "Virus persists in eyes/semen." }]
    },
    {
        id: "C37", disease: "Smallpox", title: "The Variola",
        scenario_text: "Bioterror simulation. Sync rash on face/extremities.",
        learning_objectives: ["Distinguish from Chickenpox.", "Eradicated."],
        curve: "Propagated", incubation: "7-17 days", agent: "Variola Major", transmission: "Airborne",
        spot_map: "Global.",
        counterfactual: "If Ring Vaccination used, verified containment.",
        controls: ["Vaccine (up to 4 days post exp)"],
        questions: [{ q: "Chickenpox diff?", a: "Smallpox: same stage lesions, distal. Chickenpox: crop stages, central." }]
    },
    {
        id: "C38", disease: "Rubella", title: "German Measles",
        scenario_text: "Mild rash in adult, but pregnant wife exposed.",
        learning_objectives: ["Congenital Rubella Syndrome.", "Mild in adults."],
        curve: "Propagated", incubation: "14 days", agent: "Rubella Virus", transmission: "Droplet",
        spot_map: "Household.",
        counterfactual: "If wife immune, fetus protected.",
        controls: ["MMR Vaccine"],
        questions: [{ q: "Fetus risk?", a: "Deafness, Cataracts, Heart defects." }]
    },
    {
        id: "C39", disease: "Candida auris", title: "Superbug",
        scenario_text: "ICU outbreak of drug-resistant fungal infection.",
        learning_objectives: ["Antifungal resistance.", "Surface persistence."],
        curve: "Propagated", incubation: "Unknown", agent: "C. auris", transmission: "Contact/Surface",
        spot_map: "ICU Beds.",
        counterfactual: "If special disinfectant (sporicidal) used, transmission stops.",
        controls: ["Screening", "Isolation"],
        questions: [{ q: "Resistance?", a: "Often multidrug resistant." }]
    },
    {
        id: "C40", disease: "Confounding", title: "The Coffee Paradox",
        scenario_text: "Coffee linked to cancer. Smoking is the confounder.",
        learning_objectives: ["Stratification.", "Simpsons Paradox."],
        curve: "N/A", incubation: "N/A", agent: "Stats", transmission: "Math",
        spot_map: "Venn Diagram.",
        counterfactual: "If stratified by smoking, association disappears.",
        controls: ["Analysis"],
        questions: [{ q: "Solution?", a: "Stratified Analysis." }]
    },
    {
        id: "C41", disease: "Histoplasmosis", title: "The Spelunker",
        scenario_text: "Group of explorers developing cough and fever after visiting a bat cave.",
        learning_objectives: ["Fungal spore inhalation.", "Bat/Bird guano association."],
        curve: "Point-Source", incubation: "3-17 days", agent: "Histoplasma capsulatum", transmission: "Inhalation",
        spot_map: "Cluster of cave visitors.",
        counterfactual: "If respirators were used or cave avoided, illness prevented.",
        controls: ["Dust suppression", "PPE (Respirators)"],
        questions: [{ q: "Geography?", a: "Ohio/Mississippi River Valleys." }]
    },
    {
        id: "C42", disease: "Leptospirosis", title: "The Mud Run",
        scenario_text: "Triathletes with fever, headache, and kidney failure after swimming in floodwater.",
        learning_objectives: ["Animal urine contamination.", "Mucous membrane entry."],
        curve: "Point-Source", incubation: "2-30 days", agent: "Leptospira spp.", transmission: "Contact (Water/Soil)",
        spot_map: "Participants who swallowed water.",
        counterfactual: "If race was cancelled due to flooding/rat infestation, no cases.",
        controls: ["Avoid contaminated water", "Rodent control"],
        questions: [{ q: "Severe form?", a: "Weil's Disease (Jaundice/Renal Failure)." }]
    },
    {
        id: "C43", disease: "Psittacosis", title: "Parrot Fever",
        scenario_text: "Pet shop employees with pneumonia-like symptoms.",
        learning_objectives: ["Avian zoonosis.", "Dry droppings aerosol."],
        curve: "Propagated (among birds) / Point (humans)", incubation: "5-14 days", agent: "Chlamydia psittaci", transmission: "Inhalation",
        spot_map: "Employees handling the new parrot shipment.",
        counterfactual: "If quarantine for new birds was strictly enforced, no human cases.",
        controls: ["Quarantine birds", "Wet cleaning"],
        questions: [{ q: "Reservoir?", a: "Birds (Parrots, pigeons, poultry)." }]
    },
    {
        id: "C44", disease: "Brucellosis", title: "Mediterranean Fever",
        scenario_text: "Family with undulating fevers after eating 'homemade' cheese from abroad.",
        learning_objectives: ["Unpasteurized dairy.", "Cyclical fever."],
        curve: "Household Cluster", incubation: "5-60 days", agent: "Brucella spp.", transmission: "Foodborne",
        spot_map: "Family dining table.",
        counterfactual: "If milk was pasteurized, bacteria killed.",
        controls: ["Pasteurization", "Animal vaccination"],
        questions: [{ q: "Symptom pattern?", a: "Undulating (rising and falling) fever." }]
    },
    {
        id: "C45", disease: "Q Fever", title: "Windy Discharge",
        scenario_text: "Neighbors of a goat farm developing flu-like illness during birthing season.",
        learning_objectives: ["Windborne spread.", "Placental fluids concentrate bacteria."],
        curve: "Continuous", incubation: "2-3 weeks", agent: "Coxiella burnetii", transmission: "Inhalation (Dust)",
        spot_map: "Downwind of the goat farm.",
        counterfactual: "If birth products were disposed of immediately and dust controlled, risk reduced.",
        controls: ["Dust control", "Animal vaccine"],
        questions: [{ q: "Resilience?", a: "Spore-like resistance in environment." }]
    },
    {
        id: "C46", disease: "Coccidioidomycosis", title: "Valley Fever",
        scenario_text: "Construction workers in Arizona with respiratory illness after digging.",
        learning_objectives: ["Soil disturbance.", "Fungal endemicity."],
        curve: "Point-Source (Event)", incubation: "1-3 weeks", agent: "Coccidioides", transmission: "Inhalation (Dust)",
        spot_map: "Excavation site.",
        counterfactual: "If soil was vetted down before digging, spores stay grounded.",
        controls: ["Dust suppression", "Masks"],
        questions: [{ q: "Ethnicity risk?", a: "Higher dissemination risk in Filipino/African ancestry." }]
    },
    {
        id: "C47", disease: "Scombroid", title: "Peppery Fish",
        scenario_text: "Diners at a seafood grill flushing and feeling dizzy minutes after eating Tuna.",
        learning_objectives: ["Histamine intoxication.", "Not an allergy."],
        curve: "Explosive Point-Source", incubation: "10-60 mins", agent: "Histamine", transmission: "Foodborne",
        spot_map: "Ate the Tuna Special.",
        counterfactual: "If fish was kept cold immediately, bacteria wouldn't convert histidine to histamine.",
        controls: ["Cold chain maintenance"],
        questions: [{ q: "Taste?", a: "Peppery or metallic taste." }]
    },
    {
        id: "C48", disease: "Ciguatera", title: "Hot Cold Reversal",
        scenario_text: "Tourists eating Grouper suffer nausea and strange temperature sensation.",
        learning_objectives: ["Bioaccumulation.", "Neurotoxin."],
        curve: "Point-Source", incubation: "3-6 hours", agent: "Ciguatoxin", transmission: "Foodborne (Reef Fish)",
        spot_map: "Dining party.",
        counterfactual: "Cooking does NOT kill the toxin. Avoid large reef fish.",
        controls: ["Avoid eating large predatory reef fish"],
        questions: [{ q: "Hallmark symptom?", a: "Hot feels cold, cold feels hot." }]
    },
    {
        id: "C49", disease: "Naegleria fowleri", title: "The Brain Eater",
        scenario_text: "Boy dies of meningoencephalitis after swimming in a warm lake.",
        learning_objectives: ["Nasal entry.", "Thermal pollution."],
        curve: "Single Case", incubation: "1-9 days", agent: "Naegleria fowleri", transmission: "Water to Nose",
        spot_map: "Lake swimming area.",
        counterfactual: "If nose clip used or head kept above water, amoeba can't enter.",
        controls: ["Nose clips", "Avoid sediment disturbance"],
        questions: [{ q: "Prognosis?", a: ">97% Fatality Rate." }]
    },
    {
        id: "C50", disease: "Zika Virus", title: "Microcephaly",
        scenario_text: "Increase in infants born with small heads in tropical region.",
        learning_objectives: ["Vertical transmission.", "Mosquito vector."],
        curve: "Propagated/Vector", incubation: "3-14 days", agent: "Zika Virus", transmission: "Mosquito/Sexual",
        spot_map: "Region-wide.",
        counterfactual: "If mosquito control was effective, cases drop.",
        controls: ["Mosquito control", "Safe sex"],
        questions: [{ q: "Major concern?", a: "Congenital defects (Microcephaly)." }]
    }
];

if (typeof module !== 'undefined') module.exports = CASE_LIBRARY;
else window.CASE_LIBRARY = CASE_LIBRARY;

const CASE_SCENARIOS = [
    {
        id: "case1",
        title: "Case 1: The Science Fair",
        difficulty: "Beginner",
        steps: [
            {
                text: "<b>Background:</b> 7th graders attended a science fair. 4 hours later, many students reported vomiting (92%) and nausea (87%). None had fever.",
                question: "Based on the symptoms and incubation period (4 hours), what is the most likely agent?",
                options: ["Norovirus", "Staphylococcus aureus toxin", "Salmonella", "E. coli O157:H7"],
                answer: 1,
                feedback: "<b>Correct!</b> Rapid onset (4h) + vomiting without fever strongly suggests a preformed toxin like Staph aureus. Norovirus usually takes 12-48h."
            },
            {
                text: "<b>Investigation:</b> You interview the students. Attack Rates: Chicken Salad (80% vs 33%), Mac & Cheese (80% vs 33%), Fruit (67% vs 60%).",
                question: "Both Chicken Salad and Mac & Cheese have the same Attack Rates. Which is the more likely vehicle for Staph aureus?",
                options: ["Chicken Salad", "Mac & Cheese", "Fruit", "Both are equally likely"],
                answer: 0,
                feedback: "<b>Correct!</b> Chicken Salad is a high-risk food for Staph (hand contact + temperature abuse). Mac & Cheese is less likely to support Staph toxin formation."
            },
            {
                text: "<b>Conclusion:</b> The food handler for the Chicken Salad had a cut on their finger.",
                question: "What type of outbreak source is this?",
                options: ["Point Source", "Continuous Source", "Propagated", "Intermittent"],
                answer: 0,
                feedback: "<b>Correct!</b> This is a Point Source outbreak: single exposure event, rapid onset, and tight clustering of cases."
            }
        ]
    },
    {
        id: "case2",
        title: "Case 2: The Middle School Cluster",
        difficulty: "Intermediate",
        steps: [
            {
                text: "<b>Background:</b> A cluster of respiratory illness is reported in a middle school. The Epi Curve shows multiple small peaks separated by 1-4 days over a 10-day period.",
                question: "What pattern does this Epi Curve suggest?",
                options: ["Point Source", "Common Source", "Propagated", "Environmental"],
                answer: 2,
                feedback: "<b>Correct!</b> Multiple waves or peaks separated by incubation periods indicates person-to-person transmission (propagated)."
            },
            {
                text: "<b>Data Analysis:</b> You calculate Attack Rates by Homeroom: C1 (67%), C2 (100%), C3 (33%), C4 (25%).",
                question: "What does this distribution suggest?",
                options: ["Cafeteria food is the cause", "Transmission is occurring in classrooms (C1, C2)", "Ventilation system failure", "Water fountain contamination"],
                answer: 1,
                feedback: "<b>Correct!</b> Clustering in specific homerooms (C1, C2) suggests close-contact transmission (droplet) is happening within those rooms."
            },
            {
                text: "<b>Further Investigation:</b> You find that students in C1 and C2 share a choir class.",
                question: "How does this support your hypothesis?",
                options: ["It doesn't", "Singing increases droplet spread, supporting person-to-person transmission", "It suggests a waterborne source in the choir room", "It proves airborne transmission"],
                answer: 1,
                feedback: "<b>Correct!</b> Singing is a high-risk activity for droplet spread, reinforcing the propagated/person-to-person hypothesis."
            }
        ]
    },
    {
        id: "case3",
        title: "Case 3: The Wedding Banquet",
        difficulty: "Advanced",
        steps: [
            {
                text: "<b>Background:</b> Guests at a wedding banquet fall ill. Onset times vary from 12 to 36 hours after the meal.",
                question: "Which agent fits this incubation period?",
                options: ["Staph aureus", "Salmonella", "Botulism", "Chemical toxin"],
                answer: 1,
                feedback: "<b>Correct!</b> Salmonella typically has an incubation period of 6-72 hours (average 12-36h). Staph is much faster (2-4h)."
            },
            {
                text: "<b>Epi Curve:</b> The curve shows a log-normal distribution with a single peak.",
                question: "What does this curve shape imply?",
                options: ["Propagated outbreak", "Point source outbreak", "Continuous source", "Endemic disease"],
                answer: 1,
                feedback: "<b>Correct!</b> A single peak with a log-normal (steep up, gradual down) shape is characteristic of a Point Source outbreak."
            },
            {
                text: "<b>Outlier:</b> One case had onset 2 hours before the meal.",
                question: "How do you interpret this outlier?",
                options: ["The vehicle was served earlier", "This is likely the primary case (index) or a background case", "The incubation period is shorter than thought", "It proves the food wasn't the cause"],
                answer: 1,
                feedback: "<b>Correct!</b> A case occurring before the exposure is likely a background case (unrelated) or the index case who contaminated the food/environment."
            }
        ]
    },
    {
        id: "case4",
        title: "Case 4: The Basketball Game",
        difficulty: "Intermediate",
        steps: [
            {
                text: "<b>Background:</b> Several students fell ill after a basketball game. You survey attendees.",
                question: "Data: Sick/Total (3/4) vs Not Sick/Total (3/4). What is the Risk Ratio?",
                options: ["2.0", "0.5", "1.0", "1.5"],
                answer: 2,
                feedback: "<b>Correct!</b> AR(exposed) = 75%, AR(unexposed) = 75%. RR = 0.75 / 0.75 = 1.0. The game is NOT the cause."
            },
            {
                text: "<b>Re-evaluation:</b> You look for other common exposures. All sick students ate at a specific concession stand.",
                question: "What is your next step?",
                options: ["Close the school", "Calculate AR for specific food items at the stand", "Test the water", "Interview the basketball players"],
                answer: 1,
                feedback: "<b>Correct!</b> You need to identify the specific vehicle. Calculate Attack Rates for each food item served at the stand."
            }
        ]
    },
    {
        id: "case5",
        title: "Case 5: The Picnic Salad",
        difficulty: "Beginner",
        steps: [
            {
                text: "<b>Background:</b> A potato salad is suspected in an outbreak. AR(eaten) = 80%, AR(not eaten) = 10%.",
                question: "Calculate the Relative Risk (RR).",
                options: ["8.0", "0.8", "7.0", "80%"],
                answer: 0,
                feedback: "<b>Correct!</b> RR = 80% / 10% = 8.0. This is a strong association."
            },
            {
                text: "<b>Context:</b> The salad was left out in the sun for 5 hours.",
                question: "What factor contributed most to this outbreak?",
                options: ["Acidic ingredients", "Temperature abuse", "Cross-contamination", "Improper cooking"],
                answer: 1,
                feedback: "<b>Correct!</b> Leaving food in the 'Danger Zone' (40-140Â°F) for >2 hours allows bacteria to multiply. This is Temperature Abuse."
            }
        ]
    },
    {
        id: "case6",
        title: "Case 6: The Swimming Pool",
        difficulty: "Intermediate",
        steps: [
            {
                text: "<b>Background:</b> Kids report diarrhea after swimming. Cryptosporidium is suspected.",
                question: "Why is 'Crypto' a common pool pathogen?",
                options: ["It multiplies in water", "It is chlorine-resistant", "It is airborne", "It comes from algae"],
                answer: 1,
                feedback: "<b>Correct!</b> Cryptosporidium has a thick outer shell that makes it highly resistant to standard chlorine levels."
            },
            {
                text: "<b>Control:</b> The pool operator wants to shock the pool with chlorine.",
                question: "Is this sufficient?",
                options: ["Yes, standard shock works", "No, hyperchlorination is required for Crypto", "No, the pool must be drained", "Yes, if done overnight"],
                answer: 1,
                feedback: "<b>Correct!</b> Crypto requires Hyperchlorination (very high levels for long time) or UV treatment to kill. Standard shock is often not enough."
            }
        ]
    },
    {
        id: "case7",
        title: "Case 7: The Unknown Toxin",
        difficulty: "Advanced",
        steps: [
            {
                text: "<b>Background:</b> Diners report numbness and tingling in lips after eating fish.",
                question: "What is the likely agent?",
                options: ["Scombroid", "Ciguatera", "Salmonella", "Norovirus"],
                answer: 1,
                feedback: "<b>Correct!</b> Numbness/tingling (paresthesia) and temperature reversal are classic signs of Ciguatera toxin from reef fish."
            },
            {
                text: "<b>Prevention:</b> The chef asks how to cook the fish to destroy the toxin.",
                question: "What do you tell them?",
                options: ["Cook to 165Â°F", "Freeze for 24 hours", "The toxin is heat-stable and cannot be destroyed", "Marinate in lime juice"],
                answer: 2,
                feedback: "<b>Correct!</b> Ciguatoxin is heat-stable. Cooking or freezing does NOT destroy it. Prevention relies on not eating large reef fish from risky areas."
            }
        ]
    },
    {
        id: "case8",
        title: "Case 8: The Camping Trip",
        difficulty: "Beginner",
        steps: [
            {
                text: "<b>Background:</b> Campers develop bloody diarrhea after drinking from a stream.",
                question: "Which pathogen is most likely?",
                options: ["Giardia", "E. coli O157:H7", "Norovirus", "Staph aureus"],
                answer: 1,
                feedback: "<b>Correct!</b> Bloody diarrhea (dysentery) is a hallmark of E. coli O157:H7 (or Shigella/Campylobacter). Giardia causes greasy, non-bloody stool."
            },
            {
                text: "<b>Treatment:</b> A parent wants to give antibiotics.",
                question: "Is this recommended for E. coli O157:H7?",
                options: ["Yes, immediately", "No, it increases risk of HUS", "Yes, but only penicillin", "No, it causes resistance"],
                answer: 1,
                feedback: "<b>Correct!</b> Antibiotics can increase the release of Shiga toxin, raising the risk of Hemolytic Uremic Syndrome (HUS). Supportive care is best."
            }
        ]
    },
    {
        id: "case9",
        title: "Case 9: The Daycare",
        difficulty: "Intermediate",
        steps: [
            {
                text: "<b>Background:</b> Shigella outbreak in a daycare. Transmission is rapid.",
                question: "Why does Shigella spread so easily?",
                options: ["It is airborne", "It has a very low infectious dose", "It survives on dry surfaces for years", "It is vector-borne"],
                answer: 1,
                feedback: "<b>Correct!</b> Shigella has a very low infectious dose (10-100 bacteria), making person-to-person (fecal-oral) transmission very efficient."
            },
            {
                text: "<b>Control:</b> What is the most critical control measure?",
                question: "Select the best option.",
                options: ["Handwashing supervision", "Closing the kitchen", "Spraying for bugs", "Testing the water"],
                answer: 0,
                feedback: "<b>Correct!</b> Since it's fecal-oral and low dose, supervised Handwashing is the most effective intervention in a daycare setting."
            }
        ]
    },
    {
        id: "case10",
        title: "Case 10: The Cruise Ship",
        difficulty: "Beginner",
        steps: [
            {
                text: "<b>Background:</b> Hundreds of passengers vomit. The ship returns to port.",
                question: "What is the classic 'Cruise Ship Virus'?",
                options: ["Influenza", "Norovirus", "Rotavirus", "Adenovirus"],
                answer: 1,
                feedback: "<b>Correct!</b> Norovirus is the most common cause of outbreaks on cruise ships due to close quarters and environmental persistence."
            },
            {
                text: "<b>Cleanup:</b> The crew uses alcohol sanitizer.",
                question: "Is this effective for Norovirus?",
                options: ["Yes, highly effective", "No, Norovirus is resistant to alcohol", "Only if 90% alcohol", "Yes, if hands are dry"],
                answer: 1,
                feedback: "<b>Correct!</b> Norovirus is non-enveloped and resistant to alcohol. Bleach or soap and water (mechanical removal) are required."
            }
        ]
    },
    {
        id: "case11",
        title: "Case 11: The Farm Visit",
        difficulty: "Intermediate",
        steps: [
            {
                text: "<b>Background:</b> Children visit a petting zoo. Some develop diarrhea and fever.",
                question: "What is a common zoonotic pathogen here?",
                options: ["Salmonella", "Hepatitis A", "Norovirus", "Measles"],
                answer: 0,
                feedback: "<b>Correct!</b> Salmonella (and E. coli, Campylobacter) are common in reptile/amphibian/poultry/livestock feces at petting zoos."
            },
            {
                text: "<b>Risk Factor:</b> One child ate a sandwich without washing hands.",
                question: "What mode of transmission is this?",
                options: ["Direct contact", "Indirect contact (Fecal-Oral)", "Vector-borne", "Airborne"],
                answer: 1,
                feedback: "<b>Correct!</b> This is Indirect Contact (Fecal-Oral) via hand-to-mouth transfer."
            }
        ]
    },
    {
        id: "case12",
        title: "Case 12: The Church Supper",
        difficulty: "Advanced",
        steps: [
            {
                text: "<b>Background:</b> Canned green beans are served. People develop double vision and difficulty swallowing.",
                question: "This is a medical emergency. What is the disease?",
                options: ["Botulism", "Guillain-Barre", "Stroke", "Listeria"],
                answer: 0,
                feedback: "<b>Correct!</b> Double vision (diplopia), dysphagia, and descending paralysis are classic signs of Botulism neurotoxin."
            },
            {
                text: "<b>Mechanism:</b> How did the beans become dangerous?",
                question: "Select the cause.",
                options: ["Not cooked long enough", "Improper home canning (anaerobic environment)", "Left out too long", "Contaminated by flies"],
                answer: 1,
                feedback: "<b>Correct!</b> C. botulinum spores germinate in anaerobic (oxygen-free) environments like improper home canning, producing the toxin."
            }
        ]
    },
    {
        id: "case13",
        title: "Case 13: The Hospital Wing",
        difficulty: "Advanced",
        steps: [
            {
                text: "<b>Background:</b> Patients with open wounds develop infections. MRSA is identified.",
                question: "What type of transmission is most likely?",
                options: ["Airborne via vents", "Contact via healthcare workers' hands", "Waterborne", "Foodborne"],
                answer: 1,
                feedback: "<b>Correct!</b> MRSA in hospitals is primarily spread via the hands of healthcare workers or contaminated equipment (fomites)."
            },
            {
                text: "<b>Intervention:</b> Rates remain high despite hand hygiene.",
                question: "What is the next level of precaution?",
                options: ["Contact Precautions (Gown/Glove)", "Airborne Precautions (N95)", "Droplet Precautions (Mask)", "Standard Precautions"],
                answer: 0,
                feedback: "<b>Correct!</b> Contact Precautions (Gowns and Gloves for all interactions) are necessary for MDROs like MRSA."
            }
        ]
    },
    {
        id: "case14",
        title: "Case 14: The Dormitory",
        difficulty: "Intermediate",
        steps: [
            {
                text: "<b>Background:</b> A college student has stiff neck, fever, and rash. Meningitis is suspected.",
                question: "What is the immediate public health action?",
                options: ["Wait for lab confirmation", "Prophylaxis for close contacts", "Quarantine the entire dorm", "Vaccinate everyone immediately"],
                answer: 1,
                feedback: "<b>Correct!</b> Bacterial meningitis is rapid and deadly. Chemoprophylaxis (antibiotics) for close contacts is urgent, even before final lab confirmation."
            },
            {
                text: "<b>Type:</b> The rash is petechial (non-blanching).",
                question: "This points to which pathogen?",
                options: ["Neisseria meningitidis", "Viral meningitis", "Fungal meningitis", "Tuberculosis"],
                answer: 0,
                feedback: "<b>Correct!</b> Meningococcal disease (Neisseria) causes the characteristic petechial/purpuric rash."
            }
        ]
    },
    {
        id: "case15",
        title: "Case 15: The Mosquito Bite",
        difficulty: "Beginner",
        steps: [
            {
                text: "<b>Background:</b> A traveler returns from the tropics with high fever and joint pain.",
                question: "Which vector is likely responsible?",
                options: ["Anopheles mosquito", "Aedes aegypti mosquito", "Tick", "Flea"],
                answer: 1,
                feedback: "<b>Correct!</b> Aedes mosquitoes carry Dengue, Chikungunya, and Zika, which cause fever and joint pain. Anopheles carries Malaria."
            },
            {
                text: "<b>Control:</b> How do we control Aedes mosquitoes?",
                question: "Select the best method.",
                options: ["Bed nets at night", "Eliminate standing water (containers)", "Spray forests", "Avoid animals"],
                answer: 1,
                feedback: "<b>Correct!</b> Aedes breed in small containers (tires, pots) around homes and bite during the day. Eliminating standing water is key. Bed nets help less since they are day-biters."
            }
        ]
    },
    {
        id: "case16",
        title: "Mastery Case: The National Nightmare",
        difficulty: "Advanced",
        steps: [
            {
                text: "<b>Data Cleaning:</b> You receive a line list for a wedding outbreak. <br>Case A: Onset 12:00 PM, Meal 2:00 PM.<br>Case B: Onset 6:00 PM, Meal 2:00 PM.<br>Case C: Onset 7:00 PM, Meal 2:00 PM.",
                question: "Which record should be excluded from analysis?",
                options: ["Case A", "Case B", "Case C", "None"],
                answer: 0,
                feedback: "<b>Correct!</b> Case A has an onset time <i>before</i> the exposure time. This is logically impossible for a foodborne outbreak and is likely a data entry error or a background case."
            },
            {
                text: "<b>Confounding Check:</b> You calculate the Crude OR for 'Beef' as 4.5. You suspect Gender is a confounder. You stratify by Gender.<br>Male OR = 1.2<br>Female OR = 1.1",
                question: "What does this suggest?",
                options: ["Effect Modification", "Confounding", "No Association", "Selection Bias"],
                answer: 1,
                feedback: "<b>Correct!</b> The stratum-specific ORs (1.2 and 1.1) are similar to each other but significantly different from the Crude OR (4.5). This is the definition of Confounding."
            },
            {
                text: "<b>Adjustment:</b> Since Confounding is present, the Crude OR is invalid.",
                question: "Which statistical method should you use to calculate the true association?",
                options: ["Chi-Square Test", "Mantel-Haenszel Adjusted OR", "Fisher's Exact Test", "T-Test"],
                answer: 1,
                feedback: "<b>Correct!</b> The Mantel-Haenszel method calculates a weighted average of the stratum-specific ORs to provide an Adjusted OR that removes the confounding effect."
            },
            {
                text: "<b>Bias Hunt:</b> You find that the 'Controls' were selected from a group of health-conscious gym members.",
                question: "What type of bias does this introduce?",
                options: ["Recall Bias", "Berkson's Bias", "Selection Bias (Healthy Worker)", "Information Bias"],
                answer: 2,
                feedback: "<b>Correct!</b> Selecting controls that are systematically different (healthier) from the general population or the case population introduces Selection Bias, specifically a variant of the Healthy Worker Effect."
            }
        ]
    }
];

window.CASE_SCENARIOS = CASE_SCENARIOS;

window.APPENDIX_DATA = {
    RULES: [
        ["Outbreak steps", ["#learning", "#cases", "#tools", "#quiz"],
            "<strong>The 10-Step Method:</strong> Mastery of the CDC's investigation sequence is critical. <br><br>1. Prepare<br>2. Verify Diagnosis<br>3. Confirm Outbreak<br>4. Case Definition<br>5. Descriptive Epi<br>6. Hypothesize<br>7. Test Hypothesis (Analytic)<br>8. Refine/Add Studies<br>9. Control Measures<br>10. Communicate Findings."],

        ["Study designs", ["#learning", "#quiz"],
            "<strong>Design Selection:</strong> Knowing which study fits the situation.<br><ul><li><strong>Cohort:</strong> Best for rare exposures. Calculates Relative Risk.</li><li><strong>Case-Control:</strong> Best for rare diseases or food/outbreaks. Calculates Odds Ratio.</li><li><strong>Cross-Sectional:</strong> Snapshot in time (Prevalence).</li></ul>"],

        ["Measures (AR, RR, OR, RD)", ["#tools", "#quiz", "#notesheet"],
            "<strong>Quantitative Epidemiology:</strong><br><ul><li><strong>Attack Rate:</strong> The percentage of an at-risk group that becomes ill.</li><li><strong>Relative Risk (RR):</strong> Risk in exposed / Risk in unexposed.</li><li><strong>Odds Ratio (OR):</strong> Odds of exposure in cases / Odds of exposure in controls.</li></ul>"],

        ["Epi curves/spot maps", ["#tools", "#cases", "#quiz"],
            "<strong>Descriptive Epi (Time & Place):</strong><br><ul><li><strong>Point Source:</strong> Single sharp peak, one incubation period.</li><li><strong>Propagated:</strong> Multiple peaks, growing waves, person-to-person spread.</li><li><strong>Spot Map:</strong> Geographic clustering of cases.</li></ul>"],

        ["Bias/confounding/EM", ["#learning", "#quiz"],
            "<strong>Systematic Errors:</strong><br><ul><li><strong>Selection Bias:</strong> Groups differ in ways other than exposure.</li><li><strong>Information Bias:</strong> Measurement error (Recall, Interviewer).</li><li><strong>Confounding:</strong> A third variable distorts the true association.</li></ul>"],

        ["Screening (Se/Sp, PPV, NPV)", ["#tools", "#quiz"],
            "<strong>test Validity:</strong><br><ul><li><strong>Sensitivity:</strong> Ability to identify positives (TP / All Sick).</li><li><strong>Specificity:</strong> Ability to identify negatives (TN / All Healthy).</li><li><strong>PPV:</strong> Probability a +test is actually sick.</li></ul>"],

        ["Control & prevention", ["#cases", "#learning"],
            "<strong>Public Health Action:</strong><br><ul><li><strong>Primary:</strong> Prevent before it happens (Vaccine).</li><li><strong>Secondary:</strong> catch it early (Screening).</li><li><strong>Tertiary:</strong> Treat/Rehab to prevent worsening.</li></ul>"],

        ["Communication/reporting", ["#learning"],
            "<strong>The Final Step:</strong> Communicating to stakeholders, ensuring privacy (HIPAA), and documenting findings for future reference."]
    ],
    BIASES: [
        ["Selection â€“ Nonresponse", "Participants differ from nonparticipants", "Track response, weight, simplify sampling frame"],
        ["Selection â€“ Healthy worker", "Employed groups look healthier", "Compare to appropriate worker referent"],
        ["Selection â€“ Berkson", "Hospital cases/controls distort exposure", "Prefer population controls"],
        ["Survivorship", "Long-term survivors overrepresented", "Use inception cohorts"],
        ["Loss to follow-up", "Differential attrition", "Retention protocols; sensitivity analysis"],
        ["Recall", "Cases remember exposures better", "Use records; blinding; neutral prompts"],
        ["Interviewer", "Probing differs by status", "Training; blinding; scripts"],
        ["Misclassification â€“ Non-diff", "Equal error in groups â†’ bias to null", "Improve measurement; validation subsample"],
        ["Misclassification â€“ Diff", "Error differs by group", "Standardize ascertainment; blinding"],
        ["Confounding", "Third variable distorts association", "Randomize, restrict, match, adjust, stratify"],
        ["Effect modification", "True heterogeneity", "Report stratum-specific; no adjustment"],
        ["Instrumentation", "Tool drift over time", "Calibration schedule"],
        ["Maturation", "Natural change over time", "Controls; interrupted time series"],
        ["History", "External events alter outcomes", "Document and adjust; ITS"],
        ["Regression to mean", "Extremes move toward mean", "Multiple baselines; controls"],
        ["Hawthorne", "Behavior changes when observed", "Run-in period; unobtrusive measures"],
        ["Placebo", "Expectations alter response", "Placebo control, blinding"],
        ["Contamination", "Controls receive intervention", "Cluster design; separation"],
        ["Carryover", "Prior period affects next", "Washout; parallel design"],
        ["Observer expectancy", "Coder expectations skew coding", "Double blinding; dual coding"],
        ["Publication", "Positive results overrepresented", "Pre-registration; report nulls"],
        ["Ecological", "Group-level effects misapplied to individuals", "Analyze at individual level"],
        ["Aggregation", "Combining heterogeneous groups hides truth", "Stratify; random effects"],
        ["Collinearity", "Predictors correlated", "Dimension reduction; penalization"],
        ["Overfitting", "Model captures noise", "Holdout/regularization"],
        ["Multiple testing", "Inflated Type I error", "Adjust alpha; pre-specify"],
        ["P-hacking", "Data dredging", "Analysis plan; transparency"],
        ["Outcome switching", "Change outcomes post-hoc", "Pre-register; version control"],
        ["Data leakage", "Train on test info", "Strict splits; audit"],
        ["Simpsonâ€™s paradox", "Trend reverses after stratification", "Stratify; causal diagrams"]
    ],
    MNEMS: [
        ["PVC-CDHACC", "Prepare, Verify, Case-def, Describe, Hypothesize, Analyze, Refine, Control, Communicate"],
        ["SPEC", "Sensitivity, PPV; Error types; Cutoffs"],
        ["METRIC", "Mean, Error, Trend, Rate, Incidence, CI"],
        ["CURVES", "Choose bin, Understand shape, Reconstruct exposure, Verify window, Explain spread, Summarize"],
        ["SNOUT", "Sensitivity => SeNsitive rules OUT (High sensitivity is good for ruling out disease)"],
        ["SPIN", "Specificity => SPecific rules IN (High specificity is good for ruling in disease)"],
        ["DDA", "Data, Design, Analysis (Triad of Epidemiology)"],
        ["RET EH", "Reservoir, Escape, Transmission, Entry, Host (Chain of Infection)"],
        ["PÂ²STQ", "Population, Parameter, Sample, Statistic, Question (Stats Basics)"],
        ["FAIR", "Feasible, Ambitious, Imaginable, Relevant (Research Question)"]
    ],
    RESOURCES: [
        { title: "CDC Current Outbreak List", url: "https://www.cdc.gov/outbreaks/index.html", desc: "Real-time data on active US outbreaks." },
        { title: "Science Olympiad Official Site", url: "https://www.soinc.org/disease-detectives-b", desc: "Rules, clarifications, and official handouts." },
        { title: "WHO Disease Outbreak News", url: "https://www.who.int/emergencies/disease-outbreak-news", desc: "Global alerts and situation reports." },
        { title: "MMWR (Morbidity and Mortality Weekly Report)", url: "https://www.cdc.gov/mmwr/index.html", desc: "The 'Voice of CDC' - primary source for case studies." },
        { title: "Epiville (Columbia University)", url: "http://epiville.ccnmtl.columbia.edu/", desc: "Interactive simulations and learning modules." }
    ],
    flashcards: [
        { front: "Incidence", back: "New cases over a period of time / Population at risk" },
        { front: "Prevalence", back: "Existing cases at a point in time / Total population" },
        { front: "Attack Rate", back: "Ill / (Ill + Well) x 100" },
        { front: "Relative Risk (RR)", back: "[a/(a+b)] / [c/(c+d)]" },
        { front: "Odds Ratio (OR)", back: "(a*d) / (b*c)" },
        { front: "Sensitivity", back: "True Positives / (True Positives + False Negatives)" },
        { front: "Specificity", back: "True Negatives / (True Negatives + False Positives)" },
        { front: "Type I Error", back: "False Positive (Rejecting a true null hypothesis)" },
        { front: "Type II Error", back: "False Negative (Failing to reject a false null hypothesis)" },
        { front: "Confounding", back: "Distortion of association by a third variable related to both exposure and outcome" },
        { front: "Herd Immunity", back: "Resistance of a group to invasion and spread of an infectious agent" },
        { front: "R0 (Basic Reproduction Number)", back: "Average number of secondary cases produced by one case in a completely susceptible population" },
        { front: "Fomite", back: "Inanimate object that can transmit disease (e.g., doorknob)" },
        { front: "Vector", back: "Living organism that transmits disease (e.g., mosquito)" },
        { front: "Zoonosis", back: "Disease transmissible from animals to humans" },
        { front: "Endemic", back: "Constant presence of disease in a population" },
        { front: "Epidemic", back: "Disease occurrence in excess of normal expectancy" },
        { front: "Pandemic", back: "Epidemic occurring over a wide area (crossing international boundaries)" },
        { front: "Incubation Period", back: "Time from exposure to onset of symptoms" },
        { front: "Latent Period", back: "Time from infection to infectiousness" },
        { front: "Hippocrates", back: "First to attempt to explain disease occurrence from a rational rather than supernatural viewpoint (400 BC)" },
        { front: "John Graunt", back: "Published landmark analysis of mortality data in 1662; early vital statistics" },
        { front: "James Lind", back: "Designed first controlled experiment (1747) showing limes prevent scurvy" },
        { front: "Edward Jenner", back: "Developed smallpox vaccine using cowpox (1796)" },
        { front: "John Snow", back: "Father of Epidemiology; investigated cholera in London (1854) using spot maps" },
        { front: "Louis Pasteur", back: "Germ theory; developed vaccines for anthrax and rabies" },
        { front: "Robert Koch", back: "Formalized postulates to identify organisms with infectious diseases" },
        { front: "Joseph Goldberger", back: "Identified pellagra as a nutritional deficiency (1920)" },
        { front: "Mantel & Haenszel", back: "Developed statistical procedure for stratified analysis of case-control studies" },
        { front: "Doll & Hill", back: "Conducted landmark studies linking smoking to lung cancer (1950s)" },
        { front: "Wheel Model", back: "Places the host at the centre with physical, biologic and social environments around it" },
        { front: "Web of Causation", back: "Interconnected network of factors with no single necessary agent" },
        { front: "Rothmanâ€™s Causal Pie", back: "Component causes combine to form a sufficient cause (pie) that produces disease" },
        { front: "Healthy Worker Effect", back: "Bias where working populations appear healthier than the general population" },
        { front: "Lengthâ€‘Time Bias", back: "Screening detects slowerâ€‘growing diseases more easily, making prognosis appear better" },
        { front: "Logistic Regression", back: "Multivariate model estimating adjusted odds ratios for binary outcomes" },
        { front: "Mantel-Haenszel OR", back: "Weighted average of strata-specific odds ratios to adjust for confounding" },
        { front: "Survival Analysis", back: "Statistics dealing with time-to-event data (e.g., Kaplan-Meier curves)" },
        { front: "IHR (2005)", back: "International Health Regulations: Legally binding framework for global health security" },
        { front: "Prion", back: "Abnormal protein that triggers other proteins to fold abnormally (e.g., CJD, Kuru)" },
        { front: "Analytic Epidemiology", back: "Study of determinants (Why/How); tests hypotheses" },
        { front: "Descriptive Epidemiology", back: "Study of distribution (Who/Where/When); generates hypotheses" },
        { front: "Vehicle", back: "Non-living intermediary that conveys agent (e.g. food, water, blood)" },
        { front: "Active Surveillance", back: "Health department solicits reports from providers (More expensive, accurate)" },
        { front: "Passive Surveillance", back: "Health department waits for reports (Cheaper, underreporting)" },
        { front: "Sentinel Surveillance", back: "Monitoring key sites to estimate wider trends" },
        { front: "Syndromic Surveillance", back: "Using pre-diagnosis data (e.g. OTC sales) for early warning" },
        { front: "Case Fatality Rate (CFR)", back: "Percentage of cases that result in death (Deaths / Cases)" },
        { front: "Crude Mortality Rate", back: "Total deaths / Total population (Not adjusted)" },
        { front: "Cause-Specific Rate", back: "Deaths from cause X / Total population" },
        { front: "Proportionate Mortality", back: "Deaths from cause X / Total Deaths" },
        { front: "Neonatal Mortality", back: "Deaths in first 28 days of life / Live births" },
        { front: "Infant Mortality", back: "Deaths in first year of life / Live births" },
        { front: "Maternal Mortality", back: "Maternal deaths / Live births" },
        { front: "Hyperendemic", back: "Disease constantly present at high incidence" },
        { front: "Holoendemic", back: "Prevalent disease affecting most children early in life (e.g. Malaria)" },
        { front: "Sporadic", back: "Occurring irregularly and infrequently" },
        { front: "Virulence", back: "Ability to cause SEVERE disease (Case Fatality Rate)" },
        { front: "Infectivity", back: "Ability to enter, survive, and multiply in host" },
        { front: "Pathogenicity", back: "Ability to cause CLINICAL disease (Symptoms)" }
    ],
    glossary: [
        { term: "Agent", definition: "A factor (microorganism, chemical, etc.) whose presence or absence is essential for disease." },
        { term: "Bias", definition: "Systematic deviation of results or inferences from the truth." },
        { term: "Carrier", definition: "Person or animal that harbors a specific infectious agent without discernible clinical disease." },
        { term: "Case-Control Study", definition: "Observational study comparing those with disease (cases) to those without (controls)." },
        { term: "Cluster", definition: "An aggregation of cases over a particular period closely grouped in time and space, regardless of whether the number is more than the expected number." },
        { term: "Cohort Study", definition: "Observational study comparing those exposed to a factor to those unexposed." },
        { term: "Cross-Sectional Study", definition: "Study examining the relationship between diseases and other variables at one point in time." },
        { term: "Epidemic", definition: "The occurrence of more cases of disease than expected in a given area or among a specific group of people over a particular period of time." },
        { term: "Epidemic Curve", definition: "Histogram showing the course of a disease outbreak or epidemic." },
        { term: "Fomite", definition: "An inanimate object that can be the vehicle for transmission of an infectious agent (e.g., bedding, towels, surgical instruments)." },
        { term: "Host", definition: "Person or other living animal that affords subsistence or lodgment to an infectious agent." },
        { term: "Incidence", definition: "A measure of the frequency with which a new case of illness occurs in a population over a period of time." },
        { term: "Index Case", definition: "The first case to come to the attention of the investigator." },
        { term: "Isolation", definition: "Separation of infected persons to prevent transmission." },
        { term: "Morbidity", definition: "Any departure, subjective or objective, from a state of physiological or psychological well-being." },
        { term: "Mortality Rate", definition: "A measure of the frequency of occurrence of death in a defined population." },
        { term: "Outbreak", definition: "Synonymous with epidemic, usually used for a more localized area." },
        { term: "Pandemic", definition: "An epidemic occurring over a very wide area (several countries or continents) and usually affecting a large proportion of the population." },
        { term: "Pathogenicity", definition: "The ability of an agent to cause disease." },
        { term: "Prevalence", definition: "The proportion of cases (new and existing) in a population at a given time." },
        { term: "Quarantine", definition: "Restriction of activities of well persons who have been exposed to a case." },
        { term: "Reservoir", definition: "Habitat in which the agent normally lives, grows, and multiplies." },
        { term: "Risk", definition: "The probability that an individual will be affected by, or die from, an illness or injury within a stated time or age span." },
        { term: "Risk Factor", definition: "Aspect of personal behavior or lifestyle, environmental exposure, or inborn/inherited characteristic associated with health conditions." },
        { term: "Surveillance", definition: "Systematic collection, analysis, interpretation, and dissemination of health data." },
        { term: "Transmission", definition: "Any mode or mechanism by which an infectious agent is spread." },
        { term: "Vector", definition: "An animate intermediary in the indirect transmission of an agent that carries the agent from a reservoir to a susceptible host." },
        { term: "Virulence", definition: "The ability of an infectious agent to cause severe disease." },
        { term: "Zoonosis", definition: "An infectious disease that is transmissible under natural conditions from vertebrate animals to humans." },
        { term: "Wheel Model", definition: "A causation model that emphasises the host at the centre of concentric rings representing physical, biologic and social environments." },
        { term: "Web of Causation", definition: "A representation of disease causation as a network of interconnected factors without a single necessary agent." },
        { term: "Causal Pie", definition: "A model where multiple component causes form a sufficient cause (pie) that produces disease when complete." },
        { term: "Healthy Worker Effect", definition: "A bias arising because employed populations tend to be healthier than the general population, potentially underestimating risk." },
        { term: "Lengthâ€‘Time Bias", definition: "A bias introduced by screening when slowly progressing diseases are more likely to be detected than aggressive ones." },
        { term: "Logistic Regression", definition: "A statistical model used to estimate adjusted odds ratios for a binary outcome while controlling for multiple variables." },
        { term: "YPLL", definition: "Years of Potential Life Lost: Measure of premature mortality." },
        { term: "SMR", definition: "Standardized Mortality Ratio: Observed deaths / Expected deaths." },
        { term: "Age-Adjustment", definition: "Process to remove the effect of age differences when comparing rates." },
        { term: "Prion Disease", definition: "Disease caused by misfolded proteins (e.g. Mad Cow)." },
        { term: "Recency Bias", definition: "Tendency to weigh recent events more heavily." },
        { term: "Anchoring Bias", definition: "Tendency to rely too heavily on the first piece of information." },
        { term: "Analytic Epidemiology", definition: "Testing hypotheses about relationships (Determinants)." },
        { term: "Descriptive Epidemiology", definition: "Characterizing amount/distribution of disease (Person/Place/Time)." },
        { term: "Vehicle", definition: "Non-living intermediary (e.g. Food, Water, Biologics)." },
        { term: "Active Surveillance", definition: "Health dept contacts providers to solicit reports." },
        { term: "Passive Surveillance", definition: "Health dept waits for reports from providers." },
        { term: "Sentinel Surveillance", definition: "Monitoring key sites to infer general population health." },
        { term: "Syndromic Surveillance", definition: "Using pre-diagnostic data (ER visits, sales) for early warning." },
        { term: "Case Fatality Rate", definition: "Proportion of cases that result in death (Severity)." },
        { term: "Crude Rate", definition: "Summary rate based on actual number of events in total population." },
        { term: "Adjusted Rate", definition: "Rate statistically modified to remove effect of a confounder (e.g. Age)." },
        { term: "Hyperendemic", definition: "Disease present at consistently high levels." },
        { term: "Holoendemic", definition: "Disease affecting most of the population early in life." },
        { term: "Infant Mortality Rate", definition: "Deaths under 1 year of age per 1,000 live births." },
        { term: "Maternal Mortality Ratio", definition: "Maternal deaths per 100,000 live births." },
        { term: "Neonatal Mortality Rate", definition: "Deaths under 28 days of age per 1,000 live births." },
        { term: "Infectivity", definition: "Capacity to enter, survive, and multiply in a host." }
    ],
    FORMULAS: [
        { name: "Attack Rate (AR)", calc: "(Ill / Total Exposed) Ã— 100", use: "% of group that became ill", category: "Frequency" },
        { name: "Relative Risk (RR)", calc: "[a/(a+b)] / [c/(c+d)]", use: "Cohort studies", category: "Association" },
        { name: "Odds Ratio (OR)", calc: "(a Ã— d) / (b Ã— c)", use: "Case-control studies", category: "Association" },
        { name: "Attributable Risk (AR)", calc: "I(exposed) - I(unexposed)", use: "Excess risk from exposure", category: "Impact" },
        { name: "AR% (Attributable Risk %)", calc: "[(RR - 1) / RR] Ã— 100", use: "% of disease due to exposure", category: "Impact" },
        { name: "Vaccine Efficacy (VE)", calc: "[(AR(unvax) - AR(vax)) / AR(unvax)] Ã— 100", use: "% reduction in disease", category: "Impact" },
        { name: "Sensitivity", calc: "a / (a + c)", use: "True positives / All sick", category: "Screening" },
        { name: "Specificity", calc: "d / (b + d)", use: "True negatives / All healthy", category: "Screening" },
        { name: "PPV (Positive Predictive Value)", calc: "a / (a + b)", use: "Probability positive test = sick", category: "Screening" },
        { name: "NPV (Negative Predictive Value)", calc: "d / (c + d)", use: "Probability negative test = healthy", category: "Screening" },
        { name: "Chi-Square", calc: "Î£ [(O - E)Â² / E]", use: "Testing statistical significance", category: "Statistics" },
        { name: "Standard Error (RR)", calc: "âˆš[(1/a) + (1/c) - (1/(a+b)) - (1/(c+d))]", use: "Confidence Intervals for RR", category: "Statistics" }
    ],
    TABLES: {
        chiSqure: {
            title: "Chi-Square Critical Values",
            headers: ["df", "p=0.10", "p=0.05", "p=0.01", "p=0.001"],
            rows: [
                [1, "2.706", "3.841", "6.635", "10.828"],
                [2, "4.605", "5.991", "9.210", "13.816"],
                [3, "6.251", "7.815", "11.345", "16.266"],
                [4, "7.779", "9.488", "13.277", "18.467"],
                [5, "9.236", "11.070", "15.086", "20.515"]
            ]
        },
        zTable: {
            title: "Common Z-Scores (Confidence Levels)",
            headers: ["Confidence Level", "Alpha (Î±)", "Z-Score (2-sided)"],
            rows: [
                ["90%", "0.10", "1.645"],
                ["95%", "0.05", "1.960"],
                ["99%", "0.01", "2.576"]
            ]
        }
    }
};

// console.log('[APPENDIX DATA] Loaded successfully');
// console.log('[APPENDIX DATA] Flashcards count:', window.APPENDIX_DATA.flashcards ? window.APPENDIX_DATA.flashcards.length : 0);
// console.log('[APPENDIX DATA] Glossary count:', window.APPENDIX_DATA.glossary ? window.APPENDIX_DATA.glossary.length : 0);

const PREVENTION_DATA = [
    {
        "q": "Preventing exposure to hazards that cause disease or injury such as seat belts, safety helmets",
        "answer": 1,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Primary Prevention: Preventing exposure to hazards."
    },
    {
        "q": "Vocational rehabilitation programs to retrain workers for new jobs after recovery",
        "answer": 3,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Tertiary Prevention: Rehabilitation and return to work."
    },
    {
        "q": "Changing childhood life style to prevent adult health problems as obesity and hypertension",
        "answer": 0,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Primordial Prevention: Targeting underlying conditions/lifestyles early."
    },
    {
        "q": "Detecting and treating disease or injury that has already occurred through regular exams & screening",
        "answer": 2,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Secondary Prevention: Early detection and treatment."
    },
    {
        "q": "Handwashing and regular dental cleaning & care",
        "answer": 1,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Primary Prevention: Personal hygiene to prevent disease."
    },
    {
        "q": "A healthy lifestyle, including diet and exercise (as per source text)",
        "answer": 4,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Quaternary Prevention: (Note: Source text classifies this as Quaternary, though often considered Primary)."
    },
    {
        "q": "Changing the socio-economic status of society and public attitudes to improve life style patterns",
        "answer": 0,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Primordial Prevention: Broad societal changes."
    },
    {
        "q": "Immunization against infectious diseases",
        "answer": 1,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Primary Prevention: Vaccination."
    },
    {
        "q": "Support groups that allow members to share strategies for living with limitations",
        "answer": 3,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Tertiary Prevention: Managing long-term conditions."
    },
    {
        "q": "Suitable modified work so injured or ill workers can return safely to their jobs",
        "answer": 2,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Secondary Prevention: (Source text classifies as Secondary, likely due to early intervention/return to work)."
    },
    {
        "q": "Cardiac or stroke rehabilitation programs, chronic disease management programs",
        "answer": 3,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Tertiary Prevention: Rehabilitation."
    },
    {
        "q": "Individual programs to change individual life style to promote health and safety",
        "answer": 1,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Primary Prevention: Individual lifestyle changes."
    },
    {
        "q": "Daily, low-dose aspirins and/or diet & exercise to prevent further heart attacks or stroke",
        "answer": 2,
        "type": "mc",
        "topic": "Prevention",
        "options": ["Primordial", "Primary", "Secondary", "Tertiary", "Quaternary"],
        "explain": "Secondary Prevention: Preventing recurrence (Secondary prevention)."
    }
];

if (typeof QUIZ_BANKS !== 'undefined') {
    if (!QUIZ_BANKS["practice_exam"]) QUIZ_BANKS["practice_exam"] = {};
    QUIZ_BANKS["practice_exam"]["prevention"] = PREVENTION_DATA;
    // console.log("Prevention Data loaded into QUIZ_BANKS");
}

// Practice Exam Data derived from DD_PRACTICE.html
// Converted Matching questions to Multiple Choice for compatibility

const PRACTICE_EXAM_DATA = {
    "part1": [
        {
            "q": "What is the definition of 'Outbreak'?",
            "answer": 0,
            "type": "mc",
            "topic": "Practice Part 1",
            "options": [
                "More cases of a particular disease than expected in a given area or among a specialized group of people over a particular period of time",
                "An aggregation of cases over a particular period closely grouped in time and space, regardless of whether the number is more than the expected number",
                "Large numbers of people over a wide geographical area affected",
                "An epidemic occurring over several countries or continents and affected a large proportion of the population"
            ],
            "explain": "Outbreak: more cases of a particular disease than expected in a given area (G)."
        },
        {
            "q": "What is 'Surveillance'?",
            "answer": 0,
            "type": "mc",
            "topic": "Practice Part 1",
            "options": [
                "The systematic and ongoing collection, analysis, interpretation, and dissemination of health data",
                "Compare people with and without exposures to see what happens to each",
                "Compare people with and without disease to find common exposures",
                "The probability that an individual will be affected by, or die from, an illness or injury"
            ],
            "explain": "Surveillance: systematic and ongoing collection... of health data (H)."
        },
        {
            "q": "What defines a 'Pandemic'?",
            "answer": 0,
            "type": "mc",
            "topic": "Practice Part 1",
            "options": [
                "An epidemic occurring over several countries or continents and affected a large proportion of the population",
                "Large numbers of people over a wide geographical area affected",
                "More cases of a particular disease than expected in a given area",
                "An aggregation of cases over a particular period closely grouped in time and space"
            ],
            "explain": "Pandemic: epidemic occurring over several countries or continents (I)."
        },
        {
            "q": "What is a 'Vector'?",
            "answer": 0,
            "type": "mc",
            "topic": "Practice Part 1",
            "options": [
                "An animal that transmits disease",
                "A person or animal that harbors the infectious agent for a disease and can transmit it to others, but does not demonstrate signs of the disease",
                "Comparing people with and without exposures",
                "Systematic collection of health data"
            ],
            "explain": "Vector: an animal that transmits disease (J)."
        },
        {
            "q": "What is a 'Cohort' study?",
            "answer": 0,
            "type": "mc",
            "topic": "Practice Part 1",
            "options": [
                "Compare people with and without exposures to see what happens to each",
                "Compare people with and without disease to find common exposures",
                "Systematic collection of health data",
                "Analysis of mortality data"
            ],
            "explain": "Cohort: compare people with and without exposures (A)."
        },
        {
            "q": "What is 'Risk'?",
            "answer": 0,
            "type": "mc",
            "topic": "Practice Part 1",
            "options": [
                "The probability that an individual will be affected by, or die from, an illness or injury within a stated time or age span",
                "More cases of a particular disease than expected",
                "Large numbers of people over a wide geographical area affected",
                "An animal that transmits disease"
            ],
            "explain": "Risk: probability that an individual will be affected (F)."
        },
        {
            "q": "What is a 'Cluster'?",
            "answer": 0,
            "type": "mc",
            "topic": "Practice Part 1",
            "options": [
                "An aggregation of cases over a particular period closely grouped in time and space, regardless of whether the number is more than the expected number",
                "More cases of a particular disease than expected in a given area",
                "An epidemic occurring over several countries or continents",
                "Large numbers of people over a wide geographical area affected"
            ],
            "explain": "Cluster: aggregation of cases... closely grouped in time and space (B)."
        },
        {
            "q": "What is a 'Carrier'?",
            "answer": 0,
            "type": "mc",
            "topic": "Practice Part 1",
            "options": [
                "A person or animal that harbors the infectious agent for a disease and can transmit it to others, but does not demonstrate signs of the disease",
                "An animal that transmits disease",
                "A person who has recovered from the disease",
                "An individual who is immune to the disease"
            ],
            "explain": "Carrier: harbors agent... can transmit... does not demonstrate signs (D)."
        },
        {
            "q": "What is an 'Epidemic'?",
            "answer": 0,
            "type": "mc",
            "topic": "Practice Part 1",
            "options": [
                "Large numbers of people over a wide geographical area affected",
                "More cases of a particular disease than expected in a given area",
                "An epidemic occurring over several countries or continents",
                "An aggregation of cases closely grouped in time and space"
            ],
            "explain": "Epidemic: large numbers of people over a wide geographical area affected (E). Note: Often defined similarly to Outbreak but usually implies larger scale."
        },
        {
            "q": "What is a 'Case-control' study?",
            "answer": 0,
            "type": "mc",
            "topic": "Practice Part 1",
            "options": [
                "Compare people with and without disease to find common exposures",
                "Compare people with and without exposures to see what happens to each",
                "Systematic collection of health data",
                "Analysis of mortality data"
            ],
            "explain": "Case-control: compare people with and without disease (C)."
        }
    ],
    "history": [
        {
            "q": "What was Pasteur's contribution?",
            "answer": 0,
            "type": "mc",
            "topic": "History",
            "options": [
                "Recognized bacterial cause & developed vaccine for anthrax",
                "Father of Epidemiology",
                "Developed small pox vaccine",
                "Formalized Standards (postulates)"
            ],
            "explain": "Pasteur: Recognized bacterial cause & developed vaccine for anthrax (G)."
        },
        {
            "q": "What was Hippocrates' contribution?",
            "answer": 0,
            "type": "mc",
            "topic": "History",
            "options": [
                "Attempted to explain disease as natural rather than supernatural (400 BC)",
                "Father of Epidemiology",
                "Published first epi text",
                "Developed statistical procedure"
            ],
            "explain": "Hippocrates: Attempted to explain disease as natural rather than supernatural (H)."
        },
        {
            "q": "What did Mantel & Haenszel do?",
            "answer": 0,
            "type": "mc",
            "topic": "History",
            "options": [
                "Developed statistical procedure for stratified analysis of case-control studies",
                "Published first epi text",
                "Designed study using control group in studying scurvy",
                "Published a landmark analysis of mortality data"
            ],
            "explain": "Mantel & Haenszel: Developed statistical procedure for stratified analysis (I)."
        },
        {
            "q": "What was Edward Jenner's contribution?",
            "answer": 0,
            "type": "mc",
            "topic": "History",
            "options": [
                "Developed small pox vaccine using cowpox",
                "Recognized bacterial cause & developed vaccine for anthrax",
                "Formalized Standards (postulates)",
                "Designed study using control group in studying scurvy"
            ],
            "explain": "Jenner: Developed small pox vaccine using cowpox (J)."
        },
        {
            "q": "What is John Snow known for?",
            "answer": 0,
            "type": "mc",
            "topic": "History",
            "options": [
                "Father of Epidemiology â€“ tested hypothesis about cholera in London (1854)",
                "Published first epi text",
                "Attempted to explain disease as natural rather than supernatural",
                "Developed statistical procedure for stratified analysis"
            ],
            "explain": "John Snow: Father of Epidemiology (A)."
        },
        {
            "q": "What did James Lind do?",
            "answer": 0,
            "type": "mc",
            "topic": "History",
            "options": [
                "Designed study using control group in studying scurvy (limes)",
                "Developed small pox vaccine",
                "Published a descriptive field study showing origin of pellagra",
                "Recognized bacterial cause & developed vaccine for anthrax"
            ],
            "explain": "James Lind: Scurvy study with limes (F)."
        },
        {
            "q": "What was MacMahon's contribution?",
            "answer": 0,
            "type": "mc",
            "topic": "History",
            "options": [
                "Published first epi text with systematic focus on study design (1960)",
                "Published a landmark analysis of mortality data",
                "Developed statistical procedure for stratified analysis",
                "Attempted to explain disease as natural rather than supernatural"
            ],
            "explain": "MacMahon: Published first epi text (B)."
        },
        {
            "q": "What did John Graunt do?",
            "answer": 0,
            "type": "mc",
            "topic": "History",
            "options": [
                "Published a landmark analysis of mortality data in 1662",
                "Published first epi text",
                "Father of Epidemiology",
                "Designed study using control group in studying scurvy"
            ],
            "explain": "John Graunt: Analysis of mortality data (D)."
        },
        {
            "q": "What was Robert Koch's contribution?",
            "answer": 0,
            "type": "mc",
            "topic": "History",
            "options": [
                "Formalized Standards (postulates) to Identify organisms with Infectious Diseases",
                "Recognized bacterial cause & developed vaccine for anthrax",
                "Developed small pox vaccine",
                "Published a descriptive field study showing origin of pellagra"
            ],
            "explain": "Robert Koch: Koch's Postulates (E)."
        },
        {
            "q": "What did Goldberg do?",
            "answer": 0,
            "type": "mc",
            "topic": "History",
            "options": [
                "Published a descriptive field study showing origin of pellagra (1920)",
                "Designed study using control group in studying scurvy",
                "Developed statistical procedure for stratified analysis",
                "Published first epi text"
            ],
            "explain": "Goldberg: Pellagra study (C)."
        }
    ]
};

// Inject into global QUIZ_BANKS if available
if (typeof QUIZ_BANKS !== 'undefined') {
    QUIZ_BANKS["practice_exam"] = {
        "part1": PRACTICE_EXAM_DATA.part1,
        "history": PRACTICE_EXAM_DATA.history
    };
    // console.log("Practice Exam Data loaded into QUIZ_BANKS");
} else {
    console.warn("QUIZ_BANKS not defined. Practice Exam Data loaded as standalone.");
}

/**
 * Epidemic Engine - Interactive Scenarios Data
 * 20 scenarios covering Investigation, Math, Line Lists, and Graphs.
 */

window.SCENARIO_DB = {
    // --- CATEGORY 1: FIELD INVESTIGATION (5) ---
    'potluck': {
        title: "The Potluck Panic",
        category: "investigation",
        difficulty: "Beginner",
        description: "A community potluck ends in disaster. Can you identify the culprit dish?",
        nodes: {
            'start': {
                text: "Monday Morning. Mrs. Higgins reports 'everyone is throwing up' after yesterday's potluck.",
                choices: [
                    { text: "Ask for a list of foods served.", next: 'food_list', cost: 0, time: 1 },
                    { text: "Ask about symptoms and timing.", next: 'symptoms', cost: 0, time: 1 },
                    { text: "Send inspection team.", next: 'inspection', cost: 200, time: 4 }
                ]
            },
            'food_list': {
                text: "Menu: Potato Salad, BBQ Chicken, Coleslaw, Pudding. Chicken was 'pink'.",
                choices: [
                    { text: "Suspect Chicken (Salmonella?)", next: 'suspect_chicken', cost: 0, time: 0 },
                    { text: "Suspect Potato Salad (Staph?)", next: 'suspect_potato', cost: 0, time: 0 },
                    { text: "Ask about symptoms.", next: 'symptoms', cost: 0, time: 1 }
                ]
            },
            'symptoms': {
                text: "Started 3-4 hours after eating. Vomiting, cramps. No fever.",
                choices: [
                    { text: "Short incubation + Vomiting = Staph.", next: 'hypothesis_staph', cost: 0, time: 0 },
                    { text: "Short incubation + Vomiting = Norovirus.", next: 'hypothesis_noro', cost: 0, time: 0 },
                    { text: "Check Food List.", next: 'food_list', cost: 0, time: 1 }
                ]
            },
            'inspection': {
                text: "Kitchen clean. Potato Salad left out for 5 hours.",
                choices: [
                    { text: "Temp Abuse -> Staph.", next: 'hypothesis_staph', cost: 0, time: 0 },
                    { text: "Check Chicken logs.", next: 'chicken_logs', cost: 50, time: 1 }
                ]
            },
            'hypothesis_staph': {
                text: "Hypothesis: Staphylococcal food poisoning vs Potato Salad. Test?",
                choices: [
                    { text: "Test Salad (Confirm)", next: 'win', cost: 100, time: 2 },
                    { text: "Recall without test.", next: 'win_risky', cost: 0, time: 0 }
                ]
            },
            'win': {
                text: "VICTORY! Lab confirms Staph Enterotoxin. Recall issued.",
                end: true,
                win: true
            },
            'win_risky': {
                text: "VICTORY! You guessed right, but testing would have been safer.",
                end: true,
                win: true
            },
            'hypothesis_noro': { text: "Lab negative for Norovirus. You lost time.", end: true, win: false },
            'suspect_chicken': { text: "Chicken tested negative. It was the salad.", end: true, win: false },
            'suspect_potato': { text: "Good instinct. Why? (Go to Symptoms)", choices: [{ text: "Check symptoms", next: 'symptoms', cost: 0 }] },
            'chicken_logs': { text: "Chicken cooked to 165F. Safe.", choices: [{ text: "Back to inspection", next: 'inspection' }] }
        }
    },
    'wedding': {
        title: "The Wedding Crasher",
        category: "investigation",
        difficulty: "Intermediate",
        description: "Guests at a summer wedding fall ill. Was it the cake or the water?",
        nodes: {
            'start': {
                text: "50 of 100 guests ill. Vomiting/Diarrhea. Incubation 24-48h.",
                choices: [
                    { text: "Inspect the caterer.", next: 'caterer', cost: 50 },
                    { text: "Interview guests (Case-Control).", next: 'interview', cost: 20 }
                ]
            },
            'caterer': {
                text: "Caterer had a sick employee preparing salads.",
                choices: [
                    { text: "Close the kitchen.", next: 'close_kitchen', cost: 500 },
                    { text: "Wait for interviews.", next: 'interview', cost: 0 }
                ]
            },
            'interview': {
                text: "Salad eaters: OR = 12.0. Water drinkers: OR = 1.1. Cake eaters: OR = 0.9.",
                choices: [
                    { text: "Results implicate Salad.", next: 'win', cost: 0 },
                    { text: "Results implicate Water.", next: 'lose', cost: 0 }
                ]
            },
            'win': { text: "Correct. Norovirus via sick food handler in salad.", end: true, win: true },
            'lose': { text: "Incorrect. Stats point to Salad.", end: true, win: false },
            'close_kitchen': { text: "You stopped the outbreak, but interviews confirm Salad was the vector.", end: true, win: true }
        }
    },
    'cruise': {
        title: "The Cruise Ship Crisis",
        category: "investigation",
        difficulty: "Advanced",
        description: "Outbreak on the high seas. Is it the buffet or the air?",
        nodes: {
            'start': {
                text: "High attack rate on Deck 4. Vomiting. 200 cases.",
                choices: [
                    { text: "Quarantine cabins.", next: 'quarantine', cost: 1000 },
                    { text: "Sanitize high-touch surfaces.", next: 'sanitize', cost: 200 }
                ]
            },
            'quarantine': { text: "Cases slowing, but passengers furious.", choices: [{ text: "Analyze data", next: 'analyze' }] },
            'sanitize': { text: "Good first step for Noro.", choices: [{ text: "Analyze data", next: 'analyze' }] },
            'analyze': {
                text: "Curve suggests person-to-person propagation.",
                choices: [
                    { text: "Confirm Norovirus.", next: 'win' },
                    { text: "Suspect Legionella (Air/Water).", next: 'lose' }
                ]
            },
            'win': { text: "Correct. Classic Cruise Noro.", end: true, win: true },
            'lose': { text: "Incorrect. Vomiting points to Noro, not Legionella (Pneumonia).", end: true, win: false }
        }
    },
    'zoo': {
        title: "The Petting Zoo",
        category: "investigation",
        difficulty: "Intermediate",
        description: "Children visiting a petting zoo develop bloody diarrhea.",
        nodes: {
            'start': {
                text: "Bloody diarrhea in 5 kids. HUS in 1. Visited 'Cuddly Farm'.",
                choices: [
                    { text: "Suspect Salmonella.", next: 'salm' },
                    { text: "Suspect E. coli O157.", next: 'ecoli' }
                ]
            },
            'salm': { text: "Poltry/Reptiles? Maybe. But HUS points elsewhere.", choices: [{ text: "Reconsider E. coli", next: 'ecoli' }] },
            'ecoli': {
                text: "Correct. HUS + Bloody Diarrhea = STEC.",
                choices: [
                    { text: "Close the petting zoo.", next: 'win' },
                    { text: "Recommend Antibiotics.", next: 'lose_abx' }
                ]
            },
            'win': { text: "Correct. Zoonotic transmission. Handwashing stations were empty.", end: true, win: true },
            'lose_abx': { text: "CRITICAL ERROR! Antibiotics increase HUS risk in STEC.", end: true, win: false }
        }
    },
    'hospital': {
        title: "The Hospital Wing",
        category: "investigation",
        difficulty: "Advanced",
        description: "Post-surgical infections spiking in Ward B.",
        nodes: {
            'start': {
                text: "Surgical site infections up 300%. MRSA suspected.",
                choices: [
                    { text: "Swab staff noses.", next: 'swab' },
                    { text: "Review sterilization logs.", next: 'logs' }
                ]
            },
            'swab': { text: "One surgeon is MRSA positive (Carrier).", choices: [{ text: "Decolonize surgeon.", next: 'win' }] },
            'logs': { text: "Equipment sterile. It's a person.", choices: [{ text: "Swab staff.", next: 'swab' }] },
            'win': { text: "Correct. Asymptomatic carrier identified.", end: true, win: true }
        }
    },

    // --- CATEGORY 2: CALCULATION DRILLS (5) ---
    'drill_ar_1': {
        title: "Drill: Attack Rate",
        category: "calc",
        difficulty: "Beginner",
        description: "Calculate the Attack Rate (AR).",
        nodes: {
            'start': {
                text: "At a picnic, 50 people ate potato salad. 20 got sick.<br>Calculate the Attack Rate.",
                choices: [
                    { text: "20%", next: 'lose' },
                    { text: "40%", next: 'win' },
                    { text: "50%", next: 'lose' },
                    { text: "2.5", next: 'lose' }
                ]
            },
            'win': { text: "Correct! 20 / 50 = 0.40 (40%).", end: true, win: true },
            'lose': { text: "Incorrect. AR = Sick / Total Exposed.", end: true, win: false }
        }
    },
    'drill_rr': {
        title: "Drill: Risk Ratio",
        category: "calc",
        difficulty: "Intermediate",
        description: "Calculate the Relative Risk (RR).",
        nodes: {
            'start': {
                text: "Exposed AR = 40%. Unexposed AR = 10%.<br>Calculate RR.",
                choices: [
                    { text: "30%", next: 'lose' },
                    { text: "4.0", next: 'win' },
                    { text: "0.25", next: 'lose' }
                ]
            },
            'win': { text: "Correct! RR = 40 / 10 = 4.0.", end: true, win: true },
            'lose': { text: "Incorrect. RR = AR(Exposed) / AR(Unexposed).", end: true, win: false }
        }
    },
    'drill_or': {
        title: "Drill: Odds Ratio",
        category: "calc",
        difficulty: "Intermediate",
        description: "Calculate the Odds Ratio (OR).",
        nodes: {
            'start': {
                text: "Case-Control: a=20, b=10, c=5, d=10.<br>Calculate OR (ad/bc).",
                choices: [
                    { text: "4.0", next: 'win' },
                    { text: "2.0", next: 'lose' },
                    { text: "0.5", next: 'lose' }
                ]
            },
            'win': { text: "Correct! (20*10) / (10*5) = 200 / 50 = 4.0.", end: true, win: true },
            'lose': { text: "Incorrect. Formula is ad/bc.", end: true, win: false }
        }
    },
    'drill_ve': {
        title: "Drill: Vaccine Efficacy",
        category: "calc",
        difficulty: "Advanced",
        description: "Calculate Vaccine Efficacy (VE).",
        nodes: {
            'start': {
                text: "AR(Unvax) = 20%. AR(Vax) = 5%.<br>Calculate VE.",
                choices: [
                    { text: "75%", next: 'win' },
                    { text: "15%", next: 'lose' },
                    { text: "25%", next: 'lose' }
                ]
            },
            'win': { text: "Correct! VE = (ARu - ARv)/ARu = (20-5)/20 = 15/20 = 75%.", end: true, win: true },
            'lose': { text: "Incorrect. Formula is (ARu - ARv) / ARu.", end: true, win: false }
        }
    },
    'drill_test': {
        title: "Drill: Sensitivity",
        category: "calc",
        difficulty: "Advanced",
        description: "Calculate Sensitivity.",
        nodes: {
            'start': {
                text: "100 actually sick people. Test detects 90. Misses 10.<br>Sensitivity?",
                choices: [
                    { text: "90%", next: 'win' },
                    { text: "10%", next: 'lose' },
                    { text: "100%", next: 'lose' }
                ]
            },
            'win': { text: "Correct! TP / (TP + FN) = 90 / 100 = 90%.", end: true, win: true },
            'lose': { text: "Incorrect. Sensitivity is ability to detect disease.", end: true, win: false }
        }
    },

    // --- CATEGORY 3: LINE LISTS (5) ---
    'll_index': {
        title: "Line List: Index Case",
        category: "linelist",
        difficulty: "Beginner",
        description: "Identify the index case from a list.",
        nodes: {
            'start': {
                text: "Case A: Onset Jan 1. Case B: Onset Jan 3. Case C: Onset Dec 28.<br>Who is likely the Index Case?",
                choices: [
                    { text: "Case A", next: 'lose' },
                    { text: "Case B", next: 'lose' },
                    { text: "Case C", next: 'win' }
                ]
            },
            'win': { text: "Correct. Earliest onset suggests Index.", end: true, win: true },
            'lose': { text: "Incorrect. Look for the earliest date.", end: true, win: false }
        }
    },
    'll_exclude': {
        title: "Line List: Case Def",
        category: "linelist",
        difficulty: "Intermediate",
        description: "Who meets the case definition?",
        nodes: {
            'start': {
                text: "Def: Fever AND Rash.<br>Patient 1: Fever only.<br>Patient 2: Fever + Rash.<br>Patient 3: Rash only.<br>Who is a case?",
                choices: [
                    { text: "Patient 1", next: 'lose' },
                    { text: "Patient 2", next: 'win' },
                    { text: "Patient 3", next: 'lose' }
                ]
            },
            'win': { text: "Correct. Meets both criteria.", end: true, win: true },
            'lose': { text: "Incorrect. Must meet full definition.", end: true, win: false }
        }
    },
    'll_outlier': {
        title: "Line List: Outlier",
        category: "linelist",
        difficulty: "Intermediate",
        description: "Spot the data error.",
        nodes: {
            'start': {
                text: "Ages: 12, 13, 14, 120, 13.<br>Which is likely an error?",
                choices: [
                    { text: "120", next: 'win' },
                    { text: "14", next: 'lose' }
                ]
            },
            'win': { text: "Correct. 120 is likely a typo for 12 or 20 (or improbable age).", end: true, win: true },
            'lose': { text: "Incorrect.", end: true, win: false }
        }
    },
    'll_incubation': {
        title: "Line List: Incubation",
        category: "linelist",
        difficulty: "Advanced",
        description: "Calculate incubation period.",
        nodes: {
            'start': {
                text: "Exposure: Jan 1. Onset: Jan 5.<br>Incubation period?",
                choices: [
                    { text: "1 day", next: 'lose' },
                    { text: "4 days", next: 'win' },
                    { text: "5 days", next: 'lose' }
                ]
            },
            'win': { text: "Correct. Jan 5 - Jan 1 = 4 days.", end: true, win: true },
            'lose': { text: "Incorrect. Count days between exposure and onset.", end: true, win: false }
        }
    },
    'll_map': {
        title: "Line List: Mapping",
        category: "linelist",
        difficulty: "Intermediate",
        description: "Visualize the data.",
        nodes: {
            'start': {
                text: "Most cases live on 'Broad St'. Map type?",
                choices: [
                    { text: "Spot Map", next: 'win' },
                    { text: "Epi Curve", next: 'lose' }
                ]
            },
            'win': { text: "Correct. Spot maps show location.", end: true, win: true },
            'lose': { text: "Incorrect. Curves show time.", end: true, win: false }
        }
    },

    // --- CATEGORY 4: GRAPHS (5) ---
    'graph_point': {
        title: "Graph: Point Source",
        category: "graph",
        difficulty: "Beginner",
        description: "Identify the curve type.",
        nodes: {
            'start': {
                text: "Graph Description: Rapid rise to a sharp peak, then rapid decline. All within one incubation period.<br>Type?",
                choices: [
                    { text: "Point Source", next: 'win' },
                    { text: "Propagated", next: 'lose' },
                    { text: "Continuous", next: 'lose' }
                ]
            },
            'win': { text: "Correct. Classic Point Source shape (log-normal).", end: true, win: true },
            'lose': { text: "Incorrect. Propagated has waves. Continuous is flat.", end: true, win: false }
        }
    },
    'graph_prop': {
        title: "Graph: Propagated",
        category: "graph",
        difficulty: "Intermediate",
        description: "Identify the curve type.",
        nodes: {
            'start': {
                text: "Graph Description: Series of progressively taller peaks, separated by incubation periods.<br>Type?",
                choices: [
                    { text: "Point Source", next: 'lose' },
                    { text: "Propagated", next: 'win' }
                ]
            },
            'win': { text: "Correct. Suggests person-to-person transmission.", end: true, win: true },
            'lose': { text: "Incorrect.", end: true, win: false }
        }
    },
    'graph_cont': {
        title: "Graph: Continuous",
        category: "graph",
        difficulty: "Intermediate",
        description: "Identify the curve type.",
        nodes: {
            'start': {
                text: "Graph Description: Rise to a plateau that persists for weeks.<br>Type?",
                choices: [
                    { text: "Point Source", next: 'lose' },
                    { text: "Continuous Common Source", next: 'win' }
                ]
            },
            'win': { text: "Correct. Constant exposure.", end: true, win: true },
            'lose': { text: "Incorrect.", end: true, win: false }
        }
    },
    'graph_outlier': {
        title: "Graph: Outlier",
        category: "graph",
        difficulty: "Advanced",
        description: "Identify the outlier.",
        nodes: {
            'start': {
                text: "Graph: Main peak Days 5-10. One case on Day 1.<br>What is the Day 1 case called?",
                choices: [
                    { text: "Index Case", next: 'win' },
                    { text: "Peak Case", next: 'lose' },
                    { text: "Last Case", next: 'lose' }
                ]
            },
            'win': { text: "Correct. The first case is the Index Case (or Primary Case).", end: true, win: true },
            'lose': { text: "Incorrect.", end: true, win: false }
        }
    },
    'graph_trend': {
        title: "Graph: Secular Trend",
        category: "graph",
        difficulty: "Advanced",
        description: "Long-term changes.",
        nodes: {
            'start': {
                text: "Graph: Data over 50 years showing steady decrease in Tb.<br>Type of trend?",
                choices: [
                    { text: "Seasonal", next: 'lose' },
                    { text: "Secular", next: 'win' },
                    { text: "Cyclical", next: 'lose' }
                ]
            },
            'win': { text: "Correct. Secular = Long term.", end: true, win: true },
            'lose': { text: "Incorrect.", end: true, win: false }
        }
    }
};

(function () {
    // console.log("Initializing MEGA Scenarios...");

    // -------------------------------------------------------------------------
    // MEGA SCENARIOS DATA (MC1 - MC10)
    // -------------------------------------------------------------------------
    const INTERACTIVE_CASES_DATA = [
        {
            id: "MC1",
            title: "The School Cafeteria Outbreak",
            difficulty: "Advanced",
            description: "A multi-day outbreak at a middle school requires comprehensive epidemiological investigation including attack rate calculations, curve analysis, and control measures.",
            steps: [
                {
                    id: "step1",
                    text: "<h6>Step 1: Initial Report</h6><p>On Wednesday, the school nurse reports that 45 of 300 students who ate lunch on Monday developed nausea, vomiting, and diarrhea starting Tuesday morning. Most recovered within 24 hours.</p><p><strong>Calculate the Attack Rate.</strong></p>",
                    options: [
                        { text: "AR = 15%", feedback: "Correct! 45/300 Ã— 100 = 15%", correct: true },
                        { text: "AR = 45%", feedback: "Incorrect. You need to divide cases by total exposed, not just count cases.", correct: false },
                        { text: "AR = 30%", feedback: "Incorrect. Check your calculation: 45/300.", correct: false }
                    ]
                },
                {
                    id: "step2",
                    text: "<h6>Step 2: Incubation Period</h6><p>Lunch was served Monday 12:00 PM. First case onset: Monday 11:00 PM (11 hours). Last case onset: Tuesday 2:00 PM (26 hours). Peak: Tuesday 8:00 AM (20 hours).</p><p><strong>Which pathogen fits this incubation period?</strong></p>",
                    options: [
                        { text: "Staphylococcus aureus (1-6 hours)", feedback: "Incorrect. Too short.", correct: false },
                        { text: "Norovirus (12-48 hours)", feedback: "Correct! The 11-26 hour range with peak at 20 hours fits Norovirus perfectly.", correct: true },
                        { text: "Salmonella (6-72 hours, median 12-36)", feedback: "Possible, but Norovirus is more likely given the short duration and vomiting prominence.", correct: false }
                    ]
                },
                {
                    id: "step3",
                    text: "<h6>Step 3: Food History</h6><p>Students who ate the chicken salad: 60 students, 40 ill (AR = 67%). Students who did NOT eat chicken salad: 240 students, 5 ill (AR = 2%).</p><p><strong>Calculate the Relative Risk (RR).</strong></p>",
                    options: [
                        { text: "RR = 33.5", feedback: "Correct! RR = 67% / 2% = 33.5. Students who ate chicken salad were 33.5 times more likely to get sick.", correct: true },
                        { text: "RR = 2.0", feedback: "Incorrect. You may have reversed the calculation.", correct: false },
                        { text: "RR = 0.67", feedback: "Incorrect. Check the formula: AR_exposed / AR_unexposed.", correct: false }
                    ]
                },
                {
                    id: "step4",
                    text: "<h6>Step 4: Control Measures</h6><p>Investigation reveals the chicken salad was left at room temperature for 3 hours before serving. A food handler was ill the previous week.</p><p><strong>What is the PRIMARY control measure?</strong></p>",
                    options: [
                        { text: "Close the school for deep cleaning", feedback: "Incorrect. Norovirus outbreak is over; this is excessive.", correct: false },
                        { text: "Exclude ill food handlers, enforce time/temperature controls, and educate staff on proper food handling", feedback: "Correct! Multi-pronged approach addresses the source and prevents recurrence.", correct: true },
                        { text: "Administer antibiotics to all students", feedback: "Incorrect. Norovirus is viral; antibiotics don't work.", correct: false }
                    ]
                }
            ]
        },
        {
            id: "MC2",
            title: "The Swimming Pool Cryptosporidiosis",
            difficulty: "Advanced",
            description: "A community pool outbreak requires understanding of chlorine-resistant pathogens, prolonged incubation periods, and environmental controls.",
            steps: [
                {
                    id: "step1",
                    text: "<h6>Step 1: Pattern Recognition</h6><p>Over 2 weeks, 80 children who swam at a community pool developed watery diarrhea lasting 1-2 weeks. Onset ranged from 2-10 days after swimming, with most cases appearing 7 days post-exposure.</p><p><strong>What type of outbreak curve would you expect?</strong></p>",
                    options: [
                        { text: "Point Source (sharp peak)", feedback: "Incorrect. The wide range (2-10 days) suggests continuous exposure.", correct: false },
                        { text: "Continuous Common Source (plateau)", feedback: "Correct! Continuous exposure over 2 weeks with a long incubation period creates a plateau pattern.", correct: true },
                        { text: "Propagated (successive waves)", feedback: "Incorrect. Cryptosporidium is waterborne, not person-to-person in this context.", correct: false }
                    ]
                },
                {
                    id: "step2",
                    text: "<h6>Step 2: Agent Identification</h6><p>Stool samples show oocysts. The pathogen is resistant to standard chlorine levels. Incubation: 2-10 days (median 7). Duration: 1-2 weeks.</p><p><strong>What is the most likely agent?</strong></p>",
                    options: [
                        { text: "Giardia lamblia", feedback: "Incorrect. Giardia has a longer incubation (1-3 weeks).", correct: false },
                        { text: "Cryptosporidium parvum", feedback: "Correct! Chlorine-resistant, 2-10 day incubation, prolonged diarrhea, and oocysts all point to Crypto.", correct: true },
                        { text: "E. coli O157:H7", feedback: "Incorrect. E. coli is chlorine-sensitive and has shorter incubation.", correct: false }
                    ]
                },
                {
                    id: "step3",
                    text: "<h6>Step 3: Attack Rate Calculation</h6><p>Pool attendance records show 400 children swam during the 2-week period. 80 became ill.</p><p><strong>What is the attack rate?</strong></p>",
                    options: [
                        { text: "AR = 20%", feedback: "Correct! 80/400 Ã— 100 = 20%", correct: true },
                        { text: "AR = 25%", feedback: "Incorrect. Recheck: 80/400.", correct: false },
                        { text: "AR = 80%", feedback: "Incorrect. You forgot to divide by total exposed.", correct: false }
                    ]
                },
                {
                    id: "step4",
                    text: "<h6>Step 4: Control Measures</h6><p>Standard chlorination failed. What is the MOST effective control?</p>",
                    options: [
                        { text: "Increase chlorine to maximum levels", feedback: "Incorrect. Cryptosporidium is chlorine-resistant even at high levels.", correct: false },
                        { text: "Close pool, hyperchlorinate or use UV treatment, enforce 'no swimming when ill' policy, and improve filtration", feedback: "Correct! Comprehensive approach: UV kills Crypto, policy prevents contamination, filtration removes oocysts.", correct: true },
                        { text: "Ban children under 5 from the pool", feedback: "Incorrect. This doesn't address the contamination source.", correct: false }
                    ]
                }
            ]
        },
        {
            id: "MC3",
            title: "The Restaurant Hepatitis A Cluster",
            difficulty: "Advanced",
            description: "A foodborne hepatitis A outbreak with a long incubation period requires understanding of case definitions, secondary transmission, and vaccination strategies.",
            steps: [
                {
                    id: "step1",
                    text: "<h6>Step 1: Case Definition</h6><p>15 patrons of a restaurant developed jaundice, dark urine, and elevated liver enzymes 28-35 days after dining. All tested positive for Hepatitis A IgM.</p><p><strong>What case classification applies?</strong></p>",
                    options: [
                        { text: "Probable cases (clinical symptoms only)", feedback: "Incorrect. They have lab confirmation.", correct: false },
                        { text: "Confirmed cases (clinical + lab confirmation)", feedback: "Correct! Symptoms + positive IgM = confirmed Hepatitis A.", correct: true },
                        { text: "Suspected cases (exposure only)", feedback: "Incorrect. They have both symptoms and lab confirmation.", correct: false }
                    ]
                },
                {
                    id: "step2",
                    text: "<h6>Step 2: Source Investigation</h6><p>A food handler tested positive for Hepatitis A. They worked while symptomatic (jaundice) for 3 days before being sent home. They handled ready-to-eat foods without gloves.</p><p><strong>What is the mode of transmission?</strong></p>",
                    options: [
                        { text: "Airborne", feedback: "Incorrect. Hepatitis A is fecal-oral.", correct: false },
                        { text: "Fecal-oral (contaminated food)", feedback: "Correct! Food handler with poor hand hygiene contaminated food.", correct: true },
                        { text: "Bloodborne", feedback: "Incorrect. While Hep A is in blood, transmission here was via contaminated food.", correct: false }
                    ]
                },
                {
                    id: "step3",
                    text: "<h6>Step 3: Secondary Transmission Risk</h6><p>Hepatitis A incubation: 15-50 days (average 28). Infectious period: 2 weeks before to 1 week after jaundice onset.</p><p><strong>What is the risk of secondary household transmission?</strong></p>",
                    options: [
                        { text: "Low - Hepatitis A is not contagious person-to-person", feedback: "Incorrect. Hep A IS contagious person-to-person via fecal-oral route.", correct: false },
                        { text: "High - Close contacts are at risk, especially if hygiene is poor", feedback: "Correct! Household members can be infected through shared bathrooms, poor handwashing.", correct: true },
                        { text: "Moderate - Only if blood contact occurs", feedback: "Incorrect. Fecal-oral is the primary route, not blood.", correct: false }
                    ]
                },
                {
                    id: "step4",
                    text: "<h6>Step 4: Post-Exposure Prophylaxis</h6><p>200 patrons ate at the restaurant during the food handler's infectious period. Most are now past the 2-week window for immune globulin.</p><p><strong>What is the best intervention?</strong></p>",
                    options: [
                        { text: "Hepatitis A vaccine for all exposed patrons (even if >2 weeks post-exposure)", feedback: "Correct! Vaccine can still provide protection and prevent future exposure. Also educate on symptoms and hygiene.", correct: true },
                        { text: "Immune globulin only (even though window passed)", feedback: "Incorrect. IG is only effective within 2 weeks. Vaccine is better at this point.", correct: false },
                        { text: "No intervention needed - too late", feedback: "Incorrect. Vaccine can still help and prevents future infections.", correct: false }
                    ]
                }
            ]
        },
        {
            id: "MC4",
            title: "The Legionnaires' Disease Hotel Outbreak",
            difficulty: "Advanced",
            description: "An environmental outbreak requiring understanding of aerosol transmission, environmental sampling, and engineering controls.",
            steps: [
                {
                    id: "step1",
                    text: "<h6>Step 1: Clinical Presentation</h6><p>12 hotel guests developed severe pneumonia 2-10 days after staying at the hotel. All required hospitalization. Urine antigen tests confirmed Legionella pneumophila.</p><p><strong>What is the most likely source?</strong></p>",
                    options: [
                        { text: "Person-to-person transmission from an ill guest", feedback: "Incorrect. Legionnaires' disease is NOT transmitted person-to-person.", correct: false },
                        { text: "Contaminated water system (cooling towers, hot tubs, showers)", feedback: "Correct! Legionella grows in warm water systems and spreads via aerosols.", correct: true },
                        { text: "Contaminated food in the hotel restaurant", feedback: "Incorrect. Legionella is waterborne/airborne, not foodborne.", correct: false }
                    ]
                },
                {
                    id: "step2",
                    text: "<h6>Step 2: Environmental Investigation</h6><p>Water samples from the hotel's cooling tower, hot tub, and shower heads are collected. Which is MOST likely to be positive?</p>",
                    options: [
                        { text: "Cooling tower", feedback: "Correct! Cooling towers are the #1 source of Legionnaires' outbreaks due to aerosolization and ideal growth temperature (25-42Â°C).", correct: true },
                        { text: "Cold water tap", feedback: "Incorrect. Legionella prefers warm water (25-42Â°C).", correct: false },
                        { text: "Swimming pool (chlorinated)", feedback: "Incorrect. Proper chlorination kills Legionella.", correct: false }
                    ]
                },
                {
                    id: "step3",
                    text: "<h6>Step 3: Attack Rate</h6><p>500 guests stayed at the hotel during the exposure period. 12 developed Legionnaires' disease.</p><p><strong>Calculate the attack rate.</strong></p>",
                    options: [
                        { text: "AR = 2.4%", feedback: "Correct! 12/500 Ã— 100 = 2.4%", correct: true },
                        { text: "AR = 12%", feedback: "Incorrect. You forgot to divide by total exposed.", correct: false },
                        { text: "AR = 0.24%", feedback: "Incorrect. Check your percentage calculation.", correct: false }
                    ]
                },
                {
                    id: "step4",
                    text: "<h6>Step 4: Control Measures</h6><p>What is the PRIMARY engineering control for Legionella in water systems?</p>",
                    options: [
                        { text: "Antibiotics in the water supply", feedback: "Incorrect. This is not practical or safe.", correct: false },
                        { text: "Superheat water to >60Â°C and flush system, maintain hot water >50Â°C and cold <20Â°C, regular cleaning/disinfection of cooling towers", feedback: "Correct! Temperature control and maintenance are key engineering controls.", correct: true },
                        { text: "Close the hotel permanently", feedback: "Incorrect. Proper remediation can eliminate the risk.", correct: false }
                    ]
                }
            ]
        },
        {
            id: "MC5",
            title: "The Daycare E. coli O157:H7 Outbreak",
            difficulty: "Advanced",
            description: "A person-to-person outbreak in a daycare requiring understanding of HUS complications, exclusion policies, and secondary attack rates.",
            steps: [
                {
                    id: "step1",
                    text: "<h6>Step 1: Index Case</h6><p>A 3-year-old develops bloody diarrhea after a petting zoo visit. Stool culture: E. coli O157:H7. The child attends daycare.</p><p><strong>What is the IMMEDIATE action?</strong></p>",
                    options: [
                        { text: "Wait for more cases before acting", feedback: "Incorrect. E. coli O157:H7 is highly dangerous; immediate action is needed.", correct: false },
                        { text: "Exclude the child from daycare immediately, notify parents of all children, and begin active surveillance", feedback: "Correct! Rapid exclusion prevents secondary transmission. E. coli O157:H7 can cause HUS (hemolytic uremic syndrome).", correct: true },
                        { text: "Prescribe antibiotics to all daycare children", feedback: "Incorrect. Antibiotics may INCREASE HUS risk in E. coli O157:H7.", correct: false }
                    ]
                },
                {
                    id: "step2",
                    text: "<h6>Step 2: Secondary Cases</h6><p>Over the next week, 5 more children (out of 30 total) develop diarrhea. All test positive for E. coli O157:H7. None visited the petting zoo.</p><p><strong>What is the secondary attack rate?</strong></p>",
                    options: [
                        { text: "SAR = 17.2%", feedback: "Correct! 5 secondary cases / 29 susceptible contacts Ã— 100 = 17.2%", correct: true },
                        { text: "SAR = 16.7%", feedback: "Incorrect. Don't include the index case in the denominator.", correct: false },
                        { text: "SAR = 20%", feedback: "Incorrect. Check your calculation: 5/29.", correct: false }
                    ]
                },
                {
                    id: "step3",
                    text: "<h6>Step 3: HUS Complication</h6><p>One child develops hemolytic uremic syndrome (HUS): hemolytic anemia, thrombocytopenia, and acute kidney injury.</p><p><strong>What percentage of E. coli O157:H7 cases develop HUS?</strong></p>",
                    options: [
                        { text: "5-10%", feedback: "Correct! About 5-10% of E. coli O157:H7 cases progress to HUS, especially in young children.", correct: true },
                        { text: "50%", feedback: "Incorrect. HUS is serious but not that common.", correct: false },
                        { text: "<1%", feedback: "Incorrect. HUS is more common than this in E. coli O157:H7.", correct: false }
                    ]
                },
                {
                    id: "step4",
                    text: "<h6>Step 4: Return-to-Daycare Criteria</h6><p>When can an infected child return to daycare?</p>",
                    options: [
                        { text: "After symptoms resolve (no diarrhea for 24 hours)", feedback: "Incorrect. Children can still shed bacteria after symptoms resolve.", correct: false },
                        { text: "After 2 consecutive negative stool cultures, at least 24 hours apart, after diarrhea resolves", feedback: "Correct! This ensures the child is no longer shedding E. coli O157:H7.", correct: true },
                        { text: "After completing a course of antibiotics", feedback: "Incorrect. Antibiotics are NOT recommended for E. coli O157:H7 (may increase HUS risk).", correct: false }
                    ]
                }
            ]
        },
        {
            id: "MC6",
            title: "The Measles School Outbreak",
            difficulty: "Advanced",
            description: "A highly contagious airborne outbreak requiring understanding of R0, herd immunity, and vaccination strategies.",
            steps: [
                {
                    id: "step1",
                    text: "<h6>Step 1: Index Case</h6><p>An unvaccinated 12-year-old returns from international travel with fever, cough, and a rash. Diagnosed with measles. The student attended school for 2 days while infectious.</p><p><strong>What is measles' basic reproduction number (R0)?</strong></p>",
                    options: [
                        { text: "R0 = 2-3 (like flu)", feedback: "Incorrect. Measles is MUCH more contagious.", correct: false },
                        { text: "R0 = 12-18 (one of the most contagious diseases)", feedback: "Correct! Measles R0 is 12-18, meaning one case can infect 12-18 susceptible people.", correct: true },
                        { text: "R0 = 5-7 (like chickenpox)", feedback: "Incorrect. Measles is more contagious than chickenpox.", correct: false }
                    ]
                },
                {
                    id: "step2",
                    text: "<h6>Step 2: Exposure Assessment</h6><p>The school has 500 students. Vaccination records show 450 are fully vaccinated (2 doses MMR), 30 have 1 dose, and 20 are unvaccinated.</p><p><strong>How many students are susceptible?</strong></p>",
                    options: [
                        { text: "50 students (1 dose + unvaccinated)", feedback: "Correct! 30 with 1 dose + 20 unvaccinated = 50 susceptible. 2 doses = 97% effective.", correct: true },
                        { text: "20 students (only unvaccinated)", feedback: "Incorrect. Students with only 1 dose are also at risk (1 dose = ~93% effective).", correct: false },
                        { text: "500 students (everyone)", feedback: "Incorrect. Vaccinated students have protection.", correct: false }
                    ]
                },
                {
                    id: "step3",
                    text: "<h6>Step 3: Herd Immunity Threshold</h6><p>To achieve herd immunity for measles (R0 = 15), what percentage of the population must be immune?</p><p>Formula: HIT = (1 - 1/R0) Ã— 100</p>",
                    options: [
                        { text: "93-95%", feedback: "Correct! HIT = (1 - 1/15) Ã— 100 = 93.3%. This is why measles outbreaks occur when vaccination rates drop below 95%.", correct: true },
                        { text: "70-80%", feedback: "Incorrect. This works for less contagious diseases, but measles needs higher coverage.", correct: false },
                        { text: "50%", feedback: "Incorrect. Much too low for measles.", correct: false }
                    ]
                },
                {
                    id: "step4",
                    text: "<h6>Step 4: Post-Exposure Prophylaxis</h6><p>Unvaccinated students were exposed 3 days ago. What is the best intervention?</p>",
                    options: [
                        { text: "MMR vaccine within 72 hours of exposure", feedback: "Correct! MMR vaccine within 72 hours can prevent or modify disease. After 72 hours, use immune globulin for high-risk individuals.", correct: true },
                        { text: "Antibiotics", feedback: "Incorrect. Measles is viral; antibiotics don't work.", correct: false },
                        { text: "Quarantine only, no medical intervention", feedback: "Incorrect. Vaccine can still help if given quickly.", correct: false }
                    ]
                }
            ]
        },
        {
            id: "MC7",
            title: "The Nursing Home Influenza Outbreak",
            difficulty: "Advanced",
            description: "A respiratory outbreak in a vulnerable population requiring understanding of vaccine effectiveness, antiviral prophylaxis, and cohorting.",
            steps: [
                {
                    id: "step1",
                    text: "<h6>Step 1: Outbreak Recognition</h6><p>A nursing home with 100 residents reports 15 cases of fever, cough, and myalgia over 3 days. Rapid flu tests: positive for Influenza A.</p><p><strong>What is the attack rate so far?</strong></p>",
                    options: [
                        { text: "AR = 15%", feedback: "Correct! 15/100 Ã— 100 = 15%. But this will likely increase as the outbreak progresses.", correct: true },
                        { text: "AR = 30%", feedback: "Incorrect. Currently 15 cases out of 100.", correct: false },
                        { text: "AR = 5%", feedback: "Incorrect. Check your calculation.", correct: false }
                    ]
                },
                {
                    id: "step2",
                    text: "<h6>Step 2: Vaccination Status</h6><p>Records show 80 residents received flu vaccine this season. Of the 15 ill residents, 10 were vaccinated and 5 were not.</p><p><strong>Calculate Vaccine Effectiveness (VE).</strong></p><p>VE = (ARu - ARv) / ARu Ã— 100</p>",
                    options: [
                        { text: "VE = 37.5%", feedback: "Correct! ARu = 5/20 = 25%. ARv = 10/80 = 12.5%. VE = (25-12.5)/25 Ã— 100 = 50%. Wait, let me recalculate... ARu=25%, ARv=12.5%, VE=(0.25-0.125)/0.25=0.5=50%.", correct: false },
                        { text: "VE = 50%", feedback: "Correct! ARu = 25%, ARv = 12.5%, VE = (25-12.5)/25 Ã— 100 = 50%", correct: true },
                        { text: "VE = 75%", feedback: "Incorrect. Recheck the formula and calculations.", correct: false }
                    ]
                },
                {
                    id: "step3",
                    text: "<h6>Step 3: Antiviral Prophylaxis</h6><p>The outbreak is ongoing. What is the recommendation for uninfected residents?</p>",
                    options: [
                        { text: "No intervention - let it run its course", feedback: "Incorrect. Elderly residents are at high risk for complications.", correct: false },
                        { text: "Antiviral prophylaxis (oseltamivir) for all uninfected residents, especially unvaccinated", feedback: "Correct! Prophylactic antivirals can prevent infection during an outbreak in high-risk settings.", correct: true },
                        { text: "Antibiotics for all residents", feedback: "Incorrect. Influenza is viral; antibiotics don't work (unless treating secondary bacterial pneumonia).", correct: false }
                    ]
                },
                {
                    id: "step4",
                    text: "<h6>Step 4: Infection Control</h6><p>What is the MOST important infection control measure?</p>",
                    options: [
                        { text: "Cohort ill residents together, use droplet precautions, restrict admissions/transfers, vaccinate staff", feedback: "Correct! Multi-pronged approach: cohorting prevents spread, droplet precautions protect staff, vaccination protects everyone.", correct: true },
                        { text: "Airborne isolation for all residents", feedback: "Incorrect. Influenza is droplet, not airborne (except during aerosol-generating procedures).", correct: false },
                        { text: "Close the facility to all visitors", feedback: "Partially correct but not sufficient. Need cohorting and precautions.", correct: false }
                    ]
                }
            ]
        },
        {
            id: "MC8",
            title: "The Salmonella Turtle-Associated Outbreak",
            difficulty: "Advanced",
            description: "A multi-state zoonotic outbreak requiring understanding of case-control studies, odds ratios, and public health messaging.",
            steps: [
                {
                    id: "step1",
                    text: "<h6>Step 1: Multi-State Pattern</h6><p>CDC receives reports of Salmonella infections in children across 15 states. All isolates have the same PFGE pattern (genetic fingerprint).</p><p><strong>What does the identical PFGE pattern suggest?</strong></p>",
                    options: [
                        { text: "Unrelated sporadic cases", feedback: "Incorrect. Identical PFGE patterns indicate a common source.", correct: false },
                        { text: "A common source outbreak (same contaminated product/animal)", feedback: "Correct! PFGE (pulsed-field gel electrophoresis) matching indicates cases are related.", correct: true },
                        { text: "Person-to-person transmission chain", feedback: "Incorrect. While possible, the multi-state distribution suggests a distributed product.", correct: false }
                    ]
                },
                {
                    id: "step2",
                    text: "<h6>Step 2: Case-Control Study</h6><p>A case-control study is conducted. Cases: 50 ill children. Controls: 100 healthy children matched by age and location.</p><p>Exposure to pet turtles: Cases = 40 exposed, 10 not. Controls = 20 exposed, 80 not.</p><p><strong>Calculate the Odds Ratio (OR).</strong></p>",
                    options: [
                        { text: "OR = 16", feedback: "Correct! OR = (40Ã—80)/(10Ã—20) = 3200/200 = 16. Children with turtles had 16 times the odds of infection.", correct: true },
                        { text: "OR = 4", feedback: "Incorrect. Recheck your calculation: (aÃ—d)/(bÃ—c).", correct: false },
                        { text: "OR = 2", feedback: "Incorrect. Check the 2Ã—2 table setup.", correct: false }
                    ]
                },
                {
                    id: "step3",
                    text: "<h6>Step 3: Biological Plausibility</h6><p>Why are small turtles (<4 inches) a Salmonella risk?</p>",
                    options: [
                        { text: "Small turtles are more likely to bite", feedback: "Incorrect. The risk is not from bites.", correct: false },
                        { text: "Small turtles naturally carry Salmonella in their intestines and on their shells; children often put them in their mouths", feedback: "Correct! Reptiles are natural Salmonella carriers. Small turtles are mouthing hazards for young children.", correct: true },
                        { text: "Small turtles are fed contaminated food", feedback: "Incorrect. Turtles naturally carry Salmonella.", correct: false }
                    ]
                },
                {
                    id: "step4",
                    text: "<h6>Step 4: Public Health Action</h6><p>What is the appropriate public health response?</p>",
                    options: [
                        { text: "Ban on sale of turtles <4 inches (already exists via FDA), public education on reptile-associated Salmonella, hand hygiene messaging", feedback: "Correct! The FDA banned small turtle sales in 1975, but illegal sales continue. Education is key.", correct: true },
                        { text: "Mandatory Salmonella testing of all pet turtles", feedback: "Incorrect. Not practical; turtles shed Salmonella intermittently.", correct: false },
                        { text: "Antibiotics for all turtle owners", feedback: "Incorrect. Prophylactic antibiotics are not indicated.", correct: false }
                    ]
                }
            ]
        },
        {
            id: "MC9",
            title: "The Listeria Cantaloupe Outbreak",
            difficulty: "Advanced",
            description: "A deadly foodborne outbreak requiring understanding of high-risk populations, long incubation periods, and food recalls.",
            steps: [
                {
                    id: "step1",
                    text: "<h6>Step 1: High-Risk Population</h6><p>33 cases of listeriosis are reported across 12 states. 30 patients are pregnant women, elderly (>65), or immunocompromised. 7 deaths occur.</p><p><strong>What is the case-fatality rate?</strong></p>",
                    options: [
                        { text: "CFR = 21.2%", feedback: "Correct! 7 deaths / 33 cases Ã— 100 = 21.2%. Listeria has one of the highest CFRs of foodborne pathogens.", correct: true },
                        { text: "CFR = 7%", feedback: "Incorrect. You calculated deaths as a percentage of the population, not cases.", correct: false },
                        { text: "CFR = 33%", feedback: "Incorrect. Recheck: 7/33.", correct: false }
                    ]
                },
                {
                    id: "step2",
                    text: "<h6>Step 2: Incubation Period</h6><p>Listeria has an unusually long incubation period: 1-4 weeks (can be up to 70 days for invasive disease).</p><p><strong>Why does this complicate outbreak investigation?</strong></p>",
                    options: [
                        { text: "Patients may not remember what they ate weeks ago; contaminated food may be gone", feedback: "Correct! Long incubation makes recall difficult and food may be consumed/discarded.", correct: true },
                        { text: "It doesn't complicate investigation", feedback: "Incorrect. Long incubation is a major challenge.", correct: false },
                        { text: "Patients are no longer infectious", feedback: "Incorrect. Listeria is foodborne, not person-to-person anyway.", correct: false }
                    ]
                },
                {
                    id: "step3",
                    text: "<h6>Step 3: Source Identification</h6><p>Whole genome sequencing (WGS) links all cases. Traceback investigation identifies cantaloupes from a single farm.</p><p><strong>Why are cantaloupes a Listeria risk?</strong></p>",
                    options: [
                        { text: "Netted rind can harbor bacteria; often eaten without cooking; can be contaminated by soil", feedback: "Correct! The rough rind traps bacteria, and cantaloupes are eaten raw. Listeria can grow at refrigerator temperatures.", correct: true },
                        { text: "Cantaloupes are acidic", feedback: "Incorrect. Cantaloupes are not particularly acidic, and Listeria can tolerate some acidity.", correct: false },
                        { text: "Cantaloupes are always contaminated", feedback: "Incorrect. Contamination is from poor agricultural/packing practices.", correct: false }
                    ]
                },
                {
                    id: "step4",
                    text: "<h6>Step 4: Recall and Prevention</h6><p>What is the appropriate action?</p>",
                    options: [
                        { text: "Voluntary recall of implicated cantaloupes, public warning to high-risk groups, investigation of farm practices (sanitation, water sources)", feedback: "Correct! Recall removes product, warning protects vulnerable populations, farm investigation prevents recurrence.", correct: true },
                        { text: "Ban all cantaloupe sales nationwide", feedback: "Incorrect. Only implicated farm's products need recall.", correct: false },
                        { text: "Antibiotics for all cantaloupe consumers", feedback: "Incorrect. Prophylactic antibiotics not indicated.", correct: false }
                    ]
                }
            ]
        },
        {
            id: "MC10",
            title: "The Pertussis Daycare Outbreak",
            difficulty: "Advanced",
            description: "A vaccine-preventable disease outbreak requiring understanding of waning immunity, cocooning strategy, and antibiotic prophylaxis.",
            steps: [
                {
                    id: "step1",
                    text: "<h6>Step 1: Index Case</h6><p>A 2-month-old infant (too young for full vaccination) develops severe coughing fits (paroxysms) with inspiratory 'whoop' and post-tussive vomiting. PCR confirms Bordetella pertussis.</p><p><strong>Why are young infants at highest risk for severe pertussis?</strong></p>",
                    options: [
                        { text: "They have no maternal antibodies", feedback: "Partially correct, but the main issue is lack of vaccination.", correct: false },
                        { text: "They are too young to be fully vaccinated (DTaP series starts at 2 months) and have the highest risk of complications (apnea, pneumonia, death)", feedback: "Correct! Infants <6 months are most vulnerable; they haven't completed the primary series.", correct: true },
                        { text: "Their immune systems are overactive", feedback: "Incorrect. The opposite is true.", correct: false }
                    ]
                },
                {
                    id: "step2",
                    text: "<h6>Step 2: Source Investigation</h6><p>The infant's 8-year-old sibling attends daycare and has had a mild cough for 3 weeks. PCR: positive for pertussis. The sibling was fully vaccinated as an infant but hasn't had a booster.</p><p><strong>What does this demonstrate?</strong></p>",
                    options: [
                        { text: "Vaccine failure (vaccine doesn't work)", feedback: "Incorrect. The vaccine works but immunity wanes over time.", correct: false },
                        { text: "Waning immunity - pertussis vaccine protection decreases over time, requiring boosters (Tdap at age 11-12)", feedback: "Correct! Pertussis immunity wanes 5-10 years after vaccination. Boosters are essential.", correct: true },
                        { text: "The sibling was never vaccinated", feedback: "Incorrect. The scenario states they were fully vaccinated as an infant.", correct: false }
                    ]
                },
                {
                    id: "step3",
                    text: "<h6>Step 3: Cocooning Strategy</h6><p>What is the 'cocooning' strategy for pertussis prevention?</p>",
                    options: [
                        { text: "Isolating sick infants in a separate room", feedback: "Incorrect. Cocooning refers to vaccination strategy.", correct: false },
                        { text: "Vaccinating all close contacts of infants (parents, siblings, grandparents, caregivers) with Tdap to create a protective 'cocoon'", feedback: "Correct! Cocooning protects vulnerable infants by vaccinating everyone around them.", correct: true },
                        { text: "Giving infants extra vaccine doses", feedback: "Incorrect. Infants follow the standard DTaP schedule.", correct: false }
                    ]
                },
                {
                    id: "step4",
                    text: "<h6>Step 4: Post-Exposure Prophylaxis</h6><p>20 children at the daycare were exposed. What is the recommendation?</p>",
                    options: [
                        { text: "Azithromycin prophylaxis for all close contacts, regardless of vaccination status; Tdap booster for those due", feedback: "Correct! Antibiotics prevent disease in exposed individuals. Vaccine booster provides long-term protection.", correct: true },
                        { text: "No intervention - pertussis is mild", feedback: "Incorrect. Pertussis can be severe in infants and prophylaxis prevents spread.", correct: false },
                        { text: "Quarantine only", feedback: "Incorrect. Antibiotic prophylaxis is recommended for close contacts.", correct: false }
                    ]
                }
            ]
        }
    ];

    // -------------------------------------------------------------------------
    // MERGE LOGIC
    // -------------------------------------------------------------------------
    const db = window.SCENARIO_DB;
    if (!db) {
        console.error("SCENARIO_DB not found! Make sure interactive-scenarios-data.js is loaded first.");
        return;
    }

    if (db['mc1']) {
        // console.log("MEGA Scenarios already merged.");
        return;
    }

    INTERACTIVE_CASES_DATA.forEach(mc => {
        const caseKey = mc.id.toLowerCase();

        // Transform to Node format
        const scenario = {
            title: mc.title,
            category: "investigation",
            difficulty: mc.difficulty || "Advanced",
            description: mc.description,
            nodes: {}
        };

        mc.steps.forEach((step, index) => {
            const stepNodeId = step.id;
            scenario.nodes[stepNodeId] = {
                text: step.text,
                choices: []
            };

            // Map 'start' to first step
            if (index === 0) {
                scenario.nodes['start'] = {
                    text: step.text,
                    choices: []
                };
            }

            step.options.forEach((opt, optIdx) => {
                const isCorrect = opt.correct;
                const feedbackNodeId = `${stepNodeId}_opt${optIdx}`;

                scenario.nodes[feedbackNodeId] = {
                    text: (isCorrect ? "<strong>Correct!</strong> " : "<strong>Incorrect.</strong> ") + opt.feedback,
                    choices: []
                };

                const choiceObj = {
                    text: opt.text,
                    next: feedbackNodeId,
                    cost: 0,
                    time: 1
                };
                scenario.nodes[stepNodeId].choices.push(choiceObj);

                // Add to start node too
                if (index === 0) {
                    scenario.nodes['start'].choices.push(choiceObj);
                }

                if (isCorrect) {
                    const nextStep = mc.steps[index + 1];
                    if (nextStep) {
                        scenario.nodes[feedbackNodeId].choices.push({
                            text: "Next Step",
                            next: nextStep.id,
                            cost: 0
                        });
                    } else {
                        // Case Closed
                        scenario.nodes[feedbackNodeId].end = true;
                        scenario.nodes[feedbackNodeId].win = true;
                        scenario.nodes[feedbackNodeId].text += "<br><br><strong>Case Closed! Excellent work.</strong>";
                    }
                } else {
                    // Try Again
                    scenario.nodes[feedbackNodeId].choices.push({
                        text: "Try Again",
                        next: stepNodeId,
                        cost: 50
                    });
                }
            });
        });

        db[caseKey] = scenario;
    });

    // console.log(`Merged ${INTERACTIVE_CASES_DATA.length} Mega Scenarios into SCENARIO_DB.`);

})();


</script>
    <script>
/**
 * Analytics Manager
 * Handles local storage of quiz and exam results.
 * Respects privacy: No data leaves the device.
 */
class AnalyticsManager {
    constructor() {
        this.STORAGE_KEY = 'dd_analytics_v1';
        this.storageAvailable = this._isStorageAvailable();
        this.data = this._load();
        if (!this.data.chapterViews) this.data.chapterViews = {};
    }

    _isStorageAvailable() {
        try {
            const testKey = '__test__';
            window.localStorage.setItem(testKey, '1');
            window.localStorage.removeItem(testKey);
            return true;
        } catch (e) {
            console.warn('LocalStorage not available, analytics disabled:', e);
            return false;
        }
    }

    _load() {
        if (!this.storageAvailable) return { attempts: [], chapterViews: {} };
        try {
            const stored = localStorage.getItem(this.STORAGE_KEY);
            const data = stored ? JSON.parse(stored) : { attempts: [], chapterViews: {}, missedQuestions: {} };
            if (!data.missedQuestions) data.missedQuestions = {};
            if (!data.chapterViews) data.chapterViews = {};
            return data;
        } catch (e) {
            console.error('Analytics load error:', e);
            return { attempts: [], chapterViews: {}, missedQuestions: {} };
        }
    }

    _save() {
        if (!this.storageAvailable) return;
        try {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.data));
        } catch (e) {
            console.error('Analytics save error:', e);
        }
    }

    /**
     * Log a completed quiz/exam attempt
     * @param {string} quizId - e.g. 'part1', 'simulation-1'
     * @param {number} score - Raw score
     * @param {number} maxScore - Total possible
     * @param {string} mode - 'practice' or 'simulation'
     */
    logAttempt(quizId, score, maxScore, mode) {
        const attempt = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
            quizId,
            score,
            maxScore,
            percent: Math.round((score / maxScore) * 100),
            mode,
            timestamp: new Date().toISOString()
        };
        this.data.attempts.push(attempt);
        this._save();
        return attempt;
    }

    /**
     * Log a chapter view
     * @param {string} chapterId 
     */
    logChapterView(chapterId) {
        if (!this.data.chapterViews) this.data.chapterViews = {};

        if (!this.data.chapterViews[chapterId]) {
            this.data.chapterViews[chapterId] = { count: 0, lastViewed: null };
        }

        this.data.chapterViews[chapterId].count++;
        this.data.chapterViews[chapterId].lastViewed = new Date().toISOString();
        this._save();
    }

    /**
     * Get aggregate stats for a specific quiz
     */
    getStats(quizId) {
        const attempts = this.data.attempts.filter(a => a.quizId === quizId);
        if (!attempts.length) return null;

        const scores = attempts.map(a => a.score);
        const best = Math.max(...scores);
        const totalPossible = attempts[0].maxScore; // Assume constant max score
        const avg = scores.reduce((a, b) => a + b, 0) / scores.length;

        return {
            count: attempts.length,
            best,
            bestPercent: Math.round((best / totalPossible) * 100),
            avg: Math.round(avg * 10) / 10,
            avgPercent: Math.round((avg / totalPossible) * 100),
            lastDate: attempts[attempts.length - 1].timestamp
        };
    }

    /**
     * Get all history sorted by date desc
     */
    getHistory() {
        return [...this.data.attempts].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    }

    getChapterStats() {
        const views = this.data.chapterViews || {};
        const viewedCount = Object.keys(views).length;
        return {
            viewed: viewedCount,
            total: 20,
            details: views
        };
    }

    getGlobalStats() {
        const attempts = this.data.attempts;
        if (!attempts || attempts.length === 0) {
            return { totalAttempts: 0, averageScore: 0 };
        }

        const totalPercent = attempts.reduce((sum, a) => sum + (a.percent || 0), 0);
        const avg = totalPercent / attempts.length;

        return {
            totalAttempts: attempts.length,
            averageScore: Math.round(avg * 10) / 10
        };
    }

    /**
     * Clear all data
     */
    reset() {
        this.data = { attempts: [], chapterViews: {}, missedQuestions: {} };
        this._save();
    }

    /**
     * Log a missed question
     * @param {string} topic - e.g. "Chapter 4"
     * @param {string} text - The question text (used as ID since we lack UIDs sometimes)
     */
    logMissedQuestion(topic, text) {
        if (!this.storageAvailable) return;

        // Sanitize key
        const key = text.substring(0, 50).replace(/[^a-zA-Z0-9]/g, '');

        if (!this.data.missedQuestions[key]) {
            this.data.missedQuestions[key] = {
                topic: topic,
                text: text.substring(0, 100) + '...',
                count: 0
            };
        }

        this.data.missedQuestions[key].count++;
        this._save();
    }

    /**
     * Get weak areas sorted by miss count
     */
    getWeakAreas() {
        const topicCounts = {};
        Object.values(this.data.missedQuestions).forEach(mq => {
            if (!topicCounts[mq.topic]) topicCounts[mq.topic] = 0;
            topicCounts[mq.topic] += mq.count;
        });

        // Convert to array and sort
        return Object.entries(topicCounts)
            .sort((a, b) => b[1] - a[1]) // Descending
            .map(([topic, count]) => ({ topic, count }));
    }
}

// Global Instance
window.AnalyticsManager = new AnalyticsManager();

// CHAPTER REFERENCE UTILITY
// Maps chapter IDs to titles and sections for quiz question references

const CHAPTER_REFERENCE = {
    ch1: {
        title: "The Detective's Role",
        sections: ["1.1", "1.2", "1.3", "1.4"],
        topics: ["epidemiology definition", "distribution", "determinants", "population focus"]
    },
    ch2: {
        title: "History & Heroes",
        sections: ["2.0", "2.1", "2.2", "2.3"],
        topics: ["pioneers", "incubation period", "latency", "natural history", "carriers"]
    },
    ch3: {
        title: "The Triad & Chain",
        sections: ["3.1", "3.2", "3.3", "3.4", "3.5", "3.6"],
        topics: ["agent-host-environment", "chain of infection", "wheel model", "web model", "Rothman's pies"]
    },
    ch4: {
        title: "Measures of Frequency",
        sections: ["4.1", "4.2", "4.3"],
        topics: ["counts", "proportions", "rates", "incidence", "prevalence"]
    },
    ch5: {
        title: "Modes of Transmission",
        sections: ["5.1", "5.2", "5.3", "5.4"],
        topics: ["direct", "indirect", "airborne", "vector-borne", "vehicle", "surveillance systems"]
    },
    ch6: {
        title: "Natural History",
        sections: ["6.1", "6.2", "6.3"],
        topics: ["disease stages", "R0", "herd immunity threshold", "generation time"]
    },
    ch7: {
        title: "Investigation Roadmap",
        sections: ["7.1", "7.2", "7.3"],
        topics: ["outbreak investigation steps", "verify outbreak", "case definition", "hypothesis"]
    },
    ch8: {
        title: "Case Definitions",
        sections: ["8.1", "8.2", "8.3"],
        topics: ["person-place-time-clinical", "suspect-probable-confirmed", "sensitivity", "specificity"]
    },
    ch9: {
        title: "Line Lists & Data",
        sections: ["9.1", "9.2"],
        topics: ["line list", "data collection", "variables", "attack rates"]
    },
    ch10: {
        title: "Curve Logic",
        sections: ["10.1", "10.2", "10.3"],
        topics: ["epidemic curves", "point source", "continuous source", "propagated", "intermittent"]
    },
    ch11: {
        title: "Outbreak Math I",
        sections: ["11.1", "11.2", "11.3"],
        topics: ["attack rate", "risk ratio", "attributable risk", "AR%", "2x2 table"]
    },
    ch12: {
        title: "Outbreak Math II",
        sections: ["12.1", "12.2", "12.3"],
        topics: ["odds ratio", "confidence intervals", "study designs", "matched pairs", "Mantel-Haenszel"]
    },
    ch13: {
        title: "Hypothesis Testing",
        sections: ["13.1", "13.2", "13.3", "13.4", "13.5"],
        topics: ["null hypothesis", "p-value", "Type I error", "Type II error", "chi-square", "power"]
    },
    ch14: {
        title: "Data Synthesis",
        sections: ["14.1", "14.2"],
        topics: ["vital statistics", "YPLL", "SMR", "age-adjustment", "crude rates", "specific rates"]
    },
    ch15: {
        title: "Prevention Levels",
        sections: ["15.1", "15.2", "15.3"],
        topics: ["primary prevention", "secondary prevention", "tertiary prevention", "vaccination", "screening"]
    },
    ch16: {
        title: "Control Measures",
        sections: ["16.1", "16.2", "16.3"],
        topics: ["source control", "transmission interruption", "host protection", "ring vaccination", "chain of infection"]
    },
    ch17: {
        title: "Isolation & Ethics",
        sections: ["17.1", "17.2"],
        topics: ["isolation", "quarantine", "ethics", "autonomy", "public health law"]
    },
    ch18: {
        title: "Population Immunity",
        sections: ["18.1", "18.2"],
        topics: ["herd immunity", "HIT formula", "R0", "vaccination coverage", "waning immunity"]
    },
    ch19: {
        title: "Advanced Evaluation",
        sections: ["19.1", "19.2", "19.3"],
        topics: ["effect modification", "confounding", "stratification", "screening tests", "sensitivity", "specificity"]
    },
    ch20: {
        title: "Case Studies",
        sections: ["20.1"],
        topics: ["outbreak investigation", "case scenarios", "mega-cases"]
    },

    // Special chapters
    quiz_part1: { title: "Part I Quiz", sections: [], topics: [] },
    quiz_part2: { title: "Part II Quiz", sections: [], topics: [] },
    quiz_part3: { title: "Part III Quiz", sections: [], topics: [] },
    drills: { title: "Interactive Drills", sections: [], topics: ["2x2 calculator", "epi curve", "exposure window"] },
    simulation: { title: "Simulation Exams", sections: [], topics: [] },
    case_library: { title: "Case Library", sections: [], topics: [] },
    appendix: { title: "Appendix & Resources", sections: [], topics: ["glossary", "flashcards", "mnemonics", "formulas"] }
};

// Function to get chapter info from question
function getChapterInfo(question) {
    let chapId = question.chapter;

    // Smart Fallback: Parse 'topic' legacy field (e.g. "Chapter 7" -> "ch7")
    if (!chapId && question.topic && typeof question.topic === 'string') {
        const match = question.topic.match(/Chapter\s+(\d+)/i);
        if (match) {
            chapId = 'ch' + match[1];
        }
    }

    if (!chapId) return null;

    const chapterData = CHAPTER_REFERENCE[chapId];
    if (!chapterData) return null;

    return {
        id: chapId,
        title: chapterData.title,
        section: question.section || null,
        url: `#${chapId}`,
        fullTitle: question.section
            ? `${chapterData.title} (Section ${question.section})`
            : chapterData.title
    };
}

// Function to generate "Review Chapter" link HTML
function generateReviewLink(question) {
    const info = getChapterInfo(question);
    if (!info) return '';

    return `
        <div class="review-link" style="margin-top: 1rem; padding: 0.75rem; background: var(--accent-blue); border: 2px solid var(--border-color); border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
            <i class="ph ph-book-open" style="font-size: 1.25rem;"></i>
            <div>
                <strong>Review:</strong> 
                <a href="${info.url}" onclick="loadChapter('${info.id}'); return false;" style="color: var(--navy-primary); font-weight: 600; text-decoration: none;">
                    ${info.fullTitle}
                </a>
            </div>
        </div>
    `;
}

// Function to find suggested chapter based on question keywords
function suggestChapter(questionText) {
    const text = questionText.toLowerCase();

    // Keyword mapping for common topics
    const keywordMap = {
        'epidemiology': 'ch1',
        'distribution': 'ch1',
        'determinants': 'ch1',
        'john snow': 'ch2',
        'graunt': 'ch2',
        'jenner': 'ch2',
        'koch': 'ch2',
        'semmelweis': 'ch2',
        'nightingale': 'ch2',
        'mary mallon': 'ch2',
        'typhoid mary': 'ch2',
        'incubation': 'ch2',
        'latency': 'ch2',
        'carrier': 'ch2',
        'triad': 'ch3',
        'agent': 'ch3',
        'host': 'ch3',
        'environment': 'ch3',
        'chain of infection': 'ch3',
        'reservoir': 'ch3',
        'portal': 'ch3',
        'incidence': 'ch4',
        'prevalence': 'ch4',
        'transmission': 'ch5',
        'airborne': 'ch5',
        'vector': 'ch5',
        'vehicle': 'ch5',
        'fomite': 'ch5',
        'r0': 'ch6',
        'râ‚€': 'ch6',
        'herd immunity': 'ch6',
        'outbreak investigation': 'ch7',
        'case definition': 'ch8',
        'suspect': 'ch8',
        'probable': 'ch8',
        'confirmed': 'ch8',
        'line list': 'ch9',
        'epidemic curve': 'ch10',
        'epi curve': 'ch10',
        'point source': 'ch10',
        'propagated': 'ch10',
        'attack rate': 'ch11',
        'risk ratio': 'ch11',
        'relative risk': 'ch11',
        'attributable risk': 'ch11',
        'odds ratio': 'ch12',
        'confidence interval': 'ch12',
        'matched': 'ch12',
        'mantel-haenszel': 'ch12',
        'null hypothesis': 'ch13',
        'p-value': 'ch13',
        'p value': 'ch13',
        'type i error': 'ch13',
        'type ii error': 'ch13',
        'chi-square': 'ch13',
        'chi square': 'ch13',
        'ypll': 'ch14',
        'smr': 'ch14',
        'age-adjusted': 'ch14',
        'primary prevention': 'ch15',
        'secondary prevention': 'ch15',
        'tertiary prevention': 'ch15',
        'vaccination': 'ch15',
        'control measure': 'ch16',
        'ring vaccination': 'ch16',
        'isolation': 'ch17',
        'quarantine': 'ch17',
        'ethics': 'ch17',
        'sensitivity': 'ch19',
        'specificity': 'ch19',
        'screening': 'ch19'
    };

    // Check for keyword matches
    for (const [keyword, chapter] of Object.entries(keywordMap)) {
        if (text.includes(keyword)) {
            return chapter;
        }
    }

    return null;
}

// Validation function to check unmapped questions
function validateQuestionMapping(quizBanks) {
    const unmapped = [];
    const invalid = [];

    Object.keys(quizBanks).forEach(part => {
        quizBanks[part].forEach((q, idx) => {
            if (!q.chapter) {
                unmapped.push({
                    part,
                    index: idx,
                    question: q.question.substring(0, 60) + '...',
                    suggested: suggestChapter(q.question)
                });
            } else if (!CHAPTER_REFERENCE[q.chapter]) {
                invalid.push({
                    part,
                    index: idx,
                    chapter: q.chapter,
                    question: q.question.substring(0, 60) + '...'
                });
            }
        });
    });

    return { unmapped, invalid };
}

// Export functions to window for global access
if (typeof window !== 'undefined') {
    window.CHAPTER_REFERENCE = CHAPTER_REFERENCE;
    window.getChapterInfo = getChapterInfo;
    window.generateReviewLink = generateReviewLink;
    window.suggestChapter = suggestChapter;
    window.validateQuestionMapping = validateQuestionMapping;
}

// Export for Node.js if needed
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        CHAPTER_REFERENCE,
        getChapterInfo,
        generateReviewLink,
        suggestChapter,
        validateQuestionMapping
    };
}

// console.log("[DEBUG] epidemic-engine-tools.js LOADED");
// EPIDEMIC ENGINE TOOLS MANAGER
// Handles initialization and switching of interactive tools

// Global tool instances are declared in their respective files
// calc2x2, epiCurve, exposureCalc are expected to be available globally

window.TOOLS_MANAGER = {
    init: function () {
        // console.log("[TOOLS] Initializing Tools Manager...");
        // Small delay to ensure DOM is ready if called immediately
        setTimeout(() => {
            this.setupTabs();
            // Initialize default tool (2x2)
            if (typeof Calculator2x2 !== 'undefined') {
                // console.log("[TOOLS] Initializing default 2x2 calculator");
                calc2x2 = new Calculator2x2('tool-container-2x2');
            } else {
                console.warn("[TOOLS] Calculator2x2 is undefined");
            }
        }, 50);
    },

    setupTabs: function () {
        const tabs = document.querySelectorAll('.tool-tab');
        // console.log(`[TOOLS] Found ${tabs.length} tabs`);

        if (tabs.length === 0) {
            console.warn("[TOOLS] No tabs found! Retrying in 100ms...");
            setTimeout(() => this.setupTabs(), 100);
            return;
        }

        tabs.forEach(tab => {
            // Remove old listeners by cloning (simple way to clear events without named functions)
            const newTab = tab.cloneNode(true);
            tab.parentNode.replaceChild(newTab, tab);

            newTab.addEventListener('click', (e) => {
                // console.log("[TOOLS] Tab clicked:", newTab.dataset.tool);
                e.preventDefault(); // Prevent default anchor behavior if any

                // Remove active class from all tabs and contents
                document.querySelectorAll('.tool-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tool-content').forEach(c => c.classList.remove('active'));

                // Add active class to clicked tab
                newTab.classList.add('active');

                // Show corresponding content
                const toolId = newTab.dataset.tool;
                const container = document.getElementById(`tool-container-${toolId}`);
                if (container) {
                    container.classList.add('active');
                    // console.log(`[TOOLS] Activated container: tool-container-${toolId}`);
                } else {
                    console.error(`[TOOLS] Container not found: tool-container-${toolId}`);
                }

                // Initialize specific tool if needed
                this.loadTool(toolId);
            });
        });
    },

    loadTool: function (toolId) {
        // console.log("[TOOLS] Loading tool:", toolId);
        try {
            switch (toolId) {
                case '2x2':
                    if (!calc2x2 && typeof Calculator2x2 !== 'undefined') {
                        calc2x2 = new Calculator2x2('tool-container-2x2');
                    }
                    break;
                case 'curve':
                    if (!epiCurve && typeof EpiCurve !== 'undefined') {
                        epiCurve = new EpiCurve('tool-container-curve');
                    }
                    break;
                case 'exposure':
                    if (!exposureCalc && typeof ExposureCalculator !== 'undefined') {
                        exposureCalc = new ExposureCalculator('tool-container-exposure');
                    }
                    break;
                case 'notesheet':
                    if (typeof NotesheetGenerator !== 'undefined') {
                        NotesheetGenerator.render('tool-container-notesheet');
                    }
                    break;
                case 'proctor':
                    if (!proctorTimer && typeof ProctorTimer !== 'undefined') {
                        proctorTimer = new ProctorTimer('tool-container-proctor');
                    }
                    break;
                case 'drills':
                    if (typeof FlashDrills !== 'undefined' && !window.flashDrillsInstance) {
                        window.flashDrillsInstance = new FlashDrills('tool-container-drills');
                    }
                    break;
            }
        } catch (err) {
            console.error("[TOOLS] Error loading tool:", err);
        }
    }
};

// Hook into the content loader
// This function is called by epidemic-engine-nav.js when a chapter loads
function onToolsChapterLoaded() {
    TOOLS_MANAGER.init();
}

// 2x2 TABLE CALCULATOR
// Auto-calculates RR, OR, AR, and other epidemiological measures

class Calculator2x2 {
    constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.values = { a: 0, b: 0, c: 0, d: 0 };
        this.mode = 'unmatched';
        this.render();
    }

    render() {
        const html = `
            <div class="calculator-2x2">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;"><i class="ph ph-calculator"></i> 2Ã—2 Table Calculator</h2>
                </div>
                
                <div class="mode-selector" style="background: var(--surface-2); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="calc-mode" style="font-weight: 500; font-size: 0.9rem;">Analysis Mode:</label>
                            <select id="calc-mode" class="form-select" style="width: 100%; margin-top: 0.5rem;" onchange="calc2x2.setMode(this.value)">
                                <option value="unmatched">Standard (Unmatched / Cohort)</option>
                                <option value="matched">Matched Case-Control</option>
                                <option value="pt">Incidence Density (Person-Time)</option>
                            </select>
                        </div>
                        <div class="national-toggle" style="display: flex; align-items: center; margin-top: 1.5rem;">
                            <label class="switch" style="margin-right: 0.5rem;">
                                <input type="checkbox" id="national-mode-toggle" aria-label="Toggle National Statistics Mode" ${this.nationalMode ? 'checked' : ''} onchange="calc2x2.toggleNationalMode(this.checked)">
                                <span class="slider round"></span>
                            </label>
                            <span style="font-weight: bold; color: var(--navy-primary); font-size: 0.9rem;">National Stats</span>
                        </div>
                    </div>
                    <div id="mode-guidance" style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted); font-style: italic;">
                        Standard 2x2 analysis for Cohort and Case-Control studies. Enter counts of individuals.
                    </div>
                </div>

                <div class="calc-actions" style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="calc2x2.toggleSteps()"><i class="ph-bold ph-function"></i> Show Math</button>
                    <button class="btn btn-secondary" onclick="calc2x2.copyResults()"><i class="ph-bold ph-copy"></i> Copy Results</button>
                    <button class="btn btn-outline" onclick="calc2x2.clear()">Clear</button>
                    <button class="btn btn-outline" onclick="calc2x2.loadExample()">Load Example</button>
                    <button class="btn btn-secondary" onclick="calc2x2.toggleImporter()" style="width: 100%; margin-top: 0.5rem;"><i class="ph-bold ph-upload"></i> Import Line List</button>
                </div>

                <div id="importer-section" class="neo-card small" style="display: none; background: #fff; border: 1px dashed var(--navy-primary); margin-bottom: 2rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4 style="margin:0;">Import Line List Data</h4>
                        <button onclick="calc2x2.toggleImporter()" style="background:none; border:none; cursor:pointer;"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <p style="font-size:0.9rem; color:#666; margin:0.5rem 0;">Paste rows (Excel/Sheets). Must have headers like "Exposure" and "Ill".</p>
                    <textarea id="import-area" aria-label="Paste CSV Data here" style="width:100%; height:120px; font-family:monospace; margin-bottom:0.5rem; border:1px solid #ccc; padding:0.5rem;" placeholder="ID      Exposure      Ill&#10;1       Yes           Yes&#10;2       No            No"></textarea>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div id="import-error" style="color:var(--accent-orange); font-size:0.85rem; font-weight:bold;"></div>
                        <button class="neo-btn primary small" onclick="calc2x2.runImport()">Process Data</button>
                    </div>
                </div>

                <div id="calc-steps" class="neo-card small" style="display: none; background: #f8fafc; border: 1px dashed var(--navy-primary); margin-bottom: 2rem;">
                    <h4 style="margin-top: 0; color: var(--navy-primary);">Step-by-Step Breakdown</h4>
                    <div id="steps-content" style="font-family: monospace; font-size: 0.95rem;"></div>
                </div>
                
                <div class="table-2x2">
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th id="table-head-1">Disease + (Ill)</th>
                                <th id="table-head-2">Disease âˆ’ (Well)</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="table-row-1"><strong>Exposed +</strong></td>
                                <td>
                                    <input type="number" id="cell-a" value="${this.values.a}" min="0" class="cell-input" 
                                           aria-label="Cell A: Exposed and Ill"
                                           title="a = True Positives (Exposed and Ill)">
                                    <div style="font-size: 0.7rem; color: #666; text-align: center;">a</div>
                                </td>
                                <td>
                                    <input type="number" id="cell-b" value="${this.values.b}" min="0" class="cell-input"
                                           aria-label="Cell B: Exposed and Well"
                                           title="b = False Positives (Exposed but Well)">
                                    <div style="font-size: 0.7rem; color: #666; text-align: center;">b</div>
                                </td>
                                <td class="total-cell" id="total-a-b">0</td>
                            </tr>
                            <tr>
                                <td id="table-row-2"><strong>Exposed âˆ’</strong></td>
                                <td>
                                    <input type="number" id="cell-c" value="${this.values.c}" min="0" class="cell-input"
                                           aria-label="Cell C: Unexposed and Ill"
                                           title="c = False Negatives (Unexposed but Ill)">
                                    <div style="font-size: 0.7rem; color: #666; text-align: center;">c</div>
                                </td>
                                <td>
                                    <input type="number" id="cell-d" value="${this.values.d}" min="0" class="cell-input"
                                           aria-label="Cell D: Unexposed and Well"
                                           title="d = True Negatives (Unexposed and Well)">
                                    <div style="font-size: 0.7rem; color: #666; text-align: center;">d</div>
                                </td>
                                <td class="total-cell" id="total-c-d">0</td>
                            </tr>
                            <tr>
                                <td><strong>Total</strong></td>
                                <td class="total-cell" id="total-a-c">0</td>
                                <td class="total-cell" id="total-b-d">0</td>
                                <td class="total-cell grand-total" id="grand-total">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="results-grid" aria-live="polite" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="neo-card small">
                        <strong>Attack Rate (Exp)</strong>
                        <div class="stat-value" id="ar-exposed">â€”</div>
                    </div>
                    <div class="neo-card small">
                        <strong>Attack Rate (Unexp)</strong>
                        <div class="stat-value" id="ar-unexposed">â€”</div>
                    </div>
                    <div class="neo-card small">
                        <strong>Relative Risk (RR)</strong>
                        <div class="stat-value accent" id="rr-value">â€”</div>
                        <div class="stat-sub" id="rr-interp"></div>
                    </div>
                    <div class="neo-card small">
                        <strong>Odds Ratio (OR)</strong>
                        <div class="stat-value accent" id="or-value">â€”</div>
                        <div class="stat-sub" id="or-interp"></div>
                        <div class="stat-sub" style="margin-top:0.25rem; font-size:0.8rem; color: var(--text-color); font-weight: bold;">
                           (OR â‰ˆ RR if prev. &lt; 10%)
                        </div>
                    </div>
                    <div class="neo-card small">
                        <strong>Attr. Risk (RD)</strong>
                        <div class="stat-value" id="rd-value">â€”</div>
                    </div>
                     <div class="neo-card small">
                        <strong>Attr. Risk %</strong>
                        <div class="stat-value" id="ar-pct-value">â€”</div>
                    </div>
                </div>

                <div class="national-mode-section national-stat hidden" style="border-top: 2px dashed var(--border); padding-top: 1.5rem;">
                    <h3 style="color: var(--navy-primary); margin-top: 0;">Advanced Statistics (National Mode)</h3>
                    <div class="results-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem;">
                        <div class="neo-card small" style="background: #fdf2f8;">
                            <strong>Chi-Square</strong>
                            <div class="stat-value" id="chi-square-value">â€”</div>
                            <div class="stat-sub" id="p-value"></div>
                            <div class="stat-sub" id="chi-interp"></div>
                        </div>
                        <div class="neo-card small" style="background: #fdf2f8;">
                            <strong>95% CI (OR)</strong>
                            <div class="stat-value smaller" id="or-ci">â€”</div>
                            <div class="stat-sub">Woolf's Method</div>
                        </div>
                         <div class="neo-card small" style="background: #fdf2f8;">
                            <strong>95% CI (RR)</strong>
                            <div class="stat-value smaller" id="rr-ci">â€”</div>
                            <div class="stat-sub">Taylor Series</div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        this.container.innerHTML = html;
        this.attachListeners();
        this.calculate();
    }

    copyResults() {
        const { a, b, c, d } = this.values;
        const rr = document.getElementById('rr-value').textContent;
        const or = document.getElementById('or-value').textContent;
        const arExp = document.getElementById('ar-exposed').textContent;
        const arUnexp = document.getElementById('ar-unexposed').textContent;
        const rd = document.getElementById('rd-value').textContent;

        const text = `2x2 Calculation Results:
------------------------
       Ill  Well
Exp+   ${a}   ${b}
Exp-   ${c}   ${d}
------------------------
Attack Rate (Exp): ${arExp}
Attack Rate (Unexp): ${arUnexp}
Relative Risk (RR): ${rr}
Odds Ratio (OR): ${or}
Attributable Risk: ${rd}
`;
        navigator.clipboard.writeText(text).then(() => {
            const btns = this.container.querySelectorAll('.btn-secondary');
            // Assuming the copy button is the second one, but safer to find by icon or text
            let btn = null;
            btns.forEach(b => {
                if (b.textContent.includes('Copy')) btn = b;
            });

            if (btn) {
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="ph-bold ph-check"></i> Copied!';
                setTimeout(() => btn.innerHTML = original, 2000);
            }
        }).catch(err => {
            console.error('Failed to copy', err);
            if (typeof window.UI !== 'undefined') window.UI.toast('Failed to copy to clipboard', 'error');
            else alert('Failed to copy to clipboard');
        });
    }

    attachListeners() {
        ['a', 'b', 'c', 'd'].forEach(cell => {
            const input = document.getElementById(`cell-${cell}`);
            if (input) {
                input.addEventListener('input', (e) => {
                    let val = parseInt(e.target.value);
                    if (isNaN(val) || val < 0) val = 0;
                    // Dont overwrite user typing empty string, only on calc
                    this.values[cell] = val;
                    this.calculate();
                });
                // Enforce on blur
                input.addEventListener('blur', (e) => {
                    let val = parseInt(e.target.value);
                    if (isNaN(val) || val < 0) {
                        e.target.value = 0;
                        this.values[cell] = 0;
                        this.calculate();
                    }
                });
            }
        });
    }

    toggleSteps() {
        const steps = document.getElementById('calc-steps');
        const btn = this.container.querySelector('.btn-secondary');
        if (steps.style.display === 'none') {
            steps.style.display = 'block';
            btn.innerHTML = '<i class="ph-bold ph-function"></i> Hide Math';
        } else {
            steps.style.display = 'none';
            btn.innerHTML = '<i class="ph-bold ph-function"></i> Show Math';
        }
    }

    calculate() {
        // Sanitize values to ensure they are numbers
        this.values.a = Number(this.values.a) || 0;
        this.values.b = Number(this.values.b) || 0;
        this.values.c = Number(this.values.c) || 0;
        this.values.d = Number(this.values.d) || 0;

        const { a, b, c, d } = this.values;

        // Update totals
        document.getElementById('total-a-b').textContent = Number((a + b).toFixed(1));
        document.getElementById('total-c-d').textContent = Number((c + d).toFixed(1));
        document.getElementById('total-a-c').textContent = Number((a + c).toFixed(1));
        document.getElementById('total-b-d').textContent = Number((b + d).toFixed(1));
        document.getElementById('grand-total').textContent = Number((a + b + c + d).toFixed(1));

        const mode = this.mode || 'unmatched';
        const stepsContainer = document.getElementById('steps-content');

        let rr = 0, or = 0, arExposed = 0, arUnexposed = 0, arPct = 0;

        if (mode === 'matched') {
            // McNemar's OR = b / c
            or = c > 0 ? b / c : 0;

            document.getElementById('rr-value').textContent = "N/A";
            document.getElementById('or-value').textContent = this.formatNumber(or);
            document.getElementById('ar-exposed').textContent = "N/A";
            document.getElementById('ar-unexposed').textContent = "N/A";
            document.getElementById('rd-value').textContent = "N/A";
            document.getElementById('ar-pct-value').textContent = "N/A";

            if (stepsContainer) {
                stepsContainer.innerHTML = `
                    <div style="margin-bottom: 0.5rem;"><strong>Matched Case-Control:</strong> Analyze <em>discordant pairs</em>.</div>
                    <div><strong>Odds Ratio (OR):</strong> b / c = ${b} / ${c} = <strong>${this.formatNumber(or)}</strong></div>
                `;
            }

            this.interpretValue('or-interp', or, 'odds');
            document.getElementById('rr-interp').textContent = "Not used in Matched";

        } else if (mode === 'pt') {
            arExposed = b > 0 ? a / b : 0;
            arUnexposed = d > 0 ? c / d : 0;
            const irr = arUnexposed > 0 ? arExposed / arUnexposed : 0;

            document.getElementById('ar-exposed').textContent = arExposed.toFixed(4);
            document.getElementById('ar-unexposed').textContent = arUnexposed.toFixed(4);
            document.getElementById('rr-value').textContent = this.formatNumber(irr);
            document.getElementById('or-value').textContent = "N/A";

            const rd = arExposed - arUnexposed;
            document.getElementById('rd-value').textContent = rd.toFixed(4);

            arPct = irr > 0 ? (((irr - 1) / irr) * 100) : 0;
            document.getElementById('ar-pct-value').textContent = this.formatPercent(arPct / 100);

            if (stepsContainer) {
                stepsContainer.innerHTML = `
                    <div style="margin-bottom: 0.5rem;"><strong>Incidence Rate (Exp):</strong> Cases / PT = ${a} / ${b} = <strong>${arExposed.toFixed(4)}</strong></div>
                    <div style="margin-bottom: 0.5rem;"><strong>Incidence Rate (Unexp):</strong> Cases / PT = ${c} / ${d} = <strong>${arUnexposed.toFixed(4)}</strong></div>
                    <div style="margin-bottom: 0.5rem;"><strong>Rate Ratio (IRR):</strong> IR(exp) / IR(unexp) = ${arExposed.toFixed(4)} / ${arUnexposed.toFixed(4)} = <strong>${this.formatNumber(irr)}</strong></div>
                `;
            }

            this.interpretValue('rr-interp', irr, 'risk');
            document.getElementById('or-interp').textContent = "N/A for Person-Time";

        } else {
            const totalExposed = a + b;
            const totalUnexposed = c + d;

            arExposed = totalExposed > 0 ? (a / totalExposed) : 0;
            arUnexposed = totalUnexposed > 0 ? (c / totalUnexposed) : 0;

            rr = arUnexposed > 0 ? (arExposed / arUnexposed) : 0;
            or = (b > 0 && c > 0) ? ((a * d) / (b * c)) : 0;

            document.getElementById('ar-exposed').textContent = this.formatPercent(arExposed);
            document.getElementById('ar-unexposed').textContent = this.formatPercent(arUnexposed);
            document.getElementById('rr-value').textContent = this.formatNumber(rr);
            document.getElementById('or-value').textContent = this.formatNumber(or);

            const rd = arExposed - arUnexposed;
            document.getElementById('rd-value').textContent = this.formatPercent(rd);

            arPct = rr > 0 ? (((rr - 1) / rr) * 100) : 0;
            document.getElementById('ar-pct-value').textContent = this.formatPercent(arPct / 100);

            if (stepsContainer) {
                stepsContainer.innerHTML = `
                    <div style="margin-bottom: 0.5rem;"><strong>1. Attack Rate (Exposed):</strong> a / (a+b) = ${a} / ${totalExposed} = <strong>${arExposed.toFixed(3)}</strong> (${(arExposed * 100).toFixed(1)}%)</div>
                    <div style="margin-bottom: 0.5rem;"><strong>2. Attack Rate (Unexposed):</strong> c / (c+d) = ${c} / ${totalUnexposed} = <strong>${arUnexposed.toFixed(3)}</strong> (${(arUnexposed * 100).toFixed(1)}%)</div>
                    <div style="margin-bottom: 0.5rem;"><strong>3. Relative Risk (RR):</strong> AR(exp) / AR(unexp) = ${arExposed.toFixed(3)} / ${arUnexposed.toFixed(3)} = <strong>${this.formatNumber(rr)}</strong></div>
                    <div style="margin-bottom: 0.5rem;"><strong>4. Odds Ratio (OR):</strong> (aÃ—d) / (bÃ—c) = (${a}Ã—${d}) / (${b}Ã—${c}) = ${a * d} / ${b * c} = <strong>${this.formatNumber(or)}</strong></div>
                `;
            }

            this.interpretValue('rr-interp', rr, 'risk');
            this.interpretValue('or-interp', or, 'odds');

            if (this.nationalMode) {
                this.calculateNationalStats(a, b, c, d, or, rr);
            }
        }
    }

    interpretValue(elementId, val, type) {
        const el = document.getElementById(elementId);
        if (!el) return;

        if (val > 1) {
            el.textContent = type === 'risk' ? `Exposure increases risk by ${((val - 1) * 100).toFixed(0)}%` : `${val.toFixed(2)}Ã— higher odds`;
            el.style.color = 'var(--danger)';
        } else if (val < 1 && val > 0) {
            el.textContent = type === 'risk' ? `Exposure decreases risk by ${((1 - val) * 100).toFixed(0)}%` : `${(1 / val).toFixed(2)}Ã— lower odds`;
            el.style.color = 'var(--success)';
        } else if (val === 1) {
            el.textContent = 'No association';
            el.style.color = 'var(--text-muted)';
        } else {
            el.textContent = 'â€”';
            el.style.color = 'var(--text-muted)';
        }
    }

    setMode(mode) {
        this.mode = mode;
        const guidance = document.getElementById('mode-guidance');
        const thDisease = document.getElementById('table-head-1');
        const thHealthy = document.getElementById('table-head-2');
        const rowExp = document.getElementById('table-row-1');
        const rowUnexp = document.getElementById('table-row-2');

        // Reset guidance styles
        if (guidance) {
            guidance.style.background = 'transparent';
            guidance.style.padding = '0';
            guidance.style.borderRadius = '0';
            guidance.style.color = 'var(--text-muted)';
        }

        if (mode === 'matched') {
            if (guidance) guidance.textContent = "Matched Case-Control. Use the 2x2 of Pairs. Cells represent PAIRS, not people.";
            if (thDisease) thDisease.innerHTML = "Control Exposed (+)";
            if (thHealthy) thHealthy.innerHTML = "Control Unexposed (-)";
            if (rowExp) rowExp.innerHTML = "<strong>Case Exposed (+)</strong>";
            if (rowUnexp) rowUnexp.innerHTML = "<strong>Case Unexposed (-)</strong>";
        } else if (mode === 'pt') {
            if (guidance) guidance.textContent = "Incidence Density. 'Disease -' column becomes 'Person-Time'. Enter summed time.";
            if (thDisease) thDisease.innerHTML = "Cases";
            if (thHealthy) thHealthy.innerHTML = "Person-Time";
            if (rowExp) rowExp.innerHTML = "<strong>Exposed</strong>";
            if (rowUnexp) rowUnexp.innerHTML = "<strong>Unexposed</strong>";
        } else {
            if (guidance) guidance.textContent = "Standard 2x2 analysis for Cohort and Case-Control studies. Enter counts of individuals.";
            if (thDisease) thDisease.innerHTML = "Disease + (Ill)";
            if (thHealthy) thHealthy.innerHTML = "Disease âˆ’ (Well)";
            if (rowExp) rowExp.innerHTML = "<strong>Exposed +</strong>";
            if (rowUnexp) rowUnexp.innerHTML = "<strong>Exposed âˆ’</strong>";
        }
        this.calculate();
    }

    toggleNationalMode(checked) {
        this.nationalMode = checked;
        const stats = this.container.querySelectorAll('.national-stat');
        stats.forEach(el => {
            if (this.nationalMode) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        });
        this.calculate();
    }

    calculateNationalStats(a, b, c, d, or, rr) {
        const total = a + b + c + d;
        if (total > 0) {
            const expA = ((a + c) * (a + b)) / total;
            const expB = ((b + d) * (a + b)) / total;
            const expC = ((a + c) * (c + d)) / total;
            const expD = ((b + d) * (c + d)) / total;

            const chi = (Math.pow(a - expA, 2) / expA) +
                (Math.pow(b - expB, 2) / expB) +
                (Math.pow(c - expC, 2) / expC) +
                (Math.pow(d - expD, 2) / expD);

            document.getElementById('chi-square-value').textContent = chi.toFixed(2);

            let pVal = "";
            if (chi > 6.63) pVal = "< 0.01 (Highly Sig)";
            else if (chi > 3.84) pVal = "< 0.05 (Significant)";
            else pVal = "> 0.05 (Not Sig)";

            document.getElementById('p-value').textContent = pVal;
            document.getElementById('chi-interp').textContent = chi > 3.84 ? "Reject Null Hypothesis" : "Fail to Reject Null";
        }

        if (a > 0 && b > 0 && c > 0 && d > 0) {
            const lnOR = Math.log(or);
            const seOR = Math.sqrt((1 / a) + (1 / b) + (1 / c) + (1 / d));
            const lowerOR = Math.exp(lnOR - (1.96 * seOR));
            const upperOR = Math.exp(lnOR + (1.96 * seOR));
            document.getElementById('or-ci').textContent = `95 % CI: ${lowerOR.toFixed(2)} - ${upperOR.toFixed(2)} `;
        } else {
            document.getElementById('or-ci').textContent = "Cannot calc CI (zeros)";
        }

        if (a > 0 && c > 0) {
            const lnRR = Math.log(rr);
            const seRR = Math.sqrt(((1 / a) + (1 / c)) - ((1 / (a + b)) + (1 / (c + d))));
            const lowerRR = Math.exp(lnRR - (1.96 * seRR));
            const upperRR = Math.exp(lnRR + (1.96 * seRR));
            document.getElementById('rr-ci').textContent = `95 % CI: ${lowerRR.toFixed(2)} - ${upperRR.toFixed(2)} `;
        } else {
            document.getElementById('rr-ci').textContent = "Cannot calc CI (zeros)";
        }
    }

    formatNumber(num) {
        if (num === 0 || !isFinite(num)) return 'â€”';
        return num.toFixed(2);
    }

    formatPercent(num) {
        if (num === 0 || !isFinite(num)) return 'â€”';
        return `${(num * 100).toFixed(1)}% `;
    }

    clear() {
        this.values = { a: 0, b: 0, c: 0, d: 0 };
        ['a', 'b', 'c', 'd'].forEach(cell => {
            const input = document.getElementById(`cell-${cell}`);
            if (input) input.value = 0;
        });

        // Reset mode and guidance styles
        this.setMode('unmatched');
        document.getElementById('calc-mode').value = 'unmatched';

        this.calculate();
    }

    loadExample() {
        const mode = document.getElementById('calc-mode').value;

        if (mode === 'matched') {
            // Matched Pairs Example (Foodborne pairs)
            this.values = { a: 15, b: 35, c: 5, d: 45 }; // b and c are discordant pairs
            ['a', 'b', 'c', 'd'].forEach(cell => {
                const input = document.getElementById(`cell-${cell}`);
                if (input) input.value = this.values[cell];
            });
            this.setMode('matched');
            const guidance = document.getElementById('mode-guidance');
            if (guidance) {
                guidance.innerHTML = '<strong style="color: var(--navy-primary);">Matched Example:</strong> 35 pairs were Case-Exposed/Control-Unexposed (b), only 5 were Case-Unexposed/Control-Exposed (c). OR is high.';
                guidance.style.background = '#eef2ff';
            }
        } else if (mode === 'pt') {
            // Person-Time Example
            this.values = { a: 10, b: 1000, c: 5, d: 1000 };
            ['a', 'b', 'c', 'd'].forEach(cell => {
                const input = document.getElementById(`cell-${cell}`);
                if (input) input.value = this.values[cell];
            });
            this.setMode('pt');
            const guidance = document.getElementById('mode-guidance');
            if (guidance) {
                guidance.innerHTML = '<strong style="color: var(--navy-primary);">PT Example:</strong> 10 cases in 1000 person-years exposed vs 5 in 1000 unexposed.';
                guidance.style.background = '#eef2ff';
            }
        } else {
            // Unmatched (Standard)
            this.values = { a: 85, b: 15, c: 10, d: 90 };
            ['a', 'b', 'c', 'd'].forEach(cell => {
                const input = document.getElementById(`cell-${cell}`);
                if (input) input.value = this.values[cell];
            });
            this.setMode('unmatched');

            const guidance = document.getElementById('mode-guidance');
            if (guidance) {
                guidance.innerHTML = '<strong style="color: var(--navy-primary);">Example Loaded:</strong> Chicken salad outbreak. Compare the high Attack Rate in exposed vs unexposed.';
                guidance.style.background = '#eef2ff';
                guidance.style.padding = '0.5rem';
                guidance.style.borderRadius = '4px';
            }
        }
        this.calculate();
    }

    toggleImporter() {
        const el = document.getElementById('importer-section');
        if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
        if (el.style.display === 'block') document.getElementById('import-area').focus();
    }

    runImport() {
        const text = document.getElementById('import-area').value.trim();
        const errorEl = document.getElementById('import-error');
        errorEl.textContent = '';
        errorEl.style.color = 'var(--accent-orange)';

        if (!text) { errorEl.textContent = "No data entered."; return; }

        const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
        if (lines.length < 2) { errorEl.textContent = "Need at least header and one row."; return; }

        // Naive Parser
        const header = lines[0].toLowerCase().split(/[\t,;|]+/).map(s => s.trim());
        let expIdx = header.findIndex(h => h.includes('exp') || h.includes('risk') || h.includes('food') || h.includes('eaten'));
        let illIdx = header.findIndex(h => h.includes('ill') || h.includes('sick') || h.includes('case') || h.includes('dis') || h.includes('outcome'));

        // Fallback
        if (expIdx === -1 && illIdx === -1) {
            if (header.length >= 3) { expIdx = 1; illIdx = 2; }
            else if (header.length === 2) { expIdx = 0; illIdx = 1; }
        }

        if (expIdx === -1 || illIdx === -1) {
            errorEl.textContent = "Cannot find Exposure/Ill columns. Use headers 'Exp' and 'Ill'.";
            return;
        }

        let a = 0, b = 0, c = 0, d = 0;
        let processed = 0;

        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].split(/[\t,;|]+/).map(s => s.trim());
            if (row.length <= Math.max(expIdx, illIdx)) continue;

            const expVal = this.parseBool(row[expIdx]);
            const illVal = this.parseBool(row[illIdx]);

            if (expVal === null || illVal === null) continue;

            if (expVal && illVal) a++;
            if (expVal && !illVal) b++;
            if (!expVal && illVal) c++;
            if (!expVal && !illVal) d++;
            processed++;
        }

        if (processed === 0) {
            errorEl.textContent = "No valid data rows found.";
            return;
        }

        this.values = { a, b, c, d };

        if (document.getElementById('cell-a')) document.getElementById('cell-a').value = a;
        if (document.getElementById('cell-b')) document.getElementById('cell-b').value = b;
        if (document.getElementById('cell-c')) document.getElementById('cell-c').value = c;
        if (document.getElementById('cell-d')) document.getElementById('cell-d').value = d;

        this.calculate();
        errorEl.style.color = 'green';
        errorEl.textContent = `Success! Processed ${processed} rows.`;

        // Hide after success
        setTimeout(() => {
            if (document.getElementById('import-error').textContent.includes('Success')) {
                this.toggleImporter();
            }
        }, 1500);
    }

    parseBool(val) {
        if (!val) return null;
        val = val.toLowerCase();
        if (['y', 'yes', '1', 'pos', '+', 'true'].some(x => val.startsWith(x))) return true;
        if (['n', 'no', '0', 'neg', '-', 'false'].some(x => val.startsWith(x))) return false;
        return null;
    }
}

// Global instance
let calc2x2 = null;

class EpiCurve {
    constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.cases = [];
        this.mode = 'plotter'; // 'plotter' or 'visualizer'
        this.visualizerType = 'point'; // 'point', 'continuous', 'propagated'
        this.render();
    }

    addCase(dateStr) {
        if (!dateStr) return;
        this.cases.push(dateStr);
        this.cases.sort();
        this.render();
    }

    // Cleaned up duplicate render and input methods


    removeCase(index) {
        this.cases.splice(index, 1);
        this.render();
    }

    clear() {
        if (typeof window.UI !== 'undefined') {
            window.UI.modal('Clear Data', 'Are you sure you want to clear all data?', () => {
                this.cases = [];
                this.render();
                window.UI.toast('Data cleared.', 'info');
            });
        } else if (confirm('Are you sure you want to clear all data?')) {
            this.cases = [];
            this.render();
        }
    }

    loadExample() {
        this.loadPointSource();
    }

    loadPointSource() {
        const baseDate = new Date().toISOString().split('T')[0];
        const pattern = [1, 2, 4, 7, 5, 3, 2, 1];
        this.populateData(baseDate, pattern);
        this.renderSummaryTable(this.summarizeByDate(this.cases));
        this.renderExplanation({
            title: "Point Source Outbreak",
            text: "Rapid rise to a peak, then gradual decline. Suggests a single, sharp exposure (e.g., contaminated potato salad at a picnic)."
        });
    }

    loadIntermittent() {
        const baseDate = new Date().toISOString().split('T')[0];
        // Intermittent: Peaks separated by non-incubation periods
        const pattern = [2, 3, 0, 0, 4, 5, 0, 0, 0, 3, 2];
        this.populateData(baseDate, pattern);
        this.renderSummaryTable(this.summarizeByDate(this.cases));
        this.renderExplanation({
            title: "Intermittent Common Source",
            text: "Irregular peaks reflecting the timing and extent of exposure. Suggests a source that is not constant (e.g., specific batches of contaminated product)."
        });
    }

    loadPropagated() {
        const baseDate = new Date().toISOString().split('T')[0];
        // Propagated: Successively larger peaks, spaced by incubation period
        // Approx incubation of 3 days for this fake data
        const pattern = [1, 0, 0, 2, 3, 0, 0, 5, 8, 4, 0, 0, 2];
        this.populateData(baseDate, pattern);
        this.renderSummaryTable(this.summarizeByDate(this.cases));
        this.renderExplanation({
            title: "Propagated (Person-to-Person)",
            text: "Successively taller peaks, separated by one incubation period. Suggests the disease is spreading from person to person (e.g., Measles)."
        });
    }

    populateData(baseDate, pattern) {
        this.cases = [];
        pattern.forEach((count, offset) => {
            for (let i = 0; i < count; i++) {
                this.cases.push(this.addDays(baseDate, offset));
            }
        });
        this.cases.sort();
        this.render();
    }

    renderExplanation(info) {
        const container = document.getElementById('epi-curve-explanation');
        if (!container) return;
        container.innerHTML = `
            <div class="neo-card small" style="border-left: 4px solid var(--accent-orange); margin-top: 1rem;">
                <h4>${info.title}</h4>
                <p>${info.text}</p>
            </div>
        `;
    }

    /**
     * Summarise an array of case dates into an array of objects with date and count.
     * @param {string[]} cases
     * @returns {{date: string, count: number}[]}
     */
    summarizeByDate(cases) {
        const counts = {};
        cases.forEach(d => {
            counts[d] = (counts[d] || 0) + 1;
        });
        return Object.keys(counts)
            .sort()
            .map(date => ({ date, count: counts[date] }));
    }

    /**
     * Render the summary data table into the dedicated container on the page.
     * @param {Array} summary
     */
    renderSummaryTable(summary) {
        const container = document.getElementById('epi-curve-table-container');
        if (!container) return;
        if (!summary || summary.length === 0) {
            container.innerHTML = '';
            return;
        }
        const rows = summary.map(row => {
            return `<tr><td>${row.date}</td><td style="text-align:left;">${row.count}</td></tr>`;
        }).join('');
        container.innerHTML = `
            <table class="table" style="width: auto; min-width: 300px; border-collapse: collapse;">
                <thead style="background: var(--navy-primary); color: white;">
                    <tr><th style="padding: 0.5rem; text-align:left;">Date (onset)</th><th style="padding: 0.5rem; text-align:left;">Number of cases</th></tr>
                </thead>
                <tbody>
                    ${rows}
                </tbody>
            </table>
        `;
    }



    addDays(dateStr, days) {
        const date = new Date(dateStr);
        date.setDate(date.getDate() + days);
        return date.toISOString().split('T')[0];
    }

    getHistogramData() {
        if (this.cases.length === 0) return { labels: [], data: [], max: 0 };

        const counts = {};
        let minDate = new Date(this.cases[0]);
        let maxDate = new Date(this.cases[this.cases.length - 1]);

        // Fill in gaps
        for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            counts[dateStr] = 0;
        }

        this.cases.forEach(date => {
            if (counts[date] !== undefined) counts[date]++;
        });

        const labels = Object.keys(counts).sort();
        const data = labels.map(date => counts[date]);
        const max = Math.max(...data, 1); // Ensure at least 1 for scale

        return { labels, data, max };
    }

    // --- Visualizer Methods ---

    setMode(mode) {
        this.mode = mode;
        this.render();
        if (mode === 'visualizer') {
            this.drawVisualizer();
        }
    }

    setVisualizerType(type) {
        this.visualizerType = type;
        this.drawVisualizer();
        this.updateVisualizerDescription();
    }

    drawVisualizer() {
        const canvas = document.getElementById('epiCanvas');
        if (!canvas) return;

        // Auto-Resize
        const container = canvas.parentElement;
        if (container) {
            canvas.width = container.clientWidth;
            // canvas.height remains fixed or could be ratio based
        }

        const ctx = canvas.getContext('2d');
        const type = this.visualizerType;

        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Set dimensions
        const padding = 40;
        const chartWidth = canvas.width - 2 * padding;
        const chartHeight = canvas.height - 2 * padding;

        // Draw axes
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--color-text') || '#000';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, canvas.height - padding);
        ctx.lineTo(canvas.width - padding, canvas.height - padding);
        ctx.stroke();

        // Labels
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--color-text') || '#000';
        ctx.font = '14px sans-serif';
        ctx.fillText('Cases', 10, 30);
        ctx.fillText('Time', canvas.width / 2 - 20, canvas.height - 10);

        // Generate data based on type
        let data = [];
        const maxCases = 50;

        if (type === 'point') {
            // Point source - bell curve
            for (let i = 0; i < 20; i++) {
                const x = i - 10;
                const y = maxCases * Math.exp(-x * x / 20);
                data.push(y);
            }
        } else if (type === 'continuous') {
            // Continuous - plateau
            for (let i = 0; i < 20; i++) {
                if (i < 3) data.push(maxCases * 0.1 * i);
                else if (i < 15) data.push(maxCases * 0.8 + Math.random() * maxCases * 0.2);
                else data.push(maxCases * 0.8 * (20 - i) / 5);
            }
        } else if (type === 'intermittent') {
            // Intermittent - Irregular peaks
            for (let i = 0; i < 25; i++) {
                let val = 0;
                // Peak 1
                if (Math.abs(i - 4) <= 2) val = maxCases * 0.6;
                // Peak 2
                if (Math.abs(i - 12) <= 1) val = maxCases * 0.8;
                // Peak 3
                if (Math.abs(i - 20) <= 2) val = maxCases * 0.5;

                // Add randomization
                if (val > 0) val += (Math.random() - 0.5) * (maxCases * 0.2);

                data.push(Math.max(0, val));
            }
        } else {
            // Propagated - multiple peaks
            for (let i = 0; i < 25; i++) {
                const peak1 = maxCases * 0.4 * Math.exp(-Math.pow(i - 5, 2) / 8);
                const peak2 = maxCases * 0.7 * Math.exp(-Math.pow(i - 12, 2) / 10);
                const peak3 = maxCases * 1.0 * Math.exp(-Math.pow(i - 20, 2) / 12);
                data.push(peak1 + peak2 + peak3);
            }
        }

        // Draw bars
        const barWidth = chartWidth / data.length;
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--color-primary') || '#21808d';

        data.forEach((value, index) => {
            const barHeight = (value / maxCases) * chartHeight;
            const x = padding + index * barWidth;
            const y = canvas.height - padding - barHeight;
            ctx.fillRect(x, y, barWidth * 0.8, barHeight);
        });
    }

    updateVisualizerDescription() {
        const descriptions = {
            point: `<h4 style="color: var(--color-primary);">Point Source Outbreak</h4>
                    <p><strong>Pattern:</strong> Single sharp peak with rapid rise and gradual decline (bell curve)</p>
                    <p><strong>Cause:</strong> Exposure to a common source over a brief, well-defined period</p>
                    <p><strong>Example:</strong> Food poisoning from contaminated potato salad at a single event</p>
                    <p><strong>Key Feature:</strong> Everyone exposed at approximately the same time</p>`,
            continuous: `<h4 style="color: var(--color-primary);">Continuous Common Source Outbreak</h4>
                    <p><strong>Pattern:</strong> Plateau or flat-topped curve</p>
                    <p><strong>Cause:</strong> Ongoing exposure to contaminated source over extended period</p>
                    <p><strong>Example:</strong> Contaminated water supply (like John Snow's cholera investigation)</p>
                    <p><strong>Key Feature:</strong> Source remains active, causing cases over multiple incubation periods</p>`,
            propagated: `<h4 style="color: var(--color-primary);">Propagated Outbreak</h4>
                    <p><strong>Pattern:</strong> Multiple peaks of increasing height</p>
                    <p><strong>Cause:</strong> Person-to-person transmission</p>
                    <p><strong>Example:</strong> Measles, influenza, COVID-19</p>
                    <p><strong>Key Feature:</strong> Peaks represent successive generations, spaced ~1 incubation period apart</p>`,
            intermittent: `<h4 style="color: var(--color-primary);">Intermittent Common Source</h4>
                    <p><strong>Pattern:</strong> Irregular peaks separated by periods with no cases</p>
                    <p><strong>Cause:</strong> Common source that is not constant (e.g., occasional batch of bad food)</p>
                    <p><strong>Example:</strong> Industrial waste released into water only on weekends</p>
                    <p><strong>Key Feature:</strong> Unpredictable timing, gaps reflect times when source was safe</p>`
        };
        const descContainer = document.getElementById('epi-description');
        if (descContainer) {
            descContainer.innerHTML = descriptions[this.visualizerType];
        }
    }

    // --- Render Main Interface ---

    addBulkCases(text) {
        if (!text) return;
        // Split by newlines, commas, or semicolons
        const potentialDates = text.split(/[\n,;]+/);
        let addedCount = 0;

        potentialDates.forEach(dStr => {
            const raw = dStr.trim();
            if (!raw) return;
            // Attempt simple standardization (YYYY-MM-DD)
            const d = new Date(raw);
            if (!isNaN(d.getTime())) {
                this.cases.push(d.toISOString().split('T')[0]);
                addedCount++;
            }
        });

        if (addedCount > 0) {
            this.cases.sort();
            this.render();
            if (typeof window.UI !== 'undefined') window.UI.toast(`Added ${addedCount} cases.`, 'success');
            else alert(`Added ${addedCount} cases.`);
        } else {
            if (typeof window.UI !== 'undefined') window.UI.toast('No valid dates found. Use YYYY-MM-DD format.', 'error');
            else alert('No valid dates found. Use YYYY-MM-DD format.');
        }
    }

    // --- Render Main Interface ---

    render() {
        const isPlotter = this.mode === 'plotter';

        let contentHtml = '';

        if (isPlotter) {
            const { labels, data, max } = this.getHistogramData();
            const peak = Math.max(...data, 0);
            const totalCases = this.cases.length;

            let chartHtml = '';
            if (totalCases > 0) {
                chartHtml = `
                    <div class="epi-chart-container">
                        <div class="y-axis">
                            <span>${max}</span>
                            <span>${Math.round(max / 2)}</span>
                            <span>0</span>
                        </div>
                        <div class="chart-bars">
                            ${labels.map((date, i) => {
                    const count = data[i];
                    const height = (count / max) * 100;
                    const isPeak = count === peak && count > 0;
                    return `
                                    <div class="bar-group" title="${date}: ${count} cases">
                                        <div class="bar ${isPeak ? 'peak' : ''}" style="height: ${height}%">
                                            ${count > 0 ? `<span class="bar-label">${count}</span>` : ''}
                                        </div>
                                        <div class="x-label">${date.slice(5)}</div>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            } else {
                chartHtml = `<div class="empty-state"><p>No cases recorded. Add a case to generate the curve.</p></div>`;
            }

            contentHtml = `
                <div class="tool-controls" style="display: flex; flex-direction: column; gap: 1rem;">
                    
                    <div style="display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap;">
                        <div class="neo-card small" style="flex: 1; min-width: 250px;">
                            <label for="case-date-input" style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Single Case:</label>
                            <div class="input-group">
                                <input type="date" id="case-date-input" class="form-input">
                                <button class="btn btn-primary" onclick="epiCurve.addCase(document.getElementById('case-date-input').value)">Add</button>
                            </div>
                        </div>

                        <div class="neo-card small" style="flex: 1; min-width: 250px;">
                            <label for="bulk-cases-input" style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Bulk Entry:</label>
                            <textarea id="bulk-cases-input" class="form-input" rows="3" placeholder="Paste list of dates (YYYY-MM-DD)..."></textarea>
                            <button class="btn btn-secondary btn-sm" style="margin-top: 0.5rem; width: 100%;" onclick="epiCurve.addBulkCases(document.getElementById('bulk-cases-input').value)">
                                <i class="ph-bold ph-plus"></i> Add All
                            </button>
                        </div>
                    </div>

                    <div class="action-group" style="display: flex; flex-wrap: wrap; gap: 0.5rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                        <button class="btn btn-outline" onclick="epiCurve.loadExample()">Load Point Source</button>
                        <button class="btn btn-outline" onclick="epiCurve.loadIntermittent()">Load Intermittent</button>
                        <button class="btn btn-outline" onclick="epiCurve.loadPropagated()">Load Propagated</button>
                        <button class="btn btn-outline" onclick="epiCurve.downloadCSV()"><i class="ph-bold ph-download-simple"></i> CSV</button>
                        <button class="btn btn-danger" onclick="epiCurve.clear()">Clear All</button>
                    </div>
                </div>

                <div class="stats-panel">
                    <table class="table" style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                        <thead>
                            <tr style="background: var(--surface-2);">
                                <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">Total Cases</th>
                                <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">Peak Cases</th>
                                <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color);">Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; border: 1px solid var(--border-color);">${totalCases}</td>
                                <td style="padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; border: 1px solid var(--border-color); color: var(--accent-orange);">${peak}</td>
                                <td style="padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; border: 1px solid var(--border-color);">${labels.length || 0} days</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="chart-wrapper">
                    ${chartHtml}
                    <div style="text-align: center; margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); font-style: italic;">
                        See <strong>Chapter 6</strong> (Outbreaks) or <strong>Chapter 10</strong> (Study Design) for interpreting these curves.
                    </div>
                </div>

                <div class="case-list">
                    <h3>Case List</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="table" style="width: auto; min-width: 400px; border-collapse: collapse; margin-right: auto;">
                            <thead>
                                <tr style="background: var(--surface-2); text-align: left;">
                                    <th style="padding: 0.5rem;">#</th>
                                    <th style="padding: 0.5rem;">Date</th>
                                    <th style="padding: 0.5rem; text-align: left;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.cases.map((date, i) => `
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 0.5rem;">${i + 1}</td>
                                        <td style="padding: 0.5rem;">${date}</td>
                                        <td style="padding: 0.5rem; text-align: left;">
                                            <button class="btn btn-sm btn-danger" onclick="epiCurve.removeCase(${i})" title="Remove case">
                                                <i class="ph ph-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Summary table and explanation for example datasets -->
                <div class="epi-curve-summary">
                    <h3>Example Data Table</h3>
                    <div id="epi-curve-table-container"></div>
                </div>
                <div class="epi-curve-explanation" style="margin-top: 1rem;">
                    <div id="epi-curve-explanation"></div>
                </div>
            `;
        } else {
            // Visualizer Mode
            contentHtml = `
                <div class="tool-controls">
                    <div class="input-group">
                        <label for="outbreak-type">Outbreak Type:</label>
                        <select id="outbreak-type" class="form-select" onchange="epiCurve.setVisualizerType(this.value)">
                            <option value="point" ${this.visualizerType === 'point' ? 'selected' : ''}>Point Source</option>
                            <option value="continuous" ${this.visualizerType === 'continuous' ? 'selected' : ''}>Continuous Common Source</option>
                            <option value="intermittent" ${this.visualizerType === 'intermittent' ? 'selected' : ''}>Intermittent Common Source</option>
                            <option value="propagated" ${this.visualizerType === 'propagated' ? 'selected' : ''}>Propagated</option>
                        </select>
                    </div>
                </div>

                <div class="chart-wrapper" style="text-align: center;">
                    <canvas id="epiCanvas" width="600" height="300" style="max-width: 100%; border: 1px solid var(--border-color); border-radius: 8px; background: var(--surface-color);"></canvas>
                </div>

                <div id="epi-description" class="callout" style="margin-top: 1rem;">
                    <!-- Description injected here -->
                </div>
            `;
        }

        const html = `
            <div class="tool-header">
                <h2><i class="ph ph-chart-bar"></i> Epi Curve Generator</h2>
                <div class="mode-switch" style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn ${isPlotter ? 'btn-primary' : 'btn-outline'}" onclick="epiCurve.setMode('plotter')">Data Plotter</button>
                    <button class="btn ${!isPlotter ? 'btn-primary' : 'btn-outline'}" onclick="epiCurve.setMode('visualizer')">Pattern Visualizer</button>
                </div>
            </div>
            ${contentHtml}
        `;

        this.container.innerHTML = html;

        if (!isPlotter) {
            this.updateVisualizerDescription();
            // Need to wait for DOM update to draw on canvas
            setTimeout(() => this.drawVisualizer(), 0);
        } else {
            // In plotter mode, update summary table and explanation if cases exist
            if (this.cases && this.cases.length > 0) {
                const summary = this.summarizeByDate(this.cases);
                this.renderSummaryTable(summary);
                // this.renderExplanation(summary); // REMOVED: Caused "undefined" title bug. Explanations are only for loaded examples.
            } else {
                // Clear summary and explanation if no cases
                const t = document.getElementById('epi-curve-table-container');
                const e = document.getElementById('epi-curve-explanation');
                if (t) t.innerHTML = '';
                if (e) e.innerHTML = '';
            }
        }
    }

    downloadCSV() {
        if (!this.cases || this.cases.length === 0) {
            if (typeof window.UI !== 'undefined') window.UI.toast('No data to export', 'error');
            else alert('No data to export');
            return;
        }
        const summary = this.summarizeByDate(this.cases);
        let csv = 'Date,Count\n';
        summary.forEach(row => {
            csv += `${row.date},${row.count}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'epi_curve_data.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
}
// Global instance
let epiCurve = null;

class ExposureCalculator {
    constructor(containerId) {
        this.containerId = containerId;
        this.scale = 24; // Default zoom scale (hours +/- around window)
        this.currentWindow = null;
        this.render();
    }

    // Render the input form and placeholder containers for graph and examples
    render() {
        const container = document.getElementById(this.containerId);
        if (!container) return;
        container.innerHTML = `
            <div class="exposure-tool">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="field-label" for="exposure-onset">Symptom onset (local time)</label>
                        <input type="datetime-local" id="exposure-onset" class="field-input" />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="field-label" for="exposure-min">Min incubation (hours)</label>
                            <input type="number" id="exposure-min" class="field-input" min="0" />
                        </div>
                        <div>
                            <label class="field-label" for="exposure-max">Max incubation (hours)</label>
                            <input type="number" id="exposure-max" class="field-input" min="0" />
                        </div>
                    </div>
                </div>
                <div class="mt-3 flex gap-2 flex-wrap">
                    <button class="btn btn-primary" id="exposure-calc-btn">Calculate window</button>
                    <button class="btn btn-secondary" id="exposure-step-btn" onclick="exposureCalc.toggleSteps()">Show Math</button>
                    <button class="btn btn-outline" onclick="exposureCalc.loadExample()">Load Example</button>
                    <button class="btn btn-secondary" id="exposure-clear-btn">Clear</button>
                </div>
                
                <div id="exposure-steps" class="neo-card small" style="display: none; background: #f8fafc; border: 1px dashed var(--navy-primary); margin-top: 1rem;">
                    <h4 style="margin-top: 0; color: var(--navy-primary);">Step-by-Step Breakdown</h4>
                    <div id="exposure-steps-content" style="font-family: monospace; font-size: 0.95rem;"></div>
                </div>

                <div class="mt-3 callout-info" id="exposure-result" aria-live="polite" style="border-left: 4px solid var(--accent-color); padding: 1rem; background: var(--surface-2);"></div>

                <div class="mt-4">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="tool-subheading" style="margin: 0;">Visual timeline</h3>
                        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem;">
                            <label>Zoom:</label>
                            <input type="range" min="6" max="168" value="24" id="exposure-zoom" oninput="exposureCalc.updateScale(this.value)">
                        </div>
                    </div>
                    <div id="exposure-graph" class="exposure-graph"></div>
                </div>
                <div class="mt-4">
                    <h3 class="tool-subheading">Practice scenarios</h3>
                    <div id="exposure-examples" class="exposure-examples"></div>
                </div>
            </div>
        `;
        // Attach event listeners
        const calcBtn = document.getElementById('exposure-calc-btn');
        const clearBtn = document.getElementById('exposure-clear-btn');
        if (calcBtn) calcBtn.addEventListener('click', () => this.calculate());
        if (clearBtn) clearBtn.addEventListener('click', () => this.clear());
        this.renderExamples();
    }

    // Format dates for display
    format(dt) {
        return dt.toLocaleString(undefined, {
            year: 'numeric', month: 'short', day: 'numeric',
            hour: 'numeric', minute: '2-digit'
        });
    }

    toggleSteps() {
        const steps = document.getElementById('exposure-steps');
        const btn = document.getElementById('exposure-step-btn');
        if (steps.style.display === 'none') {
            steps.style.display = 'block';
            btn.textContent = 'Hide Math';
        } else {
            steps.style.display = 'none';
            btn.textContent = 'Show Math';
        }
    }

    updateScale(val) {
        this.scale = Number(val);
        if (this.currentWindow) {
            this.renderGraph(this.currentWindow);
        }
    }

    // Perform the calculation and show result and graph
    calculate() {
        const onsetInput = document.getElementById('exposure-onset');
        const minInput = document.getElementById('exposure-min');
        const maxInput = document.getElementById('exposure-max');
        const resultBox = document.getElementById('exposure-result');
        if (!onsetInput || !minInput || !maxInput || !resultBox) return;
        const onsetStr = onsetInput.value;
        const minH = Number(minInput.value);
        const maxH = Number(maxInput.value);
        if (!onsetStr || isNaN(minH) || isNaN(maxH) || minH < 0 || maxH <= 0 || maxH < minH) {
            resultBox.innerHTML = `<p>Please enter a valid onset date/time and a valid incubation range (max â‰¥ min).</p>`;
            this.renderGraph(null);
            this.currentWindow = null;
            return;
        }
        const onset = new Date(onsetStr);
        const earliest = new Date(onset.getTime() - maxH * 3600 * 1000);
        const latest = new Date(onset.getTime() - minH * 3600 * 1000);
        this.currentWindow = { onset, earliest, latest, minH, maxH };

        resultBox.innerHTML = `
            <p><strong>Likely exposure window:</strong></p>
            <ul>
                <li>Earliest plausible exposure: <strong>${this.format(earliest)}</strong></li>
                <li>Latest plausible exposure: <strong>${this.format(latest)}</strong></li>
            </ul>
            <div class="study-tip" style="margin-top: 1rem; border-left: 4px solid var(--accent-orange); padding-left: 1rem;">
                <p class="text-sm font-bold">Exam Strategy:</p>
                <ul class="text-sm text-muted">
                    <li><strong>Individual cases:</strong> The exposure must be within the window (Earliest to Latest).</li>
                    <li><strong>Multiple cases:</strong> Look for the <strong>overlap</strong> of windows.</li>
                    <li><strong>Point Source:</strong> Count back one incubation period from the <strong>peak</strong> cases for the most probable exposure.</li>
                    <li><strong>Given Range (A-B days):</strong> Count back A days from the <em>first</em> case (start of window) and B days from the <em>last</em> case (end of window).</li>
                </ul>
            </div>
        `;

        // Populate Steps
        const stepsContainer = document.getElementById('exposure-steps-content');
        if (stepsContainer) {
            stepsContainer.innerHTML = `
                <div style="margin-bottom: 0.5rem;"><strong>Formula:</strong> Exposure = Onset Time - Incubation Period</div>
                <div style="margin-bottom: 0.5rem;"><strong>1. Earliest Exposure (using Max Incubation):</strong><br>
                ${this.format(onset)} - ${maxH} hours = <strong>${this.format(earliest)}</strong></div>
                <div><strong>2. Latest Exposure (using Min Incubation):</strong><br>
                ${this.format(onset)} - ${minH} hours = <strong>${this.format(latest)}</strong></div>
            `;
        }

        this.renderGraph(this.currentWindow);
    }

    // Clear inputs and outputs
    clear() {
        const onsetInput = document.getElementById('exposure-onset');
        const minInput = document.getElementById('exposure-min');
        const maxInput = document.getElementById('exposure-max');
        const resultBox = document.getElementById('exposure-result');
        const stepsContainer = document.getElementById('exposure-steps-content');

        if (onsetInput) onsetInput.value = '';
        if (minInput) minInput.value = '';
        if (maxInput) maxInput.value = '';
        if (resultBox) resultBox.innerHTML = '';
        if (stepsContainer) stepsContainer.innerHTML = '';
        this.currentWindow = null;

        this.renderGraph(null);
    }

    // Render timeline graph or placeholder
    renderGraph(windowObj) {
        const graph = document.getElementById('exposure-graph');
        if (!graph) return;

        if (!windowObj) {
            graph.innerHTML = `<p class="text-muted text-center" style="padding: 2rem;">Enter onset and incubation range above, or select an example.<br><span style="font-size: 2rem; opacity: 0.3;">â³</span></p>`;
            return;
        }

        const { onset, earliest, latest, minH, maxH } = windowObj;

        // Viewport Logic
        // We want to see [Earliest Exposure - Padding] to [Onset + Padding]
        const padHours = Math.max(24, Math.abs(maxH) * 0.5); // Dynamic padding
        const viewStart = new Date(earliest.getTime() - padHours * 3600 * 1000);
        const viewEnd = new Date(onset.getTime() + (padHours / 2) * 3600 * 1000);
        const totalMs = viewEnd.getTime() - viewStart.getTime();

        const getPercent = (dt) => {
            let pct = ((dt.getTime() - viewStart.getTime()) / totalMs) * 100;
            return Math.max(0, Math.min(100, pct));
        };

        const winStartPct = getPercent(earliest);
        const winEndPct = getPercent(latest);
        const winWidth = Math.max(0.5, winEndPct - winStartPct);
        const onsetPct = getPercent(onset);

        // Render Interactive Graph
        graph.innerHTML = `
            <div class="exposure-vis-container" style="position: relative; height: 140px; background: white; border: 2px solid var(--border-color); border-radius: 8px; overflow: hidden; user-select: none;">
                
                <!-- Grid Lines (Every 12h or 24h) -->
                <div class="vis-grid" style="position: absolute; width: 100%; height: 100%; display: flex; justify-content: space-between; opacity: 0.5;">
                    ${this.renderGridLines(viewStart, viewEnd)}
                </div>

                <!-- Main Timeline Track -->
                <div style="position: absolute; top: 60px; left: 2%; right: 2%; height: 6px; background: var(--border-color); border-radius: 3px;"></div>

                <!-- Exposure Window Zone (The "Answer") -->
                <div class="exp-window-zone" style="position: absolute; top: 40px; height: 44px; left: ${winStartPct}%; width: ${winWidth}%; 
                     background: rgba(255, 171, 112, 0.3); border: 4px solid var(--accent-orange); border-radius: 6px; 
                     display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    <div style="font-size: 0.8rem; font-weight: 900; color: var(--navy-primary); background: white; padding: 2px 8px; border-radius: 4px; border: 2px solid var(--accent-orange); white-space: nowrap; text-transform: uppercase;">
                        Exposure Window
                    </div>
                    
                    <!-- Min Incubation Handle (Right side of window, closer to onset) -->
                    <div class="drag-handle min-handle" title="Min Incubation: ${minH}h" style="position: absolute; right: -8px; top: -2px; bottom: -2px; width: 16px; cursor: ew-resize; display: flex; align-items: center; justify-content: center;">
                        <div style="width: 6px; height: 24px; background: var(--accent-orange); border-radius: 3px; border: 1px solid white;"></div>
                    </div>

                    <!-- Max Incubation Handle (Left side of window, further from onset) -->
                    <div class="drag-handle max-handle" title="Max Incubation: ${maxH}h" style="position: absolute; left: -8px; top: -2px; bottom: -2px; width: 16px; cursor: ew-resize; display: flex; align-items: center; justify-content: center;">
                         <div style="width: 6px; height: 24px; background: var(--accent-orange); border-radius: 3px; border: 1px solid white;"></div>
                    </div>
                </div>

                <!-- Onset Marker (Fixed Anchor) -->
                <div class="onset-marker" style="position: absolute; top: 25px; bottom: 25px; left: ${onsetPct}%; width: 4px; background: var(--navy-primary); z-index: 10;">
                    <div style="position: absolute; top: -25px; left: -50px; width: 100px; text-align: center; background: var(--navy-primary); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 4px; font-weight: bold;">
                        Symptom Onset<br>
                        ${this.formatShort(onset)}
                    </div>
                    <div style="position: absolute; bottom: 0; left: -6px; width: 16px; height: 16px; background: var(--navy-primary); border-radius: 50%;"></div>
                </div>

                <!-- Labels for Window Ends -->
                <div style="position: absolute; top: 90px; left: ${winStartPct}%; transform: translateX(-50%); text-align: center; font-size: 0.7rem; color: var(--text-muted);">
                    Earliest<br>${this.formatShort(earliest)}
                </div>
                <div style="position: absolute; top: 90px; left: ${winEndPct}%; transform: translateX(-50%); text-align: center; font-size: 0.7rem; color: var(--text-muted);">
                    Latest<br>${this.formatShort(latest)}
                </div>

            </div>
            <div style="margin-top: 0.5rem; text-align: center; font-size: 0.8rem; color: var(--text-muted); font-style: italic;">
                Drag the handles to adjust the Incubation Period.
            </div> 
        `;

        // Attach interactive listeners
        this.attachGraphListeners(graph, windowObj, viewStart, totalMs);
    }

    attachGraphListeners(container, windowObj, viewStart, totalMs) {
        const minHandle = container.querySelector('.min-handle');
        const maxHandle = container.querySelector('.max-handle');
        const width = container.querySelector('.exposure-vis-container').offsetWidth;

        // Calc conversion factor: Pixels -> Hours
        // totalMs maps to width (px)
        // 1 px = (totalMs / width) ms
        const pxToHours = (px) => {
            const ms = px * (totalMs / width);
            return ms / (3600 * 1000);
        };

        const setupDrag = (element, isMin) => {
            element.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const startX = e.clientX;
                const startVal = isMin ? windowObj.minH : windowObj.maxH;

                const onMove = (moveEvent) => {
                    const deltaPx = moveEvent.clientX - startX;
                    const deltaH = pxToHours(deltaPx); // Positive delta means moving Right (towards onset)

                    // Logic:
                    // Timeline goes Left (Past) <--------- [Max] --- [Min] ---> Right (Onset, Future)
                    // Earliest exposure is at "Onset - Max". Latest is "Onset - Min".
                    // The Graph X-axis is Time. Left is earlier.
                    // Moving Right (Positive px) means Time increases (Later date).
                    // "Min Handle" is at "Onset - Min". If it moves Right (Later), "Onset - Min" increases -> Min decreases.
                    // "Max Handle" is at "Onset - Max". If it moves Right (Later), "Onset - Max" increases -> Max decreases.
                    // So for both handles: Moving Right (Positive Delta) DECREASES the incubation hours.

                    let newVal = startVal - deltaH;

                    // Constraints
                    if (newVal < 0) newVal = 0;
                    if (isMin) {
                        // Min cannot exceed Max
                        if (newVal > windowObj.maxH) newVal = windowObj.maxH;
                    } else {
                        // Max cannot be less than Min
                        if (newVal < windowObj.minH) newVal = windowObj.minH;
                    }

                    // Update Input
                    const inputId = isMin ? 'exposure-min' : 'exposure-max';
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = Math.round(newVal); // Snap to integer hours for stability
                        // input.value = newVal.toFixed(1); // Or allow decimals
                    }
                };

                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    this.calculate(); // Re-calc and re-render on drop
                };

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
        };

        if (minHandle) setupDrag(minHandle, true);
        if (maxHandle) setupDrag(maxHandle, false);
    }

    renderGridLines(start, end) {
        let html = '';
        let current = new Date(start);
        current.setMinutes(0, 0, 0); // Snap to hour
        const totalMs = end.getTime() - start.getTime();

        // Determine interval based on span
        const spanHours = (end - start) / 3600000;
        let intervalHours = 6;
        if (spanHours > 48) intervalHours = 12;
        if (spanHours > 100) intervalHours = 24;

        while (current < end) {
            if (current > start) {
                const pct = ((current - start) / totalMs) * 100;
                const isDayStart = current.getHours() === 0;
                const label = isDayStart
                    ? current.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })
                    : current.getHours() + ':00';

                html += `
                    <div style="position: absolute; left: ${pct}%; top: 0; bottom: 0; width: 1px; background: ${isDayStart ? '#cbd5e1' : '#f1f5f9'};">
                        <div style="position: absolute; bottom: 2px; left: 4px; font-size: 0.65rem; color: #94a3b8;">${label}</div>
                    </div>
                `;
            }
            current = new Date(current.getTime() + intervalHours * 3600 * 1000);
        }
        return html;
    }

    formatShort(dt) {
        return dt.toLocaleString(undefined, {
            month: 'numeric', day: 'numeric',
            hour: 'numeric', minute: '2-digit'
        });
    }

    // Render example scenarios
    renderExamples() {
        const container = document.getElementById('exposure-examples');
        if (!container) return;
        const examples = [
            {
                id: 'noro',
                title: 'Norovirus (12â€“48h)',
                onsetOffsetH: 0,
                min: 12,
                max: 48,
                note: 'Classic short incubation, often from a single meal.'
            },
            {
                id: 'salmonella',
                title: 'Salmonella (6â€“72h)',
                onsetOffsetH: -24,
                min: 6,
                max: 72,
                note: 'Wider window; exams often pick the middle.'
            },
            {
                id: 'ecoli',
                title: 'E. coli (3â€“4 days)',
                onsetOffsetH: -48,
                min: 72,
                max: 96,
                note: 'Common bacterial outbreak. Incubation is days, not hours.'
            },
            {
                id: 'hepA',
                title: 'Hepatitis A (15â€“50 days)',
                onsetOffsetH: -7 * 24,
                min: 15 * 24,
                max: 50 * 24,
                note: 'Very long incubation; you must look weeks back.'
            }
        ];
        container.innerHTML = examples.map(ex => {
            return `
                <div class="example-card" data-id="${ex.id}" style="cursor:pointer; border: 1px solid var(--border-color); padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; background: #fff;">
                    <div class="font-semibold" style="color: var(--navy-primary);">${ex.title}</div>
                    <div class="text-sm text-muted">${ex.note}</div>
                </div>
            `;
        }).join('');
        container.querySelectorAll('.example-card').forEach(card => {
            card.addEventListener('click', () => {
                const id = card.getAttribute('data-id');
                const ex = examples.find(e => e.id === id);
                if (!ex) return;
                const now = new Date();
                now.setHours(now.getHours() + ex.onsetOffsetH);
                const iso = now.toISOString(); // UTC
                // Simple local iso trick
                const local = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().substring(0, 16);
                document.getElementById('exposure-onset').value = local;
                document.getElementById('exposure-min').value = ex.min;
                document.getElementById('exposure-max').value = ex.max;
                this.calculate();
            });
        });
    }

    // Load a default example
    loadExample() {
        const noroCard = this.containerId ? document.querySelector(`#${this.containerId} .example-card[data-id="noro"]`) : document.querySelector('.example-card[data-id="noro"]');
        if (noroCard) {
            noroCard.click();
        } else {
            // Fallback
            const now = new Date();
            const local = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().substring(0, 16);
            document.getElementById('exposure-onset').value = local;
            document.getElementById('exposure-min').value = 12;
            document.getElementById('exposure-max').value = 48;
            this.calculate();
        }
    }
}


// Global variable for Tools Manager to instantiate
let exposureCalc = null;
const NotesheetGenerator = {
    render: function (containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const html = `
            <div class="notesheet-preview neo-card" style="padding: 1.5rem; background: white; color: black; font-family: 'Arial', sans-serif; font-size: 11px; line-height: 1.4;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 3px double black; padding-bottom: 0.5rem;">
                    <div>
                        <h1 style="margin: 0; font-size: 1.3rem; font-weight: 800;">DISEASE DETECTIVES REFERENCE SHEET</h1>
                        <div style="font-size: 0.8rem; color: #555;">Science Olympiad â€¢ Division B/C</div>
                    </div>
                    <div class="no-print">
                        <button onclick="window.print()" class="neo-btn small primary">
                            <i class="ph-bold ph-printer"></i> Print Notesheet
                        </button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;">
                    
                    <!-- COLUMN 1 -->
                    <div>
                        <div style="border: 1px solid #333; padding: 0.5rem; margin-bottom: 0.5rem; background: #f9f9f9;">
                            <strong style="display: block; background: #333; color: white; margin: -0.5rem -0.5rem 0.5rem -0.5rem; padding: 0.25rem 0.5rem;">ðŸ“ CORE FORMULAS</strong>
                            <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
                                <tr><td style="padding: 2px;"><b>Attack Rate</b></td><td>= Cases Ã· Population at Risk</td></tr>
                                <tr style="background:#eee;"><td style="padding: 2px;"><b>Relative Risk</b></td><td>= AR<sub>exposed</sub> Ã· AR<sub>unexposed</sub></td></tr>
                                <tr><td style="padding: 2px;"><b>Odds Ratio</b></td><td>= (a Ã— d) Ã· (b Ã— c)</td></tr>
                                <tr style="background:#eee;"><td style="padding: 2px;"><b>Attributable Risk</b></td><td>= AR<sub>exp</sub> âˆ’ AR<sub>unexp</sub></td></tr>
                                <tr><td style="padding: 2px;"><b>Sensitivity</b></td><td>= TP Ã· (TP + FN) = "Rule Out"</td></tr>
                                <tr style="background:#eee;"><td style="padding: 2px;"><b>Specificity</b></td><td>= TN Ã· (TN + FP) = "Rule In"</td></tr>
                                <tr><td style="padding: 2px;"><b>PPV</b></td><td>= TP Ã· (TP + FP)</td></tr>
                                <tr style="background:#eee;"><td style="padding: 2px;"><b>NPV</b></td><td>= TN Ã· (TN + FN)</td></tr>
                                <tr><td style="padding: 2px;"><b>Vaccine Eff.</b></td><td>= (AR<sub>u</sub> âˆ’ AR<sub>v</sub>) Ã· AR<sub>u</sub></td></tr>
                            </table>
                        </div>
                        
                        <div style="border: 1px solid #333; padding: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="display: block; background: #333; color: white; margin: -0.5rem -0.5rem 0.5rem -0.5rem; padding: 0.25rem 0.5rem;">ðŸ“Š 2Ã—2 TABLE</strong>
                            <table style="width: 100%; text-align: center; font-size: 9px; border-collapse: collapse; border: 1px solid #666;">
                                <tr style="background: #ddd;"><td></td><td style="border: 1px solid #666;"><b>Disease+</b></td><td style="border: 1px solid #666;"><b>Diseaseâˆ’</b></td><td></td></tr>
                                <tr><td style="border: 1px solid #666;"><b>Exposed</b></td><td style="border: 1px solid #666; background:#ffe;">a</td><td style="border: 1px solid #666;">b</td><td style="border: 1px solid #666;">a+b</td></tr>
                                <tr><td style="border: 1px solid #666;"><b>Unexposed</b></td><td style="border: 1px solid #666;">c</td><td style="border: 1px solid #666; background:#efe;">d</td><td style="border: 1px solid #666;">c+d</td></tr>
                            </table>
                            <div style="font-size: 9px; margin-top: 0.25rem;"><b>OR</b> = ad/bc | <b>RR</b> = [a/(a+b)] / [c/(c+d)]</div>
                        </div>

                        <div style="border: 1px solid #333; padding: 0.5rem;">
                            <strong style="display: block; background: #333; color: white; margin: -0.5rem -0.5rem 0.5rem -0.5rem; padding: 0.25rem 0.5rem;">ðŸ“ˆ EPI CURVES</strong>
                            <ul style="margin: 0; padding-left: 1rem;">
                                <li><b>Point Source:</b> Sharp rise, single peak (potluck)</li>
                                <li><b>Continuous:</b> Plateau shape (contaminated water)</li>
                                <li><b>Propagated:</b> Multiple peaks/waves (person-to-person)</li>
                                <li><b>Intermittent:</b> Irregular peaks (sporadic exposure)</li>
                            </ul>
                            <div style="background:#eee; padding: 2px 4px; margin-top: 4px; font-size: 9px;">
                                <b>Bin Width</b> = Â¼ to â…“ of incubation period
                            </div>
                        </div>
                    </div>
                    
                    <!-- COLUMN 2 -->
                    <div>
                        <div style="border: 1px solid #333; padding: 0.5rem; margin-bottom: 0.5rem; background: #f9f9f9;">
                            <strong style="display: block; background: #333; color: white; margin: -0.5rem -0.5rem 0.5rem -0.5rem; padding: 0.25rem 0.5rem;">ðŸ”Ÿ OUTBREAK INVESTIGATION</strong>
                            <ol style="margin: 0; padding-left: 1.2rem; font-size: 10px;">
                                <li><b>Prepare</b> for field work</li>
                                <li><b>Establish</b> existence of outbreak</li>
                                <li><b>Verify</b> diagnosis</li>
                                <li><b>Define</b> case (Person, Place, Time)</li>
                                <li><b>Find</b> cases systematically</li>
                                <li><b>Describe</b> (Time, Place, Person)</li>
                                <li><b>Develop</b> hypotheses</li>
                                <li><b>Evaluate</b> hypotheses (Analytic study)</li>
                                <li><b>Implement</b> control measures</li>
                                <li><b>Communicate</b> findings</li>
                            </ol>
                        </div>
                        
                        <div style="border: 1px solid #333; padding: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="display: block; background: #333; color: white; margin: -0.5rem -0.5rem 0.5rem -0.5rem; padding: 0.25rem 0.5rem;">âš ï¸ BIAS & CONFOUNDING</strong>
                            <div style="font-size: 10px;">
                                <div style="margin-bottom: 4px;"><b>Selection Bias:</b> Berkson's (Hospital), Healthy Worker</div>
                                <div style="margin-bottom: 4px;"><b>Information Bias:</b> Recall, Interviewer, Misclassification</div>
                                <div style="margin-bottom: 4px;"><b>Confounding:</b> Associated with E and D, NOT on causal path</div>
                                <div style="background:#fff3cd; padding: 2px 4px;"><b>Fix:</b> Stratify, Match, Restrict, Adjust (MH OR)</div>
                            </div>
                        </div>

                        <div style="border: 1px solid #333; padding: 0.5rem;">
                            <strong style="display: block; background: #333; color: white; margin: -0.5rem -0.5rem 0.5rem -0.5rem; padding: 0.25rem 0.5rem;">ðŸ§  MNEMONICS</strong>
                            <ul style="margin: 0; padding-left: 1rem; font-size: 10px;">
                                <li><b>SNOUT:</b> SeNsitive test rules OUT disease</li>
                                <li><b>SPIN:</b> SPecific test rules IN disease</li>
                                <li><b>HILL:</b> Strength, Consistency, Specificity, Temporality, Dose-Response, Plausibility, Coherence, Experiment, Analogy</li>
                                <li><b>Chain:</b> Agent â†’ Reservoir â†’ Portal Exit â†’ Mode â†’ Portal Entry â†’ Host</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- COLUMN 3 -->
                    <div>
                        <div style="border: 1px solid #333; padding: 0.5rem; margin-bottom: 0.5rem; background: #f0fff0;">
                            <strong style="display: block; background: #228b22; color: white; margin: -0.5rem -0.5rem 0.5rem -0.5rem; padding: 0.25rem 0.5rem;">ðŸ¦  HIGH-YIELD DISEASES</strong>
                            <table style="width: 100%; font-size: 9px; border-collapse: collapse;">
                                <tr style="background:#ddd;"><th style="text-align:left; padding:2px;">Disease</th><th style="text-align:left; padding:2px;">Incubation</th><th style="text-align:left; padding:2px;">Key Clue</th></tr>
                                <tr><td>Norovirus</td><td>12-48h</td><td>Vomit, Chlorine resistant</td></tr>
                                <tr style="background:#eee;"><td>Staph</td><td>2-4h</td><td>Preformed toxin, fast</td></tr>
                                <tr><td>Salmonella</td><td>12-72h</td><td>Poultry, Eggs, Reptiles</td></tr>
                                <tr style="background:#eee;"><td>E.coli O157</td><td>3-4d</td><td>HUS, NO antibiotics</td></tr>
                                <tr><td>Legionella</td><td>2-10d</td><td>Water aerosols, No P2P</td></tr>
                                <tr style="background:#eee;"><td>Lyme</td><td>3-30d</td><td>Bullseye, Tick &lt;24h safe</td></tr>
                                <tr><td>Measles</td><td>10-12d</td><td>Airborne 2h, Koplik spots</td></tr>
                                <tr style="background:#eee;"><td>Hantavirus</td><td>1-5wk</td><td>Rodent dust, Southwest</td></tr>
                            </table>
                        </div>
                        
                        <div style="border: 1px solid #333; padding: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="display: block; background: #333; color: white; margin: -0.5rem -0.5rem 0.5rem -0.5rem; padding: 0.25rem 0.5rem;">ðŸ”¬ STUDY TYPES</strong>
                            <ul style="margin: 0; padding-left: 1rem; font-size: 10px;">
                                <li><b>Cohort:</b> Follow exposed/unexposed â†’ Calculate RR</li>
                                <li><b>Case-Control:</b> Compare cases/controls â†’ Calculate OR</li>
                                <li><b>Cross-Sectional:</b> Snapshot â†’ Prevalence</li>
                                <li><b>Ecologic:</b> Group-level data â†’ Correlation</li>
                                <li><b>RCT:</b> Gold standard, Randomized</li>
                            </ul>
                        </div>

                        <div style="border: 1px solid #333; padding: 0.5rem; background: #fff0f0;">
                            <strong style="display: block; background: #c00; color: white; margin: -0.5rem -0.5rem 0.5rem -0.5rem; padding: 0.25rem 0.5rem;">ðŸš¨ EXAM TRAPS</strong>
                            <ul style="margin: 0; padding-left: 1rem; font-size: 10px;">
                                <li>Crypto is CHLORINE RESISTANT</li>
                                <li>Antibiotics WORSEN E.coli O157 (HUS)</li>
                                <li>Legionella is NOT person-to-person</li>
                                <li>Staph = INTOXICATION (not infection)</li>
                                <li>RR needs INCIDENCE (Cohort only)</li>
                                <li>Confounding â‰  Effect Modification</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="custom-notes-section" style="margin-top: 0.75rem; border-top: 2px solid #333; padding-top: 0.5rem; page-break-inside: avoid;">
                    <strong style="display: block; font-size: 11px; margin-bottom: 0.25rem;">ðŸ“ MY FIELD NOTES</strong>
                    <textarea id="notesheet-memo" 
                        placeholder="Type here... Content saves automatically to this device."
                        style="width: 100%; height: 1.5in; font-family: 'Inter', sans-serif; font-size: 10px; border: 1px dashed #999; padding: 0.25rem; resize: vertical; background: #fffdf0;"
                    ></textarea>
                </div>

                <div style="margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid #999; font-size: 9px; color: #666; display: flex; justify-content: space-between;">
                    <span>Generated by Epidemic Engine v2.3</span>
                    <span>Print: Ctrl+P | Landscape recommended</span>
                </div>
            </div>
            
            <style>
                @media print {
                    body * { visibility: hidden; }
                    .notesheet-preview, .notesheet-preview * { visibility: visible; }
                    .notesheet-preview {
                        position: absolute; left: 0; top: 0; width: 100%;
                        margin: 0; padding: 0.5in; border: none; box-shadow: none;
                        font-size: 10px !important;
                    }
                    .no-print { display: none !important; }
                    /* Make textarea look like static text */
                    #notesheet-memo {
                        border: 1px solid #ccc !important;
                        resize: none !important;
                        overflow: visible !important;
                        height: auto !important;
                        color: black !important;
                    }
                    @page { size: landscape; margin: 0.25in; }
                }
            </style>
        `;

        container.innerHTML = html;

        // Restore saved notes
        const ta = document.getElementById('notesheet-memo');
        const saved = localStorage.getItem('epi_notesheet_memo');
        if (saved) ta.value = saved;

        // Auto-save
        ta.addEventListener('input', () => {
            localStorage.setItem('epi_notesheet_memo', ta.value);
        });
    }
};

/**
 * Quiz Engine Core - Unified Assessment System
 * Replaces ExamEngine and ComprehensiveQuiz with a single flexible architecture.
 * Supports: 'practice' (chapter quizzes) and 'simulation' (timed exams) modes.
 */

class QuizEngine {
    constructor(config) {
        // Configuration
        this.mode = config.mode || 'practice'; // 'practice' | 'simulation'
        this.quizId = config.quizId || 'unknown-quiz'; // Analytics ID
        this.containerId = config.containerId || 'quiz-container';
        this.questions = config.questions || [];
        this.timeLimit = config.timeLimit || (this.mode === 'simulation' ? 50 * 60 : null); // Seconds
        this.onComplete = config.onComplete || null;
        this.enableInstantFeedback = config.enableInstantFeedback || false;

        // State
        this.currentIndex = 0;
        this.answers = {}; // Map { index: optionIndex }
        this.flagged = new Set();
        this.startTime = null;
        this.endTime = null;
        this.timerInterval = null;
        this.isComplete = false;
        this.warningDisplayed = false; // For 5 min warning

        // Exam specific
        this.sectionBoundaries = config.sectionBoundaries || []; // [{index: 0, label: 'Part A'}]
        this.returnChapter = config.returnChapter || null;
    }

    /* ================= INITIALIZATION ================= */

    start() {
        const saved = this.loadLocalProgress();

        let shouldPauseImmediately = false;

        if (saved) {
            // Auto-resume logic
            this.currentIndex = saved.currentIndex || 0;
            this.answers = saved.answers || {};
            // Rehydrate Set
            this.flagged = saved.flagged ? new Set(saved.flagged) : new Set();

            // Restore time state
            this.startTime = Date.now() - (saved.elapsedTime || 0);
            this.isComplete = false;
            shouldPauseImmediately = true;
        } else {
            this.startTime = Date.now();
            this.currentIndex = 0;
            this.answers = {};
            this.flagged = new Set();
            this.isComplete = false;
        }

        // Setup UI
        this.renderFrame();
        this.renderQuestion();

        if (shouldPauseImmediately) {
            this.pauseQuiz();
        } else {
            // Start Timer if needed
            if (this.timeLimit) {
                this.startTimer();
            }
        }

        // Keyboard bindings
        this.handleKeyBound = this.handleKey.bind(this);
        document.addEventListener('keydown', this.handleKeyBound);
    }

    handleKey(e) {
        if (this.isComplete) return;
        // Arrow navigation
        if (e.key === 'ArrowRight') this.nextQuestion();
        if (e.key === 'ArrowLeft') this.previousQuestion();
    }

    /* ================= TIMER LOGIC ================= */

    startTimer() {
        if (this.timerInterval) clearInterval(this.timerInterval);

        const timerCallback = () => {
            const now = Date.now();
            const elapsed = Math.floor((now - this.startTime) / 1000);
            const remaining = this.timeLimit - elapsed;

            if (remaining <= 0) {
                this.submit(true); // Force submit
            } else {
                this.updateTimerDisplay(remaining);

                // 5 Minute Warning (Simulation only)
                if (this.mode === 'simulation' && remaining <= 300 && !this.warningDisplayed) {
                    this.showTimeWarning();
                    this.warningDisplayed = true;
                }
            }
        };

        this.timerInterval = setInterval(timerCallback, 1000);
        timerCallback(); // Immediate update
    }

    updateTimerDisplay(seconds) {
        const el = document.getElementById('quiz-timer');
        if (!el) return;

        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        el.textContent = `${m}:${s.toString().padStart(2, '0')}`;

        // Color coding
        if (seconds < 300) el.style.color = 'var(--danger)';
        else if (seconds < 600) el.style.color = 'var(--warning)';
        else el.style.color = '';
    }

    showTimeWarning() {
        if (document.getElementById('five-minute-warning')) return;
        const banner = document.createElement('div');
        banner.id = 'five-minute-warning';
        Object.assign(banner.style, {
            position: 'fixed', top: '0', left: '0', right: '0',
            padding: '1rem', background: 'rgba(255, 165, 0, 0.95)',
            color: 'black', fontWeight: 'bold', textAlign: 'center', zIndex: '1000'
        });
        banner.textContent = 'âš ï¸ 5 minutes remaining â€“ please review your answers.';
        document.body.appendChild(banner);
        setTimeout(() => banner.remove(), 10000);
    }

    /* ================= CORE ACTIONS ================= */

    selectAnswer(index) {
        if (this.isComplete) return;

        this.answers[this.currentIndex] = index;

        // Save progress to local storage if practice
        if (this.mode === 'practice') {
            this.saveLocalProgress();
        }

        // Re-render only the options part or full question to show selection state
        this.renderQuestion();
        this.updateProgressUI();
    }

    toggleFlag() {
        if (this.flagged.has(this.currentIndex)) {
            this.flagged.delete(this.currentIndex);
        } else {
            this.flagged.add(this.currentIndex);
        }
        this.renderFooter(); // Update flag icon state
    }

    nextQuestion() {
        if (this.currentIndex < this.questions.length - 1) {
            this.currentIndex++;
            this.renderQuestion();
            this.renderFooter();
        }
    }

    previousQuestion() {
        if (this.currentIndex > 0) {
            this.currentIndex--;
            this.renderQuestion();
            this.renderFooter();
        }
    }

    jumpTo(index) {
        if (index >= 0 && index < this.questions.length) {
            this.currentIndex = index;
            this.renderQuestion();
            this.renderFooter();
        }
    }

    /* ================= SUBMISSION & SCORING ================= */

    confirmExit() {
        const doExit = () => {
            // Clear global state to prevent double confirmation
            window.currentQuizEngine = null;
            if (this.returnChapter && typeof window.loadChapter === 'function') {
                window.loadChapter(this.returnChapter);
            } else {
                location.reload();
            }
        };

        if (typeof window.UI !== 'undefined') {
            window.UI.modal('Exit Quiz?', 'Your progress will be lost. Are you sure you want to go back to configuration?', doExit);
        } else if (confirm('Exit? Progress will be lost.')) {
            doExit();
        }
    }

    confirmSubmit() {
        const answeredCount = Object.keys(this.answers).length;
        const total = this.questions.length;
        const unanswered = total - answeredCount;

        let msg = `Ready to submit?\nYou have answered ${answeredCount} of ${total} questions.`;
        if (unanswered > 0) msg += `\n(${unanswered} skipped)`;

        if (typeof window.UI !== 'undefined') {
            window.UI.modal('Submit Exam?', msg.replace(/\n/g, '<br>'), () => this.submit());
        } else if (confirm(msg)) {
            this.submit();
        }
    }

    submit(forced = false) {
        if (this.isComplete) return;

        this.isComplete = true;
        this.endTime = Date.now();
        if (this.timerInterval) clearInterval(this.timerInterval);
        document.removeEventListener('keydown', this.handleKeyBound);

        if (forced) {
            if (typeof window.UI !== 'undefined') window.UI.toast("Time is up! Submitting exam.", "info");
            else alert("Time is up! Submitting exam.");
        }

        const results = this.calculateResults();
        this.renderResults(results);

        // Save local analytics
        this.saveToAnalytics(results);

        // Clear saved progress on completion
        this.clearLocalProgress();
    }

    calculateResults() {
        let correct = 0;
        const byTopic = {};
        const byPart = {}; // For simulation breakdown

        this.questions.forEach((q, idx) => {
            const userAns = this.answers[idx];
            const isCorrect = (userAns === q.answer);

            if (isCorrect) correct++;

            // Topic stats
            const topic = q.topic || 'General';
            if (!byTopic[topic]) byTopic[topic] = { total: 0, correct: 0 };
            byTopic[topic].total++;
            if (isCorrect) byTopic[topic].correct++;

            // Part stats (if simulation)
            if (q.part) {
                if (!byPart[q.part]) byPart[q.part] = { total: 0, correct: 0 };
                byPart[q.part].total++;
                if (isCorrect) byPart[q.part].correct++;
            }
        });

        const total = this.questions.length;
        const elapsedSeconds = Math.floor((this.endTime - this.startTime) / 1000);

        return {
            score: correct,
            total: total,
            percentage: Math.round((correct / total) * 100),
            timeSpent: elapsedSeconds,
            byTopic: byTopic,
            byPart: byPart
        };
    }

    saveToAnalytics(results) {
        // Deprecated: Analytics logging is now handled in renderResults via AnalyticsManager
    }

    /* ================= RENDERING ================= */

    renderFrame() {
        const container = document.getElementById(this.containerId);
        if (!container) return;

        // Common Shell
        container.innerHTML = `
            <div class="quiz-container-v2">
                <div class="quiz-header-v2">
                    <button class="btn btn-outline small" onclick="window.currentQuizEngine.confirmExit()">
                        <i class="ph-bold ph-gear"></i> Options
                    </button>
                    <!-- Pause moved to footer -->
                    <button class="btn btn-outline small" onclick="window.currentQuizEngine.printView()" title="Print Exam" style="margin-left: 0.5rem;">
                        <i class="ph-bold ph-printer"></i>
                    </button>
                    <div class="header-center">
                        <span id="quiz-header-title">${this.mode === 'simulation' ? 'Simulation Exam' : 'Chapter Quiz'}</span>
                        <div class="question-counter">Q <span id="q-num">1</span> / ${this.questions.length}</div>
                    </div>
                    ${this.timeLimit ? `
                    <div class="timer-badge">
                        <i class="ph-fill ph-clock"></i> <span id="quiz-timer" role="timer">--:--</span>
                    </div>` : ''}
                </div>

                <div class="quiz-body-v2" id="quiz-body">
                    <!-- Question injected here -->
                </div>

                <div class="quiz-footer-v2" id="quiz-footer">
                    <!-- Nav buttons injected here -->
                </div>
            </div>
        `;

        // Initial Footer Render
        this.renderFooter();
    }

    renderQuestion() {
        const container = document.getElementById('quiz-body');
        if (!container) return;

        const q = this.questions[this.currentIndex];
        const userAns = this.answers[this.currentIndex];

        // Check for section header (simulation mode)
        let sectionHtml = '';
        if (this.mode === 'simulation' && this.sectionBoundaries) {
            const boundary = this.sectionBoundaries.find(b => b.index === this.currentIndex);
            if (boundary) {
                sectionHtml = `<div class="exam-section-header">${boundary.label}</div>`;
            }
        }

        // Update Header Counter
        const numEl = document.getElementById('q-num');
        if (numEl) numEl.textContent = this.currentIndex + 1;

        // Coach Mode or Instant Feedback Logic
        const urlParams = new URLSearchParams(window.location.search);
        const isCoach = urlParams.get('coach') === '1';
        const showFeedback = (this.enableInstantFeedback || isCoach) && userAns !== undefined;

        // Render Options
        let optionsHtml = '';
        const labels = ['A', 'B', 'C', 'D', 'E'];

        q.options.forEach((opt, idx) => {
            let className = 'option-card-v2';
            let icon = '';

            if (userAns === idx) className += ' selected';

            if (showFeedback) {
                // Correct answer is always Green
                if (idx === q.answer) {
                    className += ' correct-green'; // Need CSS for this
                    icon = '<i class="ph-bold ph-check-circle" style="margin-left:auto; color:white;"></i>';
                }
                // Wrong selection is Amber
                else if (userAns === idx && idx !== q.answer) {
                    className += ' wrong-amber'; // Need CSS for this
                    icon = '<i class="ph-bold ph-x-circle" style="margin-left:auto; color:white;"></i>';
                }
            } else {
                // Normal behavior
                if (userAns === idx) icon = '<i class="ph-bold ph-check-circle" style="margin-left:auto"></i>';
            }

            optionsHtml += `
                <button class="${className}" 
                     type="button"
                     onclick="window.currentQuizEngine.selectAnswer(${idx})"
                     aria-label="Option ${labels[idx]}: ${opt}"
                     style="${showFeedback && idx === q.answer ? 'background-color: var(--success); color: white; border-color: var(--success);' : ''} 
                            ${showFeedback && userAns === idx && idx !== q.answer ? 'background-color: var(--warning); color: black; border-color: var(--warning);' : ''}">
                    <span class="option-indicator" style="${showFeedback && (idx === q.answer || (userAns === idx && idx !== q.answer)) ? 'background: rgba(255,255,255,0.3); color: white; border: none;' : ''}">${labels[idx] || '?'}</span>
                    <span class="option-content">${opt}</span>
                    ${icon}
                </button>
            `;
        });

        // Feedback Explanation
        let feedbackHtml = '';
        if (showFeedback) {
            const isRight = (userAns === q.answer);
            feedbackHtml = `
                <div class="coach-banner ${isRight ? 'success' : 'info'}" style="margin-top: 1rem; padding: 1rem; background: ${isRight ? '#dcfce7' : '#fff7ed'}; border-radius: 8px; border: 1px solid ${isRight ? '#22c55e' : '#f97316'};">
                    <strong>${isRight ? 'Correct!' : 'Incorrect.'}</strong> The answer is ${labels[q.answer]}.
                    <div class="small-explanation" style="margin-top: 0.5rem; color: #333;">
                        ${q.explain || 'No explanation provided.'}
                        ${!isRight && typeof window.generateReviewLink === 'function' ? window.generateReviewLink(q) : ''}
                    </div>
                </div>
             `;
        }

        container.innerHTML = `
            ${sectionHtml}
            <div class="question-fade-in">
                <h2 class="question-text-v2" tabindex="-1" style="outline: none;">${q.q || q.question}</h2>
                <div class="options-grid-v2">
                    ${optionsHtml}
                </div>
                ${feedbackHtml}
            </div>
        `;

        // Accessibility: Move focus to the new question to announce it
        // Use timeout to ensure DOM is ready and transition doesn't interfere
        setTimeout(() => {
            const h2 = container.querySelector('.question-text-v2');
            if (h2) h2.focus();
        }, 50);
    }

    renderFooter() {
        const container = document.getElementById('quiz-footer');
        if (!container) return;

        const isLast = this.currentIndex === this.questions.length - 1;
        const isFlagged = this.flagged.has(this.currentIndex);
        const progressPct = Math.round(((this.currentIndex) / this.questions.length) * 100);

        container.innerHTML = `
            <div class="footer-left">
                <button class="neo-btn icon-only ${isFlagged ? 'active-flag' : ''}" onclick="window.currentQuizEngine.toggleFlag()">
                    <i class="ph-fill ph-flag"></i>
                </button>
                <button class="neo-btn icon-only" onclick="window.currentQuizEngine.pauseQuiz()" title="Pause Quiz" style="margin-left: 0.5rem;">
                    <i class="ph-bold ph-pause"></i>
                </button>
                <div class="progress-mini">
                    <div class="bar" style="width: ${progressPct}%"></div>
                </div>
            </div>

            <div class="footer-right">
                <button class="neo-btn secondary" 
                        onclick="window.currentQuizEngine.previousQuestion()" 
                        ${this.currentIndex === 0 ? 'disabled' : ''}>
                    Prev
                </button>
                
                ${isLast ? `
                    <button class="neo-btn primary" onclick="window.currentQuizEngine.confirmSubmit()">
                        Submit Exam
                    </button>
                ` : `
                    <button class="neo-btn primary" onclick="window.currentQuizEngine.nextQuestion()">
                        Next
                    </button>
                `}
            </div>
        `;
    }

    updateProgressUI() {
        // Redraw footer progress bar if needed, handled in renderFooter mostly for simplicity
        // But we can target specific elements for perf if needed. For now renderFooter is fast enough.
        this.renderFooter();
    }

    /* ================= RESULTS & REVIEW ================= */

    renderResults(results) {
        // Analytics Tracking
        if (window.AnalyticsManager) {
            window.AnalyticsManager.logAttempt(this.quizId, results.score, results.total, this.mode);

            // Log missed questions for "Weak Areas" analysis
            this.questions.forEach((q, idx) => {
                const userAns = this.answers[idx];
                if (userAns !== q.answer) {
                    window.AnalyticsManager.logMissedQuestion(q.topic || 'General', q.q || q.question);
                }
            });
        }

        const container = document.getElementById(this.containerId);

        let analysisHtml = '';

        // Topic Breakdown
        const topics = Object.entries(results.byTopic).sort((a, b) => b[1].total - a[1].total);
        if (topics.length > 0) {
            analysisHtml += `<h3>Topic Breakdown</h3><div class="topic-grid">`;
            topics.forEach(([topic, stats]) => {
                const pct = Math.round((stats.correct / stats.total) * 100);
                const color = pct >= 80 ? 'green' : (pct >= 60 ? 'orange' : 'red');
                analysisHtml += `
                    <div class="stat-card ${color}">
                        <div class="stat-val">${pct}%</div>
                        <div class="stat-label">${topic}</div>
                        <div class="stat-meta">${stats.correct}/${stats.total}</div>
                    </div>
                `;
            });
            analysisHtml += `</div>`;
        }

        const mins = Math.floor(results.timeSpent / 60);
        const secs = results.timeSpent % 60;

        container.innerHTML = `
            <div class="results-view">
                <div class="score-header">
                    <h1>Results</h1>
                    <div class="big-score">${results.percentage}%</div>
                    <div class="score-meta">${results.score} / ${results.total} correct</div>
                    <div class="time-meta">Time: ${mins}m ${secs}s</div>
                </div>

                <div class="analysis-section">
                    ${analysisHtml}
                </div>

                <div class="actions-row">
                    <button class="neo-btn primary" onclick="window.currentQuizEngine.reviewMode()">Review Answers</button>
                    <button class="neo-btn secondary" onclick="window.currentQuizEngine.reviewMode(true)">Missed Only</button>
                    <button class="neo-btn outline" onclick="location.reload()">Exit</button>
                    <button class="neo-btn outline" onclick="window.currentQuizEngine.copyResultsToClipboard()">Copy</button>
                </div>
            </div>
        `;
    }

    reviewMode(missedOnly = false) {
        const container = document.getElementById(this.containerId);

        let questionsHtml = '';
        let count = 0;

        this.questions.forEach((q, idx) => {
            const userAns = this.answers[idx];
            const isCorrect = (userAns === q.answer);

            if (missedOnly && isCorrect) return; // Skip correct ones
            count++;

            const labels = ['A', 'B', 'C', 'D', 'E'];

            questionsHtml += `
                <div class="review-card ${isCorrect ? 'correct' : 'incorrect'}">
                    <div class="review-header">
                        <span class="q-idx">Q${idx + 1}</span>
                        <span class="status-badge">${isCorrect ? 'Correct' : 'Incorrect'}</span>
                    </div>
                    <div class="review-text">${q.q || q.question}</div>
                    
                    <div class="review-options">
                        ${q.options.map((opt, i) => {
                let cls = '';
                if (i === q.answer) cls = 'truth';
                else if (i === userAns) cls = 'selected-wrong';
                return `<div class="rev-opt ${cls}">${labels[i]}. ${opt}</div>`;
            }).join('')}
                    </div>

                    <div class="review-explain">
                        <strong>Explanation:</strong> ${q.explain || 'No explanation available.'}
                        ${!isCorrect && typeof window.generateReviewLink === 'function' ? `<div style="margin-top: 0.75rem; border-top: 1px dashed #ccc; padding-top: 0.5rem;">${window.generateReviewLink(q)}</div>` : ''}
                    </div>
                </div>
            `;
        });

        if (count === 0) {
            if (typeof window.UI !== 'undefined') window.UI.toast("No questions match criteria (e.g. perfect score!).", "info");
            else alert("No questions match criteria (e.g. perfect score!).");
            return;
        }

        container.innerHTML = `
            <div class="review-container">
                <div class="review-top-bar">
                    <h2>Reviewing ${missedOnly ? 'Missed' : 'All'} (${count})</h2>
                    <button class="neo-btn small outline" onclick="window.currentQuizEngine.submit(true)">Back to Results</button>
                </div>
                <div class="review-list">
                    ${questionsHtml}
                </div>
            </div>
        `;
    }

    printView() {
        const container = document.getElementById(this.containerId);

        const questionsHtml = this.questions.map((q, idx) => {
            const labels = ['A', 'B', 'C', 'D', 'E'];
            return `
                <div class="print-question" style="margin-bottom: 2rem; page-break-inside: avoid;">
                    <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 0.5rem;">${idx + 1}. ${q.q || q.question}</div>
                    <div class="print-options" style="margin-left: 1.5rem;">
                        ${q.options.map((opt, i) => `
                            <div style="margin-bottom: 0.25rem;">
                                <span style="font-weight: 600; margin-right: 0.5rem;">${labels[i]})</span> ${opt}
                            </div>
                        `).join('')}
                    </div>
                </div>
             `;
        }).join('');

        const answerKeyRows = this.questions.map((q, idx) => {
            const labels = ['A', 'B', 'C', 'D', 'E'];
            return `<div style="display:inline-block; width: 4rem; margin-bottom: 0.5rem;"><strong>${idx + 1}:</strong> ${labels[q.answer]}</div>`;
        }).join('');

        const html = `
            <div class="print-wrapper">
                <div class="print-header" style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid black; padding-bottom: 1rem;">
                    <h1 style="margin: 0; font-family:serif;">${this.mode === 'simulation' ? 'Disease Detectives Simulation Exam' : 'Epidemic Engine Practice Quiz'}</h1>
                    <div style="margin-top: 0.5rem; font-family:serif;">Name: ________________________________  Score: _______ / ${this.questions.length}</div>
                </div>

                <div class="print-body">
                    ${questionsHtml}
                </div>

                <div class="print-key" style="page-break-before: always; margin-top: 3rem;">
                    <h2 style="text-align: center; border-bottom: 1px solid black; margin-bottom: 1rem; font-family:serif;">Answer Key</h2>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${answerKeyRows}
                    </div>
                </div>

                <div class="print-controls" style="position: fixed; top: 20px; right: 20px; background: white; padding: 1rem; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                    <button class="neo-btn primary" onclick="window.print()">Print Now</button>
                    <button class="neo-btn outline" onclick="location.reload()">Back to App</button>
                </div>
            </div>
        `;

        container.innerHTML = html;
        setTimeout(() => window.print(), 500);
    }

    copyResultsToClipboard() {
        // Logic from ComprehensiveQuiz
        const results = this.calculateResults();
        let text = `Epidemic Engine Results: ${results.score}/${results.total} (${results.percentage}%)\n`;
        text += `Time: ${Math.floor(results.timeSpent / 60)}m\n\n`;
        Object.entries(results.byTopic).forEach(([topic, stats]) => {
            text += `${topic}: ${Math.round((stats.correct / stats.total) * 100)}%\n`;
        });
        navigator.clipboard.writeText(text).then(() => {
            if (typeof window.UI !== 'undefined') window.UI.toast("Copied!", "success");
            else alert("Copied!");
        });
    }

    /* ================= LOCAL STORAGE ================= */

    saveLocalProgress() {
        if (!this.quizId) return;
        const state = {
            currentIndex: this.currentIndex,
            answers: this.answers,
            flagged: Array.from(this.flagged),
            elapsedTime: Date.now() - this.startTime,
            savedAt: Date.now(),
            mode: this.mode
        };
        localStorage.setItem('quiz_progress_' + this.quizId, JSON.stringify(state));
    }

    loadLocalProgress() {
        try {
            const raw = localStorage.getItem('quiz_progress_' + this.quizId);
            if (!raw) return null;
            return JSON.parse(raw);
        } catch (e) {
            console.error("Failed to load progress", e);
            return null;
        }
    }

    clearLocalProgress() {
        if (this.quizId) {
            localStorage.removeItem('quiz_progress_' + this.quizId);
        }
    }

    pauseQuiz() {
        this.saveLocalProgress();
        if (this.timerInterval) clearInterval(this.timerInterval);

        const container = document.getElementById(this.containerId);
        if (!container) return;

        // Create overlay
        const overlay = document.createElement('div');
        overlay.id = 'quiz-pause-overlay';
        Object.assign(overlay.style, {
            position: 'absolute', top: '0', left: '0', right: '0', bottom: '0',
            background: 'rgba(255,255,255,0.95)', zIndex: '100',
            display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center'
        });

        overlay.innerHTML = `
            <h2 style="margin-bottom: 1rem; color: var(--navy-primary);">Quiz Paused</h2>
            <p style="margin-bottom: 2rem;">Your progress has been saved.</p>
            <button class="neo-btn primary large" id="resume-btn">
                <i class="ph-bold ph-play"></i> Resume Quiz
            </button>
            <button class="neo-btn outline" onclick="window.currentQuizEngine.confirmExit()" style="margin-top: 1rem;">
                Exit to Menu
            </button>
        `;

        container.appendChild(overlay);

        // Handle Resume
        document.getElementById('resume-btn').onclick = () => {
            overlay.remove();
            if (this.timeLimit) {
                // Adjust start time to account for pause duration? 
                // Simple version: just restart interval, but that might drift if we don't track pause time.
                // Better: We saved progress. The simplest is to just restart the timer interval logic.

                // The current timer logic usually calcs elapsed based on StartTime. 
                // If we pause, wall clock keeps moving. We need to shift startTime forward by the pause duration.
                // But for now, let's just re-init the timer which updates display.
                // Wait... if logic relies on (Now - StartTime), pausing will effectively count as "time taken".
                // To truly pause the CLOCK, we need to track "PauseStartTime".

                // Correction: The simplest approach for now without refactoring the whole timer:
                // We rely on the fact that the user is NOT exiting.
                // We need to adjust this.startTime so the elapsed calculation remains valid.
                // But since we didn't track "pauseStart", let's just restart for now or rely on the user knowing time ticks?
                // NO, user expects time to stop.

                // Let's effectively "re-start" the session logic similar to a reload, 
                // but we need to know how long we were paused.
                // Let's use a dirty fix: 
                // We don't have pauseStart variable in class state easily without breaking constructor.
                // ACTUALLY: The easiest fix:
                // The `start()` logic handles "resuming" by adjusting startTime based on `saved.elapsedTime`.
                // So we can just call `start()` again? No, that re-renders everything.

                // Let's do this manual fix:
                // 1. When pausing, we saved `elapsedTime`.
                // 2. When resuming, reset `startTime` to `Date.now() - saved.elapsedTime`.

                const saved = this.loadLocalProgress();
                if (saved && saved.elapsedTime) {
                    this.startTime = Date.now() - saved.elapsedTime;
                }
                this.startTimer();
            }
        };
    }
}

// Static Generator for Simulation Exams
// Static Generator for Simulation Exams (Improved Blueprint)
QuizEngine.generateSimulation = function (difficulty = 'balanced') {
    if (typeof QUIZ_BANKS === 'undefined') return { questions: [], boundaries: [] };

    // Helper: Select N random questions with TOPIC BALANCING
    const selectBalanced = (part, totalCount, difficulty = 'balanced') => {
        if (!QUIZ_BANKS[part]) return [];

        // 1. Gather Filtered Pool
        let pool = [];
        ['beginner', 'intermediate', 'advanced'].forEach(lvl => {
            if (QUIZ_BANKS[part][lvl]) {
                const qList = QUIZ_BANKS[part][lvl].map(q => ({ ...q, part: part, difficulty: lvl }));
                pool.push(...qList);
            }
        });

        // Filter by difficulty preference
        if (difficulty === 'beginner') pool = pool.filter(q => q.difficulty !== 'advanced');
        else if (difficulty === 'advanced') pool = pool.filter(q => q.difficulty !== 'beginner');

        // 2. Group by Topic
        const byTopic = {};
        pool.forEach(q => {
            const t = q.topic || 'General';
            if (!byTopic[t]) byTopic[t] = [];
            byTopic[t].push(q);
        });

        const topics = Object.keys(byTopic);
        if (topics.length === 0) return [];

        // 3. Distribute Quota
        // Goal: Even spread across topics
        let selected = [];
        const baseCount = Math.floor(totalCount / topics.length);
        let remainder = totalCount % topics.length;

        // Shuffle topics so the "remainder" (extra questions) distributes randomly each time
        topics.sort(() => Math.random() - 0.5);

        topics.forEach(topic => {
            // Determine how many to take from this topic
            let count = baseCount;
            if (remainder > 0) {
                count++;
                remainder--;
            }

            // Shuffle questions within this topic
            const topicQs = byTopic[topic].sort(() => Math.random() - 0.5);

            // Take the quota (or all if insufficient)
            selected.push(...topicQs.slice(0, count));
        });

        // 4. Fallback if pool was too small to meet totalCount (rare)
        if (selected.length < totalCount) {
            // Fill rest with randoms from full pool (excluding already selected)
            const remainingNeeded = totalCount - selected.length;
            const currentIds = new Set(selected.map(q => q.q)); // using q text as ID proxy

            const leftovers = pool.filter(q => !currentIds.has(q.q)).sort(() => Math.random() - 0.5);
            selected.push(...leftovers.slice(0, remainingNeeded));
        }

        // 5. Final Shuffle
        return selected.sort(() => Math.random() - 0.5);
    };

    // Blueprint: 50 Questions Total
    // Part I (Foundations): 10 Qs
    // Part II (Investigation/Math): 25 Qs
    // Part III (Control/Studies): 15 Qs

    const part1Qs = selectBalanced('part1', 10, difficulty);
    const part2Qs = selectBalanced('part2', 25, difficulty);
    const part3Qs = selectBalanced('part3', 15, difficulty);

    const finalQuestions = [...part1Qs, ...part2Qs, ...part3Qs];

    const boundaries = [
        { index: 0, label: 'Part I: Scientific Inquiry & Foundations' },
        { index: part1Qs.length, label: 'Part II: Investigation & Statistics' },
        { index: part1Qs.length + part2Qs.length, label: 'Part III: Prevention & Control' }
    ];

    return { questions: finalQuestions, boundaries };
};

// Helper: Select questions for a specific Part
QuizEngine.getQuestionsForPart = function (partId, difficulty = 'balanced') {
    if (typeof QUIZ_BANKS === 'undefined') return [];

    const cleanId = partId.replace('quiz_', '');

    const getQs = (pid, level) => {
        if (!QUIZ_BANKS[pid] || !QUIZ_BANKS[pid][level]) return [];
        return QUIZ_BANKS[pid][level].map(q => ({ ...q, part: pid, difficulty: level }));
    };

    let questions = [];
    const levels = ['beginner', 'intermediate', 'advanced'];

    if (difficulty === 'balanced') {
        levels.forEach(lvl => questions.push(...getQs(cleanId, lvl)));
    } else {
        questions = getQs(cleanId, difficulty);
    }

    return questions;
};

// Validates a single question object against schema
QuizEngine.validateQuestion = function (q) {
    if (!q || typeof q !== 'object') return false;
    if (!q.q || typeof q.q !== 'string' || q.q.length < 5) return false; // "q" is content
    if (!Array.isArray(q.options) || q.options.length < 2) return false;
    if (typeof q.answer !== 'number' || q.answer < 0 || q.answer >= q.options.length) return false;
    return true;
};

// Expose
window.QuizEngine = QuizEngine;
window.currentQuizEngine = null;

class AppendixEngine {
    constructor() {
        this.flashcardIndex = 0;
        this.isFlipped = false;
    }

    getFlashcards() {
        return window.APPENDIX_DATA && window.APPENDIX_DATA.flashcards ? window.APPENDIX_DATA.flashcards : [];
    }

    getGlossary() {
        return window.APPENDIX_DATA && window.APPENDIX_DATA.glossary ? window.APPENDIX_DATA.glossary : [];
    }

    initFlashcards(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const flashcards = this.getFlashcards();
        if (!flashcards || flashcards.length === 0) {
            container.innerHTML = '<p>No flashcards available.</p>';
            return;
        }

        this.renderFlashcardUI(container);
        this.updateFlashcard();
    }

    renderFlashcardUI(container) {
        container.innerHTML = `
            <div style="max-width: 700px; margin: 0 auto; display: flex; flex-direction: column; gap: 4rem;">
                
                <p style="text-align:center; color:#475569; font-style:italic; margin-bottom: -3rem; position: relative; z-index: 5;">
                    <i class="ph-bold ph-hand-tap"></i> Click the card to flip
                </p>

                <!-- Card Container -->
                <div style="perspective: 1000px; width: 100%; height: 350px; position: relative; z-index: 1;">
                    <button id="active-flashcard" onclick="window.appendixEngine.flipCard()"
                         onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); window.appendixEngine.flipCard(); }"
                         aria-label="Flashcard. Press Enter or Space to flip."
                         style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; 
                                transition: transform 0.6s; cursor: pointer; background: transparent; border: none; padding: 0; outline: none;">
                        
                        <div id="face-front" class="flashcard-face flashcard-front" aria-hidden="false"
                             style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; backface-visibility: hidden;
                                    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                                    border: 3px solid #000; border-radius: 16px; padding: 2rem;
                                    display: flex; flex-direction: column; align-items: center; justify-content: center;
                                    box-shadow: 8px 8px 0 #000;">
                            <div id="fc-front" style="font-family: 'Space Grotesk', sans-serif; font-size: 2rem; 
                                                      font-weight: 700; text-align: center; color: #1a1a1a; line-height: 1.3;"></div>
                            <div style="position: absolute; bottom: 1.5rem; font-size: 0.9rem; color: #475569; 
                                       font-family: 'Inter', sans-serif; font-style: italic;">Click (or Space) to flip</div>
                        </div>

                        <div id="face-back" class="flashcard-face flashcard-back" aria-hidden="true"
                             style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; backface-visibility: hidden;
                                    background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
                                    border: 3px solid #000; border-radius: 16px; padding: 2rem;
                                    display: flex; flex-direction: column; align-items: center; justify-content: center;
                                    box-shadow: 8px 8px 0 #000; transform: rotateY(180deg);">
                            <div id="fc-back" style="font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; 
                                                     font-weight: 600; text-align: center; color: #1a1a1a; line-height: 1.4;"></div>
                            <div style="position: absolute; bottom: 1.5rem; font-size: 0.9rem; color: #475569; 
                                       font-family: 'Inter', sans-serif; font-style: italic;">Click (or Space) to flip</div>
                        </div>
                    </button>
                </div>

                <!-- Controls Container -->
                <div style="position: relative; z-index: 10; width: 100%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                        <button id="fc-prev-btn" onclick="window.appendixEngine.prevCard()" aria-label="Previous Card"
                                style="flex: 1; max-width: 180px; padding: 1rem; border-radius: 8px; font-weight: 800; text-transform: uppercase;
                                       cursor: pointer; border: 3px solid #000; background: #000000; color: #ffffff;
                                       box-shadow: 4px 4px 0 rgba(0,0,0,0.2); font-family: 'Space Grotesk', sans-serif; font-size: 1.2rem;">
                            &#8592; PREV
                        </button>
                        <span id="fc-counter" style="font-family: 'Space Grotesk', sans-serif; font-weight: 700; 
                                                     font-size: 1.5rem; color: #1a1a1a;" aria-live="polite"></span>
                        <button id="fc-next-btn" onclick="window.appendixEngine.nextCard()" aria-label="Next Card"
                                style="flex: 1; max-width: 180px; padding: 1rem; border-radius: 8px; font-weight: 800; text-transform: uppercase;
                                       cursor: pointer; border: 3px solid #000; background: #3b82f6; color: #ffffff;
                                       box-shadow: 4px 4px 0 #000; font-family: 'Space Grotesk', sans-serif; font-size: 1.2rem;">
                            NEXT &#8594;
                        </button>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="flex:1; height: 24px; background: #e5e7eb; border: 2px solid #000; border-radius: 999px; 
                                   overflow: hidden; box-shadow: 4px 4px 0 #000;">
                            <div id="fc-progress" style="height: 100%; background: linear-gradient(90deg, #ff5c00 0%, #a855f7 100%); 
                                                         width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                         <button onclick="window.appendixEngine.printFlashcards()" title="Print All Cards"
                                style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #000; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 2px 2px 0 #000;">
                            <i class="ph-bold ph-printer"></i>
                        </button>
                    </div>
                </div>

            </div>
        `;
    }

    updateFlashcard() {
        const flashcards = this.getFlashcards();
        if (this.flashcardIndex >= flashcards.length) this.flashcardIndex = 0;

        const card = flashcards[this.flashcardIndex];
        const frontEl = document.getElementById('fc-front');
        const backEl = document.getElementById('fc-back');
        const counterEl = document.getElementById('fc-counter');
        const progressEl = document.getElementById('fc-progress');
        const flashcardEl = document.getElementById('active-flashcard');
        const faceFront = document.getElementById('face-front');
        const faceBack = document.getElementById('face-back');

        if (!frontEl || !backEl) return;

        this.isFlipped = false;
        if (flashcardEl) flashcardEl.classList.remove('is-flipped');

        // Reset ARIA
        if (faceFront) faceFront.setAttribute('aria-hidden', 'false');
        if (faceBack) faceBack.setAttribute('aria-hidden', 'true');

        frontEl.textContent = card.front;
        backEl.textContent = card.back;
        counterEl.textContent = `${this.flashcardIndex + 1} / ${flashcards.length}`;

        const pct = ((this.flashcardIndex + 1) / flashcards.length) * 100;
        progressEl.style.width = `${pct}%`;
    }

    flipCard() {
        this.isFlipped = !this.isFlipped;
        const flashcardEl = document.getElementById('active-flashcard');
        const faceFront = document.getElementById('face-front');
        const faceBack = document.getElementById('face-back');

        if (flashcardEl) {
            if (this.isFlipped) {
                flashcardEl.style.transform = 'rotateY(180deg)';
                if (faceFront) faceFront.setAttribute('aria-hidden', 'true');
                if (faceBack) faceBack.setAttribute('aria-hidden', 'false');
            } else {
                flashcardEl.style.transform = 'rotateY(0deg)';
                if (faceFront) faceFront.setAttribute('aria-hidden', 'false');
                if (faceBack) faceBack.setAttribute('aria-hidden', 'true');
            }
        }
    }

    nextCard() {
        if (this.flashcardIndex < this.getFlashcards().length - 1) {
            this.flashcardIndex++;
            this.updateFlashcard();
        }
    }

    prevCard() {
        if (this.flashcardIndex > 0) {
            this.flashcardIndex--;
            this.updateFlashcard();
        }
    }

    initGlossary(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = `
            <div style="margin-bottom: 2rem;">
                <input type="text" id="glossary-search" placeholder="ðŸ” Search terms..." onkeyup="window.appendixEngine.filterGlossary()"
                       style="width: 100%; padding: 1rem 1.5rem; font-size: 1.1rem; font-family: 'Inter', sans-serif;
                              border: 3px solid #000; border-radius: 12px; background: white;
                              box-shadow: 4px 4px 0 #000;">
            </div>
            <div id="glossary-list" style="display: grid; gap: 0.75rem;"></div>
        `;

        this.renderGlossaryList(this.getGlossary());
    }

    renderGlossaryList(items) {
        const listContainer = document.getElementById('glossary-list');
        if (!listContainer) return;

        if (!items || items.length === 0) {
            listContainer.innerHTML = '<p style="text-align: center; color: #64748b;">No terms found.</p>';
            return;
        }

        items.sort((a, b) => a.term.localeCompare(b.term));

        let html = '';
        let currentLetter = '';

        // Color Palette for Cycling
        const PALETTE = ['var(--accent-blue)', 'var(--accent-orange)', 'var(--accent-green)', 'var(--accent-purple)', 'var(--accent-pink)'];
        const BG_PALETTE = ['#eff6ff', '#fff7ed', '#f0fdf4', '#faf5ff', '#fdf2f8']; // Matches tailwind 50s
        const BORDER_PALETTE = ['#bfdbfe', '#fed7aa', '#bbf7d0', '#e9d5ff', '#fbcfe8']; // Matches tailwind 200s

        items.forEach((item, idx) => {
            const color = PALETTE[idx % PALETTE.length];
            const firstLetter = item.term.charAt(0).toUpperCase();

            if (firstLetter !== currentLetter) {
                currentLetter = firstLetter;
                html += `<div style="font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; font-weight: 700;
                                     color: ${color}; margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem;
                                     border-bottom: 3px solid #000;">${currentLetter}</div>`;
            }
            html += `
                <div style="background: white; border: 2px solid #000; border-left: 6px solid ${color}; border-radius: 8px; padding: 1rem;
                           box-shadow: 3px 3px 0 #000; margin-bottom: 0.5rem;">
                    <strong style="font-family: 'Space Grotesk', sans-serif; font-size: 1.1rem; font-weight: 700;
                                  color: ${color}; display: block; margin-bottom: 0.5rem;">${item.term}</strong>
                    <span style="font-family: 'Inter', sans-serif; font-size: 1rem; line-height: 1.6;
                                color: #1a1a1a;">${item.definition}</span>
                </div>
            `;
        });

        listContainer.innerHTML = html;
    }

    filterGlossary() {
        const searchInput = document.getElementById('glossary-search');
        if (!searchInput) return;
        const query = searchInput.value.toLowerCase();

        const filtered = this.getGlossary().filter(item =>
            item.term.toLowerCase().includes(query) ||
            item.definition.toLowerCase().includes(query)
        );

        this.renderGlossaryList(filtered);
    }

    printFlashcards() {
        const flashcards = this.getFlashcards();
        if (!flashcards.length) return;

        const container = document.getElementById('flashcard-root');
        if (!container) return;

        // Save current state to restore later if needed (simple reload is easier)
        const originalContent = container.innerHTML;

        const html = `
            <div class="print-wrapper">
                <div class="no-print" style="margin-bottom: 2rem; border-bottom: 1px solid #ccc; padding-bottom: 1rem;">
                    <button class="neo-btn outline" onclick="location.reload()">
                        <i class="ph-bold ph-arrow-left"></i> Back to Deck
                    </button>
                    <button class="neo-btn primary" onclick="window.print()" style="margin-left: 1rem;">
                        <i class="ph-bold ph-printer"></i> Print Now
                    </button>
                </div>

                <div style="text-align: center; margin-bottom: 2rem;">
                    <h1>Epidemic Engine: Flashcards</h1>
                    <p>Total Cards: ${flashcards.length}</p>
                </div>

                <div class="print-grid" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                    ${flashcards.map((card, i) => `
                        <div style="border: 2px solid #000; break-inside: avoid; padding: 1rem; display: flex; flex-direction: row; align-items: stretch;">
                            <div style="flex: 0 0 40px; font-weight: bold; border-right: 2px solid #000; margin-right: 1rem; display: flex; align-items: center; justify-content: center; background: #eee;">
                                ${i + 1}
                            </div>
                            <div style="flex: 1; padding-right: 1rem; border-right: 1px dashed #ccc; display: flex; align-items: center;">
                                <strong>${card.front}</strong>
                            </div>
                            <div style="flex: 1; padding-left: 1rem; display: flex; align-items: center;">
                                ${card.back}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            <style>
                @media print {
                    .no-print { display: none !important; }
                    .app-container, .sidebar, .site-footer { display: none !important; }
                    body { background: white; color: black; }
                    .print-wrapper { position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 0.5in; }
                }
            </style>
        `;

        container.innerHTML = html;
    }

    getFormulas() {
        return window.APPENDIX_DATA && window.APPENDIX_DATA.FORMULAS ? window.APPENDIX_DATA.FORMULAS : [];
    }

    getTables() {
        return window.APPENDIX_DATA && window.APPENDIX_DATA.TABLES ? window.APPENDIX_DATA.TABLES : null;
    }

    initFormulas(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const formulas = this.getFormulas();
        if (formulas.length === 0) {
            container.innerHTML = '<p>No formulas found.</p>';
            return;
        }

        let currentCategory = '';
        let html = '';

        formulas.sort((a, b) => {
            if (a.category !== b.category) return a.category.localeCompare(b.category);
            return a.name.localeCompare(b.name);
        });

        // Color Palette for Cycling (Re-declared for scope safety if needed, though closure handles it)
        const PALETTE = ['var(--accent-blue)', 'var(--accent-orange)', 'var(--accent-green)', 'var(--accent-purple)', 'var(--accent-pink)'];
        const BG_PALETTE = ['#eff6ff', '#fff7ed', '#f0fdf4', '#faf5ff', '#fdf2f8'];
        const BORDER_PALETTE = ['#bfdbfe', '#fed7aa', '#bbf7d0', '#e9d5ff', '#fbcfe8'];

        formulas.forEach((f, idx) => {
            const color = PALETTE[idx % PALETTE.length];
            const bg = BG_PALETTE[idx % BG_PALETTE.length];
            const border = BORDER_PALETTE[idx % BORDER_PALETTE.length];

            if (f.category !== currentCategory) {
                currentCategory = f.category;
                html += `<h4 style="margin-top: 1.5rem; color: ${color}; border-bottom: 2px solid #eee; padding-bottom: 0.5rem;">${currentCategory}</h4>`;
            }
            html += `
                <div class="neo-card small" style="margin-bottom: 0.75rem; border-left: 4px solid ${color};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                        <strong style="font-size: 1.1rem; color: ${color};">${f.name}</strong>
                        <span class="neo-badge small" style="background: ${bg}; color: ${color}; border: 1px solid ${border};">${f.use}</span>
                    </div>
                    <code style="display: block; background: #f8f9fa; padding: 0.75rem; border-radius: 4px; font-family: monospace; font-size: 1.1rem; border: 1px solid #e2e8f0;">${f.calc}</code>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    initTables(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const tables = this.getTables();
        if (!tables) {
            container.innerHTML = '<p>No tables found.</p>';
            return;
        }

        let html = '';

        // Render Chi-Square
        if (tables.chiSqure) {
            const t = tables.chiSqure;
            html += `
                <div class="neo-card" style="margin-bottom: 2rem;">
                    <h4 style="margin-top: 0; color: var(--accent-orange);">${t.title}</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-family: 'Space Grotesk', sans-serif;">
                            <thead>
                                <tr style="background: var(--navy-primary); color: white;">
                                    ${t.headers.map(h => `<th style="padding: 0.75rem; text-align: center;">${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${t.rows.map((row, i) => `
                                    <tr style="${i % 2 === 0 ? 'background: #f8fafc;' : 'background: white;'}">
                                        ${row.map(cell => `<td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e2e8f0;">${cell}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Render Z-Table
        if (tables.zTable) {
            const t = tables.zTable;
            html += `
                <div class="neo-card">
                    <h4 style="margin-top: 0; color: var(--accent-green);">${t.title}</h4>
                     <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-family: 'Space Grotesk', sans-serif;">
                            <thead>
                                <tr style="background: var(--navy-primary); color: white;">
                                    ${t.headers.map(h => `<th style="padding: 0.75rem; text-align: center;">${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${t.rows.map((row, i) => `
                                    <tr style="${i % 2 === 0 ? 'background: #f8fafc;' : 'background: white;'}">
                                        ${row.map(cell => `<td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e2e8f0;">${cell}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
    }
}

window.appendixEngine = new AppendixEngine();

/**
 * Epidemic Engine - Visual Components Library
 * Interactive SVGs and Diagrams
 */

window.VisualComponents = {

    // Interactive Epidemiologic Triad
    renderTriad: function (containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const html = `
            <div class="triad-widget neo-card" style="text-align:center; padding: 2rem;">
                <h3 style="color:var(--navy-primary); margin-bottom: 2rem; font-weight: 800; font-size: 1.5rem;">Interactive Triad</h3>
                
                <div style="display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap: 2rem;">
                    
                    <!-- SVG Diagram -->
                    <div class="triad-svg-container" style="flex: 0 0 300px;">
                        <svg viewBox="0 0 300 260" style="filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">
                            <!-- Edges -->
                            <line x1="150" y1="40" x2="40" y2="220" stroke="#cbd5e1" stroke-width="6" stroke-linecap="round" />
                            <line x1="150" y1="40" x2="260" y2="220" stroke="#cbd5e1" stroke-width="6" stroke-linecap="round" />
                            <line x1="40" y1="220" x2="260" y2="220" stroke="#cbd5e1" stroke-width="6" stroke-linecap="round" />

                            <!-- Vector (Center) -->
                            <g class="triad-node" role="button" tabindex="0" onclick="VisualComponents.updateTriad('vector')" onkeydown="if(event.key==='Enter'||event.key===' ')VisualComponents.updateTriad('vector')" style="cursor:pointer;" aria-label="Select Vector">
                                <circle cx="150" cy="150" r="32" fill="#f1f5f9" stroke="#64748b" stroke-width="3" class="node-bg" id="node-vector"/>
                                <text x="150" y="156" text-anchor="middle" font-size="11" font-weight="900" fill="#334155" style="text-transform: uppercase; letter-spacing: 0.5px;">VECTOR</text>
                            </g>

                            <!-- Agent (Top) -->
                            <g class="triad-node" role="button" tabindex="0" onclick="VisualComponents.updateTriad('agent')" onkeydown="if(event.key==='Enter'||event.key===' ')VisualComponents.updateTriad('agent')" style="cursor:pointer;" aria-label="Select Agent">
                                <circle cx="150" cy="40" r="38" fill="#fee2e2" stroke="#ef4444" stroke-width="4" class="node-bg" id="node-agent"/>
                                <text x="150" y="46" text-anchor="middle" font-size="13" font-weight="900" fill="#991b1b" style="text-transform: uppercase;">AGENT</text>
                                <text x="150" y="15" text-anchor="middle" font-size="24">ðŸ¦ </text>
                            </g>

                            <!-- Host (Left) -->
                            <g class="triad-node" role="button" tabindex="0" onclick="VisualComponents.updateTriad('host')" onkeydown="if(event.key==='Enter'||event.key===' ')VisualComponents.updateTriad('host')" style="cursor:pointer;" aria-label="Select Host">
                                <circle cx="40" cy="220" r="38" fill="#dbeafe" stroke="#3b82f6" stroke-width="4" class="node-bg" id="node-host"/>
                                <text x="40" y="226" text-anchor="middle" font-size="13" font-weight="900" fill="#1e40af" style="text-transform: uppercase;">HOST</text>
                                <text x="40" y="195" text-anchor="middle" font-size="24">ðŸ‘¤</text>
                            </g>

                            <!-- Environment (Right) -->
                            <g class="triad-node" role="button" tabindex="0" onclick="VisualComponents.updateTriad('env')" onkeydown="if(event.key==='Enter'||event.key===' ')VisualComponents.updateTriad('env')" style="cursor:pointer;" aria-label="Select Environment">
                                <circle cx="260" cy="220" r="38" fill="#dcfce7" stroke="#22c55e" stroke-width="4" class="node-bg" id="node-env"/>
                                <text x="260" y="226" text-anchor="middle" font-size="12" font-weight="900" fill="#166534" style="text-transform: uppercase;">ENVIRON</text>
                                <text x="260" y="195" text-anchor="middle" font-size="24">ðŸŒ</text>
                            </g>
                        </svg>
                    </div>

                    <!-- Info Panel -->
                    <div id="triad-info" role="status" aria-live="polite" style="flex: 1; min-width: 250px; text-align: left; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                        <h4 style="margin-top:0; color:#334155; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.75rem; font-weight: 800; font-size: 1.1rem;">Select a Node</h4>
                        <p style="color: #475569; font-size: 1rem; line-height: 1.6; font-weight: 500;">Click on the corners of the triangle to explore the components of this model.</p>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML = html;

        // Initial state - Use RAF to avoid synchronous layout thrashing after innerHTML write
        requestAnimationFrame(() => {
            this.updateTriad('agent');
        });
    },

    updateTriad: function (type) {
        const info = document.getElementById('triad-info');
        if (!info) return;

        const content = {
            agent: {
                title: "The Agent ('What')",
                color: "#b91c1c",
                bg: "#fee2e2",
                body: `
                    <p>The cause of the disease. Can be:</p>
                    <ul style="padding-left: 1.25rem;">
                        <li><strong>Biological:</strong> Bacteria, Viruses, Parasites</li>
                        <li><strong>Chemical:</strong> Poisons, Alcohol, Smoke</li>
                        <li><strong>Physical:</strong> Trauma, Radiation, Fire</li>
                        <li><strong>Nutritional:</strong> Lack (Scurvy) or Excess (Obesity)</li>
                    </ul>
                `
            },
            host: {
                title: "The Host ('Who')",
                color: "#1d4ed8",
                bg: "#dbeafe",
                body: `
                    <p>The organism harboring the disease. Risk factors include:</p>
                    <ul style="padding-left: 1.25rem;">
                        <li><strong>Intrinsic:</strong> Age, Sex, Genetics, Immunity</li>
                        <li><strong>Behavioral:</strong> Diet, Exercise, Hygiene</li>
                        <li><strong>Psychological:</strong> Stress levels</li>
                    </ul>
                `
            },
            env: {
                title: "The Environment ('Where')",
                color: "#15803d",
                bg: "#dcfce7",
                body: `
                    <p>External factors allowing transmission:</p>
                    <ul style="padding-left: 1.25rem;">
                        <li><strong>Physical:</strong> Climate, Geography, Water supply</li>
                        <li><strong>Biological:</strong> Vectors (Mosquitoes), Flora</li>
                        <li><strong>Socioeconomic:</strong> Crowding, Sanitation, Access to care</li>
                    </ul>
                `
            },
            vector: {
                title: "The Vector (Center)",
                color: "#475569",
                bg: "#f1f5f9",
                body: `
                    <p><strong>The Transporter.</strong></p>
                    <p>An organism (like a mosquito or tick) that carries the agent from a host or reservoir to a new susceptible host. Not always present in every disease model.</p>
                `
            }
        };

        const data = content[type];

        // Animate Update
        info.style.opacity = '0.5';
        setTimeout(() => {
            info.style.background = data.bg;
            info.style.borderColor = data.color;
            info.innerHTML = `
                <h4 style="margin-top:0; color:${data.color}; border-bottom: 1px solid ${data.color}40; padding-bottom: 0.5rem;">${data.title}</h4>
                <div style="font-size: 0.95rem; color: #334155;">${data.body}</div>
            `;
            info.style.opacity = '1';
        }, 150);

        // Highlight SVG Node
        document.querySelectorAll('.node-bg').forEach(el => el.style.filter = '');

        // Reset Aria-Pressed
        document.querySelectorAll('.triad-node').forEach(el => el.setAttribute('aria-pressed', 'false'));

        const activeNode = document.getElementById(`node-${type}`);
        if (activeNode) {
            activeNode.style.filter = 'brightness(0.9) drop-shadow(0 0 8px rgba(0,0,0,0.2))';
            activeNode.parentElement.setAttribute('aria-pressed', 'true'); // Set on the group
        }
    },

    // ------------------------------------------
    // "Stop the Outbreak" Simulator (R0 Control)
    // ------------------------------------------
    renderControlSimulator: function (containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const html = `
            <div class="control-sim neo-card" style="padding: 2rem; background: linear-gradient(to bottom right, #f8fafc, #f1f5f9);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 2rem;">
                    <div>
                        <h3 style="color:var(--navy-primary); margin:0;">Stop the Outbreak</h3>
                        <p style="margin:0.25rem 0 0; color:#64748b; font-size:0.9rem;">Adjust interventions to reduce the Reproduction Number (R).</p>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.8rem; text-transform:uppercase; font-weight:bold; color:#64748b;">Current Status</div>
                        <div id="sim-status" style="font-weight:bold; color:#ef4444;">EXPONENTIAL GROWTH</div>
                    </div>
                </div>

                <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                    <!-- Controls -->
                    <div style="flex: 1; min-width: 250px;">
                        <!-- Vaccine -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:0.5rem;">
                                <span>Vaccination Rate</span>
                                <span id="val-vac">0%</span>
                            </label>
                            <input type="range" id="range-vac" min="0" max="100" value="0" style="width:100%; accent-color: #3b82f6;">
                            <div style="font-size:0.8rem; color:#64748b;">Reduces susceptible population.</div>
                        </div>

                        <!-- Masks -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:0.5rem;">
                                <span>Mask Usage</span>
                                <span id="val-mask">0%</span>
                            </label>
                            <input type="range" id="range-mask" min="0" max="100" value="0" style="width:100%; accent-color: #10b981;">
                            <div style="font-size:0.8rem; color:#64748b;">Reduces transmission probability.</div>
                        </div>

                        <!-- Distancing -->
                        <div style="margin-bottom: 0;">
                            <label style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:0.5rem;">
                                <span>Social Distancing</span>
                                <span id="val-dist">Normal</span>
                            </label>
                            <input type="range" id="range-dist" min="0" max="3" step="1" value="0" style="width:100%; accent-color: #f59e0b;">
                            <div style="font-size:0.8rem; color:#64748b;">Reduces contact rate.</div>
                        </div>
                    </div>

                    <!-- Visual Output -->
                    <div style="flex: 0 0 280px; background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                        <h4 style="margin-top:0; color:#334155;">Reproduction Number (<span style="font-style:italic;">R</span>)</h4>
                        
                        <div style="position:relative; height: 120px; display:flex; align-items:flex-end; justify-content:center; margin-bottom: 1rem;">
                            <!-- Bar Background -->
                            <div style="width: 40px; height: 100%; background: #f1f5f9; border-radius: 20px; position: relative; overflow: hidden;">
                                <!-- Fill -->
                                <div id="r-bar" style="position:absolute; bottom:0; left:0; right:0; height: 100%; background: #ef4444; transition: height 0.3s, background 0.3s;"></div>
                                <!-- Line at 1.0 -->
                                <div style="position:absolute; bottom: 25%; left: -5px; right: -5px; border-top: 2px dashed #334155; z-index: 2;"></div>
                            </div>
                            <div style="position:absolute; bottom: 25%; right: 70px; font-size: 0.8rem; font-weight:bold; color: #334155;">Target < 1.0</div>
                        </div>

                        <div id="r-value" style="font-size: 3.5rem; font-weight: 800; line-height: 1; color: #ef4444; transition: color 0.3s;">4.00</div>
                        <div style="font-size: 0.9rem; color: #64748b; margin-top: 0.5rem;">Starting Râ‚€ = 4.0</div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML = html;

        // Logic
        const ranges = {
            vac: document.getElementById('range-vac'),
            mask: document.getElementById('range-mask'),
            dist: document.getElementById('range-dist')
        };
        const displays = {
            vac: document.getElementById('val-vac'),
            mask: document.getElementById('val-mask'),
            dist: document.getElementById('val-dist'),
            r: document.getElementById('r-value'),
            bar: document.getElementById('r-bar'),
            status: document.getElementById('sim-status')
        };

        const R0 = 4.0;
        const distLabels = ["Normal", "Limit Groups", "Stay Home", "Lockdown"];
        // Distancing Factors: 1.0, 0.7, 0.4, 0.1 (Contact reduction)
        const distFactors = [1.0, 0.7, 0.4, 0.1];

        const update = () => {
            const vRate = parseInt(ranges.vac.value) / 100;
            const mRate = parseInt(ranges.mask.value) / 100;
            const dIdx = parseInt(ranges.dist.value);

            displays.vac.textContent = `${(vRate * 100).toFixed(0)}%`;
            displays.mask.textContent = `${(mRate * 100).toFixed(0)}%`;
            displays.dist.textContent = distLabels[dIdx];

            // Formula: R = R0 * (1 - VaccineEff * Coverage) * (1 - MaskEff * Usage) * DistFactor
            // Assumptions: Vaccine is 90% effective, Masks are 50% effective (community)
            const rEff = R0 * (1 - (0.9 * vRate)) * (1 - (0.5 * mRate)) * distFactors[dIdx];

            displays.r.textContent = rEff.toFixed(2);

            // Visual Updates
            // Max height is R=4.0 (100%). Target is 1.0 (25%)
            let hPct = (rEff / 4.0) * 100;
            if (hPct > 100) hPct = 100;
            if (hPct < 5) hPct = 5;
            displays.bar.style.height = `${hPct}%`;

            if (rEff < 1.0) {
                displays.r.style.color = "#10b981"; // Green
                displays.bar.style.background = "#10b981";
                displays.status.textContent = "OUTBREAK CONTROLLED";
                displays.status.style.color = "#10b981";
            } else {
                displays.r.style.color = "#ef4444"; // Red
                displays.bar.style.background = "#ef4444";
                displays.status.textContent = "EXPONENTIAL GROWTH";
                displays.status.style.color = "#ef4444";
            }
        };

        Object.values(ranges).forEach(r => r.addEventListener('input', update));
    },

    // ------------------------------------------
    // Wheel of Causation (Interactive)
    // ------------------------------------------
    renderWheelOfCausation: function (containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const html = `
            <div class="wheel-widget neo-card" style="padding: 2rem; text-align: center;">
                 <h3 style="color:var(--navy-primary); margin-bottom: 2rem; font-weight: 800; font-size: 1.5rem;">Interactive Wheel of Causation</h3>
                 
                 <div style="display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap: 3rem;">
                    
                    <!-- SVG Wheel -->
                    <div style="flex: 0 0 320px;">
                        <svg viewBox="0 0 320 320" style="filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); cursor:pointer;">
                            <defs>
                                <filter id="glow-wheel" x="-20%" y="-20%" width="140%" height="140%">
                                    <feGaussianBlur stdDeviation="3" result="blur"/>
                                    <feComposite in="SourceGraphic" in2="blur" operator="over"/>
                                </filter>
                            </defs>
                            
                            <!-- Outer Ring Segments (Environment) -->
                            <!-- Physical (Top Left) -->
                            <path d="M160,160 L160,10 A150,150 0 0,0 30,85 Z" fill="#93c5fd" stroke="white" stroke-width="2" 
                                  class="wheel-slice" id="slice-physical" onclick="VisualComponents.updateWheel('physical')" role="button" tabindex="0"/>
                            <text x="90" y="80" font-weight="900" font-size="11" fill="#1e3a8a" transform="rotate(-45, 90, 80)">PHYSICAL</text>
                            
                             <!-- Biologic (Right) -->
                            <path d="M160,160 L160,10 A150,150 0 0,1 290,235 L160,160 Z" fill="#86efac" stroke="white" stroke-width="2" 
                                  class="wheel-slice" id="slice-biologic" onclick="VisualComponents.updateWheel('biologic')" role="button" tabindex="0"/>
                            <text x="230" y="100" font-weight="900" font-size="11" fill="#14532d" transform="rotate(45, 230, 100)">BIOLOGICAL</text>

                            <!-- Social (Bottom Left) -->
                            <path d="M160,160 L290,235 A150,150 0 0,1 30,85 L160,160 Z" fill="#fca5a5" stroke="white" stroke-width="2" 
                                  class="wheel-slice" id="slice-social" onclick="VisualComponents.updateWheel('social')" role="button" tabindex="0"/>
                            <text x="130" y="260" font-weight="900" font-size="11" fill="#7f1d1d">SOCIAL ENV.</text>

                            <!-- Core (Host) -->
                            <circle cx="160" cy="160" r="50" fill="#fde047" stroke="white" stroke-width="3" 
                                    class="wheel-slice" id="slice-host" onclick="VisualComponents.updateWheel('host')" role="button" tabindex="0"/>
                            <text x="160" y="160" text-anchor="middle" font-weight="900" font-size="13" fill="#854d0e" dy="5">HOST</text>
                        </svg>
                    </div>

                    <!-- Info Panel -->
                    <div id="wheel-info" role="status" aria-live="polite" style="flex: 1; min-width: 250px; text-align: left; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                        <h4 style="margin-top:0; color:#334155; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.75rem; font-weight: 800; font-size: 1.1rem;">The Wheel Model</h4>
                        <p style="color: #475569; font-size: 1rem; line-height: 1.6; font-weight: 500;">Click on any section of the wheel to understand its role in multi-factorial causation.</p>
                    </div>

                 </div>
            </div>
        `;
        container.innerHTML = html;

        // Add keyboard support
        container.querySelectorAll('.wheel-slice').forEach(el => {
            el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    el.click();
                }
            });
        });
    },

    updateWheel: function (type) {
        const info = document.getElementById('wheel-info');
        if (!info) return;

        const content = {
            host: {
                title: "The Core: The Genetically Determined Host",
                bg: "#fef9c3",
                color: "#ca8a04",
                body: "<p>The central hub. Includes genetic makeup, immunity, and intrinsic factors. The wheel model emphasizes that the host interacts with <strong>all</strong> environmental sectors simultaneously.</p>"
            },
            physical: {
                title: "Physical Environment",
                bg: "#eff6ff",
                color: "#1d4ed8",
                body: "<p>Non-living external factors:</p><ul><li>Pollution & Air Quality</li><li>Geography & Climate</li><li>Housing & Urban Design</li><li>Water Sanitation</li></ul>"
            },
            biologic: {
                title: "Biological Environment",
                bg: "#f0fdf4",
                color: "#15803d",
                body: "<p>Living external factors contributing to disease:</p><ul><li>Infectious Agents (Viruses, Bacteria)</li><li>Vectors (Mosquitoes)</li><li>Reservoirs (Animals)</li><li>Flora & Fauna</li></ul>"
            },
            social: {
                title: "Social Environment",
                bg: "#fef2f2",
                color: "#b91c1c",
                body: "<p>The #1 determinant for many chronic diseases:</p><ul><li>Socioeconomic Status (Poverty)</li><li>Culture & Lifestyle</li><li>Stress & Political Stability</li><li>Healthcare Access</li></ul>"
            }
        };

        const data = content[type];

        // Animate
        info.style.opacity = '0.5';
        setTimeout(() => {
            info.style.background = data.bg;
            info.style.borderColor = data.color;
            info.innerHTML = `
                <h4 style="margin-top:0; color:${data.color}; border-bottom: 1px solid ${data.color}40; padding-bottom: 0.5rem;">${data.title}</h4>
                <div style="font-size: 0.95rem; color: #334155;">${data.body}</div>
             `;
            info.style.opacity = '1';
        }, 150);

        // Highlight
        document.querySelectorAll('.wheel-slice').forEach(el => {
            el.style.opacity = '0.6';
            el.style.strokeWidth = '2';
            el.setAttribute('aria-pressed', 'false');
        });
        const active = document.getElementById(`slice-${type}`);
        if (active) {
            active.style.opacity = '1';
            active.style.strokeWidth = '4';
            active.setAttribute('aria-pressed', 'true');
        }
    }
};


/**
 * Epidemic Engine Navigation System
 * Handles sidebar navigation and dynamic content loading
 */

const APP_VERSION = 'v2.4.0';

document.addEventListener('DOMContentLoaded', () => {
    // console.log(`[EPIDEMIC ENGINE] Initializing ${APP_VERSION}...`);

    // Setup navigation
    setupNavigation();

    // History API Integration: Handle initial load based on URL hash
    const hash = window.location.hash.slice(1); // Remove '#'
    const initialChapter = hash || 'welcome';

    // Load initial content (don't push state for initial load)
    loadChapter(initialChapter, false);

    // History API Integration: Handle Back/Forward buttons
    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.chapter) {
            loadChapter(event.state.chapter, false);
        } else {
            // Fallback for hash-only navigation or empty state
            const currentHash = window.location.hash.slice(1);
            loadChapter(currentHash || 'welcome', false);
        }
    });

    // Initialize UI Helpers
    window.UI = {
        toast: function (msg, type = 'info') {
            const el = document.createElement('div');
            el.className = `neo-toast ${type}`;
            el.innerHTML = `<i class="ph-bold ${type === 'success' ? 'ph-check' : 'ph-info'}"></i> ${msg}`;
            document.body.appendChild(el);
            setTimeout(() => el.classList.add('show'), 10);
            setTimeout(() => {
                el.classList.remove('show');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        },
        modal: function (title, msg, onConfirm) {
            const overlay = document.createElement('div');
            overlay.className = 'neo-modal-overlay';
            overlay.innerHTML = `
                <div class="neo-modal">
                    <div class="neo-modal-header">
                        <h3>${title}</h3>
                        <button class="neo-btn icon-only" onclick="this.closest('.neo-modal-overlay').remove()"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <div class="neo-modal-body">${msg}</div>
                    <div class="neo-modal-footer">
                        <button class="neo-btn outline" onclick="this.closest('.neo-modal-overlay').remove()">Cancel</button>
                        <button class="neo-btn primary" id="neo-modal-confirm">Confirm</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            setTimeout(() => overlay.classList.add('show'), 10);

            document.getElementById('neo-modal-confirm').addEventListener('click', () => {
                onConfirm();
                overlay.classList.remove('show');
                setTimeout(() => overlay.remove(), 300);
            });
        }
    };
    // Service Worker Registration
    if ('serviceWorker' in navigator && (window.location.protocol === 'http:' || window.location.protocol === 'https:')) {
        navigator.serviceWorker.register('sw.js')
            .then(reg => { }) // console.log('[ServiceWorker] Registered', reg))
            .catch(err => console.error('[ServiceWorker] Failed', err));
    }
});

function setupNavigation() {
    const navItems = document.querySelectorAll('.nav-item');

    // Coach Mode Visibility
    const isCoach = new URLSearchParams(window.location.search).get('coach') === '1';
    if (isCoach) {
        document.querySelectorAll('.coach-only').forEach(el => el.style.display = 'block');
        document.body.classList.add('coach-mode');
    }

    navItems.forEach(item => {
        item.addEventListener('click', () => {
            // Remove active class and aria-current from all items
            navItems.forEach(nav => {
                nav.classList.remove('active');
                nav.removeAttribute('aria-current');
            });

            // Add active class and aria-current to clicked item
            item.classList.add('active');
            item.setAttribute('aria-current', 'page');

            // Load chapter content
            const chapterId = item.getAttribute('data-chapter');
            loadChapter(chapterId);

            // Close mobile menu if open (Architecture fix for mobile UX)
            const sidebar = document.getElementById('sidebar');
            if (sidebar && sidebar.classList.contains('open')) {
                window.toggleMobileMenu(false); // Use function to sync ARIA state
            }
        });
    });
}

function loadChapter(chapterId, updateHistory = true) {
    // Safeguard: Prevent accidental exit from active quiz
    // Safeguard: Auto-save active quiz if navigating away
    if (window.currentQuizEngine && !window.currentQuizEngine.isComplete) {
        if (typeof window.currentQuizEngine.saveLocalProgress === 'function') {
            window.currentQuizEngine.saveLocalProgress();
            // Optional: Toast notification that "Progress Saved"
            if (window.UI) window.UI.toast("Quiz progress saved in background.", "info");
        }
        window.currentQuizEngine = null; // Clear active state
    }

    // Alias home to welcome
    if (chapterId === 'home') chapterId = 'welcome';

    // console.log('[EPIDEMIC ENGINE] Loading chapter:', chapterId);

    // History API Integration: Update URL and History Stack
    if (updateHistory) {
        history.pushState({ chapter: chapterId }, '', `#${chapterId}`);
    }

    // Update Active Nav State (Synchronize sidebar with history)
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(nav => {
        // Handle both 'home' and 'welcome' data-chapter attributes for the home button
        const targetAttr = nav.getAttribute('data-chapter');
        if (targetAttr === chapterId || (chapterId === 'welcome' && targetAttr === 'home')) {
            nav.classList.add('active');
            nav.setAttribute('aria-current', 'page');
        } else {
            nav.classList.remove('active');
            nav.removeAttribute('aria-current');
        }
    });

    if (window.AnalyticsManager) window.AnalyticsManager.logChapterView(chapterId);

    const container = document.getElementById('content-container');

    // Load chapter content
    let content = getChapterContent(chapterId);
    container.innerHTML = content;

    // Rules Compliance Integration (Pedagogical Architecture)
    if (window.RulesEngine) {
        const badges = window.RulesEngine.renderBadges(chapterId);
        if (badges) {
            const h1 = container.querySelector('h1');
            if (h1) {
                h1.insertAdjacentHTML('afterend', badges);
            } else {
                container.insertAdjacentHTML('afterbegin', badges);
            }
        }
    }

    // Initialize Interactive Visuals (Phase 2 Audits)
    // HTML5 Security blocks innerHTML script execution, so we init manually here.
    // Initialize Interactive Visuals (Phase 2 Audits)
    // HTML5 Security blocks innerHTML script execution, so we init manually here.
    setTimeout(() => {
        if (typeof VisualComponents !== 'undefined') {
            const triadRoot = document.getElementById('triad-interactive-root');
            if (triadRoot) {
                // console.log('[EPIDEMIC ENGINE] Rendering Triad...');
                try {
                    VisualComponents.renderTriad('triad-interactive-root');
                } catch (e) { console.error('Triad Render Error:', e); }
            }

            const simRoot = document.getElementById('control-sim-root');
            if (simRoot) {
                // console.log('[EPIDEMIC ENGINE] Rendering Control Simulator...');
                try {
                    VisualComponents.renderControlSimulator('control-sim-root');
                } catch (e) { console.error('Sim Render Error:', e); }
            }
        } else {
            console.warn('[EPIDEMIC ENGINE] VisualComponents not loaded.');
        }
    }, 50);

    // Auto-Navigation: Add Next Button
    const activeNav = document.querySelector(`.nav-item[data-chapter="${chapterId}"]`);
    if (activeNav) {
        // Find next visible nav item (skipping hidden coach items if not coach)
        const allNavs = Array.from(document.querySelectorAll('.nav-item'));
        const currentIndex = allNavs.indexOf(activeNav);

        if (currentIndex > -1 && currentIndex < allNavs.length - 1) {
            const nextNav = allNavs[currentIndex + 1];
            // Ensure next item is not hidden (e.g. coach resources if not coach)
            // Note: Don't use offsetParent because sidebar might be hidden on mobile!
            const isHidden = nextNav.style.display === 'none' || nextNav.classList.contains('hidden');

            if (nextNav && !isHidden) {
                const nextId = nextNav.getAttribute('data-chapter');
                const nextTitle = nextNav.textContent.trim();

                const nextBtnHtml = `
                    <div style="margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid #eee; display: flex; justify-content: flex-end;">
                        <button class="neo-btn primary" onclick="document.querySelector('.nav-item[data-chapter=\\'${nextId}\\']').click()">
                            Next: ${nextTitle} <i class="ph-bold ph-arrow-right"></i>
                        </button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', nextBtnHtml);
            }
        }
    }

    // Setup accordions after content loads
    setTimeout(() => setupAccordions(), 100);

    // Initialize tools if drills chapter
    if (chapterId === 'drills') {
        setTimeout(() => {
            if (window.TOOLS_MANAGER) {
                window.TOOLS_MANAGER.init();
            } else {
                console.warn('[EPIDEMIC ENGINE] TOOLS_MANAGER not found, retrying...');
                setTimeout(() => {
                    if (window.TOOLS_MANAGER) window.TOOLS_MANAGER.init();
                }, 500);
            }
        }, 100);
    }

    // Initialize Interactive Scenarios
    if (chapterId === 'interactive_scenarios' && window.ScenarioEngine) {
        setTimeout(() => window.ScenarioEngine.init('interactive-cases-root'), 100);
    }

    // Initialize Home Dashboard
    if (chapterId === 'welcome' && window.HomeDashboard) {
        setTimeout(() => window.HomeDashboard.init('home-root'), 100);
    }




    // Initialize Glossary if appendix-g
    if (chapterId === 'appendix-g' && window.appendixEngine) {
        setTimeout(() => window.appendixEngine.initGlossary('glossary-root'), 100);
    }

    // Initialize Flashcards if appendix-f
    if (chapterId === 'appendix-f' && window.appendixEngine) {
        setTimeout(() => window.appendixEngine.initFlashcards('flashcard-root'), 100);
    }

    // Initialize My Progress
    if (chapterId === 'my_progress' && window.AnalyticsManager) {
        setTimeout(() => {
            const history = window.AnalyticsManager.getHistory();
            const container = document.getElementById('analytics-history-list');
            if (container) {
                if (history.length === 0) {
                    container.innerHTML = '<p style="color: #666; font-style: italic;">No quizzes taken yet.</p>';
                } else {
                    container.innerHTML = history.map(h => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding: 0.75rem 0; border-bottom: 1px solid #eee;">
                            <div>
                                <strong>${h.quizId.replace(/_/g, ' ').toUpperCase()}</strong>
                                <div style="font-size:0.8rem; color:#666;">${new Date(h.timestamp).toLocaleDateString()} ${new Date(h.timestamp).toLocaleTimeString()}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:bold; font-size:1.1rem; color: ${h.percent >= 80 ? '#22c55e' : (h.percent >= 60 ? '#f59e0b' : '#ef4444')}">
                                    ${h.score}/${h.maxScore}
                                </div>
                                <div style="font-size:0.8rem; color:#666;">${h.percent}%</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            // Attach Clear History Listener
            const clearBtn = document.getElementById('clear-history-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (typeof window.UI !== 'undefined') {
                        window.UI.modal('Clear History?', 'Are you sure you want to delete all progress? This cannot be undone.', () => {
                            window.AnalyticsManager.reset();
                            location.reload();
                        });
                    } else if (confirm('Clear all history?')) {
                        window.AnalyticsManager.reset();
                        location.reload();
                    }
                });
            }
        }, 100);
    }

    // Initialize Case Library with category grouping and interactive details
    // Initialize Case Library with expanded exam features
    if (chapterId === 'case_library' && typeof CASE_LIBRARY !== 'undefined') {
        setTimeout(() => {
            const container = document.getElementById('case-library-container');
            if (!container) return;

            // Classification helper (Expanded)
            const getCategory = (c) => {
                const idStr = c.id.toString();
                if (idStr === 'C_Special' || idStr === 'C40') return 'Special Concepts';

                const idNum = parseInt(idStr.replace('C', ''));
                if (!isNaN(idNum)) {
                    if (idNum <= 15) return 'Food & Waterborne';
                    if (idNum <= 25) return 'Vector & Zoonotic';
                    if (idNum <= 32) return 'Respiratory';
                    if (idNum <= 39) return 'Other & Bioterror';
                    return 'Other';
                }
                return 'Other';
            };

            // Group cases
            const categories = {};
            CASE_LIBRARY.forEach((c, idx) => {
                const cat = getCategory(c);
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push({ c, idx });
            });

            // Build HTML
            let html = '';
            const catOrder = ['Food & Waterborne', 'Vector & Zoonotic', 'Respiratory', 'Other & Bioterror', 'Special Concepts', 'Other'];

            catOrder.forEach(cat => {
                if (!categories[cat] || categories[cat].length === 0) return;
                html += `<h2 style="color: var(--accent-purple); margin-top: 2rem; border-bottom: 2px solid #eee; padding-bottom: 0.5rem;"><i class="ph-bold ph-files"></i> ${cat}</h2>`;
                if (cat === 'Food & Waterborne') {
                    html += `<p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                        <strong>Exam Tip:</strong> Foodborne outbreaks are the #1 most common exam topic. Master the "classic" pathogens (Salmonella, Norovirus, Staph aureus) below.
                    </p>`;
                }
                html += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; margin-top: 1rem;">`;

                categories[cat].forEach(({ c, idx }) => {
                    const objectivesHtml = c.learning_objectives ?
                        `<ul style="font-size: 0.85rem; margin-top: 0.5rem; color: #555; padding-left: 1.2rem;">${c.learning_objectives.map(o => `<li>${o}</li>`).join('')}</ul>` : '';

                    html += `
                    <div class="neo-card" style="border: 1px solid #ddd; display: flex; flex-direction: column;">
                        <div style="flex: 1;">
                            <div style="display:flex; justify-content:space-between; align-items: flex-start;">
                                <h3 style="margin: 0; color: var(--navy-primary); font-size: 1.2rem;">${c.title}</h3>
                                <span class="neo-badge small" style="background:#f3f4f6; flex-shrink:0;">${c.id}</span>
                            </div>
                            <div style="font-size: 0.95rem; color: #444; margin: 0.75rem 0; line-height: 1.5;">${c.scenario_text || c.description || 'No scenario available.'}</div>
                            
                            ${objectivesHtml ? `
                            <div style="background: #f9fafb; padding: 0.5rem; border-radius: 4px; border-left: 3px solid var(--accent-blue);">
                                <strong style="font-size: 0.8rem; text-transform: uppercase; color: var(--accent-blue);">Objectives:</strong>
                                ${objectivesHtml}
                            </div>` : ''}
                        </div>
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #ccc;">
                            <button class="neo-btn small outline full-width" onclick="window.toggleCaseDetails(${idx})">
                                <i class="ph-bold ph-student"></i> Study Case
                            </button>
                        </div>
                        
                        <div id="case-details-${idx}" style="display: none; margin-top: 1rem; border-top: 2px solid var(--accent-orange); padding-top: 1rem; animation: fadeIn 0.3s ease;">
                            <div style="text-align:center; margin-bottom:1rem;">
                                <span class="neo-badge" style="background: var(--accent-orange); color: black; font-weight:bold; font-size: 1rem;">${c.disease}</span>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem; margin-bottom: 1rem; background:#f5f7fa; padding:0.5rem; border-radius:4px;">
                                <div><strong>Agent:</strong><br>${c.agent}</div>
                                <div><strong>Incubation:</strong><br>${c.incubation}</div>
                                <div><strong>Curve:</strong><br>${c.curve}</div>
                                <div><strong>Transmission:</strong><br>${c.transmission}</div>
                            </div>

                            ${c.spot_map ? `
                            <div style="margin-bottom: 1rem; font-size: 0.9rem;">
                                <strong style="color:var(--navy-primary);"><i class="ph-bold ph-map-pin"></i> Spot Map Pattern:</strong>
                                <div style="background: #fff; border: 1px solid #eee; padding: 0.5rem; border-radius: 4px; border-left: 2px solid #ef4444; margin-top:0.25rem;">${c.spot_map}</div>
                            </div>` : ''}

                            ${c.counterfactual ? `
                            <div style="margin-bottom: 1rem; font-size: 0.9rem;">
                                <strong style="color:var(--navy-primary);"><i class="ph-bold ph-arrows-merge"></i> Counterfactual ("What If"):</strong>
                                <div style="background: #fff; border: 1px solid #eee; padding: 0.5rem; border-radius: 4px; border-left: 2px solid #3b82f6; font-style: italic; margin-top:0.25rem;">${c.counterfactual}</div>
                            </div>` : ''}

                             ${c.questions ? `
                            <div style="margin-top: 1rem;">
                                <strong><i class="ph-bold ph-question"></i> Discussion:</strong>
                                ${c.questions.map(q => `
                                    <div style="margin-top: 0.5rem; font-size: 0.9rem; border-bottom:1px dotted #eee; padding-bottom:0.5rem;">
                                        <div style="font-weight:600; color:#333;">Q: ${q.q}</div>
                                        <div style="color: var(--accent-green); margin-top: 0.25rem;">A: ${q.a}</div>
                                    </div>
                                `).join('')}
                            </div>` : ''}
                        </div>
                    </div>
                    `;
                });
                html += `</div>`;
            });

            container.innerHTML = html;

            // Toggle logic
            window.toggleCaseDetails = function (index) {
                const details = document.getElementById(`case-details-${index}`);
                const btn = details ? details.parentElement.parentElement.querySelector('button') : null;
                if (!details) return;

                if (details.style.display === 'none') {
                    details.style.display = 'block';
                    if (btn) { btn.classList.add('secondary'); btn.innerHTML = '<i class="ph-bold ph-x"></i> Close Case'; }
                } else {
                    details.style.display = 'none';
                    if (btn) { btn.classList.remove('secondary'); btn.innerHTML = '<i class="ph-bold ph-student"></i> Study Case'; }
                }
            };
        }, 100);
    }

    // Initialize Interactive Scenarios
    if (chapterId === 'interactive_scenarios') {
        setTimeout(() => {
            if (window.ScenarioEngine) {
                window.ScenarioEngine.init();
            }
        }, 100);
    }

    // Initialize Appendix
    if (chapterId === 'appendix' && typeof APPENDIX_DATA !== 'undefined') {
        setTimeout(() => {
            // Render Rules
            const rulesContainer = document.getElementById('rules-container');
            if (rulesContainer) {
                rulesContainer.innerHTML = APPENDIX_DATA.RULES.map((r, idx) => `
                    <div class="neo-card small" style="margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s;" 
                         onclick="const el = document.getElementById('rule-detail-${idx}'); const icon = this.querySelector('.chevron'); 
                                  if(el.style.display==='none'){el.style.display='block'; icon.style.transform='rotate(180deg)';} 
                                  else {el.style.display='none'; icon.style.transform='rotate(0deg)';}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="font-size: 1.05rem;">${r[0]}</strong>
                                <div style="margin-top: 0.25rem;">
                                    ${r[1].map(tag => `<span class="neo-badge small" style="opacity:0.8; font-size:0.75rem;">${tag}</span>`).join(' ')}
                                </div>
                            </div>
                            <i class="ph-bold ph-caret-down chevron" style="transition: transform 0.2s;"></i>
                        </div>
                        <div id="rule-detail-${idx}" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #ccc; font-size: 0.95rem; line-height: 1.5; color: #333; animation: fadeIn 0.2s;">
                            ${r[2] || "No detailed description available."}
                        </div>
                    </div>
                `).join('');
            }

            // Color Palette for Cycling
            const PALETTE = ['var(--accent-blue)', 'var(--accent-orange)', 'var(--accent-green)', 'var(--accent-purple)', 'var(--accent-pink)'];
            const BG_PALETTE = ['#eff6ff', '#fff7ed', '#f0fdf4', '#faf5ff', '#fdf2f8']; // Matches tailwind 50s
            const BORDER_PALETTE = ['#bfdbfe', '#fed7aa', '#bbf7d0', '#e9d5ff', '#fbcfe8']; // Matches tailwind 200s

            // Render Biases
            const biasesContainer = document.getElementById('biases-container');
            if (biasesContainer) {
                biasesContainer.innerHTML = APPENDIX_DATA.BIASES.map((b, idx) => {
                    const color = PALETTE[idx % PALETTE.length];
                    const bg = BG_PALETTE[idx % BG_PALETTE.length];
                    const border = BORDER_PALETTE[idx % BORDER_PALETTE.length];

                    return `
                    <div class="neo-card small" style="border-left: 4px solid ${color};">
                        <strong style="color: ${color}; display: block; margin-bottom: 0.5rem; font-size: 1.1rem;">${b[0]}</strong>
                        <p style="font-size: 0.95rem; margin-bottom: 0.75rem;">${b[1]}</p>
                        <div style="font-size: 0.85rem; color: #444; background: ${bg}; padding: 0.5rem; border-radius: 4px; border: 1px solid ${border};">
                            <i class="ph-bold ph-shield-check" style="color: ${color}; margin-right: 4px;"></i> 
                            <strong>Fix:</strong> ${b[2]}
                        </div>
                    </div>
                `}).join('');
            }

            // Initialize Glossary and Flashcards if engine exists
            if (window.appendixEngine) {
                if (chapterId === 'appendix') {
                    window.appendixEngine.initGlossary('glossary-root');
                    window.appendixEngine.initFlashcards('flashcard-root');
                }
                if (chapterId === 'appendix-g') {
                    window.appendixEngine.initGlossary('glossary-root');
                }
                if (chapterId === 'appendix-f') {
                    window.appendixEngine.initFlashcards('flashcard-root');
                }
            }

            // Render Mnemonics
            const mnemsContainer = document.getElementById('mnemonics-container');
            if (mnemsContainer) {
                mnemsContainer.innerHTML = APPENDIX_DATA.MNEMS.map((m, idx) => {
                    const color = PALETTE[(idx + 2) % PALETTE.length]; // Offset start for variety

                    return `
                    <div class="neo-card" style="margin-bottom: 1rem; border-left: 4px solid ${color};">
                        <h3 style="color: ${color}; margin-bottom: 0.5rem;">${m[0]}</h3>
                        <p style="font-size: 1.1rem;">${m[1]}</p>
                    </div>
                `}).join('');
            }

            // Render Resources
            const resourcesContainer = document.getElementById('resources-container');
            if (resourcesContainer && APPENDIX_DATA.RESOURCES) {
                resourcesContainer.innerHTML = APPENDIX_DATA.RESOURCES.map(r => `
                    <div class="neo-card small" style="display: flex; flex-direction: column; justify-content: space-between;">
                        <div>
                            <strong style="font-size: 1.1rem; display: block; margin-bottom: 0.5rem;">${r.title}</strong>
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">${r.desc}</p>
                        </div>
                        <a href="${r.url}" target="_blank" class="neo-btn small secondary" style="text-align: center; text-decoration: none;">
                            <i class="ph-bold ph-arrow-square-out"></i> Visit Site
                        </a>
                    </div>
                `).join('');
            }

            // Define showTab globally if not already
            window.showTab = function (tabId) {
                // console.log('[SHOWTAB] Called with tabId:', tabId);

                document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
                const tabContent = document.getElementById(tabId);
                if (tabContent) {
                    tabContent.style.display = 'block';
                }

                document.querySelectorAll('.neo-btn.small').forEach(el => el.classList.remove('active'));
                if (event && event.target && event.target.classList.contains('neo-btn')) {
                    event.target.classList.add('active');
                }

                // Initialize flashcards when flashcards tab is clicked
                if (tabId === 'flashcards' && window.appendixEngine) {
                    // console.log('[SHOWTAB] Initializing flashcards...');
                    setTimeout(() => {
                        window.appendixEngine.initFlashcards('flashcard-root');
                    }, 50);
                }

                // Initialize glossary when glossary tab is clicked
                if (tabId === 'glossary' && window.appendixEngine) {
                    // console.log('[SHOWTAB] Initializing glossary...');
                    setTimeout(() => {
                        window.appendixEngine.initGlossary('glossary-root');
                    }, 50);
                }

                // Initialize formulas when formulas tab is clicked
                if (tabId === 'formulas' && window.appendixEngine) {
                    // console.log('[SHOWTAB] Initializing formulas...');
                    setTimeout(() => {
                        window.appendixEngine.initFormulas('formulas-root');
                    }, 50);
                }

                // Initialize tables when tables tab is clicked
                if (tabId === 'tables' && window.appendixEngine) {
                    // console.log('[SHOWTAB] Initializing tables...');
                    setTimeout(() => {
                        window.appendixEngine.initTables('tables-root');
                    }, 50);
                }

                // Initialize logic when logic tab is clicked
                if (tabId === 'logic' && window.appendixEngine) {
                    setTimeout(() => {
                        window.appendixEngine.initLogic('logic-root');
                    }, 50);
                }
            };
        }, 100);
    }

    // Auto-Resume Logic for Quizzes
    if (window.startQuiz) {
        let resumeQuizId = null;
        if (chapterId === 'quiz_part1') resumeQuizId = 'part1';
        if (chapterId === 'quiz_part2') resumeQuizId = 'part2';
        if (chapterId === 'quiz_part3') resumeQuizId = 'part3';

        if (resumeQuizId) {
            const saved = localStorage.getItem('quiz_progress_' + resumeQuizId);
            if (saved) {
                // Check if not complete
                try {
                    const parsed = JSON.parse(saved);
                    if (!parsed.isComplete) {
                        setTimeout(() => window.startQuiz(resumeQuizId), 50);
                    }
                } catch (e) { console.error('Error parsing quiz progress to resume', e); }
            }
        }
    }

    // Auto-Resume Logic for Simulations
    if (chapterId === 'simulation' && window.startSimulationExam) {
        // Check for any active simulation exam
        for (let i = 1; i <= 4; i++) {
            const key = 'quiz_progress_sim_exam_' + i; // Assuming ID format used by simulation
            const saved = localStorage.getItem(key);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (!parsed.isComplete) {
                        // Found an active exam, resume it
                        setTimeout(() => window.startSimulationExam(i), 50);
                        break; // Resume the first one found (or we could track timestamp for most recent)
                    }
                } catch (e) { }
            }
        }
    }

    // Scroll to top
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
        mainContent.scrollTop = 0;
    }
}

function getChapterContent(chapterId) {
    // Alias home to welcome
    if (chapterId === 'home') chapterId = 'welcome';

    // Load from content management system
    if (window.EPIDEMIC_ENGINE_CONTENT && window.EPIDEMIC_ENGINE_CONTENT[chapterId]) {
        return window.EPIDEMIC_ENGINE_CONTENT[chapterId].content;
    }

    // Fallback for undefined chapters
    return `
        <h1>Content In Development</h1>
        <p class="lead">This chapter is currently being developed.</p>
        
        <div class="study-tip">
            <div class="callout-header">
                <i class="ph ph-info"></i>
                Coming Soon
            </div>
            <div class="callout-content">
                <p>This chapter will include comprehensive coverage with:</p>
                <ul>
                    <li>Detailed explanations</li>
                    <li>Real-world examples</li>
                    <li>Exam tips and traps</li>
                    <li>Practice problems</li>
                </ul>
            </div>
        </div>
    `;
}

// Setup accordion functionality
// Setup accordion functionality with accessibility
function setupAccordions() {
    const accordionHeaders = document.querySelectorAll('.accordion-header');

    accordionHeaders.forEach(header => {
        // Accessibility attributes
        header.setAttribute('role', 'button');
        header.setAttribute('tabindex', '0');
        if (!header.hasAttribute('aria-expanded')) {
            header.setAttribute('aria-expanded', 'false');
        }

        // Remove existing listeners to avoid duplicates
        const newHeader = header.cloneNode(true);
        header.parentNode.replaceChild(newHeader, header);

        const toggle = () => {
            const isActive = newHeader.classList.toggle('active');
            newHeader.setAttribute('aria-expanded', isActive);

            const content = newHeader.nextElementSibling;
            if (content && content.classList.contains('accordion-content')) {
                content.classList.toggle('show');
            }
        };

        newHeader.addEventListener('click', toggle);

        // Keyboard support (Enter/Space)
        newHeader.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault(); // Prevent scrolling for Space
                toggle();
            }
        });
    });
}

// Make functions globally available
window.loadChapter = loadChapter;
window.setupAccordions = setupAccordions;

// Global functions for Quiz and Simulation
// Global functions for Quiz and Simulation
window.startQuiz = function (partId) {
    // console.log('Starting quiz for:', partId);

    // Check if new engine is loaded
    if (typeof QuizEngine === 'undefined') {
        console.error('QuizEngine not loaded. Please reloading or check build.');
        return;
    }

    // 1. Get Settings (Before wiping DOM)
    const diffSelect = document.getElementById('difficulty-' + partId);
    const difficulty = diffSelect ? diffSelect.value : 'balanced';

    // 2. Clear Screen for Full-Page Mode
    // This removes the Title, Intro Text, and Difficulty Selector
    const mainContainer = document.getElementById('content-container');
    if (!mainContainer) return;

    mainContainer.innerHTML = '<div id="quiz-fullscreen-root" style="height: 100%;"></div>';

    // Use centralized helper from QuizEngine
    const questions = QuizEngine.getQuestionsForPart(partId, difficulty);

    if (questions.length === 0) {
        console.error('No questions found for quiz:', partId);
        mainContainer.innerHTML = `
            <div class="alert alert-warning">
                <h3>No Questions Found</h3>
                <p>Could not load questions for difficulty: ${difficulty}</p>
                <button class="neo-btn outline" onclick="loadChapter('quiz_${partId}')">Go Back</button>
            </div>`;
        return;
    }

    // Initialize unified QuizEngine
    window.currentQuizEngine = new QuizEngine({
        quizId: partId, // Pass ID for analytics
        mode: 'practice',
        containerId: 'quiz-fullscreen-root', // Target new Clean Div
        questions: questions,
        timeLimit: null, // No strict timer for practice
        enableInstantFeedback: true, // Show explanation immediately after answer
        returnChapter: partId.startsWith('quiz_') ? partId : 'quiz_' + partId
    });
    window.currentQuizEngine.start();
};

window.startSimulation = function () {
    window.startSimulationExam(1);
};

// Start one of several simulation exams
window.startSimulationExam = function (examNumber) {
    // console.log('Starting simulation exam', examNumber);

    if (typeof QuizEngine === 'undefined') {
        console.error('QuizEngine not loaded');
        return;
    }

    // 1. Get Settings
    const diffSelect = document.getElementById('difficulty-sim');
    const difficulty = diffSelect ? diffSelect.value : 'balanced';

    // 2. Clear Screen for Full-Page Mode
    const mainContainer = document.getElementById('content-container');
    if (!mainContainer) return;

    mainContainer.innerHTML = '<div id="sim-fullscreen-root" style="height: 100%;"></div>';

    const { questions, boundaries } = QuizEngine.generateSimulation(difficulty);

    if (questions.length === 0) {
        if (typeof window.UI !== 'undefined') window.UI.toast("Failed to generate exam - check content data.", "error");
        else alert("Failed to generate exam - check content data.");

        // Restore content on failure
        loadChapter('simulation');
        return;
    }

    // Initialize unified QuizEngine in exam mode
    window.currentQuizEngine = new QuizEngine({
        quizId: 'simulation-' + examNumber, // Pass ID for analytics
        mode: 'simulation',
        containerId: 'sim-fullscreen-root', // Main container for exam
        questions: questions,
        sectionBoundaries: boundaries,
        timeLimit: 50 * 60, // 50 minutes
        returnChapter: 'simulation'
    });

    window.currentQuizEngine.start();
};

/* ================= RESPONSIVE NAV ================= */

window.toggleMobileMenu = function (forceState = null) {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    const btn = document.getElementById('mobile-menu-toggle');

    if (!sidebar) return;

    // Determine target state
    const isOpen = (forceState !== null) ? forceState : !sidebar.classList.contains('open');

    if (isOpen) {
        sidebar.classList.add('open');
        if (overlay) overlay.classList.add('active');
        sidebar.removeAttribute('aria-hidden');
        // Focus management: Trap focus (MVP: just focus first item)
        setTimeout(() => {
            const firstItem = sidebar.querySelector('.nav-item');
            if (firstItem) firstItem.focus();
        }, 100);
    } else {
        sidebar.classList.remove('open');
        if (overlay) overlay.classList.remove('active');
        sidebar.setAttribute('aria-hidden', 'true');
        // Return focus to toggle button
        if (btn) btn.focus();
    }

    if (btn) btn.setAttribute('aria-expanded', isOpen);
}

// Auto-close on nav click (mobile)
// Auto-close on nav click is handled in setupNavigation()
document.addEventListener('DOMContentLoaded', () => {
    // Menu Button Logic
    const menuBtn = document.getElementById('mobile-menu-toggle');
    if (menuBtn) {
        menuBtn.addEventListener('click', window.toggleMobileMenu);
    }
});

const INTERACTIVE_CASES_DATA = [

    // ========== MEGA-CASES (Advanced National-Level Scenarios) ==========

    {
        id: "MC1",
        title: "The School Cafeteria Outbreak",
        difficulty: "Advanced",
        description: "A multi-day outbreak at a middle school requires comprehensive epidemiological investigation including attack rate calculations, curve analysis, and control measures.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: Initial Report</h6><p>On Wednesday, the school nurse reports that 45 of 300 students who ate lunch on Monday developed nausea, vomiting, and diarrhea starting Tuesday morning. Most recovered within 24 hours.</p><p><strong>Calculate the Attack Rate.</strong></p>",
                options: [
                    { text: "AR = 15%", feedback: "Correct! 45/300 Ã— 100 = 15%", correct: true },
                    { text: "AR = 45%", feedback: "Incorrect. You need to divide cases by total exposed, not just count cases.", correct: false },
                    { text: "AR = 30%", feedback: "Incorrect. Check your calculation: 45/300.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Incubation Period</h6><p>Lunch was served Monday 12:00 PM. First case onset: Monday 11:00 PM (11 hours). Last case onset: Tuesday 2:00 PM (26 hours). Peak: Tuesday 8:00 AM (20 hours).</p><p><strong>Which pathogen fits this incubation period?</strong></p>",
                options: [
                    { text: "Staphylococcus aureus (1-6 hours)", feedback: "Incorrect. Too short.", correct: false },
                    { text: "Norovirus (12-48 hours)", feedback: "Correct! The 11-26 hour range with peak at 20 hours fits Norovirus perfectly.", correct: true },
                    { text: "Salmonella (6-72 hours, median 12-36)", feedback: "Possible, but Norovirus is more likely given the short duration and vomiting prominence.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: Food History</h6><p>Students who ate the chicken salad: 60 students, 40 ill (AR = 67%). Students who did NOT eat chicken salad: 240 students, 5 ill (AR = 2%).</p><p><strong>Calculate the Relative Risk (RR).</strong></p>",
                options: [
                    { text: "RR = 33.5", feedback: "Correct! RR = 67% / 2% = 33.5. Students who ate chicken salad were 33.5 times more likely to get sick.", correct: true },
                    { text: "RR = 2.0", feedback: "Incorrect. You may have reversed the calculation.", correct: false },
                    { text: "RR = 0.67", feedback: "Incorrect. Check the formula: AR_exposed / AR_unexposed.", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Control Measures</h6><p>Investigation reveals the chicken salad was left at room temperature for 3 hours before serving. A food handler was ill the previous week.</p><p><strong>What is the PRIMARY control measure?</strong></p>",
                options: [
                    { text: "Close the school for deep cleaning", feedback: "Incorrect. Norovirus outbreak is over; this is excessive.", correct: false },
                    { text: "Exclude ill food handlers, enforce time/temperature controls, and educate staff on proper food handling", feedback: "Correct! Multi-pronged approach addresses the source and prevents recurrence.", correct: true },
                    { text: "Administer antibiotics to all students", feedback: "Incorrect. Norovirus is viral; antibiotics don't work.", correct: false }
                ]
            }
        ]
    },

    {
        id: "MC2",
        title: "The Swimming Pool Cryptosporidiosis",
        difficulty: "Advanced",
        description: "A community pool outbreak requires understanding of chlorine-resistant pathogens, prolonged incubation periods, and environmental controls.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: Pattern Recognition</h6><p>Over 2 weeks, 80 children who swam at a community pool developed watery diarrhea lasting 1-2 weeks. Onset ranged from 2-10 days after swimming, with most cases appearing 7 days post-exposure.</p><p><strong>What type of outbreak curve would you expect?</strong></p>",
                options: [
                    { text: "Point Source (sharp peak)", feedback: "Incorrect. The wide range (2-10 days) suggests continuous exposure.", correct: false },
                    { text: "Continuous Common Source (plateau)", feedback: "Correct! Continuous exposure over 2 weeks with a long incubation period creates a plateau pattern.", correct: true },
                    { text: "Propagated (successive waves)", feedback: "Incorrect. Cryptosporidium is waterborne, not person-to-person in this context.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Agent Identification</h6><p>Stool samples show oocysts. The pathogen is resistant to standard chlorine levels. Incubation: 2-10 days (median 7). Duration: 1-2 weeks.</p><p><strong>What is the most likely agent?</strong></p>",
                options: [
                    { text: "Giardia lamblia", feedback: "Incorrect. Giardia has a longer incubation (1-3 weeks).", correct: false },
                    { text: "Cryptosporidium parvum", feedback: "Correct! Chlorine-resistant, 2-10 day incubation, prolonged diarrhea, and oocysts all point to Crypto.", correct: true },
                    { text: "E. coli O157:H7", feedback: "Incorrect. E. coli is chlorine-sensitive and has shorter incubation.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: Attack Rate Calculation</h6><p>Pool attendance records show 400 children swam during the 2-week period. 80 became ill.</p><p><strong>What is the attack rate?</strong></p>",
                options: [
                    { text: "AR = 20%", feedback: "Correct! 80/400 Ã— 100 = 20%", correct: true },
                    { text: "AR = 25%", feedback: "Incorrect. Recheck: 80/400.", correct: false },
                    { text: "AR = 80%", feedback: "Incorrect. You forgot to divide by total exposed.", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Control Measures</h6><p>Standard chlorination failed. What is the MOST effective control?</p>",
                options: [
                    { text: "Increase chlorine to maximum levels", feedback: "Incorrect. Cryptosporidium is chlorine-resistant even at high levels.", correct: false },
                    { text: "Close pool, hyperchlorinate or use UV treatment, enforce 'no swimming when ill' policy, and improve filtration", feedback: "Correct! Comprehensive approach: UV kills Crypto, policy prevents contamination, filtration removes oocysts.", correct: true },
                    { text: "Ban children under 5 from the pool", feedback: "Incorrect. This doesn't address the contamination source.", correct: false }
                ]
            }
        ]
    },

    {
        id: "MC3",
        title: "The Restaurant Hepatitis A Cluster",
        difficulty: "Advanced",
        description: "A foodborne hepatitis A outbreak with a long incubation period requires understanding of case definitions, secondary transmission, and vaccination strategies.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: Case Definition</h6><p>15 patrons of a restaurant developed jaundice, dark urine, and elevated liver enzymes 28-35 days after dining. All tested positive for Hepatitis A IgM.</p><p><strong>What case classification applies?</strong></p>",
                options: [
                    { text: "Probable cases (clinical symptoms only)", feedback: "Incorrect. They have lab confirmation.", correct: false },
                    { text: "Confirmed cases (clinical + lab confirmation)", feedback: "Correct! Symptoms + positive IgM = confirmed Hepatitis A.", correct: true },
                    { text: "Suspected cases (exposure only)", feedback: "Incorrect. They have both symptoms and lab confirmation.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Source Investigation</h6><p>A food handler tested positive for Hepatitis A. They worked while symptomatic (jaundice) for 3 days before being sent home. They handled ready-to-eat foods without gloves.</p><p><strong>What is the mode of transmission?</strong></p>",
                options: [
                    { text: "Airborne", feedback: "Incorrect. Hepatitis A is fecal-oral.", correct: false },
                    { text: "Fecal-oral (contaminated food)", feedback: "Correct! Food handler with poor hand hygiene contaminated food.", correct: true },
                    { text: "Bloodborne", feedback: "Incorrect. While Hep A is in blood, transmission here was via contaminated food.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: Secondary Transmission Risk</h6><p>Hepatitis A incubation: 15-50 days (average 28). Infectious period: 2 weeks before to 1 week after jaundice onset.</p><p><strong>What is the risk of secondary household transmission?</strong></p>",
                options: [
                    { text: "Low - Hepatitis A is not contagious person-to-person", feedback: "Incorrect. Hep A IS contagious person-to-person via fecal-oral route.", correct: false },
                    { text: "High - Close contacts are at risk, especially if hygiene is poor", feedback: "Correct! Household members can be infected through shared bathrooms, poor handwashing.", correct: true },
                    { text: "Moderate - Only if blood contact occurs", feedback: "Incorrect. Fecal-oral is the primary route, not blood.", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Post-Exposure Prophylaxis</h6><p>200 patrons ate at the restaurant during the food handler's infectious period. Most are now past the 2-week window for immune globulin.</p><p><strong>What is the best intervention?</strong></p>",
                options: [
                    { text: "Hepatitis A vaccine for all exposed patrons (even if >2 weeks post-exposure)", feedback: "Correct! Vaccine can still provide protection and prevent future exposure. Also educate on symptoms and hygiene.", correct: true },
                    { text: "Immune globulin only (even though window passed)", feedback: "Incorrect. IG is only effective within 2 weeks. Vaccine is better at this point.", correct: false },
                    { text: "No intervention needed - too late", feedback: "Incorrect. Vaccine can still help and prevents future infections.", correct: false }
                ]
            }
        ]
    },

    {
        id: "MC4",
        title: "The Legionnaires' Disease Hotel Outbreak",
        difficulty: "Advanced",
        description: "An environmental outbreak requiring understanding of aerosol transmission, environmental sampling, and engineering controls.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: Clinical Presentation</h6><p>12 hotel guests developed severe pneumonia 2-10 days after staying at the hotel. All required hospitalization. Urine antigen tests confirmed Legionella pneumophila.</p><p><strong>What is the most likely source?</strong></p>",
                options: [
                    { text: "Person-to-person transmission from an ill guest", feedback: "Incorrect. Legionnaires' disease is NOT transmitted person-to-person.", correct: false },
                    { text: "Contaminated water system (cooling towers, hot tubs, showers)", feedback: "Correct! Legionella grows in warm water systems and spreads via aerosols.", correct: true },
                    { text: "Contaminated food in the hotel restaurant", feedback: "Incorrect. Legionella is waterborne/airborne, not foodborne.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Environmental Investigation</h6><p>Water samples from the hotel's cooling tower, hot tub, and shower heads are collected. Which is MOST likely to be positive?</p>",
                options: [
                    { text: "Cooling tower", feedback: "Correct! Cooling towers are the #1 source of Legionnaires' outbreaks due to aerosolization and ideal growth temperature (25-42Â°C).", correct: true },
                    { text: "Cold water tap", feedback: "Incorrect. Legionella prefers warm water (25-42Â°C).", correct: false },
                    { text: "Swimming pool (chlorinated)", feedback: "Incorrect. Proper chlorination kills Legionella.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: Attack Rate</h6><p>500 guests stayed at the hotel during the exposure period. 12 developed Legionnaires' disease.</p><p><strong>Calculate the attack rate.</strong></p>",
                options: [
                    { text: "AR = 2.4%", feedback: "Correct! 12/500 Ã— 100 = 2.4%", correct: true },
                    { text: "AR = 12%", feedback: "Incorrect. You forgot to divide by total exposed.", correct: false },
                    { text: "AR = 0.24%", feedback: "Incorrect. Check your percentage calculation.", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Control Measures</h6><p>What is the PRIMARY engineering control for Legionella in water systems?</p>",
                options: [
                    { text: "Antibiotics in the water supply", feedback: "Incorrect. This is not practical or safe.", correct: false },
                    { text: "Superheat water to >60Â°C and flush system, maintain hot water >50Â°C and cold <20Â°C, regular cleaning/disinfection of cooling towers", feedback: "Correct! Temperature control and maintenance are key engineering controls.", correct: true },
                    { text: "Close the hotel permanently", feedback: "Incorrect. Proper remediation can eliminate the risk.", correct: false }
                ]
            }
        ]
    },

    {
        id: "MC5",
        title: "The Daycare E. coli O157:H7 Outbreak",
        difficulty: "Advanced",
        description: "A person-to-person outbreak in a daycare requiring understanding of HUS complications, exclusion policies, and secondary attack rates.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: Index Case</h6><p>A 3-year-old develops bloody diarrhea after a petting zoo visit. Stool culture: E. coli O157:H7. The child attends daycare.</p><p><strong>What is the IMMEDIATE action?</strong></p>",
                options: [
                    { text: "Wait for more cases before acting", feedback: "Incorrect. E. coli O157:H7 is highly dangerous; immediate action is needed.", correct: false },
                    { text: "Exclude the child from daycare immediately, notify parents of all children, and begin active surveillance", feedback: "Correct! Rapid exclusion prevents secondary transmission. E. coli O157:H7 can cause HUS (hemolytic uremic syndrome).", correct: true },
                    { text: "Prescribe antibiotics to all daycare children", feedback: "Incorrect. Antibiotics may INCREASE HUS risk in E. coli O157:H7.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Secondary Cases</h6><p>Over the next week, 5 more children (out of 30 total) develop diarrhea. All test positive for E. coli O157:H7. None visited the petting zoo.</p><p><strong>What is the secondary attack rate?</strong></p>",
                options: [
                    { text: "SAR = 17.2%", feedback: "Correct! 5 secondary cases / 29 susceptible contacts Ã— 100 = 17.2%", correct: true },
                    { text: "SAR = 16.7%", feedback: "Incorrect. Don't include the index case in the denominator.", correct: false },
                    { text: "SAR = 20%", feedback: "Incorrect. Check your calculation: 5/29.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: HUS Complication</h6><p>One child develops hemolytic uremic syndrome (HUS): hemolytic anemia, thrombocytopenia, and acute kidney injury.</p><p><strong>What percentage of E. coli O157:H7 cases develop HUS?</strong></p>",
                options: [
                    { text: "5-10%", feedback: "Correct! About 5-10% of E. coli O157:H7 cases progress to HUS, especially in young children.", correct: true },
                    { text: "50%", feedback: "Incorrect. HUS is serious but not that common.", correct: false },
                    { text: "<1%", feedback: "Incorrect. HUS is more common than this in E. coli O157:H7.", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Return-to-Daycare Criteria</h6><p>When can an infected child return to daycare?</p>",
                options: [
                    { text: "After symptoms resolve (no diarrhea for 24 hours)", feedback: "Incorrect. Children can still shed bacteria after symptoms resolve.", correct: false },
                    { text: "After 2 consecutive negative stool cultures, at least 24 hours apart, after diarrhea resolves", feedback: "Correct! This ensures the child is no longer shedding E. coli O157:H7.", correct: true },
                    { text: "After completing a course of antibiotics", feedback: "Incorrect. Antibiotics are NOT recommended for E. coli O157:H7 (may increase HUS risk).", correct: false }
                ]
            }
        ]
    },

    {
        id: "MC6",
        title: "The Measles School Outbreak",
        difficulty: "Advanced",
        description: "A highly contagious airborne outbreak requiring understanding of R0, herd immunity, and vaccination strategies.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: Index Case</h6><p>An unvaccinated 12-year-old returns from international travel with fever, cough, and a rash. Diagnosed with measles. The student attended school for 2 days while infectious.</p><p><strong>What is measles' basic reproduction number (R0)?</strong></p>",
                options: [
                    { text: "R0 = 2-3 (like flu)", feedback: "Incorrect. Measles is MUCH more contagious.", correct: false },
                    { text: "R0 = 12-18 (one of the most contagious diseases)", feedback: "Correct! Measles R0 is 12-18, meaning one case can infect 12-18 susceptible people.", correct: true },
                    { text: "R0 = 5-7 (like chickenpox)", feedback: "Incorrect. Measles is more contagious than chickenpox.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Exposure Assessment</h6><p>The school has 500 students. Vaccination records show 450 are fully vaccinated (2 doses MMR), 30 have 1 dose, and 20 are unvaccinated.</p><p><strong>How many students are susceptible?</strong></p>",
                options: [
                    { text: "50 students (1 dose + unvaccinated)", feedback: "Correct! 30 with 1 dose + 20 unvaccinated = 50 susceptible. 2 doses = 97% effective.", correct: true },
                    { text: "20 students (only unvaccinated)", feedback: "Incorrect. Students with only 1 dose are also at risk (1 dose = ~93% effective).", correct: false },
                    { text: "500 students (everyone)", feedback: "Incorrect. Vaccinated students have protection.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: Herd Immunity Threshold</h6><p>To achieve herd immunity for measles (R0 = 15), what percentage of the population must be immune?</p><p>Formula: HIT = (1 - 1/R0) Ãƒâ€” 100</p>",
                options: [
                    { text: "93-95%", feedback: "Correct! HIT = (1 - 1/15) Ã— 100 = 93.3%. This is why measles outbreaks occur when vaccination rates drop below 95%.", correct: true },
                    { text: "70-80%", feedback: "Incorrect. This works for less contagious diseases, but measles needs higher coverage.", correct: false },
                    { text: "50%", feedback: "Incorrect. Much too low for measles.", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Post-Exposure Prophylaxis</h6><p>Unvaccinated students were exposed 3 days ago. What is the best intervention?</p>",
                options: [
                    { text: "MMR vaccine within 72 hours of exposure", feedback: "Correct! MMR vaccine within 72 hours can prevent or modify disease. After 72 hours, use immune globulin for high-risk individuals.", correct: true },
                    { text: "Antibiotics", feedback: "Incorrect. Measles is viral; antibiotics don't work.", correct: false },
                    { text: "Quarantine only, no medical intervention", feedback: "Incorrect. Vaccine can still help if given quickly.", correct: false }
                ]
            }
        ]
    },

    {
        id: "MC7",
        title: "The Nursing Home Influenza Outbreak",
        difficulty: "Advanced",
        description: "A respiratory outbreak in a vulnerable population requiring understanding of vaccine effectiveness, antiviral prophylaxis, and cohorting.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: Outbreak Recognition</h6><p>A nursing home with 100 residents reports 15 cases of fever, cough, and myalgia over 3 days. Rapid flu tests: positive for Influenza A.</p><p><strong>What is the attack rate so far?</strong></p>",
                options: [
                    { text: "AR = 15%", feedback: "Correct! 15/100 Ã— 100 = 15%. But this will likely increase as the outbreak progresses.", correct: true },
                    { text: "AR = 30%", feedback: "Incorrect. Currently 15 cases out of 100.", correct: false },
                    { text: "AR = 5%", feedback: "Incorrect. Check your calculation.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Vaccination Status</h6><p>Records show 80 residents received flu vaccine this season. Of the 15 ill residents, 10 were vaccinated and 5 were not.</p><p><strong>Calculate Vaccine Effectiveness (VE).</strong></p><p>VE = (ARu - ARv) / ARu Ã— 100</p>",
                options: [
                    { text: "VE = 37.5%", feedback: "Incorrect. VE = (25-12.5)/25 Ã— 100 = 50%. (ARu = 5/20 = 25%, ARv = 10/80 = 12.5%).", correct: false },
                    { text: "VE = 50%", feedback: "Correct! ARu = 25%, ARv = 12.5%, VE = (25-12.5)/25 Ã— 100 = 50%", correct: true },
                    { text: "VE = 75%", feedback: "Incorrect. Recheck the formula and calculations.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: Antiviral Prophylaxis</h6><p>The outbreak is ongoing. What is the recommendation for uninfected residents?</p>",
                options: [
                    { text: "No intervention - let it run its course", feedback: "Incorrect. Elderly residents are at high risk for complications.", correct: false },
                    { text: "Antiviral prophylaxis (oseltamivir) for all uninfected residents, especially unvaccinated", feedback: "Correct! Prophylactic antivirals can prevent infection during an outbreak in high-risk settings.", correct: true },
                    { text: "Antibiotics for all residents", feedback: "Incorrect. Influenza is viral; antibiotics don't work (unless treating secondary bacterial pneumonia).", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Infection Control</h6><p>What is the MOST important infection control measure?</p>",
                options: [
                    { text: "Cohort ill residents together, use droplet precautions, restrict admissions/transfers, vaccinate staff", feedback: "Correct! Multi-pronged approach: cohorting prevents spread, droplet precautions protect staff, vaccination protects everyone.", correct: true },
                    { text: "Airborne isolation for all residents", feedback: "Incorrect. Influenza is droplet, not airborne (except during aerosol-generating procedures).", correct: false },
                    { text: "Close the facility to all visitors", feedback: "Partially correct but not sufficient. Need cohorting and precautions.", correct: false }
                ]
            }
        ]
    },

    {
        id: "MC8",
        title: "The Salmonella Turtle-Associated Outbreak",
        difficulty: "Advanced",
        description: "A multi-state zoonotic outbreak requiring understanding of case-control studies, odds ratios, and public health messaging.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: Multi-State Pattern</h6><p>CDC receives reports of Salmonella infections in children across 15 states. All isolates have the same PFGE pattern (genetic fingerprint).</p><p><strong>What does the identical PFGE pattern suggest?</strong></p>",
                options: [
                    { text: "Unrelated sporadic cases", feedback: "Incorrect. Identical PFGE patterns indicate a common source.", correct: false },
                    { text: "A common source outbreak (same contaminated product/animal)", feedback: "Correct! PFGE (pulsed-field gel electrophoresis) matching indicates cases are related.", correct: true },
                    { text: "Person-to-person transmission chain", feedback: "Incorrect. While possible, the multi-state distribution suggests a distributed product.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Case-Control Study</h6><p>A case-control study is conducted. Cases: 50 ill children. Controls: 100 healthy children matched by age and location.</p><p>Exposure to pet turtles: Cases = 40 exposed, 10 not. Controls = 20 exposed, 80 not.</p><p><strong>Calculate the Odds Ratio (OR).</strong></p>",
                options: [
                    { text: "OR = 16", feedback: "Correct! OR = (40Ã—80)/(10Ã—20) = 3200/200 = 16. Children with turtles had 16 times the odds of infection.", correct: true },
                    { text: "OR = 4", feedback: "Incorrect. Recheck your calculation: (aÃ—d)/(bÃ—c).", correct: false },
                    { text: "OR = 2", feedback: "Incorrect. Check the 2Ã—2 table setup.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: Biological Plausibility</h6><p>Why are small turtles (<4 inches) a Salmonella risk?</p>",
                options: [
                    { text: "Small turtles are more likely to bite", feedback: "Incorrect. The risk is not from bites.", correct: false },
                    { text: "Small turtles naturally carry Salmonella in their intestines and on their shells; children often put them in their mouths", feedback: "Correct! Reptiles are natural Salmonella carriers. Small turtles are mouthing hazards for young children.", correct: true },
                    { text: "Small turtles are fed contaminated food", feedback: "Incorrect. Turtles naturally carry Salmonella.", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Public Health Action</h6><p>What is the appropriate public health response?</p>",
                options: [
                    { text: "Ban on sale of turtles <4 inches (already exists via FDA), public education on reptile-associated Salmonella, hand hygiene messaging", feedback: "Correct! The FDA banned small turtle sales in 1975, but illegal sales continue. Education is key.", correct: true },
                    { text: "Mandatory Salmonella testing of all pet turtles", feedback: "Incorrect. Not practical; turtles shed Salmonella intermittently.", correct: false },
                    { text: "Antibiotics for all turtle owners", feedback: "Incorrect. Prophylactic antibiotics are not indicated.", correct: false }
                ]
            }
        ]
    },

    {
        id: "MC9",
        title: "The Listeria Cantaloupe Outbreak",
        difficulty: "Advanced",
        description: "A deadly foodborne outbreak requiring understanding of high-risk populations, long incubation periods, and food recalls.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: High-Risk Population</h6><p>33 cases of listeriosis are reported across 12 states. 30 patients are pregnant women, elderly (>65), or immunocompromised. 7 deaths occur.</p><p><strong>What is the case-fatality rate?</strong></p>",
                options: [
                    { text: "CFR = 21.2%", feedback: "Correct! 7 deaths / 33 cases Ã— 100 = 21.2%. Listeria has one of the highest CFRs of foodborne pathogens.", correct: true },
                    { text: "CFR = 7%", feedback: "Incorrect. You calculated deaths as a percentage of the population, not cases.", correct: false },
                    { text: "CFR = 33%", feedback: "Incorrect. Recheck: 7/33.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Incubation Period</h6><p>Listeria has an unusually long incubation period: 1-4 weeks (can be up to 70 days for invasive disease).</p><p><strong>Why does this complicate outbreak investigation?</strong></p>",
                options: [
                    { text: "Patients may not remember what they ate weeks ago; contaminated food may be gone", feedback: "Correct! Long incubation makes recall difficult and food may be consumed/discarded.", correct: true },
                    { text: "It doesn't complicate investigation", feedback: "Incorrect. Long incubation is a major challenge.", correct: false },
                    { text: "Patients are no longer infectious", feedback: "Incorrect. Listeria is foodborne, not person-to-person anyway.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: Source Identification</h6><p>Whole genome sequencing (WGS) links all cases. Traceback investigation identifies cantaloupes from a single farm.</p><p><strong>Why are cantaloupes a Listeria risk?</strong></p>",
                options: [
                    { text: "Netted rind can harbor bacteria; often eaten without cooking; can be contaminated by soil", feedback: "Correct! The rough rind traps bacteria, and cantaloupes are eaten raw. Listeria can grow at refrigerator temperatures.", correct: true },
                    { text: "Cantaloupes are acidic", feedback: "Incorrect. Cantaloupes are not particularly acidic, and Listeria can tolerate some acidity.", correct: false },
                    { text: "Cantaloupes are always contaminated", feedback: "Incorrect. Contamination is from poor agricultural/packing practices.", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Recall and Prevention</h6><p>What is the appropriate action?</p>",
                options: [
                    { text: "Voluntary recall of implicated cantaloupes, public warning to high-risk groups, investigation of farm practices (sanitation, water sources)", feedback: "Correct! Recall removes product, warning protects vulnerable populations, farm investigation prevents recurrence.", correct: true },
                    { text: "Ban all cantaloupe sales nationwide", feedback: "Incorrect. Only implicated farm's products need recall.", correct: false },
                    { text: "Antibiotics for all cantaloupe consumers", feedback: "Incorrect. Prophylactic antibiotics not indicated.", correct: false }
                ]
            }
        ]
    },

    {
        id: "MC10",
        title: "The Pertussis Daycare Outbreak",
        difficulty: "Advanced",
        description: "A vaccine-preventable disease outbreak requiring understanding of waning immunity, cocooning strategy, and antibiotic prophylaxis.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: Index Case</h6><p>A 2-month-old infant (too young for full vaccination) develops severe coughing fits (paroxysms) with inspiratory 'whoop' and post-tussive vomiting. PCR confirms Bordetella pertussis.</p><p><strong>Why are young infants at highest risk for severe pertussis?</strong></p>",
                options: [
                    { text: "They have no maternal antibodies", feedback: "Partially correct, but the main issue is lack of vaccination.", correct: false },
                    { text: "They are too young to be fully vaccinated (DTaP series starts at 2 months) and have the highest risk of complications (apnea, pneumonia, death)", feedback: "Correct! Infants <6 months are most vulnerable; they haven't completed the primary series.", correct: true },
                    { text: "Their immune systems are overactive", feedback: "Incorrect. The opposite is true.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Source Investigation</h6><p>The infant's 8-year-old sibling attends daycare and has had a mild cough for 3 weeks. PCR: positive for pertussis. The sibling was fully vaccinated as an infant but hasn't had a booster.</p><p><strong>What does this demonstrate?</strong></p>",
                options: [
                    { text: "Vaccine failure (vaccine doesn't work)", feedback: "Incorrect. The vaccine works but immunity wanes over time.", correct: false },
                    { text: "Waning immunity - pertussis vaccine protection decreases over time, requiring boosters (Tdap at age 11-12)", feedback: "Correct! Pertussis immunity wanes 5-10 years after vaccination. Boosters are essential.", correct: true },
                    { text: "The sibling was never vaccinated", feedback: "Incorrect. The scenario states they were fully vaccinated as an infant.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: Cocooning Strategy</h6><p>What is the 'cocooning' strategy for pertussis prevention?</p>",
                options: [
                    { text: "Isolating sick infants in a separate room", feedback: "Incorrect. Cocooning refers to vaccination strategy.", correct: false },
                    { text: "Vaccinating all close contacts of infants (parents, siblings, grandparents, caregivers) with Tdap to create a protective 'cocoon'", feedback: "Correct! Cocooning protects vulnerable infants by vaccinating everyone around them.", correct: true },
                    { text: "Giving infants extra vaccine doses", feedback: "Incorrect. Infants follow the standard DTaP schedule.", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Post-Exposure Prophylaxis</h6><p>20 children at the daycare were exposed. What is the recommendation?</p>",
                options: [
                    { text: "Azithromycin prophylaxis for all close contacts, regardless of vaccination status; Tdap booster for those due", feedback: "Correct! Antibiotics prevent disease in exposed individuals. Vaccine booster provides long-term protection.", correct: true },
                    { text: "No intervention - pertussis is mild", feedback: "Incorrect. Pertussis can be severe in infants and prophylaxis prevents spread.", correct: false },
                    { text: "Quarantine only", feedback: "Incorrect. Antibiotic prophylaxis is recommended for close contacts.", correct: false }
                ]
            }
        ]
    },


    {
        id: "MC11",
        title: "Mastery Case: The National Nightmare",
        difficulty: "National",
        description: "The ultimate test of epidemiological judgment. This case requires data cleaning, stratified analysis to detect confounding, and identification of advanced biases.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: Data Cleaning</h6><p>You receive a raw line list for a suspected foodborne outbreak at a wedding. Before running stats, you sanity-check the data.</p><table class='table' style='width:100%; font-size:0.85rem; margin-bottom:1rem;'><thead><tr style='background:#eee'><th style='padding:4px;'>ID</th><th style='padding:4px;'>Meal Time</th><th style='padding:4px;'>Onset Time</th><th style='padding:4px;'>Symptoms</th></tr></thead><tbody><tr><td>001</td><td>2:00 PM</td><td>6:00 PM</td><td>Vomiting</td></tr><tr><td>002</td><td>2:00 PM</td><td>12:00 PM</td><td>Vomiting</td></tr><tr><td>003</td><td>2:00 PM</td><td>7:00 PM</td><td>Vomiting</td></tr></tbody></table><p><strong>Which record must be excluded/quarantined?</strong></p>",
                options: [
                    { text: "ID 001", feedback: "Incorrect. 4 hours incubation is consistent with Staph aureus.", correct: false },
                    { text: "ID 002", feedback: "Correct! ID 002 has an onset time (12:00 PM) BEFORE the exposure time (2:00 PM). This violates temporality and is likely a data entry error or a background case.", correct: true },
                    { text: "ID 003", feedback: "Incorrect. 5 hours incubation is consistent with Staph aureus.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Crude Analysis</h6><p>You investigate a study linking <strong>Coffee Consumption</strong> to <strong>Pancreatic Cancer</strong>. The Crude Odds Ratio (OR) is <strong>3.0</strong> (p < 0.05).</p><p>However, you notice that coffee drinkers in the study are also much more likely to be <strong>Smokers</strong>. Smoking is a known cause of pancreatic cancer.</p><p><strong>What is the relationship between Smoking and Coffee here?</strong></p>",
                options: [
                    { text: "Smoking is an Effect Modifier.", feedback: "Incorrect. We haven't looked at strata yet, but this setup suggests confounding.", correct: false },
                    { text: "Smoking is a potential Confounder.", feedback: "Correct! It is associated with the exposure (Coffee), associated with the outcome (Cancer), and is not on the causal pathway.", correct: true },
                    { text: "Smoking is the Independent Variable.", feedback: "Incorrect. Coffee is the exposure of interest.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: Stratified Analysis</h6><p>You stratify the data by Smoking status.</p><ul><li><strong>Smokers Only:</strong> OR for Coffee = 1.0</li><li><strong>Non-Smokers Only:</strong> OR for Coffee = 1.0</li></ul><p><strong>Compare these stratum-specific odds ratios (1.0) to the crude odds ratio (3.0). What is your conclusion?</strong></p>",
                options: [
                    { text: "Effect Modification is present.", feedback: "Incorrect. Effect Modification would show DIFFERENT ORs in each stratum (e.g., 1.0 vs 5.0). Here they are the same (1.0).", correct: false },
                    { text: "Confounding is present.", feedback: "Correct! The crude OR (3.0) disappears when you control for smoking (OR 1.0). The association was purely due to confounding.", correct: true },
                    { text: "Coffee causes cancer only in smokers.", feedback: "Incorrect. The OR is 1.0 in smokers, meaning NO association.", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Adjustment</h6><p>Since confounding is present, you cannot report the Crude OR. Which statistical method should you use to report a single, summary Odds Ratio that accounts for the confounding?</p>",
                options: [
                    { text: "Pearson's Chi-Square Test", feedback: "Incorrect. This tests significance, it doesn't adjust for confounding.", correct: false },
                    { text: "Mantel-Haenszel Adjusted Odds Ratio", feedback: "Correct! The Mantel-Haenszel method calculates a weighted average of the stratum-specific ORs, effectively removing the confounding bias.", correct: true },
                    { text: "T-Test", feedback: "Incorrect. That compares means, not odds.", correct: false }
                ]
            },
            {
                id: "step5",
                text: "<h6>Step 5: Advanced Bias</h6><p>In a separate hospital-based Case-Control study, you find that controls (patients with broken legs) smoke less than the general population. This artificially inflates the association between smoking and disease in your study.</p><p><strong>What specific type of Selection Bias is this?</strong></p>",
                options: [
                    { text: "Recall Bias", feedback: "Incorrect. That is Information Bias.", correct: false },
                    { text: "Berkson's Bias (Admission Rate Bias)", feedback: "Correct! Hospital controls often have different exposure rates than the general community, leading to spurious associations.", correct: true },
                    { text: "Neyman Bias (Prevalence-Incidence Bias)", feedback: "Incorrect. That relates to survival/mortality.", correct: false }
                ]
            }
        ]
    },

    {
        id: "IC1",
        title: "The Wedding Reception Investigation",
        difficulty: "Intermediate",
        description: "Guests at a summer wedding fall ill with vomiting and diarrhea. Navigate the investigation steps from notification to control.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: Notification</h6><p>On Monday morning, the local health department receives calls from three different attendees of a wedding reception held on Saturday. They report severe nausea, vomiting, and some diarrhea starting Sunday night.</p><p><strong>What is your immediate priority?</strong></p>",
                options: [
                    { text: "Close the wedding venue immediately.", feedback: "Incorrect. You don't have enough evidence to implicate the venue yet.", correct: false },
                    { text: "Collect food samples from the dumpster.", feedback: "Incorrect. While useful later, confirming the diagnosis and establishing an outbreak is first.", correct: false },
                    { text: "Interview the callers to gather clinical details and establish a case definition.", feedback: "Correct. You need to know 'who, what, where, when' and confirm it's an outbreak.", correct: true }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: Case Finding</h6><p>You confirm 55 of 120 guests meet the case definition. Symptoms last 24-48 hours. Stool samples are negative for Salmonella and E. coli. The incubation period is 24-36 hours.</p><p><strong>What is the most likely agent?</strong></p>",
                options: [
                    { text: "Staphylococcus aureus", feedback: "Incorrect. Staph incubation is shorter (2-7 hours).", correct: false },
                    { text: "Norovirus", feedback: "Correct. The incubation (24-48h), duration, and symptoms (vomiting > diarrhea) are classic for Norovirus.", correct: true },
                    { text: "Giardia", feedback: "Incorrect. Incubation is 1-3 weeks.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: Epi Curve Analysis</h6><p>The Epi Curve shows a sharp peak on Monday morning, with a rapid decline. All cases ate at the reception.</p><p><strong>What type of outbreak is this?</strong></p>",
                options: [
                    { text: "Propagated", feedback: "Incorrect. Propagated would show waves of cases over time.", correct: false },
                    { text: "Point Source", feedback: "Correct. A single sharp peak within one incubation period indicates a point source exposure.", correct: true }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Control Measures</h6><p>Food handlers are suspected. One server reported being ill on Friday but worked anyway.</p><p><strong>What is the best control measure?</strong></p>",
                options: [
                    { text: "Prescribe antibiotics to all guests.", feedback: "Incorrect. Norovirus is viral.", correct: false },
                    { text: "Exclude the ill food handler and disinfect surfaces with bleach.", feedback: "Correct. Exclusion stops the source; bleach kills Norovirus.", correct: true }
                ]
            }
        ]
    },
    {
        id: "IC2",
        title: "The Community Picnic Mystery (Mega-Case)",
        difficulty: "Advanced",
        description: "A comprehensive outbreak scenario covering Epi Curves, Exposure Windows, Stratified Analysis, and Confounding.",
        steps: [
            {
                id: "step1",
                text: "<h6>Step 1: The Pattern</h6><p>Three days after a large community picnic, your office is flooded with reports of fever, cramps, and diarrhea. You plot an Epi Curve of 100 cases. It shows a steep rise to a peak on Monday afternoon, followed by a gradual decline over the next few days. There are no secondary waves.</p><p><strong>What does this curve suggest?</strong></p>",
                options: [
                    { text: "Propagated outbreak (person-to-person).", feedback: "Incorrect. Propagated curves have multiple, progressively larger peaks.", correct: false },
                    { text: "Point Source outbreak (single exposure).", feedback: "Correct. The log-normal (bell) shape with a sharp rise and tail suggests a single common exposure.", correct: true },
                    { text: "Continuous Common Source.", feedback: "Incorrect. A continuous source would have a plateau, not a sharp peak.", correct: false }
                ]
            },
            {
                id: "step2",
                text: "<h6>Step 2: The Window</h6><p>The peak of cases occurred on Monday at 4:00 PM. The suspected pathogen is <em>Salmonella</em> (Incubation 12-48 hours, Median 28 hours). The picnic started Saturday at 11:00 AM and ended at 4:00 PM.</p><p><strong>Does the timing implicate the picnic?</strong></p>",
                options: [
                    { text: "No, the incubation period effectively rules out the picnic.", feedback: "Incorrect. Monday 4PM minus 28 hours is Sunday Noon. Wait, that's 28 hours. Let's calculate: Mon 4PM - 24h = Sun 4PM. -4h = Sun Noon. That's 28 hours. Picnic was Sat.", correct: false },
                    { text: "Yes. Monday 4PM minus 28 hours = Sunday Noon (Wait...). Let's re-calculate: Mon 4PM is ~52 hours after Sat Noon. That is slightly outside the median but within the max (48-72h for some strains). Actually, let's look closer. 12-36h is typical for Salmonella. If peak is Mon 4PM, exposure was likely Sun AM. The picnic was Saturday. This is tricky.", feedback: "Let's check the math. Sat 12PM to Sun 12PM (24h) to Mon 12PM (48h). Mon 4PM is 52 hours. This is a bit long for a median of 28h. Maybe it wasn't the picnic?", correct: false },
                    { text: "Wait, let's look at the data again. Peak Monday 4PM. Min Incubation 6h, Max 72h. If we subtract the median (28h) from Mon 4PM, we get Sunday 12:00 PM. The picnic was Saturday. The timing suggests the exposure might be LATER than the picnic, OR the incubation is longer.", feedback: "Correct. A strict median calculation points to Sunday. However, if we assume the Picnic IS the source, we might be dealing with a long-incubation pathogen or leftover food eaten Sunday.", correct: true }
                ]
            },
            {
                id: "step2_revised",
                text: "<h6>Step 2: Re-evaluating the Agent</h6><p>Okay, let's refine. Stool samples actually come back positive for <em>Campylobacter</em> (Incubation 2-5 days). Peak is Monday. Picnic was Saturday (2 days prior). </p><p><strong>Does this fit?</strong></p>",
                options: [
                    { text: "Yes, 2 days fits perfectly within the incubation period.", feedback: "Correct. Saturday to Monday is 48 hours. This aligns with Campylobacter.", correct: true },
                    { text: "No, it's too short.", feedback: "Incorrect. 48 hours is standard for Campy.", correct: false }
                ]
            },
            {
                id: "step3",
                text: "<h6>Step 3: The Cohort Study</h6><p>You conduct a cohort study. <br><strong>Chicken:</strong> AR(Ill)=40%, AR(Well)=10%. <br><strong>Salad:</strong> AR(Ill)=35%, AR(Well)=35%.</p><p><strong>Calculate the Risk Ratio (RR) for Chicken.</strong></p>",
                options: [
                    { text: "RR = 1.0", feedback: "Incorrect.", correct: false },
                    { text: "RR = 4.0", feedback: "Correct. 40% / 10% = 4.0. People who ate Chicken were 4 times more likely to get sick.", correct: true },
                    { text: "RR = 0.25", feedback: "Incorrect.", correct: false }
                ]
            },
            {
                id: "step4",
                text: "<h6>Step 4: Confounding?</h6><p>Almost everyone who ate Chicken also ate the <strong>Grilled Corn</strong>. You run a stratified analysis.</p><p><strong>Strata 1 (Did NOT eat Corn):</strong> RR for Chicken = 3.9.<br><strong>Strata 2 (Did eat Corn):</strong> RR for Chicken = 4.1.<br><strong>Crude RR for Chicken:</strong> 4.0.</p><p><strong>Is Corn a confounder?</strong></p>",
                options: [
                    { text: "Yes, because the stratum specific RRs are similar.", feedback: "Incorrect logic. If stratum RRs are similar to the crude, there is NO confounding.", correct: false },
                    { text: "No. The stratum-specific RRs (3.9, 4.1) are similar to the crude RR (4.0). Corn did not distort the relationship.", feedback: "Correct. This is not confounding. Chicken is the independent cause.", correct: true },
                    { text: "Yes, it is an Effect Modifier.", feedback: "Incorrect. RRs are not significantly different between strata.", correct: false }
                ]
            },
            {
                id: "step5",
                text: "<h6>Step 5: Recommendation</h6><p>The chicken was undercooked. What is the primary recommendation?</p>",
                options: [
                    { text: "Administer prophylactic antibiotics to the town.", feedback: "Incorrect. Antibiotic stewardship precludes this.", correct: false },
                    { text: "Education on safe cooking temperatures and avoiding cross-contamination.", feedback: "Correct. Prevention for future events.", correct: true }
                ]
            }
        ]
    }
];

class InteractiveCaseEngine {
    constructor() {
        this.containerId = null;
    }

    init(containerId) {
        this.containerId = containerId;
        this.renderList();
    }

    renderList() {
        const container = document.getElementById(this.containerId);
        if (!container) return;

        let html = `
            <div class="interactive-case-list" style="text-align: left;">
                <h3 style="border-bottom: 2px solid var(--accent-color); padding-bottom: 0.5rem; margin-top: 2rem; text-align: left;">Interactive Scenarios</h3>
                <p style="text-align: left;">Test your skills with multi-step investigations. Each decision affects your score.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
        `;

        INTERACTIVE_CASES_DATA.forEach(c => {
            html += `
                <div class="neo-card interactive-card" style="border: 1px solid #ddd; padding: 1.5rem; height: 100%; display: flex; flex-direction: column; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: left;" 
                     onclick="if(window.InteractiveEngine) window.InteractiveEngine.startCase('${c.id}')"
                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    
                    <div style="flex: 1;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 0.5rem;">
                            <h4 style="margin:0; font-size: 1.1rem; color: var(--navy-primary); text-align: left;">${c.title}</h4>
                            <span class="neo-badge small" style="background:${c.difficulty === 'Advanced' ? '#fecaca' : '#dbeafe'}; color:${c.difficulty === 'Advanced' ? '#991b1b' : '#1e40af'};">${c.difficulty}</span>
                        </div>
                        <p style="font-size: 0.95rem; line-height: 1.5; color: #4b5563; margin-top: 0.5rem; text-align: left;">${c.description}</p>
                    </div>

                    <div style="margin-top: auto; padding-top: 1rem; border-top: 1px dashed #eee;">
                        <button class="neo-btn small full-width primary">
                            Start Case <i class="ph-bold ph-caret-right"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        html += `</div></div>`;
        container.innerHTML = html;
    }

    startCase(id) {
        const caseData = INTERACTIVE_CASES_DATA.find(c => c.id === id);
        if (!caseData) return;
        this.currentCase = caseData;
        this.currentStepIndex = 0;
        this.renderStep();
    }

    renderStep() {
        const container = document.getElementById(this.containerId);
        const step = this.currentCase.steps[this.currentStepIndex];
        const isLastStep = this.currentStepIndex === this.currentCase.steps.length - 1;

        let html = `
            <div class="interactive-case-view">
                <button class="btn btn-outline btn-sm" onclick="window.InteractiveEngine.renderList()"><i class="ph-bold ph-arrow-left"></i> Back to Cases</button>
                <div class="neo-card" style="margin-top: 1rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0; text-align: left;">${this.currentCase.title}</h3>
                        <span class="text-sm text-muted">Step ${this.currentStepIndex + 1} of ${this.currentCase.steps.length}</span>
                    </div>
                    <hr>
                    <div class="step-content" style="font-size: 1.1rem; line-height: 1.6;">
                        ${step.text}
                    </div>
                    <div class="options-grid" style="display: flex; flex-direction: column; gap: 0.8rem; margin-top: 1.5rem;">
        `;

        step.options.forEach((opt, idx) => {
            html += `
                <button class="btn btn-outline option-btn" id="opt-${idx}" onclick="window.InteractiveEngine.checkAnswer(${idx})" style="text-align: left; padding: 1rem;">
                    ${opt.text}
                </button>
            `;
        });

        html += `   </div>
                    <div id="step-feedback" style="margin-top: 1.5rem; display: none;" class="callout"></div>
                    <button id="next-step-btn" class="btn btn-primary" onclick="window.InteractiveEngine.nextStep()" style="display: none; margin-top: 1rem; float: right;">
                        ${isLastStep ? 'Finish Case' : 'Next Step <i class="ph-bold ph-arrow-right"></i>'}
                    </button>
                    <div style="clear: both;"></div>
                </div>
            </div>
        `;

        container.innerHTML = html;
    }

    checkAnswer(optionIdx) {
        const step = this.currentCase.steps[this.currentStepIndex];
        const option = step.options[optionIdx];
        const feedbackEl = document.getElementById('step-feedback');
        const nextBtn = document.getElementById('next-step-btn');
        const btns = document.querySelectorAll('.option-btn');

        // Disable all buttons initially so they can't double click
        btns.forEach(b => b.disabled = true);

        // Show feedback
        feedbackEl.style.display = 'block';
        feedbackEl.innerHTML = `<strong>${option.correct ? 'Correct!' : 'Incorrect.'}</strong> ${option.feedback}`;
        feedbackEl.className = option.correct ? 'callout callout-success' : 'callout callout-danger';

        // Highlight selected
        const selectedBtn = document.getElementById(`opt-${optionIdx}`);
        if (option.correct) {
            selectedBtn.style.background = 'rgba(34, 197, 94, 0.1)';
            selectedBtn.style.borderColor = 'var(--success)';
            nextBtn.style.display = 'inline-block';
        } else {
            selectedBtn.style.background = 'rgba(239, 68, 68, 0.1)';
            selectedBtn.style.borderColor = 'var(--danger)';
            // Re-enable other buttons to allow retry, but keep this one disabled
            btns.forEach((b, idx) => {
                if (idx !== optionIdx) b.disabled = false;
            });
        }
    }

    nextStep() {
        if (this.currentStepIndex < this.currentCase.steps.length - 1) {
            this.currentStepIndex++;
            this.renderStep();
        } else {
            // Finish
            const container = document.getElementById(this.containerId);
            container.innerHTML = `
                <div class="interactive-case-view">
                    <div class="neo-card" style="text-align: center; padding: 3rem;">
                        <i class="ph ph-check-circle" style="font-size: 4rem; color: var(--success); margin-bottom: 1rem;"></i>
                        <h2>Case Closed!</h2>
                        <p>You successfully investigated and controlled the outbreak.</p>
                        <button class="btn btn-primary" onclick="window.InteractiveEngine.renderList()">Return to Case Library</button>
                    </div>
                </div>
             `;
        }
    }
}

const interactiveEngine = new InteractiveCaseEngine();
window.InteractiveEngine = interactiveEngine;

class HomeDashboard {
    constructor(containerId = 'content-container') {
        this.containerId = containerId;
        this.injectStyles();

        // Game State
        this.gameState = {
            active: false,
            score: 0,
            frame: 0,
            nodes: []
        };
    }

    init() {
        this.render();
    }

    injectStyles() {
        if (document.getElementById('home-dashboard-styles')) return;
        const style = document.createElement('style');
        style.id = 'home-dashboard-styles';
        style.textContent = `
            .home-wrapper {
                max-width: 1200px;
                margin: 0 auto;
                font-family: var(--font-heading);
                animation: fadeIn 0.5s ease-out;
            }
            .hero-banner {
                background: #ffffff;
                color: #0f172a;
                padding: 3rem;
                border-radius: 12px;
                margin-bottom: 2rem;
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                justify-content: space-between;
                border: 2px solid black;
                box-shadow: 6px 6px 0 black;
                position: relative;
                overflow: hidden;
            }
            /* Decorative strip on left of banner */
            .hero-banner::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 12px;
                background: var(--navy-primary);
                border-right: 2px solid black;
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }
            .stat-card {
                padding: 1.5rem;
                border-radius: 12px;
                border: 2px solid black;
                box-shadow: 4px 4px 0 black;
                transition: all 0.1s;
                position: relative;
            }
            .stat-card.accent-green { background: #dcfce7; }
            .stat-card.accent-blue { background: #e0f2fe; }
            .stat-card.accent-purple { background: #fae8ff; }

            .stat-card:hover {
                transform: translate(-2px, -2px);
                box-shadow: 6px 6px 0 black;
            }
            .stat-value {
                font-size: 2.5rem;
                font-weight: 800;
                margin: 0.5rem 0;
                color: var(--navy-primary);
            }
            .stat-label {
                font-size: 0.8rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: #475569;
                font-weight: 700;
            }
            .quick-actions {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
            }
            .action-card {
                background: white;
                padding: 1.5rem;
                border-radius: 12px;
                border: 2px solid black;
                box-shadow: 4px 4px 0 black;
                cursor: pointer;
                transition: all 0.1s;
            }
            .action-card:hover {
                background: #fff7ed; /* Light Orange Tint */
                transform: translate(-2px, -2px);
                box-shadow: 6px 6px 0 black;
                border-color: black;
            }
            .game-monitor {
                background: #ffffff;
                border-radius: 12px;
                padding: 1.5rem;
                color: #0f172a;
                border: 2px solid black;
                box-shadow: 6px 6px 0 black;
                z-index: 2; /* Above ::before */
            }
            .logo-glow {
                filter: none;
            }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        `;
        document.head.appendChild(style);
    }

    render() {
        const container = document.getElementById(this.containerId);
        if (!container) return;

        const quizStats = window.AnalyticsManager ? window.AnalyticsManager.getGlobalStats() : { totalAttempts: 0, averageScore: 0 };
        const chapters = window.AnalyticsManager ? window.AnalyticsManager.getChapterStats() : { viewed: 0, total: 20 };

        // SVG Logo (Vector) - High Quality
        const svgLogo = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23003d6b;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23007acc;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23grad1)' stroke='%23000' stroke-width='2'/%3E%3Cpath d='M50 15 L50 45 L75 60 L25 60 L50 45' fill='%23ff5c00' stroke='%23fff' stroke-width='2'/%3E%3Ccircle cx='50' cy='50' r='10' fill='%23fff'/%3E%3C/svg%3E`;

        container.innerHTML = `
            <div class="home-wrapper">
                <!-- Hero Banner -->
                <div class="hero-banner">
                    <div style="flex: 1; min-width: 300px; padding-left: 1rem;">
                        <h1 style="color: var(--navy-primary); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                            <img src="${svgLogo}" class="logo-glow" alt="Logo" style="width: 64px; height: 64px; border-radius: 50%;">
                            Epidemic Engine
                        </h1>
                        <p style="font-size: 1.25rem; opacity: 1; margin-bottom: 1.5rem; color: #334155; font-weight: 500;">
                            Navigate outbreaks, analyze data, and master the art of Disease Detectives.
                        </p>
                        <div style="display: flex; gap: 1rem;">
                            <button class="neo-btn primary" onclick="loadChapter('ch1')">Start Learning</button>
                            <button class="neo-btn outline" onclick="loadChapter('drills')">Open Tools</button>
                        </div>
                    </div>
                    <div class="game-monitor" style="flex: 1; min-width: 300px; max-width: 400px; margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <strong style="text-transform: uppercase; letter-spacing: 1px; color: var(--navy-primary);">Transmission Sim</strong>
                            <span id="game-score" class="neo-badge">0</span>
                        </div>
                        <div id="game-container" style="position: relative; height: 200px; background: #f8fafc; border-radius: 8px; overflow: hidden; border: 2px solid #000;">
                            <canvas id="bg-canvas" style="display: block; width: 100%; height: 100%;"></canvas>
                            <div id="game-overlay" style="position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
                                <button class="neo-btn primary small" onclick="window.HomeDashboard.startGame()">Start Simulation</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Global Search -->
                <div class="search-section" style="margin-bottom: 2rem; position: relative; z-index: 100;">
                    <div style="position: relative;">
                        <i class="ph-bold ph-magnifying-glass" style="position: absolute; left: 1.2rem; top: 50%; transform: translateY(-50%); font-size: 1.25rem; color: #64748b;"></i>
                        <input type="text" id="global-search-input" placeholder="Search chapters, glossary terms, or cases..." 
                               onkeyup="window.HomeDashboard.performSearch(this.value)"
                               style="width: 100%; padding: 1rem 1rem 1rem 3.5rem; font-size: 1.1rem; border: 2px solid #000; border-radius: 12px; box-shadow: 4px 4px 0 #000; outline: none; transition: all 0.2s;">
                    </div>
                    <div id="search-results" style="display: none; margin-top: 0.5rem; background: white; border: 2px solid #000; border-radius: 12px; overflow: hidden; box-shadow: 6px 6px 0 rgba(0,0,0,0.2); position: absolute; width: 100%;"></div>
                </div>

                <!-- Stats Grid -->
                <!-- Filled in JS below to use variables -->
            </div>
        `;

        container.querySelector('.home-wrapper').insertAdjacentHTML('beforeend', `
                <div class="stats-grid">
                    <div class="stat-card accent-green">
                        <div class="stat-value">${quizStats.averageScore}%</div>
                        <div class="stat-label">Avg Quiz Score</div>
                    </div>
                    <div class="stat-card accent-blue">
                        <div class="stat-value">${chapters.viewed}/${chapters.total}</div>
                        <div class="stat-label">Chapters Read</div>
                    </div>
                    <div class="stat-card accent-purple">
                        <div class="stat-value">${quizStats.totalAttempts}</div>
                        <div class="stat-label">Quizzes Taken</div>
                    </div>
                </div>

                <h2 style="margin-bottom: 1rem; color: var(--navy-primary);">Quick Actions</h2>
                <div class="quick-actions">
                    <div class="action-card" onclick="loadChapter('simulation')">
                        <i class="ph-bold ph-clock" style="font-size: 2rem; color: var(--accent-orange); margin-bottom: 0.5rem;"></i>
                        <h3 style="margin: 0; font-size: 1.25rem;">Timed Exam</h3>
                        <p style="margin: 0.5rem 0 0; font-size: 0.9rem; color: #64748b;">Full 50-minute simulation with random questions.</p>
                    </div>
                     <div class="action-card" onclick="loadChapter('case_library')">
                        <i class="ph-bold ph-files" style="font-size: 2rem; color: var(--success); margin-bottom: 0.5rem;"></i>
                        <h3 style="margin: 0; font-size: 1.25rem;">Case Library</h3>
                        <p style="margin: 0.5rem 0 0; font-size: 0.9rem; color: #64748b;">Review 16+ outbreak scenarios and solutions.</p>
                    </div>
                     <div class="action-card" onclick="loadChapter('drills')">
                        <i class="ph-bold ph-wrench" style="font-size: 2rem; color: var(--accent-purple); margin-bottom: 0.5rem;"></i>
                        <h3 style="margin: 0; font-size: 1.25rem;">Tools & Drills</h3>
                        <p style="margin: 0.5rem 0 0; font-size: 0.9rem; color: #64748b;">2x2 Calculator, Epi Curves, and more.</p>
                    </div>
                </div>
        `);
    }

    startGame() {
        const overlay = document.getElementById('game-overlay');
        if (overlay) overlay.style.display = 'none';

        const canvas = document.getElementById('bg-canvas');
        if (!canvas) return;

        this.width = canvas.parentElement.clientWidth;
        this.height = canvas.parentElement.clientHeight;
        canvas.width = this.width;
        canvas.height = this.height;
        this.ctx = canvas.getContext('2d');

        // Reset State
        this.gameState = {
            active: true,
            score: 0,
            frame: 0,
            nodes: []
        };

        this.canvasObj = canvas; // Save for touch handler

        // Spawn Nodes
        for (let i = 0; i < 15; i++) this.spawnNode();

        // Start Loop
        if (this.gameLoopId) clearInterval(this.gameLoopId);
        this.gameLoopId = setInterval(() => this.loop(), 1000 / 30); // 30 FPS

        // Timer
        if (this.timerInterval) clearInterval(this.timerInterval);
        this.timerInterval = setTimeout(() => this.endGame(), 15000); // 15s Game

        // Input
        canvas.onclick = (e) => {
            const rect = canvas.getBoundingClientRect();
            this.handleInput(e.clientX - rect.left, e.clientY - rect.top);
        };
    }

    spawnNode() {
        if (this.gameState.nodes.length > 30) return;
        this.gameState.nodes.push({
            x: Math.random() * this.width,
            y: Math.random() * this.height,
            vx: (Math.random() - 0.5) * 4,
            vy: (Math.random() - 0.5) * 4,
            radius: 8 + Math.random() * 8,
            infected: Math.random() > 0.7 // 30% bad
        });
    }

    handleInput(x, y) {
        this.gameState.nodes.forEach(node => {
            const dist = Math.hypot(node.x - x, node.y - y);
            if (dist < node.radius + 10 && node.infected) {
                // Remove/Quarantine
                const idx = this.gameState.nodes.indexOf(node);
                if (idx > -1) {
                    this.gameState.nodes.splice(idx, 1);
                    this.gameState.score++;
                    document.getElementById('game-score').textContent = this.gameState.score;
                }
            }
        });
    }

    loop() {
        if (!this.gameState.active) return;
        this.updateState();
        this.draw();
    }

    updateState() {
        this.gameState.frame++;
        if (this.gameState.frame % 50 === 0) this.spawnNode();

        this.gameState.nodes.forEach(node => {
            node.x += node.vx;
            node.y += node.vy;

            // Bounce
            if (node.x < 0 || node.x > this.width) node.vx *= -1;
            if (node.y < 0 || node.y > this.height) node.vy *= -1;
        });
    }

    draw() {
        const ctx = this.ctx;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, this.width, this.height);

        this.gameState.nodes.forEach(node => {
            this.drawNode(node);
        });
    }

    drawNode(node) {
        const ctx = this.ctx;
        ctx.beginPath();
        ctx.arc(node.x, node.y, node.radius, 0, Math.PI * 2);

        if (node.infected) {
            ctx.fillStyle = '#dc2626';
            ctx.strokeStyle = '#991b1b';
            ctx.lineWidth = 2;
        } else {
            ctx.fillStyle = '#2563eb';
            ctx.strokeStyle = '#1e40af';
            ctx.lineWidth = 2;
        }

        ctx.fill();
        ctx.stroke();
        ctx.closePath();
    }

    endGame() {
        this.gameState.active = false;
        clearInterval(this.gameLoopId);
        clearInterval(this.timerInterval);

        const oldHigh = localStorage.getItem('epi_game_highscore') || 0;
        if (this.gameState.score > oldHigh) localStorage.setItem('epi_game_highscore', this.gameState.score);

        const overlay = document.getElementById('game-overlay');
        if (overlay) {
            overlay.style.display = 'flex';
            overlay.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="color: #16a34a; font-size: 2rem; margin-bottom: 0.5rem;">SUCCESS</h2>
                    <p style="color: #000; margin-bottom: 1.5rem;">Threats Neutralized: ${this.gameState.score}</p>
                    <button class="neo-btn primary" onclick="window.HomeDashboard.startGame()">Re-Deploy</button>
                </div>
            `;
        }
    }

    performSearch(query) {
        const resultsContainer = document.getElementById('search-results');
        if (!query || query.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        const q = query.toLowerCase();
        const matches = [];

        // 1. Search Chapters (Nav Items)
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            const text = item.textContent.trim();
            if (text.toLowerCase().includes(q)) {
                matches.push({
                    type: 'Chapter',
                    label: text,
                    action: () => { item.click(); }
                });
            }
        });

        // 2. Search Glossary (if available)
        if (window.APPENDIX_DATA && window.APPENDIX_DATA.glossary) {
            window.APPENDIX_DATA.glossary.forEach(g => {
                if (g.term.toLowerCase().includes(q)) {
                    matches.push({
                        type: 'Glossary',
                        label: g.term,
                        sub: g.definition.substring(0, 50) + '...',
                        action: () => {
                            loadChapter('appendix');
                            setTimeout(() => {
                                window.showTab('glossary');
                                const input = document.getElementById('glossary-search');
                                if (input) {
                                    input.value = g.term;
                                    window.appendixEngine.filterGlossary();
                                }
                            }, 300);
                        }
                    });
                }
            });
        }

        // 3. Search Cases (if available)
        if (window.CASE_LIBRARY) {
            window.CASE_LIBRARY.forEach((c, idx) => {
                if (c.title.toLowerCase().includes(q) || c.disease.toLowerCase().includes(q)) {
                    matches.push({
                        type: 'Case Study',
                        label: c.title,
                        sub: c.disease,
                        action: () => {
                            loadChapter('case_library');
                            setTimeout(() => {
                                if (window.toggleCaseDetails) window.toggleCaseDetails(idx);
                            }, 300);
                        }
                    });
                }
            });
        }

        // Render Results
        if (matches.length === 0) {
            resultsContainer.style.display = 'block';
            resultsContainer.innerHTML = '<div style="padding: 0.5rem; color: #666; font-style: italic;">No results found.</div>';
            return;
        }

        const topMatches = matches.slice(0, 8); // Limit to 8
        resultsContainer.style.display = 'block';
        resultsContainer.innerHTML = topMatches.map((m, i) => `
            <div class="search-result-item" onclick="window.HomeDashboard.results[${i}].action()" 
                 style="padding: 0.75rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.1s;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong style="color: var(--navy-primary);">${m.label}</strong>
                    <span class="neo-badge small" style="font-size: 0.7rem; background: #f1f5f9; color: #64748b;">${m.type}</span>
                </div>
                ${m.sub ? `<div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">${m.sub}</div>` : ''}
            </div>
        `).join('');

        // Store actions slightly differently to access them via index in HTML
        this.results = topMatches;

        // Add hover effect via JS since inline styles are messy for hover
        const items = resultsContainer.querySelectorAll('.search-result-item');
        items.forEach(item => {
            item.onmouseover = () => item.style.background = '#f8fafc';
            item.onmouseout = () => item.style.background = 'white';
        });
    }
}

window.HomeDashboard = new HomeDashboard();

class RulebookWidget {
    constructor() {
        // Wait for DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.init());
        } else {
            this.init();
        }
    }

    init() {
        if (document.getElementById('rulebook-root')) return;
        this.injectStyles();
        this.createElements();
        this.renderContent();
    }

    injectStyles() {
        const style = document.createElement('style');
        style.textContent = `
            #rulebook-fab {
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background: var(--navy-primary);
                color: white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
                cursor: pointer;
                transition: transform 0.2s, background 0.2s;
                z-index: 1000;
                border: 2px solid white;
            }
            #rulebook-fab:hover {
                transform: scale(1.1);
                background: var(--accent-blue);
            }
            #rulebook-sidebar {
                position: fixed;
                top: 0;
                right: -350px; /* Hidden */
                width: 350px;
                height: 100vh;
                background: white;
                box-shadow: -4px 0 15px rgba(0,0,0,0.1);
                z-index: 1001;
                transition: right 0.3s ease-in-out;
                display: flex;
                flex-direction: column;
                border-left: 1px solid #eee;
            }
            #rulebook-sidebar.open {
                right: 0;
            }
            .rb-header {
                padding: 1.5rem;
                background: var(--navy-primary);
                color: white;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .rb-content {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
            }
            .rb-category {
                margin-bottom: 1.5rem;
            }
            .rb-cat-title {
                font-weight: 800;
                color: var(--accent-orange);
                text-transform: uppercase;
                font-size: 0.85rem;
                margin-bottom: 0.5rem;
                border-bottom: 2px solid #eee;
                padding-bottom: 0.25rem;
            }
            .rb-rule-item {
                font-size: 0.9rem;
                margin-bottom: 0.75rem;
                padding: 0.5rem;
                background: #f8fafc;
                border-radius: 6px;
                border-left: 3px solid #ccc;
                cursor: pointer;
                transition: background 0.2s;
            }
            .rb-rule-item:hover {
                background: #eef2ff;
                border-left-color: var(--accent-blue);
            }
            .rb-rule-id {
                font-weight: bold;
                color: var(--navy-primary);
                font-size: 0.8rem;
                display: block;
            }
            .rb-overlay {
                position: fixed;
                top: 0; left: 0; bottom: 0; right: 0;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
                display: none;
                opacity: 0;
                transition: opacity 0.3s;
            }
            .rb-overlay.show {
                display: block;
                opacity: 1;
            }
        `;
        document.head.appendChild(style);
    }

    createElements() {
        const root = document.createElement('div');
        root.id = 'rulebook-root';
        root.innerHTML = `
            <div id="rulebook-fab" title="Open Rulebook Reference" onclick="window.RulebookWidget.toggle()">
                <i class="ph-bold ph-book-bookmark"></i>
            </div>
            <div class="rb-overlay" id="rulebook-overlay" onclick="window.RulebookWidget.toggle()"></div>
            <aside id="rulebook-sidebar">
                <div class="rb-header">
                    <h3 style="margin:0; font-size:1.2rem;">Rulebook Reference</h3>
                    <button onclick="window.RulebookWidget.toggle()" style="background:none; border:none; color:white; cursor:pointer;">
                        <i class="ph-bold ph-x" style="font-size:1.5rem;"></i>
                    </button>
                </div>
                <div class="rb-content" id="rb-content-area">
                    <!-- Dynamic Rules -->
                </div>
                <div style="padding:1rem; border-top:1px solid #eee; font-size:0.8rem; color:#666; text-align:center;">
                    2026 Official Rules Draft (Div B)
                </div>
            </aside>
        `;
        document.body.appendChild(root);
    }

    renderContent() {
        if (!window.RULES_DATA) {
            document.getElementById('rb-content-area').innerHTML = "<p>Rule data not found.</p>";
            return;
        }

        const rules = window.RULES_DATA.rules;
        // Group by prefix (1., 2., etc)
        const groups = {};
        const titles = {
            "1": "Scientific Inquiry",
            "2": "Pattern Recognition",
            "3": "Etiology",
            "4": "Calculations",
            "5": "Prevention & Control",
            "6": "Public Health Systems"
        };

        for (const [id, desc] of Object.entries(rules)) {
            const prefix = id.split('.')[0];
            if (!groups[prefix]) groups[prefix] = [];
            groups[prefix].push({ id, desc });
        }

        let html = "";
        for (const [prefix, list] of Object.entries(groups)) {
            const title = titles[prefix] || "General";
            html += `
                <div class="rb-category">
                    <div class="rb-cat-title">${prefix}. ${title}</div>
                    ${list.map(r => `
                        <div class="rb-rule-item" onclick="window.RulebookWidget.findChapter('${r.id}')">
                            <span class="rb-rule-id">Rule ${r.id}</span>
                            ${r.desc.replace(`${title}: `, '').replace(`${title} `, '')} <!-- Clean desc -->
                        </div>
                    `).join('')}
                </div>
            `;
        }
        document.getElementById('rb-content-area').innerHTML = html;
    }

    toggle() {
        const sb = document.getElementById('rulebook-sidebar');
        const overlay = document.getElementById('rulebook-overlay');
        const fab = document.getElementById('rulebook-fab');

        if (sb.classList.contains('open')) {
            sb.classList.remove('open');
            overlay.classList.remove('show');
            setTimeout(() => overlay.style.display = 'none', 300);
            fab.style.transform = 'scale(1)';
        } else {
            overlay.style.display = 'block';
            setTimeout(() => overlay.classList.add('show'), 10); // Trigger transition
            sb.classList.add('open');
            fab.style.transform = 'scale(0)';
        }
    }

    findChapter(ruleId) {
        // Reverse lookup
        if (!window.RULES_DATA || !window.RULES_DATA.mapping) return;

        const reverseMap = [];
        for (const [chap, rules] of Object.entries(window.RULES_DATA.mapping)) {
            if (rules.includes(ruleId) || rules.includes('*')) {
                reverseMap.push(chap);
            }
        }

        if (reverseMap.length > 0) {
            // Load the first one
            // We assume loadChapter is global
            if (window.loadChapter) {
                window.loadChapter(reverseMap[0]);
                this.toggle(); // Close sidebar
            }
        } else {
            alert("No direct chapter found for Rule " + ruleId);
        }
    }
}

window.RulebookWidget = new RulebookWidget();

class ProctorTimer {
    constructor(containerId) {
        this.containerId = containerId;
        this.duration = 50 * 60; // default 50 mins
        this.timeLeft = this.duration;
        this.interval = null;
        this.isRunning = false;

        // Audio Context lazy init
        this.audioCtx = null;

        this.render();
    }

    render() {
        const container = document.getElementById(this.containerId);
        if (!container) return;

        const m = Math.floor(this.timeLeft / 60);
        const s = this.timeLeft % 60;
        const timeStr = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

        // Progress percentage for background fill or bar
        const pct = (this.timeLeft / this.duration) * 100;
        let color = '#10b981'; // Green
        if (pct < 20) color = '#ef4444'; // Red
        else if (pct < 50) color = '#f59e0b'; // Output

        container.innerHTML = `
            <div class="proctor-wrapper" style="text-align: center; max-width: 600px; margin: 0 auto;">
                 <h2 style="color: var(--navy-primary); margin-bottom: 2rem;">Exam Proctoring Tool</h2>
                 
                 <div class="timer-display" style="
                    font-size: 8rem; 
                    font-weight: 800; 
                    font-family: monospace; 
                    color: ${color};
                    background: #1e293b;
                    padding: 2rem;
                    border-radius: 16px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    margin-bottom: 2rem;
                    position: relative;
                    overflow: hidden;
                 ">
                    <div style="position: relative; z-index: 2;" role="timer" aria-live="off" id="pt-display-text">${timeStr}</div>
                    <div class="timer-progress" style="
                        position: absolute; bottom: 0; left: 0; height: 6px; background: ${color}; width: ${pct}%; transition: width 1s linear, background 0.3s;
                    "></div>
                 </div>

                 <div class="controls-row" style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem;">
                    <button id="pt-start" class="neo-btn primary large" onclick="window.proctorTimer.start()" aria-label="Start Timer">
                        <i class="ph-bold ph-play"></i> Start
                    </button>
                    <button id="pt-stop" class="neo-btn danger large" onclick="window.proctorTimer.stop()" style="display: none;" aria-label="Stop Timer">
                        <i class="ph-bold ph-stop"></i> Stop
                    </button>
                    <button class="neo-btn outline" onclick="window.proctorTimer.reset()" aria-label="Reset Timer">
                        <i class="ph-bold ph-arrow-counter-clockwise"></i> Reset
                    </button>
                 </div>

                 <div class="presets-row" style="display: flex; gap: 0.5rem; justify-content: center;">
                    <button class="neo-btn small outline" onclick="window.proctorTimer.setDuration(50)">50m (Std)</button>
                    <button class="neo-btn small outline" onclick="window.proctorTimer.setDuration(30)">30m</button>
                    <button class="neo-btn small outline" onclick="window.proctorTimer.setDuration(15)">15m</button>
                    <button class="neo-btn small outline" onclick="window.proctorTimer.setDuration(5)">5m</button>
                 </div>
                 
                 <div style="margin-top: 2rem; font-size: 0.9rem; color: #64748b;">
                    <p><i class="ph-bold ph-speaker-high"></i> Audio cues at Start, 5 min warning, and End.</p>
                 </div>
            </div>
        `;
    }

    start() {
        if (this.isRunning) return;

        // Init Audio
        if (!this.audioCtx) {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (this.audioCtx.state === 'suspended') this.audioCtx.resume();

        this.isRunning = true;
        this.playBeep('start');

        document.getElementById('pt-start').style.display = 'none';
        document.getElementById('pt-stop').style.display = 'inline-block';

        this.interval = setInterval(() => {
            this.timeLeft--;
            if (this.timeLeft === 300) {
                this.playBeep('warning');
                // Announce warning
                const disp = document.getElementById('pt-display-text');
                if (disp) disp.setAttribute('aria-live', 'assertive');
            }
            if (this.timeLeft <= 0) {
                this.finish();
            } else {
                this.updateDisplay();
            }
        }, 1000);
    }

    stop() {
        if (!this.isRunning) return;
        this.isRunning = false;
        clearInterval(this.interval);
        document.getElementById('pt-start').style.display = 'inline-block';
        document.getElementById('pt-stop').style.display = 'none';

        document.getElementById('pt-start').innerHTML = '<i class="ph-bold ph-play"></i> Resume';
    }

    reset() {
        this.stop();
        this.timeLeft = this.duration;
        this.updateDisplay();
        document.getElementById('pt-start').innerHTML = '<i class="ph-bold ph-play"></i> Start';
        const disp = document.getElementById('pt-display-text');
        if (disp) {
            disp.setAttribute('aria-live', 'off');
            disp.textContent = this.formatTime(this.duration);
        }
    }

    setDuration(mins) {
        this.stop();
        this.duration = mins * 60;
        this.timeLeft = this.duration;
        this.updateDisplay();
    }

    finish() {
        this.stop();
        this.timeLeft = 0;
        this.updateDisplay();
        this.playBeep('end');
        alert("TIME IS UP!");
    }

    formatTime(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    updateDisplay() {
        const container = document.getElementById(this.containerId);
        if (!container) return;

        const timeStr = this.formatTime(this.timeLeft);

        const displayEl = document.getElementById('pt-display-text');
        if (displayEl) displayEl.textContent = timeStr;
        else {
            this.render(); // Fallback
            return;
        }

        const pct = (this.timeLeft / this.duration) * 100;
        let color = '#10b981';
        if (pct < 20) color = '#ef4444';
        else if (pct < 50) color = '#f59e0b';

        const wrapper = container.querySelector('.timer-display');
        if (wrapper) wrapper.style.color = color;

        const bar = container.querySelector('.timer-progress');
        if (bar) {
            bar.style.width = `${pct}%`;
            bar.style.background = color;
        }

        // Ensure buttons sync
        const startBtn = document.getElementById('pt-start');
        const stopBtn = document.getElementById('pt-stop');
        if (this.isRunning) {
            if (startBtn) startBtn.style.display = 'none';
            if (stopBtn) stopBtn.style.display = 'inline-block';
        } else {
            if (startBtn) startBtn.style.display = 'inline-block';
            if (stopBtn) stopBtn.style.display = 'none';
        }
    }

    playBeep(type) {
        if (!this.audioCtx) return;

        const osc = this.audioCtx.createOscillator();
        const gain = this.audioCtx.createGain();
        osc.connect(gain);
        gain.connect(this.audioCtx.destination);

        const now = this.audioCtx.currentTime;

        if (type === 'start') {
            osc.frequency.setValueAtTime(880, now); // A5
            gain.gain.setValueAtTime(0.1, now);
            osc.start(now);
            osc.stop(now + 0.1);
        } else if (type === 'warning') {
            osc.frequency.setValueAtTime(660, now);
            osc.start(now);
            osc.stop(now + 0.2);

            const osc2 = this.audioCtx.createOscillator();
            const gain2 = this.audioCtx.createGain();
            osc2.connect(gain2);
            gain2.connect(this.audioCtx.destination);
            osc2.frequency.setValueAtTime(660, now + 0.3);
            osc2.start(now + 0.3);
            osc2.stop(now + 0.5);
        } else if (type === 'end') {
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.linearRampToValueAtTime(110, now + 1);
            gain.gain.setValueAtTime(0.5, now);
            gain.gain.linearRampToValueAtTime(0, now + 1);
            osc.start(now);
            osc.stop(now + 1);
        }
    }
}

window.ProctorTimer = ProctorTimer;
window.proctorTimer = null;

class PacketGenerator {
    static init() {
        // Expose global function
        window.generateStudyGuide = this.generateStudyGuide.bind(this);
    }

    static generateStudyGuide() {
        if (typeof window.EPIDEMIC_ENGINE_CONTENT === 'undefined') {
            alert("Content not loaded.");
            return;
        }

        const chapters = [
            'ch1', 'ch2', 'ch3', 'ch4', 'ch5', 'ch6',
            'ch7', 'ch8', 'ch9', 'ch10', 'ch11', 'ch12', 'ch13',
            'ch14', 'ch15', 'ch16', 'ch17', 'ch18', 'ch19', 'ch20'
        ];

        let htmlContent = '';

        // Generate Table of Contents
        let tocHtml = `<div class="toc-page" style="page-break-after: always;">
            <h2 style="text-align:center; border-bottom: 2px solid black; padding-bottom: 1rem;">Table of Contents</h2>
            <ul style="list-style: none; padding: 0;">`;

        chapters.forEach(id => {
            const ch = window.EPIDEMIC_ENGINE_CONTENT[id];
            if (ch) {
                tocHtml += `<li style="margin-bottom: 0.5rem; border-bottom: 1px dotted #ccc; display: flex; justify-content: space-between;">
                    <span>${ch.title.split(':')[0]}</span>
                    <span>${ch.title.split(':')[1] || ''}</span>
                </li>`;
            }
        });

        tocHtml += `
            <li style="margin-top: 1rem; font-weight: bold;">Appendices</li>
            <li>Glossary</li>
            <li>Formulas</li>
        </ul></div>`;

        htmlContent += tocHtml;

        // Generate Chapters
        chapters.forEach(id => {
            const ch = window.EPIDEMIC_ENGINE_CONTENT[id];
            if (!ch) return;

            // Clean Content
            let cleanBody = this.cleanContent(ch.content);

            htmlContent += `
                <div class="chapter-section" style="page-break-before: always;">
                    <div class="chapter-header" style="border-bottom: 4px solid black; margin-bottom: 2rem; padding-bottom: 0.5rem;">
                        <h2 style="margin: 0; font-size: 2rem;">${ch.title}</h2>
                        <div style="font-style: italic; margin-top: 0.25rem;">Epidemic Engine v2.0 Study Guide</div>
                    </div>
                    <div class="chapter-body" style="line-height: 1.6; font-size: 11pt; text-align: justify;">
                        ${cleanBody}
                    </div>
                </div>
            `;
        });

        // Add Appendices (Glossary/Formulas) if available
        // We'd need to extract them from APPENDIX_DATA usually, but for now we might skip or grab snippets.
        // Let's assume APPENDIX_DATA is available.
        if (typeof window.APPENDIX_DATA !== 'undefined') {
            htmlContent += this.generateGlossary();
        }

        this.openPrintWindow(htmlContent);
    }

    static cleanContent(html) {
        // Create a temporary DOM to manipulate
        const div = document.createElement('div');
        div.innerHTML = html;

        // Remove interactive elements
        const removables = div.querySelectorAll('button, input, select, .tool-container, .tool-tabs, .mobile-only, .video-container');
        removables.forEach(el => el.remove());

        // Replace Drill Boxes with Static versions if possible, or just style them
        const drills = div.querySelectorAll('.drill-box, .neo-card');
        drills.forEach(el => {
            el.style.border = '1px solid black';
            el.style.boxShadow = 'none';
            el.style.background = 'white';
            el.style.padding = '1rem';
            el.style.marginBottom = '1rem';
        });

        // Fix Callouts
        const callouts = div.querySelectorAll('.callout-header, .callout-content');
        callouts.forEach(el => {
            el.style.color = 'black';
            el.style.background = 'transparent';
        });

        // Expand Accordions (Answers)
        const accordions = div.querySelectorAll('.accordion');
        accordions.forEach(acc => {
            const content = acc.querySelector('.accordion-content');
            if (content) {
                const p = document.createElement('div');
                p.innerHTML = content.innerHTML;
                p.style.marginTop = '0.5rem';
                p.style.paddingLeft = '1rem';
                p.style.borderLeft = '2px solid #ccc';
                acc.replaceWith(p);
            } else {
                acc.remove();
            }
        });

        return div.innerHTML;
    }

    static generateGlossary() {
        if (!window.APPENDIX_DATA || !window.APPENDIX_DATA.glossary) return '';

        let html = `<div class="appendix-section" style="page-break-before: always;">
            <h1 style="border-bottom: 4px solid black;">Appendix A: Glossary</h1>
            <dl>`;

        window.APPENDIX_DATA.glossary.forEach(term => {
            html += `<dt style="font-weight: bold; margin-top: 1rem;">${term.term}</dt>
                     <dd style="margin-left: 1.5rem;">${term.def}</dd>`;
        });

        html += `</dl></div>`;
        return html;
    }

    static openPrintWindow(content) {
        const win = window.open('', '_blank');
        win.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Epidemic Engine Study Guide</title>
                <style>
                    body { font-family: 'Times New Roman', serif; color: black; max-width: 800px; margin: 0 auto; padding: 2cm; }
                    img { max-width: 100%; height: auto; filter: grayscale(100%); }
                    table { border-collapse: collapse; width: 100%; margin: 1rem 0; }
                    th, td { border: 1px solid black; padding: 0.5rem; text-align: left; }
                    h1, h2, h3 { color: black; page-break-after: avoid; }
                    p { margin-bottom: 1rem; orphans: 3; widows: 3; }
                    .neo-badge { border: 1px solid black; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
                    a { text-decoration: underline; color: black; }
                    @media print {
                         @page { margin: 2cm; }
                         body { margin: 0; padding: 0; max-width: none; }
                    }
                </style>
            </head>
            <body>
                <div class="cover-page" style="text-align: center; page-break-after: always; padding-top: 30%;">
                    <h1 style="font-size: 4rem; margin-bottom: 1rem;">Epidemic Engine</h1>
                    <h2 style="font-size: 2rem; font-weight: normal; margin-bottom: 4rem;">Comprehensive Study Guide</h2>
                    <p><strong>Division B (Middle School)</strong></p>
                    <p>Generated: ${new Date().toLocaleDateString()}</p>
                    <p style="margin-top: 4rem;"><em>This document contains all educational content from the Epidemic Engine application.</em></p>
                </div>
                ${content}
            </body>
            </html>
        `);
        win.document.close();
        // win.print(); // Optional auto-print
    }
}

// Init immediately
PacketGenerator.init();

/**
 * Epidemic Engine - Interactive Scenario Engine
 * "Choose Your Own Adventure" style outbreak simulations.
 */

class ScenarioEngine {
    constructor(containerId = 'interactive-cases-root') {
        this.containerId = containerId;
        this.currentScenario = null;
        this.currentNodeId = null;
        this.history = [];
        this.state = {
            integrity: 100, // Health/Public Trust
            budget: 1000,
            time: 0 // Days elapsed
        };

        // Scenario Database
        this.scenarios = window.SCENARIO_DB || {};
    }

    init() {
        // Called when chapter loads.
        this.renderMenu();
    }

    renderMenu() {
        const container = document.getElementById(this.containerId);
        if (!container) return; // Not on the right page



        // Group by category
        const categories = {
            'investigation': { title: 'Field Invest', icon: 'ph-magnifying-glass' },
            'calc': { title: 'Epi Math', icon: 'ph-calculator' },
            'linelist': { title: 'Data Detective', icon: 'ph-table' },
            'graph': { title: 'Visual Analytics', icon: 'ph-chart-line' }
        };

        const grouped = {};
        Object.keys(this.scenarios).forEach(key => {
            const s = this.scenarios[key];
            const cat = s.category || 'investigation';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push({ key, ...s });
        });

        let html = `<div class="scenarios-container">
            <h2 style="margin-bottom: 0.5rem;"><i class="ph-bold ph-strategy"></i> Simulation Center</h2>
            <p class="lead" style="margin-bottom: 2rem; color: #666;">
                Master key skills through interactive "Choose Your Own Adventure" stations. 
                Each scenario mimics a <strong>Station</strong> you might encounter in a Science Olympiad competition.
            </p>`;

        Object.keys(categories).forEach(catId => {
            const items = grouped[catId];
            if (!items || items.length === 0) return;

            html += `
                <div class="category-section" style="margin-bottom: 2rem;">
                    <h3 style="border-bottom: 2px solid var(--accent-orange); padding-bottom: 0.5rem; display: inline-block;">
                        <i class="ph-bold ${categories[catId].icon}"></i> ${categories[catId].title}
                    </h3>
                    <div class="grid" style="gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-top: 1rem;">
            `;

            items.forEach(s => {
                const diffColor = s.difficulty === 'Hard' || s.difficulty === 'Advanced' ? '#ef4444' : (s.difficulty === 'Medium' || s.difficulty === 'Intermediate' ? '#f59e0b' : '#22c55e');
                const diffBg = s.difficulty === 'Hard' || s.difficulty === 'Advanced' ? '#fef2f2' : (s.difficulty === 'Medium' || s.difficulty === 'Intermediate' ? '#fffbeb' : '#f0fdf4');

                html += `
                    <button class="neo-card interactive-card" style="display: flex; flex-direction: column; height: 100%; border: 1px solid #ddd; transition: all 0.2s ease; cursor: pointer; width: 100%; text-align: left; background: white;" onclick="window.ScenarioEngine.startScenario('${s.key}')">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <h4 style="margin: 0; color: var(--navy-primary); font-size: 1.15rem; font-weight: 700;">${s.title}</h4>
                                <span class="neo-badge small" style="background: ${diffBg}; color: ${diffColor}; border: 1px solid ${diffColor}; font-size: 0.75rem; white-space: nowrap;">${s.difficulty}</span>
                            </div>
                            
                            <p style="font-size: 0.95rem; color: #555; line-height: 1.5; margin-bottom: 1.5rem;">
                                ${s.description}
                            </p>
                        </div>

                        <div style="margin-top: auto;">
                            <span class="neo-btn primary full-width" style="display: block; text-align: center;">
                                <i class="ph-bold ph-play-circle" style="vertical-align: middle; margin-right: 6px;"></i> Start Simulation
                            </span>
                        </div>
                    </button>
                `;
            });

            html += `</div></div>`;
        });

        html += `</div>`;
        container.innerHTML = html;
        return;


    }

    startScenario(id) {
        this.currentScenario = this.scenarios[id];
        this.currentNodeId = 'start';
        this.history = [];
        this.state = { integrity: 100, budget: 1000, time: 0 };
        this.renderNode();

        // Scroll to top
        const container = document.getElementById(this.containerId);
        if (container) container.scrollIntoView({ behavior: 'smooth' });
    }

    renderNode() {
        const container = document.getElementById(this.containerId);
        if (!container || !this.currentScenario) return;

        const node = this.currentScenario.nodes[this.currentNodeId];

        let choicesHtml = '';

        if (node.type === 'reflection') {
            choicesHtml = `
                <div class="reflection-box" style="margin-top: 2rem;">
                    <label style="display:block; font-weight:bold; margin-bottom:0.5rem; color:var(--accent-color);">
                        <i class="ph-bold ph-pencil-simple"></i> Critical Thinking Challenge
                    </label>
                    <p style="font-size:0.9rem; color:#666;">Type your answer below before revealing the expert analysis.</p>
                    <textarea id="reflection-input" class="neo-input" rows="4" placeholder="Explain your reasoning..." style="width:100%; margin-bottom:1rem; font-family:var(--font-body);"></textarea>
                    
                    <div id="reflection-feedback" role="status" style="display:none; background:#f0fdf4; padding:1.5rem; border-left:4px solid #22c55e; margin-bottom:1rem; border-radius:0 8px 8px 0;">
                        <h4 style="margin-top:0; color:#15803d; font-size:1.1rem;"><i class="ph-bold ph-check-circle"></i> Expert Analysis:</h4>
                        <p style="margin-bottom:0;">${node.feedback || "Good reasoning. Proceed to see the outcome."}</p>
                    </div>

                    <div style="display:flex; gap:1rem; align-items:center;">
                        <button id="reflection-btn" class="neo-btn primary" onclick="
                            const fb = document.getElementById('reflection-feedback');
                            const btn = this;
                            const nextBtn = document.getElementById('reflection-next');
                            const input = document.getElementById('reflection-input');
                            
                            fb.style.display='block';
                            btn.style.display='none';
                            nextBtn.style.display='inline-flex';
                            input.disabled=true;
                            fb.focus();
                        ">Submit Reasoning</button>
                        
                        <button id="reflection-next" class="neo-btn outline" style="display:none;" onclick="window.ScenarioEngine.makeChoice(0)">
                            Continue <i class="ph-bold ph-arrow-right" style="margin-left:0.5rem;"></i>
                        </button>
                    </div>
                </div>
            `;
        } else if (node.choices) {
            choicesHtml = `<div class="scenario-choices" style="display: grid; gap: 1rem; margin-top: 2rem;">`;
            node.choices.forEach((choice, idx) => {
                choicesHtml += `
                    <button class="neo-btn outline" onclick="window.ScenarioEngine.makeChoice(${idx})" style="text-align: left; justify-content: flex-start; padding: 1rem;">
                        <span style="font-weight: bold; color: var(--accent-color); margin-right: 0.5rem;">${String.fromCharCode(65 + idx)}.</span>
                        ${choice.text}
                        <span style="margin-left: auto; font-size: 0.8rem; opacity: 0.7;">
                            ${choice.cost > 0 ? `-$${choice.cost}` : ''} 
                            ${choice.time > 0 ? `+${choice.time}h` : ''}
                        </span>
                    </button>
                `;
            });
            choicesHtml += `</div>`;
        } else if (node.end) {
            choicesHtml = `
                <div style="margin-top: 2rem; text-align: center;">
                    <button class="neo-btn primary large" onclick="window.ScenarioEngine.renderMenu()">Return to Menu</button>
                </div>
             `;
        }

        container.innerHTML = `
            <div class="neo-card" style="max-width: 800px; margin: 0 auto; border-top: 4px solid var(--navy-primary);" role="region" aria-label="Scenario Scenario">
                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 1rem; margin-bottom: 1rem;" aria-live="polite">
                    <div><strong>Case:</strong> ${this.currentScenario.title}</div>
                    <div style="display: flex; gap: 1rem;">
                        <span aria-label="Integrity: ${this.state.integrity} percent"><i class="ph-bold ph-heart" aria-hidden="true"></i> ${this.state.integrity}%</span>
                        <span aria-label="Time Elapsed: ${this.state.time} hours"><i class="ph-bold ph-clock" aria-hidden="true"></i> +${this.state.time}h</span>
                        <span aria-label="Budget Remaining: ${this.state.budget} dollars"><i class="ph-bold ph-money" aria-hidden="true"></i> $${this.state.budget}</span>
                    </div>
                </div>
                
                <div class="scenario-text" tabindex="-1" style="font-size: 1.1rem; line-height: 1.6; outline: none;">
                    ${node.text}
                </div>

                ${choicesHtml}
            </div>
        `;

        // Focus management: move focus to the new text so screen reader starts reading
        setTimeout(() => {
            const textEl = container.querySelector('.scenario-text');
            if (textEl) textEl.focus();
        }, 50);
    }

    makeChoice(index) {
        if (!this.currentScenario) return;
        const node = this.currentScenario.nodes[this.currentNodeId];
        const choice = node.choices[index];

        this.state.budget -= (choice.cost || 0);
        this.state.time += (choice.time || 0);

        // Integrity check? (if budget < 0)

        this.history.push({ nodeId: this.currentNodeId, choiceIndex: index });
        this.currentNodeId = choice.next;
        this.renderNode();
    }
}

window.ScenarioEngine = new ScenarioEngine();

/**
 * Flash Drills - Rapid Fire Practice
 * Pulls random questions from the Quiz Bank for infinite practice.
 */

class FlashDrills {
    constructor(containerId) {
        this.containerId = containerId;
        this.container = document.getElementById(containerId);
        this.currentQuestion = null;
        this.streak = 0;
        this.mode = 'all'; // all, math, logic

        if (this.container) {
            this.renderIntro();
        }
    }

    renderIntro() {
        this.container.innerHTML = `
            <div class="neo-card text-center" style="max-width: 600px; margin: 2rem auto; padding: 3rem;">
                <div style="font-size: 3rem; color: var(--accent-purple); margin-bottom: 1rem;">
                    <i class="ph-bold ph-lightning"></i>
                </div>
                <h2 style="margin-top:0; color:var(--navy-primary);">Flash Drills</h2>
                <p class="lead" style="margin-bottom: 2rem;">Rapid-fire practice to build your speed and intuition.</p>
                
                <div style="margin-bottom: 2rem;">
                    <label style="font-weight:bold; display:block; margin-bottom:0.5rem;">Select Topic:</label>
                    <select id="drill-mode" class="neo-select" style="max-width:300px; margin:0 auto;">
                        <option value="all">Everything (Mix)</option>
                        <option value="math">Calculations Only</option>
                        <option value="content">Concepts & Definitions</option>
                    </select>
                </div>

                <button class="neo-btn primary large" onclick="window.flashDrills.start()">
                    Start Practice <i class="ph-bold ph-play"></i>
                </button>
            </div>
        `;

        // Expose instance for onclick
        window.flashDrills = this;
    }

    start() {
        const select = document.getElementById('drill-mode');
        if (select) this.mode = select.value;
        this.streak = 0;
        this.nextQuestion();
    }

    nextQuestion() {
        this.currentQuestion = this.getRandomQuestion();

        if (!this.currentQuestion) {
            this.container.innerHTML = `<div class="alert alert-error">Error loading questions. Please reload.</div>`;
            return;
        }

        this.renderQuestion();
    }

    getRandomQuestion() {
        if (typeof QUIZ_BANKS === 'undefined') return null;

        let pool = [];

        // Flatten all banks
        Object.keys(QUIZ_BANKS).forEach(key => {
            const bank = QUIZ_BANKS[key];
            if (bank.questions) {
                // Filter by mode
                const validQuestions = bank.questions.filter(q => {
                    if (this.mode === 'all') return true;
                    const isMath = (q.type === 'calculation' || q.question.includes('Calculate') || q.type === 'math');
                    if (this.mode === 'math') return isMath;
                    if (this.mode === 'content') return !isMath;
                    return true;
                });
                pool = pool.concat(validQuestions);
            }
        });

        if (pool.length === 0) return null;
        return pool[Math.floor(Math.random() * pool.length)];
    }

    renderQuestion() {
        const q = this.currentQuestion;
        if (!q) return;

        // Shuffle options but keep track of correct one
        const options = q.options.map((text, idx) => ({ text, isCorrect: idx === q.correct }));
        // Simple shuffle
        for (let i = options.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [options[i], options[j]] = [options[j], options[i]];
        }

        const html = `
            <div style="max-width: 800px; margin: 0 auto; animation: slideUp 0.3s ease;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <button class="neo-btn small outline" onclick="window.flashDrills.renderIntro()">
                        <i class="ph-bold ph-arrow-left"></i> Exit
                    </button>
                    <div style="font-weight:bold; color:var(--accent-purple);">
                        Current Streak: <span style="font-size:1.2rem;">${this.streak}</span> ðŸ”¥
                    </div>
                </div>

                <div class="neo-card">
                    <div style="font-size: 1.2rem; font-weight: 500; margin-bottom: 2rem; border-bottom: 1px solid #eee; padding-bottom: 1.5rem;">
                        ${q.question}
                        ${q.image ? `<img src="${q.image}" style="max-width:100%; margin-top:1rem; border-radius:8px;">` : ''}
                    </div>

                    <div class="drill-options" style="display: grid; gap: 1rem;">
                        ${options.map((opt, idx) => `
                            <button class="drill-option neo-btn outline" 
                                onclick="window.flashDrills.checkAnswer(this, ${opt.isCorrect})"
                                style="text-align:left; padding: 1rem;">
                                <span style="font-weight:bold; margin-right:0.5rem;">${String.fromCharCode(65 + idx)}.</span> ${opt.text}
                            </button>
                        `).join('')}
                    </div>

                    <div id="drill-feedback" style="display:none; margin-top:2rem; padding-top:2rem; border-top:2px solid #eee;">
                        <h4 id="feedback-title" style="margin-top:0;"></h4>
                        <div id="feedback-text" style="margin-bottom:1.5rem;"></div>
                        <button class="neo-btn primary large" style="width:100%;" onclick="window.flashDrills.nextQuestion()">
                            Next Question <i class="ph-bold ph-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        this.container.innerHTML = html;

        // Focus first option for a11y
        setTimeout(() => {
            const first = this.container.querySelector('.drill-option');
            if (first) first.focus();
        }, 50);
    }

    checkAnswer(btn, isCorrect) {
        // Disable all buttons
        const allBtns = this.container.querySelectorAll('.drill-option');
        allBtns.forEach(b => {
            b.disabled = true;
            b.style.pointerEvents = 'none';
        });

        const feedback = document.getElementById('drill-feedback');
        const title = document.getElementById('feedback-title');
        const text = document.getElementById('feedback-text');

        feedback.style.display = 'block';

        if (isCorrect) {
            btn.style.background = '#dcfce7';
            btn.style.borderColor = '#16a34a';
            btn.style.color = '#14532d';
            title.textContent = "Correct! ðŸŽ‰";
            title.style.color = "#16a34a";
            text.innerHTML = this.currentQuestion.explanation || "Great job!";
            this.streak++;
        } else {
            btn.style.background = '#fee2e2';
            btn.style.borderColor = '#dc2626';
            title.textContent = "Incorrect";
            title.style.color = "#dc2626";

            // Highlight correct one
            // We need to find which button was correct
            // Since we shuffled, we might not know easily unless we stored it in DOM?
            // Actually, we passed isCorrect to the function. We can't find the other button easily
            // unless we store the data-is-correct attribute.
            // Let's just show the explanation which typically contains the answer.
            text.innerHTML = this.currentQuestion.explanation || "Review this concept.";
            this.streak = 0;
        }

        // Focus next button
        const nextBtn = feedback.querySelector('button');
        if (nextBtn) nextBtn.focus();
    }
}

/**
 * Visual Enhancements Module
 * Dynamically injects additional SVG diagrams into chapters
 * v2.5.0 Visual Learning Edition
 */

(function () {
    'use strict';

    const VisualEnhancements = {

        // Initialize on chapter load
        init: function () {
            // Hook into existing loadChapter system
            const originalLoadChapter = window.loadChapter;
            if (typeof originalLoadChapter === 'function') {
                window.loadChapter = function (chapterId, updateHistory) {
                    // Call original function
                    const result = originalLoadChapter.call(this, chapterId, updateHistory);

                    // Add visual enhancements after a short delay (allow DOM to settle)
                    setTimeout(() => {
                        VisualEnhancements.enhanceChapter(chapterId);
                    }, 150);

                    return result;
                };
            }
        },

        enhanceChapter: function (chapterId) {
            switch (chapterId) {
                case 'ch6':
                    this.addIncubationLatencyVisual();
                    break;
                case 'ch10':
                    this.addEpiCurveComparison();
                    break;
                case 'ch11':
                    this.add2x2TableTemplate();
                    break;
                case 'ch12':
                    this.addStudyDesignTree();
                    break;
            }
        },

        // Visual 1: Incubation vs Latency Timeline (Chapter 6)
        addIncubationLatencyVisual: function () {
            const container = document.getElementById('content-container');
            if (!container) return;

            // Find the table and insert visual after it
            const tables = container.querySelectorAll('table');
            if (tables.length === 0) return;

            const targetTable = Array.from(tables).find(t =>
                t.textContent.includes('Incubation Period') &&
                t.textContent.includes('Latency Period')
            );

            if (!targetTable || document.getElementById('visual-incubation-latency')) return;

            const visualDiv = document.createElement('div');
            visualDiv.id = 'visual-incubation-latency';
            visualDiv.style.cssText = 'text-align: center; margin: 2rem 0;';
            visualDiv.innerHTML = `
                <svg width="500" height="280" viewBox="0 0 500 280" class="responsive-svg" style="max-width: 100%; height: auto; background: white; border: 2px solid var(--navy-primary); border-radius: 8px; padding: 1rem;">
                    <text x="250" y="25" text-anchor="middle" font-weight="bold" font-size="16" fill="var(--navy-primary)">Incubation vs Latency</text>
                    
                    <!-- Incubation Period (Top) -->
                    <text x="20" y="55" font-weight="bold" font-size="13" fill="#c2410c">INCUBATION (Infectious)</text>
                    
                    <defs>
                        <marker id="arrowIncub" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#c2410c" />
                        </marker>
                        <marker id="arrowLat" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#a16207" />
                        </marker>
                    </defs>
                    
                    <line x1="40" y1="75" x2="420" y2="75" stroke="#c2410c" stroke-width="3" marker-end="url(#arrowIncub)"/>
                    <circle cx="40" cy="75" r="6" fill="#ef4444"/>
                    <text x="40" y="95" text-anchor="middle" font-size="11" font-weight="bold">Exposure</text>
                    <rect x="40" y="67" width="180" height="16" fill="#fef3c7" opacity="0.6"/>
                    <text x="130" y="62" text-anchor="middle" font-size="10" fill="#92400e">Incubation</text>
                    <circle cx="220" cy="75" r="6" fill="#22c55e"/>
                    <text x="220" y="95" text-anchor="middle" font-size="11" font-weight="bold">Symptoms</text>
                    <text x="320" y="72" font-size="12" fill="#666">Ex: Flu (1-4 days)</text>
                    
                    <!-- Latency Period (Bottom) -->
                    <text x="20" y="150" font-weight="bold" font-size="13" fill="#a16207">LATENCY (Chronic)</text>
                    <line x1="40" y1="170" x2="420" y2="170" stroke="#a16207" stroke-width="3" marker-end="url(#arrowLat)"/>
                    <circle cx="40" cy="170" r="6" fill="#ef4444"/>
                    <text x="40" y="190" text-anchor="middle" font-size="11" font-weight="bold">Exposure</text>
                    <rect x="40" y="162" width="310" height="16" fill="#fed7aa" opacity="0.6"/>
                    <text x="195" y="157" text-anchor="middle" font-size="10" fill="#92400e">Latency (Years)</text>
                    <circle cx="350" cy="170" r="6" fill="#3b82f6"/>
                    <text x="350" y="190" text-anchor="middle" font-size="11" font-weight="bold">Detectable</text>
                    <text x="260" y="220" font-size="12" fill="#666">Ex: Cancer (20+ years)</text>
                </svg>
                <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem; font-style: italic;"><strong>Key:</strong> Incubation = <em>days</em>; Latency = <em>years</em>.</p>
            `;

            // Insert after the table's parent container
            const tableContainer = targetTable.closest('.table-container') || targetTable.parentElement;
            tableContainer.insertAdjacentElement('afterend', visualDiv);
        },

        // Visual 2: Epi Curve Pattern Comparison (Chapter 10)
        addEpiCurveComparison: function () {
            const container = document.getElementById('content-container');
            if (!container || document.getElementById('visual-epi-curves')) return;

            // Find h2 with "Curve Logic" or similar
            const headers = container.querySelectorAll('h2');
            const targetHeader = Array.from(headers).find(h => h.textContent.includes('Curve') || h.textContent.includes('10.'));
            if (!targetHeader) return;

            const visualDiv = document.createElement('div');
            visualDiv.id = 'visual-epi-curves';
            visualDiv.style.cssText = 'margin: 2rem 0; padding: 1.5rem; background: #f8fafc; border: 2px solid var(--navy-primary); border-radius: 12px;';
            visualDiv.innerHTML = `
                <h3 style="text-align: center; color: var(--navy-primary); margin-bottom: 1.5rem;">
                    <i class="ph-bold ph-chart-line"></i> Epi Curve Pattern Recognition Guide
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    
                    <!-- Point Source -->
                    <div class="neo-card" style="padding: 1rem;">
                        <h4 style="color: #dc2626; margin-top: 0;">Point Source</h4>
                        <svg width="100%" height="120" viewBox="0 0 200 120">
                            <path d="M10,100 L40,100 L60,40 L80,30 L100,20 L120,40 L140,70 L160,90 L190,100" 
                                  fill="none" stroke="#dc2626" stroke-width="3"/>
                            <text x="100" y="115" text-anchor="middle" font-size="11" fill="#666">Time â†’</text>
                        </svg>
                        <p style="font-size: 0.85rem; margin: 0.5rem 0 0 0;"><strong>Shape:</strong> Sharp peak, rapid decline</p>
                        <p style="font-size: 0.85rem; margin: 0.25rem 0 0 0;"><em>Example: Wedding buffet outbreak</em></p>
                    </div>
                    
                    <!-- Continuous Source -->
                    <div class="neo-card" style="padding: 1rem;">
                        <h4 style="color: #ea580c; margin-top: 0;">Continuous Source</h4>
                        <svg width="100%" height="120" viewBox="0 0 200 120">
                            <rect x="40" y="40" width="120" height="45" fill="#fed7aa" opacity="0.6"/>
                            <path d="M10,100 L40,45 L160,45 L190,100" 
                                  fill="none" stroke="#ea580c" stroke-width="3"/>
                            <text x="100" y="115" text-anchor="middle" font-size="11" fill="#666">Time â†’</text>
                        </svg>
                        <p style="font-size: 0.85rem; margin: 0.5rem 0 0 0;"><strong>Shape:</strong> Plateau</p>
                        <p style="font-size: 0.85rem; margin: 0.25rem 0 0 0;"><em>Example: Contaminated well</em></p>
                    </div>
                    
                    <!-- Propagated -->
                    <div class="neo-card" style="padding: 1rem;">
                        <h4 style="color: #16a34a; margin-top: 0;">Propagated</h4>
                        <svg width="100%" height="120" viewBox="0 0 200 120">
                            <path d="M10,100 L30,80 L50,40 L70,70 L90,35 L110,60 L130,30 L150,55 L170,45 L190,65" 
                                  fill="none" stroke="#16a34a" stroke-width="3"/>
                            <text x="100" y="115" text-anchor="middle" font-size="11" fill="#666">Time â†’</text>
                        </svg>
                        <p style="font-size: 0.85rem; margin: 0.5rem 0 0 0;"><strong>Shape:</strong> Successive peaks</p>
                        <p style="font-size: 0.85rem; margin: 0.25rem 0 0 0;"><em>Example: Measles outbreak</em></p>
                    </div>
                    
                    <!-- Intermittent -->
                    <div class="neo-card" style="padding: 1rem;">
                        <h4 style="color: #7c3aed; margin-top: 0;">Intermittent</h4>
                        <svg width="100%" height="120" viewBox="0 0 200 120">
                            <path d="M10,100 L30,95 L50,40 L70,95 L90,94 L110,35 L130,96 L150,93 L170,45 L190,97" 
                                  fill="none" stroke="#7c3aed" stroke-width="3"/>
                            <text x="100" y="115" text-anchor="middle" font-size="11" fill="#666">Time â†’</text>
                        </svg>
                        <p style="font-size: 0.85rem; margin: 0.5rem 0 0 0;"><strong>Shape:</strong> Irregular spikes</p>
                        <p style="font-size: 0.85rem; margin: 0.25rem 0 0 0;"><em>Example: Weekend picnics</em></p>
                    </div>
                </div>
                <div class="study-tip" style="margin-top: 1rem; background: #fffbeb; border-left: 4px solid #f59e0b; padding: 1rem;">
                    <strong><i class="ph-bold ph-lightbulb"></i> Exam Tip:</strong> Look at the overall shape first. Point source = ONE peak. Propagated = MULTIPLE peaks. Continuous = PLATEAU.
                </div>
            `;

            targetHeader.insertAdjacentElement('afterend', visualDiv);
        },

        // Visual 3: 2x2 Table Template (Chapter 11)
        add2x2TableTemplate: function () {
            const container = document.getElementById('content-container');
            if (!container || document.getElementById('visual-2x2-table')) return;

            // Find section about 2x2 tables or attack rates
            const headers = container.querySelectorAll('h2, h3');
            const targetHeader = Array.from(headers).find(h =>
                h.textContent.includes('2') && h.textContent.includes('2') ||
                h.textContent.includes('Attack') ||
                h.textContent.includes('Outbreak Math')
            );
            if (!targetHeader) return;

            const visualDiv = document.createElement('div');
            visualDiv.id = 'visual-2x2-table';
            visualDiv.style.cssText = 'margin: 2rem 0; padding: 1.5rem; background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); border: 3px solid var(--navy-primary); border-radius: 12px;';
            visualDiv.innerHTML = `
                <h3 style="text-align: center; color: var(--navy-primary); margin-bottom: 1rem;">
                    <i class="ph-bold ph-table"></i> The 2Ã—2 Table: Foundation of Outbreak Math
                </h3>
                <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; align-items: center;">
                    <div>
                        <table style="border-collapse: collapse; font-size: 14px; background: white; box-shadow: 4px 4px 0 rgba(0,0,0,0.1);">
                            <tr>
                                <td style="border: 2px solid #333; padding: 0.5rem; background: #f3f4f6;"></td>
                                <td style="border: 2px solid #333; padding: 0.5rem; text-align: center; font-weight: bold; background: #dbeafe;">Exposed</td>
                                <td style="border: 2px solid #333; padding: 0.5rem; text-align: center; font-weight: bold; background: #dbeafe;">Not Exposed</td>
                                <td style="border: 2px solid #333; padding: 0.5rem; text-align: center; font-weight: bold; background: #f3f4f6;">Total</td>
                            </tr>
                            <tr>
                                <td style="border: 2px solid #333; padding: 0.5rem; font-weight: bold; background: #fee2e2;">Ill</td>
                                <td style="border: 2px solid #333; padding: 1.5rem; text-align: center; font-size: 18px; font-weight: bold; background: #fef3c7;">a</td>
                                <td style="border: 2px solid #333; padding: 1.5rem; text-align: center; font-size: 18px; font-weight: bold; background: #fef3c7;">b</td>
                                <td style="border: 2px solid #333; padding: 1rem; text-align: center; font-weight: bold; background: #f3f4f6;">a+b</td>
                            </tr>
                            <tr>
                                <td style="border: 2px solid #333; padding: 0.5rem; font-weight: bold; background: #d1fae5;">Not Ill</td>
                                <td style="border: 2px solid #333; padding: 1.5rem; text-align: center; font-size: 18px; font-weight: bold; background: #e0f2fe;">c</td>
                                <td style="border: 2px solid #333; padding: 1.5rem; text-align: center; font-size: 18px; font-weight: bold; background: #e0f2fe;">d</td>
                                <td style="border: 2px solid #333; padding: 1rem; text-align: center; font-weight: bold; background: #f3f4f6;">c+d</td>
                            </tr>
                            <tr>
                                <td style="border: 2px solid #333; padding: 0.5rem; font-weight: bold; background: #f3f4f6;">Total</td>
                                <td style="border: 2px solid #333; padding: 1rem; text-align: center; font-weight: bold; background: #f3f4f6;">a+c</td>
                                <td style="border: 2px solid #333; padding: 1rem; text-align: center; font-weight: bold; background: #f3f4f6;">b+d</td>
                                <td style="border: 2px solid #333; padding: 1rem; text-align: center; font-weight: bold; background: #e5e7eb;">N</td>
                            </tr>
                        </table>
                    </div>
                    <div style="max-width: 350px;">
                        <div class="formula-box" style="margin-bottom: 1rem; padding: 1rem; background: white; border: 2px solid #10b981; border-radius: 8px;">
                            <strong style="color: #10b981;">Attack Rate (Exposed):</strong>
                            <p style="font-size: 1.2rem; margin: 0.5rem 0;">AR<sub>exp</sub> = a / (a+c)</p>
                        </div>
                        <div class="formula-box" style="margin-bottom: 1rem; padding: 1rem; background: white; border: 2px solid #3b82f6; border-radius: 8px;">
                            <strong style="color: #3b82f6;">Risk Ratio:</strong>
                            <p style="font-size: 1.2rem; margin: 0.5rem 0;">RR = [a/(a+c)] / [b/(b+d)]</p>
                        </div>
                        <div class="formula-box" style="padding: 1rem; background: white; border: 2px solid #8b5cf6; border-radius: 8px;">
                            <strong style="color: #8b5cf6;">Odds Ratio:</strong>
                            <p style="font-size: 1.2rem; margin: 0.5rem 0;">OR = (aÃ—d) / (bÃ—c)</p>
                        </div>
                    </div>
                </div>
                <div class="exam-trap" style="margin-top: 1rem; background: #fef2f2; border-left: 4px solid #dc2626; padding: 1rem;">
                    <strong><i class="ph-bold ph-warning"></i> Common Mistake:</strong> Students often swap rows/columns. Remember: <strong>EXPOSURE goes on TOP</strong>, DISEASE goes on the SIDE.
                </div>
            `;

            // Insert near the beginning of the chapter
            const firstParagraph = container.querySelector('p.lead') || container.querySelector('p');
            if (firstParagraph) {
                firstParagraph.insertAdjacentElement('afterend', visualDiv);
            }
        },

        // Visual 4: Study Design Decision Tree (Chapter 12)
        addStudyDesignTree: function () {
            const container = document.getElementById('content-container');
            if (!container || document.getElementById('visual-study-tree')) return;

            const headers = container.querySelectorAll('h2');
            const targetHeader = Array.from(headers).find(h =>
                h.textContent.includes('Study') || h.textContent.includes('Design') || h.textContent.includes('12.')
            );
            if (!targetHeader) return;

            const visualDiv = document.createElement('div');
            visualDiv.id = 'visual-study-tree';
            visualDiv.style.cssText = 'margin: 2rem 0;';
            visualDiv.innerHTML = `
                <div style="background: linear-gradient(to bottom right, #eff6ff, #dbeafe); border: 3px solid var(--navy-primary); border-radius: 12px; padding: 2rem;">
                    <h3 style="text-align: center; color: var(--navy-primary); margin-bottom: 1.5rem;">
                        <i class="ph-bold ph-tree-structure"></i> Study Design Selection Flowchart
                    </h3>
                    <svg width="100%" height="500" viewBox="0 0 600 500" style="max-width: 100%; height: auto;">
                        <defs>
                            <marker id="arrowTree" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <path d="M0,0 L0,6 L9,3 z" fill="#333" />
                            </marker>
                        </defs>
                        
                        <!-- Start -->
                        <rect x="200" y="20" width="200" height="50" rx="25" fill="#3b82f6" stroke="#1e40af" stroke-width="2"/>
                        <text x="300" y="50" text-anchor="middle" font-weight="bold" fill="white" font-size="16">START</text>
                        
                        <!-- Question 1: Outbreak Now? -->
                        <line x1="300" y1="70" x2="300" y2="100" stroke="#333" stroke-width="2" marker-end="url(#arrowTree)"/>
                        <rect x="150" y="100" width="300" height="60" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                        <text x="300" y="125" text-anchor="middle" font-weight="bold" font-size="14">Is there an outbreak</text>
                        <text x="300" y="145" text-anchor="middle" font-weight="bold" font-size="14">happening NOW?</text>
                        
                        <!-- Yes Branch -->
                        <line x1="250" y1="160" x2="150" y2="200" stroke="#333" stroke-width="2" marker-end="url(#arrowTree)"/>
                        <text x="180" y="185" font-size="12" font-weight="bold" fill="#16a34a">YES</text>
                        
                        <!-- Question 2: Rare Disease? -->
                        <rect x="20" y="200" width="260" height="60" rx="8" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
                        <text x="150" y="225" text-anchor="middle" font-weight="bold" font-size="14">Is the disease</text>
                        <text x="150" y="245" text-anchor="middle" font-weight="bold" font-size="14">RARE?</text>
                        
                        <!-- Case-Control -->
                        <line x1="80" y1="260" x2="80" y2="300" stroke="#333" stroke-width="2" marker-end="url(#arrowTree)"/>
                        <text x="50" y="285" font-size="11" font-weight="bold" fill="#16a34a">YES</text>
                        <rect x="10" y="300" width="140" height="80" rx="8" fill="#d1fae5" stroke="#10b981" stroke-width="3"/>
                        <text x="80" y="330" text-anchor="middle" font-weight="bold" font-size="13" fill="#065f46">CASE-CONTROL</text>
                        <text x="80" y="350" text-anchor="middle" font-size="10">Start with cases,</text>
                        <text x="80" y="365" text-anchor="middle" font-size="10">find controls</text>
                        
                        <!-- Cohort -->
                        <line x1="220" y1="260" x2="220" y2="300" stroke="#333" stroke-width="2" marker-end="url(#arrowTree)"/>
                        <text x="240" y="285" font-size="11" font-weight="bold" fill="#dc2626">NO</text>
                        <rect x="165" y="300" width="140" height="80" rx="8" fill="#e0f2fe" stroke="#0284c7" stroke-width="3"/>
                        <text x="235" y="330" text-anchor="middle" font-weight="bold" font-size="13" fill="#075985">COHORT</text>
                        <text x="235" y="350" text-anchor="middle" font-size="10">Follow exposed</text>
                        <text x="235" y="365" text-anchor="middle" font-size="10">and unexposed</text>
                        
                        <!-- No Branch (No Outbreak) -->
                        <line x1="350" y1="160" x2="450" y2="200" stroke="#333" stroke-width="2" marker-end="url(#arrowTree)"/>
                        <text x="420" y="185" font-size="12" font-weight="bold" fill="#dc2626">NO</text>
                        
                        <!-- Cross-Sectional -->
                        <rect x="320" y="200" width="260" height="60" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                        <text x="450" y="225" text-anchor="middle" font-weight="bold" font-size="14">Need quick snapshot?</text>
                        
                        <line x1="380" y1="260" x2="380" y2="300" stroke="#333" stroke-width="2" marker-end="url(#arrowTree)"/>
                        <text x="350" y="285" font-size="11" font-weight="bold" fill="#16a34a">YES</text>
                        <rect x="320" y="300" width="140" height="80" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="3"/>
                        <text x="390" y="330" text-anchor="middle" font-weight="bold" font-size="13" fill="#78350f">CROSS-SECT.</text>
                        <text x="390" y="350" text-anchor="middle" font-size="10">Survey at one</text>
                        <text x="390" y="365" text-anchor="middle" font-size="10">point in time</text>
                        
                        <line x1="520" y1="260" x2="520" y2="300" stroke="#333" stroke-width="2" marker-end="url(#arrowTree)"/>
                        <text x="540" y="285" font-size="11" font-weight="bold" fill="#dc2626">NO</text>
                        <rect x="470" y="300" width="120" height="80" rx="8" fill="#e0e7ff" stroke="#6366f1" stroke-width="3"/>
                        <text x="530" y="330" text-anchor="middle" font-weight="bold" font-size="13" fill="#3730a3">COHORT</text>
                        <text x="530" y="350" text-anchor="middle" font-size="10">Long-term</text>
                        <text x="530" y="365" text-anchor="middle" font-size="10">follow-up</text>
                        
                        <!-- Legend -->
                        <rect x="20" y="420" width="560" height="70" rx="8" fill="#f8fafc" stroke="#cbd5e1" stroke-width="2"/>
                        <text x="300" y="445" text-anchor="middle" font-weight="bold" font-size="14">Quick Reference</text>
                        <text x="150" y="465" text-anchor="middle" font-size="11"><tspan font-weight="bold">Outbreak + Rare:</tspan> Case-Control</text>
                        <text x="300" y="465" text-anchor="middle" font-size="11"><tspan font-weight="bold">Outbreak + Common:</tspan> Cohort</text>
                        <text x="450" y="465" text-anchor="middle" font-size="11"><tspan font-weight="bold">No Outbreak:</tspan> Cross-Sectional or Cohort</text>
                    </svg>
                </div>
                <div class="study-tip" style="margin-top: 1rem; background: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem;">
                    <strong><i class="ph-bold ph-lightbulb"></i> Exam Strategy:</strong> In Division B, you'll mostly see <strong>Case-Control</strong> (for outbreaks of rare diseases like Salmonella) and <strong>Cohort</strong> (for common exposures like food at a picnic).
                </div>
            `;

            targetHeader.insertAdjacentElement('afterend', visualDiv);
        }
    };

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => VisualEnhancements.init());
    } else {
        VisualEnhancements.init();
    }

    // Expose to window for debugging
    window.VisualEnhancements = VisualEnhancements;

})();


</script>
    <script>
        if ('serviceWorker' in navigator && (window.location.protocol === 'http:' || window.location.protocol === 'https:')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered!', reg.scope))
                    .catch(err => console.log('SW Failure:', err));
            });
        } else if (window.location.protocol === 'file:') {
            console.log('Service Workers are not supported on the file:// protocol. Run via a local server to test offline features.');
        }
    </script>
</body>

</html>

