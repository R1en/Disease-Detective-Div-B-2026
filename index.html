<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Epidemic Engine: Disease Detectives Mastery Guide (v5.0.0)</title>
    <meta property="og:title" content="Epidemic Engine - Disease Detectives Toolkit (v5.0.0)">
    <meta property="og:description"
        content="The ultimate offline training simulator for Science Olympiad. Features 50+ cases, Infinite Outbreak Generator, and precision calculators.">
    <meta property="og:image" content="assets/og-image.png">
    <meta name="twitter:card" content="summary_large_image">

    <!-- SEO -->
    <meta name="description"
        content="Free offline study tool for Science Olympiad Disease Detectives (Div B). Includes outbreak simulations, epi curve tools, and 50+ practice cases.">
    <meta name="keywords"
        content="Science Olympiad, Disease Detectives, Epidemiology, STEM, Public Health, CDC, Outbreak Simulation">
    <meta name="author" content="Epidemic Engine Team">

    <!-- iOS / PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Epi Engine">
    <link rel="apple-touch-icon" href="assets/logo.png">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff5c00">
    <link rel="icon" type="image/png" href="assets/logo.png">
    <script src="js/vendor/phosphor-icons.js"></script>

    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; font-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:; connect-src 'self';">
    <!--
      Use legacy styling files for the Epidemic Engine. The modern
      modular theme has been replaced with the original CSS to
      preserve the full UI and layout while implementing Phaseâ€‘2
      improvements. These styles define colours, typography and
      structural classes consistent with the original application.
    -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/epidemic-engine.css">
    <link rel="stylesheet" href="css/mobile-overrides.css">
</head>

<body>
    <div class="app-container">
        <!-- Accessibility: Overlay is now a button-like interactor -->
        <div class="sidebar-overlay" role="button" aria-label="Close Menu" tabindex="0"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="brand" style="display: flex; align-items: center; gap: 0.75rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" style="height: 32px; width: 32px;"
                        aria-label="Epidemic Engine Logo - Stylized disease outbreak visualization">
                        <circle cx="50" cy="50" r="45" fill="url(#logoGrad)" stroke="#000" stroke-width="2" />
                        <defs>
                            <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#003d6b" />
                                <stop offset="100%" stop-color="#007acc" />
                            </linearGradient>
                        </defs>
                        <path d="M50 15 L50 45 L75 60 L25 60 L50 45" fill="#ff5c00" stroke="#fff" stroke-width="2" />
                        <circle cx="50" cy="50" r="10" fill="#fff" />
                    </svg>
                    Epidemic Engine
                </div>
                <!-- Hamburger Menu for Mobile -->
                <button class="hamburger" id="mobile-toggle" onclick="toggleSidebar()" aria-label="Toggle Menu">
                    <i class="ph ph-list"></i>
                </button>
            </div>
            <nav class="sidebar-nav">
                <button class="nav-item active" data-chapter="home">
                    <i class="ph ph-house"></i> Home
                </button>
                <div class="nav-group">
                    <div class="nav-label label-p1">Part I: The Foundation</div>
                    <button class="nav-item" data-chapter="ch1">1. Mindset</button>
                    <button class="nav-item" data-chapter="ch2">2. History & Heroes</button>
                    <button class="nav-item" data-chapter="ch3">3. The Triad & Chain</button>
                    <button class="nav-item" data-chapter="ch4">4. Measures of Freq.</button>
                    <button class="nav-item" data-chapter="ch5">5. Surveillance Sys.</button>

                    <button class="nav-item" data-chapter="ch6">6. Natural History</button>
                    <button class="nav-item" data-chapter="quiz_part1">
                        <i class="ph ph-exam"></i> Part I Quiz
                    </button>
                </div>
                <div class="nav-group">
                    <div class="nav-label label-p2">Part II: Investigation & Analysis</div>
                    <button class="nav-item" data-chapter="ch7">7. Invest. Roadmap</button>
                    <button class="nav-item" data-chapter="ch8">8. Case Definitions</button>
                    <button class="nav-item" data-chapter="ch9">9. Line Lists & Data</button>
                    <button class="nav-item" data-chapter="ch10">10. Curves & Timing</button>
                    <button class="nav-item" data-chapter="ch11">11. Outbreak Math I</button>

                    <button class="nav-item" data-chapter="ch12">12. Outbreak Math II</button>

                    <button class="nav-item" data-chapter="ch13">13. Hypothesis Test</button>

                    <button class="nav-item" data-chapter="quiz_part2">
                        <i class="ph ph-exam"></i> Part II Quiz
                    </button>
                </div>
                <div class="nav-group">
                    <div class="nav-label label-p3">Part III: Control & Prevention</div>
                    <button class="nav-item" data-chapter="ch14">14. Data Synthesis</button>

                    <button class="nav-item" data-chapter="ch15">15. Prevention Levels</button>
                    <button class="nav-item" data-chapter="ch16">16. Control Measures</button>
                    <button class="nav-item" data-chapter="ch17">17. Isolation & Ethics</button>
                    <button class="nav-item" data-chapter="ch18">18. Pop. Dynamics</button>
                    <button class="nav-item" data-chapter="ch19">19. Advanced Eval</button>
                    <button class="nav-item" data-chapter="ch20">20. Case Studies</button>
                    <button class="nav-item" data-chapter="ch21">21. Env. Toxins</button>
                    <button class="nav-item" data-chapter="quiz_part3">
                        <i class="ph ph-exam"></i> Part III Quiz
                    </button>
                </div>
                <div class="nav-group">
                    <div class="nav-label label-management" style="color: #64748b; margin-top: 1rem;"><i
                            class="ph-bold ph-users-three"></i> Management</div>
                    <button class="nav-item coach-only" data-chapter="coach_resources">
                        <i class="ph ph-chalkboard-teacher"></i> Coach Resources
                    </button>
                </div>
                <div class="nav-group">
                    <div class="nav-label label-tools">Tools, Exam & Appendix</div>
                    <button class="nav-item" data-chapter="drills">
                        <i class="ph ph-barbell"></i> Interactive Drills
                    </button>
                    <button class="nav-item" data-chapter="random_problems">
                        <i class="ph ph-question"></i> Practice Problems
                    </button>
                    <button class="nav-item" data-chapter="simulation">
                        <i class="ph ph-exam"></i> Simulation Exams
                    </button>
                    <button class="nav-item" data-chapter="quick_quiz">
                        <i class="ph ph-lightning"></i> Quick Quiz
                    </button>
                    <button class="nav-item" data-chapter="case_library">
                        <i class="ph ph-folder-open"></i> Case Library
                    </button>
                    <button class="nav-item" data-chapter="case_quiz">
                        <i class="ph ph-puzzle-piece"></i> Case Challenges
                    </button>
                    <button class="nav-item" data-chapter="interactive_scenarios">
                        <i class="ph ph-game-controller"></i> Interactive Cases
                    </button>
                    <button class="nav-item" data-chapter="appendix">
                        <i class="ph ph-book-bookmark"></i> Appendix
                    </button>
                    <button class="nav-item" data-chapter="about" style="font-weight: 700;">
                        <i class="ph ph-info"></i> About & Credits
                    </button>
                </div>
            </nav>
        </aside>
        <main class="main-content">
            <button id="mobile-menu-toggle" class="neo-btn small hidden-desktop" aria-label="Toggle Navigation"
                aria-expanded="false">
                <i class="ph ph-list"></i> Menu
            </button>
            <div id="content-container">
                <!-- Content loaded dynamically -->
            </div>

            <footer class="site-footer"
                style="margin-top: 6rem; padding: 3rem 0; border-top: 2px solid var(--border-color); text-align: center; color: var(--text-color); font-family: var(--font-heading); opacity: 0.8;">
                <p style="margin-bottom: 1rem; line-height: 1.6;">
                    <strong>The Epidemic Engine</strong> v5.0.0 â€¢ Â© 2026 Science Olympiad Mastery Guide<br>
                    <span
                        style="display: block; margin-top: 0.75rem; font-size: 1rem; color: var(--navy-primary);">Designed,
                        Created, & Conceived by <strong>Rishi Reddy</strong></span>
                </p>
                <p style="font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.7;">Content based on CDC/WHO principles.
                    For educational
                    use only.</p>
                <p style="font-size: 0.9rem; margin-top: 1rem;"><a href="#"
                        onclick="loadChapter('about'); return false;"
                        style="color: var(--accent-orange); text-decoration: underline;">About Epidemic
                        Engine</a></p>
            </footer>

        </main>
    </div>

    <!--
      Load the legacy monolithic scripts. These scripts power the
      entire Epidemic Engine, including content, tools, quizzes and
      simulation exams. Phaseâ€‘2 additions (quiz_phase2_additions.js)
      extend the quiz bank with new advanced questions and should be
      loaded after quiz_bank_enhanced.js.
    -->
    <!-- Bundled JS: data first, then core engine -->
    <script src="dist/epi-data.bundle.js"></script>
    <script src="dist/epi-core.bundle.js"></script>

    <!-- Phase 13: Source Overrides (Fixing Content Visibility) -->
    <!-- Core Logic -->
    <script src="js/home-dashboard.js"></script>
    <script src="js/quiz-engine-core.js"></script>
    <script src="js/epidemic-engine-nav.js"></script>
    <script src="js/epidemic-engine-content.js"></script>
    <script src="js/chapter-reference.js"></script>
    <script src="js/quiz_bank_enhanced.js"></script>

    <!-- App Init: Service Worker and UI Logic (CSP Safe) -->
    <script src="js/app-init.js"></script>

    <!-- Extensions: Consolidated features and updates -->
    <script src="js/epidemic-engine-extensions.js"></script>
    <!-- PhaseÂ 2 scripts: Coach portal and dynamic practice problems -->
    <script src="js/coach_resources.js"></script>
    <script src="js/random_problems.js"></script>

    <!-- Custom Flash Drills: aggregate question pool and override loader -->
    <script src="js/custom_flash_drills.js"></script>

    <!-- Quick Quiz module -->
    <script src="js/quick_quiz.js"></script>


    <!-- PhaseÂ 8: diagnostic tools page definition -->
    <script src="js/diagnostic_tools.js"></script>

    <!-- PhaseÂ 9: case challenges multiâ€‘step quiz -->
    <script src="js/case_quiz.js"></script>

    <!-- Phase 12: Genomic Epidemiology Content -->

    <!-- Phase 13: Surveillance Systems -->

    <!-- Phase 14: Mega Cases (Tier 2 Enhancements) -->
    <script src="js/mega-cases-data.js"></script>
    <script src="js/mega-scenarios-data.js"></script>

    <!-- Phase 15: Herd Immunity Tool -->
    <script src="js/tool-herd-immunity.js"></script>

    <!-- Phase 16: Tier 3 (Infinite) -->
    <script src="js/procedural-engine.js"></script>
    <script src="js/tools-interface-content.js"></script>

    <!-- FORCE v5 Override for file:// protocol -->
    <script>
        (function () {
            console.log("Forcing QuizEngine v5.0.0 override...");

            // CRITICAL: Clear ALL old quiz progress from localStorage
            Object.keys(localStorage).filter(k => k.startsWith('quiz_progress') || k.startsWith('sim_exam')).forEach(k => localStorage.removeItem(k));
            console.log("Cleared old quiz progress from localStorage");

            // v5 QuizEngine - NO pause, uses existing CSS classes
            window.QuizEngine = class QuizEngine {
                static VERSION = '5.0.0';
                constructor(cfg) {
                    this.quizId = cfg.quizId || 'quiz';
                    this.containerId = cfg.containerId || 'quiz-container';
                    this.questions = cfg.questions || [];
                    this.mode = cfg.mode || 'practice';
                    this.timeLimit = cfg.timeLimit || null;
                    this.enableInstantFeedback = cfg.enableInstantFeedback !== false;
                    this.currentIndex = 0;
                    this.answers = {};
                    this.flagged = new Set();
                    this.startTime = null;
                    this.timerInterval = null;
                    this.isComplete = false;
                }
                start() {
                    this.startTime = Date.now();
                    this.render();
                    if (this.timeLimit) this.startTimer();
                }
                startTimer() {
                    if (this.timerInterval) clearInterval(this.timerInterval);
                    this.timerInterval = setInterval(() => {
                        const remaining = this.timeLimit - Math.floor((Date.now() - this.startTime) / 1000);
                        if (remaining <= 0) this.submit();
                        else this.updateTimerDisplay(remaining);
                    }, 1000);
                }
                updateTimerDisplay(s) {
                    const el = document.getElementById('quiz-timer');
                    if (el) {
                        el.textContent = Math.floor(s / 60) + ':' + (s % 60).toString().padStart(2, '0');
                        if (s < 300) el.style.color = '#ef4444';
                    }
                }
                render() {
                    const c = document.getElementById(this.containerId);
                    if (!c) return;
                    c.innerHTML = `
                        <div class="quiz-container-v2">
                            <div class="quiz-header-v2">
                                <button class="neo-btn secondary" onclick="window.quizEngine.exit()">
                                    <i class="ph-bold ph-sign-out"></i> Exit
                                </button>
                                <div style="font-size:1.25rem;font-weight:700;">
                                    Question <span id="q-num">${this.currentIndex + 1}</span> of ${this.questions.length}
                                </div>
                                ${this.timeLimit ? '<div class="timer-badge"><i class="ph-fill ph-clock"></i> <span id="quiz-timer">--:--</span></div>' : '<div></div>'}
                            </div>
                            <div id="quiz-body" class="quiz-body-v2"></div>
                            <div id="quiz-footer" class="quiz-footer-v2"></div>
                        </div>`;
                    this.renderQuestion();
                    this.renderFooter();
                }
                renderQuestion() {
                    const body = document.getElementById('quiz-body');
                    if (!body) return;
                    const q = this.questions[this.currentIndex];
                    if (!q) return;
                    const labels = ['A', 'B', 'C', 'D', 'E'];
                    const userAns = this.answers[this.currentIndex];
                    const showFeedback = this.enableInstantFeedback && userAns !== undefined;

                    // Build option cards with neo-brutalist styling
                    let optHtml = q.options.map((opt, i) => {
                        let cls = 'option-card-v2';
                        let extraStyle = '';
                        if (userAns === i) cls += ' selected';
                        if (showFeedback) {
                            if (i === q.answer) {
                                extraStyle = 'background:#dcfce7 !important;border-color:#22c55e !important;';
                            } else if (userAns === i && i !== q.answer) {
                                extraStyle = 'background:#fee2e2 !important;border-color:#ef4444 !important;';
                            }
                        }
                        const icon = showFeedback ? (i === q.answer ? '<i class="ph-bold ph-check-circle" style="color:#22c55e;margin-left:auto;"></i>' : (userAns === i && i !== q.answer ? '<i class="ph-bold ph-x-circle" style="color:#ef4444;margin-left:auto;"></i>' : '')) : '';
                        return `<button class="${cls}" style="${extraStyle}" onclick="window.quizEngine.selectAnswer(${i})" ${showFeedback ? 'disabled' : ''}>
                            <div class="option-indicator">${labels[i]}</div>
                            <span style="flex:1;text-align:left;">${opt}</span>
                            ${icon}
                        </button>`;
                    }).join('');

                    // Build enhanced feedback section
                    let feedbackHtml = '';
                    if (showFeedback) {
                        const isCorrect = userAns === q.answer;
                        const topic = q.topic || 'General';

                        // Use the question's chapter field directly if available
                        // Otherwise map topic to chapter
                        let chapterLink = q.chapter || null;
                        if (!chapterLink) {
                            // Extended topic-to-chapter mapping for all quiz topics
                            const topicToChapter = {
                                // Part 1 - Foundation
                                'Chapter 1': 'ch1', 'Mindset': 'ch1', 'Introduction': 'ch1',
                                'Chapter 2': 'ch2', 'History': 'ch2', 'Heroes': 'ch2',
                                'Chapter 3': 'ch3', 'Causation': 'ch3', 'Transmission': 'ch3',
                                'Chapter 4': 'ch4', 'Surveillance': 'ch4',
                                'Chapter 5': 'ch5', 'Case Definition': 'ch5',
                                'Chapter 6': 'ch6', 'Natural History': 'ch6',
                                // Part 2 - Investigation & Measures
                                'Chapter 7': 'ch7', 'Measures': 'ch7', 'Measures of Association': 'ch7',
                                'Chapter 8': 'ch8', 'Epidemic Curves': 'ch8', 'Epi Curves': 'ch8',
                                'Chapter 9': 'ch9', 'Outbreak Investigation': 'ch9', 'Investigation Steps': 'ch9',
                                'Chapter 10': 'ch10', 'Study Design': 'ch10',
                                'Chapter 11': 'ch11', 'Bias': 'ch11', 'Bias and Confounding': 'ch11', 'Confounding': 'ch11',
                                'Chapter 12': 'ch12', 'Screening': 'ch12', 'Diagnostic Testing': 'ch12',
                                'Chapter 13': 'ch13', '2x2 Tables': 'ch13', 'Attack Rates': 'ch13',
                                // Part 3 - Advanced
                                'Chapter 14': 'ch14', 'Statistics': 'ch14', 'Statistical Measures': 'ch14',
                                'Chapter 15': 'ch15', 'Prevention': 'ch15', 'Vaccines': 'ch15',
                                'Chapter 16': 'ch16', 'Herd Immunity': 'ch16',
                                'Chapter 17': 'ch17', 'Râ‚€': 'ch17', 'Reproduction Number': 'ch17',
                                'Chapter 18': 'ch18', 'Infectious Disease': 'ch18',
                                'Chapter 19': 'ch19', 'Advanced Bias': 'ch19', 'Advanced Topics': 'ch19',
                                'Chapter 20': 'ch20', 'Case Studies': 'ch20',
                                // Fallback mappings
                                'Mortality Metrics': 'ch7', 'Study Design': 'ch10',
                                'General': 'ch1'
                            };
                            chapterLink = topicToChapter[topic] || 'ch1';
                        }

                        // Get chapter title for display
                        const chapterTitles = {
                            'ch1': 'Mindset', 'ch2': 'History & Heroes', 'ch3': 'Causation & Transmission',
                            'ch4': 'Surveillance', 'ch5': 'Case Definition', 'ch6': 'Natural History',
                            'ch7': 'Measures of Association', 'ch8': 'Epidemic Curves', 'ch9': 'Outbreak Investigation',
                            'ch10': 'Study Design', 'ch11': 'Bias & Confounding', 'ch12': 'Screening & Testing',
                            'ch13': '2x2 Tables', 'ch14': 'Statistics', 'ch15': 'Prevention & Vaccines',
                            'ch16': 'Herd Immunity', 'ch17': 'Râ‚€', 'ch18': 'Infectious Disease',
                            'ch19': 'Advanced Topics', 'ch20': 'Case Studies'
                        };
                        const chapterTitle = chapterTitles[chapterLink] || 'Related Content';

                        const explanation = q.explain || 'This concept is essential for understanding epidemiological principles.';

                        feedbackHtml = `
                        <div class="neo-card" style="margin-top:1.5rem;overflow:hidden;">
                            <div style="padding:1rem 1.5rem;background:${isCorrect ? '#22c55e' : '#ef4444'};color:white;display:flex;align-items:center;gap:0.75rem;">
                                <i class="ph-bold ${isCorrect ? 'ph-check-circle' : 'ph-x-circle'}" style="font-size:1.5rem;"></i>
                                <span style="font-size:1.1rem;font-weight:700;">${isCorrect ? 'Correct!' : 'Incorrect'}</span>
                                <span style="margin-left:auto;opacity:0.9;">The answer is <strong>${labels[q.answer]}</strong></span>
                            </div>
                            <div style="padding:1.5rem;">
                                <div style="margin-bottom:1rem;">
                                    <h4 style="margin:0 0 0.5rem;color:#1e40af;display:flex;align-items:center;gap:0.5rem;">
                                        <i class="ph-bold ph-lightbulb"></i> Explanation
                                    </h4>
                                    <p style="margin:0;color:#334155;line-height:1.6;">${explanation}</p>
                                </div>
                                ${!isCorrect ? `
                                <div style="margin-bottom:1rem;padding:1rem;background:#fef3c7;border-radius:8px;border-left:4px solid #f59e0b;">
                                    <h4 style="margin:0 0 0.5rem;color:#92400e;display:flex;align-items:center;gap:0.5rem;">
                                        <i class="ph-bold ph-warning"></i> Why ${labels[userAns]} is incorrect
                                    </h4>
                                    <p style="margin:0;color:#78350f;line-height:1.5;">
                                        Option ${labels[userAns]} ("${q.options[userAns]}") is not the best answer. 
                                        The correct answer is ${labels[q.answer]} because it most accurately addresses the concept being tested.
                                    </p>
                                </div>` : ''}
                                <div style="display:flex;align-items:center;gap:1rem;padding-top:1rem;border-top:1px solid #e5e7eb;flex-wrap:wrap;">
                                    <span style="font-size:0.875rem;color:#64748b;">
                                        <i class="ph-bold ph-tag"></i> Topic: <strong>${topic}</strong>
                                    </span>
                                    <a href="#${chapterLink}" onclick="event.preventDefault(); window._returnToQuiz = window.quizEngine ? window.quizEngine.quizId : null; loadChapter('${chapterLink}');" 
                                       style="margin-left:auto;display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:#003d6b;color:white;border-radius:6px;text-decoration:none;font-weight:600;font-size:0.875rem;border:2px solid #000;box-shadow:2px 2px 0 #000;">
                                        <i class="ph-bold ph-book-open"></i> Learn: ${chapterTitle}
                                    </a>
                                </div>
                            </div>
                        </div>`;
                    }

                    body.innerHTML = `
                        <h2 class="question-text-v2">${q.q || q.question}</h2>
                        <div class="options-grid-v2">${optHtml}</div>
                        ${feedbackHtml}`;

                    const numEl = document.getElementById('q-num');
                    if (numEl) numEl.textContent = this.currentIndex + 1;
                }
                renderFooter() {
                    const f = document.getElementById('quiz-footer');
                    if (!f) return;
                    const isFirst = this.currentIndex === 0;
                    const isLast = this.currentIndex === this.questions.length - 1;
                    const isFlagged = this.flagged.has(this.currentIndex);
                    const progress = Math.round(((this.currentIndex + 1) / this.questions.length) * 100);

                    f.innerHTML = `
                        <div style="display:flex;align-items:center;gap:1rem;">
                            <button class="neo-btn ${isFlagged ? '' : 'secondary'}" onclick="window.quizEngine.toggleFlag()" title="${isFlagged ? 'Unflag' : 'Flag for review'}">
                                <i class="ph-fill ph-flag"></i>
                            </button>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width:${progress}%"></div>
                            </div>
                            <span style="font-weight:600;min-width:40px;">${progress}%</span>
                        </div>
                        <div style="display:flex;gap:0.75rem;">
                            <button class="neo-btn secondary" onclick="window.quizEngine.prev()" ${isFirst ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>
                                <i class="ph-bold ph-arrow-left"></i> Prev
                            </button>
                            ${isLast
                            ? '<button class="neo-btn" onclick="window.quizEngine.confirmSubmit()"><i class="ph-bold ph-check-circle"></i> Submit</button>'
                            : '<button class="neo-btn" onclick="window.quizEngine.next()">Next <i class="ph-bold ph-arrow-right"></i></button>'
                        }
                        </div>`;
                }
                selectAnswer(i) {
                    if (this.isComplete) return;
                    this.answers[this.currentIndex] = i;
                    this.renderQuestion();
                    this.renderFooter();
                }
                toggleFlag() {
                    if (this.flagged.has(this.currentIndex)) this.flagged.delete(this.currentIndex);
                    else this.flagged.add(this.currentIndex);
                    this.renderFooter();
                }
                next() {
                    if (this.currentIndex < this.questions.length - 1) {
                        this.currentIndex++;
                        this.renderQuestion();
                        this.renderFooter();
                    }
                }
                prev() {
                    if (this.currentIndex > 0) {
                        this.currentIndex--;
                        this.renderQuestion();
                        this.renderFooter();
                    }
                }
                exit() {
                    if (confirm('Exit quiz? Progress will not be saved.')) {
                        this.cleanup();
                        window.location.href = 'index.html#welcome';
                    }
                }
                confirmSubmit() {
                    const answered = Object.keys(this.answers).length;
                    if (confirm('Submit quiz? You have answered ' + answered + ' of ' + this.questions.length + ' questions.')) {
                        this.submit();
                    }
                }
                submit() {
                    this.isComplete = true;
                    this.cleanup();
                    const r = this.calcResults();
                    this.showResults(r);
                    if (window.AnalyticsManager) window.AnalyticsManager.logAttempt(this.quizId, r.score, r.total, this.mode);
                }
                cleanup() {
                    if (this.timerInterval) clearInterval(this.timerInterval);
                }
                calcResults() {
                    let correct = 0;
                    const byTopic = {};
                    this.questions.forEach((q, i) => {
                        const isCorrect = this.answers[i] === q.answer;
                        if (isCorrect) correct++;
                        const t = q.topic || 'General';
                        if (!byTopic[t]) byTopic[t] = { total: 0, correct: 0 };
                        byTopic[t].total++;
                        if (isCorrect) byTopic[t].correct++;
                    });
                    return {
                        score: correct,
                        total: this.questions.length,
                        percentage: Math.round((correct / this.questions.length) * 100),
                        timeSpent: Math.floor((Date.now() - this.startTime) / 1000),
                        byTopic
                    };
                }
                showResults(r) {
                    const c = document.getElementById(this.containerId);
                    if (!c) return;
                    const mins = Math.floor(r.timeSpent / 60);
                    const secs = r.timeSpent % 60;
                    let topicHtml = Object.entries(r.byTopic).map(([t, s]) => {
                        const pct = Math.round((s.correct / s.total) * 100);
                        const color = pct >= 80 ? '#22c55e' : pct >= 60 ? '#f59e0b' : '#ef4444';
                        return `<div style="display:flex;justify-content:space-between;padding:0.75rem 0;border-bottom:1px solid #e5e7eb;">
                            <span>${t}</span>
                            <span style="color:${color};font-weight:700;">${pct}% (${s.correct}/${s.total})</span>
                        </div>`;
                    }).join('');

                    c.innerHTML = `
                        <div class="quiz-container-v2" style="text-align:center;">
                            <div class="quiz-body-v2">
                                <h1 style="font-size:2.5rem;margin-bottom:1.5rem;">ðŸŽ‰ Quiz Complete!</h1>
                                <div class="neo-card" style="max-width:400px;margin:0 auto 2rem;padding:2rem;">
                                    <div style="font-size:4rem;font-weight:900;color:${r.percentage >= 80 ? '#22c55e' : r.percentage >= 60 ? '#f59e0b' : '#ef4444'};">${r.percentage}%</div>
                                    <div style="font-size:1.25rem;margin-top:0.5rem;">${r.score} of ${r.total} correct</div>
                                    <div style="margin-top:0.5rem;color:#64748b;">Time: ${mins}m ${secs}s</div>
                                </div>
                                <div class="neo-card" style="max-width:500px;margin:0 auto 2rem;padding:1.5rem;text-align:left;">
                                    <h3 style="margin-bottom:1rem;">Performance by Topic</h3>
                                    ${topicHtml}
                                </div>
                                <button class="neo-btn" onclick="window.location.href='index.html#welcome'">
                                    <i class="ph-bold ph-house"></i> Return Home
                                </button>
                            </div>
                        </div>`;
                }
                static getQuestionsForPart(partId, difficulty = 'balanced') {
                    if (typeof QUIZ_BANKS === 'undefined') return [];
                    const cleanId = partId.replace('quiz_', '').replace('part', 'part');
                    const bank = QUIZ_BANKS[cleanId];
                    if (!bank) return [];
                    let questions = [];
                    if (difficulty === 'balanced') {
                        ['beginner', 'intermediate', 'advanced'].forEach(lvl => {
                            if (bank[lvl]) questions.push(...bank[lvl].map(q => ({ ...q, difficulty: lvl })));
                        });
                    } else if (bank[difficulty]) {
                        questions = bank[difficulty].map(q => ({ ...q, difficulty }));
                    }
                    return questions;
                }
                static generateSimulation(difficulty = 'balanced') {
                    if (typeof QUIZ_BANKS === 'undefined') return { questions: [], boundaries: [] };
                    const shuffle = arr => {
                        for (let i = arr.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [arr[i], arr[j]] = [arr[j], arr[i]];
                        }
                        return arr;
                    };
                    const selectRandom = (arr, n) => shuffle([...arr]).slice(0, n);
                    let all = [], boundaries = [], idx = 0;
                    ['part1', 'part2', 'part3'].forEach(part => {
                        const qs = window.QuizEngine.getQuestionsForPart(part, difficulty);
                        const sel = selectRandom(qs, Math.min(17, qs.length));
                        if (sel.length > 0) {
                            boundaries.push({ index: idx, label: part.replace('part', 'Part ').toUpperCase() });
                            sel.forEach(q => { all.push({ ...q, part }); idx++; });
                        }
                    });
                    return { questions: all, boundaries };
                }
            };
            window.quizEngine = null;

            // Override startQuiz
            window.startQuiz = function (partId) {
                console.log('QuizEngine v5 startQuiz:', partId);
                const diffSel = document.getElementById('difficulty-' + partId);
                const difficulty = diffSel ? diffSel.value : 'balanced';
                const main = document.getElementById('content-container');
                if (!main) return;
                main.innerHTML = '<div id="quiz-fullscreen-root" style="height:100%;display:flex;align-items:center;justify-content:center;padding:1rem;"></div>';
                const questions = window.QuizEngine.getQuestionsForPart(partId, difficulty);
                if (questions.length === 0) {
                    main.innerHTML = '<div class="neo-card" style="padding:2rem;text-align:center;"><h3>No Questions Found</h3><p>Could not load questions for this quiz.</p><button class="neo-btn secondary" onclick="loadChapter(\'quiz_' + partId + '\')">Go Back</button></div>';
                    return;
                }
                window.quizEngine = new window.QuizEngine({
                    quizId: partId,
                    mode: 'practice',
                    containerId: 'quiz-fullscreen-root',
                    questions: questions,
                    timeLimit: null,
                    enableInstantFeedback: true
                });
                window.quizEngine.start();
            };

            // Override startSimulationExam
            window.startSimulationExam = function (examNumber) {
                console.log('QuizEngine v5 startSimulationExam:', examNumber);
                const diffSel = document.getElementById('difficulty-sim');
                const difficulty = diffSel ? diffSel.value : 'balanced';
                const main = document.getElementById('content-container');
                if (!main) return;
                main.innerHTML = '<div id="sim-fullscreen-root" style="height:100%;display:flex;align-items:center;justify-content:center;padding:1rem;"></div>';
                const { questions } = window.QuizEngine.generateSimulation(difficulty);
                if (questions.length === 0) {
                    alert('Failed to generate exam');
                    loadChapter('simulation');
                    return;
                }
                window.quizEngine = new window.QuizEngine({
                    quizId: 'simulation-' + examNumber,
                    mode: 'simulation',
                    containerId: 'sim-fullscreen-root',
                    questions: questions,
                    timeLimit: 50 * 60
                });
                window.quizEngine.start();
            };

            console.log("QuizEngine v5.0.0 ready. startQuiz and startSimulationExam overridden.");

            // Floating "Return to Quiz" button
            window._returnToQuiz = null;

            // Create the floating button element
            const returnBtn = document.createElement('div');
            returnBtn.id = 'return-to-quiz-btn';
            returnBtn.innerHTML = `
                <button onclick="window.returnToQuiz()" style="
                    display: flex; align-items: center; gap: 0.5rem;
                    padding: 0.75rem 1.25rem;
                    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
                    color: white; font-weight: 700; font-size: 0.9rem;
                    border: 3px solid #000; border-radius: 12px;
                    box-shadow: 4px 4px 0 #000;
                    cursor: pointer; transition: all 0.15s;
                ">
                    <i class="ph-bold ph-arrow-left"></i>
                    Return to Quiz
                </button>
            `;
            returnBtn.style.cssText = `
                position: fixed; bottom: 2rem; right: 2rem; z-index: 9999;
                display: none; animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(returnBtn);

            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                #return-to-quiz-btn button:hover {
                    transform: translate(-2px, -2px);
                    box-shadow: 6px 6px 0 #000;
                }
            `;
            document.head.appendChild(style);

            // Show/hide logic
            const originalLoadChapter = window.loadChapter;
            window.loadChapter = function (chapterId) {
                // Show return button if we're coming from a quiz
                if (window._returnToQuiz && window.quizEngine && !chapterId.startsWith('quiz_')) {
                    returnBtn.style.display = 'block';
                } else if (chapterId.startsWith('quiz_')) {
                    // Hide when returning to quiz
                    returnBtn.style.display = 'none';
                    window._returnToQuiz = null;
                }

                // Call original loadChapter
                if (originalLoadChapter) {
                    return originalLoadChapter(chapterId);
                }
            };

            // Return to quiz function
            window.returnToQuiz = function () {
                if (window._returnToQuiz && window.quizEngine) {
                    // Navigate back to the quiz
                    const quizId = window._returnToQuiz;
                    returnBtn.style.display = 'none';
                    window._returnToQuiz = null;

                    // Re-render the quiz from current state
                    const main = document.querySelector('.main-content');
                    if (main) {
                        main.innerHTML = '<div id="quiz-container"></div>';
                        window.quizEngine.containerId = 'quiz-container';
                        window.quizEngine.render();
                    }

                    // Update URL hash
                    window.location.hash = quizId;
                }
            };
        })();
    </script>

</body>

</html>